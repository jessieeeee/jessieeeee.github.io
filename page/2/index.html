<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
  <link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>JessieK's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/24/LiveDataBus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/07/24/LiveDataBus/" class="post-title-link" itemprop="url">LiveDataBus的封装</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-07-24 20:16:11" itemprop="dateCreated datePublished" datetime="2020-07-24T20:16:11+08:00">2020-07-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-26 09:42:45" itemprop="dateModified" datetime="2021-02-26T09:42:45+08:00">2021-02-26</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>随着JetPack的火热，google首推的Kotlin+LiveData+ViewModel+DataBinding的MVVM框架也越来越流行，在MVP的基础上，解决了P层带来的接口地狱和内存泄漏的问题，通信框架也从传统的handler，broadcast，interface到EventBus再到rxBus，最后到LiveDataBus，目前为止LiveDataBus确实是众多通信方案中最优的，在LiveData的加持下，拥有体积小，易封装，易维护且可感知生命周期防止内存泄漏的特点，接下来记录一下LiveDataBus的封装过程</p>
<hr>
<h1 id="通信框架对比"><a href="#通信框架对比" class="headerlink" title="通信框架对比"></a>通信框架对比</h1><p>Handler 高耦合，不利于维护，内存泄漏</p>
<p>BroadCast 性能差，传输数据有限，打乱代码的执行逻辑</p>
<p>Interface 实现复杂，不利于维护</p>
<p>RxBus 基于RxJava，学习成本高且依赖大</p>
<p>EventBus 需解决混淆问题，无法感知生命周期，实现复杂</p>
<h1 id="发布订阅模式和观察者模式区别"><a href="#发布订阅模式和观察者模式区别" class="headerlink" title="发布订阅模式和观察者模式区别"></a>发布订阅模式和观察者模式区别</h1><ul>
<li><p>观察者模式：观察者和被观察者相互知道对方的存在</p>
</li>
<li><p>发布订阅模式：发布者和订阅者互相不知道对方的存在</p>
</li>
</ul>
<h1 id="什么是LiveData"><a href="#什么是LiveData" class="headerlink" title="什么是LiveData"></a>什么是LiveData</h1><p>数据持有类，持有数据并且这个数据可以被观察者监听，它是和LifeCycle绑定的，在生命周期内使用有效，减少内存泄漏和引用问题</p>
<h1 id="LiveData的特点"><a href="#LiveData的特点" class="headerlink" title="LiveData的特点"></a>LiveData的特点</h1><ol>
<li>UI和数据保持一致：LiveData采用观察者模式，在数据变化时得到通知更新UI</li>
<li>避免内存泄漏：观察者被绑定到组件的生命周期上，组件销毁时，观察者会立刻清理数据</li>
<li>不会在Activity的stop状态下崩溃：当Activity处于后台，不会收到LiveData的延迟消息</li>
<li>解决屏幕旋转重启问题：能收到最新的数</li>
</ol>
<h1 id="LiveDataBus的封装"><a href="#LiveDataBus的封装" class="headerlink" title="LiveDataBus的封装"></a>LiveDataBus的封装</h1><ol>
<li>通过map维护一个消息事件和MutableLiveData的映射关系，MutableLiveData的类型默认为Object，接收任意类型，实现总线通信</li>
<li>将LiveDataBus封装为一个单例类</li>
<li>消息注册时，如果当前map中不存在，则先将消息和对应的MutableLiveData对象放入维护的map中，添加映射关系，返回当前map中缓存的MutableLiveData对象</li>
</ol>
<h2 id="粘性消息问题解决"><a href="#粘性消息问题解决" class="headerlink" title="粘性消息问题解决"></a>粘性消息问题解决</h2><p>具体现象：当前Activity给未启动的Activity发送一个消息，Activity在启动时能收到之前发送的消息</p>
<h3 id="LiveData源码"><a href="#LiveData源码" class="headerlink" title="LiveData源码"></a>LiveData源码</h3><p>LifecycleBoundObserver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(@NonNull LifecycleOwner source,</span></span></span><br><span class="line"><span class="function"><span class="params">              @NonNull Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">              removeObserver(mObserver);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          activeStateChanged(shouldBeActive());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>LiveData的version初始化是-1，每次LiveData设置值都会version加1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mVersion = START_VERSION;</span><br><span class="line"> <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        assertMainThread(<span class="string">"setValue"</span>);</span><br><span class="line">        mVersion++;</span><br><span class="line">        mData = value;</span><br><span class="line">        dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>LifeCircleOwner的状态变化时，会调LiveData.ObserverWrapper的activeStateChanged方法，如果这个时候ObserverWrapper的状态是active，就会调用LiveData的dispatchingValue，继续跟踪considerNotify，如果ObserverWrapper的mLastVersion小于LiveData的mVersion，会调mObserver的onChanged方法。所以LiveDataBus注册一个新的订阅者就会收到消息，即使消息发生在订阅之前。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// immediately set active state, so we'd never dispatch anything to inactive</span></span><br><span class="line">            <span class="comment">// owner</span></span><br><span class="line">            mActive = newActive;</span><br><span class="line">            <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">            LiveData.<span class="keyword">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class="line">                onActive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123;</span><br><span class="line">                onInactive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">                dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(@Nullable ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                considerNotify(initiator);</span><br><span class="line">                initiator = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                        mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                    considerNotify(iterator.next().getValue());</span><br><span class="line">                    <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">        mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// we still first check observer.active to keep it as the entrance for events. So even if</span></span><br><span class="line">        <span class="comment">// the observer moved to an active state, if we've not received that event, we better not</span></span><br><span class="line">        <span class="comment">// notify for a more predictable notification order.</span></span><br><span class="line">        <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">            observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        observer.mLastVersion = mVersion;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        observer.mObserver.onChanged((T) mData);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h3><p>在事件传递过程中拦截并监控事件的传输，修改事件传递流程<br>只要调用setValue版本号mVersion就会加1，此时版本号已经不一致导致onChange的调用，触发粘性事件，如果将mObservers.observer.mLastVersion修改为mVersion当前版本，就会在mObservers.observer.onChange调用前，也就是数据变化通知前return结束，这样就不调onChange方法<br>mObservers是Map对象，Map的item是键值对，observer是键值对的value，反射Map获取到Entry并获取到value也就是observer<br>继承MutableLiveData，重写observe方法，在注册监听时进行hook逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveDataBus</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BusMutableLiveData&lt;Object&gt;&gt; bus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LiveDataBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bus = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LiveDataBus DEFAULT_BUS = <span class="keyword">new</span> LiveDataBus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LiveDataBus <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.DEFAULT_BUS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">MutableLiveData&lt;T&gt; <span class="title">with</span><span class="params">(String key, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!bus.containsKey(key)) &#123;</span><br><span class="line">            bus.put(key, <span class="keyword">new</span> BusMutableLiveData&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MutableLiveData&lt;T&gt;) bus.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MutableLiveData&lt;Object&gt; <span class="title">with</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> with(key, Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BusMutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.observe(owner, observer);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 去除粘性事件</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//get wrapper's version</span></span><br><span class="line">            Class&lt;LiveData&gt; classLiveData = LiveData.class;</span><br><span class="line">            Field fieldObservers = classLiveData.getDeclaredField(<span class="string">"mObservers"</span>);</span><br><span class="line">            fieldObservers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectObservers = fieldObservers.get(<span class="keyword">this</span>);</span><br><span class="line">            Class&lt;?&gt; classObservers = objectObservers.getClass();</span><br><span class="line">            Method methodGet = classObservers.getDeclaredMethod(<span class="string">"get"</span>, Object.class);</span><br><span class="line">            methodGet.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</span><br><span class="line">            Object objectWrapper = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Wrapper can not be bull!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt; classObserverWrapper = objectWrapper.getClass().getSuperclass();</span><br><span class="line">            Field fieldLastVersion = classObserverWrapper.getDeclaredField(<span class="string">"mLastVersion"</span>);</span><br><span class="line">            fieldLastVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//get livedata's version</span></span><br><span class="line">            Field fieldVersion = classLiveData.getDeclaredField(<span class="string">"mVersion"</span>);</span><br><span class="line">            fieldVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectVersion = fieldVersion.get(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//set wrapper's version</span></span><br><span class="line">            fieldLastVersion.set(objectWrapper, objectVersion);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对非生命周期感知的observeForever方法，生成的wrapper不是LifecycleBoundObserver而是AlwaysActiveObserver，没有办法在observeForever调用完后再改AlwaysActiveObserver的version，因为注册监听时直接调了wrapper.activeStateChanged(true)而不是在LifeCircleOwner的状态变化时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@MainThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">      assertMainThread(<span class="string">"observeForever"</span>);</span><br><span class="line">      AlwaysActiveObserver wrapper = <span class="keyword">new</span> AlwaysActiveObserver(observer);</span><br><span class="line">      ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">      <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; existing <span class="keyword">instanceof</span> LiveData.LifecycleBoundObserver) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></span><br><span class="line">                  + <span class="string">" with different lifecycles"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      wrapper.activeStateChanged(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AlwaysActiveObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      AlwaysActiveObserver(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">          <span class="keyword">super</span>(observer);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以用ObserverWrapper，包装真正的回调传给observeForever，回调时检查调用栈，如果回调是observeForever方法，那么就不调真正的回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包装类包裹真正的Observer，处理非生命周期感知的注册监听</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Observer&lt;T&gt; observer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverWrapper</span><span class="params">(Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.observer = observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 目标方法不调onChanged</span></span><br><span class="line">            <span class="keyword">if</span> (isCallOnObserve()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            observer.onChanged(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCallOnObserve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (stackTrace != <span class="keyword">null</span> &amp;&amp; stackTrace.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement element : stackTrace) &#123;</span><br><span class="line">            <span class="comment">// 如果当前是LiveData对象且为observeForever方法</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"android.arch.lifecycle.LiveData"</span>.equals(element.getClassName()) &amp;&amp;</span><br><span class="line">                        <span class="string">"observeForever"</span>.equals(element.getMethodName())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改BusMutableLiveData增加对非生命周期感知的注册监听处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BusMutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Map&lt;Observer, Observer&gt; observerMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.observe(owner, observer);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!observerMap.containsKey(observer)) &#123;</span><br><span class="line">                observerMap.put(observer, <span class="keyword">new</span> ObserverWrapper(observer));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.observeForever(observerMap.get(observer));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非生命周期感知取消注册监听</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            Observer realObserver = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observerMap.containsKey(observer)) &#123;</span><br><span class="line">                realObserver = observerMap.remove(observer);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realObserver = observer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.removeObserver(realObserver);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 去除粘性事件</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//get wrapper's version</span></span><br><span class="line">            Class&lt;LiveData&gt; classLiveData = LiveData.class;</span><br><span class="line">            Field fieldObservers = classLiveData.getDeclaredField(<span class="string">"mObservers"</span>);</span><br><span class="line">            fieldObservers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectObservers = fieldObservers.get(<span class="keyword">this</span>);</span><br><span class="line">            Class&lt;?&gt; classObservers = objectObservers.getClass();</span><br><span class="line">            Method methodGet = classObservers.getDeclaredMethod(<span class="string">"get"</span>, Object.class);</span><br><span class="line">            methodGet.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</span><br><span class="line">            Object objectWrapper = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Wrapper can not be bull!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt; classObserverWrapper = objectWrapper.getClass().getSuperclass();</span><br><span class="line">            Field fieldLastVersion = classObserverWrapper.getDeclaredField(<span class="string">"mLastVersion"</span>);</span><br><span class="line">            fieldLastVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//get livedata's version</span></span><br><span class="line">            Field fieldVersion = classLiveData.getDeclaredField(<span class="string">"mVersion"</span>);</span><br><span class="line">            fieldVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectVersion = fieldVersion.get(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//set wrapper's version</span></span><br><span class="line">            fieldLastVersion.set(objectWrapper, objectVersion);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LiveDataBus.get().with(<span class="string">"test_event"</span>).setValue(<span class="string">"this is a message"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="接收事件"><a href="#接收事件" class="headerlink" title="接收事件"></a>接收事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LiveDataBus.get().with(<span class="string">"test_event"</span>, String.class)</span><br><span class="line">    .observe(<span class="keyword">this</span>, <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable String aBoolean)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/29/ReflectStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/06/29/ReflectStudy/" class="post-title-link" itemprop="url">注解反射-学习笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-06-29 17:34:43" itemprop="dateCreated datePublished" datetime="2020-06-29T17:34:43+08:00">2020-06-29</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-02-16 17:27:10" itemprop="dateModified" datetime="2021-02-16T17:27:10+08:00">2021-02-16</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>注解和反射是Android开发的基础，也是项目框架搭建中用到的必不可少的技术，减少重复代码编写，提高开发效率，并且广泛用于知名的开源框架中，有利于我们阅读源码，同时提升自己的架构能力和封装基础库的能力。下面对注解和反射的学习做一个记录。</p>
<hr>
<h1 id="原注解"><a href="#原注解" class="headerlink" title="原注解"></a>原注解</h1><p>元注解是定义注解的注解</p>
<p>@Retention：该注解保留阶段，保留的时长， 源码（RetentionPolicy.SOURCE） &lt; 字节码（RetentionPolicy.CLASS） &lt; 运行时（RetentionPolicy.RUNTIME）</p>
<ul>
<li>源码级别的注解：应用于APT编译期处理注解生成JAVA代码，生成额外的辅助类，如Dagger2, ButterKnife, EventBus3</li>
<li>字节码级别的注解：应用于字节码插桩，可用于埋点，如ASM，AspectJ</li>
<li>运行时级别的注解：反射获取被注解标记的变量/方法/类的信息</li>
</ul>
<p>@Target：该注解被使用的位置，字段枚举常量级（ElementType.FIELD），局部变量级（ElementType.LOCAL_VARIABLE），方法级（ElementType.METHOD），方法级（ElementType.PARAMETER），类级接口级（ElementType.TYPE），包级（ElementType.PACKAGE），构造方法（ElementType.CONSTRUCTOR），注解级（ElementType.ANNOTATION_TYPE）</p>
<h1 id="替代枚举"><a href="#替代枚举" class="headerlink" title="替代枚举"></a>替代枚举</h1><p>自定义注解并使用@IntDef注解指定一个数组，使用该注解去标记参数或返回值时，这个参数只能接收在@IntDef中所指定的几个参数，比如Android中设置view可见性的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@IntDef</span>(&#123;VISIBLE, INVISIBLE, GONE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Visibility &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVisibility</span><span class="params">(@Visibility <span class="keyword">int</span> visibility)</span> </span>&#123;</span><br><span class="line">      setFlags(visibility, VISIBILITY_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在setVisibility中传入这三个以外的其它值时，编译器就会提示错误</p>
<h1 id="注入布局文件"><a href="#注入布局文件" class="headerlink" title="注入布局文件"></a>注入布局文件</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义注解InjectLayout</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> InjectLayout &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> -1</span>; <span class="comment">// Activity布局文件</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在BaseActivity的onCreate中调用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectLayout</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; activityClass = activity.getClass();</span><br><span class="line">        <span class="keyword">if</span> (activityClass.isAnnotationPresent(InjectLayout.class)) &#123;</span><br><span class="line">            InjectLayout injectLayout = activityClass.getAnnotation(InjectLayout.class);</span><br><span class="line">            activity.setContentView(injectLayout.value());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@InjectLayout</span>(R.layout.activity_main)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="查找控件id"><a href="#查找控件id" class="headerlink" title="查找控件id"></a>查找控件id</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义注解BindView</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.FIELD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> -1</span>; <span class="comment">// View的id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在BaseActivity的onCreate中调用</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindView</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">       Class&lt;?&gt; activityClass = activity.getClass();</span><br><span class="line">       Field[] declaredFields = activityClass.getDeclaredFields();</span><br><span class="line">       <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">           <span class="keyword">if</span> (field.isAnnotationPresent(BindView.class)) &#123;</span><br><span class="line">               BindView bindView = field.getAnnotation(BindView.class);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   View view = activity.findViewById(bindView.value());</span><br><span class="line">                   field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                   field.set(activity, view);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IllegalAccessException e ) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line"><span class="meta">@BindView</span>(R.id.tv_test)</span><br><span class="line">Button mButton;</span><br></pre></td></tr></table></figure>
<h1 id="注解-反射实现Intent参数传递"><a href="#注解-反射实现Intent参数传递" class="headerlink" title="注解+反射实现Intent参数传递"></a>注解+反射实现Intent参数传递</h1><h2 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h2><p>用反射获取该变量的信息需保留到运行时阶段且注解应用于类的字段变量之上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoInject &#123;</span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注入逻辑"><a href="#注入逻辑" class="headerlink" title="注入逻辑"></a>注入逻辑</h2><ol>
<li>获取到该Activity的class对象，获取到该Activity的Intent数据</li>
<li>没有任何传值时直接返回</li>
<li>如果有参数传递，获取到该Activity的所有字段变量</li>
<li>确定每个字段变量的传值key，遍历所有的字段变量，判断该字段变量是否被注解，如果被注解则获取到注解对象，判断注解上的参数传值是否为空，如果为空直接使用被注解的变量名称为key，不为空则使用注解上的参数传值为key</li>
<li>判断传递的参数中是否有该key的值，如果有获取传入的值，如果字段变量不为数组，这里传入的值为最终结果</li>
<li>获取被注解的变量类型，如果该变量是数组并且是序列化的类，强转对象数组，并复制一份新的对象数组为最终结果，修改Activity中该变量的访问权限，将结果赋值给该变量<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectBundle</span><span class="params">(Activity activity)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 获取class对象</span></span><br><span class="line">    Class&lt;? extends Activity&gt; cls = activity.getClass();</span><br><span class="line">    Intent intent = activity.getIntent();</span><br><span class="line">    Bundle bundle = intent.getExtras();</span><br><span class="line">    <span class="comment">// 如果没有传值返回</span></span><br><span class="line">    <span class="keyword">if</span> (bundle == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取所有的变量</span></span><br><span class="line">    Field[] fields = cls.getDeclaredFields();</span><br><span class="line">    <span class="comment">// 遍历activity的变量</span></span><br><span class="line">    <span class="keyword">for</span>(Field field: fields)&#123;</span><br><span class="line">        <span class="comment">// 判断是否被注解</span></span><br><span class="line">        <span class="keyword">if</span> (field.isAnnotationPresent(AutoInject.class))&#123;</span><br><span class="line">            <span class="comment">// 获取到注解对象</span></span><br><span class="line">            AutoInject autoInject = field.getAnnotation(AutoInject.class);</span><br><span class="line">            <span class="comment">// 判断注解传值是否为空，如果为空使用当前被注解的变量名称</span></span><br><span class="line">            String key = TextUtils.isEmpty(autoInject.key()) ? field.getName() : autoInject.key();</span><br><span class="line">            <span class="comment">// 如果有该key的传值</span></span><br><span class="line">            <span class="keyword">if</span> (bundle.containsKey(key))&#123;</span><br><span class="line">                <span class="comment">// 获取传入的值</span></span><br><span class="line">                Object object = bundle.get(key);</span><br><span class="line">                <span class="comment">// 获取被注解的变量类型</span></span><br><span class="line">                Class&lt;?&gt; componentType = field.getType().getComponentType();</span><br><span class="line">                <span class="comment">// 如果当前变量是数组并且是序列化的class</span></span><br><span class="line">                <span class="keyword">if</span> (field.getType().isArray() &amp;&amp; Parcelable.class.isAssignableFrom(componentType))&#123;</span><br><span class="line">                    <span class="comment">// 强转对象数组</span></span><br><span class="line">                    Object[] objs = (Object[])object;</span><br><span class="line">                    <span class="comment">// 复制到新的对象数组</span></span><br><span class="line">                    Object[] objects = Arrays.copyOf(objs, objs.length, (Class&lt;?  extends Object[]&gt;) field.getType());</span><br><span class="line">                    object = objects;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 修改该变量的访问权限</span></span><br><span class="line">                field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 设置当前activity该变量的值为传值对象</span></span><br><span class="line">                    field.set(activity,object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2></li>
</ol>
<ul>
<li>第一个Activity传递参数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//User是序列化对象</span></span><br><span class="line">User user1 = <span class="keyword">new</span> User(<span class="string">"小明"</span>,<span class="number">12</span>); </span><br><span class="line">User user2 = <span class="keyword">new</span> User(<span class="string">"小王"</span>,<span class="number">13</span>);</span><br><span class="line">User[] users = <span class="keyword">new</span> User[<span class="number">2</span>];</span><br><span class="line">users[<span class="number">0</span>] = user1;</span><br><span class="line">users[<span class="number">1</span>] = user2;</span><br><span class="line">ArrayList&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">userList.add(user1);</span><br><span class="line">userList.add(user2);</span><br><span class="line"><span class="comment">// 传对象</span></span><br><span class="line">intent.putExtra(<span class="string">"test1"</span>,user1);</span><br><span class="line"><span class="comment">// 传对象数组</span></span><br><span class="line">intent.putExtra(<span class="string">"test2"</span>,users);</span><br><span class="line"><span class="comment">// 传对象列表</span></span><br><span class="line">intent.putParcelableArrayListExtra(<span class="string">"test3"</span>,userList);</span><br></pre></td></tr></table></figure></li>
<li>第二个Activity声明接收变量添加注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收对象</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test1"</span>)</span><br><span class="line"><span class="keyword">private</span> User value1;</span><br><span class="line"><span class="comment">// 接收对象数组</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test2"</span>)</span><br><span class="line"><span class="keyword">private</span> User[] value4;</span><br><span class="line"><span class="comment">// 接收对象列表</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test3"</span>)</span><br><span class="line"><span class="keyword">private</span> ArrayList&lt;User&gt; value5;</span><br><span class="line"><span class="comment">// Activity创建时调注入逻辑</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    InjectUtils.injectBundle(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="注解-代理器实现View-OnClick注入逻辑"><a href="#注解-代理器实现View-OnClick注入逻辑" class="headerlink" title="注解+代理器实现View.OnClick注入逻辑"></a>注解+代理器实现View.OnClick注入逻辑</h1><h2 id="定义注解-1"><a href="#定义注解-1" class="headerlink" title="定义注解"></a>定义注解</h2><h3 id="定义注解的注解"><a href="#定义注解的注解" class="headerlink" title="定义注解的注解"></a>定义注解的注解</h3><p>声明监听器类型，注入的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.ANNOTATION_TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EventType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Class <span class="title">listenerType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">listenerSetter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义方法注解"><a href="#定义方法注解" class="headerlink" title="定义方法注解"></a>定义方法注解</h3><p>用反射获取该变量的信息需保留到运行时阶段且注解应用于方法之上</p>
<p>普通点击监听的类型为View.OnClickListener.class，作用的方法为setOnClickListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@EventType</span>(listenerType = View.OnClickListener.class, listenerSetter = <span class="string">"setOnClickListener"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</span><br><span class="line">    <span class="keyword">int</span>[] value();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>长按监听的类型为View.OnLongClickListener.class，作用的方法为setOnLongClickListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@EventType</span>(listenerType = View.OnLongClickListener.class, listenerSetter = <span class="string">"setOnLongClickListener"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnLongClick &#123;</span><br><span class="line">    <span class="keyword">int</span>[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注入逻辑-1"><a href="#注入逻辑-1" class="headerlink" title="注入逻辑"></a>注入逻辑</h2><ol>
<li>获取到该Activity的class对象，获取到当前Activity的所有方法</li>
<li>遍历所有方法，获取到方法的所有注解</li>
<li>遍历所有注解，获取到当前注解类型</li>
<li>如果是EventType目标注解，获取到注解对象，获取到注解上定义的传值，监听的Class类型，注解作用的方法</li>
<li>获取到方法上注解传入的id</li>
<li>修改方法的访问权限</li>
<li>利用Java的代理器生成代理对象，动态代理OnClickListener/OnLongClickListener接口</li>
<li>自定义InvocationHandler添加在对应的点击事件上注入的逻辑</li>
<li>获取到View对象，在对应的点击方法上注入代理对象<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectClick</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectEvent</span><span class="params">(Activity activity)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 获取到当前的activity的class对象</span></span><br><span class="line">        Class&lt;? extends Activity&gt; activityClass = activity.getClass();</span><br><span class="line">        <span class="comment">// 获取到当前activity的所有方法</span></span><br><span class="line">        Method[] methods = activityClass.getDeclaredMethods();</span><br><span class="line">        <span class="comment">// 遍历所有方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method: methods)&#123;</span><br><span class="line">            <span class="comment">// 获取到方法的所有注解</span></span><br><span class="line">            Annotation[] annotations = method.getAnnotations();</span><br><span class="line">            <span class="comment">// 遍历所有注解</span></span><br><span class="line">            <span class="keyword">for</span> (Annotation annotation: annotations)&#123;</span><br><span class="line">                <span class="comment">// 获取到注解的类型</span></span><br><span class="line">                Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</span><br><span class="line">                <span class="comment">// 如果是EventType的注解</span></span><br><span class="line">                <span class="keyword">if</span> (annotationType.isAnnotationPresent(EventType.class))&#123;</span><br><span class="line">                    <span class="comment">// 获取到注解对象</span></span><br><span class="line">                    EventType eventType = annotationType.getAnnotation(EventType.class);</span><br><span class="line">                    <span class="comment">// 获取到注解上定义的传值</span></span><br><span class="line">                    Class listenerType = eventType.listenerType();</span><br><span class="line">                    String listenerSetter = eventType.listenerSetter();</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        <span class="comment">// 获取到注解传入的id值</span></span><br><span class="line">                        Method valueMethod = annotationType.getDeclaredMethod(<span class="string">"value"</span>);</span><br><span class="line">                        <span class="keyword">int</span>[] viewIds = (<span class="keyword">int</span>[]) valueMethod.invoke(annotation);</span><br><span class="line">                        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        <span class="comment">// 自定义InvocationHandler实现注入逻辑</span></span><br><span class="line">                        ListenerInvocationHandler&lt;Activity&gt; handler = <span class="keyword">new</span> ListenerInvocationHandler(activity, method);</span><br><span class="line">                        <span class="comment">// OnClickListener/OnLongClickListener的代理对象</span></span><br><span class="line">                        Object listenerProxy = Proxy.newProxyInstance(listenerType.getClassLoader(),</span><br><span class="line">                                <span class="keyword">new</span> Class[]&#123;listenerType&#125;, handler);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 遍历传入的id</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> viewId : viewIds) &#123;</span><br><span class="line">                            <span class="comment">// 获得view</span></span><br><span class="line">                            View view = activity.findViewById(viewId);</span><br><span class="line">                            <span class="comment">// 获得OnClickListener/OnLongClickListener的setOnClickLisnter/setOnLongClickLisnter方法</span></span><br><span class="line">                            Method setter = view.getClass().getMethod(listenerSetter, listenerType);</span><br><span class="line">                            <span class="comment">// 在View的点击方法上注入代理对象</span></span><br><span class="line">                            setter.invoke(view, listenerProxy);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 兼容自定义view注入，所以是泛型： T = Activity/View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerInvocationHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Method method;</span><br><span class="line">        <span class="keyword">private</span> T target;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListenerInvocationHandler</span><span class="params">(T target, Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.target = target;</span><br><span class="line">            <span class="keyword">this</span>.method = method;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            Log.v(<span class="string">"injectClick"</span>,<span class="string">"注入点击事件逻辑"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.method.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h1><p>声明对应的点击回调，并添加注解，传入被注入点击事件View的Id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClick</span>(&#123;R.id.text, R.id.button&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.text:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"click: 按钮1"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"click: 按钮2"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnLongClick</span>(&#123;R.id.text, R.id.button&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">longClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.text:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"longClick: 按钮1"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"longClick: 按钮2"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    InjectClick.injectEvent(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/24/ProxyStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/05/24/ProxyStudy/" class="post-title-link" itemprop="url">代理模式-学习笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-05-24 17:34:31" itemprop="dateCreated datePublished" datetime="2020-05-24T17:34:31+08:00">2020-05-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-08 23:32:59" itemprop="dateModified" datetime="2020-07-08T23:32:59+08:00">2020-07-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很久没有写博客了，疫情结束后经济萧条，很多年轻人受疫情的影响而被迫离职至今未找到工作。今年受疫情影响，招聘需求明显萎缩，离职人员近几个月大幅增加，这应该是最难找工作的一年，相信不管是在职或离职的小伙伴应该都不太轻松。有工作经验的人尚且如此，今年毕业的应届生求职可能会更加艰难。生活不易，但是我们仍要以积极的心态去应对，相信终有一天这一切都会过去，生活又美好如初。受疫情影响今年我也经历了找工作这段痛苦的日子，受老天眷顾找到了一份新的工作，但仍然感觉自己的技术实力还需提高，作为程序员扎实的基础是核心竞争力中不可缺少的一部分，在扎实的基础下进一步扩展深度，学习更多的计算机底层原理，同时扩展广度，学习当下的新技术，只有保证自己的核心竞争力，才能在任何时候面对危机和考验从容应对。代理模式是设计模式中的常考点且很多开源框架都用到了这个模式，有必要学习并加深理解，在此做一个学习记录。</p>
<hr>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><p>外地拼搏的年轻人总是要面对租房的问题，这里以租房为例，理解静态代理模式。首先我们需要一个租赁接口，这个接口中只有一个方法就是租房</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rent</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个年轻人叫小明，在外地拼搏的他需要租房，需要继承租赁这个接口并实现租房的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XiaoMing</span> <span class="keyword">implements</span> <span class="title">Rent</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"小明需要租房"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个中介机构链家可以帮你租房，你将租房需求告诉他们，当你满意成功租房后需要支付给他们中介费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LianJia</span> <span class="keyword">implements</span> <span class="title">Rent</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Rent rent;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LianJia</span><span class="params">(Rent rent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rent = rent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"链家获取你的租房需求"</span>);</span><br><span class="line">        rent.rentHouse();</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"链家帮你租房"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来让链家帮小明租房</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明一个有租房需求的人小明</span></span><br><span class="line">Rent xiaoMing = <span class="keyword">new</span> XiaoMing();</span><br><span class="line"><span class="comment">// 声明中介机构链家，接受小明的租房需求</span></span><br><span class="line">LianJia lianJia = <span class="keyword">new</span> LianJia(xiaoMing);</span><br><span class="line"><span class="comment">// 链家帮小明租房</span></span><br><span class="line">lianJia.rentHouse();</span><br></pre></td></tr></table></figure>

<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>Java中有个代理器可以实现接口对象的代理并生成对应的代理对象，我们利用Proxy.newProxyInstance生成实现了Rent接口的小明并生成代理对象，invoke方法中第一个参数是代理对象，第二个参数是被代理的方法，第三个参数是当前方法传入的参数值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object o = Proxy.newProxyInstance(SplashActivity.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Rent.class&#125;, <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(xiaoMing,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将代理对象转化为Rent接口的实例并调用租房的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理生成器的代理对象</span></span><br><span class="line">Rent xiaoMingProxy = (Rent) o;</span><br><span class="line">xiaoMingProxy.rentHouse();</span><br></pre></td></tr></table></figure>

<h1 id="手写Retrofit框架"><a href="#手写Retrofit框架" class="headerlink" title="手写Retrofit框架"></a>手写Retrofit框架</h1><p>Retrofit的核心就是通过动态代理，将注解参数拼接成一个完整的http请求再给网络请求框架去处理</p>
<h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.PARAMETER) <span class="comment">// 表单提交，作用在POST请求的参数上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Field &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD) <span class="comment">// 声明GET请求，作用在方法上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GET &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD) <span class="comment">// 声明POST请求，作用在方法上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> POST &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.PARAMETER) <span class="comment">// url上拼接，作用在请求的参数上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Query &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现Retrofit"><a href="#实现Retrofit" class="headerlink" title="实现Retrofit"></a>实现Retrofit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRetrofit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Map&lt;Method, ServiceMethod&gt; serviceMethodMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); <span class="comment">// 缓存调用方法到方法参数解析服务的映射</span></span><br><span class="line">    <span class="keyword">final</span> Call.Factory callFactory;<span class="comment">// 网络请求框架</span></span><br><span class="line">    <span class="keyword">final</span> HttpUrl baseUrl;<span class="comment">// 请求服务器url地址</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRetrofit</span><span class="params">(Call.Factory callFactory, HttpUrl baseUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.callFactory = callFactory;</span><br><span class="line">        <span class="keyword">this</span>.baseUrl = baseUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回请求接口的代理对象</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class[]&#123;service&#125;,</span><br><span class="line">                <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        <span class="comment">//解析方法所有注解信息</span></span><br><span class="line">                        ServiceMethod serviceMethod = loadServiceMethod(method);</span><br><span class="line">                        <span class="comment">//传入参数的值并返回拼接好的请求</span></span><br><span class="line">                        <span class="keyword">return</span> serviceMethod.invoke(args);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双琐式创建实例</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span></span>&#123;</span><br><span class="line">        ServiceMethod serviceMethod = serviceMethodMap.get(method);</span><br><span class="line">        <span class="keyword">if</span> (serviceMethod == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (serviceMethodMap)&#123;</span><br><span class="line">                <span class="comment">// 直接取出对应的方法参数解析服务</span></span><br><span class="line">                serviceMethod = serviceMethodMap.get(method);</span><br><span class="line">                <span class="comment">// 如果没有缓存就初始化调用，再放入缓存</span></span><br><span class="line">                <span class="keyword">if</span> (serviceMethod == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    serviceMethod = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>,method).build();</span><br><span class="line">                    serviceMethodMap.put(method,serviceMethod);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serviceMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收外部传入的参数并构建实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> HttpUrl baseUrl;</span><br><span class="line">        <span class="keyword">private</span> Call.Factory callFactory;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">callFactory</span><span class="params">(Call.Factory callFactory)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.callFactory = callFactory;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">baseUrl</span><span class="params">(String url)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.baseUrl = HttpUrl.parse(url);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MyRetrofit <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"base url required"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</span><br><span class="line">            <span class="keyword">if</span>(callFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">                callFactory = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyRetrofit(callFactory, baseUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现方法参数解析服务"><a href="#实现方法参数解析服务" class="headerlink" title="实现方法参数解析服务"></a>实现方法参数解析服务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMethod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Call.Factory callFactory;<span class="comment">// 网络请求框架</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url; <span class="comment">// 当前的请求路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> hasBody; <span class="comment">// 是否有请求体</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ParameterHandler[] parameterHandlers;</span><br><span class="line">    <span class="keyword">private</span> FormBody.Builder formBuild; <span class="comment">// 请求体表单</span></span><br><span class="line">    HttpUrl baseUrl;<span class="comment">// 请求服务器url</span></span><br><span class="line">    String httpMethod; <span class="comment">// 请求方式post/get</span></span><br><span class="line">    HttpUrl.Builder urlBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceMethod</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        baseUrl = builder.retrofit.baseUrl;</span><br><span class="line">        callFactory = builder.retrofit.callFactory;</span><br><span class="line"></span><br><span class="line">        httpMethod = builder.httpMethod;</span><br><span class="line">        url = builder.url;</span><br><span class="line">        hasBody = builder.hasBody;</span><br><span class="line">        parameterHandlers = builder.parameterHandlers;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果有请求体,创建okhttp请求体对象</span></span><br><span class="line">        <span class="keyword">if</span> (hasBody) &#123;</span><br><span class="line">            formBuild = <span class="keyword">new</span> FormBody.Builder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理传参</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理请求的地址与参数</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterHandlers.length; i++) &#123;</span><br><span class="line">            ParameterHandler handlers = parameterHandlers[i];</span><br><span class="line">            <span class="comment">//handler内本来就记录了key,现在给到对应的value</span></span><br><span class="line">            handlers.apply(<span class="keyword">this</span>, args[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取最终请求地址</span></span><br><span class="line">        HttpUrl httpUrl;</span><br><span class="line">        <span class="keyword">if</span> (urlBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            urlBuilder = baseUrl.newBuilder(url);</span><br><span class="line">        &#125;</span><br><span class="line">        httpUrl = urlBuilder.build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        FormBody formBody = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (formBuild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            formBody = formBuild.build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后拼接成功的请求</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder().url(httpUrl).method(httpMethod, formBody).build();</span><br><span class="line">        <span class="keyword">return</span> callFactory.newCall(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get请求, 按http的方式处理参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addQueryParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (urlBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            urlBuilder = baseUrl.newBuilder(url);</span><br><span class="line">        &#125;</span><br><span class="line">        urlBuilder.addQueryParameter(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Post请求, 按http的方式处理参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFiledParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        formBuild.add(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MyRetrofit retrofit;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Annotation[] methodAnnotations;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Annotation[][] parameterAnnotations;</span><br><span class="line">        ParameterHandler[] parameterHandlers;</span><br><span class="line">        <span class="keyword">private</span> String httpMethod;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> hasBody;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(MyRetrofit retrofit, Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.retrofit = retrofit;</span><br><span class="line">            <span class="comment">//获取方法的所有注解</span></span><br><span class="line">            methodAnnotations = method.getAnnotations();</span><br><span class="line">            <span class="comment">//获取方法参数的所有注解</span></span><br><span class="line">            parameterAnnotations = method.getParameterAnnotations();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//处理POST与GET</span></span><br><span class="line">            <span class="keyword">for</span> (Annotation methodAnnotation : methodAnnotations) &#123;</span><br><span class="line">                <span class="keyword">if</span> (methodAnnotation <span class="keyword">instanceof</span> POST) &#123;</span><br><span class="line">                    <span class="comment">//记录请求方式</span></span><br><span class="line">                    <span class="keyword">this</span>.httpMethod = <span class="string">"POST"</span>;</span><br><span class="line">                    <span class="comment">//记录请求url的path</span></span><br><span class="line">                    <span class="keyword">this</span>.url = ((POST) methodAnnotation).value();</span><br><span class="line">                    <span class="comment">// 是否有请求体</span></span><br><span class="line">                    <span class="keyword">this</span>.hasBody = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodAnnotation <span class="keyword">instanceof</span> GET) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.httpMethod = <span class="string">"GET"</span>;</span><br><span class="line">                    <span class="keyword">this</span>.url = ((GET) methodAnnotation).value();</span><br><span class="line">                    <span class="keyword">this</span>.hasBody = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理方法参数的注解</span></span><br><span class="line">            <span class="keyword">int</span> length = parameterAnnotations.length;</span><br><span class="line">            <span class="comment">// 创建请求参数映射数组</span></span><br><span class="line">            parameterHandlers = <span class="keyword">new</span> ParameterHandler[length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">                <span class="comment">// 一个参数的所有注解</span></span><br><span class="line">                Annotation[] annotations = parameterAnnotations[i];</span><br><span class="line">                <span class="comment">// 处理每一个注解</span></span><br><span class="line">                <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</span><br><span class="line">                    <span class="comment">// 如果是Field注解</span></span><br><span class="line">                    <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Field) &#123;</span><br><span class="line">                        <span class="comment">//得到注解上的value也就是请求参数的key</span></span><br><span class="line">                        String value = ((Field) annotation).value();</span><br><span class="line">                        <span class="comment">// 传入参数的key</span></span><br><span class="line">                        parameterHandlers[i] = <span class="keyword">new</span> ParameterHandler.FieldParameterHandler(value);</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">// 如果是Query注解</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">                        String value = ((Query) annotation).value();</span><br><span class="line">                        parameterHandlers[i] = <span class="keyword">new</span> ParameterHandler.QueryParameterHandler(value);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryParameterHandler</span> <span class="keyword">extends</span> <span class="title">ParameterHandler</span></span>&#123;</span><br><span class="line">        String key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">QueryParameterHandler</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span> </span>&#123;</span><br><span class="line">            serviceMethod.addQueryParameter(key,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldParameterHandler</span> <span class="keyword">extends</span> <span class="title">ParameterHandler</span></span>&#123;</span><br><span class="line">        String key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FieldParameterHandler</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span> </span>&#123;</span><br><span class="line">            serviceMethod.addFiledParameter(key,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义网络请求Api"><a href="#定义网络请求Api" class="headerlink" title="定义网络请求Api"></a>定义网络请求Api</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WeatherApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@POST</span>(<span class="string">"/v3/weather/weatherInfo"</span>)</span><br><span class="line">    <span class="function">Call <span class="title">postWeather</span><span class="params">(@Field(<span class="string">"city"</span>)</span> String city, @<span class="title">Field</span><span class="params">(<span class="string">"key"</span>)</span> String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/v3/weather/weatherInfo"</span>)</span><br><span class="line">    <span class="function">Call <span class="title">getWeather</span><span class="params">(@Query(<span class="string">"city"</span>)</span> String city, @<span class="title">Query</span><span class="params">(<span class="string">"key"</span>)</span> String key)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义Retrofit发起请求"><a href="#自定义Retrofit发起请求" class="headerlink" title="自定义Retrofit发起请求"></a>自定义Retrofit发起请求</h2><h3 id="初始化Retrofit"><a href="#初始化Retrofit" class="headerlink" title="初始化Retrofit"></a>初始化Retrofit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyRetrofit myRetrofit = <span class="keyword">new</span> MyRetrofit.Builder().baseUrl(<span class="string">"https://restapi.amap.com"</span>).build();</span><br><span class="line">weatherApi = myRetrofit.create(WeatherApi.class);</span><br></pre></td></tr></table></figure>

<h3 id="发起post请求"><a href="#发起post请求" class="headerlink" title="发起post请求"></a>发起post请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Call getCall = weatherApi.getWeather(<span class="string">"110101"</span>, <span class="string">"ae6c53e2186f33bbf240a12d80672d1b"</span>);</span><br><span class="line">        getCall.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                Log.i(<span class="string">"onResponse"</span>, <span class="string">"onResponse enjoy get: "</span> + response.body().string());</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="发起get请求"><a href="#发起get请求" class="headerlink" title="发起get请求"></a>发起get请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Call postCall = weatherApi.postWeather(<span class="string">"110101"</span>, <span class="string">"ae6c53e2186f33bbf240a12d80672d1b"</span>);</span><br><span class="line"> postCall.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">         Log.i(<span class="string">"onResponse"</span>, <span class="string">"onResponse enjoy post: "</span> + response.body().string());</span><br><span class="line">         response.close();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/05/PuppeteerInterception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/02/05/PuppeteerInterception/" class="post-title-link" itemprop="url">nodejs爬虫-puppeteer网络拦截器</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-02-05 14:36:13 / Modified: 17:53:38" itemprop="dateCreated datePublished" datetime="2020-02-05T14:36:13+08:00">2020-02-05</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很久没有写博客了，最近由于武汉疫情，这个春节从初一起就全程宅家，春节假期一延再延，本该上班的我们依然没有正常返工，街上仍然是没有几个人，快递延迟，很多人仍然是宅在家里远程上班。停工不停学，之前的漫画项目主要使用了网易漫画和腾讯漫画爬取的数据，而网易漫画在不久前被bilibili收购了，现在正式改为bilibili漫画，所以之前的爬虫逻辑和接口失效了，正好趁着这个时间把之前的服务端数据爬取接口改一下，这里做一个简单的记录。</p>
<hr>
<p>爬取漫画列表和漫画详情都没什么问题，跟之前的思路一样，改一下对应的标签重新绑定目标数据，但是在爬去漫画内容的时候，发现漫画图片的链接已经不在html的标签中了，而是直接获取到服务端返回的图片地址后用canvas绘制出来的。如下图所示：<br><img src="/images/PuppeteerInterception1.png" alt="截图"></p>
<p>所以只要我们能获取到该页面的网络请求结果，我们就能过滤出图片地址，也就不用去标签中获取目标数据了，接下来我发现在chrome浏览器中元素审查界面的网络拦截器中可以找到漫画内容的图片链接，如下图所示：<br><img src="/images/PuppeteerInterception2.png" alt="截图"></p>
<p>所以只要我们目前使用的爬虫框架puppeteer能够拦截到网络请求的结果就可以解决标签中无法爬取到图片地址的问题了。我查了一下puppeteer的官方文档，发现了这些api</p>
<p>开启拦截</p>
<p><code>page.setRequestInterception(true)</code></p>
<p>监听服务端返回<br><code>page.on(&#39;response&#39;)</code></p>
<p>另外还可以监听当前页面的请求</p>
<p><code>page.on(&#39;request&#39;)</code></p>
<p>返回一个自定义的响应</p>
<p><code>req.respond()</code></p>
<p>根据当前的场景，我们需要获取服务器返回的数据，并过滤其中的漫画图片地址</p>
<p><code>https://manga.hdslb.com/bfs/manga/a39f3fd06e540fe14b7e591ced413f372bd9f85f.jpg@660w.jpg?token=3a96fd02961137c00a76145fb381d544&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/4cd38fde6581e146c249373c9ed120b75047004a.jpg@660w.jpg?token=2e740fd7ccfefec3f1f5d0d27e925e33&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/18a6e2e4739e7e3eb9888e7220b398fb2d0def9d.jpg@660w.jpg?token=0e8b573c3c40fa3c5554d2df6ec8b2cb&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/e6cbe3162d3c4b6e1175557a90d4a0e54562032f.jpg@660w.jpg?token=0d1a55fe1d27d3527a9340034cd5a35f&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/0c649ad9107997801dd4e45179323381b16dc50a.jpg@660w.jpg?token=fbdf6eb7df231dbe345f4411a32d56c6&amp;ts=5e3a7d62</code></p>
<p>以上的链接地址特征</p>
<ol>
<li>以<code>https://manga.hdslb.com/bfs/manga/</code>开头</li>
<li>尾部都跟有token和ts的参数，<code>?token=</code>和<code>&amp;ts=</code></li>
<li><code>@660w.jpg</code>看起来是传入了请求图片的宽度和图片格式</li>
<li>抛开<code>@</code>后面的尾部参数，请求的图片格式和<code>@</code>后面的尾部参数传入的格式一致</li>
</ol>
<p>根据特征，抓取漫画图片代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>)</span><br><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">            headless: <span class="literal">false</span>,</span><br><span class="line">            executablePath: <span class="string">'/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'</span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.setRequestInterception(<span class="literal">true</span>);</span><br><span class="line">page.on(<span class="string">'response'</span>,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">response</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> url = response.url().toString()</span><br><span class="line">                <span class="keyword">let</span> tokenStart = url.indexOf(<span class="string">'?token='</span>)</span><br><span class="line">                <span class="keyword">let</span> tsStart = url.indexOf(<span class="string">'&amp;ts='</span>)</span><br><span class="line">                <span class="comment">// 捕获目标url</span></span><br><span class="line">                <span class="keyword">if</span> (url.indexOf(<span class="string">'manga.hdslb.com/bfs/manga/'</span>) !== <span class="number">-1</span></span><br><span class="line">                    &amp;&amp; tokenStart !== <span class="number">-1</span></span><br><span class="line">                    &amp;&amp; tsStart !== <span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="comment">// 尾部参数请求的格式</span></span><br><span class="line">                    <span class="keyword">let</span> imgParamStart = url.indexOf(<span class="string">'@'</span>)</span><br><span class="line">                    <span class="keyword">if</span> (imgParamStart !== <span class="number">-1</span>)&#123;</span><br><span class="line">                        <span class="comment">// 图片本身的格式</span></span><br><span class="line">                        <span class="keyword">let</span> suffix = url.substring(imgParamStart - <span class="number">3</span>, imgParamStart)</span><br><span class="line">                        <span class="comment">// 请求图片的参数</span></span><br><span class="line">                        <span class="keyword">let</span> imgParam = url.substring(imgParamStart, tokenStart)</span><br><span class="line">                        <span class="keyword">let</span> imgWidthEnd = imgParam.indexOf(<span class="string">'w'</span>)</span><br><span class="line">                        <span class="comment">// 请求图片的宽度</span></span><br><span class="line">                        <span class="keyword">let</span> imgWidth = imgParam.substring(<span class="number">1</span>, imgWidthEnd)</span><br><span class="line">                        <span class="keyword">let</span> imgFormatStart = imgParam.indexOf(<span class="string">'.'</span>)</span><br><span class="line">                        <span class="comment">// 请求图片的格式</span></span><br><span class="line">                        <span class="keyword">let</span> imgFormat = imgParam.substring(imgFormatStart + <span class="number">1</span>,tokenStart)</span><br><span class="line">                        <span class="comment">// 过滤图片信息</span></span><br><span class="line">                        <span class="keyword">if</span> (suffix === imgFormat)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(response.url())</span><br><span class="line">                            <span class="keyword">let</span> data = response.url().toString();</span><br><span class="line">                            <span class="keyword">let</span> imgHeight = <span class="number">1320</span></span><br><span class="line">                            resolve(&#123;data, imgWidth, imgHeight&#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"><span class="comment">// 跳转到目标网站</span></span><br><span class="line"><span class="keyword">await</span> page.goto(url)</span><br></pre></td></tr></table></figure>




        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/24/DingDingRobot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/11/24/DingDingRobot/" class="post-title-link" itemprop="url">钉钉机器人实现自定义闹钟提醒</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-24 20:57:51" itemprop="dateCreated datePublished" datetime="2019-11-24T20:57:51+08:00">2019-11-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-07 23:59:00" itemprop="dateModified" datetime="2020-03-07T23:59:00+08:00">2020-03-07</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很长一段时间没写博客了，最近工作繁忙，加班多，也是无奈啊～但是好习惯还是应该坚持下去的，平时工作钉钉作为主要的沟通工具，发现它除了是个聊天软件以外，还有一个好玩的东西-钉钉机器人，做些自动化推送提醒还是不错的，之前在telegram看到过类似的东西，它有一套专属api，可发送一些自定义的消息，实现一些自动化功能，目前推送提醒的解决方案一般是app推送，短信，企业微信，邮件，为了推送提醒单独开发一个app成本太高，短信现在几乎都是收费的，企业微信注册麻烦，而邮件一般都不会及时去看的。钉钉机器人创建成本低，又是主力聊天工具之一，对于个人或群组推送还是很实用的，随便拉两个人创建一个群就可以添加机器人了，如果只是做个人提醒的话，创建好后可以把这两个人T掉。唯一的限制是1秒最多发送20条～由于个人用iphone手机，本土化做得不好，节假日后补班那几天经常因为忘记定闹钟而睡过头，又不想下载第三方app，准备用家里有个树莓派做个人小型服务器，每天晚上定时跑一个python脚本，提醒我明天是否上班，如果上班提醒我设好闹钟，并请求天气预报，如果明天上班且下雨，提醒我闹钟提前半个小时，下雨早点出门不堵啊。</p>
<hr>
<h1 id="创建钉钉机器人"><a href="#创建钉钉机器人" class="headerlink" title="创建钉钉机器人"></a>创建钉钉机器人</h1><p>只要是个群组即可创建钉钉机器人，先拉两个人组成群组，在群组菜单中选择群组助手，添加机器人选择自定义机器人，创建的时候填写机器人名字，这里需要复制webhook的url链接，安全设置中可勾选自定义关键字，签名，ip地址，这里为了简单选择自定义关键字，设置为“提醒”，只要发送内容中带了关键字“提醒”即可。如果选择签名的话需要参考官方的签名算法，签名需添加到webhook的url上，如果选择ip地址的话，只有该ip地址的服务器才可以调用api发送消息。</p>
<h2 id="钉钉机器人发送消息"><a href="#钉钉机器人发送消息" class="headerlink" title="钉钉机器人发送消息"></a>钉钉机器人发送消息</h2><p>发起post请求，参数为json格式，就是机器人发送的内容，请求的地址就是创建机器人的webhook，如果安全设置选择了签名的话要带上签名参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">  url = <span class="string">'你的webhook'</span></span><br><span class="line">  headers = &#123;</span><br><span class="line">      <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">  &#125;</span><br><span class="line">  requests.post(url, data=json.dumps(msg), headers=headers)</span><br></pre></td></tr></table></figure>
<h1 id="获取日期信息"><a href="#获取日期信息" class="headerlink" title="获取日期信息"></a>获取日期信息</h1><p>找了一个免费api，<code>http://timor.tech/api/holiday/info/{yyyy-MM-dd}</code>，{yyyy-MM-dd}为要查询的日期，请求结果如下：<br>如果该接口请求失败，code = 1，也需要给自己发送接口请求失败的消息，及时处理<br>type = 0, 明天是正常的工作日<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-11</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"周五"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">5</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 1, 明天是正常的双休日<br>request url: <code>http://timor.tech/api/holiday/info/2019-10-13</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"周日"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">7</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 2, 明天是法定节假日<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: &#123;</span><br><span class="line">    <span class="attr">"holiday"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"wage"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2019-10-01"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 3, 明天是补班的特殊日子<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-12</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节后调休"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">6</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: &#123;</span><br><span class="line">    <span class="attr">"holiday"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节后调休"</span>,</span><br><span class="line">    <span class="attr">"after"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"wage"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2019-10-12"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="获取天气预报"><a href="#获取天气预报" class="headerlink" title="获取天气预报"></a>获取天气预报</h1><p>也是找了一个免费Api，<code>http://t.weather.sojson.com/api/weather/city/{citycode}</code>，参数是城市编码，以成都为例，请求结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"success感谢又拍云(upyun.com)提供CDN赞助"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"20200307"</span>,</span><br><span class="line">  <span class="attr">"time"</span>: <span class="string">"2020-03-07 22:52:50"</span>,</span><br><span class="line">  <span class="attr">"cityInfo"</span>: &#123;</span><br><span class="line">    <span class="attr">"city"</span>: <span class="string">"成都市"</span>,</span><br><span class="line">    <span class="attr">"citykey"</span>: <span class="string">"101270101"</span>,</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"四川"</span>,</span><br><span class="line">    <span class="attr">"updateTime"</span>: <span class="string">"22:30"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"shidu"</span>: <span class="string">"63%"</span>,</span><br><span class="line">    <span class="attr">"pm25"</span>: <span class="number">52.0</span>,</span><br><span class="line">    <span class="attr">"pm10"</span>: <span class="number">79.0</span>,</span><br><span class="line">    <span class="attr">"quality"</span>: <span class="string">"良"</span>,</span><br><span class="line">    <span class="attr">"wendu"</span>: <span class="string">"14"</span>,</span><br><span class="line">    <span class="attr">"ganmao"</span>: <span class="string">"极少数敏感人群应减少户外活动"</span>,</span><br><span class="line">    <span class="attr">"forecast"</span>: Array[<span class="number">15</span>][</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"07"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 19℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-07"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:25"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:06"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">94</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"08"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 18℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-08"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期日"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:24"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:07"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">57</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"09"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 17℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 8℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-09"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期一"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:22"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:08"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">52</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"10"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 18℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 8℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-10"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期二"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:21"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:08"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">59</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"11"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-11"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期三"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:20"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:09"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">55</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"12"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 17℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-12"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期四"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:19"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:10"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">62</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"13"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-13"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:18"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:10"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"14"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 20℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-14"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:16"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:11"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"15"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-15"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期日"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:15"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:12"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"16"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 14℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-16"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期一"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:14"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:12"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"17"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 16℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 10℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-17"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期二"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:13"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:13"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"小雨"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"雨虽小，注意保暖别感冒"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"18"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 20℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-18"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期三"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:12"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:14"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"19"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 22℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-19"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期四"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:10"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:14"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"20"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 23℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-20"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:09"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:15"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"21"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 22℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 13℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-21"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:08"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:16"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"西北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"yesterday"</span>: &#123;</span><br><span class="line">      <span class="attr">"date"</span>: <span class="string">"06"</span>,</span><br><span class="line">      <span class="attr">"high"</span>: <span class="string">"高温 16℃"</span>,</span><br><span class="line">      <span class="attr">"low"</span>: <span class="string">"低温 10℃"</span>,</span><br><span class="line">      <span class="attr">"ymd"</span>: <span class="string">"2020-03-06"</span>,</span><br><span class="line">      <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">      <span class="attr">"sunrise"</span>: <span class="string">"07:26"</span>,</span><br><span class="line">      <span class="attr">"sunset"</span>: <span class="string">"19:06"</span>,</span><br><span class="line">      <span class="attr">"aqi"</span>: <span class="number">79</span>,</span><br><span class="line">      <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">      <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">      <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求成功status=200，data的forecast字段是包括今天以及未来14天的天气情况，所以这个字段下的第二个元素就是明天的天气预报，判断该元素下的type字段是否包含“雨”，并返回调用结果，如果接口请求失败也给自己发送一条消息，及时处理</p>
<h2 id="python3实现"><a href="#python3实现" class="headerlink" title="python3实现"></a>python3实现</h2><p>每天定时跑脚本，给自己发钉钉消息，并结合明天的天气预报，如果要下雨给自己发送要早起的提示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWeather</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">"http://t.weather.sojson.com/api/weather/city/&#123;citycode&#125;"</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime(<span class="string">"getWeather ---&gt; "</span> + response.text)</span><br><span class="line">    json_data = json.loads(response.text)</span><br><span class="line">    status = json_data.get(<span class="string">'status'</span>)</span><br><span class="line">    <span class="keyword">if</span>  status == <span class="number">200</span>:</span><br><span class="line">        <span class="comment"># 明天的天气信息</span></span><br><span class="line">        tomorrow = json_data.get(<span class="string">'data'</span>).get(<span class="string">'forecast'</span>)[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 明天的天气</span></span><br><span class="line">        tomorrow_weather = str(tomorrow.get(<span class="string">"type"</span>))</span><br><span class="line">        <span class="keyword">if</span>  <span class="string">"雨"</span> <span class="keyword">in</span> tomorrow_weather:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">getDateInfo</span><span class="params">()</span>:</span></span><br><span class="line">     <span class="comment">#获得今天的日期</span></span><br><span class="line">    today = datetime.date.today() </span><br><span class="line">    <span class="comment">#获得明天的日期</span></span><br><span class="line">    tomorrow = today + datetime.timedelta(days=<span class="number">1</span>)</span><br><span class="line">    url = <span class="string">"http://timor.tech/api/holiday/info/"</span> + str(tomorrow)</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime(<span class="string">"getDateInfo ---&gt; "</span> + response.text)</span><br><span class="line">    json_data = json.loads(response.text)</span><br><span class="line">    dayType = json_data.get(<span class="string">'type'</span>).get(<span class="string">'type'</span>)</span><br><span class="line">    code = json_data.get(<span class="string">'code'</span>)</span><br><span class="line">    holiday = json_data.get(<span class="string">'holiday'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getDateInfoError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span>(dayType == <span class="number">0</span>): <span class="comment">#正常上班</span></span><br><span class="line">            messageWorkNormal(getWeather())</span><br><span class="line">        <span class="keyword">elif</span>(dayType == <span class="number">1</span> <span class="keyword">or</span> dayType == <span class="number">2</span>): <span class="comment">#普通周末和节假日</span></span><br><span class="line">            messageHoliday()</span><br><span class="line">        <span class="keyword">elif</span>(dayType == <span class="number">3</span>): <span class="comment"># 补假日</span></span><br><span class="line">            messageWorkAbnormal(today, str(holiday.get(<span class="string">'name'</span>)),getWeather())</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 休息日</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageHoliday</span><span class="params">()</span>:</span></span><br><span class="line">    logWithTime(<span class="string">"messageHoliday ---&gt; "</span>)</span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天休息日，不上班哦~"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常上班</span></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">messageWorkNormal</span><span class="params">(rain)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>  rain == <span class="number">-1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getWeatherError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> rain == <span class="number">1</span>:</span><br><span class="line">            logWithTime(<span class="string">"messageWorkNormal rain ---&gt; "</span>)</span><br><span class="line">            str = <span class="string">"可能下雨，需提前出门，"</span></span><br><span class="line">        logWithTime(<span class="string">"messageWorkNormal ---&gt; "</span>)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天要上班，"</span>+ str +<span class="string">"注意添加闹钟!!!"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口请求出错处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestError</span><span class="params">(date)</span>:</span></span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span>  date:</span><br><span class="line">        str = <span class="string">"日期信息"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">"天气信息"</span></span><br><span class="line">    </span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【闹钟提醒】"</span>+str+<span class="string">"接口请求失败，注意添加闹钟!!!"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补假要上班</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageWorkAbnormal</span><span class="params">(date, reason, rain)</span>:</span> </span><br><span class="line">    <span class="keyword">if</span>  rain == <span class="number">-1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getWeatherError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span>  rain == <span class="number">1</span>:</span><br><span class="line">            logWithTime(<span class="string">"messageWorkAbnormal rain ---&gt; "</span>)</span><br><span class="line">            str = <span class="string">"可能下雨，需提前出门，"</span></span><br><span class="line">        logWithTime(<span class="string">"messageWorkAbnormal ---&gt; "</span>)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天是：&#123;&#125;，&#123;&#125; 要上班，"</span>.format(date,reason)+ str + <span class="string">"注意添加闹钟!!!"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉机器人发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">    url = <span class="string">'your webhook'</span></span><br><span class="line">    </span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">    requests.post(url, data=json.dumps(msg), headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志带时间利于排查</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logWithTime</span><span class="params">(msg)</span>:</span></span><br><span class="line">      localtime = time.asctime( time.localtime(time.time()) )</span><br><span class="line">      <span class="keyword">print</span> (localtime + <span class="string">"    "</span> + msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    getDateInfo()</span><br></pre></td></tr></table></figure>
<p>每日晚上11点23在服务端运行这个脚本，请求钉钉机器人接口，给自己发送一个钉钉推送提醒，要定好闹钟</p>
<h1 id="树莓派设置定时任务"><a href="#树莓派设置定时任务" class="headerlink" title="树莓派设置定时任务"></a>树莓派设置定时任务</h1><p>将python脚本上传到树莓派，用ftp，ssh，samba都可以，这里就不详细说明了，设置定时任务前需要注意的是校准树莓派的时间，树莓派默认采用欧洲时区，如果树莓派的时间校准过，可略过此步骤。</p>
<h2 id="校准树莓派时间"><a href="#校准树莓派时间" class="headerlink" title="校准树莓派时间"></a>校准树莓派时间</h2><p>查看当前树莓派时间<code>date</code><br>设置树莓派时区<br><code>sudo dpkg-reconfigure tzdata</code><br>选择亚洲时区Asia，选择上海时间Shanghai</p>
<h2 id="contab设置定时任务"><a href="#contab设置定时任务" class="headerlink" title="contab设置定时任务"></a>contab设置定时任务</h2><p>linux定时任务可利用contab设置，<code>crontab -e</code>，进入文件编辑，选择编辑工具，nano或vim<br>格式为：Minute Hour Day Month Dayofweek   command<br>Minute            每个小时的第几分钟执行该任务<br>Hour               每天的第几个小时执行该任务<br>Day                 每月的第几天执行该任务<br>Month             每年的第几个月执行该任务<br>DayOfWeek    每周的第几天执行该任务<br>Command       要执行的命令<br>设置23点22分执行python3的脚本，并输出日志，利于维护和问题排查<br><code>22 23 * * * python3 /home/pi/upload/test123.py &gt;&gt;/home/pi/mylog.log</code><br>保存文件，并重启contab服务<br><code>sudo service cron restart</code></p>
<h1 id="ip变化提醒（2020-03-07更新）"><a href="#ip变化提醒（2020-03-07更新）" class="headerlink" title="ip变化提醒（2020/03/07更新）"></a>ip变化提醒（2020/03/07更新）</h1><p>家里申请了电信的公网ip，之前买了域名，一直在用端口转发+动态域名服务访问家里的树莓派，最近域名过期了，不打算续了，但希望仍然能在外网访问到家里的树莓派，电信的公网ip一直都是变动的，让电信固定ip需要繁杂的手续且需要企业申请，所以是不可能的了。最后想了一个可行的方法，如果能利用钉钉机器人在ip变化时给自己发送一条消息，告知最新的ip，那么仍然可以访问到家里的树莓派，这个问题就解决了。那如何知道ip变化了呢？还是利用linux的定时任务，每个小时跑一次python脚本，获取当前的外网ip，并将第一次的结果写入本地文件记录下来，每次运行脚本将当前外网ip与上一次记录的外网ip对比，如果不一致则ip变化，给自己发送钉钉消息告知最新的ip并再次写入文件刷新本地记录，如果ip一致则不用发送。</p>
<h2 id="获取本机外网ip"><a href="#获取本机外网ip" class="headerlink" title="获取本机外网ip"></a>获取本机外网ip</h2><p>找了一个免费的接口，<code>http://members.3322.org/dyndns/getip</code>，直接返回本机外网ip，如果为空就请求失败了，也给自己发送钉钉消息，及时处理，python实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># 获取当前ip</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getip</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">"http://members.3322.org/dyndns/getip"</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime (<span class="string">"getip ---&gt;"</span> + response.text)</span><br><span class="line">    myip = response.text.strip()</span><br><span class="line">    <span class="keyword">return</span> myip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口请求出错处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestError</span><span class="params">()</span>:</span>    </span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【ip变更提醒】获取ip接口请求失败!!!"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeFile</span><span class="params">(ip)</span>:</span></span><br><span class="line">    fo = open(<span class="string">"ip.txt"</span>, <span class="string">"w"</span>)</span><br><span class="line">    fo.write( ip)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readFile</span><span class="params">()</span>:</span></span><br><span class="line">    fo = open(<span class="string">"ip.txt"</span>, <span class="string">"r+"</span>)</span><br><span class="line">    <span class="keyword">return</span> fo.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉机器人发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">    url = <span class="string">'your webhook'</span></span><br><span class="line">    </span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">    requests.post(url, data=json.dumps(msg), headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启ip变更通知任务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notifyIpTask</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"ip.txt"</span>):</span><br><span class="line">        lastIp = readFile()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lastIp = <span class="string">""</span></span><br><span class="line">    logWithTime(<span class="string">"notifyIpTask ---&gt; notify ip server start"</span>)</span><br><span class="line">    myIp = getip()</span><br><span class="line">    <span class="keyword">if</span>  myIp == <span class="string">""</span>:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; get ip error"</span>)</span><br><span class="line">        requestError()</span><br><span class="line">    <span class="keyword">elif</span> myIp == lastIp:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; same ip"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; send ip"</span>)</span><br><span class="line">        writeFile(myIp)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【ip变更提醒】当前ip为&#123;&#125;"</span>.format(myIp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志带时间利于排查</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logWithTime</span><span class="params">(msg)</span>:</span></span><br><span class="line">      localtime = time.asctime( time.localtime(time.time()) )</span><br><span class="line">      <span class="keyword">print</span> (localtime + <span class="string">"    "</span> + msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    notifyIpTask()</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/20/NtpSync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/07/20/NtpSync/" class="post-title-link" itemprop="url">Android上利用Ntp实现不同设备间的同步</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-07-20 20:31:21" itemprop="dateCreated datePublished" datetime="2019-07-20T20:31:21+08:00">2019-07-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-21 18:32:51" itemprop="dateModified" datetime="2019-07-21T18:32:51+08:00">2019-07-21</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近公司有个需求，希望在不同的Android设备上实现视频的播放同步，误差尽可能的小，后期继续优化实现逐帧同步效果，以便后期进行矩阵拼接屏的研发，前期处于试探性阶段，在App上实现，目前误差在10-20ms内，属于肉眼完全看不出的误差效果范围，只有利用手机的慢动作摄影才能看出一点过渡误差，并且视频播放出的声音听起来也完全同步。对于请求主机时间消息的传递误差，主要利用了ntp时间同步技术来解决，对于视频的加载耗时通过两个播放器实例交替加载，达到预先加载的效果来解决，加载视频耗时造成的误差基本可以忽略不计。只要获取到了当前的主机时间，那么就能推算出主机的播放时间，这个时间可以看作是所有设备同步播放的时间，也能算出当前设备时间到这个同步播放时间的偏移量，达到准时播放同一个视频的效果。由于设备不一定一直联网，排除设备的时钟时间错误造成的干扰，这里统一采用rtc时间（硬件时钟）。这里主要记录一下在Android平台上ntp协议的应用。</p>
<hr>
<h1 id="NTP协议简介"><a href="#NTP协议简介" class="headerlink" title="NTP协议简介"></a>NTP协议简介</h1><p>网络时间协议NTP(Network Time Protocol)用于将计算机客户或服务器的时间与另一服务器同步，使用层次式时间分布模型。在配置时，NTP可以利用冗余服务器和多条网络路径来获得时间的高准确性和高可靠性。即使客户机在长时间无法与某一时间服务器相联系的情况下,仍可提供高准确度时间。</p>
<p>联网计算机同步时钟最简便的方法是网络授时。网络授时分为广域网授时和局域网授时。广域网授时精度通常能达50ms级，但有时超过500ms，这是因为每次经过的路由器路径可能不相同。现在还没有更好的办法将这种不同路径延迟的时间误差完全消除。局域网授时不存在路由器路径延迟问题，因而授时精度理论上可以提到亚毫秒级。Windows内置NTP服务，在局域网内其最高授时精度也只能达10ms级。</p>
<h2 id="进一步提高NTP授时精度的方法"><a href="#进一步提高NTP授时精度的方法" class="headerlink" title="进一步提高NTP授时精度的方法"></a>进一步提高NTP授时精度的方法</h2><p>局域网络延相对较大的原因在于时间戳的发送请求和接收一般都是在应用层。减少操作系统内核处理延时可以提高NTP授时精度，使发/收NTP包时间戳应尽量接近主机真实发/收包时刻。在不改变硬件的条件下，修改网卡驱动程序，将记录NTP包发/收时间戳从应用程序移至网卡驱动程序处，可消除操作系统内核处理延时不确定而造成的误差。这种方法在局域网中可大幅提高NTP授时精度至μs级。</p>
<h1 id="NTP的算法推导"><a href="#NTP的算法推导" class="headerlink" title="NTP的算法推导"></a>NTP的算法推导</h1><p>NTP最典型的授时方式是Client/Server方式。如下图所示，客户机首先向服务器发送一个NTP包，其中包含了该包离开客户机的时间戳T1，当服务器接收到该包时，依次填入包到达的时间戳T2、包离开的时间戳T3，然后立即把包返回给客户机。客户机在接收到响应包时，记录包返回的时间戳T4。客户机用上述4个时间参数就能够计算出2个关键参数：NTP包的往返延迟d和客户机与服务器之间的时钟偏差t。客户机使用时钟偏差来调整本地时钟，以使其时间与服务器时间一致。</p>
<p>T1为客户发送NTP请求时间戳(以客户时间为参照)；T2为服务器收到NTP请求时间戳(以服务器时间为参照)；T3为服务器回复NTP请求时间戳(以服务器时间为参照)；T4为客户收到NTP回复包时间戳(以客户时间为参照)；d1为NTP请求包传送延时，d2为NTP回复包传送延时；t为服务器和客户端之间的时间偏差，d为NTP包的往返时间<br>那么服务器的处理时间为T3 - T2，服务器从发送请求到接收应答总时间为T4 - T1<br>例如T1客户发送NTP请求时间为10:00:00am，T2服务器收到NTP请求时间为11:00:01am，T3服务器回复NTP请求时间为11:00:02am，T4客户端收到NTP回复包10:00:03am，那么<br>d = (T4 - T1) - (T3 - T2) = 2秒<br>客户端设备相对服务端设备的时间差为<br>t = (T2 - T1) + (T3 - T4) / 2 约等于 1 小时</p>
<h1 id="Android代码实现"><a href="#Android代码实现" class="headerlink" title="Android代码实现"></a>Android代码实现</h1><h2 id="客户端请求ntp时间"><a href="#客户端请求ntp时间" class="headerlink" title="客户端请求ntp时间"></a>客户端请求ntp时间</h2><p>已知客户端T1，T4时间，实现从服务器返回的报文中获取T2，T3时间参数并计算服务器ntp时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_PACKET_SIZE = <span class="number">48</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_MODE_CLIENT = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_VERSION = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RECEIVE_TIME_OFFSET = <span class="number">32</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSMIT_TIME_OFFSET = <span class="number">40</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> OFFSET_1900_TO_1970 = ((<span class="number">365L</span> * <span class="number">70L</span>) + <span class="number">17L</span>) * <span class="number">24L</span> * <span class="number">60L</span> * <span class="number">60L</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 请求ntp服务器设备的时间，设置服务器IP地址，端口号，以及超时时间</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ipAddress ip地址</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> port      端口号</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timeout   超时时间单位毫秒</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 如果请求成功返回true</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">requestTime</span><span class="params">(String ipAddress, <span class="keyword">int</span> port, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           InetAddress address = InetAddress.getByName(ipAddress);</span><br><span class="line">           DatagramSocket mSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">           mSocket.setSoTimeout(timeout);</span><br><span class="line">           <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[NTP_PACKET_SIZE];</span><br><span class="line">           DatagramPacket request = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length, address, port);</span><br><span class="line">           buffer[<span class="number">0</span>] = NTP_MODE_CLIENT | (NTP_VERSION &lt;&lt; <span class="number">3</span>);</span><br><span class="line">           <span class="comment">// 请求发送时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> requestTicks = SystemClock.elapsedRealtime();</span><br><span class="line">           mSocket.send(request);</span><br><span class="line">           <span class="comment">// 读取服务器响应数据包</span></span><br><span class="line">           DatagramPacket response = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length);</span><br><span class="line">           mSocket.receive(response);</span><br><span class="line">           <span class="comment">// 收到服务器响应时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> responseTicks = SystemClock.elapsedRealtime();</span><br><span class="line">           <span class="comment">// 服务器的接收时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> receiveTime = readTimeStamp(buffer, RECEIVE_TIME_OFFSET);</span><br><span class="line">           <span class="comment">// 服务器的发送时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> transmitTime = readTimeStamp(buffer, TRANSMIT_TIME_OFFSET);</span><br><span class="line">           <span class="comment">// 计算时间客户端和服务器的时间差（服务器收到请求时间 - 客户端请求时间） + （服务器回复请求时间 - 客户端收到回复时间） / 2</span></span><br><span class="line">           <span class="keyword">long</span> clockOffset = ((receiveTime - requestTicks) + (transmitTime - responseTicks)) / <span class="number">2</span>;</span><br><span class="line">           <span class="comment">// 当前ntp服务器的时间</span></span><br><span class="line">           <span class="keyword">long</span> mNtpTime = SystemClock.elapsedRealtime() + clockOffset;</span><br><span class="line">           <span class="comment">// 添加到平均值计算集合中，求平均值使得计算误差更小</span></span><br><span class="line">           addDeviation(clockOffset);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!mSocket.isClosed()) &#123;</span><br><span class="line">                       mSocket.close();</span><br><span class="line">                   &#125;</span><br><span class="line">                   mSocket.disconnect();</span><br><span class="line">                   mSocket = <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从buffer中读取32位的大端数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">read32</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">byte</span> b0 = buffer[offset];</span><br><span class="line">       <span class="keyword">byte</span> b1 = buffer[offset + <span class="number">1</span>];</span><br><span class="line">       <span class="keyword">byte</span> b2 = buffer[offset + <span class="number">2</span>];</span><br><span class="line">       <span class="keyword">byte</span> b3 = buffer[offset + <span class="number">3</span>];</span><br><span class="line">       <span class="comment">// convert signed bytes to unsigned values</span></span><br><span class="line">       <span class="keyword">int</span> i0 = ((b0 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b0 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b0);</span><br><span class="line">       <span class="keyword">int</span> i1 = ((b1 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b1 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b1);</span><br><span class="line">       <span class="keyword">int</span> i2 = ((b2 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b2 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b2);</span><br><span class="line">       <span class="keyword">int</span> i3 = ((b3 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b3 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b3);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> ((<span class="keyword">long</span>) i0 &lt;&lt; <span class="number">24</span>) + ((<span class="keyword">long</span>) i1 &lt;&lt; <span class="number">16</span>) + ((<span class="keyword">long</span>) i2 &lt;&lt; <span class="number">8</span>)</span><br><span class="line">               + (<span class="keyword">long</span>) i3;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从buffer中读取时间戳</span></span><br><span class="line"><span class="comment">    * 返回毫秒数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">readTimeStamp</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 读取秒数</span></span><br><span class="line">       <span class="keyword">long</span> seconds = read32(buffer, offset);</span><br><span class="line">       <span class="comment">// 读取小数</span></span><br><span class="line">       <span class="keyword">long</span> fraction = read32(buffer, offset + <span class="number">4</span>);</span><br><span class="line">       <span class="keyword">return</span> ((seconds - OFFSET_1900_TO_1970) * <span class="number">1000</span>)</span><br><span class="line">               + ((fraction * <span class="number">1000L</span>) / <span class="number">0x100000000L</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里的SystemClock.elapsedRealtime()是获取设备启动后到现在的时间（硬件时间），System.currentTimeMillis()获取的是系统时间（软件时间），是距离1970年1月1日开始计算的一个值，这里为了减少误差，避免因为外界修改软件时间而导致时间不准的情况而使用硬件时间。</p>
<h1 id="服务器返回ntp时间"><a href="#服务器返回ntp时间" class="headerlink" title="服务器返回ntp时间"></a>服务器返回ntp时间</h1><p>从客户端发的报文中获取响应地址和端口号，把收到请求的时间写入报文并保存到链表，从链表中取出刚才放入的报文，写入发送响应的时间发给客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> OFFSET_1900_TO_1970 = ((<span class="number">365L</span> * <span class="number">70L</span>) + <span class="number">17L</span>) * <span class="number">24L</span> * <span class="number">60L</span> * <span class="number">60L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RECEIVE_TIME_OFFSET = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSMIT_TIME_OFFSET = <span class="number">40</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_PACKET_SIZE = <span class="number">48</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_MODE_SERVIER = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_VERSION = <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    mCompositeDisposable.add(Observable.just(<span class="number">1</span>).subscribeOn(Schedulers.io())</span><br><span class="line">            .subscribe(integer -&gt; &#123;</span><br><span class="line">                start = <span class="keyword">true</span>;</span><br><span class="line">                Logger.t(TAG).d(<span class="string">"服务端开启 port="</span> + port);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mSocket = <span class="keyword">new</span> DatagramSocket(<span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// 设置端口重用</span></span><br><span class="line">                    mSocket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 绑定端口号</span></span><br><span class="line">                    mSocket.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">                    <span class="keyword">while</span> (start) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[NTP_PACKET_SIZE];</span><br><span class="line">                            DatagramPacket response = <span class="keyword">new</span> DatagramPacket(buffer,</span><br><span class="line">                                    buffer.length);</span><br><span class="line">                            buffer[<span class="number">0</span>] = NTP_MODE_SERVIER | (NTP_VERSION &lt;&lt; <span class="number">3</span>);</span><br><span class="line">                            Logger.t(TAG).d(<span class="string">"等待接收客户端消息"</span>);</span><br><span class="line">                            mSocket.receive(response);</span><br><span class="line">                            DatagramPacket echo = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length, response.getAddress(), response.getPort());</span><br><span class="line">                            Logger.t(TAG).d(<span class="string">"收到客户端请求="</span> + response.getAddress());</span><br><span class="line">                            <span class="comment">// 把收到的时间写入buffer</span></span><br><span class="line">                            writeTimeStamp(buffer, RECEIVE_TIME_OFFSET, SystemClock.elapsedRealtime());</span><br><span class="line">                            <span class="comment">// 添加到链表</span></span><br><span class="line">                            mLinkedList.add(echo);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            Logger.t(TAG).e(<span class="string">"while receive failed:"</span> + e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Logger.t(TAG).e(<span class="string">"response failed:"</span> + e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Logger.t(TAG).e(<span class="string">"关闭socket"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mSocket.isClosed()) &#123;</span><br><span class="line">                            mSocket.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                        mSocket.disconnect();</span><br><span class="line">                        mSocket = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">    mCompositeDisposable.add(Observable.just(<span class="number">1</span>).subscribeOn(Schedulers.io())</span><br><span class="line">            .subscribe(integer -&gt; &#123;</span><br><span class="line">                mSendSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">                mSendSocket.setSoTimeout(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">while</span> (start) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mLinkedList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 取出刚才放入链表的数据包</span></span><br><span class="line">                            DatagramPacket first = mLinkedList.removeFirst();</span><br><span class="line">                            <span class="keyword">if</span> (first != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// 写入发送响应包的时间</span></span><br><span class="line">                                writeTimeStamp(first.getData(), TRANSMIT_TIME_OFFSET, SystemClock.elapsedRealtime());</span><br><span class="line">                                Logger.t(TAG).d(<span class="string">"向客户端发送消息="</span> + first.getAddress());</span><br><span class="line">                                mSendSocket.send(first);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        Logger.t(TAG).e(<span class="string">"while send failed:"</span> + e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Logger.t(TAG).d(<span class="string">"发送消息端关闭"</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入硬件时间到buffer中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeTimeStamp</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> seconds = time / <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">long</span> milliseconds = time - seconds * <span class="number">1000L</span>;</span><br><span class="line">    seconds += OFFSET_1900_TO_1970;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按大端模式写入秒数</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> fraction = milliseconds * <span class="number">0x100000000L</span> / <span class="number">1000L</span>;</span><br><span class="line">    <span class="comment">// 按大端模式写入小数</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// 低位字节随机</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (Math.random() * <span class="number">255.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/13/MacRemoveAnySearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/07/13/MacRemoveAnySearch/" class="post-title-link" itemprop="url">Mac移除浏览器劫持AnySearch</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-07-13 19:11:56" itemprop="dateCreated datePublished" datetime="2019-07-13T19:11:56+08:00">2019-07-13</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-09 23:20:25" itemprop="dateModified" datetime="2020-08-09T23:20:25+08:00">2020-08-09</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>家里面一直使用的MAC电脑最近遇到一个比较烦人的问题，浏览器被劫持，打开chrome浏览器和safari浏览器主页全是AnySearch的搜索导航界面，被一个名为AnySearch的插件恶意修改了主页，主页修改劫持，最开始我手动删除chrome和safari的插件，当时主页被修正回来了，但是过不了几天这个插件又悄悄的被安装在chrome和safari浏览器上，主页又被修改为了AnySearch的搜索导航界面。我发现SystemPreference(系统偏好)中多出一个profile的选项，里面能看到一个AnySearch脚本路径，然后我在profile中把脚本删除，再手动删除chrome和safari的插件，结果和第一次的尝试一样，过几天又悄无声息的装上了，主页再次被修改。我查找了很多方案都不起作用，后来发现一个比较靠谱的方法能彻底移除AnySearch的浏览器劫持，在这里记录一下。</p>
<hr>
<p>除了删除profile中AnySearch的脚本路径和chrome浏览器以及safari浏览器的AnySearch插件以外</p>
<h1 id="命令行中删除以下路径的文件"><a href="#命令行中删除以下路径的文件" class="headerlink" title="命令行中删除以下路径的文件"></a>命令行中删除以下路径的文件</h1><p>~/Library/Safari/Extensions/AnySearch.safariextz</p>
<p>~/Library/Saved\ Application\ State/com.apple.Safari.savedState<br>~/Library/Saved\ Application\ State/com.google.Chrome.savedState</p>
<h1 id="2019-11-22记"><a href="#2019-11-22记" class="headerlink" title="2019-11-22记"></a>2019-11-22记</h1><p>仅删除文件以上无效，每过一段时间仍然会自动安装系统描述文件profile，并自动给chrome浏览器和safari浏览器安装infoSearch插件，篡改浏览器主页，拦截所有google搜索的内容到yahoo搜索，需要将~/Library/Application Support下的所有infosearch相关的文件删除。<br>命令行执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Library/Application Support</span><br><span class="line">find ./ -iname &quot;infosearch*&quot;</span><br></pre></td></tr></table></figure>
<p>找出所有相关的文件路径并删除路径下的文件</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/19/RaspberryAria2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/05/19/RaspberryAria2/" class="post-title-link" itemprop="url">树莓派+PanDownload(aria2)实现远程下载</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-19 17:45:57 / Modified: 21:04:30" itemprop="dateCreated datePublished" datetime="2019-05-19T17:45:57+08:00">2019-05-19</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很长一段时间没有更新博客了，最近工作特别忙，加班多都没有时间写博客了。在如今这个快节奏的时代，难免会有这样的需求，身处办公室希望能远程下发下载任务到家里的树莓派下载资源，之前开坑玩了一下树莓派，尝试了迅雷远程下载的方案，在树莓派上搭建一个迅雷的远程下载服务器，不过目前这种方案已经失效了，迅雷关闭了远程下载的服务。不过最近我发现了一个不错的远程下载方案，aria2是一个在linux上支持远程下载的工具，无奈它的下载速度实在是太慢了，百度云的第三方下载工具PanDownload是基于aria2的，下载速度非常可观，且支持远程下载。我们可以在树莓派上搭建aria2的下载服务器，然后利用PanDownload远程下发下载任务到树莓派上的aria2服务器，即可实现远程下载。</p>
<hr>
<h1 id="树莓派搭建aria2服务器"><a href="#树莓派搭建aria2服务器" class="headerlink" title="树莓派搭建aria2服务器"></a>树莓派搭建aria2服务器</h1><p>关于树莓派的准备工作和系统安装这里就不讲了，希望了解的朋友可以查看<a href="https://jessiekate.gitee.io/2019/02/04/RaspberryStart/" target="_blank" rel="noopener">上一篇</a>，这里主要是说一下关于aria2服务器的搭建流程。</p>
<h2 id="安装aria2"><a href="#安装aria2" class="headerlink" title="安装aria2"></a>安装aria2</h2><p><code>sudo apt install -y aria2</code></p>
<h2 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h2><ul>
<li>创建配置文件的文件夹<br><code>mkdir -p ~/.config/aria2/</code></li>
<li>vim编写配置文件<br><code>sudo vi ~/.config/aria2/aria2.config</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">后台运行</span></span><br><span class="line">daemon=true</span><br><span class="line"><span class="meta">#</span><span class="bash">设置加密密钥</span></span><br><span class="line">rpc-secret=secret</span><br><span class="line"><span class="meta">#</span><span class="bash">允许rpc</span></span><br><span class="line">enable-rpc=true</span><br><span class="line"><span class="meta">#</span><span class="bash">允许所有来源, web界面跨域权限需要</span></span><br><span class="line">rpc-allow-origin-all=true</span><br><span class="line"><span class="meta">#</span><span class="bash">允许外部访问，<span class="literal">false</span>的话只监听本地端口</span></span><br><span class="line">rpc-listen-all=true</span><br><span class="line"><span class="meta">#</span><span class="bash">RPC端口, 仅当默认端口被占用时修改</span></span><br><span class="line">rpc-listen-port=6800</span><br><span class="line"><span class="meta">#</span><span class="bash">最大同时下载数(任务数), 路由建议值: 3</span></span><br><span class="line">max-concurrent-downloads=5</span><br><span class="line"><span class="meta">#</span><span class="bash">断点续传</span></span><br><span class="line">continue=true</span><br><span class="line"><span class="meta">#</span><span class="bash">同服务器连接数</span></span><br><span class="line">max-connection-per-server=5</span><br><span class="line"><span class="meta">#</span><span class="bash">最小文件分片大小, 下载线程数上限取决于能分出多少片, 对于小文件重要</span></span><br><span class="line">min-split-size=10M</span><br><span class="line"><span class="meta">#</span><span class="bash">单文件最大线程数, 路由建议值: 5</span></span><br><span class="line">split=10</span><br><span class="line"><span class="meta">#</span><span class="bash">下载速度限制</span></span><br><span class="line">max-overall-download-limit=0</span><br><span class="line"><span class="meta">#</span><span class="bash">单文件速度限制</span></span><br><span class="line">max-download-limit=0</span><br><span class="line"><span class="meta">#</span><span class="bash">上传速度限制</span></span><br><span class="line">max-overall-upload-limit=0</span><br><span class="line"><span class="meta">#</span><span class="bash">单文件速度限制</span></span><br><span class="line">max-upload-limit=0</span><br><span class="line"><span class="meta">#</span><span class="bash">文件保存路径</span></span><br><span class="line">dir=/home/pi/Downloads</span><br><span class="line"><span class="meta">#</span><span class="bash">所需时间</span></span><br><span class="line">file-allocation=prealloc</span><br><span class="line"><span class="meta">#</span><span class="bash">不进行证书校验</span></span><br><span class="line">check-certificate=false</span><br><span class="line"><span class="meta">#</span><span class="bash">保存下载会话</span></span><br><span class="line">save-session=/home/pi/.config/aria2/aria2.session</span><br><span class="line">input-file=/home/pi/.config/aria2/aria2.session</span><br><span class="line"><span class="meta">#</span><span class="bash">断电续传</span></span><br><span class="line">save-session-interval=60</span><br></pre></td></tr></table></figure></li>
<li>创建该会话空白文件<br><code>touch /home/pi/.config/aria2/aria2.session</code></li>
<li>测试下aria2是否启动成功<br><code>aria2c --conf-path=/home/pi/.config/aria2/aria2.config</code></li>
<li>是否有进程启动<br><code>用 ps aux|grep aria2</code></li>
<li>结束进程<br><code>kill -9 xxxx</code></li>
</ul>
<h1 id="设置aria2服务并开机启动"><a href="#设置aria2服务并开机启动" class="headerlink" title="设置aria2服务并开机启动"></a>设置aria2服务并开机启动</h1><h2 id="编写服务文件"><a href="#编写服务文件" class="headerlink" title="编写服务文件"></a>编写服务文件</h2><p><code>sudo vim /lib/systemd/system/aria.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Aria2 Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=pi</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/bin/aria2c --conf-path=/home/pi/.config/aria2/aria2.config</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h2 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a>设置开机启动</h2><p><code>sudo systemctl daemon-reload</code><br><code>sudo systemctl enable aria</code></p>
<h2 id="查看aria服务状态"><a href="#查看aria服务状态" class="headerlink" title="查看aria服务状态"></a>查看aria服务状态</h2><p><code>sudo systemctl status aria</code> </p>
<h2 id="启动aria2服务"><a href="#启动aria2服务" class="headerlink" title="启动aria2服务"></a>启动aria2服务</h2><p><code>sudo systemctl start aria</code></p>
<h2 id="停止aria2服务"><a href="#停止aria2服务" class="headerlink" title="停止aria2服务"></a>停止aria2服务</h2><p><code>sudo systemctl stop aria</code></p>
<h2 id="重启aria2服务"><a href="#重启aria2服务" class="headerlink" title="重启aria2服务"></a>重启aria2服务</h2><p><code>sudo systemctl restart aria</code></p>
<h1 id="PanDownload配置"><a href="#PanDownload配置" class="headerlink" title="PanDownload配置"></a>PanDownload配置</h1><p>目前PanDownload只有windows版本，mac 需开启虚拟机使用<br>设置 -&gt; 远程 -&gt; 添加 -&gt; 添加远程主机<br><img src="/images/RaspberryAria2_1.png" alt="效果图"></p>
<ol>
<li>勾选开启远程下载模式<br><img src="/images/RaspberryAria2_2.png" alt="效果图"></li>
<li>填写树莓派下载服务器的ip，填写端口号对应配置文件中的rpc-listen-port和token对应配置文件中的rpc-secret<br><img src="/images/RaspberryAria2_3.png" alt="效果图"></li>
<li>检测连接，提示连接成功<br><img src="/images/RaspberryAria2_4.png" alt="效果图"></li>
<li>取消默认下载路径的配置，这样才可以在选择下载文件后弹出远程下载的选择弹窗</li>
<li>如果提示“下载失败：无法创建文件，给下载文件夹授权，<code>chmod 777 /mnt/download</code></li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/IjkplayerSo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/02/16/IjkplayerSo/" class="post-title-link" itemprop="url">ijkplayer编译so文件支持更多格式</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-02-16 21:50:54 / Modified: 23:14:00" itemprop="dateCreated datePublished" datetime="2019-02-16T21:50:54+08:00">2019-02-16</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>bilibili大名鼎鼎的ijkplayer开源播放器，有支持ffmpeg拓展，可拓展性高，体积小的优点，成为很多公司的首选播放器，但官方给的demo只支持mp4格式，想要支持横多的视频格式需要自己修改配置文件并重新编译出so文件才能实现，之前折腾了很久，一直是循环编译，最后编译失败。周末闲来下了，继续折腾终于编译成功，下面对ijkplayer的配置修改和编译做一个详细记录，方便以后查阅。</p>
<p>编译前提：在linux或者mac开发环境下，配置好JDK,SDK,NDK的环境变量</p>
<p>编译步骤：</p>
<ol>
<li>git clone ijkplayer的源码</li>
<li>通过init-android.sh脚本把ijkplayer的jni源码和ffmepg的源码拉下来</li>
<li>如果要支持https，通过init-android-openssl.sh把openssl的代码拉下来</li>
<li>用脚本compile-openssl.sh编译openssl</li>
<li>选择编译配置文件，修改配置</li>
<li>用脚本compile-ffmpeg.sh编译ffmpeg</li>
<li>用脚本compile-ijk.sh编译ijkplayer的jni源码</li>
</ol>
<p>下面是具体的操作过程：</p>
<ol>
<li><p>拉ijkplayer的源码</p>
<p><code>git clone https://github.com/bilibili/ijkplayer</code></p>
</li>
<li><p>切换目录，把ijkplayer的jni源码和ffmepg的源码拉下来</p>
<p><code>cd ijkplayer</code></p>
<p><code>./init-android.sh</code></p>
</li>
<li><p>把openssl的代码拉下来</p>
<p><code>./init-android-openssl.sh</code></p>
</li>
<li><p>切换目录，编译openssl</p>
<p><code>cd android/contrib</code></p>
<p><code>./compile-openssl.sh clean</code></p>
<p><code>./compile-openssl.sh all</code></p>
</li>
<li><p>切换目录，修改配置文件，删除之前的配置文件软链接，并重新设置一个配置文件的软链接</p>
<p><code>cd ../../</code></p>
<p><code>cd config</code></p>
<p><code>rm module.sh</code></p>
<p><code>ln -s module-default.sh module.sh</code></p>
<p>注意module-lite.sh是精简了支持格式的配置文件，module-default.sh这个是支持格式较多的配置文件</p>
<p>这一步，遇到了一个错误<code>linux/perf_event.h: No such file</code>，当执行ffmpeg的编译操作，<code>./compile-ffmpeg.sh all</code>才会提示。</p>
<p>解决方案：</p>
<p>先删除之前的软链接文件<code>rm module.sh</code></p>
<p>改一下module-default.sh配置文件，在末尾添加2行代码：</p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export COMMON_FF_CFG_FLAGS="$COMMON_FF_CFG_FLAGS --disable-linux-perf"</span><br><span class="line">export COMMON_FF_CFG_FLAGS="$COMMON_FF_CFG_FLAGS --disable-bzlib"</span><br></pre></td></tr></table></figure>
<p>再创建软链接<code>ln -s module-default.sh module.sh</code></p>
</li>
<li><p>切换目录，编译ffmpeg</p>
<p><code>cd ..</code></p>
<p><code>cd android/contrib</code></p>
<p><code>./compile-ffmpeg.sh clean</code></p>
<p><code>./compile-ffmpeg.sh all</code></p>
<p>这一步，遇到了一个错误<code>nasm/yasm not found or too old. Use --disable-x86asm for a crippled build</code></p>
<p> 提示汇编工具没有安装。</p>
<p>解决方案：</p>
<p>可以安装yasm，或者按照提示执行./configure –disable-x86asm，由于yasm暂时用不上，那么就执行./configure –disable-x86asm来解决，但是这里我们编译ffmpeg是通过shell脚本，所以只能去改脚本。</p>
<p>我们打开compile-ffmpeg.sh这个脚本发现它其实是在执行tools/do-compile-ffmpeg.sh这个脚本，再打开do-compile-ffmpeg.sh，搜索是否有<code>./configure</code>这个命令，果然在305行，我们找到了相关代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure $FF_CFG_FLAGS \</span><br><span class="line">       --extra-cflags="$FF_CFLAGS $FF_EXTRA_CFLAGS" \</span><br><span class="line">       --extra-ldflags="$FF_DEP_LIBS $FF_EXTRA_LDFLAGS"</span><br></pre></td></tr></table></figure>

<p>这里关注一下FF_CFG_FLAGS这个变量，我们可以在它后面追加<code>--disable-x86asm</code>这个参数命令</p>
<p>修改FF_CFG_FLAGS变量应该在调用<code>./configure</code>命令之前，所以我们添加一句代码在294行：</p>
<p><code>FF_CFG_FLAGS=&quot;$FF_CFG_FLAGS --disable-x86asm&quot;</code>，先清除之前编译的文件<code>./compile-ffmpeg.sh clean</code>，再编译一次<code>./compile-ffmpeg.sh all</code>这个错误就解决了。</p>
</li>
<li><p>切换目录，编译ijkplayer的jni源码</p>
<p><code>cd ..</code></p>
<p><code>./compile-ijk.sh all</code></p>
<p>编译完成，so文件一般保留arm-v7a的就可以了，路径是<code>/ijkplayer/android/ijkplayer/ijkplayer-armv7a/src/main/libs/armeabi-v7a</code>比较module-default.sh和module-lite.sh编译出来的so文件，前面一个明显大一些。</p>
</li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/04/RaspberryStart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/02/04/RaspberryStart/" class="post-title-link" itemprop="url">树莓派折腾记录</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-02-04 23:54:18" itemprop="dateCreated datePublished" datetime="2019-02-04T23:54:18+08:00">2019-02-04</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-13 16:49:54" itemprop="dateModified" datetime="2020-12-13T16:49:54+08:00">2020-12-13</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>放假前在公司看到有同事在玩树莓派，觉得挺有意思，之前也曾经了解过，但是一直都没有下定决定买一个玩玩，这次也算是被同事拉下水吧，趁着这次放假的机会，在淘宝上买了个最新的树莓派3B+ 来学习一下，从小白开始树莓派的折腾之旅。想到自己有linux的基础应该上手不会太难，没想到还是踩了不少的坑，在购买的时候淘宝店家说会有技术支持，结果放假了完全不回消息😔，不过遇到的问题还是自己慢慢踩坑爬出来了，在这里做个简单的记录。</p>
<hr>
<h1 id="折腾树莓派的准备工作"><a href="#折腾树莓派的准备工作" class="headerlink" title="折腾树莓派的准备工作"></a>折腾树莓派的准备工作</h1><h2 id="贴散热贴"><a href="#贴散热贴" class="headerlink" title="贴散热贴"></a>贴散热贴</h2><p>拿到树莓派的主板后，先贴好散热贴，总共3个散热贴，有2个带脚的散热贴和1个不带脚并有树莓标志的散热贴，主要是3个地方，CPU，GPU和内存，其中CPU和GPU在主板的正面，贴两个带脚的散热片，正中有两个近似于正方形的方块，大的是CPU，小的是GPU，而内存在主板的背面，贴不带脚并有树莓标志的散热贴。</p>
<h2 id="连接风扇"><a href="#连接风扇" class="headerlink" title="连接风扇"></a>连接风扇</h2><p>树莓派的风扇主要有2根连接线，红色和黑色，红色接4针脚，黑色接6针脚，对应树莓派上的两列针脚区域，第二列的第二和第三个针脚。如果树莓派通电，接入后风扇就可以马上转起来。</p>
<h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><p>将SD卡插入读卡器，用系统烧录工具，Mac为balenaEtcher，下载好官网的debian系统的zip文件，然后烧录到SD卡中。然后把SD卡插入树莓派的SD卡槽，将树莓派接上电源，这时红色灯光常量，代表电源接通正常。树莓派读取SD卡，自动启动系统，系统启动好后绿色灯光闪烁，代表系统已经启动完毕。</p>
<h2 id="接入局域网"><a href="#接入局域网" class="headerlink" title="接入局域网"></a>接入局域网</h2><p>由于mac无法插入网线直接访问树莓派，可以把树莓派的网线插入到路由器上，我们可以直接在路由器的设备管理界面看到树莓派的IP地址，接下来就可以用命令行工具ssh或者图形化界面vnc远程访问到我们的树莓派。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>作为小白，在前期的准备工作也遇到了坑😔，由于系统下错了，下成了虚拟机的树莓派镜像文件（这是个ISO文件）无语的是balenaEtcher烧录系统到SD卡的时候也没有任何报错，导致SD卡插入到SD卡槽后无法正常启动系统（然而我当时并不知道），所以接入到局域网中发现路由器的设备管理界面根本没有看到树莓派这个设备。后面看到树莓派指示灯相关的内容后，才明白原来系统都没跑起来。这里推荐使用Raspbian Stretch Lite版的系统，比较稳定，没有多余的功能，纯命令行的系统（之前安装过带图形界面的，发现不太好用，用到的也少，因为大部分功能都是命令行下实现的）。如果你发现插入SD卡只有红色灯亮，不是没有读到SD卡，就是系统启动失败，同样关机时执行关机命令后，等到绿色灯熄灭才是系统正常关闭，再拔掉电源。下面对常用的树莓派指示灯含义做一个总结：</p>
<ol>
<li>绿色灯闪烁，读取到了SD卡并且也正常启动了系统</li>
<li>红色灯常亮，电源接入正常</li>
<li>橙色灯亮全双工状态，不亮半双工状态<h1 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h1>我认为最简单的方法如下:</li>
<li>树莓派默认没有开启ssh，把sd卡用读卡器插到电脑上，创建一个名为ssh的文件</li>
<li>直接用网线连在家里的路由器上，通过路由器后台查看ip地址连接<br><code>ssh pi@xxx.xxx.xxx.xxx</code><br>默认密码为raspberry<h1 id="设置中文显示"><a href="#设置中文显示" class="headerlink" title="设置中文显示"></a>设置中文显示</h1>打开系统设置<code>sudo raspi-config</code></li>
</ol>
<ul>
<li>Localisation Options -&gt; Change Locale</li>
<li>按空格选择</li>
<li>去掉en_GB.UTF-8 UTF-8</li>
<li>勾上en_US.UTF-8 UTF-8、zh_CN.UTF-8 UTF-8、zh_CN.GBK GBK</li>
<li>下一屏幕默认语言选zh_CN.UTF-8<h1 id="shadowsocks配置"><a href="#shadowsocks配置" class="headerlink" title="shadowsocks配置"></a>shadowsocks配置</h1></li>
</ul>
<ol>
<li>安装python的依赖库<br><code>sudo apt-get install python-pip python-gevent python-m2crypto</code></li>
<li>利用python安装shadowsocks，注意别忘记sudo，否则可能造成安装路径有问题而无法使用sslocal的命令<br>i</li>
<li>修改/usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py，将此文件中的52行和111行中的cleanup替换为reset，否则可能执行启动命令报错</li>
<li>创建shadowsocks的配置文件ss_conf.json，需根据shadowsocks服务器的信息替换，内容如下：<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"server"</span>:<span class="string">"server_ip"</span>,</span><br><span class="line"><span class="attr">"server_port"</span>:server_port,</span><br><span class="line"><span class="attr">"local_address"</span>:<span class="string">"127.0.0.1"</span>,</span><br><span class="line"><span class="attr">"local_port"</span>:<span class="number">1080</span>,</span><br><span class="line"><span class="attr">"password"</span>:<span class="string">"password"</span>,</span><br><span class="line"><span class="attr">"timeout"</span>:<span class="number">600</span>,</span><br><span class="line"><span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>最后执行启动命令<br><code>sudo sslocal -c ./ss_conf.json -d start</code><h1 id="privoxy配置"><a href="#privoxy配置" class="headerlink" title="privoxy配置"></a>privoxy配置</h1>在树莓派下命令行梯子是十分有必要的，给http,https设置代理使用privoxy。</li>
<li>安装privoxy<br><code>sudo apt install privoxy</code></li>
<li>修改配置文件<br><code>sudo vi /etc/privoxy/config</code><br>783行，去掉注释<br><code>listen-address 127.0.0.1:8118</code><br>1336行，去掉注释，注意与ss地址端口号保持一致<br><code>forward-socks5t / 127.0.0.1:1080</code></li>
<li>配置开机启动<br><code>sudo vi /etc/profile</code><br><code>export https_proxy=http://127.0.0.1:8118</code><br><code>export http_proxy=http://127.0.0.1:8118</code></li>
<li>重启<br><code>sudo systemctl restart privoxy</code><h1 id="开机启动设置"><a href="#开机启动设置" class="headerlink" title="开机启动设置"></a>开机启动设置</h1>这个步骤估计是我爬坑时间最长的地方，写入命令到rc.local配置文件中即可实现开机启动的功能，然而到树莓派上始终无法实现，树莓派已经不支持这种自启方式了。</li>
</ol>
<ul>
<li>创建一个文件写入自启命令<br><code>sudo vi /etc/rc.local</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh -e</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rc.local</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Make sure that the script will <span class="string">"exit 0"</span> on success or any other</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> value on error.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In order to <span class="built_in">enable</span> or <span class="built_in">disable</span> this script just change the execution</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bits.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default this script does nothing.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Print the IP address</span></span><br><span class="line">_IP=$(hostname -I) || true</span><br><span class="line">if [ "$_IP" ]; then</span><br><span class="line">  printf "My IP address is %s\n" "$_IP"</span><br><span class="line">fi</span><br><span class="line">sudo sslocal -c /etc/ss.json -d start</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></li>
<li>创建一个服务文件<br><code>sudo vi /lib/systemd/system/rc.local.service</code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">  This file is part of systemd.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  (at your option) any later version.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This unit gets pulled automatically into multi-user.target by</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> systemd-rc-local-generator <span class="keyword">if</span> /etc/rc.local is executable.</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=/etc/rc.local Compatibility</span><br><span class="line">ConditionFileIsExecutable=/etc/rc.local</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/rc.local start</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line">GuessMainPID=no</span><br></pre></td></tr></table></figure>
<h1 id="修改apt源"><a href="#修改apt源" class="headerlink" title="修改apt源"></a>修改apt源</h1>树莓派默认的apt源在英国，速度非常慢，即使我配置了香港的http代理，还是很慢，换成了阿里的源速度还不错。<br>修改apt源的配置文件<br><code>sudo vi /etc/apt/sources.list</code><br>注释掉原来的源，添加<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/raspbian/raspbian/ jessie main non-free contrib rpi</span><br><span class="line">deb-src http://mirrors.aliyun.com/raspbian/raspbian/ jessie main non-free contrib rpi</span><br></pre></td></tr></table></figure>
更新索引清单<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
更新依赖库<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get upgrade -y</span><br></pre></td></tr></table></figure>
<h1 id="U盘挂载和卸载"><a href="#U盘挂载和卸载" class="headerlink" title="U盘挂载和卸载"></a>U盘挂载和卸载</h1><h2 id="挂载u盘"><a href="#挂载u盘" class="headerlink" title="挂载u盘"></a>挂载u盘</h2><code>sudo mount -o umask=0000 /dev/sda1 ~/Downloads</code></li>
<li>o 配置挂载可选项，umask=0000对所有用户都可读可写可执行<br>/dev/sda1 usb分区路径<br><code>fdisk -l</code>可查看分区<br>~/Downloads 要挂载的文件夹路径<h2 id="卸载u盘"><a href="#卸载u盘" class="headerlink" title="卸载u盘"></a>卸载u盘</h2><code>sudo umount -l ~/Downloads</code></li>
<li>l 强制卸载，避免busy的错误提示<h1 id="dlna服务器搭建"><a href="#dlna服务器搭建" class="headerlink" title="dlna服务器搭建"></a>dlna服务器搭建</h1></li>
</ul>
<ol>
<li>安装dlna<br><code>apt-get install minidlna</code></li>
<li>修改配置文件<br><code>sudo vi /etc/minidlna.conf</code><br><code>media_dir=/home/pi/Downloads</code><br>修改media_dir的变量指向资源路径，这里我是挂载U盘上的资源，遇到了一个坑，需要刷新资源索引，耗了很长时间，网上很多说dlna刷新命令是<code>sudo service minidlna force-reload</code>我发现并没有作用，以为是配置文件的问题改了很多次，还是不起作用，后来发现资源刷新的正确姿势是这样：<br><code>sudo minidlna -R</code><br>然后重启服务：<br><code>sudo service minidlna restart</code><br>设置开机启动<br><code>sudo update-rc.d minidlna defaults</code><br>访问<code>http://树莓派ip地址:8200</code>查看当前服务器上的资源类型和数量<h1 id="samba服务器搭建"><a href="#samba服务器搭建" class="headerlink" title="samba服务器搭建"></a>samba服务器搭建</h1></li>
<li>安装smaba<br><code>sudo apt-get install samba samba-common-bin</code><br>第二个命令也遇到过一个坑，就是smaba的部分依赖库已经安装，且版本高于smaba依赖的版本，这个时候命令行是不会安装smaba的，网上说需要把这些已经安装的依赖库卸载掉重新安装，但是我试了这种方式仍旧无效，最后我根据当前的树莓派系统版本找到了国内的镜像源（阿里），切换apt源以后再安装就可以了。</li>
</ol>
<ul>
<li>samba服务器默认支持隐藏文件的展示，用本地编辑器直接编辑脚本，调试运行是十分方便的，推荐刚入门不太习惯vi，nano的朋友都搭建一个，不过samba服务器的搭建有很多坑，第一次安装没啥问题，卸载重装就有问题了，折腾好久，记一次踩坑过程：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dpkg: error processing package xxx</span><br><span class="line">dpkg: dependency problems prevent configuration of xxx</span><br><span class="line">xxx depends on xxx; however:</span><br><span class="line">Package xxx is not configured yet.</span><br><span class="line">Sub-process /usr/bin/dpkg returned an error code (1)</span><br></pre></td></tr></table></figure>
貌似这个错误不止在重装samba会遇到，有时apt软件升级也会遇到</li>
<li>解决步骤<br>执行以下命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mv /var/lib/dpkg/info/ /var/lib/dpkg/info_old/</span><br><span class="line">sudo mkdir /var/lib/dpkg/info/</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -f install</span><br><span class="line">sudo mv /var/lib/dpkg/info/* /var/lib/dpkg/info_old/</span><br><span class="line">sudo rm -rf /var/lib/dpkg/info</span><br><span class="line">sudo mv /var/lib/dpkg/info_old/ /var/lib/dpkg/info/</span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
再执行刚才的安装或升级命令即可</li>
</ul>
<ol start="2">
<li>修改配置文件<br><code>sudo vi /etc/samba/smb.conf</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[pi]           #共享文件的名称， 将在网络上以此名称显示</span><br><span class="line">path = /home/pi         #共享文件的路径</span><br><span class="line">valid users = pi        #允许访问的用户</span><br><span class="line">browseable = yes        #允许浏览</span><br><span class="line">writable = yes          #可写</span><br><span class="line">writelist = pi          #可写用户</span><br><span class="line">create mask = 0777      #可读可写权限</span><br><span class="line">directory mask = 0777   #可读可写权限</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>创建共享文件夹<br><code>mkdir ~/Downloads</code><br>如果树莓派的内存卡不够用，我们一般需要挂载外置的U盘或硬盘</li>
<li>创建挂载文件夹（挂载点）<br><code>mkdir ~/Downloads/diskMount</code></li>
<li>挂载硬盘或U盘<br><code>sudo mount -o umask=0000 /dev/sda5 ~/Downloads/diskMount/</code></li>
<li>如果是exfat格式的硬盘加上格式参数（兼容windows和mac）<br><code>sudo mount -t exfat -o umask=0000 /dev/sda5 ~/Downloads/diskMount/</code><br>挂载完后发现没有权限访问，需要对该文件夹下的所有文件赋予权限<br><code>sudo chmod -R 777 ~/Downloads</code><br>权限修改后需重启samba服务，文件即可访问<br><code>sudo service smbd restart</code><br>smaba4.9.5在服务启动后会在共享文件路径下生成color IA64 W32ALPHA W32MIPS W32PPC W32X86 WIN40 x64一堆文件夹，是默认配置了printer打印机引起的，这些文件夹放对应的驱动文件，如果我们注释了打印机相关的配置就不会在共享文件路径下生成这一堆文件夹<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#[printers]</span><br><span class="line">#   comment = All Printers</span><br><span class="line">#   browseable = no</span><br><span class="line">#   path = /var/spool/samba</span><br><span class="line">#   printable = yes</span><br><span class="line">#   guest ok = no</span><br><span class="line">#   read only = yes</span><br><span class="line">#   create mask = 0700</span><br><span class="line"></span><br><span class="line"># Windows clients look for this share name as a source of downloadable</span><br><span class="line"># printer drivers</span><br><span class="line">#[print$]</span><br><span class="line">#   comment = Printer Drivers</span><br><span class="line">#   path = /var/lib/samba/printers</span><br><span class="line">#   browseable = yes</span><br><span class="line">#   read only = yes</span><br><span class="line">#   guest ok = no</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>将默认用户添加到samba<br><code>sudo smbpasswd -a pi</code></li>
<li>重启smaba<br><code>sudo service samba restart</code></li>
<li>配置开机启动<br><code>systemctl enable smdb</code></li>
</ol>
<h1 id="ftp服务器搭建"><a href="#ftp服务器搭建" class="headerlink" title="ftp服务器搭建"></a>ftp服务器搭建</h1><p>ftp方便文件传输，而且vsftpd搭建服务器只有400k</p>
<ol>
<li>安装sftp<br><code>sudo apt-get install vsftpd</code></li>
<li>修改配置文件<br><code>sudo vim /etc/vsftpd.conf</code><br>配置可选项如下：<br>禁止匿名用户登录：anonymous_enable=NO<br>配置用户可以写权限：write_enable=YES<br>配置uMask：local_umask=022（077不支持断点续传，修改为022）</li>
<li>重启<br><code>sudo service vsftpd restart</code><h1 id="折腾摄像头"><a href="#折腾摄像头" class="headerlink" title="折腾摄像头"></a>折腾摄像头</h1>我在购买树莓派主板的时候，也购买了官方的摄像头，它是usb接口，插入树莓派的usb接口后，输入命令：<code>ls /dev</code>如果此时能识别到video0的设备时，代表树莓派已识别。<br>此时我们使用<code>lsusb</code>命令同样可以查看这个设备的idVendor和idProduct<h2 id="拍摄照片"><a href="#拍摄照片" class="headerlink" title="拍摄照片"></a>拍摄照片</h2>拍摄一张照片<br><code>sudo fswebcam image.jpg</code><br>预览<br><code>gpicview image.jpg</code><h2 id="搭建视频流服务器"><a href="#搭建视频流服务器" class="headerlink" title="搭建视频流服务器"></a>搭建视频流服务器</h2><h3 id="安装依赖库和编译库"><a href="#安装依赖库和编译库" class="headerlink" title="安装依赖库和编译库"></a>安装依赖库和编译库</h3><code>sudo apt install libjpeg8-dev</code><br><code>sudo apt install imagemagic</code><br><code>sudo apt install libv4l-dev</code><br><code>sudo apt install cmake</code><h3 id="安装mjpg-streamer"><a href="#安装mjpg-streamer" class="headerlink" title="安装mjpg-streamer"></a>安装mjpg-streamer</h3>克隆项目到本地并编译<br><code>sudo git clone https://github.com/jacksonliam/mjpg-streamer.git</code><br><code>cd mjpg-streamer/mjpg-streamer-experimental</code><br><code>make all</code><br><code>sudo make install</code><br>启动流服务器<br><code>./mjpg_streamer -i &quot;./input_uvc.so&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>此时报错，树莓派官方的摄像头不支持v4l的驱动，需安装UV4L兼容驱动，解决方法是<br>添加软件源<br><code>curl https://www.linux-projects.org/listing/uv4l_repo/lrkey.asc | sudo apt-key add -</code><br>修改apt-get的源列表文件<code>/etc/apt/sources.list</code>，在文件末尾添加<br><code>deb https://www.linux-projects.org/listing/uv4l_repo/raspbian/ wheezy main</code><br>再安装兼容驱动<br><code>sudo rpi-update</code><br><code>sudo apt-get update</code><br><code>sudo apt-get install uv4l uv4l-raspicam</code><br><code>sudo service uv4l_raspicam restart</code><br><code>sudo pkill uv4l</code><br><code>sudo apt-get update</code><br><code>sudo apt install uv4l-uvc</code><br><code>sudo apt install uv4l-xscreen</code><br><code>sudo apt install uv4l-mjpegstream</code><br>启动流服务器<br><code>./mjpg_streamer -i &quot;./input_uvc.so&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>发现仍然报错<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Unable to set format: 1196444237 res: 640x480</span><br><span class="line">Init v4L2 failed !! exit fatal</span><br></pre></td></tr></table></figure>
mjpg-stream支持JPEG和YUV两种格式，默认采用JPEG，这里是因为树莓派官方的摄像头不支持JPEG<br>解决方案1:<br><code>cd mjpg-streamer-experimental/plugins/input_uvc/</code><br><code>sudo vi input_uvc.c</code><br>将<code>format = V4L2_PIX_FMT_MJPEG</code>改为<code>format = V4L2_PIX_FMT_YUYV</code><br>解决方案2:<br>用命令参数-y使用YUV编码<br><code>./mjpg_streamer -i &quot;./input_uvc.so -y&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>此时看到启动信息已经启动，但是有一堆error<br>用命令参数-n来消除error<br><code>./mjpg_streamer -i &quot;./input_uvc.so -y -n&quot; -o &quot;./output_http.so -w ./www&quot;</code></li>
</ol>
<p>访问树莓派的ip:8080就可以看到采集的视频了</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jessie Kate</p>
  <div class="site-description" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  





















  

  

  


</body>
</html>
