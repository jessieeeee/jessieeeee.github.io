<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;page&#x2F;4&#x2F;index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
  <link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>JessieK's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/25/PuppeteerStart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/08/25/PuppeteerStart/" class="post-title-link" itemprop="url">nodejs爬虫-puppeteer入门</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-08-25 14:33:58" itemprop="dateCreated datePublished" datetime="2018-08-25T14:33:58+08:00">2018-08-25</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-02 23:58:24" itemprop="dateModified" datetime="2018-11-02T23:58:24+08:00">2018-11-02</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很久没有写博客了，最近忙着一个开源项目，做一个免费漫画app，抓取网易和腾讯漫画的web数据，用nodejs+koa+mongoose+socket.io搭建这个app的后端服务，客户端用react-native编写，同时适配ios和Android。本人是做Android开发的，想借此机会打开全栈技术的大门，给自己的技术栈增加一些广度。对于一个app开发者来说，app的数据源总是一个很头疼的问题，虽然现在免费的api接口有很多，但是类型就那么几种，想做一些感兴趣的app但是苦于找不到数据源。之前学react-native的时候也做过一个开源项目高仿韩寒的one一个<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="noopener">SimpleOne传送门</a>，这个app的数据全是通过抓包工具抓取官方app的接口地址（用charles或fidder即可），分析数据获得，由于数据没有做加密，所以没有花太多的成本。但是毕竟是别人的接口，出现问题不是自己可控的。后来了解到google的一个web自动化测试框架puppeteer，解析html抓取dom节点，这下就可以通过服务端访问web，抓取数据，提供接口将抓取到的数据返回给客户端，做自己感兴趣的应用了。而且自己本来对服务端的技术也感兴趣，索性借此机会学下nodejs相关的服务端技术。下面就对puppeteer这个自动化框架爬虫做一个入门总结，接触不久，如有不对的地方欢迎指正。</p>
<hr>
<h1 id="puppeteer框架背景"><a href="#puppeteer框架背景" class="headerlink" title="puppeteer框架背景"></a>puppeteer框架背景</h1><p>puppeteer是 Google Chrome 团队官方的无界面（Headless）Chrome 工具，它是一个 Node 库， web 应用自动化测试框架，提供了一些高级的 API 来控制Chrome浏览器。你也可以在开发过程中开启浏览器，实时查看运行过程方便调试。那它可以做写什么呢？</p>
<ul>
<li>生成页面的截图和PDF。</li>
<li>抓取SPA并生成预先呈现的内容（即“SSR”）。</li>
<li>从网站抓取你需要的内容。</li>
<li>自动表单提交，UI测试，键盘输入等</li>
<li>创建一个最新的自动化测试环境。使用最新的JavaScript和浏览器功能，直接在最新版本的Chrome中运行测试。</li>
<li>捕获您的网站的时间线跟踪，以帮助诊断性能问题。</li>
</ul>
<h1 id="为什么要选择puppeteer？"><a href="#为什么要选择puppeteer？" class="headerlink" title="为什么要选择puppeteer？"></a>为什么要选择puppeteer？</h1><p>nodejs的爬虫框架有很多，要根据具体的业务进行选择，比如说cheerio一类的静态网页爬虫框架就只能爬取服务端渲染的网页，不能爬取JavaScript运行后的数据，但很多时候我们需要爬取的是动态网页，而puppeteer可以完整的模拟浏览器获取网页，访问dom，且框架的运行效率也很不错，<br>支持调用Chrome的API来操纵Web，相比较Selenium或是PhantomJs，它最大的特点就是它的操作Dom可以完全在内存中进行模拟既在V8引擎中处理而不打开浏览器，是Chrome团队在维护，拥有更好的兼容性和前景。</p>
<h1 id="puppeteer如何使用？"><a href="#puppeteer如何使用？" class="headerlink" title="puppeteer如何使用？"></a>puppeteer如何使用？</h1><h2 id="安装puppeteer"><a href="#安装puppeteer" class="headerlink" title="安装puppeteer"></a>安装puppeteer</h2><p>这里有个安装的坑，别看puppeteer的安装只有<code>npm i puppeteer</code>这么一条简单的命令，但是在国内安装起来也不是这么容易的，因为它默认会去下载Chromium作为抓取数据的客户端，国内基本下载不下来，安装会失败。即使我开着ss，仍然失败了，Orz….比如说像下面这样报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Failed to download Chromium r515411! Set &quot;PUPPETEER_SKIP_CHROMIUM_DOWNLOA</span><br><span class="line">D&quot; env variable to skip download.</span><br></pre></td></tr></table></figure>
<p>我发现从最新的1.7的版本开始分离出一个轻量版的puppeteer核心库，默认不去下载Chromium。<br>当然网上也有很多教程说先忽略跳过，再去手动下载Chromium，后面可能还有一些坑要跳，个人感觉比较麻烦，这里有一个方便快捷的办法。无意中发现一个库<a href="https://github.com/valleykid/puppeteer-cn" target="_blank" rel="noopener">puppeteer-cn传送门</a>，和puppeteer完全一样，你完全可以用puppeteer-cn代替之。这个包会先去检测本地Chrome版本是否大于59，再决定是否通过一个国内源下载Chromium。这个库下载速度很快，直接就安装好了Chromium。</p>
<h2 id="使用puppeteer"><a href="#使用puppeteer" class="headerlink" title="使用puppeteer"></a>使用puppeteer</h2><p>这个无非是一些常规的API调用，可以查阅<a href="https://github.com/GoogleChrome/puppeteer/blob/v1.7.0/docs/api.md" target="_blank" rel="noopener">官方的文档</a>来实现一些自己想要的功能，这里给出一个快速上手的小例子。由于我的app是抓取免费漫画，下面就给出抓取网易免费漫画的例子</p>
<ol>
<li>引入puppeteer工具类<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer-cn'</span>)　<span class="comment">//抓取工具类</span></span><br></pre></td></tr></table></figure></li>
<li>设置模拟的pc设备<br>设置浏览器的尺寸和userAgent<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟pc设备mac</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> viewPort = &#123;</span><br><span class="line">    width: <span class="number">1920</span>,</span><br><span class="line">    height: <span class="number">1080</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> userAgent = <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span></span><br><span class="line"><span class="keyword">await</span> page.setViewport(viewPort);</span><br><span class="line"><span class="keyword">await</span> page.setUserAgent(userAgent);</span><br></pre></td></tr></table></figure></li>
<li>初始化请求客户端<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动了一个Chrome实例</span></span><br><span class="line"><span class="keyword">let</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">headless</span>: <span class="literal">true</span> &#125;)</span><br><span class="line"><span class="comment">// 浏览器中创建一个新的页面</span></span><br><span class="line"><span class="keyword">await</span> browser.newPage()</span><br></pre></td></tr></table></figure>
headless 设置为true，则不展示Chromium的访问界面，在开发过程中，为了方便调试，最好设置成false，可以实时查看运行过程。</li>
<li>跳转到目标网站<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="string">'https://manhua.163.com/category?sort=2&amp;sf=1'</span></span><br><span class="line"><span class="comment">// 跳转到目标网站</span></span><br><span class="line"><span class="keyword">await</span> page.goto(url)</span><br><span class="line"><span class="comment">// 等待时长</span></span><br><span class="line"><span class="keyword">await</span> page.waitFor(<span class="number">200</span>)</span><br></pre></td></tr></table></figure>
这个地址正好是网易漫画的官方地址在漫画列表中过滤出免费漫画</li>
<li>抓取数据，并返回</li>
</ol>
<ul>
<li>首先分析抓取到的页面数据，找出目标dom节点，<br>可以在调试的Chromium中或者在自己打开一个chrome浏览器中按下查看网页代码。<br>调出审查元素界面<br>Mac：command+option+I<br>windows/linux：ctrl+shift+I<br><img src="/images/PuppeteerStart.png" alt="图"><br>从网页代码中，我们可以找出目标数据和相关的dom节点。带有<code>comic-item</code>类选择器的div就是漫画列表的每一个数据项，其中子节点<code>cover</code>类选择器div就是数据项的图片信息部分，里面的子元素img标签的src属性就是漫画封面的图片地址。而<code>comic-info</code>类选择器的div就是数据项的文字信息部分，里面的子元素<code>.title</code>类选择器的div中包含的文字就是标题，<code>span</code>标签中包含的文字就是当前章节，<code>.muted</code>类选择器div中的文字就是点击量，漫画的跳转链接在<code>a</code>标签中的<code>href</code>属性中，得到完整的地址需要做一个拼接。<br>puppeteer是通过seletor选择器去获取元素的，了解一部分前端知识的人来说并不陌生，也没什么难度。分析完了以后，我们就可以从目标dom中提取到想要返回的数据。<br>所以最后的抓取代码如下:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> targetUrl = <span class="string">'https://manhua.163.com'</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">targetUrl</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> data = []</span><br><span class="line">    <span class="keyword">let</span> elements = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.comic-item'</span>) <span class="comment">// 获取所有漫画元素</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> element <span class="keyword">of</span> elements) &#123; <span class="comment">// 循环</span></span><br><span class="line">        <span class="keyword">let</span> title = element.querySelector(<span class="string">'.comic-info .title'</span>).innerText <span class="comment">// 获取标题</span></span><br><span class="line">        <span class="keyword">let</span> chapter = element.querySelector(<span class="string">'.comic-info span'</span>).innerText　<span class="comment">// 获取章节</span></span><br><span class="line">        <span class="keyword">let</span> clickNum = element.querySelector(<span class="string">'.comic-info div.muted'</span>).innerText <span class="comment">//　获取点击量</span></span><br><span class="line">        <span class="keyword">let</span> link = element.querySelector(<span class="string">'.comic-info a'</span>).getAttribute(<span class="string">'href'</span>)</span><br><span class="line">        link = targetUrl + link</span><br><span class="line">        <span class="keyword">let</span> cover = element.querySelector(<span class="string">'.cover img'</span>).getAttribute(<span class="string">'src'</span>)</span><br><span class="line">        <span class="comment">// let id = link.replace('https://manhua.163.com/source/','')</span></span><br><span class="line">        <span class="keyword">let</span> id = link.substring(link.lastIndexOf(<span class="string">'/'</span>)+<span class="number">1</span>,link.length)</span><br><span class="line">        data.push(&#123; id, title, chapter, clickNum, link, cover &#125;) <span class="comment">// 存入数组</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;, targetUrl)</span><br></pre></td></tr></table></figure>
通过seletor选择器去获取元素，有两种方法可以获取目标节点，一个是通过page.evaluate这个api获取到html内容后，在回调函数中调用dom节点选择器相关api获取，这个回调函数无法打印log，无法内部断点，也无法直接访问外部的变量，需要通过api最后一个参数进行传参访问，最后返回一个操作结果。另一个方法就是通过puppeteer的选择器相关api直接获取。<br>比如说这样：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的所有节点</span></span><br><span class="line"><span class="keyword">let</span> imgs = <span class="keyword">await</span> page.$$(<span class="string">'div.portrait-player .img-box'</span>)</span><br><span class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的第一个节点</span></span><br><span class="line"><span class="keyword">let</span> img = <span class="keyword">await</span> page.$$(<span class="string">'div.portrait-player .img-box'</span>)</span><br><span class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的所有节点并返回数量</span></span><br><span class="line"><span class="keyword">let</span> imagesLen = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'div.portrait-player .img-box'</span>, imgs =&gt; imgs.length)</span><br><span class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的第一个节点并返回节点的style属性中的高度值并去掉'px'单位字符串</span></span><br><span class="line"><span class="keyword">let</span> imgHeight =<span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'div.portrait-player .img-box'</span>, img =&gt; img.style.height.replace(<span class="string">'px'</span>,<span class="string">''</span>))</span><br></pre></td></tr></table></figure>
<code>page.$$</code> 抓取该选择器匹配的所有节点，对应dom获取节点querySelectorAll这个api，如果没有匹配的返回null<br><code>page.$</code> 抓取该选择器匹配的第一个节点并返回给回调函数，对应dom获取节点querySelector这个api，如果没有匹配的返回null，<br><code>page.$$eval</code> 比起<code>page.$$</code>多了一个回调函数进行抓取后的操作，抓取该选择器匹配的所有节点并返回给回调函数，在回调函数中进行数据转换操作后再返回函数结果，如果没有匹配的是抛出一个异常<br><code>page.$eval</code> 比起<code>page.$</code>多了一个回调函数进行抓取后的操作，抓取该选择器匹配的第一个节点并返回给回调函数，在回调函数中进行数据转换操作后再返回函数结果，如果没有匹配的是抛出一个异常</li>
</ul>
<p>当然，puppeteer提供的api操作远不止这些，这只是一个快速上手的小例子，更多有趣的玩法，可以参考官方的文档，这里就不一一列举了。</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/20/RN-CallNative-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/07/20/RN-CallNative-Android/" class="post-title-link" itemprop="url">react-native调android原生</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-07-20 11:03:00" itemprop="dateCreated datePublished" datetime="2018-07-20T11:03:00+08:00">2018-07-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-08-25 14:24:24" itemprop="dateModified" datetime="2018-08-25T14:24:24+08:00">2018-08-25</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>我的开源项目高仿韩寒的one一个，打算长期维护并借此机会学习react-native相关的技术，感兴趣的可以<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="noopener">戳这里</a>，此项目不是标准的react-native项目结构，而是在android studio工程项目下引入react-native的混合式开发结构，其中不少地方调用了原生的模块和原生封装的ui组件，相信在react-native跨平台还不成熟的阶段，调用原生完成开发需求是不可避免的，打算在这里对react-native调用原生的相关技术做一个总结．如果有不正确的地方还望指正，或者您有更好的解决方案也欢迎提出一起讨论</p>
<hr>
<h1 id="调用原生模块"><a href="#调用原生模块" class="headerlink" title="调用原生模块"></a>调用原生模块</h1><p>react-native调用原生模块应该是经常会用到的，我们在android studio项目中引入react-native实质上就是设置ReactRootView为activity的布局视图，初始化mReactInstanceManager进行react-native的相关配置，添加自定义的原生组件包，MainReactPackage主组件包，这个是默认添加的，在activity的生命周期中对react-native做相关配置，同时继承DefaultHardwareBackBtnHandler接口，这个接口只有invokeDefaultOnBackPressed的方法，对于android back按键，是在onBackPressed中，把所有的back事件都发到js端，如果js端没监听，或者监听都返回了false，那么就会回到invokeDefaultOnBackPressed的Activity处理。</p>
<h2 id="调用原生的场景"><a href="#调用原生的场景" class="headerlink" title="调用原生的场景"></a>调用原生的场景</h2><p>比如我们需要在react-native 的ui中加入toast提示，调用音乐播放等多媒体相关的系统api支持，调用第三方分享和登录授权……不可避免的要调用原生代码，接下来详细记录react-native js端与原生android端之间的通信方式</p>
<h2 id="react-native调用android原生"><a href="#react-native调用android原生" class="headerlink" title="react-native调用android原生"></a>react-native调用android原生</h2><p>以加入toast提示为例：</p>
<h3 id="先定义一个ReactContextBaseJavaModule"><a href="#先定义一个ReactContextBaseJavaModule" class="headerlink" title="先定义一个ReactContextBaseJavaModule"></a>先定义一个ReactContextBaseJavaModule</h3><p>自定义一个ToastModule继承ReactContextBaseJavaModule，重写其中的getName方法，返回react-native中调用时的组件名，重写getConstants方法，返回一个常量map，定义常量值的key，将所有可供调用的常量值put进去，通过对象.常量值key使用模块常量，使用｀@ReactMethod｀注解可供react-native调用的方法，@ReactMethod注解的方法返回类型一定是void，这里的回调可以有两种方式实现，第一种是callback的方式，第二种是promise的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_SHORT_KEY = <span class="string">"SHORT"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_LONG_KEY = <span class="string">"LONG"</span>;</span><br><span class="line">    <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> count=<span class="number">100000</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToastModule</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(reactContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复写方法，返回react-native中调用的组件名</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ToastNative"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复写方法，返回常量</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getConstants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, Object&gt; constants = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        constants.put(DURATION_SHORT_KEY, Toast.LENGTH_SHORT);</span><br><span class="line">        constants.put(DURATION_LONG_KEY, Toast.LENGTH_LONG);</span><br><span class="line">        <span class="keyword">return</span> constants;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用 @ReactMethod注解返回react-native中可调用的方法（使用callback的方式）</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String message, <span class="keyword">int</span> duration ,Callback successCallback, Callback errorCallback)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(getReactApplicationContext(), message, duration).show();</span><br><span class="line">        <span class="comment">// 通过invoke调用，随便你传参</span></span><br><span class="line">        <span class="keyword">if</span>(flag) &#123;</span><br><span class="line">            successCallback.invoke(<span class="string">"success"</span>, ++count);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            errorCallback.invoke(<span class="string">"error"</span>, ++count);</span><br><span class="line">        &#125;</span><br><span class="line">        flag = !flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">　  <span class="comment">//  使用 @ReactMethod注解返回react-native中可调用的方法（使用promise的方式）</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMsg</span><span class="params">(String msg, Promise promise)</span> </span>&#123;</span><br><span class="line">        String result = <span class="string">"处理结果："</span> + msg;</span><br><span class="line">        Toast.makeText(getReactApplicationContext(), result, Toast.LENGTH_SHORT).show();</span><br><span class="line">        promise.resolve(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 @ReactMethod注解返回react-native中可调用的 方法</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMsg</span><span class="params">(String message, <span class="keyword">int</span> duration)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(getReactApplicationContext(), message, duration).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">　</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注册ReactContextBaseJavaModule"><a href="#注册ReactContextBaseJavaModule" class="headerlink" title="注册ReactContextBaseJavaModule"></a>注册ReactContextBaseJavaModule</h3><p>在自定义的组件包中MyReactPackage注册这个ReactContextBaseJavaModule,其中createViewManagers方法用于注册原生ui组件，而createNativeModules方法用于注册原生模块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReactPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入原生的模块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reactContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">        List&lt;NativeModule&gt; modules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        modules.add(<span class="keyword">new</span> UShareModule(reactContext));</span><br><span class="line">        modules.add(<span class="keyword">new</span> ULoginModule(reactContext));</span><br><span class="line">        modules.add(<span class="keyword">new</span> ToastModule(reactContext));</span><br><span class="line">        modules.add(<span class="keyword">new</span> MediaPlayerModule(reactContext));</span><br><span class="line">        <span class="keyword">return</span> modules;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个MyReactPackage是我们自定义的组件包，我们需要添加到配置中</p>
<h3 id="在react-native工程结构下添加自定义的ReactPackage"><a href="#在react-native工程结构下添加自定义的ReactPackage" class="headerlink" title="在react-native工程结构下添加自定义的ReactPackage"></a>在react-native工程结构下添加自定义的ReactPackage</h3><p>修改android工程中的Application类，重写ReactNativeHost中的getPackages方法，在返回的数组中添加自定义的组件包对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">ReactApplication</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MyReactPackage myReactPackage=<span class="keyword">new</span> MyReactPackage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactNativeHost mReactNativeHost = <span class="keyword">new</span> ReactNativeHost(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUseDeveloperSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> BuildConfig.DEBUG;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(</span><br><span class="line">                    <span class="keyword">new</span> MainReactPackage(),</span><br><span class="line">                    myReactPackage</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReactNativeHost <span class="title">getReactNativeHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mReactNativeHost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在android-studio工程结构下添加自定义的ReactPackage"><a href="#在android-studio工程结构下添加自定义的ReactPackage" class="headerlink" title="在android studio工程结构下添加自定义的ReactPackage"></a>在android studio工程结构下添加自定义的ReactPackage</h3><p>找到ReactActivity或者继承DefaultHardwareBackBtnHandler接口的activity中的mReactInstanceManager，添加一个自定义的组件包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ReactRootView mReactRootView;</span><br><span class="line"><span class="keyword">private</span> ReactInstanceManager mReactInstanceManager;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    ...</span><br><span class="line">    mReactRootView = <span class="keyword">new</span> ReactRootView(<span class="keyword">this</span>);</span><br><span class="line">    mReactInstanceManager = ReactInstanceManager.builder()</span><br><span class="line">            .setApplication(getApplication())</span><br><span class="line">            .setBundleAssetName(<span class="string">"index.android.bundle"</span>)</span><br><span class="line">            .setJSMainModuleName(<span class="string">"index.android"</span>)</span><br><span class="line">            .addPackage(<span class="keyword">new</span> MainReactPackage())</span><br><span class="line">            .addPackage(<span class="keyword">new</span> MyReactPackage())</span><br><span class="line">            .addPackage(<span class="keyword">new</span> ImagePickerPackage())</span><br><span class="line">            .setUseDeveloperSupport(BuildConfig.DEBUG)</span><br><span class="line">            .setInitialLifecycleState(mLifecycleState)</span><br><span class="line">            .build();</span><br><span class="line">    mReactRootView.startReactApplication(mReactInstanceManager,</span><br><span class="line">            <span class="string">"SimpleOne"</span>, <span class="keyword">null</span>);</span><br><span class="line">    mReactInstanceManager.getDevSupportManager().showDevOptionsDialog();</span><br><span class="line">    setContentView(mReactRootView);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以只要实现了ReactPackage和ReactContextBaseJavaModule，将它注册到ReactNativeHost或者ReactInstanceManager，就可以在React Native中调用原生模块了。</p>
<h3 id="在react-native中使用"><a href="#在react-native中使用" class="headerlink" title="在react-native中使用"></a>在react-native中使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NativeModules &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="keyword">let</span> toast = NativeModules.ToastNative;</span><br><span class="line">toast.show(<span class="string">'Toast message'</span>,toast.SHORT,(message,count)=&gt;&#123;<span class="built_in">console</span>.log(<span class="string">"success"</span>,message,count)&#125;,(message,count)=&gt;&#123;<span class="built_in">console</span>.log(<span class="string">"error"</span>,message,count)&#125;)</span><br><span class="line">toast.showMsg(<span class="string">'今晚22:30主播在这里等你'</span>,toast.SHORT);</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是，callback／promise 在执行invoke／（reject、resolve）之后，都会在js的消息队列中被销毁。callback／promise只能用于一次返回，也就是说不能多次调用callback／promise来与react-native的组件进行通信，在一些场景下这种callback／promise的通信方式是不实用的，比如说我们调用android系统api来播放音乐，我们需要监听音乐的播放状态和进度，这里需要原生模块主动与react-native通信而且是多次通信，我们需要采用另一种通信方式，就是emit，有点类似android的广播，发送一条消息给js端，js端注册监听接收这条消息</p>
<h1 id="Android原生调react-native"><a href="#Android原生调react-native" class="headerlink" title="Android原生调react-native"></a>Android原生调react-native</h1><p>以实现播放音乐，监听音乐的播放状态和进度为例，我们需要让android主动向react-native多次发送消息，我们同样需要定义一个ReactContextBaseJavaModule，并且在自定义的组件包MyReactPackage中的createNativeModules方法里注册，跟前面的做法完全一样就不再赘述了，这里我们需要关心的是如何主动发送消息</p>
<h2 id="Android端主动发消息"><a href="#Android端主动发消息" class="headerlink" title="Android端主动发消息"></a>Android端主动发消息</h2><p>reactContext在我们注册ReactContextBaseJavaModule的时候由MyReactPackage中的createNativeModules方法传入，通过reactContext得到当前的JSModule调用它的emit方法，可以传两个参数，一个事件名称和一个WritableMap对象，事件名称需要与react-native注册监听的事件名称参数对应起来，而这个WritableMap对象存放的就是所有需要传递的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendEvent</span><span class="params">(ReactContext reactContext, String eventName, WritableMap map)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"reactContext="</span>+reactContext);</span><br><span class="line">    reactContext</span><br><span class="line">                .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)</span><br><span class="line">                .emit(eventName,map);</span><br><span class="line">&#125;</span><br><span class="line">WritableMap map=Arguments.createMap();</span><br><span class="line">map.putString(<span class="string">"state"</span>,LOADING_MEDIA_SUCCESS);</span><br><span class="line">sendEvent(mContext,PLAY_STATE,map);</span><br></pre></td></tr></table></figure>

<h2 id="react-native注册监听接收消息"><a href="#react-native注册监听接收消息" class="headerlink" title="react-native注册监听接收消息"></a>react-native注册监听接收消息</h2><p>这里我们需要对发送的事件名称注册监听，与发送消息时事件名称的传参保持一致，在回调中处理接收到消息以后的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.listener = <span class="function">(<span class="params">reminder</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'当前状态'</span> + reminder.state);</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">this</span>.props.isVisible)&#123;</span><br><span class="line">               <span class="keyword">if</span> (reminder.state === constants.STOP_PLAY_MEDIA || reminder.state === constants.PLAY_EXCEPTION || reminder.state == constants.PLAY_COMPLETE) &#123;</span><br><span class="line">                   <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                       isPlay: <span class="literal">false</span>,</span><br><span class="line">                   &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">DeviceEventEmitter.addListener(constants.PLAY_STATE, <span class="keyword">this</span>.listener)</span><br></pre></td></tr></table></figure>
<p>如果你在这个回调逻辑中刷新了ui，然而这个页面当前并没绘制，react-native会发出警告，对应的还有取消监听的方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DeviceEventEmitter.removeAllListeners(constants.PLAY_STATE);　<span class="comment">//移除该事件所有监听</span></span><br><span class="line">DeviceEventEmitter.removeListener(constants.PLAY_STATE,listener); <span class="comment">//移除该事件的指定监听</span></span><br></pre></td></tr></table></figure>
<p>这里我们需要注意的是一旦调用了DeviceEventEmitter.removeAllListeners方法，影响的不只有当前页面的监听，所有页面的监听都被移除了，移除当前页面的监听是第二个</p>
<h1 id="调原生ui组件"><a href="#调原生ui组件" class="headerlink" title="调原生ui组件"></a>调原生ui组件</h1><p>由于react-native官方提供的滚轮组件可定制性比较低，DatePickerIOS和DatePickerAndroid，调用的都是原生的日期滚轮选择器，也没找到合适的第三方库，无法达到设计的效果，所以采用了自定义原生ui组件的方案，给react-native暴露接口，让react-native调用原生的ui组件，这里我们以自定义日期选择滚轮为例，记录一下react-native调用原生ui组件的过程。</p>
<h2 id="封装组件"><a href="#封装组件" class="headerlink" title="封装组件"></a>封装组件</h2><h3 id="绘制单个滚轮"><a href="#绘制单个滚轮" class="headerlink" title="绘制单个滚轮"></a>绘制单个滚轮</h3><p>常规方式继承View，在onDraw中用canvas直接绘制，监听手势，根据手指滑动的距离对当前滚轮选项进行刷新。注意一下边界判断，当前选择项下标小于0时，选择最后一项，当前项下标大于最后一项下标，选择第一项。手指抬起时滚动到当前选择项的中间位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WheelView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"WheelView"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动回滚到中间的速度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> SPEED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 除选中item外，上下各需要显示的备选项数目</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHOW_SIZE = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; itemList;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * item高度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemHeight = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 选中的位置，这个位置是mDataList的中心位置，一直不变</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentItem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Paint selectPaint;</span><br><span class="line">    <span class="keyword">private</span> Paint mPaint;</span><br><span class="line">    <span class="comment">// 画背景图中单独的画笔</span></span><br><span class="line">    <span class="keyword">private</span> Paint centerLinePaint;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> centerY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> centerX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mLastDownY;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 滑动的距离</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mMoveLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isInit = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> SelectListener mSelectListener;</span><br><span class="line">    <span class="keyword">private</span> Timer timer;</span><br><span class="line">    <span class="keyword">private</span> MyTimerTask mTask;</span><br><span class="line"></span><br><span class="line">    Handler updateHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(mMoveLen) &lt; SPEED) &#123;</span><br><span class="line">                <span class="comment">// 如果偏移量少于最少偏移量</span></span><br><span class="line">                mMoveLen = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != timer) &#123;</span><br><span class="line">                    timer.cancel();</span><br><span class="line">                    timer.purge();</span><br><span class="line">                    timer = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mTask.cancel();</span><br><span class="line">                    mTask = <span class="keyword">null</span>;</span><br><span class="line">                    performSelect();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 这里mMoveLen / Math.abs(mMoveLen)是为了保有mMoveLen的正负号，以实现上滚或下滚</span></span><br><span class="line">                mMoveLen = mMoveLen - mMoveLen / Math.abs(mMoveLen) * SPEED;</span><br><span class="line">            &#125;</span><br><span class="line">            invalidate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WheelView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WheelView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnSelectListener</span><span class="params">(SelectListener listener)</span> </span>&#123;</span><br><span class="line">        mSelectListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWheelStyle</span><span class="params">(<span class="keyword">int</span> style)</span> </span>&#123;</span><br><span class="line">        itemList = WheelStyle.getItemList(context, style);</span><br><span class="line">        <span class="keyword">if</span> (itemList != <span class="keyword">null</span>) &#123;</span><br><span class="line">            itemCount = itemList.size();</span><br><span class="line">            resetCurrentSelect();</span><br><span class="line">            invalidate();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"item is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWheelItemList</span><span class="params">(List&lt;String&gt; itemList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.itemList = itemList;</span><br><span class="line">        <span class="keyword">if</span> (itemList != <span class="keyword">null</span>) &#123;</span><br><span class="line">            itemCount = itemList.size();</span><br><span class="line">            resetCurrentSelect();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"item is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetCurrentSelect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (currentItem &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            currentItem = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (currentItem &gt;= itemCount) &#123;</span><br><span class="line">            currentItem--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentItem &gt;= <span class="number">0</span> &amp;&amp; currentItem &lt; itemCount) &#123;</span><br><span class="line">            invalidate();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"current item is invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> itemCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 选择选中的item的index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentItem</span><span class="params">(String selected)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;itemList.size();i++)&#123;</span><br><span class="line">            String item=itemList.get(i);</span><br><span class="line">            <span class="keyword">if</span>(item.equals(selected))&#123;</span><br><span class="line">                currentItem = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resetCurrentSelect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentItem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> mViewHeight = getMeasuredHeight();</span><br><span class="line">        <span class="keyword">int</span> mViewWidth = getMeasuredWidth();</span><br><span class="line">        centerX = (<span class="keyword">float</span>) (mViewWidth / <span class="number">2.0</span>);</span><br><span class="line">        centerY = (<span class="keyword">float</span>) (mViewHeight / <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line">        isInit = <span class="keyword">true</span>;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">        timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        itemList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        mPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        mPaint.setStyle(Style.FILL);</span><br><span class="line">        mPaint.setTextAlign(Align.CENTER);</span><br><span class="line">        mPaint.setColor(getResources().getColor(R.color.wheel_unselect_text));</span><br><span class="line">        mPaint.setTextSize(SizeConvertUtil.spTopx(context, <span class="number">15</span>));</span><br><span class="line"></span><br><span class="line">        selectPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        selectPaint.setStyle(Style.FILL);</span><br><span class="line">        selectPaint.setTextAlign(Align.CENTER);</span><br><span class="line">        selectPaint.setColor(getResources().getColor(R.color.wheel_select));</span><br><span class="line">        selectPaint.setTextSize(SizeConvertUtil.spTopx(context, <span class="number">17</span>));</span><br><span class="line"></span><br><span class="line">        centerLinePaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        centerLinePaint.setStyle(Style.FILL);</span><br><span class="line">        centerLinePaint.setTextAlign(Align.CENTER);</span><br><span class="line">        centerLinePaint.setColor(getResources().getColor(R.color.wheel_unselect_text));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">        <span class="keyword">if</span> (isInit) &#123;</span><br><span class="line">            drawData(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawData</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先绘制选中的text再往上往下绘制其余的text</span></span><br><span class="line">        <span class="keyword">if</span> (!itemList.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 绘制中间data</span></span><br><span class="line">            drawCenterText(canvas);</span><br><span class="line">            <span class="comment">// 绘制上方data</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; SHOW_SIZE + <span class="number">1</span>; i++) &#123;</span><br><span class="line">                drawOtherText(canvas, i, -<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 绘制下方data</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; SHOW_SIZE + <span class="number">1</span>; i++) &#123;</span><br><span class="line">                drawOtherText(canvas, i, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawCenterText</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// text居中绘制，注意baseline的计算才能达到居中，y值是text中心坐标</span></span><br><span class="line">        <span class="keyword">float</span> y = centerY + mMoveLen;</span><br><span class="line">        FontMetricsInt fmi = selectPaint.getFontMetricsInt();</span><br><span class="line">        <span class="keyword">float</span> baseline = (<span class="keyword">float</span>) (y - (fmi.bottom / <span class="number">2.0</span> + fmi.top / <span class="number">2.0</span>));</span><br><span class="line">        canvas.drawText(itemList.get(currentItem), centerX, baseline, selectPaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas   画布</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> position 距离mCurrentSelected的差值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type     1表示向下绘制，-1表示向上绘制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawOtherText</span><span class="params">(Canvas canvas, <span class="keyword">int</span> position, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = currentItem + type * position;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= itemCount) &#123;</span><br><span class="line">            index = index - itemCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            index = index + itemCount;</span><br><span class="line">        &#125;</span><br><span class="line">        String text = itemList.get(index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> itemHeight = getHeight() / (SHOW_SIZE * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">float</span> d = itemHeight * position + type * mMoveLen;</span><br><span class="line">        <span class="keyword">float</span> y = centerY + type * d;</span><br><span class="line"></span><br><span class="line">        FontMetricsInt fmi = mPaint.getFontMetricsInt();</span><br><span class="line">        <span class="keyword">float</span> baseline = (<span class="keyword">float</span>) (y - (fmi.bottom / <span class="number">2.0</span> + fmi.top / <span class="number">2.0</span>));</span><br><span class="line">        canvas.drawText(text, centerX, baseline, mPaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="keyword">int</span> alpha)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColorFilter</span><span class="params">(ColorFilter cf)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOpacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">super</span>.setBackground(background);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                doDown(event);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                doMove(event);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                doUp();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDown</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTask.cancel();</span><br><span class="line">            mTask = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mLastDownY = event.getY();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doMove</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        mMoveLen += (event.getY() - mLastDownY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mMoveLen &gt; itemHeight / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 往下滑超过离开距离</span></span><br><span class="line">            mMoveLen = mMoveLen - itemHeight;</span><br><span class="line">            currentItem--;</span><br><span class="line">            <span class="keyword">if</span> (currentItem &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                currentItem = itemCount - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mMoveLen &lt; -itemHeight / <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 往上滑超过离开距离</span></span><br><span class="line">            mMoveLen = mMoveLen + itemHeight;</span><br><span class="line">            currentItem++;</span><br><span class="line">            <span class="keyword">if</span> (currentItem &gt;= itemCount) &#123;</span><br><span class="line">                currentItem = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLastDownY = event.getY();</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 抬起手后mCurrentSelected的位置由当前位置move到中间选中位置</span></span><br><span class="line">        <span class="keyword">if</span> (Math.abs(mMoveLen) &lt; <span class="number">0.0001</span>) &#123;</span><br><span class="line">            mMoveLen = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTask.cancel();</span><br><span class="line">            mTask = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == timer) &#123;</span><br><span class="line">            timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        &#125;</span><br><span class="line">        mTask = <span class="keyword">new</span> MyTimerTask(updateHandler);</span><br><span class="line">        timer.schedule(mTask, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyTimerTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</span><br><span class="line">        Handler handler;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTimerTask</span><span class="params">(Handler handler)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.handler = handler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            handler.sendMessage(handler.obtainMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSelect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSelectListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSelectListener.onSelect(currentItem, itemList.get(currentItem));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"null listener"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelectListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成日期数据源"><a href="#生成日期数据源" class="headerlink" title="生成日期数据源"></a>生成日期数据源</h3><p>封装一个工具类用于生成日期滚轮选择器的数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WheelStyle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> minYear = <span class="number">1980</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> maxYear = <span class="number">2020</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Hour</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_HOUR = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Minute</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_MINUTE = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Year</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_YEAR = <span class="number">3</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Month</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_MONTH = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Day</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_DAY = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Wheel Style Light Time</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_LIGHT_TIME = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WheelStyle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getItemList</span><span class="params">(Context context, <span class="keyword">int</span> Style)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Style == STYLE_HOUR) &#123;</span><br><span class="line">            <span class="keyword">return</span> createHourString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_MINUTE) &#123;</span><br><span class="line">            <span class="keyword">return</span> createMinuteString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_YEAR) &#123;</span><br><span class="line">            <span class="keyword">return</span> createYearString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_MONTH) &#123;</span><br><span class="line">            <span class="keyword">return</span> createMonthString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_DAY) &#123;</span><br><span class="line">            <span class="keyword">return</span> createDayString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_LIGHT_TIME) &#123;</span><br><span class="line">            <span class="keyword">return</span> createWeekString(context);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"style is illegal"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createHourString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) &#123;</span><br><span class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createMinuteString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;</span><br><span class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createYearString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = minYear; i &lt;= maxYear; i++) &#123;</span><br><span class="line">            wheelString.add(Integer.toString(i)+<span class="string">'年'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createMonthString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">12</span>; i++) &#123;</span><br><span class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i)+<span class="string">'月'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createDayString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">31</span>; i++) &#123;</span><br><span class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createWeekString</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String[] timeString = context.getResources().getStringArray(R.array.weeks);</span><br><span class="line">        <span class="keyword">for</span> (String week : timeString) &#123;</span><br><span class="line">            wheelString.add(week);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createDayString</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="keyword">if</span> (isLeapMonth(month)) &#123;</span><br><span class="line">            size = <span class="number">31</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (month == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLeapYear(year)) &#123;</span><br><span class="line">                size = <span class="number">29</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                size = <span class="number">28</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            size = <span class="number">30</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= size; i++) &#123;</span><br><span class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wheelString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算闰月</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> month</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeapMonth</span><span class="params">(<span class="keyword">int</span> month)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> month == <span class="number">1</span> || month == <span class="number">3</span> || month == <span class="number">5</span> || month == <span class="number">7</span></span><br><span class="line">                || month == <span class="number">8</span> || month == <span class="number">10</span> || month == <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算闰年</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> year</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeapYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (year % <span class="number">4</span> == <span class="number">0</span> &amp;&amp; year % <span class="number">100</span> != <span class="number">0</span>) || year % <span class="number">400</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义LinearLayout绘制整个滚轮视图"><a href="#自定义LinearLayout绘制整个滚轮视图" class="headerlink" title="自定义LinearLayout绘制整个滚轮视图"></a>自定义LinearLayout绘制整个滚轮视图</h3><p>由2个滚轮组成的滚轮视图</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PickDateView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PickDateView原生Tag"</span>;</span><br><span class="line">    CallBack callBack;</span><br><span class="line">    WheelView yearWheel;</span><br><span class="line">    WheelView monthWheel;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CallBack</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">changeYear</span><span class="params">(<span class="keyword">int</span> year)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">changeMonth</span><span class="params">(<span class="keyword">int</span> month)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSure</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month, <span class="keyword">long</span> time)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallBack</span><span class="params">(CallBack callBack)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.callBack = callBack;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PickDateView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">       addCustomLayout(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(String year)</span></span>&#123;</span><br><span class="line">        yearWheel.setCurrentItem(year);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMonth</span><span class="params">(String month)</span></span>&#123;</span><br><span class="line">        monthWheel.setCurrentItem(month);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCustomLayout</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        LayoutInflater mInflater = LayoutInflater.from(context);</span><br><span class="line">        View contentView = mInflater.inflate(R.layout.wheel_select_date, <span class="keyword">null</span>);</span><br><span class="line">        yearWheel = (WheelView) contentView.findViewById(R.id.select_date_wheel_year_wheel);</span><br><span class="line">        monthWheel = (WheelView) contentView.findViewById(R.id.select_date_month_wheel);</span><br><span class="line"></span><br><span class="line">        yearWheel.setWheelStyle(WheelStyle.STYLE_YEAR);</span><br><span class="line">        yearWheel.setOnSelectListener(<span class="keyword">new</span> WheelView.SelectListener() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> selectYear = index + WheelStyle.minYear;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callBack.changeYear(selectYear);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        monthWheel.setWheelStyle(WheelStyle.STYLE_MONTH);</span><br><span class="line">        monthWheel.setOnSelectListener(<span class="keyword">new</span> WheelView.SelectListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> selectMonth = index + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callBack.changeMonth(selectMonth);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Button sureBt = (Button) contentView.findViewById(R.id.select_date_sure);</span><br><span class="line">        sureBt.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> year = yearWheel.getCurrentItem() + WheelStyle.minYear;</span><br><span class="line">                <span class="keyword">int</span> month = monthWheel.getCurrentItem();</span><br><span class="line"></span><br><span class="line">                Calendar calendar = Calendar.getInstance();</span><br><span class="line">                calendar.set(Calendar.YEAR, year);</span><br><span class="line">                calendar.set(Calendar.MONTH, month);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">long</span> setTime = calendar.getTimeInMillis();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callBack.onSure(year, month, setTime);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        addView(contentView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="给react-native暴露接口"><a href="#给react-native暴露接口" class="headerlink" title="给react-native暴露接口"></a>给react-native暴露接口</h3><p>自定义ViewManager，继承SimpleViewManager设置需要暴露的ui组件类PickDateView，重写实例化方法createViewInstance在方法内实例化ui组件类，同时在回调被调用时通知js端，发送事件消息，也是通过WritableMap传递参数列表，用<code>@ReactProp</code>注解标注的方法在react-native中作为属性传入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PickDateViewManager</span> <span class="keyword">extends</span> <span class="title">SimpleViewManager</span>&lt;<span class="title">PickDateView</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REACT_CLASS = <span class="string">"PickDateView"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PickDateViewManger原生Tag"</span>;</span><br><span class="line">    <span class="keyword">private</span> PickDateView pickDateView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> REACT_CLASS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PickDateView <span class="title">createViewInstance</span><span class="params">(<span class="keyword">final</span> ThemedReactContext reactContext)</span> </span>&#123;</span><br><span class="line">        pickDateView=<span class="keyword">new</span> PickDateView(reactContext);</span><br><span class="line">        pickDateView.setCallBack(<span class="keyword">new</span> PickDateView.CallBack() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</span><br><span class="line">                WritableMap map = Arguments.createMap();</span><br><span class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</span><br><span class="line">                map.putString(<span class="string">"msg"</span>, <span class="string">"year: "</span> + year);</span><br><span class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</span><br><span class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeMonth</span><span class="params">(<span class="keyword">int</span> month)</span> </span>&#123;</span><br><span class="line">                WritableMap map = Arguments.createMap();</span><br><span class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</span><br><span class="line">                map.putString(<span class="string">"msg"</span>, <span class="string">"month: "</span> + month);</span><br><span class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</span><br><span class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSure</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">                WritableMap map = Arguments.createMap();</span><br><span class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</span><br><span class="line"></span><br><span class="line">                WritableMap params=Arguments.createMap();</span><br><span class="line">                params.putInt(<span class="string">"year"</span>,year);</span><br><span class="line">                params.putInt(<span class="string">"month"</span>,month);</span><br><span class="line">                params.putString(<span class="string">"time"</span>,time+<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//                String paramsStr=jsonEnclose(params).toString();</span></span><br><span class="line">                map.putMap(<span class="string">"msg"</span>, params);</span><br><span class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</span><br><span class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> pickDateView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReactProp</span>(name = <span class="string">"setYear"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(PickDateView pickDateView,String year)</span> </span>&#123;</span><br><span class="line">        pickDateView.setYear(year);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReactProp</span>(name = <span class="string">"setMonth"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMonth</span><span class="params">(PickDateView pickDateView,String month)</span> </span>&#123;</span><br><span class="line">        pickDateView.setMonth(month);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注册自定义的ViewManager"><a href="#注册自定义的ViewManager" class="headerlink" title="注册自定义的ViewManager"></a>注册自定义的ViewManager</h3><p>同样需要在自定义的组件包MyReactPackage的createViewManagers方法中注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReactPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入原生的view</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reactContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">        List&lt;ViewManager&gt; viewManagers=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        viewManagers.add(<span class="keyword">new</span> PickDateViewManager());</span><br><span class="line">        viewManagers.add(<span class="keyword">new</span> ShowPlayViewManager());</span><br><span class="line">        <span class="keyword">return</span> viewManagers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在react-native中使用-1"><a href="#在react-native中使用-1" class="headerlink" title="在react-native中使用"></a>在react-native中使用</h3><h4 id="在react-native中声明原生组件"><a href="#在react-native中声明原生组件" class="headerlink" title="在react-native中声明原生组件"></a>在react-native中声明原生组件</h4><p>定义原生中也声明了的组件属性和统一接收回调消息的onChange方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;requireNativeComponent, View&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iface = &#123;</span><br><span class="line">    name: <span class="string">'PickDateView'</span>,</span><br><span class="line">    propTypes: &#123;</span><br><span class="line">        setYear: PropTypes.string,</span><br><span class="line">        setMonth: PropTypes.string,</span><br><span class="line">        <span class="comment">//回调</span></span><br><span class="line">        onChange: PropTypes.func,</span><br><span class="line">        ...View.propTypes  <span class="comment">//支持View组件的所有属性</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> RCTPickDateView = requireNativeComponent(<span class="string">'PickDateView'</span>, iface);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> RCTPickDateView;</span><br></pre></td></tr></table></figure>
<h4 id="在react-native中使用原生组件"><a href="#在react-native中使用原生组件" class="headerlink" title="在react-native中使用原生组件"></a>在react-native中使用原生组件</h4><p>绘制一个弹窗，弹窗内部使用原生的日期滚轮选择器，在弹窗弹出时加入一个展开动画，在onChange方法中接收参数obj.nativeEvent.参数名</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    AppRegistry,</span><br><span class="line">    StyleSheet,</span><br><span class="line">    Text,</span><br><span class="line">    View,</span><br><span class="line">    Modal,</span><br><span class="line">    Animated,</span><br><span class="line">    TouchableOpacity</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="keyword">import</span> PickDateView <span class="keyword">from</span> <span class="string">'../view/PickDate'</span>;</span><br><span class="line"><span class="keyword">import</span> constants <span class="keyword">from</span> <span class="string">'../Constants'</span>;</span><br><span class="line"><span class="keyword">let</span> &#123;width, height&#125; = constants.ScreenWH;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullPickDate</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">        <span class="keyword">this</span>.onLayout=<span class="keyword">this</span>.onLayout.bind(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.state=&#123;</span><br><span class="line">            expanded: <span class="literal">false</span>,</span><br><span class="line">            animation : <span class="keyword">new</span> Animated.Value()</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    showAnimation(height)&#123;</span><br><span class="line">        <span class="keyword">let</span> maxHeight=height;</span><br><span class="line">        <span class="keyword">let</span> minHeight=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> initialValue = <span class="keyword">this</span>.state.expanded ? maxHeight + minHeight : minHeight,</span><br><span class="line">            finalValue= <span class="keyword">this</span>.state.expanded ? minHeight : maxHeight + minHeight;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            expanded: !<span class="keyword">this</span>.state.expanded <span class="comment">//Step 2</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'最大高度'</span>+maxHeight);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'初始值'</span>+initialValue+<span class="string">'最终值'</span>+finalValue);</span><br><span class="line">        <span class="keyword">this</span>.state.animation.setValue(initialValue); <span class="comment">//Step 3</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.timer = setTimeout(</span><br><span class="line">            () =&gt; &#123;</span><br><span class="line">                <span class="keyword">this</span>.toggle(finalValue);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="number">5000</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    toggle(finalValue) &#123;</span><br><span class="line">        Animated.spring(</span><br><span class="line">            <span class="keyword">this</span>.state.animation,</span><br><span class="line">            &#123;</span><br><span class="line">                toValue: finalValue</span><br><span class="line">            &#125;</span><br><span class="line">        ).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;Modal</span><br><span class="line">                animationType=&#123;<span class="string">'none'</span>&#125;</span><br><span class="line">                transparent=&#123;<span class="literal">true</span>&#125;</span><br><span class="line">                visible=&#123;<span class="keyword">this</span>.props.onShow&#125;</span><br><span class="line">                onRequestClose=&#123;() =&gt; &#123;</span><br><span class="line">                    <span class="keyword">this</span>.props.onCancel();</span><br><span class="line">                &#125;&#125;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;View style=&#123;&#123;<span class="attr">width</span>: width, <span class="attr">flex</span>: <span class="number">1</span>, <span class="attr">marginTop</span>: height * <span class="number">0.08</span> + <span class="number">0.12</span> * width,<span class="attr">backgroundColor</span>: <span class="string">'rgba(0, 0, 0, 0.7)'</span>&#125;&#125;&gt;</span><br><span class="line">                    &lt;PickDateView</span><br><span class="line">                        setYear=&#123;<span class="keyword">this</span>.props.year&#125;</span><br><span class="line">                        setMonth=&#123;<span class="keyword">this</span>.props.month&#125;</span><br><span class="line">                        onLayout=&#123;<span class="keyword">this</span>.onLayout&#125;</span><br><span class="line">                        onChange=&#123;(obj) =&gt; &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">'onSure收到事件'</span> + obj.nativeEvent.msg + <span class="string">"目标id"</span> + obj.nativeEvent.msg.year);</span><br><span class="line">                            <span class="comment">//当此回调被onSure调用时</span></span><br><span class="line">                            <span class="keyword">let</span> year = obj.nativeEvent.msg.year + <span class="string">''</span>;</span><br><span class="line">                            <span class="keyword">let</span> month = obj.nativeEvent.msg.month + <span class="string">''</span>;</span><br><span class="line">                            <span class="keyword">let</span> time= obj.nativeEvent.msg.time + <span class="string">''</span>;</span><br><span class="line">                            <span class="keyword">if</span> (year !== <span class="string">'undefined'</span> &amp;&amp; month !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.props.onCancel();</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                <span class="keyword">this</span>.props.onSure(year,month,time);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;&#125;</span><br><span class="line">                        style=&#123;&#123;<span class="attr">width</span>: <span class="string">'100%'</span>, <span class="attr">flex</span>: <span class="number">0.42</span>,&#125;&#125;/&gt;</span><br><span class="line">                    &lt;TouchableOpacity style=&#123;&#123;<span class="attr">flex</span>:<span class="number">0.58</span>&#125;&#125; onPress=&#123;() =&gt; <span class="keyword">this</span>.props.onCancel()&#125;/&gt;</span><br><span class="line">                &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Modal&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onLayout(event)&#123;</span><br><span class="line">        <span class="keyword">this</span>.showAnimation(event.nativeEvent.layout.height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PullPickDate;</span><br></pre></td></tr></table></figure>




        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/09/RN-NumberScroll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/07/09/RN-NumberScroll/" class="post-title-link" itemprop="url">react-native 实现数字滚动动画</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-07-09 11:11:26" itemprop="dateCreated datePublished" datetime="2018-07-09T11:11:26+08:00">2018-07-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-03 00:08:37" itemprop="dateModified" datetime="2018-11-03T00:08:37+08:00">2018-11-03</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>自从在github上开源了高仿韩寒的one一个项目之后，空闲时间仍旧保持项目的更新和维护，目前公司没有react-native的项目，但我一直对react-native很有兴趣，所以打算一直维护下去并借此机会学习相关的技术。one一个是资讯类的app，主界面是由3个分页组成的，底部有导航栏，是一个比较大众化的展示方式，其中one分页是用日期作为顶部标题，手指每向左滑动一次就往前翻页，向右滑动一次就往后翻页，每天的展示内容就是一页列表，标题就会随着手指的翻页而刷新，显示当前展示内容的发布日期，这里的日期刷新就是一个数字滚动的动画效果。</p>
<hr>
<p>先上效果图：</p>
<p><img src="/images/react-native-number-scroll.gif" alt="效果图"></p>
<h1 id="绘制思路如下："><a href="#绘制思路如下：" class="headerlink" title="绘制思路如下："></a>绘制思路如下：</h1><ol>
<li>设置表示数字范围的数字数组</li>
<li>测量数字的绘制高度 </li>
<li>对当前文本做切割，遍历每个字符，判断当前字符是否是数字，如果是数字，根据目标数字在数字数组中的下标，和当前数字在数字数组中的下标，以及数字绘制的高度，计算出垂直方向y上需要平移的距离，执行平移动画。如果不是数字，直接绘制这个字符文本</li>
<li>文本由父组件通过props传递，注意props值变化时重置动画属性值，刷新文本内容<h1 id="定义数字布局样式"><a href="#定义数字布局样式" class="headerlink" title="定义数字布局样式"></a>定义数字布局样式</h1>数字水平排列，需要先放置一个隐藏的text测量数字的高度<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">    <span class="comment">// 数字水平浮动排列</span></span><br><span class="line">    row: &#123;</span><br><span class="line">        flexDirection: <span class="string">'row'</span>,</span><br><span class="line">        overflow: <span class="string">'hidden'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 隐藏</span></span><br><span class="line">    hide: &#123;</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">        left: <span class="number">0</span>,</span><br><span class="line">        right: <span class="number">0</span>,</span><br><span class="line">        opacity: <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="父组件需要传入的参数"><a href="#父组件需要传入的参数" class="headerlink" title="父组件需要传入的参数"></a>父组件需要传入的参数</h1>文本内容,样式,滚动时长<br>其中文本内容可以有两种传递方式：</li>
<li>通过props.text进行传递</li>
<li>通过子组件设置成文本内容直接传递<h1 id="设置数字范围"><a href="#设置数字范围" class="headerlink" title="设置数字范围"></a>设置数字范围</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定范围创建数组</span></span><br><span class="line"><span class="keyword">const</span> range = <span class="function"><span class="params">length</span> =&gt;</span> <span class="built_in">Array</span>.from(&#123; length &#125;, (x, i) =&gt; i);</span><br><span class="line"><span class="comment">// 创建"0","1","2","3","4"..."9"的数组,默认绘制数据</span></span><br><span class="line"><span class="keyword">const</span> numberRange = range(<span class="number">10</span>).map(<span class="function"><span class="params">p</span> =&gt;</span> p + <span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<h1 id="定义数字滚动动画组件"><a href="#定义数字滚动动画组件" class="headerlink" title="定义数字滚动动画组件"></a>定义数字滚动动画组件</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ticker</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义属性类型</span></span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">        text: PropTypes.string,</span><br><span class="line">        textStyle: PropTypes.oneOfType([PropTypes.number, PropTypes.object, PropTypes.array]),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 定义默认属性值</span></span><br><span class="line">    <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">        rotateTime: <span class="number">250</span>, <span class="comment">// 默认滚动时间</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    state = &#123;</span><br><span class="line">        measured: <span class="literal">false</span>, <span class="comment">// 是否已测量</span></span><br><span class="line">        height: <span class="number">0</span>, <span class="comment">// 高度</span></span><br><span class="line">        fontSize: StyleSheet.flatten(<span class="keyword">this</span>.props.textStyle).fontSize, <span class="comment">// 获取props中的字体大小</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// props变动时回调</span></span><br><span class="line">    componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            fontSize: StyleSheet.flatten(nextProps.textStyle).fontSize,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleMeasure = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            measured: <span class="literal">true</span>, <span class="comment">// 修改flag为已测量</span></span><br><span class="line">            height: e.nativeEvent.layout.height, <span class="comment">//测量高度</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渲染</span></span><br><span class="line"><span class="comment">     * @returns &#123;*&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="comment">// 获取文本内容,子组件,样式,滚动时长</span></span><br><span class="line">        <span class="keyword">const</span> &#123; text, children, textStyle, style, rotateTime &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="comment">// 获取高度, 是否测量标记</span></span><br><span class="line">        <span class="keyword">const</span> &#123; height, measured &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">        <span class="comment">// 如果未测量则透明</span></span><br><span class="line">        <span class="keyword">const</span> opacity = measured ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 文本内容获取,读取text或子组件内容,两种方式配置文本内容</span></span><br><span class="line">        <span class="keyword">const</span> childs = text || children;</span><br><span class="line">        <span class="comment">// 如果子组件是字符串,字符串渲染,否则子组件渲染</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;[styles.row, &#123; height, opacity &#125;, style]&#125;&gt;</span><br><span class="line">                &#123;<span class="comment">/*渲染逻辑*/</span>&#125;</span><br><span class="line">                &#123;numberRenderer(&#123;</span><br><span class="line">                    children: childs,</span><br><span class="line">                    textStyle,</span><br><span class="line">                    height,</span><br><span class="line">                    rotateTime,</span><br><span class="line">                    rotateItems: numberRange,</span><br><span class="line">                &#125;)&#125;</span><br><span class="line">                &#123;<span class="comment">/*测量text高度,不显示该组件*/</span>&#125;</span><br><span class="line">                &lt;Text style=&#123;[textStyle, styles.hide]&#125; onLayout=&#123;<span class="keyword">this</span>.handleMeasure&#125; pointerEvents=<span class="string">"none"</span>&gt;</span><br><span class="line">                    <span class="number">0</span></span><br><span class="line">                &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>View&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在render方法中，绘制了一个隐藏的text组件，是为了测量在当前样式下，绘制出的数字高度值<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="comment">/*测量text高度,不显示该组件*/</span>&#125;</span><br><span class="line">               &lt;Text style=&#123;[textStyle, styles.hide]&#125; onLayout=&#123;<span class="keyword">this</span>.handleMeasure&#125; pointerEvents=<span class="string">"none"</span>&gt;</span><br><span class="line">                   <span class="number">0</span></span><br><span class="line">               &lt;<span class="regexp">/Text&gt;</span></span><br></pre></td></tr></table></figure>
其中view中的numberRenderer是数字滚动动画的渲染逻辑，这个view是在测量高度之后再显示的。<br>在numberRenderer这个方法中，我们需要对当前的文本做切割得到包含文本中每个字符的字符数组，遍历切割后的字符数组，取出每一个字符，判断是否是数字，不是数字就直接绘制文本，Piece是封装的直接用text进行文本绘制的组件，如果是数字就绘制数字动画组件，Tick是封装的单个数字动画绘制的组件。<br>实现如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numberRenderer = <span class="function">(<span class="params">&#123; children, textStyle, height, rotateTime, rotateItems &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 切割子组件文本内容遍历</span></span><br><span class="line">    <span class="keyword">return</span> splitText(children).map(<span class="function">(<span class="params">piece, i</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isNumber(piece)) &#123; <span class="comment">//取单个字符，如果不是数字,直接绘制文本</span></span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                &lt;Piece key=&#123;i&#125; style=&#123;&#123; height &#125;&#125; textStyle=&#123;textStyle&#125;&gt;</span><br><span class="line">                    &#123;piece&#125;</span><br><span class="line">                &lt;<span class="regexp">/Piece&gt;</span></span><br><span class="line"><span class="regexp">            );</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ 如果是数字，绘制单个数字</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;Tick</span></span><br><span class="line"><span class="regexp">                duration=&#123;rotateTime&#125;</span></span><br><span class="line"><span class="regexp">                key=&#123;i&#125;</span></span><br><span class="line"><span class="regexp">                text=&#123;piece&#125;</span></span><br><span class="line"><span class="regexp">                textStyle=&#123;textStyle&#125;</span></span><br><span class="line"><span class="regexp">                height=&#123;height&#125;</span></span><br><span class="line"><span class="regexp">                rotateItems=&#123;rotateItems&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
文本切割和数字判断方法如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 切割</span></span><br><span class="line"><span class="keyword">const</span> splitText = <span class="function">(<span class="params">text = <span class="string">""</span></span>) =&gt;</span> (text + <span class="string">""</span>).split(<span class="string">""</span>);</span><br><span class="line"><span class="comment">// 是十进制数字判断</span></span><br><span class="line"><span class="keyword">const</span> isNumber = <span class="function">(<span class="params">text = <span class="string">""</span></span>) =&gt;</span> !<span class="built_in">isNaN</span>(<span class="built_in">parseInt</span>(text, <span class="number">10</span>));</span><br></pre></td></tr></table></figure>
直接用text进行文本绘制的组件Piece，代码如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param children 子组件(文本内容)</span></span><br><span class="line"><span class="comment"> * @param style 样式</span></span><br><span class="line"><span class="comment"> * @param height 高度</span></span><br><span class="line"><span class="comment"> * @param textStyle 文本样式</span></span><br><span class="line"><span class="comment"> * @returns 无动画绘制文本</span></span><br><span class="line"><span class="comment"> * @constructor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> Piece = <span class="function">(<span class="params">&#123; children, style, height, textStyle &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;View style=&#123;style&#125;&gt;</span><br><span class="line">            &lt;Text style=&#123;[textStyle, &#123; height &#125;]&#125;&gt;&#123;children&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>View&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
单个数字动画绘制的组件：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tick</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建动画初始值</span></span><br><span class="line"><span class="comment">     * @type &#123;&#123;animation: Animated.Value&#125;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    state = &#123;</span><br><span class="line">        animation: <span class="keyword">new</span> Animated.Value(</span><br><span class="line">            getPosition(&#123;</span><br><span class="line">                text: <span class="keyword">this</span>.props.text,</span><br><span class="line">                items: <span class="keyword">this</span>.props.rotateItems,</span><br><span class="line">                height: <span class="keyword">this</span>.props.height,</span><br><span class="line">            &#125;),</span><br><span class="line">        ),</span><br><span class="line">    &#125;;</span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="comment">// 如果高度已测量,设置动画初始值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.props.height !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                animation: <span class="keyword">new</span> Animated.Value(</span><br><span class="line">                    getPosition(&#123;</span><br><span class="line">                        text: <span class="keyword">this</span>.props.text,</span><br><span class="line">                        items: <span class="keyword">this</span>.props.rotateItems,</span><br><span class="line">                        height: <span class="keyword">this</span>.props.height,</span><br><span class="line">                    &#125;),</span><br><span class="line">                ),</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="comment">// 高度变化,重置动画初始值</span></span><br><span class="line">        <span class="keyword">if</span> (nextProps.height !== <span class="keyword">this</span>.props.height) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                animation: <span class="keyword">new</span> Animated.Value(</span><br><span class="line">                    getPosition(&#123;</span><br><span class="line">                        text: nextProps.text,</span><br><span class="line">                        items: nextProps.rotateItems,</span><br><span class="line">                        height: nextProps.height,</span><br><span class="line">                    &#125;),</span><br><span class="line">                ),</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidUpdate(prevProps) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; height, duration, rotateItems, text &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="comment">// 数字变化,用当前动画值和变化后的动画值进行插值,并启动动画</span></span><br><span class="line">        <span class="keyword">if</span> (prevProps.text !== text) &#123;</span><br><span class="line">            Animated.timing(<span class="keyword">this</span>.state.animation, &#123;</span><br><span class="line">                toValue: getPosition(&#123;</span><br><span class="line">                    text: text,</span><br><span class="line">                    items: rotateItems,</span><br><span class="line">                    height,</span><br><span class="line">                &#125;),</span><br><span class="line">                duration,</span><br><span class="line">                useNativeDriver: <span class="literal">true</span>,</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; animation &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">        <span class="keyword">const</span> &#123; textStyle, height, rotateItems &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;&#123; height &#125;&#125;&gt;</span><br><span class="line">                &lt;Animated.View style=&#123;getAnimationStyle(animation)&#125;&gt;</span><br><span class="line">                    &#123;<span class="comment">/*遍历数字范围数组绘制数字*/</span>&#125;</span><br><span class="line">                    &#123;rotateItems.map(<span class="function"><span class="params">v</span> =&gt;</span> (</span><br><span class="line">                        &lt;Text key=&#123;v&#125; style=&#123;[textStyle, &#123; height &#125;]&#125;&gt;</span><br><span class="line">                            &#123;v&#125;</span><br><span class="line">                        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                    ))&#125;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>Animated.View&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
这里就封装了一个平移动画，绘制的时候是绘制了整个范围的数字，getPosition这个方法是用来计算目标数字的y轴坐标值，根据当前数字在数组中的下标乘以测量出的数字文本绘制高度取负值，得出坐标值。具体代码如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getPosition = <span class="function">(<span class="params">&#123; text, items, height &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获得文本在数组的下标</span></span><br><span class="line">    <span class="keyword">const</span> index = items.findIndex(<span class="function"><span class="params">p</span> =&gt;</span> p === text);</span><br><span class="line">    <span class="comment">// 返回文本绘制的y轴坐标</span></span><br><span class="line">    <span class="keyword">return</span> index * height * <span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
这里需要注意数字变化后的处理，一旦数字变化，就触发动画，当父组件传递的props的值变化了，就会调用子组件的componentDidUpdate方法，可以在componentDidUpdate方法中对文本内容做比对，如果与之前props的text值不一致，表示数字变化，根据目标数字计算目标y值，执行平移动画。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">componentDidUpdate(prevProps) &#123;</span><br><span class="line">     <span class="keyword">const</span> &#123; height, duration, rotateItems, text &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">     <span class="comment">// 数字变化,用当前动画值和变化后的动画值进行插值,并启动动画</span></span><br><span class="line">     <span class="keyword">if</span> (prevProps.text !== text) &#123;</span><br><span class="line">         Animated.timing(<span class="keyword">this</span>.state.animation, &#123;</span><br><span class="line">             toValue: getPosition(&#123;</span><br><span class="line">                 text: text,</span><br><span class="line">                 items: rotateItems,</span><br><span class="line">                 height,</span><br><span class="line">             &#125;),</span><br><span class="line">             duration,</span><br><span class="line">             useNativeDriver: <span class="literal">true</span>,</span><br><span class="line">         &#125;).start();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
注意规避高度变化带来的问题，一旦高度变化，重置动画的初始值<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="comment">// 高度变化,重置动画初始值</span></span><br><span class="line">        <span class="keyword">if</span> (nextProps.height !== <span class="keyword">this</span>.props.height) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                animation: <span class="keyword">new</span> Animated.Value(</span><br><span class="line">                    getPosition(&#123;</span><br><span class="line">                        text: nextProps.text,</span><br><span class="line">                        items: nextProps.rotateItems,</span><br><span class="line">                        height: nextProps.height,</span><br><span class="line">                    &#125;),</span><br><span class="line">                ),</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
导出封装的组件：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; Tick, numberRange &#125;; <span class="comment">// 单个数字动画组件，数字范围</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ticker; <span class="comment">// 整个数字动画组件</span></span><br></pre></td></tr></table></figure>
在项目中使用，展示格式为yyyy / MM / dd的日期：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;Ticker text=&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="keyword">this</span>.state.showDate.substring(<span class="number">0</span>, <span class="number">4</span>)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;<span class="number">1000</span>&#125; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;Text style=&#123;styles.dividerText&#125;&gt;&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="string">'    /    '</span>&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;Ticker text=&#123;this.state.showDate === '0' ? '' : this.state.showDate.substring(5, 7)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;1000&#125; /</span>&gt;</span><br><span class="line">                       </span><br><span class="line">&lt;Text style=&#123;styles.dividerText&#125;&gt;&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="string">'    /    '</span>&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                       </span></span><br><span class="line"><span class="regexp">&lt;Ticker text=&#123;this.state.showDate === '0' ? '' : this.state.showDate.substring(8, 10)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;1000&#125; /</span>&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/08/Ubuntu-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/07/08/Ubuntu-start/" class="post-title-link" itemprop="url">搭建Ubuntu下的开发环境</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-07-08 13:54:00" itemprop="dateCreated datePublished" datetime="2018-07-08T13:54:00+08:00">2018-07-08</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-04-15 00:38:41" itemprop="dateModified" datetime="2019-04-15T00:38:41+08:00">2019-04-15</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Util/" itemprop="url" rel="index">
                    <span itemprop="name">Util</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近有点闲暇时间，厌倦了windows开发环境，想尝试一下ubuntu下的开发环境。本人Android开发者，也写一点前端，以前家里是mac开发环境，公司是windows开发环境，现在打算把公司的开发环境改为ubuntu，之前也看过ubuntu下搭建Android开发环境的文章，即使这样，也踩了不少的坑，折腾了几天，总算把环境搭建起来了，基本稳定。总的来说ubuntu下的开发环境不像windows和mac那么好搭建，坑点略多，但是搭建成功后运行速度是非常可观的，比起windows快了不少，也不枉费花了这么多时间。接下来总结一下ubuntu下开发的常用软件，插件，以及可能遇到的坑点。</p>
<hr>
<h1 id="安装系统遇到的问题"><a href="#安装系统遇到的问题" class="headerlink" title="安装系统遇到的问题"></a>安装系统遇到的问题</h1><p>安装系统流程比较普通，分区方案网上有很多，不过要注意两点</p>
<h2 id="安装英文版的系统"><a href="#安装英文版的系统" class="headerlink" title="安装英文版的系统"></a>安装英文版的系统</h2><p>即使不习惯英文系统也应该在安装系统时选择英文，安装完了再改回中文，因为如果是安装中文版的系统，文件夹的名称会变成下载，文档，音乐，图片．．．由于ubuntu很多时候用命令行，导致命令行输入经常切换中文不方便，我第一次安装的时候手快选了中文版，以为后面可以改，然而这个目录名是安装系统的时候就建好了的，第二次果断安装英文版</p>
<h2 id="分区的坑"><a href="#分区的坑" class="headerlink" title="分区的坑"></a>分区的坑</h2><p>ubuntu虽然可以挂载ntfs分区，但是ide在读取工程目录的时候是只读取/下面的，所以根目录的分区一定不能小</p>
<h1 id="卸载系统自带的软件"><a href="#卸载系统自带的软件" class="headerlink" title="卸载系统自带的软件"></a>卸载系统自带的软件</h1><p>有些软件系统自带，但是并不好用或者不会用到的可以卸载掉<br>以下是卸载清单<br>libreoffice-common libreoffice（可以换 WPS）<br>unity-webapps-common Amazon 链接<br>totem 自带的播放器<br>rhythmbox 自带的音乐播放器<br>empathy 自带的即时聊天应用<br>brasero 自带的光盘刻录器<br>simple-scan 扫描仪<br>gnome-mahjongg 对对碰游戏<br>aisleriot 纸牌游戏<br>gnome-mines 扫雷游戏<br>cheese webcam 应用<br>gnome-sudoku 数独游戏<br>transmission-common BT 客户端<br>gnome-orca 屏幕阅读<br>webbrowser-app 自带的浏览器（这个太难用了，有chrome 和 Firefox）<br>landscape-client-ui-install landscape 远程控制软件<br>deja-dup 备份<br>onboard 屏幕键盘</p>
<p>下面是可以批量卸载的命令<br><code>sudo apt-get remove unity-webapps-common;sudo apt-get remove totem;sudo apt-get remove rhythmbox;sudo apt-get remove empathy;sudo apt-get remove brasero;sudo apt-get remove simple-scan;sudo apt-get remove gnome-mahjongg;sudo apt-get remove aisleriot;sudo apt-get remove gnome-mines;sudo apt-get remove cheese;sudo apt-get remove transmission-common;sudo apt-get remove gnome-orca;sudo apt-get remove webbrowser-app;sudo apt-get remove gnome-sudoku;sudo apt-get remove landscape-client-ui-install;sudo apt-get remove onboard;sudo apt-get remove deja-dup;sudo apt-get remove libreoffice-common</code></p>
<p>apt-get remove –purge xxx # 移除应用及配置<br>apt-get autoremove # 移除没用的包</p>
<h1 id="apt替换阿里源"><a href="#apt替换阿里源" class="headerlink" title="apt替换阿里源"></a>apt替换阿里源</h1><h2 id="图形界面配置"><a href="#图形界面配置" class="headerlink" title="图形界面配置"></a>图形界面配置</h2><p>新手推荐使用图形界面配置： 系统设置 -&gt; 软件和更新 选择下载服务器 -&gt; “mirrors.aliyun.com”</p>
<h2 id="手动更改"><a href="#手动更改" class="headerlink" title="手动更改"></a>手动更改</h2><p>用你熟悉的编辑器打开：<br>/etc/apt/sources.list<br>替换默认的<br><a href="http://archive.ubuntu.com/为mirrors.aliyun.com" target="_blank" rel="noopener">http://archive.ubuntu.com/为mirrors.aliyun.com</a><br>以Ubuntu 14.04.5 LTS为例，最后的效果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">deb https://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse</span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse</span><br><span class="line">## Not recommended</span><br><span class="line"># deb https://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<p>ubuntu 16.04 配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br></pre></td></tr></table></figure>
<p>ubuntu 18.04(bionic) 配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<h1 id="设置中文输入法"><a href="#设置中文输入法" class="headerlink" title="设置中文输入法"></a>设置中文输入法</h1><p>sudo add-apt-repository ppa:fcitx-team/nightly<br>sudo apt-get update<br>安装fcitx<br>sudo apt-get install fcitx<br>安装fcitx的配置工具<br>sudo apt-get install fcitx-config-gtk<br>安装fcitx的table-all软件包<br>sudo apt-get install fcitx-table-al l<br>安装输入法切换工具<br>sudo apt-get install im-switch<br>设置语言选项：将键盘输入法系统由默认的iBus设置为fcitx<br>安装了搜狗输入法后频繁崩溃，索性就用fcitx自带的，并没觉得有什么不同</p>
<h1 id="命令行相关"><a href="#命令行相关" class="headerlink" title="命令行相关"></a>命令行相关</h1><p>bash对应配置文件为.bashrc<br>zsh对应配置文件为.zshrc<br>oh-my-zsh是基于zsh的功能做了一个扩展，方便的插件管理、主题自定义，以及漂亮的自动完成效果。比默认的bash好用</p>
<h2 id="安装zsh"><a href="#安装zsh" class="headerlink" title="安装zsh"></a>安装zsh</h2><p>sudo apt-get install zsh</p>
<h2 id="安装ohmyzsh"><a href="#安装ohmyzsh" class="headerlink" title="安装ohmyzsh"></a>安装ohmyzsh</h2><h3 id="git源码"><a href="#git源码" class="headerlink" title="git源码"></a>git源码</h3><p>git clone git://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh<br>cd oh-my-zsh/tools<br>./install.sh</p>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>sh -c “$(curl -fsSL <a href="https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;" target="_blank" rel="noopener">https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</a></p>
<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><p>sh -c “$(wget <a href="https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh" target="_blank" rel="noopener">https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh</a> -O -)”</p>
<h2 id="修改默认shell"><a href="#修改默认shell" class="headerlink" title="修改默认shell"></a>修改默认shell</h2><p>ubuntu下默认的shell是bash，修改它为zsh&amp;ohmyzsh<br>chsh -s /bin/zsh</p>
<h2 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h2><p>修改~/.zshrc中的ZSH_THEME</p>
<h2 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h2><p>修改~/.zshrc中的plugins=(git bundler osx rake ruby)<br>常用插件<br>wd 快速进入<br>zsh-syntax-highlighting 语法高亮<br>zsh-autosuggestions 历史记录提示<br>svn<br>adb<br>yarn</p>
<h2 id="图形化svn与git管理工具"><a href="#图形化svn与git管理工具" class="headerlink" title="图形化svn与git管理工具"></a>图形化svn与git管理工具</h2><p>rabbitvcs</p>
<ol>
<li>添加PPA源<br>sudo add-apt-repository ppa:rabbitvcs/ppa<br>如果导入密钥失败，则在 /etc/apt/sources.list 文件中加入:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://ppa.launchpad.net/rabbitvcs/ppa/ubuntu **DISTRIBUTION** main</span><br></pre></td></tr></table></figure></li>
<li>更新源<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure></li>
<li>安装依赖<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-nautilus python-configobj python-gtk2 python-glade2 python-svn python-dbus python-dulwich subversion meld</span><br></pre></td></tr></table></figure></li>
<li>安装RabbitVCS<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install rabbitvcs-cli  rabbitvcs-core rabbitvcs-gedit rabbitvcs-nautilus</span><br></pre></td></tr></table></figure></li>
<li>重启文件浏览器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nautilus -q </span><br><span class="line">nautilus</span><br></pre></td></tr></table></figure>
<h1 id="shadowsocks相关"><a href="#shadowsocks相关" class="headerlink" title="shadowsocks相关"></a>shadowsocks相关</h1>作为开发者ss是必不可少的，特别是习惯了google的，完全无法忍受没有梯子的日子，ubuntu下配置shadowsocks稍微有些麻烦。<br>首先我们要下载shadowsocks的无图形界面版本，我用过图形界面版qt5，太不稳定了。<br>sudo apt update<br>sudo apt install python-gevent python-pip<br>pip install shadowsocks<br>编辑配置文件<br>vim /etc/ss.json<br>server 服务器地址<br>server_port 端口<br>local_port 本地端口<br>password 密码<br>method 加密方式 跟服务器保持一致<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">&quot;server&quot;:&quot;server_ip&quot;,</span><br><span class="line">&quot;server_port&quot;:30696,</span><br><span class="line">&quot;local_port&quot;:1080,</span><br><span class="line">&quot;password&quot;:&quot;password&quot;,</span><br><span class="line">&quot;timeout&quot;:600,</span><br><span class="line">&quot;method&quot;:&quot;rc4-md5&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ubuntu自带开机启动项设置工具 startupapplications点击add添加<br>name和comment随意填写，command填写为sudo sslocal -c /etc/ss.json -d start<br>配置好了以后，我们需要修改本机代理，windows、mac都是不需要的<br>这里有一个坑点ubuntu18上启动shadowsocks，openssl.py会报错，将此文件中的52行和111行中的cleanup替换为reset，否则可能执行启动命令报错<h2 id="全部请求用代理"><a href="#全部请求用代理" class="headerlink" title="全部请求用代理"></a>全部请求用代理</h2>SystemSetting-&gt;Network-&gt;-&gt;NetworkProxy<br>Method设置为Ｍanual<br>sockshost 127.0.0.1 1080，然后Apply System Wide<h2 id="添加规则，部分代理"><a href="#添加规则，部分代理" class="headerlink" title="添加规则，部分代理"></a>添加规则，部分代理</h2>安装genpac<br>sudo apt-get install python-pip<br>sudo pip install genpac<br>使用genpac生成autoproxy.pac规则文件<br>genpac -p “SOCKS5 127.0.0.1:1080” –output=”autoproxy.pac”<br>让系统应用规则<br>SystemSetting-&gt;Network-&gt;NetworkProxy<br>Method设置为Automatic<br>Configuration Url填”file:///home/xxx/autoproxy.pac”，然后Apply System Wide<br>chrome和firefox都要安装Proxy SwitchyOmega插件<br>方便我们设置自动切换规则<h2 id="http代理"><a href="#http代理" class="headerlink" title="http代理"></a>http代理</h2>如果是命令行，很多只支持http协议的软件或者工具，我们再配置一次http代理<h3 id="安装privoxy"><a href="#安装privoxy" class="headerlink" title="安装privoxy"></a>安装privoxy</h3>sudo apt-get install privoxy<h3 id="配置privoxy"><a href="#配置privoxy" class="headerlink" title="配置privoxy"></a>配置privoxy</h3>打开/etc/privoxy/config<br>取消listen-address localhost:8118的代码注释<br>找到5.2节<br>加入一句<br>forward-socks5 / 127.0.0.1:1080 .<br>重启privoxy服务<br>sudo /etc/init.d/privoxy restart<br>开机自启privoxy服务<br>sudo /etc/init.d/privoxy start加入到/etc/rc.local文件中的exit 0这句之前<br>在profile中写入http代理<br>export http_proxy=”127.0.0.1:8118”<br>export https_proxy=”127.0.0.1:8118”</li>
</ol>
<h1 id="Ubuntu软件集合"><a href="#Ubuntu软件集合" class="headerlink" title="Ubuntu软件集合"></a>Ubuntu软件集合</h1><p>chrome 开发者必备浏览器，自带有firefox<br>Typora markdown编辑器<br>Deepin Screenshot深度截图(Ubuntu Software中安装)<br>electronic wechat 微信<br>快速启动ULauncher<br>Redshift 自动调节屏幕色温<br>Android studio android开发者都懂<br>Webstorm 前端开发利器<br>vscode 微软出的开发神器，轻量级<br>mpv 播放器<br>angrySearch文件搜索<br>ubuntu-tweak 集清理，主题管理，字体管理，热区自定义于一体的软件，可替代ubuntu-tweak-tool，这个软件会默认安装系统自带的浏览器<br>(2018-5-31 新版的ubuntu18移除了unity桌面,这个没啥用了,可换成gnome-tweak-tool)</p>
<h2 id="ubuntu18-gnome主题定制"><a href="#ubuntu18-gnome主题定制" class="headerlink" title="ubuntu18 gnome主题定制"></a>ubuntu18 gnome主题定制</h2><p><a href="https://www.gnome-look.org/" target="_blank" rel="noopener">定制资源下载</a><br>光标: 下载解压后放到/usr/share/icons/目录<br>GTK主题: 下载解压后放到/usr/share/themes/目录<br>图标: 下载解压放到/usr/share/icons/目录<br>shell主题: 下载解压放到/usr/share/themes/目录 (需要安装gnome shell extension)<br>(使用gnome tweak tool-&gt;apperance前面按钮安装zip,会放到~/.local/share/themes下)<br>重启gnome tweak tool,才可在gnome tweak tool中找到</p>
<h1 id="wps-金山wps有linux版"><a href="#wps-金山wps有linux版" class="headerlink" title="wps 金山wps有linux版"></a>wps 金山wps有linux版</h1><p>安装后进入，报字体缺失<br>下载字体包<br>百度云<a href="http://pan.baidu.com/s/1nuS5U5b" target="_blank" rel="noopener">http://pan.baidu.com/s/1nuS5U5b</a> 密码：p4vz</p>
<ol>
<li>解压</li>
<li>把wps_symbol_fonts目录拷贝到 /usr/share/fonts/ 目录下</li>
<li>权限添加<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> /usr/share/fonts/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chmod 755 wps_symbol_fonts</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> /usr/share/fonts/wps_symbol_fonts</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chmod 644 *</span></span><br></pre></td></tr></table></figure></li>
<li>生成缓存配置信息<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> /usr/share/fonts/wps_symbol_fonts</span></span><br><span class="line"><span class="meta">#</span><span class="bash">mkfontdir</span></span><br><span class="line"><span class="meta">#</span><span class="bash">mkfontscale</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">fc</span>-cache</span></span><br></pre></td></tr></table></figure>
<h1 id="小程序开发工具"><a href="#小程序开发工具" class="headerlink" title="小程序开发工具"></a>小程序开发工具</h1>微信开发者工具(微信小程序)linux完美支持<br><a href="https://github.com/cytle/wechat_web_devtools" target="_blank" rel="noopener">https://github.com/cytle/wechat_web_devtools</a></li>
</ol>
<h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><p>wireshark<br><a href="https://blog.csdn.net/xukai871105/article/details/31008635" target="_blank" rel="noopener">https://blog.csdn.net/xukai871105/article/details/31008635</a><br>charles也有linux版</p>
<h1 id="qq-解决方案"><a href="#qq-解决方案" class="headerlink" title="qq 解决方案"></a>qq 解决方案</h1><p>优麒麟qq，表情显示不出来且发送错误，版本很老<br>Wine-QQ-TIM，使用几天后出现电脑无故卡死，输入法切换不了，无法启动等问题<br>Wine真的不好用，还不如虚拟机<br>一番折腾后，还是卸载了qq，珍爱生命，远离qq</p>
<h1 id="微信-解决方案-（2019-4-15更新）"><a href="#微信-解决方案-（2019-4-15更新）" class="headerlink" title="微信 解决方案 （2019.4.15更新）"></a>微信 解决方案 （2019.4.15更新）</h1><ul>
<li>目前发现electronic-wechat就是最好的解决方案没有之一，基于web微信用Electron封装并开源<br><a href="https://github.com/geeeeeeeeek/electronic-wechat" target="_blank" rel="noopener">传送门</a><h1 id="钉钉-解决方案-（2019-4-15更新）"><a href="#钉钉-解决方案-（2019-4-15更新）" class="headerlink" title="钉钉 解决方案 （2019.4.15更新）"></a>钉钉 解决方案 （2019.4.15更新）</h1></li>
<li>目前发现dingtalk就是最好的解决方案没有之一，基于web钉钉用Electron封装并开源<br><a href="https://github.com/nashaofu/dingtalk" target="_blank" rel="noopener">传送门</a><h1 id="virtualbox-amp-genymotion"><a href="#virtualbox-amp-genymotion" class="headerlink" title="virtualbox&amp;genymotion"></a>virtualbox&amp;genymotion</h1>虚拟机和Android模拟器<br>在virtualbox下安装win7，解决ubuntu下无法解决的问题<br>安装virtualbox时注意安装ubuntu最新版本，如果开了intel虚拟技术，还是卡开机界面，可能是当前显卡驱动问题，不要选择opensource版本的显卡驱动<br>genymotion尽量选择最新的版本，这里有个坑，如果卡死，内存分配尽量大一点</li>
</ul>
<h1 id="拾色器"><a href="#拾色器" class="headerlink" title="拾色器"></a>拾色器</h1><p>前端开发，app开发必不可少的工具<br>Deepin picker 深度取色器(Ubuntu Software中安装)<br>添加快捷键：<br>Settings -&gt; Devices -&gt; Keyboard commond为:/usr/bin/deepin-picker<br>同理，添加截图的快捷键<br>Settings -&gt; Devices -&gt; Keyboard commond为:/usr/bin/deepin-screenshot</p>
<h1 id="系统备份"><a href="#系统备份" class="headerlink" title="系统备份"></a>系统备份</h1><p>辛苦折腾的系统最好做个备份 ,remastersys这个系统备份工具是不错，但是备份文件大于4g就会备份失败，官方文档也说了这个问题是iso9660的限制，目前无解。<br>后来发现一个更好用的工具，Timeshift类似mac上的TimeMachine，按备份时间点创建快照，对快照可进行管理，有备份计划等功能，可以实现增强备份和完整备份。</p>
<p>目前就总结到这里，后面如果发现更好用的软件，插件，坑点会持续更新～</p>
<ul>
<li>2018.11.11爬坑<br>Android studio真机调试会报一个错，发现设备无法被识别<br><code>error insufficient permissions for device user in plugdev group are your udev rules wrong</code><br>解决方案：</li>
</ul>
<ol>
<li>lsusb命令查出所有通过usb连接pc的设备，找出那个正在调试的读不出型号的设备<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Bus 001 Device 004: ID 0424:2514 Standard Microsystems Corp. USB 2.0 Hub</span><br><span class="line">Bus 001 Device 003: ID 1bcf:2984 Sunplus Innovation Technology Inc.</span><br><span class="line">Bus 001 Device 006: ID 2717:9039</span><br><span class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br><span class="line">Bus 003 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span><br><span class="line">Bus 002 Device 002: ID 046d:c077 Logitech, Inc.</span><br></pre></td></tr></table></figure>
注意ID后XXXX:XXXX的参数，前一个是idVendor，后一个是idProduct</li>
<li>创建adb_usb.ini文件，写入idVendor到~/.android/adb_usb.ini，内容格式为<code>0xidVendor</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0x2717&gt; ~/.android/adb_usb.ini</span><br></pre></td></tr></table></figure>
这一步官网上没有提到，导致后面<code>android.rules</code>文件一直报<code>SUBSYSTEM==&quot;usb&quot;</code>有错</li>
</ol>
<ul>
<li>以下步骤可以解决Android studio无法识别设备XXXX[null]的问题</li>
</ul>
<ol start="3">
<li>添加Usb设备配置文件，创建文件并写入以下内容<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/udev/rules.d/70-android.rules</span><br><span class="line">SUBSYSTEM==&quot;usb&quot;, ATTRS&#123;idVendor&#125;==&quot;2717&quot;, ATTRS&#123;idProduct&#125;==&quot;9039&quot;,MODE=&quot;0666&quot;</span><br></pre></td></tr></table></figure></li>
<li>给配置文件添加权限<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod a+rx /etc/udev/rules.d/70-android.rules</span><br></pre></td></tr></table></figure></li>
<li>重新加载usb配置规则文件，重启adb服务并查看<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo udevadm control --reload-rules &amp;&amp; sudo service udev restart &amp;&amp; sudo udevadm trigger</span><br><span class="line">adb kill-server &amp;&amp; adb start-server</span><br><span class="line">adb devices</span><br></pre></td></tr></table></figure>
此时设备已经可以识别了</li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/20/KotlinStudy5-For-Collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/06/20/KotlinStudy5-For-Collection/" class="post-title-link" itemprop="url">kotlin学习日志5 - 集合</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-06-20 10:30:43" itemprop="dateCreated datePublished" datetime="2018-06-20T10:30:43+08:00">2018-06-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-07-08 13:54:00" itemprop="dateModified" datetime="2018-07-08T13:54:00+08:00">2018-07-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kotlin集合操作"><a href="#kotlin集合操作" class="headerlink" title="kotlin集合操作"></a>kotlin集合操作</h1><h2 id="kotlin集合的不同"><a href="#kotlin集合的不同" class="headerlink" title="kotlin集合的不同"></a>kotlin集合的不同</h2><p>kotlin在集合这方面与大多数语言不同,分只读集合和读写集合,这种良好的设计有利于在使用的过程中避免bug的出现</p>
<h2 id="集合的创建"><a href="#集合的创建" class="headerlink" title="集合的创建"></a>集合的创建</h2><p>读写集合是只读集合的子类,可以将一个读写集合赋值给只读集合引用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// list</span></span><br><span class="line"><span class="keyword">val</span> list1 = listOf&lt;<span class="built_in">Int</span>&gt;() <span class="comment">// 创建kotlin只读集合</span></span><br><span class="line"><span class="keyword">val</span> list2 = mutableListOf&lt;<span class="built_in">Int</span>&gt;() <span class="comment">// 创建kotlin读写集合</span></span><br><span class="line"><span class="keyword">val</span> list3 = arrayListOf&lt;<span class="built_in">Int</span>&gt;() <span class="comment">// 创建java arraylist集合,这是读写集合</span></span><br><span class="line"><span class="keyword">val</span> list4 = ArrayList&lt;<span class="built_in">Int</span>&gt;() <span class="comment">// 通过构造函数创建也可以</span></span><br><span class="line"><span class="comment">// 下面同理</span></span><br><span class="line"><span class="comment">// set</span></span><br><span class="line"><span class="keyword">val</span> set1 = setOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> set2 = mutableSetOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> set3 = hashSetOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="comment">// map</span></span><br><span class="line"><span class="keyword">val</span> map1 = mapOf&lt;String,<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> map2 = mutableMapOf&lt;String,<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> map3 = hashMapOf&lt;String,<span class="built_in">Int</span>&gt;()</span><br></pre></td></tr></table></figure>
<h2 id="集合的操作符"><a href="#集合的操作符" class="headerlink" title="集合的操作符"></a>集合的操作符</h2><h3 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="comment">// 任何一个满足,返回true</span></span><br><span class="line">list.any &#123;</span><br><span class="line">    it &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 全部满足,返回true</span></span><br><span class="line">list.all &#123;</span><br><span class="line">    it &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没有一个满足,返回true</span></span><br><span class="line">list.none&#123;</span><br><span class="line">    it &lt; <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 满足条件的个数</span></span><br><span class="line">list.count&#123;</span><br><span class="line">    it &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h3><h4 id="求和"><a href="#求和" class="headerlink" title="求和"></a>求和</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有元素求和</span></span><br><span class="line">list.sum()</span><br><span class="line"><span class="comment">// 对每个元素的lambda表达式求和</span></span><br><span class="line">list.sumBy &#123;</span><br><span class="line">    it % <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="遍历每个元素-求经过lambda表达式运算后的值"><a href="#遍历每个元素-求经过lambda表达式运算后的值" class="headerlink" title="遍历每个元素,求经过lambda表达式运算后的值"></a>遍历每个元素,求经过lambda表达式运算后的值</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数initValue是初始值</span></span><br><span class="line"><span class="comment">// element当前遍历的元素,从第一个开始</span></span><br><span class="line"><span class="comment">// currentValue当前计算后的值</span></span><br><span class="line">list.fold(initValue) &#123;currentValue,element -&gt; </span><br><span class="line">    currentValue + element / <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">// 反方向遍历</span></span><br><span class="line">list.foldRight(initValue) &#123;currentValue,element -&gt;</span><br><span class="line">    currentValue + element / <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">// 不带初始值,currentValue是第一个元素,element从第二个开始</span></span><br><span class="line">list.reduce&#123;currentValue,element -&gt;</span><br><span class="line">    currentValue + element / <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">// 反方向遍历,currentValue是最后一个元素,element从倒数第二个开始</span></span><br><span class="line">list.reduceRight&#123;currentValue,element -&gt;</span><br><span class="line">    currentValue + element / <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无索引强循环</span></span><br><span class="line">list.forEach&#123;</span><br><span class="line">    print(it)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 带索引循环</span></span><br><span class="line">list.forEachIndexed&#123;index, value -&gt; </span><br><span class="line">    print(<span class="string">"position <span class="variable">$index</span> is <span class="variable">$value</span>"</span>)&#125;</span><br><span class="line"><span class="comment">// 包括11，但不包括66</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">11</span> until <span class="number">66</span>) &#123; ... &#125;</span><br><span class="line"><span class="comment">// 每次递增4</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">23</span>..<span class="number">89</span> step <span class="number">4</span>) &#123; ... &#125;</span><br><span class="line"><span class="comment">// downTo递减</span></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">50</span> downTo <span class="number">7</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<h4 id="最大最小值"><a href="#最大最小值" class="headerlink" title="最大最小值"></a>最大最小值</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回最大值</span></span><br><span class="line">list.max()</span><br><span class="line"><span class="comment">// 返回lambda运算后的最大值</span></span><br><span class="line">list.maxBy&#123;it&#125;</span><br><span class="line"><span class="comment">// 返回最小值</span></span><br><span class="line">list.min()</span><br><span class="line"><span class="comment">// 返回lambda运算后的最小值</span></span><br><span class="line">list.minBy&#123;it&#125;</span><br></pre></td></tr></table></figure>
<h4 id="过滤操作"><a href="#过滤操作" class="headerlink" title="过滤操作"></a>过滤操作</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除前n个元素返回</span></span><br><span class="line">list.drop(n)</span><br><span class="line"><span class="comment">// 删除后n个元素返回</span></span><br><span class="line">list.dropLast(n)</span><br><span class="line"><span class="comment">// 删除满足条件的第一个元素返回</span></span><br><span class="line">list.dropWhile &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 删除满足条件的最后一个元素返回</span></span><br><span class="line">list.dropLastWhile &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤所有满足条件的元素返回</span></span><br><span class="line">list.filter &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 过滤所有不满足条件的元素返回</span></span><br><span class="line">list.filterNot &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 过滤所有非空元素返回</span></span><br><span class="line">list.filterNotNull()</span><br><span class="line"><span class="comment">// 过滤指定索引集合对应的元素</span></span><br><span class="line">list.slice(listof(<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历每个元素,依次经过lambda运算,最终返回新的list</span></span><br><span class="line">list.map&#123;</span><br><span class="line">    it * <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 同上,带下标的遍历</span></span><br><span class="line">list.mapIndexed &#123;index, it -&gt; index * it&#125;</span><br><span class="line"><span class="comment">// 同上,过滤非空值</span></span><br><span class="line">list.mapNotNull &#123; it * <span class="number">2</span> &#125;</span><br><span class="line"><span class="comment">// 遍历每个元素,将返回的每个list合并,最终返回合并后的list</span></span><br><span class="line">list.flatMap &#123;</span><br><span class="line">    listOf(it, it + <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据key分组,返回一个map</span></span><br><span class="line">list.groupBy &#123;</span><br><span class="line">    <span class="keyword">if</span> (it % <span class="number">2</span> == <span class="number">0</span>) <span class="string">"even"</span> <span class="keyword">else</span> <span class="string">"odd"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将返回的结果list放入一个指定的list</span></span><br><span class="line"><span class="keyword">val</span> resultList = mutableListOf&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">list.mapTo (resultList) &#123;</span><br><span class="line">    it * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="集合取值"><a href="#集合取值" class="headerlink" title="集合取值"></a>集合取值</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取前面的n个元素返回</span></span><br><span class="line">list.take(n)</span><br><span class="line"><span class="comment">// 取后面的n个元素返回</span></span><br><span class="line">list.takeLast(n)</span><br><span class="line"><span class="comment">// 取满足条件的第一个元素返回</span></span><br><span class="line">list.takeWhile &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 取满足条件的最后一个元素返回</span></span><br><span class="line">list.takeLastWhile &#123;</span><br><span class="line">    it &gt; <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回下标为n的元素</span></span><br><span class="line">list.elementAt(n)</span><br><span class="line"><span class="comment">// 返回下标为n的元素,越界返回null</span></span><br><span class="line">list.elementAtOrNull(n)</span><br><span class="line"><span class="comment">// 返回下标为n的元素,越界返回经过lambda运算后的值</span></span><br><span class="line">list.elementAtOrElse(n) &#123; index -&gt; index * <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">// 返回第一个元素</span></span><br><span class="line">list.first()</span><br><span class="line"><span class="comment">// 返回满足条件的第一个元素</span></span><br><span class="line">list.first &#123; it &gt; <span class="number">1</span>&#125;</span><br><span class="line"><span class="comment">// 返回第一个元素,如果集合为空返回null</span></span><br><span class="line">list.firstOrNull()</span><br><span class="line"><span class="comment">// 返回满足条件的第一个元素,没有满足的返回null</span></span><br><span class="line">list.firstOrNull &#123; it &gt; <span class="number">1</span> &#125;</span><br><span class="line"><span class="comment">// 返回最后一个元素</span></span><br><span class="line">list.last()</span><br><span class="line"><span class="comment">// 返回满足条件的最后一个元素</span></span><br><span class="line">list.last &#123; it &gt; <span class="number">1</span>&#125;</span><br><span class="line"><span class="comment">// 返回最后一个元素,如果集合为空返回null</span></span><br><span class="line">list.lastOrNull()</span><br><span class="line"><span class="comment">// 返回最后一个元素,没有满足的返回null</span></span><br><span class="line">list.lastOrNull &#123; it &gt; <span class="number">1</span> &#125;</span><br><span class="line"><span class="comment">// 返回第一个出现的元素2的索引</span></span><br><span class="line">list.indexOf(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 返回最后一个出现的元素2的索引</span></span><br><span class="line">list.lastIndexOf(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 返回满足条件的第一个元素索引</span></span><br><span class="line">list.indexOfFirst &#123;</span><br><span class="line">    it &gt; <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回满足条件的最后一个元素索引</span></span><br><span class="line">list.indexOfLast &#123;</span><br><span class="line">    it &gt; <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回满足条件的唯一元素,如果有多个,或不存在满足条件的则抛异常</span></span><br><span class="line">list.single &#123;</span><br><span class="line">    it == <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回满足条件的唯一元素,如果有多个,或不存在满足条件的则返回null</span></span><br><span class="line">list.singleOrNull &#123;</span><br><span class="line">    it == <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拼接和切割"><a href="#拼接和切割" class="headerlink" title="拼接和切割"></a>拼接和切割</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list1 = listOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="keyword">val</span> list2 = listOf(<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>)</span><br><span class="line"><span class="comment">//拼接</span></span><br><span class="line">list1 + list2 = list1.plus(list2)</span><br><span class="line"><span class="comment">//按条件切割成两个list</span></span><br><span class="line"><span class="keyword">val</span>(list3, list4) = list1.partition &#123;</span><br><span class="line">    it % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 合并,返回一个由pair组成的list,每一个pair是取两个list下标相同的两个元素</span></span><br><span class="line"><span class="keyword">val</span> pairList: List&lt;Pair&lt;<span class="built_in">Int</span>,<span class="built_in">Int</span>&gt;&gt; = list1.zip(list2)</span><br><span class="line"><span class="comment">// 将一个由pair组成的list切割成两个list,再返回</span></span><br><span class="line"><span class="keyword">val</span> (list5, list6) = pairList.unzip()</span><br></pre></td></tr></table></figure>
<h4 id="排序和逆序"><a href="#排序和逆序" class="headerlink" title="排序和逆序"></a>排序和逆序</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = listOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="comment">// 逆序</span></span><br><span class="line">list.reversed()</span><br><span class="line"><span class="comment">// 升序</span></span><br><span class="line">list.sorted()</span><br><span class="line"><span class="comment">// 根据lambda表达式返回值来升序排序</span></span><br><span class="line">list.sortedBy &#123;</span><br><span class="line">    it * <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 降序</span></span><br><span class="line">list.sortedDescending()</span><br><span class="line"><span class="comment">// 根据lambda表达式返回值来降序排序</span></span><br><span class="line">list.sortedByDescending &#123;</span><br><span class="line">    it * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/02/RN-Mobx-HighOrderComponent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/05/02/RN-Mobx-HighOrderComponent/" class="post-title-link" itemprop="url">react-native-mobx和高阶组件</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-05-02 11:46:37" itemprop="dateCreated datePublished" datetime="2018-05-02T11:46:37+08:00">2018-05-02</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-07-08 13:54:00" itemprop="dateModified" datetime="2018-07-08T13:54:00+08:00">2018-07-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>由于我是android开发过渡到学习react-native的，所以对于一些web的状态管理方案不是很了解，比如说遇到多界面的异步刷新，直接使用回调的方式显得相当麻烦，到处留下接口，导致项目结构混乱，但在android中只需要使用广播，eventbus或者rxbus就可以解决的问题。我了解到react-redux这个东西，就是一个状态管理的解决方案，后来我发现，更多人推荐使用mobx去替换react-redux因为这个东西使用更简洁，更易于上手。当一个项目越来越庞大的时候，我们发现界面存在很多公共的逻辑，是不需要重复去写的，封装避免冗余代码这个工作是必不可少的，对比android，我们可以使用BaseActivity来封装公共逻辑，在react中最初我了解到mixin这个东西可以实现公共逻辑的封装，但是mixin不支持es6，所以最后采用了高阶组件的方式封装组件的base层，执行组件的公共逻辑。接下来详细介绍实现过程。</p>
<hr>
<h1 id="mobx基础"><a href="#mobx基础" class="headerlink" title="mobx基础"></a>mobx基础</h1><p>当我第一次看到mobx的时候我觉得它就是观察者模式，和android中的mvvm架构实现是差不多的。</p>
<h2 id="mobx术语"><a href="#mobx术语" class="headerlink" title="mobx术语"></a>mobx术语</h2><p>主要是4个，可观察的状态，计算值，状态反应，触发动作</p>
<h3 id="定义数据类"><a href="#定义数据类" class="headerlink" title="定义数据类"></a>定义数据类</h3><h3 id="可观察的状态"><a href="#可观察的状态" class="headerlink" title="可观察的状态"></a>可观察的状态</h3><p>通过@observable去标记变量，如对象，数组等，添加了可观察的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@observable count;</span><br><span class="line">@observable name;</span><br></pre></td></tr></table></figure>
<h3 id="根据状态得到计算值"><a href="#根据状态得到计算值" class="headerlink" title="根据状态得到计算值"></a>根据状态得到计算值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@computed <span class="keyword">get</span> msg() &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> say count is <span class="subst">$&#123;<span class="keyword">this</span>.count&#125;</span>`</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="状态变化时的反应"><a href="#状态变化时的反应" class="headerlink" title="状态变化时的反应"></a>状态变化时的反应</h3><p>autorun 方法需要传入数据类的实例，在可观察的变量被修改时调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">autorun(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(appState.msg);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="触发修改状态的动作"><a href="#触发修改状态的动作" class="headerlink" title="触发修改状态的动作"></a>触发修改状态的动作</h3><p>通过定义的动作方法修改状态的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@action add() &#123;</span><br><span class="line">   this.count += 1;</span><br><span class="line"> &#125;</span><br><span class="line">@action changeName(name) &#123;</span><br><span class="line">   this.name = name;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>整个数据类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">AppState</span> </span>&#123;</span><br><span class="line">  @observable count;</span><br><span class="line">  @observable name;</span><br><span class="line">  @computed <span class="keyword">get</span> msg() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> say count is <span class="subst">$&#123;<span class="keyword">this</span>.count&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @action add() &#123;</span><br><span class="line">    <span class="keyword">this</span>.count += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  @action changeName(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回json格式化数据</span></span><br><span class="line">  toJson() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count: <span class="keyword">this</span>.count,</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在组件中使用"><a href="#在组件中使用" class="headerlink" title="在组件中使用"></a>在组件中使用</h2><p>在index中注入数据类的实例对象，通过props传入到内部组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> AppState <span class="keyword">from</span> <span class="string">'./store/app-state'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Root</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;Provider appState=&#123;<span class="keyword">new</span> AppState()&#125;&gt;</span><br><span class="line">          &lt;App /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">      );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br></pre></td></tr></table></figure>

<p>在组件内监听，用@observer标记组件，@inject(‘appState’)注入数据类，通过props获取到数据类实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  observer,</span><br><span class="line">  inject,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'mobx-react'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppState &#125; <span class="keyword">from</span> <span class="string">'../../store/app-state'</span>;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'appState'</span>) @observer</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.changeName = <span class="keyword">this</span>.changeName.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="comment">// do something here</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  changeName(event) &#123;</span><br><span class="line">    <span class="keyword">this</span>.props.appState.changeName(event.target.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> onChange=&#123;<span class="keyword">this</span>.changeName&#125; /&gt;</span><br><span class="line">        &lt;span&gt;&#123;<span class="keyword">this</span>.props.appState.msg&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">TopicList.propTypes = &#123;</span><br><span class="line">  appState: PropTypes.instanceOf(AppState),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="利用高阶组件封装组件的base层"><a href="#利用高阶组件封装组件的base层" class="headerlink" title="利用高阶组件封装组件的base层"></a>利用高阶组件封装组件的base层</h1><p>高阶组件Higher Order Component简称HOC，是一个使用函数来实现的类工厂，接收一个React.Component的参数，这个参数必须传，我们可以定义为WrappedComponent，代表被包裹的组件，返回一个React.Component的对象，就是包裹后的新组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HighOrderComponent = <span class="function">(<span class="params">WrappedComponent, title</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="title">HOC</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 公共state初始化</span></span><br><span class="line">        <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">            <span class="keyword">super</span>(props);</span><br><span class="line">            <span class="keyword">this</span>.state = &#123;</span><br><span class="line">                username: <span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 公共逻辑处理</span></span><br><span class="line">        componentWillMount() &#123;</span><br><span class="line">            <span class="keyword">let</span> username = localStorage.getItem(<span class="string">'username'</span>);</span><br><span class="line">            <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                username: username</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 界面渲染的公共部分</span></span><br><span class="line">        render() &#123;</span><br><span class="line">            <span class="keyword">return</span>(</span><br><span class="line">                &lt;div&gt;</span><br><span class="line">                    &lt;View&gt;&#123;title&#125;&lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;WrappedComponent &#123;...this.props&#125; username=&#123;this.state.username&#125;&gt;&lt;/</span>WrappedComponent&gt;</span><br><span class="line">                &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">            )</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们可以在这个类中操作props，对props的增删改查，可以通过Refs访问到组件实例，对state做处理，也可以用其他的组件包裹WrappedComponent。作为组件的base层，在这里处理公共逻辑，使用的时候传入被包裹的组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span>(</span><br><span class="line">            &lt;View&gt;</span><br><span class="line">                &lt;Text&gt;Hi &#123;<span class="keyword">this</span>.props.username&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>View&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HighOrderIndex = HighOrderComponent(Index, <span class="string">'Index title'</span>);</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/20/RN-Refresh-Loadmore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/04/20/RN-Refresh-Loadmore/" class="post-title-link" itemprop="url">react-native-封装下拉刷新和加载更多</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-04-20 13:35:38" itemprop="dateCreated datePublished" datetime="2018-04-20T13:35:38+08:00">2018-04-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-27 21:55:30" itemprop="dateModified" datetime="2018-11-27T21:55:30+08:00">2018-11-27</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近又是很长一段时间没写文章了，忙着学习webpack，react，react-router，eslint，babel，mobx，一系列框架，开源的SimpleOne项目也在持续维护，把以前的ES5语法改为ES6，移除了react-timer-mixin这个模块，当然这个项目中的某些技术点需要总结，接下来的几篇会对这些技术点做一个记录。我们的app经常会用到长列表的展示方式，显示内容过多，大多数情况会用到分页加载，滑动到列表的底部，通过加载更多的方式，显示下一页的内容，看起来是一页，其实是多页拼接的长列表。一般我们的列表都有下拉刷新，但是这些react-native没有封装好的组件，我们需要自己实现，下面详细记录实现过程，如果你有更好的实现方式，希望一起学习讨论。</p>
<hr>
<p>当前的效果图gif：<br><img src="/images/rn-refresh.gif" alt="效果图1"><br><img src="/images/rn-loadmore.gif" alt="效果图2"></p>
<p>要实现下拉刷新和加载更多，需要对scrollview做一个扩展，对scrollview的滑动事件做监听和逻辑处理，利用官方的PanResponder 做手势识别，显示一个自定义的顶部下拉刷新视图，所以我们可以利用react-native现有的组件封装一个支持下拉刷新和加载更多的view来实现我们的需求。这里我们定义下拉刷新的动画是一个常见的图片旋转+文字提示。</p>
<h1 id="对ScrollView封装和使用"><a href="#对ScrollView封装和使用" class="headerlink" title="对ScrollView封装和使用"></a>对ScrollView封装和使用</h1><h2 id="封装ScrollView实现下拉刷新和加载更多"><a href="#封装ScrollView实现下拉刷新和加载更多" class="headerlink" title="封装ScrollView实现下拉刷新和加载更多"></a>封装ScrollView实现下拉刷新和加载更多</h2><p>首先，定义下拉到位时距离顶部的高度，默认下拉到位的时长，默认顶部刷新视图的高度，下拉刷新提示文字的显示状态，主要是4个状态，默认状态，正在下拉状态，下拉到位状态，和下拉释放状态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultDuration = <span class="number">300</span>; <span class="comment">//默认时长</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提示文字的显示状态</span></span><br><span class="line"><span class="comment"> * @type &#123;&#123;pulling: boolean, pullok: boolean, pullrelease: boolean&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> defaultState = &#123;<span class="attr">pulling</span>: <span class="literal">false</span>, <span class="attr">pullok</span>: <span class="literal">false</span>, <span class="attr">pullrelease</span>: <span class="literal">false</span>&#125;; <span class="comment">//默认状态</span></span><br><span class="line"><span class="keyword">const</span> statePulling = &#123;<span class="attr">pulling</span>: <span class="literal">true</span>, <span class="attr">pullok</span>: <span class="literal">false</span>, <span class="attr">pullrelease</span>: <span class="literal">false</span>&#125;; <span class="comment">//正在下拉状态</span></span><br><span class="line"><span class="keyword">const</span> statePullok = &#123;<span class="attr">pulling</span>: <span class="literal">false</span>, <span class="attr">pullok</span>: <span class="literal">true</span>, <span class="attr">pullrelease</span>: <span class="literal">false</span>&#125;; <span class="comment">//下拉到位状态</span></span><br><span class="line"><span class="keyword">const</span> statePullrelease = &#123;<span class="attr">pulling</span>: <span class="literal">false</span>, <span class="attr">pullok</span>: <span class="literal">false</span>, <span class="attr">pullrelease</span>: <span class="literal">true</span>&#125;; <span class="comment">//下拉释放状态</span></span><br></pre></td></tr></table></figure>

<p>接下来是定义手势判断</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向下手势</span></span><br><span class="line"><span class="keyword">const</span> isDownGesture = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> y &gt; <span class="number">0</span> &amp;&amp; (y &gt; <span class="built_in">Math</span>.abs(x));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//向上手势</span></span><br><span class="line"><span class="keyword">const</span> isUpGesture = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> y &lt; <span class="number">0</span> &amp;&amp; (<span class="built_in">Math</span>.abs(x) &lt; <span class="built_in">Math</span>.abs(y));</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//垂直方向手势</span></span><br><span class="line"><span class="keyword">const</span> isVerticalGesture = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">Math</span>.abs(x) &lt; <span class="built_in">Math</span>.abs(y));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>定义我们自定义的组件PullScollView继承自Component，定义默认值，传参类型，在构造函数中初始化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">       topRefreshHeight: <span class="number">50</span>, <span class="comment">//顶部刷新视图的高度</span></span><br><span class="line">       pullOkMargin:<span class="number">100</span> <span class="comment">//下拉到位状态时距离顶部的高度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">       topRefreshHeight: PropTypes.number,</span><br><span class="line">       pullOkMargin: PropTypes.number,</span><br><span class="line">       onPulling: PropTypes.func,</span><br><span class="line">       onPullOk: PropTypes.func,</span><br><span class="line">       onPullRelease: PropTypes.func,</span><br><span class="line">       onLoadMore: PropTypes.func,</span><br><span class="line">       onScroll: PropTypes.func,</span><br><span class="line">       children: PropTypes.array,</span><br><span class="line">       style: PropTypes.object,</span><br><span class="line">       loadMoreState: PropTypes.number,</span><br><span class="line">       onRetry: PropTypes.func,</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">       <span class="keyword">super</span>(props)</span><br><span class="line">       <span class="keyword">this</span>.defaultScrollEnabled = <span class="literal">false</span></span><br><span class="line">       <span class="keyword">this</span>.topRefreshHeight = <span class="keyword">this</span>.props.topRefreshHeight</span><br><span class="line">       <span class="keyword">this</span>.defaultXY = &#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="keyword">this</span>.topRefreshHeight * <span class="number">-1</span>&#125;</span><br><span class="line">       <span class="keyword">this</span>.pullOkMargin = <span class="keyword">this</span>.props.pullOkMargin</span><br><span class="line">       <span class="keyword">this</span>.state = <span class="built_in">Object</span>.assign(&#123;&#125;, props, &#123;</span><br><span class="line">           pullPan: <span class="keyword">new</span> Animated.ValueXY(<span class="keyword">this</span>.defaultXY), <span class="comment">//下拉区域</span></span><br><span class="line">           scrollEnabled: <span class="keyword">this</span>.defaultScrollEnabled, <span class="comment">//滚动启动</span></span><br><span class="line">           height: <span class="number">0</span>,</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="comment">// 滚动监听</span></span><br><span class="line">       <span class="keyword">this</span>.onScroll = <span class="keyword">this</span>.onScroll.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 布局监听</span></span><br><span class="line">       <span class="keyword">this</span>.onLayout = <span class="keyword">this</span>.onLayout.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 下拉状态监听</span></span><br><span class="line">       <span class="keyword">this</span>.isPullState = <span class="keyword">this</span>.isPullState.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 下拉未到位，重置回调</span></span><br><span class="line">       <span class="keyword">this</span>.resetDefaultXYHandler = <span class="keyword">this</span>.resetDefaultXYHandler.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 数据加载完，重置归位</span></span><br><span class="line">       <span class="keyword">this</span>.resolveHandler = <span class="keyword">this</span>.resolveHandler.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 顶部绘制</span></span><br><span class="line">       <span class="keyword">this</span>.renderTopRefresh = <span class="keyword">this</span>.renderTopRefresh.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 默认顶部绘制</span></span><br><span class="line">       <span class="keyword">this</span>.defaultTopRefreshRender = <span class="keyword">this</span>.defaultTopRefreshRender.bind(<span class="keyword">this</span>)</span><br><span class="line">       <span class="comment">// 多点触摸识别</span></span><br><span class="line">       <span class="keyword">this</span>.panResponder = PanResponder.create(&#123;</span><br><span class="line">           onMoveShouldSetPanResponder: <span class="keyword">this</span>.onShouldSetPanResponder.bind(<span class="keyword">this</span>),</span><br><span class="line">           onPanResponderMove: <span class="keyword">this</span>.onPanResponderMove.bind(<span class="keyword">this</span>),<span class="comment">// 最近一次的移动距离为gestureState.move&#123;X,Y&#125;</span></span><br><span class="line">           onPanResponderRelease: <span class="keyword">this</span>.onPanResponderRelease.bind(<span class="keyword">this</span>),<span class="comment">//放开了所有的触摸点，且此时视图已经成为了响应者。</span></span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">this</span>.setPullState(defaultState)<span class="comment">// 设置提示文字的默认状态</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>PanResponder手势响应回调中的处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手势响应回调，是否处理</span></span><br><span class="line">  onShouldSetPanResponder(e, gesture) &#123;</span><br><span class="line">      <span class="comment">//非垂直手势不处理</span></span><br><span class="line">      <span class="keyword">if</span> (!isVerticalGesture(gesture.dx, gesture.dy)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.state.scrollEnabled) &#123;</span><br><span class="line">          <span class="keyword">this</span>.lastY = <span class="keyword">this</span>.state.pullPan.y._value;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>PanResponder手势移动回调中的处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手势移动的处理</span></span><br><span class="line">    onPanResponderMove(e, gesture) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isUpGesture(gesture.dx, gesture.dy)) &#123; <span class="comment">//向上手势</span></span><br><span class="line">            <span class="comment">// 如果处于下拉状态，重置</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.isPullState()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.resetDefaultXYHandler();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 恢复到默认位置</span></span><br><span class="line">                <span class="keyword">this</span>.scroll.scrollTo(&#123;<span class="attr">x</span>:<span class="number">0</span>, <span class="attr">y</span>: gesture.dy * <span class="number">-1</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDownGesture(gesture.dx, gesture.dy)) &#123; <span class="comment">//向下手势</span></span><br><span class="line">            <span class="comment">// 设置下拉区域</span></span><br><span class="line">            <span class="keyword">this</span>.state.pullPan.setValue(&#123;<span class="attr">x</span>: <span class="keyword">this</span>.defaultXY.x, <span class="attr">y</span>: <span class="keyword">this</span>.lastY + gesture.dy / <span class="number">2</span>&#125;);</span><br><span class="line">            <span class="keyword">if</span> (gesture.dy &lt; <span class="keyword">this</span>.topRefreshHeight + <span class="keyword">this</span>.pullOkMargin) &#123; <span class="comment">//正在下拉</span></span><br><span class="line">                <span class="comment">// 之前状态不是正在下拉状态，调用正在下拉回调</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.curState.pulling) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.props.onPulling &amp;&amp; <span class="keyword">this</span>.props.onPulling();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录当前为下拉状态</span></span><br><span class="line">                <span class="keyword">this</span>.setPullState(statePulling);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">//下拉到位</span></span><br><span class="line">                <span class="comment">// 之前状态不是下拉到位状态，调用下拉到位回调</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.state.pullok) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.props.onPullOk &amp;&amp; <span class="keyword">this</span>.props.onPullOk();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 记录当前为下拉到位状态</span></span><br><span class="line">                <span class="keyword">this</span>.setPullState(statePullok);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>PanResponder手势释放回调中的处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手势释放</span></span><br><span class="line">    onPanResponderRelease() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.curState.pulling) &#123; <span class="comment">// 之前是下拉状态</span></span><br><span class="line">            <span class="keyword">this</span>.resetDefaultXYHandler(); <span class="comment">//重置状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.curState.pullok) &#123; <span class="comment">// 之前是下拉到位状态</span></span><br><span class="line">            <span class="comment">// 之前没有松开</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.curState.pullrelease) &#123;</span><br><span class="line">                <span class="comment">// 之前是刷新中，调用数据处理回调</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.props.onPullRelease) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.props.onPullRelease(<span class="keyword">this</span>.resolveHandler);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// 重置</span></span><br><span class="line">                    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="keyword">this</span>.resetDefaultXYHandler()&#125;, <span class="number">3000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.setPullState(statePullrelease); <span class="comment">//记录当前状态为完成下拉，已松开</span></span><br><span class="line">            <span class="comment">// 刷新view 的下拉动画开启</span></span><br><span class="line">            Animated.timing(<span class="keyword">this</span>.state.pullPan, &#123;</span><br><span class="line">                toValue: &#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;,</span><br><span class="line">                easing: Easing.linear,</span><br><span class="line">                duration: defaultDuration</span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 刷新视图中的转圈动画开启</span></span><br><span class="line">            <span class="keyword">this</span>.spin();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下拉重置，注意这里需要停止转圈的动画，根据当前剩余的变化值去初始化动画，如果没有这个操作，可能导致后面几次下拉刷新显示的刷新视图动画异常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 数据加载完成后调用此方法进行重置归位*/</span></span><br><span class="line">   resolveHandler() &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.curState.pullrelease) &#123; <span class="comment">//仅触摸松开时才触发</span></span><br><span class="line">           <span class="keyword">this</span>.resetDefaultXYHandler();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 重置下拉</span></span><br><span class="line">   resetDefaultXYHandler() &#123;</span><br><span class="line">       <span class="keyword">this</span>.curState = defaultState;</span><br><span class="line">       <span class="keyword">this</span>.state.pullPan.setValue(<span class="keyword">this</span>.defaultXY);</span><br><span class="line">       <span class="keyword">this</span>.state.spinValue.stopAnimation(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'剩余时间'</span> + (<span class="number">1</span> - value) * <span class="number">3000</span>);</span><br><span class="line">           <span class="comment">//计算角度比例</span></span><br><span class="line">           <span class="keyword">this</span>.animation = Animated.timing(<span class="keyword">this</span>.state.spinValue, &#123;</span><br><span class="line">               toValue: <span class="number">1</span>,</span><br><span class="line">               duration: (<span class="number">1</span> - value) * <span class="number">3000</span>,</span><br><span class="line">               easing: Easing.linear,</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>实现刷新视图中的循环转圈动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转圈动画</span></span><br><span class="line"> spin () &#123;</span><br><span class="line">   <span class="keyword">this</span>.animation.start(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">//正常转完1周,继续转</span></span><br><span class="line">         <span class="keyword">if</span> (<span class="built_in">Boolean</span>(result.finished)) &#123;</span><br><span class="line">             <span class="keyword">this</span>.animation = Animated.timing(</span><br><span class="line">                 <span class="keyword">this</span>.state.spinValue,</span><br><span class="line">                 &#123;</span><br><span class="line">                     toValue: <span class="number">1</span>,</span><br><span class="line">                     duration: <span class="number">3000</span>,</span><br><span class="line">                     easing: Easing.linear</span><br><span class="line">                 &#125;</span><br><span class="line">             );</span><br><span class="line">             <span class="keyword">this</span>.state.spinValue.setValue(<span class="number">0</span>);<span class="comment">// 每次转完都要重置</span></span><br><span class="line">             <span class="keyword">this</span>.spin();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们仍然需要对scrollview的滑动事件做一个监听，这里我们需要过滤一个临界状态，当列表已经滑动到顶部，但还没有触发下拉刷新的状态，不允许继续滚动。滑动监听实现加载更多，先获取到垂直方向的滑动距离，列表的高度，内容的高度，当滑出去的距离加上列表的高度大于等于内容高度时触发加载更多，这里给个20的偏移量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scrollview 的滚动回调</span></span><br><span class="line">  onScroll(e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.nativeEvent.contentOffset.y &lt;= <span class="number">0</span>) &#123; <span class="comment">//临界状态，此时已经到列表顶部，但是还没触发下拉刷新状态</span></span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">scrollEnabled</span>: <span class="keyword">this</span>.defaultScrollEnabled&#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.isPullState()) &#123;  <span class="comment">//当前不是下拉状态允许滚动</span></span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">scrollEnabled</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> y = e.nativeEvent.contentOffset.y;</span><br><span class="line">      <span class="comment">// console.log('滑动距离' + y);</span></span><br><span class="line">      <span class="keyword">let</span> height = e.nativeEvent.layoutMeasurement.height;</span><br><span class="line">      <span class="comment">// console.log('列表高度' + height);</span></span><br><span class="line">      <span class="keyword">let</span> contentHeight = e.nativeEvent.contentSize.height;</span><br><span class="line">      <span class="comment">// console.log('内容高度' + contentHeight);</span></span><br><span class="line">      <span class="comment">// console.log('判断条件' + (y + height));</span></span><br><span class="line">      <span class="keyword">if</span> (y + height &gt;= contentHeight - <span class="number">20</span>) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'触发加载更多'</span>);</span><br><span class="line">          <span class="keyword">this</span>.props.onLoadMore &amp;&amp; <span class="keyword">this</span>.props.onLoadMore()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 调用外部的滑动回调</span></span><br><span class="line">      <span class="keyword">this</span>.props.onScroll &amp;&amp; <span class="keyword">this</span>.props.onScroll(e)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>处于下拉过程判断</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处于下拉过程判断</span></span><br><span class="line">isPullState() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.curState.pulling || <span class="keyword">this</span>.curState.pullok || <span class="keyword">this</span>.curState.pullrelease;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置当前处于的下拉状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置当前的下拉状态</span></span><br><span class="line"> setPullState(pullState) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.curState !== pullState) &#123;</span><br><span class="line">         <span class="keyword">this</span>.curState = pullState;</span><br><span class="line">         <span class="keyword">this</span>.renderTopRefresh();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>根据当前的下拉状态，完成下拉刷新部分的重绘：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绘制下拉刷新</span></span><br><span class="line">   renderTopRefresh() &#123;</span><br><span class="line">       <span class="keyword">let</span> &#123; pulling, pullok, pullrelease &#125; = <span class="keyword">this</span>.curState;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.defaultTopRefreshRender(pulling, pullok, pullrelease);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    使用setNativeProps解决卡顿问题</span></span><br><span class="line"><span class="comment">    绘制默认的下拉刷新</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   defaultTopRefreshRender(pulling, pullok, pullrelease) &#123;</span><br><span class="line">       <span class="comment">//控制下拉刷新提示文字显示状态</span></span><br><span class="line">       setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (pulling) &#123;</span><br><span class="line">               <span class="keyword">this</span>.txtPulling &amp;&amp; <span class="keyword">this</span>.txtPulling.setNativeProps(&#123;<span class="attr">style</span>: styles.show&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullok &amp;&amp; <span class="keyword">this</span>.txtPullok.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullrelease &amp;&amp; <span class="keyword">this</span>.txtPullrelease.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pullok) &#123;</span><br><span class="line">               <span class="keyword">this</span>.txtPulling &amp;&amp; <span class="keyword">this</span>.txtPulling.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullok &amp;&amp; <span class="keyword">this</span>.txtPullok.setNativeProps(&#123;<span class="attr">style</span>: styles.show&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullrelease &amp;&amp; <span class="keyword">this</span>.txtPullrelease.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pullrelease) &#123;</span><br><span class="line">               <span class="keyword">this</span>.txtPulling &amp;&amp; <span class="keyword">this</span>.txtPulling.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullok &amp;&amp; <span class="keyword">this</span>.txtPullok.setNativeProps(&#123;<span class="attr">style</span>: styles.hide&#125;);</span><br><span class="line">               <span class="keyword">this</span>.txtPullrelease &amp;&amp; <span class="keyword">this</span>.txtPullrelease.setNativeProps(&#123;<span class="attr">style</span>: styles.show&#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;, <span class="number">1</span>);</span><br><span class="line">       <span class="comment">// 初始化旋转角度</span></span><br><span class="line">       <span class="keyword">const</span> spin = <span class="keyword">this</span>.state.spinValue.interpolate(&#123;</span><br><span class="line">           inputRange: [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">           outputRange: [<span class="string">'0deg'</span>, <span class="string">'1080deg'</span>]</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="comment">// 绘制下拉刷新view</span></span><br><span class="line">       <span class="keyword">return</span> (</span><br><span class="line">           &lt;View style=&#123;&#123;<span class="attr">flexDirection</span>: <span class="string">'row'</span>, <span class="attr">justifyContent</span>: <span class="string">'center'</span>, <span class="attr">alignItems</span>: <span class="string">'center'</span>, <span class="attr">height</span>: defaultTopRefreshHeight&#125;&#125;&gt;</span><br><span class="line">               &lt;Animated.Image</span><br><span class="line">                   style=&#123;&#123;</span><br><span class="line">                       width: <span class="number">23</span>,</span><br><span class="line">                       height: <span class="number">23</span>,</span><br><span class="line">                       transform: [&#123;<span class="attr">rotate</span>: spin&#125;] ,</span><br><span class="line">                       position:<span class="string">'absolute'</span>,</span><br><span class="line">                       left:<span class="number">24</span></span><br><span class="line">                   &#125;&#125;</span><br><span class="line">                   source=&#123;&#123;<span class="attr">uri</span>: <span class="string">'default_ptr_rotate'</span>&#125;&#125;</span><br><span class="line">               /&gt;</span><br><span class="line"></span><br><span class="line">               &lt;Text ref=&#123;(c) =&gt; &#123;<span class="keyword">this</span>.txtPulling = c;&#125;&#125; style=&#123;styles.hide&#125;&gt;&#123;tipText.pulling&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">               &lt;Text ref=&#123;(c) =&gt; &#123;this.txtPullok = c;&#125;&#125; style=&#123;styles.hide&#125;&gt;&#123;tipText.pullok&#125;&lt;/</span>Text&gt;</span><br><span class="line">               &lt;Text ref=&#123;(c) =&gt; &#123;<span class="keyword">this</span>.txtPullrelease = c;&#125;&#125; style=&#123;styles.hide&#125;&gt;&#123;tipText.pullrelease&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">           &lt;/</span>View&gt;</span><br><span class="line">       );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>测量宽高，动态设置自定义view的宽高，绘制整个自定义view以及该组件内部包含的子view</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得测量的宽高，动态设置</span></span><br><span class="line">    onLayout(e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state.width !== e.nativeEvent.layout.width || <span class="keyword">this</span>.state.height !== e.nativeEvent.layout.height) &#123;</span><br><span class="line">            <span class="keyword">this</span>.scrollContainer.setNativeProps(&#123;<span class="attr">style</span>: &#123;<span class="attr">width</span>: e.nativeEvent.layout.width, <span class="attr">height</span>: e.nativeEvent.layout.height&#125;&#125;);</span><br><span class="line">            <span class="keyword">this</span>.width = e.nativeEvent.layout.width;</span><br><span class="line">            <span class="keyword">this</span>.height = e.nativeEvent.layout.height;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;[Refresh.styles.wrap, <span class="keyword">this</span>.props.style]&#125; onLayout=&#123;<span class="keyword">this</span>.onLayout&#125;&gt;</span><br><span class="line">                &lt;Animated.View style=&#123;[<span class="keyword">this</span>.state.pullPan.getLayout()]&#125;&gt;</span><br><span class="line">                    &#123;<span class="comment">/*绘制下拉刷新view*/</span>&#125;</span><br><span class="line">                    &#123;<span class="keyword">this</span>.renderTopRefresh()&#125;</span><br><span class="line">                    &#123;<span class="comment">/*绘制里面的子view*/</span>&#125;</span><br><span class="line">                    &lt;View ref=&#123;(c) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">this</span>.scrollContainer = c</span><br><span class="line">                    &#125;&#125; &#123;...this.panResponder.panHandlers&#125; style=&#123;&#123;<span class="attr">width</span>: <span class="keyword">this</span>.state.width, <span class="attr">height</span>: <span class="keyword">this</span>.state.height&#125;&#125;&gt;</span><br><span class="line">                        &lt;ScrollView &#123;...this.props&#125; ref=&#123;(c) =&gt; &#123;</span><br><span class="line">                            <span class="keyword">this</span>.scroll = c</span><br><span class="line">                        &#125;&#125; scrollEnabled=&#123;<span class="keyword">this</span>.state.scrollEnabled&#125; onScroll=&#123;<span class="keyword">this</span>.onScroll&#125;&gt;</span><br><span class="line">                            &#123;<span class="keyword">this</span>.props.children&#125;</span><br><span class="line">                             &#123;<span class="comment">/*绘制加载view*/</span>&#125;</span><br><span class="line">                            &lt;LoadMore state=&#123;<span class="keyword">this</span>.props.loadMoreState&#125; onRetry=&#123;() =&gt; <span class="keyword">this</span>.props.onRetry()&#125;/&gt;</span><br><span class="line">                        &lt;<span class="regexp">/ScrollView&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;/</span>View&gt;</span><br><span class="line">                &lt;<span class="regexp">/Animated.View&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>View&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>设置默认提示文本和自带样式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认提示文本</span></span><br><span class="line"><span class="keyword">const</span> tipText = &#123;</span><br><span class="line">    pulling: <span class="string">"下拉刷新..."</span>,</span><br><span class="line">    pullok: <span class="string">"松开刷新......"</span>,</span><br><span class="line">    pullrelease: <span class="string">"刷新中......"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自带样式</span></span><br><span class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</span><br><span class="line">    wrap: &#123;</span><br><span class="line">        flex: <span class="number">1</span>,</span><br><span class="line">        flexGrow: <span class="number">1</span>,</span><br><span class="line">        flexDirection: <span class="string">'column'</span>,</span><br><span class="line">        zIndex:<span class="number">-999</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    hide: &#123;</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">        left: <span class="number">10000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    show: &#123;</span><br><span class="line">        position: <span class="string">'relative'</span>,</span><br><span class="line">        left: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="在业务代码中使用"><a href="#在业务代码中使用" class="headerlink" title="在业务代码中使用"></a>在业务代码中使用</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;PullScrollView style=&#123;&#123;<span class="attr">flex</span>: <span class="number">1</span>, <span class="attr">backgroundColor</span>: <span class="string">'white'</span>&#125;&#125;</span><br><span class="line">                onPullRelease=&#123;<span class="keyword">this</span>.onPullRelease&#125;&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;<span class="regexp">/PullScollView&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里注意在onPullRelease中一定要调用<code>resolve()</code>让下拉刷新重置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">onPullRelease(resolve) &#123;</span><br><span class="line">    <span class="comment">//刷新完毕，重置下拉刷新，再次更新刷新和加载更多状态</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要在触发加载更多，发起网络请求时显示一个加载更多的loadingview，通过loading参数传值控制当前是否显示，同样简单封装一下，这里加了一个逐个展示小圆点的组合动画</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pointsNum = <span class="number">3</span>; <span class="comment">//点数量</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadMore</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props)</span><br><span class="line">        <span class="comment">// 初始化点的数量</span></span><br><span class="line">        <span class="keyword">this</span>.arr = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pointsNum; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.arr.push(i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化动画</span></span><br><span class="line">        <span class="keyword">this</span>.animatedValue = []</span><br><span class="line">        <span class="keyword">this</span>.arr.forEach(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.animatedValue[value] = <span class="keyword">new</span> Animated.Value(<span class="number">0</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            curState: <span class="keyword">this</span>.props.state</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidMount()&#123;</span><br><span class="line">        <span class="keyword">this</span>.isMount = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentWillUnmount()&#123;</span><br><span class="line">        <span class="keyword">this</span>.isMount = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动画执行，逐个显示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    animate() &#123;</span><br><span class="line">        <span class="keyword">this</span>.arr.forEach(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.animatedValue[value].setValue(<span class="number">0</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> animations = <span class="keyword">this</span>.arr.map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Animated.timing(</span><br><span class="line">                <span class="keyword">this</span>.animatedValue[item],</span><br><span class="line">                &#123;</span><br><span class="line">                    toValue: <span class="number">1</span>,</span><br><span class="line">                    duration: <span class="number">200</span>,</span><br><span class="line">                    easing: Easing.linear</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">this</span>.loadingAnim = Animated.sequence(animations)</span><br><span class="line">        <span class="keyword">this</span>.loadingAnim.start(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">Boolean</span>(result.finished)) <span class="keyword">this</span>.animate()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;[styles.container]&#125;&gt;</span><br><span class="line">                &#123;<span class="keyword">this</span>.state.curState !== LoadMoreState.state.hide ? <span class="keyword">this</span>.renderLoad() : <span class="literal">null</span>&#125;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    componentWillReceiveProps(nextProps) &#123;</span></span><br><span class="line"><span class="regexp">        this.setState(&#123;</span></span><br><span class="line"><span class="regexp">            curState: nextProps.state</span></span><br><span class="line"><span class="regexp">        &#125;)</span></span><br><span class="line"><span class="regexp">        switch (nextProps.state) &#123;</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.loading:</span></span><br><span class="line"><span class="regexp">                if (this.props.loadAnim)&#123;</span></span><br><span class="line"><span class="regexp">                    this.animate()</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">                break</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.hide:</span></span><br><span class="line"><span class="regexp">                this.arr.forEach((item) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                    this.animatedValue[item].stopAnimation(value =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                        /</span><span class="regexp">/ console.log('剩余时间' + (1 - value) * 200);</span></span><br><span class="line"><span class="regexp">                    &#125;);</span></span><br><span class="line"><span class="regexp">                &#125;)</span></span><br><span class="line"><span class="regexp">                break</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.noMore:</span></span><br><span class="line"><span class="regexp">                setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                    if(this.isMount)&#123;</span></span><br><span class="line"><span class="regexp">                        this.setState(&#123;</span></span><br><span class="line"><span class="regexp">                            curState: LoadMoreState.state.hide</span></span><br><span class="line"><span class="regexp">                        &#125;)</span></span><br><span class="line"><span class="regexp">                    &#125;</span></span><br><span class="line"><span class="regexp">                &#125;, 3000)</span></span><br><span class="line"><span class="regexp">                break</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span>**</span><br><span class="line">     * 根据状态返回绘制文字</span><br><span class="line">     * @returns &#123;string&#125;</span><br><span class="line">     *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">    renderLoadText() &#123;</span></span><br><span class="line"><span class="regexp">        switch (this.state.curState) &#123;</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.loading:</span></span><br><span class="line"><span class="regexp">                if (this.props.loadAnim)&#123;</span></span><br><span class="line"><span class="regexp">                    return LoadMoreState.stateText.loading</span></span><br><span class="line"><span class="regexp">                &#125;else&#123;</span></span><br><span class="line"><span class="regexp">                    return LoadMoreState.stateText.loading + '...'</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.noMore:</span></span><br><span class="line"><span class="regexp">                return LoadMoreState.stateText.noMore</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.tip:</span></span><br><span class="line"><span class="regexp">                return LoadMoreState.stateText.tip</span></span><br><span class="line"><span class="regexp">            case LoadMoreState.state.error:</span></span><br><span class="line"><span class="regexp">                return LoadMoreState.stateText.error</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 绘制文字</span></span><br><span class="line"><span class="regexp">    renderLoad() &#123;</span></span><br><span class="line"><span class="regexp">        const animations = this.arr.map((value, index) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            return (</span></span><br><span class="line"><span class="regexp">                &lt;Animated.Text key=&#123;index&#125; style=&#123;&#123;</span></span><br><span class="line"><span class="regexp">                    opacity: this.animatedValue[value], fontSize: Config.screenW * 0.06, color: Config.normalTextColor</span></span><br><span class="line"><span class="regexp">                &#125;&#125;&gt;.&lt;/</span>Animated.Text&gt;</span><br><span class="line">            )</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;TouchableOpacity</span><br><span class="line">                style=&#123;&#123;<span class="attr">flexDirection</span>: <span class="string">'row'</span>, <span class="attr">alignItems</span>: <span class="string">'center'</span>, <span class="attr">height</span>: Config.screenW * <span class="number">0.14</span>,&#125;&#125;</span><br><span class="line">                onPress=&#123;() =&gt; <span class="keyword">new</span> DoubleClick().filterDoubleClick(</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.state.curState === LoadMoreState.state.error)&#123;</span><br><span class="line">                            <span class="keyword">this</span>.props.onRetry &amp;&amp; <span class="keyword">this</span>.props.onRetry()</span><br><span class="line">                            <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">                                curState:LoadMoreState.state.loading</span><br><span class="line">                            &#125;)</span><br><span class="line">                            <span class="keyword">this</span>.animate()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;.bind(<span class="keyword">this</span>)</span><br><span class="line">                )&#125;&gt;</span><br><span class="line">                &lt;Text style=&#123;&#123;</span><br><span class="line">                    color: Config.normalTextColor,</span><br><span class="line">                    fontSize: Config.screenW * <span class="number">0.04</span>,</span><br><span class="line">                    marginRight: Config.screenW * <span class="number">0.02</span>,</span><br><span class="line">                &#125;&#125;&gt;</span><br><span class="line">                    &#123;<span class="keyword">this</span>.renderLoadText()&#125;</span><br><span class="line">                &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &#123;/</span>*是加载状态绘制。。。的动画*<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">                &#123;this.state.curState === LoadMoreState.state.loading ?</span></span><br><span class="line"><span class="regexp">                    &lt;View style=&#123;styles.pointsView&#125;&gt;</span></span><br><span class="line"><span class="regexp">                        &#123;animations&#125;</span></span><br><span class="line"><span class="regexp">                    &lt;/</span>View&gt; : <span class="literal">null</span>&#125;</span><br><span class="line"></span><br><span class="line">            &lt;<span class="regexp">/TouchableOpacity&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">LoadMore.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">    state: PropTypes.number, /</span><span class="regexp">/当前状态</span></span><br><span class="line"><span class="regexp">    onRetry: PropTypes.func ,/</span><span class="regexp">/重试回调</span></span><br><span class="line"><span class="regexp">    loadAnim: PropTypes.bool, /</span><span class="regexp">/是否显示加载动画，flatlist尾部组件不支持</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">LoadMore.defaultProps = &#123;</span></span><br><span class="line"><span class="regexp">    state: LoadMoreState.state.hide, /</span><span class="regexp">/默认不显示</span></span><br><span class="line"><span class="regexp">    loadAnim: false /</span><span class="regexp">/默认不用动画</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const styles = StyleSheet.create(&#123;</span></span><br><span class="line"><span class="regexp">    container: &#123;</span></span><br><span class="line"><span class="regexp">        flex: 1,</span></span><br><span class="line"><span class="regexp">        justifyContent: 'center',</span></span><br><span class="line"><span class="regexp">        alignItems: 'center',</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    pointsView: &#123;</span></span><br><span class="line"><span class="regexp">        height: Config.screenW * 0.14,</span></span><br><span class="line"><span class="regexp">        flexDirection: 'row',</span></span><br><span class="line"><span class="regexp">        alignItems: 'center',</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    instructions: &#123;</span></span><br><span class="line"><span class="regexp">        textAlign: 'center',</span></span><br><span class="line"><span class="regexp">        color: '#333333',</span></span><br><span class="line"><span class="regexp">        marginBottom: 5,</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">&#125;)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default LoadMore;</span></span><br></pre></td></tr></table></figure>
<h1 id="对flatlist封装"><a href="#对flatlist封装" class="headerlink" title="对flatlist封装"></a>对flatlist封装</h1><h2 id="封装flatlist实现下拉刷新和加载更多"><a href="#封装flatlist实现下拉刷新和加载更多" class="headerlink" title="封装flatlist实现下拉刷新和加载更多"></a>封装flatlist实现下拉刷新和加载更多</h2><p>与scrollview的封装方式大致相同，render方法需要稍做修改</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">     <span class="keyword">return</span> (</span><br><span class="line">         &lt;View style=&#123;[Refresh.styles.wrap, <span class="keyword">this</span>.props.style]&#125; onLayout=&#123;<span class="keyword">this</span>.onLayout&#125;&gt;</span><br><span class="line">             &lt;Animated.View style=&#123;[<span class="keyword">this</span>.state.pullPan.getLayout()]&#125;&gt;</span><br><span class="line">                 &#123;<span class="comment">/*绘制下拉刷新view*/</span>&#125;</span><br><span class="line">                 &#123;<span class="keyword">this</span>.renderTopRefresh()&#125;</span><br><span class="line">                 &#123;<span class="comment">/*绘制里面的子view*/</span>&#125;</span><br><span class="line">                 &lt;View ref=&#123;(c) =&gt; &#123;</span><br><span class="line">                     <span class="keyword">this</span>.scrollContainer = c</span><br><span class="line">                 &#125;&#125; &#123;...this.panResponder.panHandlers&#125; style=&#123;&#123;<span class="attr">width</span>: <span class="keyword">this</span>.state.width, <span class="attr">height</span>: <span class="keyword">this</span>.state.height&#125;&#125;&gt;</span><br><span class="line">                     &lt;FlatList</span><br><span class="line">                         ref=&#123;(c) =&gt; &#123;</span><br><span class="line">                             <span class="keyword">this</span>.list = c</span><br><span class="line">                         &#125;&#125;</span><br><span class="line">                         extraData=&#123;<span class="keyword">this</span>.state&#125;</span><br><span class="line">                         &#123;...this.props&#125;</span><br><span class="line">                         onScroll=&#123;<span class="keyword">this</span>.onScroll&#125;</span><br><span class="line">                         scrollEnabled=&#123;<span class="keyword">this</span>.state.scrollEnabled&#125;</span><br><span class="line">                         ListFooterComponent=&#123;() =&gt; &#123;</span><br><span class="line">                             <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">LoadMore</span> <span class="attr">state</span>=<span class="string">&#123;this.props.loadMoreState&#125;</span> <span class="attr">onRetry</span>=<span class="string">&#123;()</span> =&gt;</span> this.props.onRetry()&#125;/&gt;</span></span><br><span class="line"><span class="xml">                         &#125;&#125;</span></span><br><span class="line"><span class="xml">                     /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                 <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">             &lt;<span class="regexp">/Animated.View&gt;</span></span><br><span class="line"><span class="regexp">         &lt;/</span>View&gt;</span><br><span class="line">     )</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="在业务代码中使用-1"><a href="#在业务代码中使用-1" class="headerlink" title="在业务代码中使用"></a>在业务代码中使用</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;PullFlatList</span><br><span class="line">        data=&#123;<span class="keyword">this</span>.state.data.data&#125;</span><br><span class="line">        showsVerticalScrollIndicator=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">        ItemSeparatorComponent=&#123;<span class="keyword">this</span>.space&#125;</span><br><span class="line">        renderItem=&#123;(&#123;item, index&#125;) =&gt; (</span><br><span class="line">            &lt;ComicImg imgUrl=&#123;item&#125; index=&#123;index&#125;/&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">        keyExtractor=&#123;item =&gt; item&#125;</span><br><span class="line">        numColumns=&#123;<span class="number">1</span>&#125;</span><br><span class="line">        onPullRelease=&#123;<span class="keyword">this</span>.props.onRefresh&#125;</span><br><span class="line">        style=&#123;[CommonStyle.styles.listView,&#123;<span class="attr">width</span>: Config.screenW,<span class="attr">height</span>:Config.screenH&#125;]&#125;</span><br><span class="line">    /&gt;</span><br></pre></td></tr></table></figure>

<p>对应的源码地址:</p>
<p><a href="https://github.com/jessieeeee/SimpleOne/blob/master/js/view/PullScrollView.js" target="_blank" rel="noopener">组件封装</a><br><a href="https://github.com/jessieeeee/SimpleOne/blob/master/js/mainall/All.js" target="_blank" rel="noopener">组件使用</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/SimpleOne/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2018/01/03/SimpleOne/" class="post-title-link" itemprop="url">SimpleOne-one一个高仿开源项目</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2018-01-03 20:03:19" itemprop="dateCreated datePublished" datetime="2018-01-03T20:03:19+08:00">2018-01-03</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-02 23:36:56" itemprop="dateModified" datetime="2018-11-02T23:36:56+08:00">2018-11-02</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>随着混合开发越来越火，逐渐成为行业发展趋势，ReactNative也一直保持着快速更新的节奏，”learn once,write anywhere”这个宣传语一直吸引着我，公司最近也不忙了，一直想入坑的我终于找到了一个合适的时间点，很长一段时间没有更新博客了，因为在学习ReactNative这个框架，由于喜欢one一个的ui界面，做了这个开源项目，这是一个高仿韩寒one一个的开源项目，在此声明，本项目完全以学习为目的，不侵犯one一个的利益，遵守开源协议，所有接口全部来源于one一个android版4.3.4抓包获得，项目中使用的素材也是解压apk文件获得，不打算支持登录后的评论,  分享,  点赞操作,  原版是使用android原生实现的，本项目用ReactNative框架实现，还使用了ReactNative的第三方库，sdk接入是调用了原生android sdk模块，此项目目前只对android进行了适配，ios目前尚未适配，项目结构并非标准的ReactNative项目结构，而是android原生项目结构引入ReactNative框架的混合开发结构。我学习ReactNative不久，以前是做android原生开发的，如果有写的不好的地方，或者是你有更好的实现方式，希望一起学习讨论。</p>
<hr>
<p>先上目前的效果图：</p>
<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone1.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone2.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone3.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone4.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone5.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone6.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone7.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone8.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone9.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone10.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone12.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone13.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone14.jpg" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone15.png" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone16.png" width="120" height="180" ></div>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/simpleone17.png" width="120" height="180" ></div>
<div style="clear:both;"></div>

<h1 id="如何运行"><a href="#如何运行" class="headerlink" title="如何运行"></a>如何运行</h1><p>确保你的编译设备和运行设备在同一网络下,并且配置开发设置中的主机ip和端口号(Dev settings -&gt; Debug server host &amp; port for device)</p>
<ol>
<li>在命令行输入, react-native start</li>
<li>选择你的运行设备, run app</li>
</ol>
<h1 id="api接口清单"><a href="#api接口清单" class="headerlink" title="api接口清单"></a>api接口清单</h1><p>这里对提取出的api接口做个记录，本人以学习为目的，希望读者也不要用于任何商业项目中，目前列出的接口是基于4.3.4的android版：</p>
<ol>
<li><p>one首页（第一页，date=0，更多页date=yyyy-MM-dd）</p>
<p><code>http://v3.wufazhuce.com:8000/api/channel/one/{date}/0</code></p>
</li>
<li><p>专题列表（第一页，last_id=0，更多页last_id=上次请求结束的id）</p>
<p><code>http://v3.wufazhuce.com:8000/api/banner/list/4?last_id={last_id}</code></p>
</li>
<li><p>横着的列表（所有人问所有人）</p>
<p><code>http://v3.wufazhuce.com:8000/api/banner/list/5</code></p>
</li>
<li><p>近期热门作者</p>
<p><code>http://v3.wufazhuce.com:8000/api/author/hot</code></p>
</li>
<li><p>one首页菜单跳转</p>
<ul>
<li><p>问答<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/question/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/question/htmlcontent/{content_id}</code></p>
</li>
<li><p>连载<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/serial/{content_id}/0</code><br><code>http://v3.wufazhuce.com:8000/api/serialcontent/htmlcontent/{content_id}</code></p>
</li>
<li><p>音乐<br><code>http://v3.wufazhuce.com:8000/api/music/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/music/{content_id}/0</code></p>
</li>
<li><p>电影<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/movie/{content_id}/0</code><br><code>http://v3.wufazhuce.com:8000/api/movie/htmlcontent/{content_id}</code></p>
</li>
<li><p>文章内容和作者<br><code>http://v3.wufazhuce.com:8000/api/essay/htmlcontent/{content_id}</code><br>文章评论<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/essay/{content_id}/0</code></p>
</li>
</ul>
</li>
<li><p>搜索模块分类跳转（category_id，0图文 3问答 1阅读 2连载 5影视 4音乐 8电台）</p>
<p><code>http://v3.wufazhuce.com:8000/api/all/list/{category_id}</code></p>
</li>
<li><p>one首页和专题列表的item点击阅读跳转详情和获取评论</p>
<ul>
<li><p>问答<br><code>http://v3.wufazhuce.com:8000/api/question/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/question/{content_id}</code></p>
</li>
<li><p>连载<br><code>http://v3.wufazhuce.com:8000/api/serialcontent/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/serial/{content_id}/0</code></p>
</li>
<li><p>音乐<br><code>http://v3.wufazhuce.com:8000/api/music/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/music/{content_id}/0</code></p>
</li>
<li><p>电影<br><code>http://v3.wufazhuce.com:8000/api/movie/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/movie/{content_id}/0</code></p>
</li>
<li><p>文章内容和作者<br><code>http://v3.wufazhuce.com:8000/api/essay/htmlcontent/{content_id}</code></p>
</li>
<li><p>文章评论<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/essay/{content_id}/0</code></p>
</li>
<li><p>电台<br><code>http://v3.wufazhuce.com:8000/api/radio/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/radio/{content_id}/0</code></p>
</li>
<li><p>专题<br><code>http://v3.wufazhuce.com:8000/api/topic/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/topic/{content_id}/0</code></p>
</li>
</ul>
</li>
<li><p>作者页<br><code>http://v3.wufazhuce.com:8000/api/author/works?page_num={page_num}&amp;author_id={author_id}&amp;version=4.3.4</code></p>
</li>
</ol>
<h1 id="功能模块："><a href="#功能模块：" class="headerlink" title="功能模块："></a>功能模块：</h1><p>根据android 4.3.4整理：</p>
<p>一级界面：</p>
<p>欢迎界面，按星期几展示不同的欢迎界面</p>
<p>one分页，也是首页，展示今日列表（插图，one-story, 问答，文章，影视，音乐，电台），折叠菜单，可翻页查看以前的列表，每翻一页，查看前一天的内容，列表头部可以下拉刷新。</p>
<p>all分页，长列表展示，顶部banner，分类导航，专题列表（下拉到底部以后，可加载更多），列表头部可以下拉刷新。</p>
<p>me分页，个人资料页，未登录时，为登录界面入口和设置入口</p>
<p>二级界面：</p>
<p>设置界面</p>
<p>阅读界面</p>
<p>登录界面</p>
<p>分享界面</p>
<p>搜索界面</p>
<p>第三方平台分享，登录sdk对接</p>
<h2 id="当前未完成部分："><a href="#当前未完成部分：" class="headerlink" title="当前未完成部分："></a>当前未完成部分：</h2><p>阅读界面js回调（包含音乐播放）夜间模式</p>
<p>设置模块缓存</p>
<p>阅读界面交互动画</p>
<h1 id="目前用到的技术："><a href="#目前用到的技术：" class="headerlink" title="目前用到的技术："></a>目前用到的技术：</h1><p>由于我最初学习的时候资料是用ES5进行编写的，这是我自学ReactNative后的第一个项目，所以本项目ES5和ES6混用，我知道这样不是很好，有时间了会全部使用ES6</p>
<p>react-native对原生组件进行了封装。</p>
<ol>
<li>基本控件的使用 View，Text，Image，ScrollView，ListView，WebView，Clipboard，Platform，TouchableOpacity，ActivityIndicator，StatusBar，SliderBar。</li>
<li>动画的调用，Animated，Easing</li>
<li>计时器的使用，<del>react-timer-mixin</del> 改为ES6语法，该模块移除</li>
<li>react-native调用原生模块（原生toast，调android第三方分享sdk）</li>
<li>底部导航栏TabNavigator，页面导航Navigator</li>
<li>子组件的封装，调用以及回调</li>
<li>父组件和子组件之间的参数传递</li>
<li>页面导航跳转时的参数传递，以及回调</li>
<li>下拉刷新，第三方react-native控件的引入( react-native-pull )，并进行部分修改</li>
<li>自定义折叠控件（one分页中的菜单）实现折叠动画</li>
<li>自定义banner控件，实现all分页中的广告栏展示</li>
<li>自定义加载更多控件，监听ScrollView的滑动，实现加载更多</li>
<li>自定义阅读界面loading时的帧动画展示</li>
<li>半透明界面，悬浮窗实现，自定义单选对话框实现</li>
<li>相册，拍照实现，react-native第三方库接入</li>
<li>调用基于Android原生封装的ui控件</li>
<li>在Android原生项目的基础上引入react-native框架进行混合开发</li>
<li>音乐专辑封面旋转动画（解决动画循环播放中的暂停与播放事件），通过直接修改属性setNativeProps实现帧动画提高性能</li>
<li>加入mobx实现多界面同时刷新（2018.5.2更新）</li>
<li>利用高阶组件封装base组件，实现组件的公共逻辑（2018.5.2更新）</li>
<li>实现one分页标题(日期数字)切换动画 (2018.6.28更新)</li>
</ol>
<p>这个项目让初学者的我受益良多，现在的react-native第三方框架还不是很多，很多时候要自定义，而且在Android上的坑还是有很多，不过react-native的更新速度也是相当快的。后面有时间会陆续追加一些此项目中自定义部分的详细技术文章。<br>最近由于公司的项目需求，入坑了微信小程序，年前忙项目进度，估计短期内没有时间更新这个项目了，有时间会上传目前的动画效果图。</p>
<p>此项目的github地址<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="noopener">传送门</a>，欢迎一起交流和学习。</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/01/RxJavaStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2017/12/01/RxJavaStudy/" class="post-title-link" itemprop="url">RxJava学习</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2017-12-01 20:07:55" itemprop="dateCreated datePublished" datetime="2017-12-01T20:07:55+08:00">2017-12-01</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-23 17:30:07" itemprop="dateModified" datetime="2021-05-23T17:30:07+08:00">2021-05-23</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>RxJava 的异步实现，是通过一种扩展的观察者模式来实现的。免除了业务逻辑代码的频繁回调，增加了逻辑代码的可读性。</p>
<h2 id="观察者模式："><a href="#观察者模式：" class="headerlink" title="观察者模式："></a>观察者模式：</h2><p>A 对象（观察者）对 B 对象（被观察者）的某种变化高度敏感，需要在 B 变化的一瞬间做出反应。<br>观察者不需要时刻盯着被观察者（例如 A 不需要每过 2ms 就检查一次 B 的状态），而是采用注册(Register)或者称为订阅(Subscribe)的方式</p>
<ul>
<li>观察者接口定义<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(Object value)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>观察者实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Observer</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>,name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object value)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.message = (String) value;</span><br><span class="line">         readMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">"收到推送消息"</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>被观察者接口定义<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pushMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>被观察者实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatServerObservable</span> <span class="keyword">implements</span> <span class="title">Observable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 缓存多个观察者</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">         observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">        observers.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">              observer.update(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pushMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">         <span class="keyword">this</span>,message = message;</span><br><span class="line">         notifyObservers();</span><br><span class="line">        System.out.println(name + <span class="string">"发送推送消息"</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个被观察者，微信服务</span></span><br><span class="line">Observable observable =<span class="keyword">new</span> WeChatServerObservable();</span><br><span class="line"><span class="comment">//创建多个观察者，用户</span></span><br><span class="line">Observer user1 =<span class="keyword">new</span> UserPerson(<span class="string">"小方"</span>);</span><br><span class="line">Observer user2 =<span class="keyword">new</span> UserPerson(<span class="string">"小明"</span>);</span><br><span class="line">observable.addObserver(user1);</span><br><span class="line">observable.addObserver(user2);</span><br><span class="line"><span class="comment">//推送消息</span></span><br><span class="line">observable.pushMessage(<span class="string">"开始抢票！"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="RxJava-基本概念："><a href="#RxJava-基本概念：" class="headerlink" title="RxJava 基本概念："></a>RxJava 基本概念：</h2>Observable (可观察者，即被观察者)也称作上游<br>Observer (观察者)也称作下游<br>subscribe (订阅)、事件<br>Observable 和 Observer 通过 subscribe() 方法实现订阅关系，从而 Observable 可以在需要的时候发出事件来通知 Observer。</li>
</ul>
<p>与传统观察者模式不同， RxJava 的事件回调方法除了普通事件 onNext() （相当于 onClick() / onEvent()）之外，还定义了两个特殊的事件：onCompleted() 和 onError()。</p>
<p>onCompleted(): 事件队列完结。RxJava 不仅把每个事件单独处理，还会把它们看做一个队列。RxJava 规定，当不会再有新的 onNext() 发出时，需要触发 onCompleted() 方法作为标志。<br>onError(): 事件队列异常。在事件处理过程中出异常时，onError() 会被触发，同时队列自动终止，不允许再有事件发出。<br>在一个正确运行的事件序列中, onCompleted() 和 onError() 有且只有一个，并且是事件序列中的最后一个。需要注意的是，onCompleted() 和 onError() 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</p>
<p>对于Android本身有一套现成的框架，复杂的逻辑操作在服务端较多，客户端出现的场景较少，长时间不怎么使用，很容易让人忘记那些理论知识，所以根据一些实战例子来进行学习效果更佳。</p>
<h2 id="map操作符"><a href="#map操作符" class="headerlink" title="map操作符"></a>map操作符</h2><p>常用于数据列表类型转换<br>上游读取数据源并发送到下游，Utils.getApiUserList()模拟从服务端获得的dto类型为ApiUser的数据列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observable&lt;List&lt;ApiUser&gt;&gt; getObservable() &#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;ApiUser&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;ApiUser&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//上游未被切断</span></span><br><span class="line">            <span class="keyword">if</span> (!e.isDisposed()) &#123;</span><br><span class="line">                <span class="comment">//发送到下游,执行下游对应逻辑</span></span><br><span class="line">                e.onNext(Utils.getApiUserList());</span><br><span class="line">                <span class="comment">//上游发送完毕，执行下游对应逻辑</span></span><br><span class="line">                e.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ApiUser&gt; <span class="title">getApiUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ApiUser&gt; apiUserList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    ApiUser apiUserOne = <span class="keyword">new</span> ApiUser();</span><br><span class="line">    apiUserOne.firstname = <span class="string">"Amit"</span>;</span><br><span class="line">    apiUserOne.lastname = <span class="string">"Shekhar"</span>;</span><br><span class="line">    apiUserList.add(apiUserOne);</span><br><span class="line"></span><br><span class="line">    ApiUser apiUserTwo = <span class="keyword">new</span> ApiUser();</span><br><span class="line">    apiUserTwo.firstname = <span class="string">"Manish"</span>;</span><br><span class="line">    apiUserTwo.lastname = <span class="string">"Kumar"</span>;</span><br><span class="line">    apiUserList.add(apiUserTwo);</span><br><span class="line"></span><br><span class="line">    ApiUser apiUserThree = <span class="keyword">new</span> ApiUser();</span><br><span class="line">    apiUserThree.firstname = <span class="string">"Sumit"</span>;</span><br><span class="line">    apiUserThree.lastname = <span class="string">"Kumar"</span>;</span><br><span class="line">    apiUserList.add(apiUserThree);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> apiUserList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立订阅关系，通过map操作符将ApiUser类型的dto转化成User类型的dto，再执行下游的处理逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//上游处理逻辑</span></span><br><span class="line">    getObservable()</span><br><span class="line">            .map(<span class="keyword">new</span> Function&lt;List&lt;ApiUser&gt;, List&lt;User&gt;&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">apply</span><span class="params">(List&lt;ApiUser&gt; apiUsers)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">//转化操作</span></span><br><span class="line">                    <span class="keyword">return</span> Utils.convertApiUserListToUserList(apiUsers);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 在子线程中运行</span></span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            <span class="comment">// 切换到主线程</span></span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            <span class="comment">// 下游处理逻辑</span></span><br><span class="line">            .subscribe(getObserver());</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">convertApiUserListToUserList</span><span class="params">(List&lt;ApiUser&gt; apiUserList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ApiUser apiUser : apiUserList) &#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.firstname = apiUser.firstname;</span><br><span class="line">        user.lastname = apiUser.lastname;</span><br><span class="line">        userList.add(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下游获取到数据源，进行数据打印：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observer&lt;List&lt;User&gt;&gt; getObserver() &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;List&lt;User&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; userList)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onNext"</span>);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">                   textView.append(<span class="string">" firstname : "</span> + user.firstname);</span><br><span class="line">                   textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               &#125;</span><br><span class="line">               Log.d(TAG, <span class="string">" onNext : "</span> + userList.size());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="flatMap操作符"><a href="#flatMap操作符" class="headerlink" title="flatMap操作符"></a>flatMap操作符</h2><p>常用于遍历数据列表，按条件进行过滤<br>与它相同的是concatMap，但是flatMap可能会乱序，concatMap可保证下游的获取到的数据源与上游发送顺序一致<br>此处上游数据源与map操作符相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">getObservable()</span><br><span class="line">               .subscribeOn(Schedulers.io())</span><br><span class="line">               .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">               .flatMap(<span class="keyword">new</span> Function&lt;List&lt;ApiUser&gt;, ObservableSource&lt;ApiUser&gt;&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> ObservableSource&lt;ApiUser&gt; <span class="title">apply</span><span class="params">(List&lt;ApiUser&gt; apiUsers)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> Observable.fromIterable(apiUsers);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">               .filter(<span class="keyword">new</span> Predicate&lt;ApiUser&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(ApiUser apiUser)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> apiUser.lastname.substring(<span class="number">0</span>,<span class="number">1</span>).equals(<span class="string">"K"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">               .subscribe(getObserver());</span><br></pre></td></tr></table></figure>
<p>下游获取到数据源，进行数据打印：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Observer&lt;ApiUser&gt; <span class="title">getObserver</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;ApiUser&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiUser apiUser)</span> </span>&#123;</span><br><span class="line">               Log.d(TAG, <span class="string">"user : "</span> + apiUser.toString());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="zip操作符"><a href="#zip操作符" class="headerlink" title="zip操作符"></a>zip操作符</h2><p>常用于对两个数据源列表进行处理，并返回一个结果数据列表<br>上游读取两个数据源并发送到下游：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observable&lt;List&lt;User&gt;&gt; getCricketFansObservable() &#123;</span><br><span class="line">      <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;User&gt;&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;User&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">              <span class="comment">//上游未被切断</span></span><br><span class="line">              <span class="keyword">if</span> (!e.isDisposed()) &#123;</span><br><span class="line">                  <span class="comment">//发送到下游,执行下游对应逻辑</span></span><br><span class="line">                  e.onNext(Utils.getUserListWhoLovesCricket());</span><br><span class="line">                  <span class="comment">//上游发送完毕，执行下游对应逻辑</span></span><br><span class="line">                  e.onComplete();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Observable&lt;List&lt;User&gt;&gt; getFootballFansObservable() &#123;</span><br><span class="line">      <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;User&gt;&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;User&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">              <span class="comment">//上游未被切断</span></span><br><span class="line">              <span class="keyword">if</span> (!e.isDisposed()) &#123;</span><br><span class="line">                  <span class="comment">//发送到下游,执行下游对应逻辑</span></span><br><span class="line">                  e.onNext(Utils.getUserListWhoLovesFootball());</span><br><span class="line">                  <span class="comment">//上游发送完毕，执行下游对应逻辑</span></span><br><span class="line">                  e.onComplete();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//模拟数据源1</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">getUserListWhoLovesCricket</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      User userOne = <span class="keyword">new</span> User();</span><br><span class="line">      userOne.id = <span class="number">1</span>;</span><br><span class="line">      userOne.firstname = <span class="string">"Amit"</span>;</span><br><span class="line">      userOne.lastname = <span class="string">"Shekhar"</span>;</span><br><span class="line">      userList.add(userOne);</span><br><span class="line"></span><br><span class="line">      User userTwo = <span class="keyword">new</span> User();</span><br><span class="line">      userTwo.id = <span class="number">2</span>;</span><br><span class="line">      userTwo.firstname = <span class="string">"Manish"</span>;</span><br><span class="line">      userTwo.lastname = <span class="string">"Kumar"</span>;</span><br><span class="line">      userList.add(userTwo);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> userList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//模拟数据源2</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">getUserListWhoLovesFootball</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      User userOne = <span class="keyword">new</span> User();</span><br><span class="line">      userOne.id = <span class="number">1</span>;</span><br><span class="line">      userOne.firstname = <span class="string">"Amit"</span>;</span><br><span class="line">      userOne.lastname = <span class="string">"Shekhar"</span>;</span><br><span class="line">      userList.add(userOne);</span><br><span class="line"></span><br><span class="line">      User userTwo = <span class="keyword">new</span> User();</span><br><span class="line">      userTwo.id = <span class="number">3</span>;</span><br><span class="line">      userTwo.firstname = <span class="string">"Sumit"</span>;</span><br><span class="line">      userTwo.lastname = <span class="string">"Kumar"</span>;</span><br><span class="line">      userList.add(userTwo);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> userList;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>建立订阅关系，通过zip操作符过滤两个数据源都有的数据，返回结果数据列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Observable.zip(getCricketFansObservable(), getFootballFansObservable(),</span><br><span class="line">                <span class="keyword">new</span> BiFunction&lt;List&lt;User&gt;, List&lt;User&gt;, List&lt;User&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">apply</span><span class="params">(List&lt;User&gt; cricketFans, List&lt;User&gt; footballFans)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">//过滤两个数据表都有的数据，返回结果数据列表</span></span><br><span class="line">                        <span class="keyword">return</span> Utils.filterUserWhoLovesBoth(cricketFans, footballFans);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 在子线程中运行</span></span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                <span class="comment">// 切到主线程</span></span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                <span class="comment">// 下游逻辑处理</span></span><br><span class="line">                .subscribe(getObserver());</span><br><span class="line">                </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">filterUserWhoLovesBoth</span><span class="params">(List&lt;User&gt; cricketFans, List&lt;User&gt; footballFans)</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; userWhoLovesBoth = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span> (User cricketFan : cricketFans) &#123;</span><br><span class="line">            <span class="keyword">for</span> (User footballFan : footballFans) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cricketFan.id == footballFan.id) &#123;</span><br><span class="line">                    userWhoLovesBoth.add(cricketFan);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userWhoLovesBoth;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>下游获取到数据源进行数据打印</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observer&lt;List&lt;User&gt;&gt; getObserver() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;List&lt;User&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; userList)</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onNext"</span>);</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">                textView.append(<span class="string">" firstname : "</span> + user.firstname);</span><br><span class="line">                textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">" onNext : "</span> + userList.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Interval操作符"><a href="#Interval操作符" class="headerlink" title="Interval操作符"></a>Interval操作符</h2><p>常用于周期性的处理逻辑（每隔多少时间后执行）<br>上游11秒延迟后，每隔2秒，发送long型数据源到下游，从0开始逐渐递增</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observable&lt;? extends Long&gt; getObservable() &#123;</span><br><span class="line">       <span class="keyword">return</span> Observable.interval(<span class="number">11</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>建立订阅关系，CompositeDisposable统一存放水管，也就是被观察者，为防止内存泄漏，在activity被destory时切断所有的水管</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CompositeDisposable disposables = <span class="keyword">new</span> CompositeDisposable();</span><br><span class="line"> disposables.add(getObservable()</span><br><span class="line">                <span class="comment">// 上游运行在子线程</span></span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                <span class="comment">// 切换到主线程</span></span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                <span class="comment">// 下游逻辑处理</span></span><br><span class="line">                .subscribeWith(getObserver()));</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        disposables.clear();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>下游获取到数据源进行数据打印：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> DisposableObserver&lt;Long&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DisposableObserver&lt;Long&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long value)</span> </span>&#123;</span><br><span class="line">                textView.append(<span class="string">" onNext : value : "</span> + value);</span><br><span class="line">                textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">                Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">                textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">                Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">                textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">                Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Timer操作符"><a href="#Timer操作符" class="headerlink" title="Timer操作符"></a>Timer操作符</h2><p>常用于计时器的处理逻辑（多少时间后执行）<br>上游延迟2秒发送long型数据0到下游，只发送一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observable&lt;? extends Long&gt; getObservable() &#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.timer(<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>建立订阅关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getObservable()</span><br><span class="line">             <span class="comment">// 上游在子线程运行</span></span><br><span class="line">             .subscribeOn(Schedulers.io())</span><br><span class="line">             <span class="comment">// 切换到主线程</span></span><br><span class="line">             .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">             .subscribe(getObserver());</span><br></pre></td></tr></table></figure>
<p>下游进行打印输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Observer&lt;Long&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;Long&gt;() &#123;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long value)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onNext : value : "</span> + value);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Flowable背压式"><a href="#Flowable背压式" class="headerlink" title="Flowable背压式"></a>Flowable背压式</h2><p>Rxjava在处理异步操作时，会先将上游的数据放入一个缓存池中，这里称作水缸，一旦下游不能及时处理就会出现内存溢出的问题，抛出MissingBackpressureException<br>解决方式</p>
<ol>
<li>放慢上游的发送速度</li>
<li>减少发送的数据<br>Flowable在设计的时候采用了一种新的思路也就是响应式拉取的方式来更好的解决上下游流速不均衡的问题，<br>在同一线程中下游没有调用request, 上游就认为下游没有处理事件的能力，抛出MissingBackpressureException，当上下游工作在不同的线程中时,  只有当下游调用request时, 才从水缸里取出事件发给下游。 <h3 id="背压策略"><a href="#背压策略" class="headerlink" title="背压策略"></a>背压策略</h3><h4 id="BackpressureStrategy-ERROR："><a href="#BackpressureStrategy-ERROR：" class="headerlink" title="BackpressureStrategy.ERROR："></a>BackpressureStrategy.ERROR：</h4>默认策略，有一个大小为128的水缸<h4 id="BackpressureStrategy-BUFFER"><a href="#BackpressureStrategy-BUFFER" class="headerlink" title="BackpressureStrategy.BUFFER"></a>BackpressureStrategy.BUFFER</h4>增大水缸的容量，仍有内存溢出问题<h4 id="BackpressureStrategy-DROP"><a href="#BackpressureStrategy-DROP" class="headerlink" title="BackpressureStrategy.DROP"></a>BackpressureStrategy.DROP</h4>水缸存不下时，直接把存不下的事件丢弃<h4 id="BackpressureStrategy-LATEST"><a href="#BackpressureStrategy-LATEST" class="headerlink" title="BackpressureStrategy.LATEST"></a>BackpressureStrategy.LATEST</h4>水缸存不下时，只保留最新的事件<h2 id="reduce操作符"><a href="#reduce操作符" class="headerlink" title="reduce操作符"></a>reduce操作符</h2>遍历list，第一次将第一个元素和第二个元素作为入参，返回一个结果值，以后将上一次返回的结果和当前遍历的元素作为入参，返回一个结果值。<br>与它相同的是scan操作符，但是scan操作符会返回上一次的结果<br>上游创建数据源，发送到下游<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Integer&gt; <span class="title">getObservable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
建立订阅关系，将上一次返回的结果和当前遍历的元素作为入参，最后返回一个累加值<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getObservable()</span><br><span class="line">                .reduce(<span class="keyword">new</span> BiFunction&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">apply</span><span class="params">(Integer t1, Integer t2)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> t1 + t2;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .subscribe(getObserver());</span><br></pre></td></tr></table></figure>
下游进行打印输出<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> MaybeObserver&lt;Integer&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaybeObserver&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Integer value)</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onSuccess : value : "</span> + value);</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            Log.d(TAG, <span class="string">" onSuccess : value : "</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">            textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">            Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Filter操作符"><a href="#Filter操作符" class="headerlink" title="Filter操作符"></a>Filter操作符</h2>遍历list中的每个元素，按条件过滤<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">               .filter(<span class="keyword">new</span> Predicate&lt;Integer&gt;() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                       <span class="keyword">return</span> integer % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">               .subscribe(getObserver());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Observer&lt;Integer&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer value)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onNext : "</span>);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               textView.append(<span class="string">" value : "</span> + value);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onNext "</span>);</span><br><span class="line">               Log.d(TAG, <span class="string">" value : "</span> + value);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">               textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Contact操作符"><a href="#Contact操作符" class="headerlink" title="Contact操作符"></a>Contact操作符</h2>将多个数据源结合成一个数据源并发送数据，并且严格按照先后顺序发射数据<br>与它相同的有merge，但是merge是无序的且是并发的<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">String[] aStrings = &#123;<span class="string">"A1"</span>, <span class="string">"A2"</span>, <span class="string">"A3"</span>, <span class="string">"A4"</span>&#125;;</span><br><span class="line">String[] bStrings = &#123;<span class="string">"B1"</span>, <span class="string">"B2"</span>, <span class="string">"B3"</span>&#125;;</span><br><span class="line"></span><br><span class="line">Observable&lt;String&gt; aObservable = Observable.fromArray(aStrings);</span><br><span class="line">Observable&lt;String&gt; bObservable = Observable.fromArray(bStrings);</span><br><span class="line"></span><br><span class="line">Observable.concat(aObservable, bObservable)</span><br><span class="line">              .subscribe(getObserver());</span><br><span class="line">              </span><br><span class="line"><span class="function"><span class="keyword">private</span> Observer&lt;String&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">              Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">              textView.append(<span class="string">" onNext : value : "</span> + value);</span><br><span class="line">              textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">              Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">              textView.append(<span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">              textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">              Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              textView.append(<span class="string">" onComplete"</span>);</span><br><span class="line">              textView.append(AppConstant.LINE_SEPARATOR);</span><br><span class="line">              Log.d(TAG, <span class="string">" onComplete"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Rxbus的使用"><a href="#Rxbus的使用" class="headerlink" title="Rxbus的使用"></a>Rxbus的使用</h2>定义Rxbus<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PublishSubject&lt;Object&gt; bus = PublishSubject.create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送event</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        bus.onNext(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取bus对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Object&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus.hasObservers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在Application中初始化Rxbus，做事件的统一管理<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> RxBus bus;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        bus = <span class="keyword">new</span> RxBus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RxBus <span class="title">bus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bus;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在activity中发送事件，CompositeDisposable统一存放水管，为避免内存泄漏，destory时切断水管<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CompositeDisposable disposables = <span class="keyword">new</span> CompositeDisposable();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        disposables.clear();</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//上游是MyApplication的bus，建立订阅关系，绑定下游事件接收回调处理</span></span><br><span class="line"> disposables.add(((MyApplication) getApplication())</span><br><span class="line">                .bus()</span><br><span class="line">                .toObservable()</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Object&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Events.TapEvent) &#123;</span><br><span class="line">                            textView.setText(<span class="string">"Tap Event Received"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;));</span><br><span class="line">                </span><br><span class="line">    <span class="comment">//发送事件到MyApplication的bus</span></span><br><span class="line">    ((MyApplication) getApplication())</span><br><span class="line">                        .bus()</span><br><span class="line">                        .send(<span class="keyword">new</span> Events.TapEvent());</span><br></pre></td></tr></table></figure>
<h2 id="操作符组合使用"><a href="#操作符组合使用" class="headerlink" title="操作符组合使用"></a>操作符组合使用</h2>android搜索功能的实现<br>绑定searchview的监听<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxSearchObservable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Observable&lt;String&gt; <span class="title">fromView</span><span class="params">(SearchView searchView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PublishSubject&lt;String&gt; subject = PublishSubject.create();</span><br><span class="line"></span><br><span class="line">        searchView.setOnQueryTextListener(<span class="keyword">new</span> SearchView.OnQueryTextListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                subject.onComplete();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">                subject.onNext(text);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
建立订阅关系，上游输入文字监听，下游显示结果<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上游绑定SearchView输入文字监听</span></span><br><span class="line">    RxSearchObservable.fromView(searchView)</span><br><span class="line">            <span class="comment">//每隔300毫秒执行</span></span><br><span class="line">            .debounce(<span class="number">300</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">            <span class="comment">//过滤输入文字不为空</span></span><br><span class="line">            .filter(<span class="keyword">new</span> Predicate&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String text)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (text.isEmpty()) &#123;</span><br><span class="line">                        textViewResult.setText(<span class="string">""</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">//与上次的数据对比有变化</span></span><br><span class="line">            .distinctUntilChanged()</span><br><span class="line">            <span class="comment">//只发射最近的一次observable</span></span><br><span class="line">            .switchMap(<span class="keyword">new</span> Function&lt;String, ObservableSource&lt;String&gt;&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> ObservableSource&lt;String&gt; <span class="title">apply</span><span class="params">(String query)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="comment">//从网络获取数据</span></span><br><span class="line">                    <span class="keyword">return</span> dataFromNetwork(query);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">//在子线程中运行</span></span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            <span class="comment">//切到主线程</span></span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            <span class="comment">//下游显示结果</span></span><br><span class="line">            .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String result)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    textViewResult.setText(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line"><span class="comment">//模拟网络请求</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;String&gt; <span class="title">dataFromNetwork</span><span class="params">(<span class="keyword">final</span> String query)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.just(<span class="keyword">true</span>)</span><br><span class="line">            .delay(<span class="number">2</span>, TimeUnit.SECONDS)</span><br><span class="line">            .map(<span class="keyword">new</span> Function&lt;Boolean, String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(@NonNull Boolean value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> query;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="封装线程切换"><a href="#封装线程切换" class="headerlink" title="封装线程切换"></a>封装线程切换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> &lt;UD&gt; ObservableTransformer &lt;UD, UD&gt; rxud()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObservableTransformer&lt;UD,UD&gt;()&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ObservableSource&lt;UD&gt; <span class="title">apply</span> <span class="params">(Observable&lt;UD&gt; upstream)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> upstream.subscribeOn(Schedulers,io())</span><br><span class="line">                       .observableOn(AndroidSchedulers.mainThread());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Observable.from(getObservable())  </span><br><span class="line">    .map(data -&gt; dealwith(data))</span><br><span class="line">    .compose(rxud())</span><br><span class="line">    .subscribe(getObserver());</span><br></pre></td></tr></table></figure>
<h2 id="切子线程切主线程再切子线程切主线程"><a href="#切子线程切主线程再切子线程切主线程" class="headerlink" title="切子线程切主线程再切子线程切主线程"></a>切子线程切主线程再切子线程切主线程</h2>doOnNext 替代subscribeOn连接两次请求之间的切换<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">api.registerAction()</span><br><span class="line">     .subscribeOn(Schedulers.io())</span><br><span class="line">     .observableOn(AndroidSchedulers.mainThread())</span><br><span class="line">     .doOnNext(<span class="keyword">new</span> Consumer&lt;RegisterResponse&gt;()&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(RegisterResponse registerResponse)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">             </span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     .observableOn(Schedulers.io())</span><br><span class="line">     .flatMap(<span class="keyword">new</span> Function&lt;RegisterResponse, ObservableSource&lt;LoginResponse&gt;&gt;()&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> ObservableSource&lt;LoginResponse&gt;  <span class="title">apply</span><span class="params">(RegisterResponse registerResponse)</span></span>&#123;</span><br><span class="line">             Observable&lt;LoginResponse&gt; loginResponse = api.loginAction();</span><br><span class="line">             <span class="keyword">return</span> loginResponse;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     .observableOn(AndroidSchedulers.mainThread())</span><br><span class="line">     .subscribe(<span class="keyword">new</span> Observable&lt;LoginResponse&gt;&#123;</span><br><span class="line"></span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="封装RXView"><a href="#封装RXView" class="headerlink" title="封装RXView"></a>封装RXView</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxView</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = RxView.class.getSimpleName();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Observable&lt;Object&gt; <span class="title">clicks</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> ViewClickObservable(view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewClickObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> View view;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object EVENT = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object EVENT2;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewClickObservable</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.view = view;</span><br><span class="line">        EVENT2 = view;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Object&gt; observer)</span></span>&#123;</span><br><span class="line">          MyListener myListener = <span class="keyword">new</span> MyListener(view, observer);</span><br><span class="line">          observer.onSubscribe(myListener)</span><br><span class="line">        </span><br><span class="line">          <span class="keyword">this</span>.view.setOnClickListener(myListener)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>, <span class="title">Disposable</span></span>&#123;</span><br><span class="line">           <span class="keyword">private</span> <span class="keyword">final</span> View view;</span><br><span class="line">           <span class="keyword">private</span> Observer&lt;Object&gt; observer;</span><br><span class="line">           <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean isDisposable = <span class="keyword">new</span> AtomicBoolean(); <span class="comment">// 是否中断</span></span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="title">MyListener</span><span class="params">(View view, Observer&lt;Object&gt; observer)</span></span>&#123;</span><br><span class="line">                 <span class="keyword">this</span>.view = view;</span><br><span class="line">                 <span class="keyword">this</span>.observer  = observer;</span><br><span class="line">           &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>&#123;</span><br><span class="line">                <span class="comment">// 继续分发</span></span><br><span class="line">                 <span class="keyword">if</span> (isDisposed() == <span class="keyword">false</span>)&#123;</span><br><span class="line">                      observer.onNext(EVENT);</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="comment">// 之前没有中断，设置为中断</span></span><br><span class="line">                  <span class="keyword">if</span> (isDisposable.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>))&#123;</span><br><span class="line">                      <span class="comment">// 主线程取消监听逻辑</span></span><br><span class="line">                      <span class="keyword">if</span> (Looper.myLoop() == Looper.getMainLooper())&#123;</span><br><span class="line">                            view.setOnClickListener(<span class="keyword">null</span>)</span><br><span class="line">                      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                         AndroidSchedulers.mainThread().schedulerDirect(<span class="keyword">new</span> Runnable())&#123;</span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">                                     view.setOnClickListener(<span class="keyword">null</span>)</span><br><span class="line">                               &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> isDisposable;</span><br><span class="line">            &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RxView.clicks(button)</span><br><span class="line">             .throttleFirst(<span class="number">2000</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">             .subscribe(<span class="keyword">new</span> Consumer&lt;Object&gt;()&#123;</span><br><span class="line">                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                     Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;String&gt;()&#123;</span><br><span class="line">                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;String&gt; e)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">                             e.onNext(<span class="string">"click"</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;)</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;)</span><br><span class="line">             .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;()&#123;</span><br><span class="line">                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                     Log.d(<span class="string">"RxView"</span>,<span class="string">"accept:"</span> + s)</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;)</span><br></pre></td></tr></table></figure></li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/12/Java8-NewFeatures/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2017/11/12/Java8-NewFeatures/" class="post-title-link" itemprop="url">java8新特性学习</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2017-11-12 21:51:24" itemprop="dateCreated datePublished" datetime="2017-11-12T21:51:24+08:00">2017-11-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-08-28 19:01:18" itemprop="dateModified" datetime="2018-08-28T19:01:18+08:00">2018-08-28</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>java9已经发布一段时间了，AndroidStudio才开始支持Java 8，Java 8是Java的一个重大版本，虽然这些新特性令Java开发人员十分期待，但同时也需要花不少精力去学习，对于android开发者而言了解Java8的新特性是必要的，虽然现在Google力推kotlin，但是Java仍然是排名第一的使用最广泛的语言，社区依旧很活跃，也是处于不断进步和发展中，而且在新特性中我们能看到一些kotlin的影子。</p>
<h1 id="lambda表达式的支持"><a href="#lambda表达式的支持" class="headerlink" title="lambda表达式的支持"></a>lambda表达式的支持</h1><p>格式为：(入参) -&gt; {函数体}</p>
<h2 id="基本形式："><a href="#基本形式：" class="headerlink" title="基本形式："></a>基本形式：</h2><p>入参和返回值的类型可被编译器推测，入参一个参数不需要括号，无参直接写为<code>（）</code>，函数体多行可加上括号</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; a + b;</span><br><span class="line">(a, b) -&gt; a - b;</span><br><span class="line">(<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; &#123; <span class="keyword">return</span> a * b; &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h2><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p>以前的写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (String player : players) &#123;  </span><br><span class="line">     System.out.print(player + <span class="string">"; "</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>lambda写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">players.forEach((player) -&gt; System.out.print(player + <span class="string">"; "</span>));</span><br></pre></td></tr></table></figure>
<h3 id="ui回调"><a href="#ui回调" class="headerlink" title="ui回调"></a>ui回调</h3><p>以前的写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">check_all.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>
<p>lambda写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check_all.setOnClickListener(v-&gt;&#123;&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h3><p>以前的写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">"Hello world !"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<p>lambda写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"Hello world !"</span>)).start();</span><br></pre></td></tr></table></figure>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>以前的写法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arrays.sort(players, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String s1, String s2)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (s1.length() - s2.length());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>lambda写法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.sort(players, (String s1, String s2) -&gt; (s1.length() - s2.length()));</span><br></pre></td></tr></table></figure>
<h3 id="结合Stream"><a href="#结合Stream" class="headerlink" title="结合Stream"></a>结合Stream</h3><p>Stream是对集合的包装，通常和lambda一起使用。 使用lambdas可以支持许多操作,如 map, filter, limit, sorted, count, min, max, sum, collect 等等。<br>定义一个类，医生</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Doctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String degree;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> salary;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Doctor</span><span class="params">(String name, <span class="keyword">int</span> age, String degree, <span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.degree = degree;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDegree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> degree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDegree</span><span class="params">(String degree)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.degree = degree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSalary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSalary</span><span class="params">(<span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先初始化医生列表，foreach循环输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Doctor&gt; doctors =<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"joe"</span>,<span class="number">20</span>,<span class="string">"bachelor"</span>,<span class="number">2000</span>));</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"jack"</span>,<span class="number">23</span>,<span class="string">"bachelor"</span>,<span class="number">2300</span>));</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"kris"</span>,<span class="number">27</span>,<span class="string">"Master"</span>,<span class="number">4200</span>));</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"bob"</span>,<span class="number">28</span>,<span class="string">"doctor"</span>,<span class="number">5000</span>));</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"tom"</span>,<span class="number">26</span>,<span class="string">"Master"</span>,<span class="number">4400</span>));</span><br><span class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"jay"</span>,<span class="number">29</span>,<span class="string">"doctor"</span>,<span class="number">5500</span>));</span><br><span class="line"></span><br><span class="line"> doctors.forEach(</span><br><span class="line">         (doctor)-&gt;&#123;</span><br><span class="line">             System.out.println(doctor.getName());</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">         );</span><br></pre></td></tr></table></figure>
<p>过滤器filter()，过滤出年龄大于25岁且学历为博士的医生</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">doctors.stream().filter( doctor -&gt; doctor.getAge()&gt;<span class="number">25</span>)</span><br><span class="line">                .filter(doctor -&gt; <span class="string">"doctor"</span>.equals(doctor.getDegree()))</span><br><span class="line">                .forEach(doctor -&gt; System.out.println(doctor.getName()));</span><br></pre></td></tr></table></figure>
<p>limit方法，限制结果个数，年龄大于25的前三个医生</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">doctors.stream().filter( doctor -&gt; doctor.getAge()&gt;<span class="number">25</span>)</span><br><span class="line">              .limit(<span class="number">3</span>)</span><br><span class="line">              .forEach(doctor -&gt; System.out.println(doctor.getName()));</span><br></pre></td></tr></table></figure>
<p>sorted方法，按薪水由多到少排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">doctors.stream().sorted((d1,d2)-&gt;d2.getSalary()-d1.getSalary())</span><br><span class="line">        .forEach(</span><br><span class="line">                (doctor)-&gt;&#123;</span><br><span class="line">                    System.out.println(doctor.getName());</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>
<p>min和max方法，找出最低和最高的薪水</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Doctor doctor1=doctors.stream().min((d1,d2)-&gt;d1.getSalary()-d2.getSalary()).get();</span><br><span class="line">System.out.print(doctor1.getName());</span><br><span class="line"></span><br><span class="line">Doctor doctor2=doctors.stream().min((d1,d2)-&gt;d1.getSalary()-d2.getSalary()).get();</span><br><span class="line">System.out.print(doctor2.getName());</span><br></pre></td></tr></table></figure>

<p>结合 map 方法,使用 collect 方法来将我们的结果集放到一个字符串,一个 Set 中<br>将所有医生的名字拼接在一个string中，用逗号隔开</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String names=doctors.stream().map(Doctor::getName).collect(joining(<span class="string">","</span>));</span><br><span class="line">System.out.print(names);</span><br></pre></td></tr></table></figure>
<p>将所有医生的名字存放到一个set中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; doctorSet=doctors.stream().map(Doctor::getName).collect(Collectors.toSet());</span><br><span class="line">octorSet.forEach((name)-&gt;System.out.println(name));</span><br></pre></td></tr></table></figure>
<p>summaryStatistics方法获得stream中元素的汇总数据，求和，平均值，最大最小值，个数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">IntSummaryStatistics statistics=doctors.stream()</span><br><span class="line">                .mapToInt(doctor-&gt;doctor.getSalary())</span><br><span class="line">                .summaryStatistics();</span><br><span class="line">System.out.println(statistics.getSum());</span><br><span class="line">System.out.println(statistics.getAverage());</span><br><span class="line">System.out.println(statistics.getMax());</span><br><span class="line">System.out.println(statistics.getMin());</span><br><span class="line">System.out.println(statistics.getCount());</span><br></pre></td></tr></table></figure>
<h1 id="接口的默认方法和静态方法"><a href="#接口的默认方法和静态方法" class="headerlink" title="接口的默认方法和静态方法"></a>接口的默认方法和静态方法</h1><p>默认方法和抽象方法之间的区别在于抽象方法需要实现，而默认方法不需要。接口提供的默认方法可以被接口的实现类继承或者覆写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">defaultMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is default method"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> <span class="keyword">implements</span> <span class="title">MyInterface</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在接口中可以定义静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">default</span> String <span class="title">defaultMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"this is default method"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> String <span class="title">staticMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"this is static method"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="方法的引用方式"><a href="#方法的引用方式" class="headerlink" title="方法的引用方式"></a>方法的引用方式</h1><p>初始化数组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;Integer, String[]&gt; fun = x -&gt; <span class="keyword">new</span> String[x];</span><br><span class="line">String[] strs = fun.apply(<span class="number">10</span>);</span><br><span class="line">System.out.println(strs.length);</span><br><span class="line">Function&lt;Integer,String[]&gt; fun1 = String[]::<span class="keyword">new</span>;</span><br><span class="line">strs = fun1.apply(<span class="number">20</span>);</span><br><span class="line">System.out.println(strs.length);</span><br></pre></td></tr></table></figure>
<p>构造方法的引用 Class::new只针对无参构造，若该类只有有参构造，需要添加一个无参构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;Student&gt; supplier=Student::<span class="keyword">new</span>;</span><br><span class="line">Student student=supplier.get();</span><br><span class="line">student.setName(<span class="string">"小明"</span>);</span><br><span class="line">System.out.println(student.getName());</span><br></pre></td></tr></table></figure>
<p>有参构造调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;Student&gt; supplier=()-&gt;<span class="keyword">new</span> Student(<span class="string">"小张"</span>,<span class="string">"man"</span>,<span class="number">12</span>);</span><br><span class="line">Student student=supplier.get();</span><br><span class="line">System.out.println(student.getName());</span><br></pre></td></tr></table></figure>
<p>静态方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;String&gt; supplier=Student::saying;</span><br><span class="line">System.out.println(supplier.get());</span><br></pre></td></tr></table></figure>
<p>成员方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Supplier&lt;Student&gt; supplier=Student::<span class="keyword">new</span>;</span><br><span class="line">Student student=supplier.get();</span><br><span class="line">Consumer&lt;String&gt; consumer1=student::setName;</span><br><span class="line">consumer1.accept(<span class="string">"小明"</span>);</span><br><span class="line">Consumer&lt;Integer&gt; consumer2=student::setAge;</span><br><span class="line">consumer2.accept(<span class="number">18</span>);</span><br><span class="line">System.out.println(student.getName()+<span class="string">":"</span>+student.getAge());</span><br></pre></td></tr></table></figure>
<h1 id="注解的变化"><a href="#注解的变化" class="headerlink" title="注解的变化"></a>注解的变化</h1><h2 id="支持重复注解"><a href="#支持重复注解" class="headerlink" title="支持重复注解"></a>支持重复注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Filter</span>( <span class="string">"filter1"</span> )</span><br><span class="line"><span class="meta">@Filter</span>( <span class="string">"filter2"</span> )</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filterable</span> </span>&#123;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Filterable.class.getAnnoation(Filters.class)</span><br></pre></td></tr></table></figure>
<p>控制台输出：<br>filter1<br>filter2</p>
<h2 id="注解使用范围扩大"><a href="#注解使用范围扩大" class="headerlink" title="注解使用范围扩大"></a>注解使用范围扩大</h2><p>java8可以使用在任何元素上：局部变量、方法、接口、类和泛型，甚至可以用在函数的异常定义上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>( RetentionPolicy.RUNTIME )</span><br><span class="line"><span class="meta">@Target</span>( &#123; ElementType.TYPE_USE, ElementType.TYPE_PARAMETER &#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NonEmpty &#123;        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span>&lt; @<span class="title">NonEmpty</span> <span class="title">T</span> &gt; <span class="keyword">extends</span> @<span class="title">NonEmpty</span> <span class="title">Object</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> <span class="keyword">throws</span> @NonEmpty Exception </span>&#123;            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>( <span class="string">"unused"</span> )</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Holder&lt; String &gt; holder = <span class="keyword">new</span> <span class="meta">@NonEmpty</span> Holder&lt; String &gt;();        </span><br><span class="line">    <span class="meta">@NonEmpty</span> Collection&lt; <span class="meta">@NonEmpty</span> String &gt; strings = <span class="keyword">new</span> ArrayList&lt;&gt;();        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Map新增方法"><a href="#Map新增方法" class="headerlink" title="Map新增方法"></a>Map新增方法</h1><p>初始化一个map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="number">1</span>, <span class="string">"Tom"</span>);</span><br><span class="line">map.put(<span class="number">2</span>, <span class="string">"Bob"</span>);</span><br><span class="line">map.put(<span class="number">3</span>, <span class="string">"Jack"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="forEach-遍历"><a href="#forEach-遍历" class="headerlink" title="forEach 遍历"></a>forEach 遍历</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.forEach((key,value)-&gt;System.out.println(key+<span class="string">":"</span>+value));</span><br></pre></td></tr></table></figure>
<h2 id="getOrDefault"><a href="#getOrDefault" class="headerlink" title="getOrDefault"></a>getOrDefault</h2><p>如果指定的key存在，则返回该key对应的value，如果不存在，则返回指定的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(map.getOrDefault(<span class="number">4</span>, <span class="string">"name"</span>));</span><br></pre></td></tr></table></figure>
<h2 id="replaceAll修改所有的value值"><a href="#replaceAll修改所有的value值" class="headerlink" title="replaceAll修改所有的value值"></a>replaceAll修改所有的value值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//所有value前面加上一个编号</span></span><br><span class="line">map.replaceAll((key,value)-&gt;<span class="string">"20000"</span>+key+value);</span><br><span class="line">map.forEach((key,value)-&gt;System.out.println(key+<span class="string">":"</span>+value));</span><br></pre></td></tr></table></figure>
<h2 id="putIfAbsent返回key对应的value，如果value为空则填入一个值"><a href="#putIfAbsent返回key对应的value，如果value为空则填入一个值" class="headerlink" title="putIfAbsent返回key对应的value，如果value为空则填入一个值"></a>putIfAbsent返回key对应的value，如果value为空则填入一个值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map.putIfAbsent(<span class="number">3</span>, <span class="string">"xiaoming"</span>);</span><br><span class="line">map.putIfAbsent(<span class="number">4</span>, <span class="string">"xiaoming"</span>);</span><br><span class="line"><span class="comment">//Jack</span></span><br><span class="line">System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line"><span class="comment">//xiaoming</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>
<h2 id="remove指定元素删除"><a href="#remove指定元素删除" class="headerlink" title="remove指定元素删除"></a>remove指定元素删除</h2><p>如果key获取的value值与给的value值相等，则删除这个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map.remove(<span class="number">1</span>, <span class="string">"Bob"</span>);</span><br><span class="line"><span class="comment">// 未删除成功， 输出 Tom</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">map.remove(<span class="number">2</span>, <span class="string">"Bob"</span>);</span><br><span class="line"><span class="comment">// 删除成功，输出 null</span></span><br><span class="line">System.out.println(map.get(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h2 id="replace替换"><a href="#replace替换" class="headerlink" title="replace替换"></a>replace替换</h2><p>如果key获取的value值与给的value值相等，则把这个value替换成一个新的value</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map.replace(<span class="number">3</span>, <span class="string">"Tom"</span>, <span class="string">"Joe"</span>);</span><br><span class="line"><span class="comment">// 未替换成功，输出 Jack</span></span><br><span class="line">System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line">map.replace(<span class="number">1</span>, <span class="string">"Tom"</span>, <span class="string">"Joe"</span>);</span><br><span class="line"><span class="comment">// 替换成功， 输出 Joe</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>如果map中存在key，则替换成value值，替换成功返回旧值，否则返回null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出Tom</span></span><br><span class="line">System.out.println( map.replace(<span class="number">1</span>, <span class="string">"Joe"</span>));</span><br><span class="line"><span class="comment">//输出Joe</span></span><br><span class="line">System.out.println( map.get(<span class="number">1</span>));</span><br><span class="line"><span class="comment">//输出null</span></span><br><span class="line">System.out.println( map.replace(<span class="number">4</span>, <span class="string">"Joe"</span>));</span><br><span class="line"><span class="comment">//输出null</span></span><br><span class="line">System.out.println( map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>
<h2 id="computeIfAbsent"><a href="#computeIfAbsent" class="headerlink" title="computeIfAbsent"></a>computeIfAbsent</h2><p>如果指定的key不存在，则可通过key计算value为新的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map.computeIfAbsent(<span class="number">1</span>,key-&gt;key+<span class="string">"newName"</span>);</span><br><span class="line"><span class="comment">//输出Tom</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line">map.computeIfAbsent(<span class="number">4</span>,key-&gt;key+<span class="string">"newName"</span>);</span><br><span class="line"><span class="comment">//输出4newName</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h2 id="computeIfPresent"><a href="#computeIfPresent" class="headerlink" title="computeIfPresent"></a>computeIfPresent</h2><p>如果指定的key存在，则根据key和value计算一个新的newValue, 如果这个newValue不为null，则设置key新的值为这个newValue, 如果newValue为null, 则删除该key的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map.computeIfPresent(<span class="number">1</span>, (key, value) -&gt; key + <span class="string">"新的值:"</span> + value);</span><br><span class="line"><span class="comment">// 输出1新的值:Tom</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">map.computeIfPresent(<span class="number">2</span>, (key, value) -&gt; <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// 输出 null</span></span><br><span class="line">System.out.println(map.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<h2 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h2><p>如果指定的key不存在，则设置指定的value值，否则根据key和value计算一个新的newValue, 如果这个newValue不为null，则设置key新的值为这个newValue, 如果newValue为null, 则删除该key的值。<br>这个解释有点长，容易绕，实际上用if-else可以很简单的表达</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!key.exist())&#123;</span><br><span class="line">   map.computeIfAbsent(key,key-&gt;key+<span class="string">"newValue"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">   map.computeIfPresent(key, (key, value) -&gt; key + <span class="string">"新的值:"</span> + value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以就是if key不存在，调computeIfAbsent，否则调computeIfPresent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map.compute(<span class="number">4</span>,(key,value)-&gt;key+<span class="string">":"</span>+value+<span class="string">"新的值"</span>);</span><br><span class="line"><span class="comment">//输出 4:null新的值</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br><span class="line">map.compute(<span class="number">1</span>,(key,value)-&gt;key+<span class="string">":"</span>+<span class="string">"新的值"</span>);</span><br><span class="line"><span class="comment">//输出 1:新的值</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><p>如果指定的key不存在，直接设置指定值，如果存在根据旧的value，指定值计算出新的值newValue, 如果这个newValue不为空，设置key的新值newValue，如果newValue为null, 则删除该key。最后返回当前最新的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//输出 指定的名字</span></span><br><span class="line">System.out.println(map.merge(<span class="number">4</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;oldValue+<span class="string">","</span>+assignValue));</span><br><span class="line"><span class="comment">//输出 Tom,指定的名字</span></span><br><span class="line">System.out.println(map.merge(<span class="number">1</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;oldValue+<span class="string">","</span>+assignValue));</span><br><span class="line"><span class="comment">//输出 null</span></span><br><span class="line">System.out.println(map.merge(<span class="number">1</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;<span class="keyword">null</span>));</span><br></pre></td></tr></table></figure>
<h1 id="空指针判断类Optional"><a href="#空指针判断类Optional" class="headerlink" title="空指针判断类Optional"></a>空指针判断类Optional</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">String str1=<span class="keyword">null</span>;</span><br><span class="line">String str2=<span class="string">"abc"</span>;</span><br><span class="line"><span class="comment">//创建初始化Optional对象，可为空的</span></span><br><span class="line">Optional&lt;String&gt; optionalStr1=Optional.ofNullable(str1);</span><br><span class="line"><span class="comment">//创建初始化Optional对象，不可为空，会抛异常</span></span><br><span class="line">Optional&lt;String&gt; optionalStr2=Optional.of(str2);</span><br><span class="line">System.out.println(<span class="string">"第一个参数是否存在"</span>+optionalStr1.isPresent());</span><br><span class="line">System.out.println(<span class="string">"第二个参数是否存在"</span>+optionalStr2.isPresent());</span><br><span class="line"><span class="comment">//不存在时返回默认值，存在时返回该值</span></span><br><span class="line">String getStr1=optionalStr1.orElse(<span class="string">"这个值不存在的默认值"</span>);</span><br><span class="line"><span class="comment">//返回该值，该值必须存在</span></span><br><span class="line">String getStr2=optionalStr2.get();</span><br><span class="line">System.out.println(getStr1);</span><br><span class="line">System.out.println(getStr2);</span><br></pre></td></tr></table></figure>
<h1 id="日期和时间Joda-Time的支持"><a href="#日期和时间Joda-Time的支持" class="headerlink" title="日期和时间Joda-Time的支持"></a>日期和时间Joda-Time的支持</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前的日期时间</span></span><br><span class="line">LocalDateTime currentTime = LocalDateTime.now();</span><br><span class="line">System.out.println(<span class="string">"当前时间: "</span> + currentTime);</span><br><span class="line"><span class="comment">// 获取当前日期</span></span><br><span class="line">LocalDate currentDate = currentTime.toLocalDate();</span><br><span class="line">System.out.println(<span class="string">"当前日期: "</span> + currentDate);</span><br><span class="line">System.out.println(<span class="string">"年"</span>+currentDate.getYear()+<span class="string">"月"</span>+currentDate.getMonthOfYear()+<span class="string">"日"</span>+currentDate.getDayOfMonth());</span><br><span class="line"><span class="comment">// 修改当前时间的月份和年份</span></span><br><span class="line">currentDate.withYear(<span class="number">2013</span>).withMonthOfYear(<span class="number">3</span>);</span><br><span class="line">System.out.println(<span class="string">"修改后的日期: "</span> + currentDate);</span><br><span class="line"><span class="comment">// 日期格式化</span></span><br><span class="line">System.out.println(currentDate.toString(<span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line"><span class="comment">// 修改时区</span></span><br><span class="line">DateTimeZone zoneEurope = DateTimeZone.forID(<span class="string">"Europe/London"</span>);</span><br><span class="line">DateTime dtLondon = <span class="keyword">new</span> DateTime().withZone(zoneEurope);</span><br><span class="line">System.out.println(<span class="string">"修改时区: "</span> + dtLondon);</span><br><span class="line">DateTimeZone currentZone = DateTimeZone.getDefault();</span><br><span class="line">DateTime dtCurrent = <span class="keyword">new</span> DateTime().withZone(currentZone);</span><br><span class="line">System.out.println(<span class="string">"当期时区: "</span> + dtCurrent);</span><br></pre></td></tr></table></figure>
<h1 id="base64支持"><a href="#base64支持" class="headerlink" title="base64支持"></a>base64支持</h1><p>基本编解码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 使用基本编码</span></span><br><span class="line">        String base64encodedString = Base64.getEncoder().encodeToString(<span class="string">"这是待编码的字符串"</span>.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Base64编码后"</span> + base64encodedString);</span><br><span class="line">        <span class="comment">// 解码</span></span><br><span class="line">        <span class="keyword">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(base64encodedString);</span><br><span class="line">        System.out.println(<span class="string">"原始字符串: "</span> + <span class="keyword">new</span> String(base64decodedBytes, <span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="comment">//使用url编码</span></span><br><span class="line">        String base64encodedUrl = Base64.getUrlEncoder().encodeToString(<span class="string">"这是待编码的字符串"</span>.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Base64 URL编码:"</span> + base64encodedUrl);</span><br><span class="line">        <span class="comment">//生成随机uuid</span></span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            stringBuilder.append(UUID.randomUUID().toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用mime编码</span></span><br><span class="line">        <span class="keyword">byte</span>[] mimeBytes = stringBuilder.toString().getBytes(<span class="string">"utf-8"</span>);</span><br><span class="line">        String mimeEncodedString = Base64.getMimeEncoder().encodeToString(mimeBytes);</span><br><span class="line">        System.out.println(<span class="string">"Base64 MIME编码:"</span> + mimeEncodedString);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(UnsupportedEncodingException e)&#123;</span><br><span class="line">        System.out.println(<span class="string">"Error :"</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jessie Kate</p>
  <div class="site-description" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  





















  

  

  


</body>
</html>
