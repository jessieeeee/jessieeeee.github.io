<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JessieK&#39;s blog">
<meta name="twitter:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>JessieK's blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/IjkplayerSo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/IjkplayerSo/" itemprop="url">ijkplayer编译so文件支持更多格式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T21:50:54+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/16/IjkplayerSo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/02/16/IjkplayerSo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/02/16/IjkplayerSo/" class="leancloud_visitors" data-flag-title="ijkplayer编译so文件支持更多格式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>bilibili大名鼎鼎的ijkplayer开源播放器，有支持ffmpeg拓展，可拓展性高，体积小的优点，成为很多公司的首选播放器，但官方给的demo只支持mp4格式，想要支持横多的视频格式需要自己修改配置文件并重新编译出so文件才能实现，之前折腾了很久，一直是循环编译，最后编译失败。周末闲来下了，继续折腾终于编译成功，下面对ijkplayer的配置修改和编译做一个详细记录，方便以后查阅。</p>
<p>编译前提：在linux或者mac开发环境下，配置好JDK,SDK,NDK的环境变量</p>
<p>编译步骤：</p>
<ol>
<li>git clone ijkplayer的源码</li>
<li>通过init-android.sh脚本把ijkplayer的jni源码和ffmepg的源码拉下来</li>
<li>如果要支持https，通过init-android-openssl.sh把openssl的代码拉下来</li>
<li>用脚本compile-openssl.sh编译openssl</li>
<li>选择编译配置文件，修改配置</li>
<li>用脚本compile-ffmpeg.sh编译ffmpeg</li>
<li>用脚本compile-ijk.sh编译ijkplayer的jni源码</li>
</ol>
<p>下面是具体的操作过程：</p>
<ol>
<li><p>拉ijkplayer的源码</p>
<p><code>git clone https://github.com/bilibili/ijkplayer</code></p>
</li>
<li><p>切换目录，把ijkplayer的jni源码和ffmepg的源码拉下来</p>
<p><code>cd ijkplayer</code></p>
<p><code>./init-android.sh</code></p>
</li>
<li><p>把openssl的代码拉下来</p>
<p><code>./init-android-openssl.sh</code></p>
</li>
<li><p>切换目录，编译openssl</p>
<p><code>cd android/contrib</code></p>
<p><code>./compile-openssl.sh clean</code></p>
<p><code>./compile-openssl.sh all</code></p>
</li>
<li><p>切换目录，修改配置文件，删除之前的配置文件软链接，并重新设置一个配置文件的软链接</p>
<p><code>cd ../../</code></p>
<p><code>cd config</code></p>
<p><code>rm module.sh</code></p>
<p><code>ln -s module-default.sh module.sh</code></p>
<p>注意module-lite.sh是精简了支持格式的配置文件，module-default.sh这个是支持格式较多的配置文件</p>
<p>这一步，遇到了一个错误<code>linux/perf_event.h: No such file</code>，当执行ffmpeg的编译操作，<code>./compile-ffmpeg.sh all</code>才会提示。</p>
<p>解决方案：</p>
<p>先删除之前的软链接文件<code>rm module.sh</code></p>
<p>改一下module-default.sh配置文件，在末尾添加2行代码：</p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export COMMON_FF_CFG_FLAGS="$COMMON_FF_CFG_FLAGS --disable-linux-perf"</div><div class="line">export COMMON_FF_CFG_FLAGS="$COMMON_FF_CFG_FLAGS --disable-bzlib"</div></pre></td></tr></table></figure>
<p>再创建软链接<code>ln -s module-default.sh module.sh</code></p>
</li>
<li><p>切换目录，编译ffmpeg</p>
<p><code>cd ..</code></p>
<p><code>cd android/contrib</code></p>
<p><code>./compile-ffmpeg.sh clean</code></p>
<p><code>./compile-ffmpeg.sh all</code></p>
<p>这一步，遇到了一个错误<code>nasm/yasm not found or too old. Use --disable-x86asm for a crippled build</code></p>
<p> 提示汇编工具没有安装。</p>
<p>解决方案：</p>
<p>可以安装yasm，或者按照提示执行./configure –disable-x86asm，由于yasm暂时用不上，那么就执行./configure –disable-x86asm来解决，但是这里我们编译ffmpeg是通过shell脚本，所以只能去改脚本。</p>
<p>我们打开compile-ffmpeg.sh这个脚本发现它其实是在执行tools/do-compile-ffmpeg.sh这个脚本，再打开do-compile-ffmpeg.sh，搜索是否有<code>./configure</code>这个命令，果然在305行，我们找到了相关代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure $FF_CFG_FLAGS \</div><div class="line">       --extra-cflags="$FF_CFLAGS $FF_EXTRA_CFLAGS" \</div><div class="line">       --extra-ldflags="$FF_DEP_LIBS $FF_EXTRA_LDFLAGS"</div></pre></td></tr></table></figure>
<p>这里关注一下FF_CFG_FLAGS这个变量，我们可以在它后面追加<code>--disable-x86asm</code>这个参数命令</p>
<p>修改FF_CFG_FLAGS变量应该在调用<code>./configure</code>命令之前，所以我们添加一句代码在294行：</p>
<p><code>FF_CFG_FLAGS=&quot;$FF_CFG_FLAGS --disable-x86asm&quot;</code>，先清除之前编译的文件<code>./compile-ffmpeg.sh clean</code>，再编译一次<code>./compile-ffmpeg.sh all</code>这个错误就解决了。</p>
</li>
<li><p>切换目录，编译ijkplayer的jni源码</p>
<p><code>cd ..</code></p>
<p><code>./compile-ijk.sh all</code></p>
<p>编译完成，so文件一般保留arm-v7a的就可以了，路径是<code>/ijkplayer/android/ijkplayer/ijkplayer-armv7a/src/main/libs/armeabi-v7a</code>比较module-default.sh和module-lite.sh编译出来的so文件，前面一个明显大一些。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/04/RaspberryStart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/04/RaspberryStart/" itemprop="url">树莓派折腾记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-04T23:54:18+08:00">
                2019-02-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/04/RaspberryStart/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/02/04/RaspberryStart/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/02/04/RaspberryStart/" class="leancloud_visitors" data-flag-title="树莓派折腾记录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>放假前在公司看到有同事在玩树莓派，觉得挺有意思，之前也曾经了解过，但是一直都没有下定决定买一个玩玩，这次也算是被同事拉下水吧，趁着这次放假的机会，在淘宝上买了个最新的树莓派3B+ 来学习一下，从小白开始树莓派的折腾之旅。想到自己有linux的基础应该上手不会太难，没想到还是踩了不少的坑，在购买的时候淘宝店家说会有技术支持，结果放假了完全不回消息😔，不过遇到的问题还是自己慢慢踩坑爬出来了，在这里做个简单的记录。</p>
<hr>
<h1 id="折腾树莓派的准备工作"><a href="#折腾树莓派的准备工作" class="headerlink" title="折腾树莓派的准备工作"></a>折腾树莓派的准备工作</h1><h2 id="贴散热贴"><a href="#贴散热贴" class="headerlink" title="贴散热贴"></a>贴散热贴</h2><p>拿到树莓派的主板后，先贴好散热贴，总共3个散热贴，有2个带脚的散热贴和1个不带脚并有树莓标志的散热贴，主要是3个地方，CPU，GPU和内存，其中CPU和GPU在主板的正面，贴两个带脚的散热片，正中有两个近似于正方形的方块，大的是CPU，小的是GPU，而内存在主板的背面，贴不带脚并有树莓标志的散热贴。</p>
<h2 id="连接风扇"><a href="#连接风扇" class="headerlink" title="连接风扇"></a>连接风扇</h2><p>树莓派的风扇主要有2根连接线，红色和黑色，红色接4针脚，黑色接6针脚，对应树莓派上的两列针脚区域，第二列的第二和第三个针脚。如果树莓派通电，接入后风扇就可以马上转起来。</p>
<h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><p>将SD卡插入读卡器，用系统烧录工具，Mac为balenaEtcher，下载好官网的debian系统的zip文件，然后烧录到SD卡中。然后把SD卡插入树莓派的SD卡槽，将树莓派接上电源，这时红色灯光常量，代表电源接通正常。树莓派读取SD卡，自动启动系统，系统启动好后绿色灯光闪烁，代表系统已经启动完毕。</p>
<h2 id="接入局域网"><a href="#接入局域网" class="headerlink" title="接入局域网"></a>接入局域网</h2><p>由于mac无法插入网线直接访问树莓派，可以把树莓派的网线插入到路由器上，我们可以直接在路由器的设备管理界面看到树莓派的IP地址，接下来就可以用命令行工具ssh或者图形化界面vnc远程访问到我们的树莓派。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>作为小白，在前期的准备工作也遇到了坑😔，由于系统下错了，下成了虚拟机的树莓派镜像文件（这是个ISO文件）无语的是balenaEtcher烧录系统到SD卡的时候也没有任何报错，导致SD卡插入到SD卡槽后无法正常启动系统（然而我当时并不知道），所以接入到局域网中发现路由器的设备管理界面根本没有看到树莓派这个设备。后面看到树莓派指示灯相关的内容后，才明白原来系统都没跑起来。如果你发现插入SD卡只有红色灯亮，不是没有读到SD卡，就是系统启动失败，同样关机时执行关机命令后，等到绿色灯熄灭才是系统正常关闭，再拔掉电源。下面对常用的树莓派指示灯含义做一个总结：</p>
<ol>
<li>绿色灯闪烁，读取到了SD卡并且也正常启动了系统</li>
<li>红色灯常亮，电源接入正常</li>
<li>橙色灯亮全双工状态，不亮半双工状态</li>
</ol>
<h1 id="shadowsocks配置"><a href="#shadowsocks配置" class="headerlink" title="shadowsocks配置"></a>shadowsocks配置</h1><ol>
<li>安装python的依赖库<br><code>sudo apt-get install python-pip python-gevent python-m2crypto</code></li>
<li>利用python安装shadowsocks，注意别忘记sudo，否则可能造成安装路径有问题而无法使用sslocal的命令<br><code>sudo pip install shadowsocks</code> </li>
<li>修改/usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py，将此文件中的52行和111行中的cleanup替换为reset，否则可能执行启动命令报错</li>
<li><p>创建shadowsocks的配置文件ss_conf.json，需根据shadowsocks服务器的信息替换，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"server"</span>:<span class="string">"server_ip"</span>,</div><div class="line"><span class="attr">"server_port"</span>:server_port,</div><div class="line"><span class="attr">"local_address"</span>:<span class="string">"127.0.0.1"</span>,</div><div class="line"><span class="attr">"local_port"</span>:<span class="number">1080</span>,</div><div class="line"><span class="attr">"password"</span>:<span class="string">"password"</span>,</div><div class="line"><span class="attr">"timeout"</span>:<span class="number">600</span>,</div><div class="line"><span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>最后执行启动命令<br><code>sudo sslocal -c ./ss_conf.json -d start</code></p>
<h1 id="开机启动设置"><a href="#开机启动设置" class="headerlink" title="开机启动设置"></a>开机启动设置</h1><p>这个步骤估计是我爬坑时间最长的地方，写入命令到rc.local配置文件中即可实现开机启动的功能，然而到树莓派上始终无法实现。<br><code>sudo systemctl status rc-local</code>可以查看开机启动失败的原因<br>原因在于debian系统中rc.local默认执行的是dash脚本，与bash存在差异导致无法运行。<br><code>ls -l /bin/sh</code>查看当前系统运行的脚本类型。<br><code>sudo dpkg-reconfigure dash</code>选择NO，不使用Dash Shell。<br><code>chmod +x /etc/rc.local</code> 添加执行权限</p>
<h1 id="折腾摄像头"><a href="#折腾摄像头" class="headerlink" title="折腾摄像头"></a>折腾摄像头</h1><p>我在购买树莓派主板的时候，也购买了官方的摄像头，它是usb接口，插入树莓派的usb接口后，输入命令：<code>ls /dev</code>如果此时能识别到video0的设备时，代表树莓派已识别。<br>此时我们使用<code>lsusb</code>命令同样可以查看这个设备的idVendor和idProduct</p>
<h2 id="拍摄照片"><a href="#拍摄照片" class="headerlink" title="拍摄照片"></a>拍摄照片</h2><p>拍摄一张照片<br><code>sudo fswebcam image.jpg</code><br>预览<br><code>gpicview image.jpg</code></p>
<h2 id="搭建视频流服务器"><a href="#搭建视频流服务器" class="headerlink" title="搭建视频流服务器"></a>搭建视频流服务器</h2><h3 id="安装依赖库和编译库"><a href="#安装依赖库和编译库" class="headerlink" title="安装依赖库和编译库"></a>安装依赖库和编译库</h3><p><code>sudo apt install libjpeg8-dev</code><br><code>sudo apt install imagemagic</code><br><code>sudo apt install libv4l-dev</code><br><code>sudo apt install cmake</code></p>
<h3 id="安装mjpg-streamer"><a href="#安装mjpg-streamer" class="headerlink" title="安装mjpg-streamer"></a>安装mjpg-streamer</h3><p>克隆项目到本地并编译<br><code>sudo git clone https://github.com/jacksonliam/mjpg-streamer.git</code><br><code>cd mjpg-streamer/mjpg-streamer-experimental</code><br><code>make all</code><br><code>sudo make install</code><br>启动流服务器<br><code>./mjpg_streamer -i &quot;./input_uvc.so&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>此时报错，树莓派官方的摄像头不支持v4l的驱动，需安装UV4L兼容驱动，解决方法是<br>添加软件源<br><code>curl https://www.linux-projects.org/listing/uv4l_repo/lrkey.asc | sudo apt-key add -</code><br>修改apt-get的源列表文件<code>/etc/apt/sources.list</code>，在文件末尾添加<br><code>deb https://www.linux-projects.org/listing/uv4l_repo/raspbian/ wheezy main</code><br>再安装兼容驱动<br><code>sudo rpi-update</code><br><code>sudo apt-get update</code><br><code>sudo apt-get install uv4l uv4l-raspicam</code><br><code>sudo service uv4l_raspicam restart</code><br><code>sudo pkill uv4l</code><br><code>sudo apt-get update</code><br><code>sudo apt install uv4l-uvc</code><br><code>sudo apt install uv4l-xscreen</code><br><code>sudo apt install uv4l-mjpegstream</code><br>启动流服务器<br><code>./mjpg_streamer -i &quot;./input_uvc.so&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>发现仍然报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Unable to set format: 1196444237 res: 640x480</div><div class="line">Init v4L2 failed !! exit fatal</div></pre></td></tr></table></figure>
</li>
</ol>
<p>mjpg-stream支持JPEG和YUV两种格式，默认采用JPEG，这里是因为树莓派官方的摄像头不支持JPEG<br>解决方案1:<br><code>cd mjpg-streamer-experimental/plugins/input_uvc/</code><br><code>sudo vi input_uvc.c</code><br>将<code>format = V4L2_PIX_FMT_MJPEG</code>改为<code>format = V4L2_PIX_FMT_YUYV</code><br>解决方案2:<br>用命令参数-y使用YUV编码<br><code>./mjpg_streamer -i &quot;./input_uvc.so -y&quot; -o &quot;./output_http.so -w ./www&quot;</code><br>此时看到启动信息已经启动，但是有一堆error<br>用命令参数-n来消除error<br><code>./mjpg_streamer -i &quot;./input_uvc.so -y -n&quot; -o &quot;./output_http.so -w ./www&quot;</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/27/ScrollPage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/27/ScrollPage/" itemprop="url">window.scrollTo失效了怎么办？使用puppeteer实现屏幕滑动效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-27T14:56:38+08:00">
                2019-01-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/27/ScrollPage/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/01/27/ScrollPage/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/01/27/ScrollPage/" class="leancloud_visitors" data-flag-title="window.scrollTo失效了怎么办？使用puppeteer实现屏幕滑动效果">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>又是很久没有写博客了，最近在搞漫画爬虫项目时发现某些网站把window.scrollTo方法都屏蔽了，由于大多数漫画网站都是在网页滚动时动态加载，所以如果无法实现网页滚动是没办法爬取到所有漫画的，幸好还好有google爸爸维护的puppeteer爬虫框架，这个强大的框架当然是无视这些方法屏蔽的，它可以实现鼠标按下，滑动，弹起等一系列自动化操作，那么利用这些方法我们就可以实现网页滑动了，在此，针对原生滑动方法都被屏蔽的情况下，利用puppeteer实现网页滑动做一个记录。如果有更好的方法的小伙伴欢迎一起交流讨论。</p>
<hr>
<p>前几天我维护代码的时候，突然发现爬虫代码报错了😂</p>
<p>打开该网站的控制台调试，输入<code>window.scrollTo(0, 800);</code></p>
<p>控制台输出结果为：<code>Uncaught TypeError: window.scrollTo is not a function</code></p>
<p>然后再打印一下window这个实例：<code>console.log(window)</code></p>
<p>可以看到<code>scrollTo: null</code></p>
<p>估计是网站为了反爬取而采用的措施，直接把window.scrollTo等原生方法赋值为空。</p>
<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><h2 id="获取浏览器页面实例"><a href="#获取浏览器页面实例" class="headerlink" title="获取浏览器页面实例"></a>获取浏览器页面实例</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">headless</span>: <span class="literal">true</span> &#125;)</div><div class="line"><span class="keyword">let</span> page =<span class="keyword">await</span> browser.newPage()</div></pre></td></tr></table></figure>
<h2 id="模拟PC的尺寸和UA"><a href="#模拟PC的尺寸和UA" class="headerlink" title="模拟PC的尺寸和UA"></a>模拟PC的尺寸和UA</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 模拟pc设备mac</div><div class="line"> */</div><div class="line">exports.viewPort = &#123;</div><div class="line">    <span class="attr">width</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">height</span>: <span class="number">1920</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> userAgent = <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* 设置屏幕尺寸和UA</div><div class="line">*/</div><div class="line"><span class="keyword">await</span> page.setViewport(viewPort);</div><div class="line"><span class="keyword">await</span> page.setUserAgent(userAgent);</div></pre></td></tr></table></figure>
<h1 id="实现网页滑动"><a href="#实现网页滑动" class="headerlink" title="实现网页滑动"></a>实现网页滑动</h1><h2 id="利用鼠标动作组合"><a href="#利用鼠标动作组合" class="headerlink" title="利用鼠标动作组合"></a>利用鼠标动作组合</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">exports.scrollPage = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</div><div class="line">    <span class="keyword">await</span> page.mouse.move(Spider.viewPort.width/<span class="number">2</span>, Spider.viewPort.height * <span class="number">0.9</span>, &#123;<span class="attr">steps</span>: <span class="number">10</span>&#125;)</div><div class="line">    <span class="keyword">await</span> page.mouse.down(Spider.viewPort.width/<span class="number">2</span>, Spider.viewPort.height * <span class="number">0.9</span>)</div><div class="line">    <span class="keyword">if</span> (Spider.viewPort.height * <span class="number">0.9</span> - distance &gt; Spider.viewPort.height * <span class="number">0.05</span>)&#123;</div><div class="line">        <span class="keyword">await</span> page.mouse.move(Spider.viewPort.width/<span class="number">2</span>, Spider.viewPort.height * <span class="number">0.9</span> - distance, &#123;<span class="attr">steps</span>: <span class="number">10</span>&#125;)</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">await</span> page.mouse.move(Spider.viewPort.width/<span class="number">2</span>, Spider.viewPort.height * <span class="number">0.05</span>, &#123;<span class="attr">steps</span>: <span class="number">10</span>&#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">await</span> page.mouse.up()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>distance是y轴滑动的垂直距离，根据屏幕尺寸计算出鼠标滑动到的组合操作的起始位置x和y的坐标点，然后模拟鼠标按下操作。因为我们需要爬取的网页，屏幕高度的5%是顶部固定的导航栏，所以结束位置的y轴坐标应该大于屏幕高度的5%。由于我们的网页滑动操作普遍是鼠标由下往上滑动，所以我们需要判断一下动作当前的起始位置的y轴坐标减去滑动的垂直距离后的y轴坐标值是否大于屏幕高度的5%，如果是，结束位置的y轴坐标为鼠标按下操作的y轴坐标减去滑动的垂直距离，否则结束位置的y轴坐标即为屏幕高度的5%。将window.scrollTo方法替换为我们自定义的scrollPage方法，传入滑动的垂直距离即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/Jenkins-Build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/Jenkins-Build/" itemprop="url">搭建Jenkins自动化构建环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-13T22:20:20+08:00">
                2019-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Util/" itemprop="url" rel="index">
                    <span itemprop="name">Util</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/13/Jenkins-Build/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/01/13/Jenkins-Build/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/01/13/Jenkins-Build/" class="leancloud_visitors" data-flag-title="搭建Jenkins自动化构建环境">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>最近公司想搭建自动化构建平台，由于以前自己在空闲时间折腾过jenkins搭建相关的东西，领导就把这个任务交给了我，虽然以前在自己的电脑上搭建过，由于时间过去太久了，当时又没做记录，搭建的时候还是踩了不少坑，不过在google爸爸的帮助下，翻阅各种资料，最后都爬坑解决，所以这里对再此搭建做一个记录，避免以后遗忘。</p>
<hr>
<h1 id="连接远程服务器"><a href="#连接远程服务器" class="headerlink" title="连接远程服务器"></a>连接远程服务器</h1><ol>
<li>ssh -p 端口号 服务器用户名@ip</li>
<li>输入密码<h1 id="安装jenkins相关依赖包"><a href="#安装jenkins相关依赖包" class="headerlink" title="安装jenkins相关依赖包"></a>安装jenkins相关依赖包</h1><h2 id="安装java"><a href="#安装java" class="headerlink" title="安装java"></a>安装java</h2></li>
</ol>
<ul>
<li><code>java -version</code></li>
<li>如果没有显示版本号则需要安装，安装命令<code>sudo yum install java</code><h2 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h2></li>
<li>添加安装源<br><code>sudo wget -O /etc/yum.repos.d/jenkins.repo http://jenkins-ci.org/redhat/jenkins.repo</code><br><code>sudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key</code></li>
<li>安装<br><code>yum install jenkins</code><h3 id="jenkins安装目录"><a href="#jenkins安装目录" class="headerlink" title="jenkins安装目录"></a>jenkins安装目录</h3><code>/var/lib/jenkins/</code><h3 id="jenkins配置文件目录"><a href="#jenkins配置文件目录" class="headerlink" title="jenkins配置文件目录"></a>jenkins配置文件目录</h3><code>/etc/sysconfig/jenkins</code></li>
<li>主要参数：</li>
<li>JENKINS_HOME:Jenkins的主目录，Jenkins工作目录,储存文件的地址,Jenkins的插件,生成的文件都在这个目录下</li>
<li>JENKINS_USER:Jenkins的用户，拥有$JENKINS_HOME和/var/log/jenkins的权限</li>
<li>JENKINS_PORT:Jenkins的端口，默认端口是8080<h2 id="启动jenkins服务"><a href="#启动jenkins服务" class="headerlink" title="启动jenkins服务"></a>启动jenkins服务</h2><code>sudo service jenkins start</code></li>
<li>此时在浏览器中输入：http://&lt;服务器ip&gt;:8080/ 就可以进入Jenkins界面，8080是默认端口号<h2 id="停止jenkins服务"><a href="#停止jenkins服务" class="headerlink" title="停止jenkins服务"></a>停止jenkins服务</h2><code>sudo service jenkins stop</code><h1 id="创建项目并配置"><a href="#创建项目并配置" class="headerlink" title="创建项目并配置"></a>创建项目并配置</h1><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylbbjevj9j31fa0mwwhn.jpg" alt=""></li>
</ul>
<ol>
<li>选择New任务，新建一个项目<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylbq5m1vej31ev0qc43p.jpg" alt=""></li>
<li>输入一个项目名称</li>
<li>选择构建一个自由风格的软件项目，点击左下角的ok<br><img src="https://ww1.sinaimg.cn/large/006LWy2zgy1fylbswx4j0j316r0n076c.jpg" alt=""></li>
<li>输入项目的文字描述<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fyld7gm55jj30xx09f751.jpg" alt=""></li>
<li>勾选丢弃旧的构建，设置保留的构建天数和保留的最大构建数<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fyldeclw5pj30yg0fhdi3.jpg" alt=""><br>6.勾选参数化构建过程，添加不同类型的参数<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fyle0kgb04j30qk09st98.jpg" alt=""></li>
</ol>
<ul>
<li>布尔值参数<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fyle6utuc8j30rc0cgdg8.jpg" alt=""></li>
<li>文本参数<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fz5bbqc12yj31g40om14f.jpg" alt=""><br><img src="https://ww1.sinaimg.cn/large/006LWy2zgy1fyle1gna1kj30q30caaaw.jpg" alt=""></li>
<li>选项参数<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fyle4hao7oj30pz0b0q3i.jpg" alt=""></li>
<li>git Parameter<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fyle3q6ydhj30q50fydgg.jpg" alt=""></li>
<li>dynamic Parameter<br>打包前，要配置这些参数，配置界面展示效果如下：<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fz5b4jiontj31al0u0tsk.jpg" alt=""><br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fz5b2jvit9j31vm0tu7n3.jpg" alt=""><br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fz5b9rum2oj31v80egjyz.jpg" alt=""></li>
</ul>
<ol>
<li>Source Code Management配置git远程代码仓库</li>
</ol>
<ul>
<li>复制项目地址并填入Repository URL</li>
<li>Credentials，点击add，选择jenkins账户（jenkins统一用这个），该账户需加入项目，拥有代码拉取权限</li>
<li>配置成功后不会有红字错误提示</li>
<li>有的项目克隆比较慢，可能会有克隆超时导致构建失败的问题，可以把这个超时时间改大一点，需要添加一个配置<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fz5bfpllo7j31fx0u017x.jpg" alt=""></li>
<li>Additional Behaviours点击Add<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylhl1bp5oj30os0lo77e.jpg" alt=""></li>
<li>选择Advanced clone behaviours<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylhm54mjyj30x40cgq3t.jpg" alt=""></li>
<li>修改Timeout (in minutes) for clone and fetch operations的值，改大一点60</li>
</ul>
<ol>
<li>Build Triggers配置轮询构建和定时构建<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylczte35hj30y906xq3a.jpg" alt=""><br>定时构建： 无论git中有无提交，均执行定时化的构建任务<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fyld1v9z9pj30y406sjrq.jpg" alt=""><br>轮询构建： 查看git中是否有提交，如果有，则执行构建任务<br>每隔5分钟构建一次<br><code>H/5 * * * *</code><br>每两小时构建一次<br><code>H H/2 * * *</code><br>每天中午下班前定时构建一次<br><code>0 12 * * *</code><br>每天下午下班前定时构建一次<br><code>0 18 * * *</code></li>
<li>Build Environment设置构建名称<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylelvfn79j30y503vglr.jpg" alt=""></li>
</ol>
<ul>
<li>勾选Set Build Name，这里填写的参数对应上面设置的参数，保持名称一致<br>打包后展示的效果如下：<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fyleg0e2cwj30co0i8myu.jpg" alt=""></li>
</ul>
<ol>
<li>Build构建方式（Android以gradle为例）<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fyleoramsuj30ek0bfwex.jpg" alt=""></li>
</ol>
<ul>
<li>点击add build step，选择Invoke Gradle script<br>勾选Invoke Gradle，选择Gradle Version为gradle4.6<br><img src="https://ww1.sinaimg.cn/large/006LWy2zgy1fyletf9rdbj30y40c2aao.jpg" alt=""></li>
<li>填写task，配置gradle打包命令<code>clean assemble${BUILD_TYPE} --stacktrace</code>，这里的BUILD_TYPE引用前面配置的</li>
<li>点击Advanced选项，勾选Pass all job parameters as Project properties，将上面的配置参数全部传入gradle.properties配置文件中，实现参数化打包<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fylfq19zwfj30wr0ji3zl.jpg" alt=""></li>
</ul>
<ol>
<li>Post-build Actions</li>
</ol>
<ul>
<li>点击add Post-build Actions，选择归档成品，提取打包后的apk文件<br><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fylezsvjylj30cj0b9aar.jpg" alt=""></li>
<li>Files to archive填入过滤规则<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fylf2ur67hj30yb0853yw.jpg" alt=""></li>
<li>在所有文件中过滤apk文件</li>
<li>点击add Post-build Actions，配置打包后的邮箱通知<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fylf58asykj30cr0bpmxv.jpg" alt=""><br>一般情况下使用默认配置就可以，直接引用全局配置中已经配置过的参数。<br><img src="https://ww1.sinaimg.cn/large/006LWy2zgy1fz5b5jxygej31te0940vr.jpg" alt=""><br>如果要修改接收人邮箱，编辑Project Recipient List，多个邮箱地址，空格隔开<br>如果要修改发送邮件的内容，可编辑以下几项</li>
<li>Content Type 文本类型，可配置html、纯文本、纯文本和html</li>
<li>Default Subject 邮件标题</li>
<li>Default Content 邮件内容<br>打包日志压缩并添加附件，Attach Build Log选择Compress and Attach Build Log<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylfn7t6jcj30vi0ic3zs.jpg" alt=""><br>邮件发送触发器配置，点击Advanced选项，编辑Triggers选项，点击Add Trigger，可以选择触发器类型，不管构建成功失败总是触发（默认），成功时触发，失败时触发</li>
<li>此时项目配置完毕<h1 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h1><img src="https://ww4.sinaimg.cn/large/006LWy2zgy1fylg0gxdazj31fg0gc0vm.jpg" alt=""></li>
</ul>
<ol>
<li>选择要打包的项目<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fylfvilxs2j31fg0mltba.jpg" alt=""></li>
<li>点击Build with Parameters，进入打包前的参数配置流程<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fz5b89vbakj31eh0u0tv5.jpg" alt=""></li>
<li>配置好打包的参数，点击build开始打包<br><img src="https://ww3.sinaimg.cn/large/006LWy2zgy1fylhe643yxj30d206pmxf.jpg" alt=""></li>
<li>点击打包进程可查看相关信息<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fylh9s1hnmj30a909zt97.jpg" alt=""></li>
<li>点击Console Output可查看打包日志<br><img src="https://ww2.sinaimg.cn/large/006LWy2zgy1fz5b1ybg63j310n0u01kx.jpg" alt=""></li>
<li>如果配置了邮件通知，打包完成后邮箱会收到一封邮件</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/18/SocketioRn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/18/SocketioRn/" itemprop="url">socket.io+nodejs+mongodb+reactnative 实现简易聊天室</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-18T19:22:41+08:00">
                2018-11-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/18/SocketioRn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/11/18/SocketioRn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/18/SocketioRn/" class="leancloud_visitors" data-flag-title="socket.io+nodejs+mongodb+reactnative 实现简易聊天室">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>最近公司非常忙，又是很长一段时间没有写博客了，虽然公司的项目使用不到ReactNative和nodejs相关的知识，但我仍然看好跨平台技术，毕竟以后是大前端的发展趋势。所以依旧不能停下学习的脚步，多做技术储备，提升核心竞争力，继续挖全栈的坑，拓展自己的技术栈。毕竟有的时候站在一个不同的角度，可能有不同的看法。之前做了一个获取网易腾讯免费漫画的app，后台用nodejs+mongodb+koa搭建，在展示漫画弹幕的时候，需要用到长链接实时展示当前最新的弹幕内容。之前对socket.io在react-native上的使用不太了解，借此机会学习一下相关的知识并做一个总结和记录。</p>
<hr>
<p>效果如下：<br><img src="/images/socketio_rn.gif" alt="效果gif"></p>
<h1 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h1><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install socket.io</div><div class="line">npm install mongoose</div></pre></td></tr></table></figure>
<h2 id="引入socket-io对象"><a href="#引入socket-io对象" class="headerlink" title="引入socket.io对象"></a>引入socket.io对象</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Socketio = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)</div></pre></td></tr></table></figure>
<h2 id="引入mongoose对象"><a href="#引入mongoose对象" class="headerlink" title="引入mongoose对象"></a>引入mongoose对象</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div></pre></td></tr></table></figure>
<h2 id="创建和引入mongoose的数据库表对象"><a href="#创建和引入mongoose的数据库表对象" class="headerlink" title="创建和引入mongoose的数据库表对象"></a>创建和引入mongoose的数据库表对象</h2><ul>
<li><p>创建users表</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"><span class="keyword">var</span> UsersSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</div><div class="line">    <span class="attr">name</span>: <span class="built_in">String</span>,</div><div class="line">    <span class="attr">createdAt</span>: &#123;</div><div class="line">        <span class="attr">type</span>: <span class="built_in">Date</span>,</div><div class="line">        <span class="attr">default</span>: <span class="built_in">Date</span>.now()</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">updateAt</span>: &#123;</div><div class="line">        <span class="attr">type</span>: <span class="built_in">Date</span>,</div><div class="line">        <span class="attr">default</span>: <span class="built_in">Date</span>.now()</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line">UsersSchema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">next</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isNew) &#123; <span class="comment">// 如果这是个新的数据</span></div><div class="line">        <span class="keyword">this</span>.createdAt = <span class="keyword">this</span>.updateAt = <span class="built_in">Date</span>.now() <span class="comment">// 设置当前时间</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">this</span>.updateAt = <span class="built_in">Date</span>.now() <span class="comment">// 否则刷新更新时间</span></div><div class="line">    &#125;</div><div class="line">    next()</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.export = mongoose.model(<span class="string">'users'</span>, UsersSchema)</div></pre></td></tr></table></figure>
</li>
<li><p>创建messages表</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> MessagesSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</div><div class="line">    <span class="attr">text</span>: <span class="built_in">String</span>,</div><div class="line">    <span class="attr">user</span>: <span class="built_in">Object</span>,</div><div class="line">    <span class="attr">chatId</span>: <span class="built_in">String</span>,</div><div class="line">    <span class="attr">createdAt</span>:&#123;</div><div class="line">        <span class="attr">type</span>:<span class="built_in">Date</span>,</div><div class="line">        <span class="attr">default</span>:<span class="built_in">Date</span>.now()</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">updateAt</span>:&#123;</div><div class="line">        <span class="attr">type</span>:<span class="built_in">Date</span>,</div><div class="line">        <span class="attr">default</span>:<span class="built_in">Date</span>.now()</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line">MessagesSchema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.isNew)&#123; <span class="comment">// 如果这是个新的数据</span></div><div class="line">        <span class="keyword">this</span>.createAt = <span class="keyword">this</span>.updateAt = <span class="built_in">Date</span>.now() <span class="comment">// 设置当前时间</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">this</span>.updateAt = <span class="built_in">Date</span>.now() <span class="comment">// 否则刷新更新时间</span></div><div class="line">    &#125;</div><div class="line">    next()</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">var</span> MessageModel = mongoose.model(<span class="string">'messages'</span>, MessagesSchema)</div><div class="line"><span class="built_in">module</span>.export = MessageModel</div></pre></td></tr></table></figure>
</li>
<li><p>引入表对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Users = mongoose.model(<span class="string">'users'</span>)</div><div class="line"><span class="keyword">var</span> Messages = mongoose.model(<span class="string">'messages'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>初始化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> users = &#123;&#125;; <span class="comment">// 客户端用户id和socket id映射表</span></div><div class="line"><span class="keyword">var</span> chatId = <span class="number">1</span>; <span class="comment">// 聊天室id</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用socket-io通信"><a href="#使用socket-io通信" class="headerlink" title="使用socket.io通信"></a>使用socket.io通信</h2><ul>
<li><p>监听connection消息，与客户端建立连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> websocket = Socketio(server)</div><div class="line">websocket.on(<span class="string">'connection'</span>,(socket) =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'连上了'</span>)</div><div class="line">    socket.on(<span class="string">'userJoined'</span>, (userId) =&gt; onUserJoined(userId, socket));</div><div class="line">    socket.on(<span class="string">'message'</span>, (message) =&gt; onMessageReceived(message, socket));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>监听userJoined消息，用户进入聊天室触发，客户端向服务端发送userJoined消息，第一次进入的用户，客户端发送的用户id为空，服务端在回调中获得用户id和客户端的socket对象，如果用户id为空，插入数据库，取得用户id，并向客户端发送用户id，客户端将这个用户id保存下来，下一次发送这个id。服务端刷新用户数组中该客户端对应的用户id，如果用户id不为空直接执行这一步，最后发送数据库中保存的该聊天室发送过的消息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">onUserJoined</span>(<span class="params">userId, socket</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'有用户进来了'</span> + userId)</div><div class="line">    <span class="comment">// 新用户userId为空，向数据库users表插入id</span></div><div class="line">    <span class="keyword">if</span> (!userId) &#123;</div><div class="line">        <span class="keyword">var</span> userData = <span class="keyword">new</span> Users(&#123;&#125;)</div><div class="line">        <span class="keyword">let</span> user = <span class="keyword">await</span> userData.save()</div><div class="line">        socket.emit(<span class="string">'userJoined'</span>, user._id);</div><div class="line">        users[socket.id] = user._id;</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//否则刷新用户id</span></div><div class="line">        users[socket.id] = userId;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 发送之前的消息</span></div><div class="line">    <span class="keyword">await</span> sendExistingMessages(socket);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 发送之前的消息</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">sendExistingMessages</span>(<span class="params">socket</span>) </span>&#123;</div><div class="line">    <span class="comment">// 查数据</span></div><div class="line">    <span class="keyword">await</span> Messages.find(&#123;</div><div class="line">        <span class="attr">chatId</span>: chatId</div><div class="line">    &#125;).sort(&#123;<span class="attr">createdAt</span>:<span class="number">1</span>&#125;).exec(<span class="function">(<span class="params">err, messages</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">//　如果没有任何消息，直接返回</span></div><div class="line">        <span class="keyword">if</span> (!messages.length)&#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        socket.emit(<span class="string">'message'</span>, messages.reverse());</div><div class="line">    &#125;)</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>监听message消息，在接收到客户端发送的消息时触发，服务端在回调中获得消息和发送的socket对象，从用户数组中取得该socket对象对应的客户端的用户id，用户id为空时可能因服务端重启造成用户数组的数据丢失，直接返回不处理，最后保存这条消息到数据库，发送这条消息给除了当前客户端用户的所有用户</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 用户接收到消息</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessageReceived</span>(<span class="params">message, socket</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(message.text)</div><div class="line">    <span class="keyword">var</span> userId = users[socket.id];</div><div class="line">    <span class="comment">// 用户id为空返回</span></div><div class="line">    <span class="keyword">if</span> (!userId) &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'没有这个用户啦'</span>)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">　　 <span class="comment">// 保存消息并发送</span></div><div class="line">    <span class="keyword">await</span> sendAndSaveMessage(message, socket);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 保存消息到数据，发送消息给除了当前用户的所有的用户</span></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">sendAndSaveMessage</span>(<span class="params">message, socket</span>) </span>&#123;</div><div class="line">    <span class="comment">//　创建消息数据</span></div><div class="line">    <span class="keyword">var</span> messageData = <span class="keyword">new</span> Messages(&#123;</div><div class="line">        <span class="attr">text</span>: message.text,</div><div class="line">        <span class="attr">user</span>: message.user,</div><div class="line">        <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(message.createdAt),</div><div class="line">        <span class="attr">chatId</span>: chatId</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">var</span> message = <span class="keyword">await</span> messageData.save()</div><div class="line">    <span class="comment">// 发送消息给除了当前用户的所有的用户</span></div><div class="line">    socket.broadcast.emit(<span class="string">'message'</span>, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="koa中集成socket-io"><a href="#koa中集成socket-io" class="headerlink" title="koa中集成socket.io"></a>koa中集成socket.io</h2><p>如果服务端已经集成了koa需要再集成socket.io<br>传入koa的server对象，外面包一层Socketio对象导出，再注册监听端口<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">server</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> websocket = Socketio(server)</div><div class="line">    websocket.on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</div><div class="line">        clients[socket.id] = socket;<span class="comment">//保存客户端对象到列表</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'连上了'</span>)</div><div class="line">        socket.on(<span class="string">'userJoined'</span>, (userId) =&gt; onUserJoined(userId, socket));</div><div class="line">        socket.on(<span class="string">'message'</span>, (message) =&gt; onMessageReceived(message, socket));</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">// xxx为socketio的module路径</span></div><div class="line">server.listen(<span class="number">1234</span>)</div><div class="line"><span class="built_in">require</span>(<span class="string">'xxx'</span>)(server)</div></pre></td></tr></table></figure></p>
<h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>这里以react-native举例</p>
<h2 id="引入socket-io"><a href="#引入socket-io" class="headerlink" title="引入socket.io"></a>引入socket.io</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> SocketIOClient <span class="keyword">from</span> <span class="string">'socket.io-client'</span>;</div></pre></td></tr></table></figure>
<h2 id="初始化socket-io"><a href="#初始化socket-io" class="headerlink" title="初始化socket.io"></a>初始化socket.io</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.socket = SocketIOClient(<span class="string">'http://localhost:3000'</span>); <span class="comment">// 设置服务端的地址和端口号</span></div></pre></td></tr></table></figure>
<h2 id="使用socket-io通信-1"><a href="#使用socket-io通信-1" class="headerlink" title="使用socket.io通信"></a>使用socket.io通信</h2><p>第一次进入时发送空的用户id给服务端，监听userJoined消息，保存服务端给的用户id，第二次发送本地保存的用户id给服务端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">AsyncStorage.getItem(USER_ID)</div><div class="line">      .then(<span class="function">(<span class="params">userId</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">// 本地没有用户id</span></div><div class="line">        <span class="keyword">if</span> (!userId) &#123;</div><div class="line">          <span class="comment">// 发送空的用户id</span></div><div class="line">          <span class="keyword">this</span>.socket.emit(<span class="string">'userJoined'</span>, <span class="literal">null</span>);</div><div class="line">          <span class="comment">// 监听userJoined消息，保存服务端给的用户id</span></div><div class="line">          <span class="keyword">this</span>.socket.on(<span class="string">'userJoined'</span>, (userId) =&gt; &#123;</div><div class="line">            AsyncStorage.setItem(USER_ID, userId);</div><div class="line">            <span class="keyword">this</span>.setState(&#123; userId &#125;);</div><div class="line">          &#125;);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// 发送本地保存的用户id</span></div><div class="line">          <span class="keyword">this</span>.socket.emit(<span class="string">'userJoined'</span>, userId);</div><div class="line">          <span class="keyword">this</span>.setState(&#123; userId &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function">(<span class="params">e</span>) =&gt;</span> alert(e));</div></pre></td></tr></table></figure>
<p>监听服务端发送的message消息并刷新</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.socket.on(<span class="string">'message'</span>, <span class="keyword">this</span>.storeMessages); <span class="comment">//监听message消息</span></div><div class="line">storeMessages(messages) &#123;</div><div class="line">    <span class="keyword">this</span>.setState(<span class="function">(<span class="params">previousState</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">messages</span>: <span class="keyword">this</span>.msgs.append(previousState.messages, messages),</div><div class="line">      &#125;;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>点击发送按钮，向服务端发送消息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">onSend(message) &#123;</div><div class="line">    <span class="keyword">this</span>.socket.emit(<span class="string">'message'</span>, message);</div><div class="line">    <span class="keyword">this</span>.storeMessages(messages);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端的ui用了一个封装的库GiftedChat来简单展示一下。demo已打包上传，最后贴一个<a href="https://github.com/jessieeeee/SocketioRn/" target="_blank" rel="external">传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/Presentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/Presentation/" itemprop="url">Presentation实现双屏异显</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T21:06:44+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/21/Presentation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/10/21/Presentation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/10/21/Presentation/" class="leancloud_visitors" data-flag-title="Presentation实现双屏异显">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>由于公司的项目需求，需要在一台搭载Android系统的显示设备的两块屏幕上显示不同的内容，该设备拥有一块主屏和一块辅屏，这里就需要使用双屏异显的技术，以前没有接触过这一块的知识，经过一段时间的熟悉后顺利实现双屏异显，其实Android实现双屏异显并不难而且Google提供了现成的API，用Presentation这个类去实现，只不过没接触过的时候觉得挺高大上的，在此做一个简单的记录。</p>
<hr>
<p>Presentation是一个特殊的dialog，可以在辅屏上显示与主屏不一样的内容，设置里面也可以把“模拟第二屏”的功能打开，运行的时候会在左上角显示一个小窗口来显示第二屏的显示内容，Presentation在创建的时候需要和Display对象相关联，关联之前需要先获取显示设备，DisplayManager或MediaRouter都可以来获取显示设备。下面用最简单的两个例子来介绍，在主屏和辅屏上都显示一个不同内容的TextView文本。</p>
<h1 id="设置权限"><a href="#设置权限" class="headerlink" title="设置权限"></a>设置权限</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.SYSTEM_ALERT_WINDOW"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.SYSTEM_OVERLAY_WINDOW"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h1 id="DisplayManager实现"><a href="#DisplayManager实现" class="headerlink" title="DisplayManager实现"></a>DisplayManager实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPresentation</span> <span class="keyword">extends</span> <span class="title">Presentation</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">MyPresentation</span><span class="params">(Context outerContext, Display display)</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>(outerContext,display);</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">           setContentView(R.layout.second_screen);</div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MyPresentation myPresentation;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        DisplayManager manager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</div><div class="line">        Display[] displays = manager.getDisplays();</div><div class="line">        <span class="keyword">if</span> (presentationDisplays.length &gt; <span class="number">1</span>) &#123;</div><div class="line">            <span class="comment">// displays[0] 主屏 displays[1] 辅屏</span></div><div class="line">            myPresentation = <span class="keyword">new</span> MyPresentation(<span class="keyword">this</span>,displays[<span class="number">1</span>]);</div><div class="line">            myPresentation.getWindow().setType(</div><div class="line">                    WindowManager.LayoutParams.TYPE_SYSTEM_ALERT);</div><div class="line">            myPresentation.show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">        onDestroy();</div><div class="line">        <span class="comment">//完全退出应用，取消双屏异显</span></div><div class="line">        Intent startMain = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</div><div class="line">        startMain.addCategory(Intent.CATEGORY_HOME);</div><div class="line">        startMain.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        startActivity(startMain);</div><div class="line">        System.exit(<span class="number">0</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里的activity_main和second_screen就是一个xml布局，放了一个不同内容的TextView文本，代码就不贴了，可以看到DisplayManager的getDisplays方法可以返回一个可显示的Display数组，也就是当前可以连接的屏幕列表，第一个元素是主屏的Display对象，第二个元素是辅屏的Display对象，然后把辅屏的Display对象传入到Presentation的构造函数中绑定，设置窗口类型就可以展示了。</p>
<h1 id="MediaRouter实现"><a href="#MediaRouter实现" class="headerlink" title="MediaRouter实现"></a>MediaRouter实现</h1><p>这里就只贴辅屏的Display对象获取并传入到Presentation的构造函数中绑定的代码，因为其余部分都是一样的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">MediaRouter mediaRouter = (MediaRouter) getSystemService(Context.MEDIA_ROUTER_SERVICE);</div><div class="line">MediaRouter.RouteInfo route = mediaRouter.getSelectedRoute(MediaRouter.ROUTE_TYPE_LIVE_VIDEO);</div><div class="line"><span class="keyword">if</span>(route != <span class="keyword">null</span>) &#123;</div><div class="line">    Display display = route.getPresentationDisplay();</div><div class="line">    <span class="keyword">if</span> (display != <span class="keyword">null</span>) &#123;</div><div class="line">        myPresentation = <span class="keyword">new</span> MyPresentation(<span class="keyword">this</span>, display);</div><div class="line">        myPresentation.getWindow().setType(</div><div class="line">                    WindowManager.LayoutParams.TYPE_SYSTEM_ALERT);</div><div class="line">        myPresentation.show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MediaRouter与DisplayManager不同的是MediaRouter会直接绑定周围最合适的设备。总的来说，这两个API实现的思路大致相同，都是要自定义Presentation，获取到一个辅屏的Display对象传入到Presentation的构造函数中进行绑定，Presentation初始化完成后设置窗口类型然后展示。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/25/PuppeteerStart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/25/PuppeteerStart/" itemprop="url">nodejs爬虫-puppeteer入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-25T14:33:58+08:00">
                2018-08-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/25/PuppeteerStart/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/08/25/PuppeteerStart/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/08/25/PuppeteerStart/" class="leancloud_visitors" data-flag-title="nodejs爬虫-puppeteer入门">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>又是很久没有写博客了，最近忙着一个开源项目，做一个免费漫画app，抓取网易和腾讯漫画的web数据，用nodejs+koa+mongoose+socket.io搭建这个app的后端服务，客户端用react-native编写，同时适配ios和Android。本人是做Android开发的，想借此机会打开全栈技术的大门，给自己的技术栈增加一些广度。对于一个app开发者来说，app的数据源总是一个很头疼的问题，虽然现在免费的api接口有很多，但是类型就那么几种，想做一些感兴趣的app但是苦于找不到数据源。之前学react-native的时候也做过一个开源项目高仿韩寒的one一个<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="external">SimpleOne传送门</a>，这个app的数据全是通过抓包工具抓取官方app的接口地址（用charles或fidder即可），分析数据获得，由于数据没有做加密，所以没有花太多的成本。但是毕竟是别人的接口，出现问题不是自己可控的。后来了解到google的一个web自动化测试框架puppeteer，解析html抓取dom节点，这下就可以通过服务端访问web，抓取数据，提供接口将抓取到的数据返回给客户端，做自己感兴趣的应用了。而且自己本来对服务端的技术也感兴趣，索性借此机会学下nodejs相关的服务端技术。下面就对puppeteer这个自动化框架爬虫做一个入门总结，接触不久，如有不对的地方欢迎指正。</p>
<hr>
<h1 id="puppeteer框架背景"><a href="#puppeteer框架背景" class="headerlink" title="puppeteer框架背景"></a>puppeteer框架背景</h1><p>puppeteer是 Google Chrome 团队官方的无界面（Headless）Chrome 工具，它是一个 Node 库， web 应用自动化测试框架，提供了一些高级的 API 来控制Chrome浏览器。你也可以在开发过程中开启浏览器，实时查看运行过程方便调试。那它可以做写什么呢？</p>
<ul>
<li>生成页面的截图和PDF。</li>
<li>抓取SPA并生成预先呈现的内容（即“SSR”）。</li>
<li>从网站抓取你需要的内容。</li>
<li>自动表单提交，UI测试，键盘输入等</li>
<li>创建一个最新的自动化测试环境。使用最新的JavaScript和浏览器功能，直接在最新版本的Chrome中运行测试。</li>
<li>捕获您的网站的时间线跟踪，以帮助诊断性能问题。</li>
</ul>
<h1 id="为什么要选择puppeteer？"><a href="#为什么要选择puppeteer？" class="headerlink" title="为什么要选择puppeteer？"></a>为什么要选择puppeteer？</h1><p>nodejs的爬虫框架有很多，要根据具体的业务进行选择，比如说cheerio一类的静态网页爬虫框架就只能爬取服务端渲染的网页，不能爬取JavaScript运行后的数据，但很多时候我们需要爬取的是动态网页，而puppeteer可以完整的模拟浏览器获取网页，访问dom，且框架的运行效率也很不错，<br>支持调用Chrome的API来操纵Web，相比较Selenium或是PhantomJs，它最大的特点就是它的操作Dom可以完全在内存中进行模拟既在V8引擎中处理而不打开浏览器，是Chrome团队在维护，拥有更好的兼容性和前景。</p>
<h1 id="puppeteer如何使用？"><a href="#puppeteer如何使用？" class="headerlink" title="puppeteer如何使用？"></a>puppeteer如何使用？</h1><h2 id="安装puppeteer"><a href="#安装puppeteer" class="headerlink" title="安装puppeteer"></a>安装puppeteer</h2><p>这里有个安装的坑，别看puppeteer的安装只有<code>npm i puppeteer</code>这么一条简单的命令，但是在国内安装起来也不是这么容易的，因为它默认会去下载Chromium作为抓取数据的客户端，国内基本下载不下来，安装会失败。即使我开着ss，仍然失败了，Orz….比如说像下面这样报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ERROR: Failed to download Chromium r515411! Set &quot;PUPPETEER_SKIP_CHROMIUM_DOWNLOA</div><div class="line">D&quot; env variable to skip download.</div></pre></td></tr></table></figure></p>
<p>我发现从最新的1.7的版本开始分离出一个轻量版的puppeteer核心库，默认不去下载Chromium。<br>当然网上也有很多教程说先忽略跳过，再去手动下载Chromium，后面可能还有一些坑要跳，个人感觉比较麻烦，这里有一个方便快捷的办法。无意中发现一个库<a href="https://github.com/valleykid/puppeteer-cn" target="_blank" rel="external">puppeteer-cn传送门</a>，和puppeteer完全一样，你完全可以用puppeteer-cn代替之。这个包会先去检测本地Chrome版本是否大于59，再决定是否通过一个国内源下载Chromium。这个库下载速度很快，直接就安装好了Chromium。</p>
<h2 id="使用puppeteer"><a href="#使用puppeteer" class="headerlink" title="使用puppeteer"></a>使用puppeteer</h2><p>这个无非是一些常规的API调用，可以查阅<a href="https://github.com/GoogleChrome/puppeteer/blob/v1.7.0/docs/api.md" target="_blank" rel="external">官方的文档</a>来实现一些自己想要的功能，这里给出一个快速上手的小例子。由于我的app是抓取免费漫画，下面就给出抓取网易免费漫画的例子</p>
<ol>
<li><p>引入puppeteer工具类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer-cn'</span>)　<span class="comment">//抓取工具类</span></div></pre></td></tr></table></figure>
</li>
<li><p>设置模拟的pc设备<br>设置浏览器的尺寸和userAgent</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 模拟pc设备mac</div><div class="line"> */</div><div class="line"><span class="keyword">const</span> viewPort = &#123;</div><div class="line">    <span class="attr">width</span>: <span class="number">1920</span>,</div><div class="line">    <span class="attr">height</span>: <span class="number">1080</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> userAgent = <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span></div><div class="line"><span class="keyword">await</span> page.setViewport(viewPort);</div><div class="line"><span class="keyword">await</span> page.setUserAgent(userAgent);</div></pre></td></tr></table></figure>
</li>
<li><p>初始化请求客户端</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 启动了一个Chrome实例</span></div><div class="line"><span class="keyword">let</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">headless</span>: <span class="literal">true</span> &#125;)</div><div class="line"><span class="comment">// 浏览器中创建一个新的页面</span></div><div class="line"><span class="keyword">await</span> browser.newPage()</div></pre></td></tr></table></figure>
</li>
</ol>
<p>headless 设置为true，则不展示Chromium的访问界面，在开发过程中，为了方便调试，最好设置成false，可以实时查看运行过程。</p>
<ol>
<li>跳转到目标网站<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> url = <span class="string">'https://manhua.163.com/category?sort=2&amp;sf=1'</span></div><div class="line"><span class="comment">// 跳转到目标网站</span></div><div class="line"><span class="keyword">await</span> page.goto(url)</div><div class="line"><span class="comment">// 等待时长</span></div><div class="line"><span class="keyword">await</span> page.waitFor(<span class="number">200</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这个地址正好是网易漫画的官方地址在漫画列表中过滤出免费漫画</p>
<ol>
<li>抓取数据，并返回</li>
</ol>
<ul>
<li>首先分析抓取到的页面数据，找出目标dom节点，<br>可以在调试的Chromium中或者在自己打开一个chrome浏览器中按下查看网页代码。<br>调出审查元素界面<br>Mac：command+option+I<br>windows/linux：ctrl+shift+I<br><img src="/images/PuppeteerStart.png" alt="图"><br>从网页代码中，我们可以找出目标数据和相关的dom节点。带有<code>comic-item</code>类选择器的div就是漫画列表的每一个数据项，其中子节点<code>cover</code>类选择器div就是数据项的图片信息部分，里面的子元素img标签的src属性就是漫画封面的图片地址。而<code>comic-info</code>类选择器的div就是数据项的文字信息部分，里面的子元素<code>.title</code>类选择器的div中包含的文字就是标题，<code>span</code>标签中包含的文字就是当前章节，<code>.muted</code>类选择器div中的文字就是点击量，漫画的跳转链接在<code>a</code>标签中的<code>href</code>属性中，得到完整的地址需要做一个拼接。<br>puppeteer是通过seletor选择器去获取元素的，了解一部分前端知识的人来说并不陌生，也没什么难度。分析完了以后，我们就可以从目标dom中提取到想要返回的数据。<br>所以最后的抓取代码如下:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> targetUrl = <span class="string">'https://manhua.163.com'</span></div><div class="line"><span class="keyword">return</span> <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">targetUrl</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> data = []</div><div class="line">    <span class="keyword">let</span> elements = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.comic-item'</span>) <span class="comment">// 获取所有漫画元素</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> element <span class="keyword">of</span> elements) &#123; <span class="comment">// 循环</span></div><div class="line">        <span class="keyword">let</span> title = element.querySelector(<span class="string">'.comic-info .title'</span>).innerText <span class="comment">// 获取标题</span></div><div class="line">        <span class="keyword">let</span> chapter = element.querySelector(<span class="string">'.comic-info span'</span>).innerText　<span class="comment">// 获取章节</span></div><div class="line">        <span class="keyword">let</span> clickNum = element.querySelector(<span class="string">'.comic-info div.muted'</span>).innerText <span class="comment">//　获取点击量</span></div><div class="line">        <span class="keyword">let</span> link = element.querySelector(<span class="string">'.comic-info a'</span>).getAttribute(<span class="string">'href'</span>)</div><div class="line">        link = targetUrl + link</div><div class="line">        <span class="keyword">let</span> cover = element.querySelector(<span class="string">'.cover img'</span>).getAttribute(<span class="string">'src'</span>)</div><div class="line">        <span class="comment">// let id = link.replace('https://manhua.163.com/source/','')</span></div><div class="line">        <span class="keyword">let</span> id = link.substring(link.lastIndexOf(<span class="string">'/'</span>)+<span class="number">1</span>,link.length)</div><div class="line">        data.push(&#123; id, title, chapter, clickNum, link, cover &#125;) <span class="comment">// 存入数组</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> data</div><div class="line">&#125;, targetUrl)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>通过seletor选择器去获取元素，有两种方法可以获取目标节点，一个是通过page.evaluate这个api获取到html内容后，在回调函数中调用dom节点选择器相关api获取，这个回调函数无法打印log，无法内部断点，也无法直接访问外部的变量，需要通过api最后一个参数进行传参访问，最后返回一个操作结果。另一个方法就是通过puppeteer的选择器相关api直接获取。<br>比如说这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的所有节点</span></div><div class="line"><span class="keyword">let</span> imgs = <span class="keyword">await</span> page.$$(<span class="string">'div.portrait-player .img-box'</span>)</div><div class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的第一个节点</span></div><div class="line"><span class="keyword">let</span> img = <span class="keyword">await</span> page.$$(<span class="string">'div.portrait-player .img-box'</span>)</div><div class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的所有节点并返回数量</span></div><div class="line"><span class="keyword">let</span> imagesLen = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'div.portrait-player .img-box'</span>, imgs =&gt; imgs.length)</div><div class="line"><span class="comment">// 获取匹配选择器'div.portrait-player .img-box'下的第一个节点并返回节点的style属性中的高度值并去掉'px'单位字符串</span></div><div class="line"><span class="keyword">let</span> imgHeight =<span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'div.portrait-player .img-box'</span>, img =&gt; img.style.height.replace(<span class="string">'px'</span>,<span class="string">''</span>))</div></pre></td></tr></table></figure></p>
<p><code>page.$$</code> 抓取该选择器匹配的所有节点，对应dom获取节点querySelectorAll这个api，如果没有匹配的返回null<br><code>page.$</code> 抓取该选择器匹配的第一个节点并返回给回调函数，对应dom获取节点querySelector这个api，如果没有匹配的返回null，<br><code>page.$$eval</code> 比起<code>page.$$</code>多了一个回调函数进行抓取后的操作，抓取该选择器匹配的所有节点并返回给回调函数，在回调函数中进行数据转换操作后再返回函数结果，如果没有匹配的是抛出一个异常<br><code>page.$eval</code> 比起<code>page.$</code>多了一个回调函数进行抓取后的操作，抓取该选择器匹配的第一个节点并返回给回调函数，在回调函数中进行数据转换操作后再返回函数结果，如果没有匹配的是抛出一个异常</p>
<p>当然，puppeteer提供的api操作远不止这些，这只是一个快速上手的小例子，更多有趣的玩法，可以参考官方的文档，这里就不一一列举了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/20/RN-CallNative-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/20/RN-CallNative-Android/" itemprop="url">react-native调android原生</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-20T11:03:00+08:00">
                2018-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/20/RN-CallNative-Android/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/20/RN-CallNative-Android/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/20/RN-CallNative-Android/" class="leancloud_visitors" data-flag-title="react-native调android原生">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>我的开源项目高仿韩寒的one一个，打算长期维护并借此机会学习react-native相关的技术，感兴趣的可以<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="external">戳这里</a>，此项目不是标准的react-native项目结构，而是在android studio工程项目下引入react-native的混合式开发结构，其中不少地方调用了原生的模块和原生封装的ui组件，相信在react-native跨平台还不成熟的阶段，调用原生完成开发需求是不可避免的，打算在这里对react-native调用原生的相关技术做一个总结．如果有不正确的地方还望指正，或者您有更好的解决方案也欢迎提出一起讨论</p>
<hr>
<h1 id="调用原生模块"><a href="#调用原生模块" class="headerlink" title="调用原生模块"></a>调用原生模块</h1><p>react-native调用原生模块应该是经常会用到的，我们在android studio项目中引入react-native实质上就是设置ReactRootView为activity的布局视图，初始化mReactInstanceManager进行react-native的相关配置，添加自定义的原生组件包，MainReactPackage主组件包，这个是默认添加的，在activity的生命周期中对react-native做相关配置，同时继承DefaultHardwareBackBtnHandler接口，这个接口只有invokeDefaultOnBackPressed的方法，对于android back按键，是在onBackPressed中，把所有的back事件都发到js端，如果js端没监听，或者监听都返回了false，那么就会回到invokeDefaultOnBackPressed的Activity处理。</p>
<h2 id="调用原生的场景"><a href="#调用原生的场景" class="headerlink" title="调用原生的场景"></a>调用原生的场景</h2><p>比如我们需要在react-native 的ui中加入toast提示，调用音乐播放等多媒体相关的系统api支持，调用第三方分享和登录授权……不可避免的要调用原生代码，接下来详细记录react-native js端与原生android端之间的通信方式</p>
<h2 id="react-native调用android原生"><a href="#react-native调用android原生" class="headerlink" title="react-native调用android原生"></a>react-native调用android原生</h2><p>以加入toast提示为例：</p>
<h3 id="先定义一个ReactContextBaseJavaModule"><a href="#先定义一个ReactContextBaseJavaModule" class="headerlink" title="先定义一个ReactContextBaseJavaModule"></a>先定义一个ReactContextBaseJavaModule</h3><p>自定义一个ToastModule继承ReactContextBaseJavaModule，重写其中的getName方法，返回react-native中调用时的组件名，重写getConstants方法，返回一个常量map，定义常量值的key，将所有可供调用的常量值put进去，通过对象.常量值key使用模块常量，使用｀@ReactMethod｀注解可供react-native调用的方法，@ReactMethod注解的方法返回类型一定是void，这里的回调可以有两种方式实现，第一种是callback的方式，第二种是promise的方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_SHORT_KEY = <span class="string">"SHORT"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_LONG_KEY = <span class="string">"LONG"</span>;</div><div class="line">    <span class="keyword">boolean</span> flag=<span class="keyword">true</span>;</div><div class="line">    <span class="keyword">int</span> count=<span class="number">100000</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ToastModule</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(reactContext);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 复写方法，返回react-native中调用的组件名</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"ToastNative"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 复写方法，返回常量</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getConstants</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Map&lt;String, Object&gt; constants = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        constants.put(DURATION_SHORT_KEY, Toast.LENGTH_SHORT);</div><div class="line">        constants.put(DURATION_LONG_KEY, Toast.LENGTH_LONG);</div><div class="line">        <span class="keyword">return</span> constants;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 使用 @ReactMethod注解返回react-native中可调用的方法（使用callback的方式）</span></div><div class="line">    <span class="meta">@ReactMethod</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String message, <span class="keyword">int</span> duration ,Callback successCallback, Callback errorCallback)</span> </span>&#123;</div><div class="line">        Toast.makeText(getReactApplicationContext(), message, duration).show();</div><div class="line">        <span class="comment">// 通过invoke调用，随便你传参</span></div><div class="line">        <span class="keyword">if</span>(flag) &#123;</div><div class="line">            successCallback.invoke(<span class="string">"success"</span>, ++count);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            errorCallback.invoke(<span class="string">"error"</span>, ++count);</div><div class="line">        &#125;</div><div class="line">        flag = !flag;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">　  <span class="comment">//  使用 @ReactMethod注解返回react-native中可调用的方法（使用promise的方式）</span></div><div class="line">    <span class="meta">@ReactMethod</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMsg</span><span class="params">(String msg, Promise promise)</span> </span>&#123;</div><div class="line">        String result = <span class="string">"处理结果："</span> + msg;</div><div class="line">        Toast.makeText(getReactApplicationContext(), result, Toast.LENGTH_SHORT).show();</div><div class="line">        promise.resolve(result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 使用 @ReactMethod注解返回react-native中可调用的 方法</span></div><div class="line">    <span class="meta">@ReactMethod</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMsg</span><span class="params">(String message, <span class="keyword">int</span> duration)</span> </span>&#123;</div><div class="line">        Toast.makeText(getReactApplicationContext(), message, duration).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">　</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="注册ReactContextBaseJavaModule"><a href="#注册ReactContextBaseJavaModule" class="headerlink" title="注册ReactContextBaseJavaModule"></a>注册ReactContextBaseJavaModule</h3><p>在自定义的组件包中MyReactPackage注册这个ReactContextBaseJavaModule,其中createViewManagers方法用于注册原生ui组件，而createNativeModules方法用于注册原生模块<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReactPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引入原生的模块</div><div class="line">     * <span class="doctag">@param</span> reactContext</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(</span></span></div><div class="line">            ReactApplicationContext reactContext) &#123;</div><div class="line">        List&lt;NativeModule&gt; modules = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        modules.add(<span class="keyword">new</span> UShareModule(reactContext));</div><div class="line">        modules.add(<span class="keyword">new</span> ULoginModule(reactContext));</div><div class="line">        modules.add(<span class="keyword">new</span> ToastModule(reactContext));</div><div class="line">        modules.add(<span class="keyword">new</span> MediaPlayerModule(reactContext));</div><div class="line">        <span class="keyword">return</span> modules;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个MyReactPackage是我们自定义的组件包，我们需要添加到配置中</p>
<h3 id="在react-native工程结构下添加自定义的ReactPackage"><a href="#在react-native工程结构下添加自定义的ReactPackage" class="headerlink" title="在react-native工程结构下添加自定义的ReactPackage"></a>在react-native工程结构下添加自定义的ReactPackage</h3><p>修改android工程中的Application类，重写ReactNativeHost中的getPackages方法，在返回的数组中添加自定义的组件包对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">ReactApplication</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MyReactPackage myReactPackage=<span class="keyword">new</span> MyReactPackage();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactNativeHost mReactNativeHost = <span class="keyword">new</span> ReactNativeHost(<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUseDeveloperSupport</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> BuildConfig.DEBUG;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(</div><div class="line">                    <span class="keyword">new</span> MainReactPackage(),</div><div class="line">                    myReactPackage</div><div class="line">            );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ReactNativeHost <span class="title">getReactNativeHost</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mReactNativeHost;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="在android-studio工程结构下添加自定义的ReactPackage"><a href="#在android-studio工程结构下添加自定义的ReactPackage" class="headerlink" title="在android studio工程结构下添加自定义的ReactPackage"></a>在android studio工程结构下添加自定义的ReactPackage</h3><p>找到ReactActivity或者继承DefaultHardwareBackBtnHandler接口的activity中的mReactInstanceManager，添加一个自定义的组件包<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ReactRootView mReactRootView;</div><div class="line"><span class="keyword">private</span> ReactInstanceManager mReactInstanceManager;</div><div class="line"> <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    ...</div><div class="line">    mReactRootView = <span class="keyword">new</span> ReactRootView(<span class="keyword">this</span>);</div><div class="line">    mReactInstanceManager = ReactInstanceManager.builder()</div><div class="line">            .setApplication(getApplication())</div><div class="line">            .setBundleAssetName(<span class="string">"index.android.bundle"</span>)</div><div class="line">            .setJSMainModuleName(<span class="string">"index.android"</span>)</div><div class="line">            .addPackage(<span class="keyword">new</span> MainReactPackage())</div><div class="line">            .addPackage(<span class="keyword">new</span> MyReactPackage())</div><div class="line">            .addPackage(<span class="keyword">new</span> ImagePickerPackage())</div><div class="line">            .setUseDeveloperSupport(BuildConfig.DEBUG)</div><div class="line">            .setInitialLifecycleState(mLifecycleState)</div><div class="line">            .build();</div><div class="line">    mReactRootView.startReactApplication(mReactInstanceManager,</div><div class="line">            <span class="string">"SimpleOne"</span>, <span class="keyword">null</span>);</div><div class="line">    mReactInstanceManager.getDevSupportManager().showDevOptionsDialog();</div><div class="line">    setContentView(mReactRootView);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以只要实现了ReactPackage和ReactContextBaseJavaModule，将它注册到ReactNativeHost或者ReactInstanceManager，就可以在React Native中调用原生模块了。</p>
<h3 id="在react-native中使用"><a href="#在react-native中使用" class="headerlink" title="在react-native中使用"></a>在react-native中使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; NativeModules &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"><span class="keyword">let</span> toast = NativeModules.ToastNative;</div><div class="line">toast.show(<span class="string">'Toast message'</span>,toast.SHORT,(message,count)=&gt;&#123;<span class="built_in">console</span>.log(<span class="string">"success"</span>,message,count)&#125;,(message,count)=&gt;&#123;<span class="built_in">console</span>.log(<span class="string">"error"</span>,message,count)&#125;)</div><div class="line">toast.showMsg(<span class="string">'今晚22:30主播在这里等你'</span>,toast.SHORT);</div></pre></td></tr></table></figure>
<p>这里需要注意的是，callback／promise 在执行invoke／（reject、resolve）之后，都会在js的消息队列中被销毁。callback／promise只能用于一次返回，也就是说不能多次调用callback／promise来与react-native的组件进行通信，在一些场景下这种callback／promise的通信方式是不实用的，比如说我们调用android系统api来播放音乐，我们需要监听音乐的播放状态和进度，这里需要原生模块主动与react-native通信而且是多次通信，我们需要采用另一种通信方式，就是emit，有点类似android的广播，发送一条消息给js端，js端注册监听接收这条消息</p>
<h1 id="Android原生调react-native"><a href="#Android原生调react-native" class="headerlink" title="Android原生调react-native"></a>Android原生调react-native</h1><p>以实现播放音乐，监听音乐的播放状态和进度为例，我们需要让android主动向react-native多次发送消息，我们同样需要定义一个ReactContextBaseJavaModule，并且在自定义的组件包MyReactPackage中的createNativeModules方法里注册，跟前面的做法完全一样就不再赘述了，这里我们需要关心的是如何主动发送消息</p>
<h2 id="Android端主动发消息"><a href="#Android端主动发消息" class="headerlink" title="Android端主动发消息"></a>Android端主动发消息</h2><p>reactContext在我们注册ReactContextBaseJavaModule的时候由MyReactPackage中的createNativeModules方法传入，通过reactContext得到当前的JSModule调用它的emit方法，可以传两个参数，一个事件名称和一个WritableMap对象，事件名称需要与react-native注册监听的事件名称参数对应起来，而这个WritableMap对象存放的就是所有需要传递的参数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendEvent</span><span class="params">(ReactContext reactContext, String eventName, WritableMap map)</span></span></div><div class="line">&#123;</div><div class="line">    System.out.println(<span class="string">"reactContext="</span>+reactContext);</div><div class="line">    reactContext</div><div class="line">                .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)</div><div class="line">                .emit(eventName,map);</div><div class="line">&#125;</div><div class="line">WritableMap map=Arguments.createMap();</div><div class="line">map.putString(<span class="string">"state"</span>,LOADING_MEDIA_SUCCESS);</div><div class="line">sendEvent(mContext,PLAY_STATE,map);</div></pre></td></tr></table></figure></p>
<h2 id="react-native注册监听接收消息"><a href="#react-native注册监听接收消息" class="headerlink" title="react-native注册监听接收消息"></a>react-native注册监听接收消息</h2><p>这里我们需要对发送的事件名称注册监听，与发送消息时事件名称的传参保持一致，在回调中处理接收到消息以后的逻辑<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.listener = <span class="function">(<span class="params">reminder</span>) =&gt;</span> &#123;</div><div class="line">           <span class="built_in">console</span>.log(<span class="string">'当前状态'</span> + reminder.state);</div><div class="line">           <span class="keyword">if</span>(<span class="keyword">this</span>.props.isVisible)&#123;</div><div class="line">               <span class="keyword">if</span> (reminder.state === constants.STOP_PLAY_MEDIA || reminder.state === constants.PLAY_EXCEPTION || reminder.state == constants.PLAY_COMPLETE) &#123;</div><div class="line">                   <span class="keyword">this</span>.setState(&#123;</div><div class="line">                       <span class="attr">isPlay</span>: <span class="literal">false</span>,</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">DeviceEventEmitter.addListener(constants.PLAY_STATE, <span class="keyword">this</span>.listener)</div></pre></td></tr></table></figure></p>
<p>如果你在这个回调逻辑中刷新了ui，然而这个页面当前并没绘制，react-native会发出警告，对应的还有取消监听的方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DeviceEventEmitter.removeAllListeners(constants.PLAY_STATE);　<span class="comment">//移除该事件所有监听</span></div><div class="line">DeviceEventEmitter.removeListener(constants.PLAY_STATE,listener); <span class="comment">//移除该事件的指定监听</span></div></pre></td></tr></table></figure></p>
<p>这里我们需要注意的是一旦调用了DeviceEventEmitter.removeAllListeners方法，影响的不只有当前页面的监听，所有页面的监听都被移除了，移除当前页面的监听是第二个</p>
<h1 id="调原生ui组件"><a href="#调原生ui组件" class="headerlink" title="调原生ui组件"></a>调原生ui组件</h1><p>由于react-native官方提供的滚轮组件可定制性比较低，DatePickerIOS和DatePickerAndroid，调用的都是原生的日期滚轮选择器，也没找到合适的第三方库，无法达到设计的效果，所以采用了自定义原生ui组件的方案，给react-native暴露接口，让react-native调用原生的ui组件，这里我们以自定义日期选择滚轮为例，记录一下react-native调用原生ui组件的过程。</p>
<h2 id="封装组件"><a href="#封装组件" class="headerlink" title="封装组件"></a>封装组件</h2><h3 id="绘制单个滚轮"><a href="#绘制单个滚轮" class="headerlink" title="绘制单个滚轮"></a>绘制单个滚轮</h3><p>常规方式继承View，在onDraw中用canvas直接绘制，监听手势，根据手指滑动的距离对当前滚轮选项进行刷新。注意一下边界判断，当前选择项下标小于0时，选择最后一项，当前项下标大于最后一项下标，选择第一项。手指抬起时滚动到当前选择项的中间位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WheelView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"WheelView"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 自动回滚到中间的速度</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> SPEED = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 除选中item外，上下各需要显示的备选项数目</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHOW_SIZE = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context context;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; itemList;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemCount;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * item高度</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> itemHeight = <span class="number">50</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 选中的位置，这个位置是mDataList的中心位置，一直不变</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentItem;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Paint selectPaint;</div><div class="line">    <span class="keyword">private</span> Paint mPaint;</div><div class="line">    <span class="comment">// 画背景图中单独的画笔</span></div><div class="line">    <span class="keyword">private</span> Paint centerLinePaint;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> centerY;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> centerX;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mLastDownY;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 滑动的距离</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mMoveLen = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isInit = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> SelectListener mSelectListener;</div><div class="line">    <span class="keyword">private</span> Timer timer;</div><div class="line">    <span class="keyword">private</span> MyTimerTask mTask;</div><div class="line"></div><div class="line">    Handler updateHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (Math.abs(mMoveLen) &lt; SPEED) &#123;</div><div class="line">                <span class="comment">// 如果偏移量少于最少偏移量</span></div><div class="line">                mMoveLen = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != timer) &#123;</div><div class="line">                    timer.cancel();</div><div class="line">                    timer.purge();</div><div class="line">                    timer = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</div><div class="line">                    mTask.cancel();</div><div class="line">                    mTask = <span class="keyword">null</span>;</div><div class="line">                    performSelect();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 这里mMoveLen / Math.abs(mMoveLen)是为了保有mMoveLen的正负号，以实现上滚或下滚</span></div><div class="line">                mMoveLen = mMoveLen - mMoveLen / Math.abs(mMoveLen) * SPEED;</div><div class="line">            &#125;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WheelView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WheelView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">        init(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnSelectListener</span><span class="params">(SelectListener listener)</span> </span>&#123;</div><div class="line">        mSelectListener = listener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWheelStyle</span><span class="params">(<span class="keyword">int</span> style)</span> </span>&#123;</div><div class="line">        itemList = WheelStyle.getItemList(context, style);</div><div class="line">        <span class="keyword">if</span> (itemList != <span class="keyword">null</span>) &#123;</div><div class="line">            itemCount = itemList.size();</div><div class="line">            resetCurrentSelect();</div><div class="line">            invalidate();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.i(TAG, <span class="string">"item is null"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWheelItemList</span><span class="params">(List&lt;String&gt; itemList)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.itemList = itemList;</div><div class="line">        <span class="keyword">if</span> (itemList != <span class="keyword">null</span>) &#123;</div><div class="line">            itemCount = itemList.size();</div><div class="line">            resetCurrentSelect();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.i(TAG, <span class="string">"item is null"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetCurrentSelect</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (currentItem &lt; <span class="number">0</span>) &#123;</div><div class="line">            currentItem = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (currentItem &gt;= itemCount) &#123;</div><div class="line">            currentItem--;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (currentItem &gt;= <span class="number">0</span> &amp;&amp; currentItem &lt; itemCount) &#123;</div><div class="line">            invalidate();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.i(TAG, <span class="string">"current item is invalid"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> itemCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 选择选中的item的index</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentItem</span><span class="params">(String selected)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;itemList.size();i++)&#123;</div><div class="line">            String item=itemList.get(i);</div><div class="line">            <span class="keyword">if</span>(item.equals(selected))&#123;</div><div class="line">                currentItem = i;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        resetCurrentSelect();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCurrentItem</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> currentItem;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> mViewHeight = getMeasuredHeight();</div><div class="line">        <span class="keyword">int</span> mViewWidth = getMeasuredWidth();</div><div class="line">        centerX = (<span class="keyword">float</span>) (mViewWidth / <span class="number">2.0</span>);</div><div class="line">        centerY = (<span class="keyword">float</span>) (mViewHeight / <span class="number">2.0</span>);</div><div class="line"></div><div class="line">        isInit = <span class="keyword">true</span>;</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.context = context;</div><div class="line"></div><div class="line">        timer = <span class="keyword">new</span> Timer();</div><div class="line">        itemList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        mPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        mPaint.setStyle(Style.FILL);</div><div class="line">        mPaint.setTextAlign(Align.CENTER);</div><div class="line">        mPaint.setColor(getResources().getColor(R.color.wheel_unselect_text));</div><div class="line">        mPaint.setTextSize(SizeConvertUtil.spTopx(context, <span class="number">15</span>));</div><div class="line"></div><div class="line">        selectPaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        selectPaint.setStyle(Style.FILL);</div><div class="line">        selectPaint.setTextAlign(Align.CENTER);</div><div class="line">        selectPaint.setColor(getResources().getColor(R.color.wheel_select));</div><div class="line">        selectPaint.setTextSize(SizeConvertUtil.spTopx(context, <span class="number">17</span>));</div><div class="line"></div><div class="line">        centerLinePaint = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        centerLinePaint.setStyle(Style.FILL);</div><div class="line">        centerLinePaint.setTextAlign(Align.CENTER);</div><div class="line">        centerLinePaint.setColor(getResources().getColor(R.color.wheel_unselect_text));</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">        <span class="keyword">if</span> (isInit) &#123;</div><div class="line">            drawData(canvas);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawData</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="comment">// 先绘制选中的text再往上往下绘制其余的text</span></div><div class="line">        <span class="keyword">if</span> (!itemList.isEmpty()) &#123;</div><div class="line">            <span class="comment">// 绘制中间data</span></div><div class="line">            drawCenterText(canvas);</div><div class="line">            <span class="comment">// 绘制上方data</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; SHOW_SIZE + <span class="number">1</span>; i++) &#123;</div><div class="line">                drawOtherText(canvas, i, -<span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 绘制下方data</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; SHOW_SIZE + <span class="number">1</span>; i++) &#123;</div><div class="line">                drawOtherText(canvas, i, <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawCenterText</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="comment">// text居中绘制，注意baseline的计算才能达到居中，y值是text中心坐标</span></div><div class="line">        <span class="keyword">float</span> y = centerY + mMoveLen;</div><div class="line">        FontMetricsInt fmi = selectPaint.getFontMetricsInt();</div><div class="line">        <span class="keyword">float</span> baseline = (<span class="keyword">float</span>) (y - (fmi.bottom / <span class="number">2.0</span> + fmi.top / <span class="number">2.0</span>));</div><div class="line">        canvas.drawText(itemList.get(currentItem), centerX, baseline, selectPaint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> canvas   画布</div><div class="line">     * <span class="doctag">@param</span> position 距离mCurrentSelected的差值</div><div class="line">     * <span class="doctag">@param</span> type     1表示向下绘制，-1表示向上绘制</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawOtherText</span><span class="params">(Canvas canvas, <span class="keyword">int</span> position, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> index = currentItem + type * position;</div><div class="line">        <span class="keyword">if</span> (index &gt;= itemCount) &#123;</div><div class="line">            index = index - itemCount;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">            index = index + itemCount;</div><div class="line">        &#125;</div><div class="line">        String text = itemList.get(index);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> itemHeight = getHeight() / (SHOW_SIZE * <span class="number">2</span> + <span class="number">1</span>);</div><div class="line">        <span class="keyword">float</span> d = itemHeight * position + type * mMoveLen;</div><div class="line">        <span class="keyword">float</span> y = centerY + type * d;</div><div class="line"></div><div class="line">        FontMetricsInt fmi = mPaint.getFontMetricsInt();</div><div class="line">        <span class="keyword">float</span> baseline = (<span class="keyword">float</span>) (y - (fmi.bottom / <span class="number">2.0</span> + fmi.top / <span class="number">2.0</span>));</div><div class="line">        canvas.drawText(text, centerX, baseline, mPaint);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="keyword">int</span> alpha)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColorFilter</span><span class="params">(ColorFilter cf)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOpacity</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">super</span>.setBackground(background);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (event.getActionMasked()) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                doDown(event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                doMove(event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                doUp();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDown</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</div><div class="line">            mTask.cancel();</div><div class="line">            mTask = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        mLastDownY = event.getY();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doMove</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">        mMoveLen += (event.getY() - mLastDownY);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mMoveLen &gt; itemHeight / <span class="number">2</span>) &#123;</div><div class="line">            <span class="comment">// 往下滑超过离开距离</span></div><div class="line">            mMoveLen = mMoveLen - itemHeight;</div><div class="line">            currentItem--;</div><div class="line">            <span class="keyword">if</span> (currentItem &lt; <span class="number">0</span>) &#123;</div><div class="line">                currentItem = itemCount - <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mMoveLen &lt; -itemHeight / <span class="number">2</span>) &#123;</div><div class="line">            <span class="comment">// 往上滑超过离开距离</span></div><div class="line">            mMoveLen = mMoveLen + itemHeight;</div><div class="line">            currentItem++;</div><div class="line">            <span class="keyword">if</span> (currentItem &gt;= itemCount) &#123;</div><div class="line">                currentItem = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mLastDownY = event.getY();</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doUp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 抬起手后mCurrentSelected的位置由当前位置move到中间选中位置</span></div><div class="line">        <span class="keyword">if</span> (Math.abs(mMoveLen) &lt; <span class="number">0.0001</span>) &#123;</div><div class="line">            mMoveLen = <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mTask != <span class="keyword">null</span>) &#123;</div><div class="line">            mTask.cancel();</div><div class="line">            mTask = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == timer) &#123;</div><div class="line">            timer = <span class="keyword">new</span> Timer();</div><div class="line">        &#125;</div><div class="line">        mTask = <span class="keyword">new</span> MyTimerTask(updateHandler);</div><div class="line">        timer.schedule(mTask, <span class="number">0</span>, <span class="number">10</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyTimerTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">        Handler handler;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTimerTask</span><span class="params">(Handler handler)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.handler = handler;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            handler.sendMessage(handler.obtainMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSelect</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mSelectListener != <span class="keyword">null</span>) &#123;</div><div class="line">            mSelectListener.onSelect(currentItem, itemList.get(currentItem));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.i(TAG, <span class="string">"null listener"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelectListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="生成日期数据源"><a href="#生成日期数据源" class="headerlink" title="生成日期数据源"></a>生成日期数据源</h3><p>封装一个工具类用于生成日期滚轮选择器的数据源<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WheelStyle</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> minYear = <span class="number">1980</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> maxYear = <span class="number">2020</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Hour</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_HOUR = <span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Minute</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_MINUTE = <span class="number">2</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Year</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_YEAR = <span class="number">3</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Month</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_MONTH = <span class="number">4</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Day</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_DAY = <span class="number">5</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Wheel Style Light Time</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STYLE_LIGHT_TIME = <span class="number">7</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WheelStyle</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getItemList</span><span class="params">(Context context, <span class="keyword">int</span> Style)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Style == STYLE_HOUR) &#123;</div><div class="line">            <span class="keyword">return</span> createHourString();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_MINUTE) &#123;</div><div class="line">            <span class="keyword">return</span> createMinuteString();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_YEAR) &#123;</div><div class="line">            <span class="keyword">return</span> createYearString();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_MONTH) &#123;</div><div class="line">            <span class="keyword">return</span> createMonthString();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_DAY) &#123;</div><div class="line">            <span class="keyword">return</span> createDayString();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Style == STYLE_LIGHT_TIME) &#123;</div><div class="line">            <span class="keyword">return</span> createWeekString(context);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"style is illegal"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createHourString</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++) &#123;</div><div class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createMinuteString</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;</div><div class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createYearString</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = minYear; i &lt;= maxYear; i++) &#123;</div><div class="line">            wheelString.add(Integer.toString(i)+<span class="string">'年'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createMonthString</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">12</span>; i++) &#123;</div><div class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i)+<span class="string">'月'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createDayString</span><span class="params">()</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">31</span>; i++) &#123;</div><div class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createWeekString</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        String[] timeString = context.getResources().getStringArray(R.array.weeks);</div><div class="line">        <span class="keyword">for</span> (String week : timeString) &#123;</div><div class="line">            wheelString.add(week);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">createDayString</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; wheelString = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">int</span> size;</div><div class="line">        <span class="keyword">if</span> (isLeapMonth(month)) &#123;</div><div class="line">            size = <span class="number">31</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (month == <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (isLeapYear(year)) &#123;</div><div class="line">                size = <span class="number">29</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                size = <span class="number">28</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            size = <span class="number">30</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= size; i++) &#123;</div><div class="line">            wheelString.add(String.format(<span class="string">"%02d"</span>, i));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> wheelString;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 计算闰月</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> month</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeapMonth</span><span class="params">(<span class="keyword">int</span> month)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> month == <span class="number">1</span> || month == <span class="number">3</span> || month == <span class="number">5</span> || month == <span class="number">7</span></div><div class="line">                || month == <span class="number">8</span> || month == <span class="number">10</span> || month == <span class="number">12</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 计算闰年</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> year</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeapYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (year % <span class="number">4</span> == <span class="number">0</span> &amp;&amp; year % <span class="number">100</span> != <span class="number">0</span>) || year % <span class="number">400</span> == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="自定义LinearLayout绘制整个滚轮视图"><a href="#自定义LinearLayout绘制整个滚轮视图" class="headerlink" title="自定义LinearLayout绘制整个滚轮视图"></a>自定义LinearLayout绘制整个滚轮视图</h3><p>由2个滚轮组成的滚轮视图<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PickDateView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PickDateView原生Tag"</span>;</div><div class="line">    CallBack callBack;</div><div class="line">    WheelView yearWheel;</div><div class="line">    WheelView monthWheel;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CallBack</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">changeYear</span><span class="params">(<span class="keyword">int</span> year)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">changeMonth</span><span class="params">(<span class="keyword">int</span> month)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSure</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month, <span class="keyword">long</span> time)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallBack</span><span class="params">(CallBack callBack)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.callBack = callBack;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PickDateView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">       addCustomLayout(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(String year)</span></span>&#123;</div><div class="line">        yearWheel.setCurrentItem(year);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMonth</span><span class="params">(String month)</span></span>&#123;</div><div class="line">        monthWheel.setCurrentItem(month);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addCustomLayout</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        LayoutInflater mInflater = LayoutInflater.from(context);</div><div class="line">        View contentView = mInflater.inflate(R.layout.wheel_select_date, <span class="keyword">null</span>);</div><div class="line">        yearWheel = (WheelView) contentView.findViewById(R.id.select_date_wheel_year_wheel);</div><div class="line">        monthWheel = (WheelView) contentView.findViewById(R.id.select_date_month_wheel);</div><div class="line"></div><div class="line">        yearWheel.setWheelStyle(WheelStyle.STYLE_YEAR);</div><div class="line">        yearWheel.setOnSelectListener(<span class="keyword">new</span> WheelView.SelectListener() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span> </span>&#123;</div><div class="line">                <span class="keyword">int</span> selectYear = index + WheelStyle.minYear;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</div><div class="line">                    callBack.changeYear(selectYear);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        monthWheel.setWheelStyle(WheelStyle.STYLE_MONTH);</div><div class="line">        monthWheel.setOnSelectListener(<span class="keyword">new</span> WheelView.SelectListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelect</span><span class="params">(<span class="keyword">int</span> index, String text)</span> </span>&#123;</div><div class="line">                <span class="keyword">int</span> selectMonth = index + <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</div><div class="line">                    callBack.changeMonth(selectMonth);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line"></div><div class="line">        Button sureBt = (Button) contentView.findViewById(R.id.select_date_sure);</div><div class="line">        sureBt.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">int</span> year = yearWheel.getCurrentItem() + WheelStyle.minYear;</div><div class="line">                <span class="keyword">int</span> month = monthWheel.getCurrentItem();</div><div class="line"></div><div class="line">                Calendar calendar = Calendar.getInstance();</div><div class="line">                calendar.set(Calendar.YEAR, year);</div><div class="line">                calendar.set(Calendar.MONTH, month);</div><div class="line"></div><div class="line">                <span class="keyword">long</span> setTime = calendar.getTimeInMillis();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</div><div class="line">                    callBack.onSure(year, month, setTime);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        addView(contentView);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="给react-native暴露接口"><a href="#给react-native暴露接口" class="headerlink" title="给react-native暴露接口"></a>给react-native暴露接口</h3><p>自定义ViewManager，继承SimpleViewManager设置需要暴露的ui组件类PickDateView，重写实例化方法createViewInstance在方法内实例化ui组件类，同时在回调被调用时通知js端，发送事件消息，也是通过WritableMap传递参数列表，用<code>@ReactProp</code>注解标注的方法在react-native中作为属性传入<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PickDateViewManager</span> <span class="keyword">extends</span> <span class="title">SimpleViewManager</span>&lt;<span class="title">PickDateView</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REACT_CLASS = <span class="string">"PickDateView"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PickDateViewManger原生Tag"</span>;</div><div class="line">    <span class="keyword">private</span> PickDateView pickDateView;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> REACT_CLASS;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> PickDateView <span class="title">createViewInstance</span><span class="params">(<span class="keyword">final</span> ThemedReactContext reactContext)</span> </span>&#123;</div><div class="line">        pickDateView=<span class="keyword">new</span> PickDateView(reactContext);</div><div class="line">        pickDateView.setCallBack(<span class="keyword">new</span> PickDateView.CallBack() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</div><div class="line">                WritableMap map = Arguments.createMap();</div><div class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</div><div class="line">                map.putString(<span class="string">"msg"</span>, <span class="string">"year: "</span> + year);</div><div class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</div><div class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeMonth</span><span class="params">(<span class="keyword">int</span> month)</span> </span>&#123;</div><div class="line">                WritableMap map = Arguments.createMap();</div><div class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</div><div class="line">                map.putString(<span class="string">"msg"</span>, <span class="string">"month: "</span> + month);</div><div class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</div><div class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</div><div class="line">                );</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSure</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month, <span class="keyword">long</span> time)</span> </span>&#123;</div><div class="line">                WritableMap map = Arguments.createMap();</div><div class="line">                map.putInt(<span class="string">"target"</span>, pickDateView.getId());</div><div class="line"></div><div class="line">                WritableMap params=Arguments.createMap();</div><div class="line">                params.putInt(<span class="string">"year"</span>,year);</div><div class="line">                params.putInt(<span class="string">"month"</span>,month);</div><div class="line">                params.putString(<span class="string">"time"</span>,time+<span class="string">""</span>);</div><div class="line"></div><div class="line"><span class="comment">//                String paramsStr=jsonEnclose(params).toString();</span></div><div class="line">                map.putMap(<span class="string">"msg"</span>, params);</div><div class="line">                reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</div><div class="line">                        pickDateView.getId(), <span class="string">"topChange"</span>, map</div><div class="line">                );</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> pickDateView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@ReactProp</span>(name = <span class="string">"setYear"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(PickDateView pickDateView,String year)</span> </span>&#123;</div><div class="line">        pickDateView.setYear(year);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@ReactProp</span>(name = <span class="string">"setMonth"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMonth</span><span class="params">(PickDateView pickDateView,String month)</span> </span>&#123;</div><div class="line">        pickDateView.setMonth(month);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="注册自定义的ViewManager"><a href="#注册自定义的ViewManager" class="headerlink" title="注册自定义的ViewManager"></a>注册自定义的ViewManager</h3><p>同样需要在自定义的组件包MyReactPackage的createViewManagers方法中注册<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReactPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 引入原生的view</div><div class="line">     * <span class="doctag">@param</span> reactContext</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</div><div class="line">        List&lt;ViewManager&gt; viewManagers=<span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        viewManagers.add(<span class="keyword">new</span> PickDateViewManager());</div><div class="line">        viewManagers.add(<span class="keyword">new</span> ShowPlayViewManager());</div><div class="line">        <span class="keyword">return</span> viewManagers;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="在react-native中使用-1"><a href="#在react-native中使用-1" class="headerlink" title="在react-native中使用"></a>在react-native中使用</h3><h4 id="在react-native中声明原生组件"><a href="#在react-native中声明原生组件" class="headerlink" title="在react-native中声明原生组件"></a>在react-native中声明原生组件</h4><p>定义原生中也声明了的组件属性和统一接收回调消息的onChange方法<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</div><div class="line"><span class="keyword">import</span> &#123;requireNativeComponent, View&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">let</span> iface = &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'PickDateView'</span>,</div><div class="line">    <span class="attr">propTypes</span>: &#123;</div><div class="line">        <span class="attr">setYear</span>: PropTypes.string,</div><div class="line">        <span class="attr">setMonth</span>: PropTypes.string,</div><div class="line">        <span class="comment">//回调</span></div><div class="line">        onChange: PropTypes.func,</div><div class="line">        ...View.propTypes  <span class="comment">//支持View组件的所有属性</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> RCTPickDateView = requireNativeComponent(<span class="string">'PickDateView'</span>, iface);</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> RCTPickDateView;</div></pre></td></tr></table></figure></p>
<h4 id="在react-native中使用原生组件"><a href="#在react-native中使用原生组件" class="headerlink" title="在react-native中使用原生组件"></a>在react-native中使用原生组件</h4><p>绘制一个弹窗，弹窗内部使用原生的日期滚轮选择器，在弹窗弹出时加入一个展开动画，在onChange方法中接收参数obj.nativeEvent.参数名<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">    AppRegistry,</div><div class="line">    StyleSheet,</div><div class="line">    Text,</div><div class="line">    View,</div><div class="line">    Modal,</div><div class="line">    Animated,</div><div class="line">    TouchableOpacity</div><div class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"><span class="keyword">import</span> PickDateView <span class="keyword">from</span> <span class="string">'../view/PickDate'</span>;</div><div class="line"><span class="keyword">import</span> constants <span class="keyword">from</span> <span class="string">'../Constants'</span>;</div><div class="line"><span class="keyword">let</span> &#123;width, height&#125; = constants.ScreenWH;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullPickDate</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(props)&#123;</div><div class="line">        <span class="keyword">super</span>(props);</div><div class="line">        <span class="keyword">this</span>.onLayout=<span class="keyword">this</span>.onLayout.bind(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">this</span>.state=&#123;</div><div class="line">            <span class="attr">expanded</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">animation</span> : <span class="keyword">new</span> Animated.Value()</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    showAnimation(height)&#123;</div><div class="line">        <span class="keyword">let</span> maxHeight=height;</div><div class="line">        <span class="keyword">let</span> minHeight=<span class="number">0</span>;</div><div class="line">        <span class="keyword">let</span> initialValue = <span class="keyword">this</span>.state.expanded ? maxHeight + minHeight : minHeight,</div><div class="line">            finalValue= <span class="keyword">this</span>.state.expanded ? minHeight : maxHeight + minHeight;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;</div><div class="line">            <span class="attr">expanded</span>: !<span class="keyword">this</span>.state.expanded <span class="comment">//Step 2</span></div><div class="line">        &#125;);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'最大高度'</span>+maxHeight);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'初始值'</span>+initialValue+<span class="string">'最终值'</span>+finalValue);</div><div class="line">        <span class="keyword">this</span>.state.animation.setValue(initialValue); <span class="comment">//Step 3</span></div><div class="line"></div><div class="line">        <span class="keyword">this</span>.timer = setTimeout(</div><div class="line">            <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">                <span class="keyword">this</span>.toggle(finalValue);</div><div class="line">            &#125;,</div><div class="line">            <span class="number">5000</span></div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    toggle(finalValue) &#123;</div><div class="line">        Animated.spring(</div><div class="line">            <span class="keyword">this</span>.state.animation,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">toValue</span>: finalValue</div><div class="line">            &#125;</div><div class="line">        ).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;Modal</div><div class="line">                animationType=&#123;'none'&#125;</div><div class="line">                transparent=&#123;true&#125;</div><div class="line">                visible=&#123;this.props.onShow&#125;</div><div class="line">                onRequestClose=&#123;() =&gt; &#123;</div><div class="line">                    this.props.onCancel();</div><div class="line">                &#125;&#125;&gt;</div><div class="line"></div><div class="line">                &lt;View style=&#123;&#123;width: width, flex: 1, marginTop: height * 0.08 + 0.12 * width,backgroundColor: 'rgba(0, 0, 0, 0.7)'&#125;&#125;&gt;</div><div class="line">                    &lt;PickDateView</div><div class="line">                        setYear=&#123;this.props.year&#125;</div><div class="line">                        setMonth=&#123;this.props.month&#125;</div><div class="line">                        onLayout=&#123;this.onLayout&#125;</div><div class="line">                        onChange=&#123;(obj) =&gt; &#123;</div><div class="line">                            console.log('onSure收到事件' + obj.nativeEvent.msg + "目标id" + obj.nativeEvent.msg.year);</div><div class="line">                            //当此回调被onSure调用时</div><div class="line">                            let year = obj.nativeEvent.msg.year + '';</div><div class="line">                            let month = obj.nativeEvent.msg.month + '';</div><div class="line">                            let time= obj.nativeEvent.msg.time + '';</div><div class="line">                            if (year !== 'undefined' &amp;&amp; month !== 'undefined') &#123;</div><div class="line">                                this.props.onCancel();</div><div class="line">                            &#125;else&#123;</div><div class="line">                                this.props.onSure(year,month,time);</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                        &#125;&#125;</div><div class="line">                        style=&#123;&#123;width: '100%', flex: 0.42,&#125;&#125;/&gt;</div><div class="line">                    &lt;TouchableOpacity style=&#123;&#123;flex:0.58&#125;&#125; onPress=&#123;() =&gt; this.props.onCancel()&#125;/&gt;</div><div class="line">                &lt;/View&gt;</div><div class="line">            &lt;/Modal&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    onLayout(event)&#123;</div><div class="line">        this.showAnimation(event.nativeEvent.layout.height);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default PullPickDate;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/09/RN-NumberScroll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/09/RN-NumberScroll/" itemprop="url">react-native 实现数字滚动动画</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-09T11:11:26+08:00">
                2018-07-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/09/RN-NumberScroll/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/09/RN-NumberScroll/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/09/RN-NumberScroll/" class="leancloud_visitors" data-flag-title="react-native 实现数字滚动动画">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>自从在github上开源了高仿韩寒的one一个项目之后，空闲时间仍旧保持项目的更新和维护，目前公司没有react-native的项目，但我一直对react-native很有兴趣，所以打算一直维护下去并借此机会学习相关的技术。one一个是资讯类的app，主界面是由3个分页组成的，底部有导航栏，是一个比较大众化的展示方式，其中one分页是用日期作为顶部标题，手指每向左滑动一次就往前翻页，向右滑动一次就往后翻页，每天的展示内容就是一页列表，标题就会随着手指的翻页而刷新，显示当前展示内容的发布日期，这里的日期刷新就是一个数字滚动的动画效果。</p>
<hr>
<p>先上效果图：</p>
<p><img src="/images/react-native-number-scroll.gif" alt="效果图"></p>
<h1 id="绘制思路如下："><a href="#绘制思路如下：" class="headerlink" title="绘制思路如下："></a>绘制思路如下：</h1><ol>
<li>设置表示数字范围的数字数组</li>
<li>测量数字的绘制高度 </li>
<li>对当前文本做切割，遍历每个字符，判断当前字符是否是数字，如果是数字，根据目标数字在数字数组中的下标，和当前数字在数字数组中的下标，以及数字绘制的高度，计算出垂直方向y上需要平移的距离，执行平移动画。如果不是数字，直接绘制这个字符文本</li>
<li>文本由父组件通过props传递，注意props值变化时重置动画属性值，刷新文本内容<h1 id="定义数字布局样式"><a href="#定义数字布局样式" class="headerlink" title="定义数字布局样式"></a>定义数字布局样式</h1>数字水平排列，需要先放置一个隐藏的text测量数字的高度<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> styles = StyleSheet.create(&#123;</div><div class="line">    <span class="comment">// 数字水平浮动排列</span></div><div class="line">    row: &#123;</div><div class="line">        <span class="attr">flexDirection</span>: <span class="string">'row'</span>,</div><div class="line">        <span class="attr">overflow</span>: <span class="string">'hidden'</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 隐藏</span></div><div class="line">    hide: &#123;</div><div class="line">        <span class="attr">position</span>: <span class="string">'absolute'</span>,</div><div class="line">        <span class="attr">left</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">right</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">opacity</span>: <span class="number">0</span>,</div><div class="line">    &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="父组件需要传入的参数"><a href="#父组件需要传入的参数" class="headerlink" title="父组件需要传入的参数"></a>父组件需要传入的参数</h1><p>文本内容,样式,滚动时长<br>其中文本内容可以有两种传递方式：</p>
<ol>
<li>通过props.text进行传递</li>
<li>通过子组件设置成文本内容直接传递<h1 id="设置数字范围"><a href="#设置数字范围" class="headerlink" title="设置数字范围"></a>设置数字范围</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 指定范围创建数组</span></div><div class="line"><span class="keyword">const</span> range = <span class="function"><span class="params">length</span> =&gt;</span> <span class="built_in">Array</span>.from(&#123; length &#125;, (x, i) =&gt; i);</div><div class="line"><span class="comment">// 创建"0","1","2","3","4"..."9"的数组,默认绘制数据</span></div><div class="line"><span class="keyword">const</span> numberRange = range(<span class="number">10</span>).map(<span class="function"><span class="params">p</span> =&gt;</span> p + <span class="string">""</span>);</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="定义数字滚动动画组件"><a href="#定义数字滚动动画组件" class="headerlink" title="定义数字滚动动画组件"></a>定义数字滚动动画组件</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ticker</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 定义属性类型</span></div><div class="line">    <span class="keyword">static</span> propTypes = &#123;</div><div class="line">        <span class="attr">text</span>: PropTypes.string,</div><div class="line">        <span class="attr">textStyle</span>: PropTypes.oneOfType([PropTypes.number, PropTypes.object, PropTypes.array]),</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// 定义默认属性值</span></div><div class="line">    <span class="keyword">static</span> defaultProps = &#123;</div><div class="line">        <span class="attr">rotateTime</span>: <span class="number">250</span>, <span class="comment">// 默认滚动时间</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    state = &#123;</div><div class="line">        <span class="attr">measured</span>: <span class="literal">false</span>, <span class="comment">// 是否已测量</span></div><div class="line">        height: <span class="number">0</span>, <span class="comment">// 高度</span></div><div class="line">        fontSize: StyleSheet.flatten(<span class="keyword">this</span>.props.textStyle).fontSize, <span class="comment">// 获取props中的字体大小</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// props变动时回调</span></div><div class="line">    componentWillReceiveProps(nextProps) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;</div><div class="line">            <span class="attr">fontSize</span>: StyleSheet.flatten(nextProps.textStyle).fontSize,</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    handleMeasure = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;</div><div class="line">            <span class="attr">measured</span>: <span class="literal">true</span>, <span class="comment">// 修改flag为已测量</span></div><div class="line">            height: e.nativeEvent.layout.height, <span class="comment">//测量高度</span></div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 渲染</div><div class="line">     * @returns &#123;*&#125;</div><div class="line">     */</div><div class="line">    render() &#123;</div><div class="line">        <span class="comment">// 获取文本内容,子组件,样式,滚动时长</span></div><div class="line">        <span class="keyword">const</span> &#123; text, children, textStyle, style, rotateTime &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="comment">// 获取高度, 是否测量标记</span></div><div class="line">        <span class="keyword">const</span> &#123; height, measured &#125; = <span class="keyword">this</span>.state;</div><div class="line">        <span class="comment">// 如果未测量则透明</span></div><div class="line">        <span class="keyword">const</span> opacity = measured ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">        <span class="comment">// 文本内容获取,读取text或子组件内容,两种方式配置文本内容</span></div><div class="line">        <span class="keyword">const</span> childs = text || children;</div><div class="line">        <span class="comment">// 如果子组件是字符串,字符串渲染,否则子组件渲染</span></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.row,</span> &#123; <span class="attr">height</span>, <span class="attr">opacity</span> &#125;, <span class="attr">style</span>]&#125;&gt;</span></span></div><div class="line">                &#123;/*渲染逻辑*/&#125;</div><div class="line">                &#123;numberRenderer(&#123;</div><div class="line">                    children: childs,</div><div class="line">                    textStyle,</div><div class="line">                    height,</div><div class="line">                    rotateTime,</div><div class="line">                    rotateItems: numberRange,</div><div class="line">                &#125;)&#125;</div><div class="line">                &#123;/*测量text高度,不显示该组件*/&#125;</div><div class="line">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;[textStyle,</span> <span class="attr">styles.hide</span>]&#125; <span class="attr">onLayout</span>=<span class="string">&#123;this.handleMeasure&#125;</span> <span class="attr">pointerEvents</span>=<span class="string">"none"</span>&gt;</span></div><div class="line">                    0</div><div class="line">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在render方法中，绘制了一个隐藏的text组件，是为了测量在当前样式下，绘制出的数字高度值<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="comment">/*测量text高度,不显示该组件*/</span>&#125;</div><div class="line">               &lt;Text style=&#123;[textStyle, styles.hide]&#125; onLayout=&#123;<span class="keyword">this</span>.handleMeasure&#125; pointerEvents=<span class="string">"none"</span>&gt;</div><div class="line">                   <span class="number">0</span></div><div class="line">               &lt;<span class="regexp">/Text&gt;</span></div></pre></td></tr></table></figure></p>
<p>其中view中的numberRenderer是数字滚动动画的渲染逻辑，这个view是在测量高度之后再显示的。<br>在numberRenderer这个方法中，我们需要对当前的文本做切割得到包含文本中每个字符的字符数组，遍历切割后的字符数组，取出每一个字符，判断是否是数字，不是数字就直接绘制文本，Piece是封装的直接用text进行文本绘制的组件，如果是数字就绘制数字动画组件，Tick是封装的单个数字动画绘制的组件。<br>实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> numberRenderer = <span class="function">(<span class="params">&#123; children, textStyle, height, rotateTime, rotateItems &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// 切割子组件文本内容遍历</span></div><div class="line">    <span class="keyword">return</span> splitText(children).map(<span class="function">(<span class="params">piece, i</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (!isNumber(piece)) &#123; <span class="comment">//取单个字符，如果不是数字,直接绘制文本</span></div><div class="line">            <span class="keyword">return</span> (</div><div class="line">                <span class="xml"><span class="tag">&lt;<span class="name">Piece</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height</span> &#125;&#125; <span class="attr">textStyle</span>=<span class="string">&#123;textStyle&#125;</span>&gt;</span></span></div><div class="line">                    &#123;piece&#125;</div><div class="line">                <span class="tag">&lt;/<span class="name">Piece</span>&gt;</span></div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果是数字，绘制单个数字</span></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            <span class="xml"><span class="tag">&lt;<span class="name">Tick</span></span></span></div><div class="line">                <span class="attr">duration</span>=<span class="string">&#123;rotateTime&#125;</span></div><div class="line">                <span class="attr">key</span>=<span class="string">&#123;i&#125;</span></div><div class="line">                <span class="attr">text</span>=<span class="string">&#123;piece&#125;</span></div><div class="line">                <span class="attr">textStyle</span>=<span class="string">&#123;textStyle&#125;</span></div><div class="line">                <span class="attr">height</span>=<span class="string">&#123;height&#125;</span></div><div class="line">                <span class="attr">rotateItems</span>=<span class="string">&#123;rotateItems&#125;</span></div><div class="line">            /&gt;</div><div class="line">        );</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>文本切割和数字判断方法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 切割</span></div><div class="line"><span class="keyword">const</span> splitText = <span class="function">(<span class="params">text = <span class="string">""</span></span>) =&gt;</span> (text + <span class="string">""</span>).split(<span class="string">""</span>);</div><div class="line"><span class="comment">// 是十进制数字判断</span></div><div class="line"><span class="keyword">const</span> isNumber = <span class="function">(<span class="params">text = <span class="string">""</span></span>) =&gt;</span> !<span class="built_in">isNaN</span>(<span class="built_in">parseInt</span>(text, <span class="number">10</span>));</div></pre></td></tr></table></figure></p>
<p>直接用text进行文本绘制的组件Piece，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *</div><div class="line"> * @param children 子组件(文本内容)</div><div class="line"> * @param style 样式</div><div class="line"> * @param height 高度</div><div class="line"> * @param textStyle 文本样式</div><div class="line"> * @returns 无动画绘制文本</div><div class="line"> * @constructor</div><div class="line"> */</div><div class="line"><span class="keyword">const</span> Piece = <span class="function">(<span class="params">&#123; children, style, height, textStyle &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">        <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></div><div class="line">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;[textStyle,</span> &#123; <span class="attr">height</span> &#125;]&#125;&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">    );</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>单个数字动画绘制的组件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tick</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 创建动画初始值</div><div class="line">     * @type &#123;&#123;animation: Animated.Value&#125;&#125;</div><div class="line">     */</div><div class="line">    state = &#123;</div><div class="line">        <span class="attr">animation</span>: <span class="keyword">new</span> Animated.Value(</div><div class="line">            getPosition(&#123;</div><div class="line">                <span class="attr">text</span>: <span class="keyword">this</span>.props.text,</div><div class="line">                <span class="attr">items</span>: <span class="keyword">this</span>.props.rotateItems,</div><div class="line">                <span class="attr">height</span>: <span class="keyword">this</span>.props.height,</div><div class="line">            &#125;),</div><div class="line">        ),</div><div class="line">    &#125;;</div><div class="line">    componentDidMount() &#123;</div><div class="line">        <span class="comment">// 如果高度已测量,设置动画初始值</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.props.height !== <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.setState(&#123;</div><div class="line">                <span class="attr">animation</span>: <span class="keyword">new</span> Animated.Value(</div><div class="line">                    getPosition(&#123;</div><div class="line">                        <span class="attr">text</span>: <span class="keyword">this</span>.props.text,</div><div class="line">                        <span class="attr">items</span>: <span class="keyword">this</span>.props.rotateItems,</div><div class="line">                        <span class="attr">height</span>: <span class="keyword">this</span>.props.height,</div><div class="line">                    &#125;),</div><div class="line">                ),</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    componentWillReceiveProps(nextProps) &#123;</div><div class="line">        <span class="comment">// 高度变化,重置动画初始值</span></div><div class="line">        <span class="keyword">if</span> (nextProps.height !== <span class="keyword">this</span>.props.height) &#123;</div><div class="line">            <span class="keyword">this</span>.setState(&#123;</div><div class="line">                <span class="attr">animation</span>: <span class="keyword">new</span> Animated.Value(</div><div class="line">                    getPosition(&#123;</div><div class="line">                        <span class="attr">text</span>: nextProps.text,</div><div class="line">                        <span class="attr">items</span>: nextProps.rotateItems,</div><div class="line">                        <span class="attr">height</span>: nextProps.height,</div><div class="line">                    &#125;),</div><div class="line">                ),</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    componentDidUpdate(prevProps) &#123;</div><div class="line">        <span class="keyword">const</span> &#123; height, duration, rotateItems, text &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="comment">// 数字变化,用当前动画值和变化后的动画值进行插值,并启动动画</span></div><div class="line">        <span class="keyword">if</span> (prevProps.text !== text) &#123;</div><div class="line">            Animated.timing(<span class="keyword">this</span>.state.animation, &#123;</div><div class="line">                <span class="attr">toValue</span>: getPosition(&#123;</div><div class="line">                    <span class="attr">text</span>: text,</div><div class="line">                    <span class="attr">items</span>: rotateItems,</div><div class="line">                    height,</div><div class="line">                &#125;),</div><div class="line">                duration,</div><div class="line">                <span class="attr">useNativeDriver</span>: <span class="literal">true</span>,</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; animation &#125; = <span class="keyword">this</span>.state;</div><div class="line">        <span class="keyword">const</span> &#123; textStyle, height, rotateItems &#125; = <span class="keyword">this</span>.props;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height</span> &#125;&#125;&gt;</span></span></div><div class="line">                <span class="tag">&lt;<span class="name">Animated.View</span> <span class="attr">style</span>=<span class="string">&#123;getAnimationStyle(animation)&#125;</span>&gt;</span></div><div class="line">                    &#123;/*遍历数字范围数组绘制数字*/&#125;</div><div class="line">                    &#123;rotateItems.map(v =&gt; (</div><div class="line">                        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">key</span>=<span class="string">&#123;v&#125;</span> <span class="attr">style</span>=<span class="string">&#123;[textStyle,</span> &#123; <span class="attr">height</span> &#125;]&#125;&gt;</span></div><div class="line">                            &#123;v&#125;</div><div class="line">                        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">                    ))&#125;</div><div class="line">                <span class="tag">&lt;/<span class="name">Animated.View</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就封装了一个平移动画，绘制的时候是绘制了整个范围的数字，getPosition这个方法是用来计算目标数字的y轴坐标值，根据当前数字在数组中的下标乘以测量出的数字文本绘制高度取负值，得出坐标值。具体代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> getPosition = <span class="function">(<span class="params">&#123; text, items, height &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// 获得文本在数组的下标</span></div><div class="line">    <span class="keyword">const</span> index = items.findIndex(<span class="function"><span class="params">p</span> =&gt;</span> p === text);</div><div class="line">    <span class="comment">// 返回文本绘制的y轴坐标</span></div><div class="line">    <span class="keyword">return</span> index * height * <span class="number">-1</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这里需要注意数字变化后的处理，一旦数字变化，就触发动画，当父组件传递的props的值变化了，就会调用子组件的componentDidUpdate方法，可以在componentDidUpdate方法中对文本内容做比对，如果与之前props的text值不一致，表示数字变化，根据目标数字计算目标y值，执行平移动画。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">componentDidUpdate(prevProps) &#123;</div><div class="line">     <span class="keyword">const</span> &#123; height, duration, rotateItems, text &#125; = <span class="keyword">this</span>.props;</div><div class="line">     <span class="comment">// 数字变化,用当前动画值和变化后的动画值进行插值,并启动动画</span></div><div class="line">     <span class="keyword">if</span> (prevProps.text !== text) &#123;</div><div class="line">         Animated.timing(<span class="keyword">this</span>.state.animation, &#123;</div><div class="line">             <span class="attr">toValue</span>: getPosition(&#123;</div><div class="line">                 <span class="attr">text</span>: text,</div><div class="line">                 <span class="attr">items</span>: rotateItems,</div><div class="line">                 height,</div><div class="line">             &#125;),</div><div class="line">             duration,</div><div class="line">             <span class="attr">useNativeDriver</span>: <span class="literal">true</span>,</div><div class="line">         &#125;).start();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>注意规避高度变化带来的问题，一旦高度变化，重置动画的初始值<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">componentWillReceiveProps(nextProps) &#123;</div><div class="line">        <span class="comment">// 高度变化,重置动画初始值</span></div><div class="line">        <span class="keyword">if</span> (nextProps.height !== <span class="keyword">this</span>.props.height) &#123;</div><div class="line">            <span class="keyword">this</span>.setState(&#123;</div><div class="line">                <span class="attr">animation</span>: <span class="keyword">new</span> Animated.Value(</div><div class="line">                    getPosition(&#123;</div><div class="line">                        <span class="attr">text</span>: nextProps.text,</div><div class="line">                        <span class="attr">items</span>: nextProps.rotateItems,</div><div class="line">                        <span class="attr">height</span>: nextProps.height,</div><div class="line">                    &#125;),</div><div class="line">                ),</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>导出封装的组件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> &#123; Tick, numberRange &#125;; <span class="comment">// 单个数字动画组件，数字范围</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ticker; <span class="comment">// 整个数字动画组件</span></div></pre></td></tr></table></figure></p>
<p>在项目中使用，展示格式为yyyy / MM / dd的日期：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;Ticker text=&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="keyword">this</span>.state.showDate.substring(<span class="number">0</span>, <span class="number">4</span>)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;<span class="number">1000</span>&#125; /&gt;</div><div class="line"></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.dividerText&#125;</span>&gt;</span>&#123;this.state.showDate === '0' ? '' : '    /    '&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></div><div class="line"></div><div class="line">&lt;Ticker text=&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="keyword">this</span>.state.showDate.substring(<span class="number">5</span>, <span class="number">7</span>)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;<span class="number">1000</span>&#125; /&gt;</div><div class="line">                       </div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.dividerText&#125;</span>&gt;</span>&#123;this.state.showDate === '0' ? '' : '    /    '&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></div><div class="line">                       </div><div class="line">&lt;Ticker text=&#123;<span class="keyword">this</span>.state.showDate === <span class="string">'0'</span> ? <span class="string">''</span> : <span class="keyword">this</span>.state.showDate.substring(<span class="number">8</span>, <span class="number">10</span>)&#125; textStyle=&#123;styles.dateText&#125; rotateTime=&#123;<span class="number">1000</span>&#125; /&gt;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/08/Ubuntu-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/08/Ubuntu-start/" itemprop="url">搭建Ubuntu下的开发环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-08T13:54:00+08:00">
                2018-07-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Util/" itemprop="url" rel="index">
                    <span itemprop="name">Util</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/08/Ubuntu-start/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/08/Ubuntu-start/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/08/Ubuntu-start/" class="leancloud_visitors" data-flag-title="搭建Ubuntu下的开发环境">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>最近有点闲暇时间，厌倦了windows开发环境，想尝试一下ubuntu下的开发环境。本人Android开发者，也写一点前端，以前家里是mac开发环境，公司是windows开发环境，现在打算把公司的开发环境改为ubuntu，之前也看过ubuntu下搭建Android开发环境的文章，即使这样，也踩了不少的坑，折腾了几天，总算把环境搭建起来了，基本稳定。总的来说ubuntu下的开发环境不像windows和mac那么好搭建，坑点略多，但是搭建成功后运行速度是非常可观的，比起windows快了不少，也不枉费花了这么多时间。接下来总结一下ubuntu下开发的常用软件，插件，以及可能遇到的坑点。</p>
<hr>
<h1 id="安装系统遇到的问题"><a href="#安装系统遇到的问题" class="headerlink" title="安装系统遇到的问题"></a>安装系统遇到的问题</h1><p>安装系统流程比较普通，分区方案网上有很多，不过要注意两点</p>
<h2 id="安装英文版的系统"><a href="#安装英文版的系统" class="headerlink" title="安装英文版的系统"></a>安装英文版的系统</h2><p>即使不习惯英文系统也应该在安装系统时选择英文，安装完了再改回中文，因为如果是安装中文版的系统，文件夹的名称会变成下载，文档，音乐，图片．．．由于ubuntu很多时候用命令行，导致命令行输入经常切换中文不方便，我第一次安装的时候手快选了中文版，以为后面可以改，然而这个目录名是安装系统的时候就建好了的，第二次果断安装英文版</p>
<h2 id="分区的坑"><a href="#分区的坑" class="headerlink" title="分区的坑"></a>分区的坑</h2><p>ubuntu虽然可以挂载ntfs分区，但是ide在读取工程目录的时候是只读取/下面的，所以根目录的分区一定不能小</p>
<h1 id="卸载系统自带的软件"><a href="#卸载系统自带的软件" class="headerlink" title="卸载系统自带的软件"></a>卸载系统自带的软件</h1><p>有些软件系统自带，但是并不好用或者不会用到的可以卸载掉<br>以下是卸载清单<br>libreoffice-common libreoffice（可以换 WPS）<br>unity-webapps-common Amazon 链接<br>totem 自带的播放器<br>rhythmbox 自带的音乐播放器<br>empathy 自带的即时聊天应用<br>brasero 自带的光盘刻录器<br>simple-scan 扫描仪<br>gnome-mahjongg 对对碰游戏<br>aisleriot 纸牌游戏<br>gnome-mines 扫雷游戏<br>cheese webcam 应用<br>gnome-sudoku 数独游戏<br>transmission-common BT 客户端<br>gnome-orca 屏幕阅读<br>webbrowser-app 自带的浏览器（这个太难用了，有chrome 和 Firefox）<br>landscape-client-ui-install landscape 远程控制软件<br>deja-dup 备份<br>onboard 屏幕键盘</p>
<p>下面是可以批量卸载的命令<br><code>sudo apt-get remove unity-webapps-common;sudo apt-get remove totem;sudo apt-get remove rhythmbox;sudo apt-get remove empathy;sudo apt-get remove brasero;sudo apt-get remove simple-scan;sudo apt-get remove gnome-mahjongg;sudo apt-get remove aisleriot;sudo apt-get remove gnome-mines;sudo apt-get remove cheese;sudo apt-get remove transmission-common;sudo apt-get remove gnome-orca;sudo apt-get remove webbrowser-app;sudo apt-get remove gnome-sudoku;sudo apt-get remove landscape-client-ui-install;sudo apt-get remove onboard;sudo apt-get remove deja-dup;sudo apt-get remove libreoffice-common</code></p>
<p>apt-get remove –purge xxx # 移除应用及配置<br>apt-get autoremove # 移除没用的包</p>
<h1 id="设置中文输入法"><a href="#设置中文输入法" class="headerlink" title="设置中文输入法"></a>设置中文输入法</h1><p>sudo add-apt-repository ppa:fcitx-team/nightly<br>sudo apt-get update<br>安装fcitx<br>sudo apt-get install fcitx<br>安装fcitx的配置工具<br>sudo apt-get install fcitx-config-gtk<br>安装fcitx的table-all软件包<br>sudo apt-get install fcitx-table-all<br>安装输入法切换工具<br>sudo apt-get install im-switch<br>设置语言选项：将键盘输入法系统由默认的iBus设置为fcitx<br>安装了搜狗输入法后频繁崩溃，索性就用fcitx自带的，并没觉得有什么不同</p>
<h1 id="命令行相关"><a href="#命令行相关" class="headerlink" title="命令行相关"></a>命令行相关</h1><p>bash对应配置文件为.bashrc<br>zsh对应配置文件为.zshrc<br>oh-my-zsh是基于zsh的功能做了一个扩展，方便的插件管理、主题自定义，以及漂亮的自动完成效果。比默认的bash好用</p>
<h2 id="安装zsh"><a href="#安装zsh" class="headerlink" title="安装zsh"></a>安装zsh</h2><p>sudo apt-get install zsh</p>
<h2 id="安装ohmyzsh"><a href="#安装ohmyzsh" class="headerlink" title="安装ohmyzsh"></a>安装ohmyzsh</h2><h3 id="git源码"><a href="#git源码" class="headerlink" title="git源码"></a>git源码</h3><p>git clone git://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh<br>cd oh-my-zsh/tools<br>./install.sh</p>
<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>sh -c “$(curl -fsSL <a href="https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh" target="_blank" rel="external">https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh</a>)”</p>
<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><p>sh -c “$(wget <a href="https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh" target="_blank" rel="external">https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh</a> -O -)”</p>
<h2 id="修改默认shell"><a href="#修改默认shell" class="headerlink" title="修改默认shell"></a>修改默认shell</h2><p>ubuntu下默认的shell是bash，修改它为zsh&amp;ohmyzsh<br>chsh -s /bin/zsh</p>
<h2 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h2><p>修改~/.zshrc中的ZSH_THEME</p>
<h2 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h2><p>修改~/.zshrc中的plugins=(git bundler osx rake ruby)<br>常用插件<br>wd 快速进入<br>zsh-syntax-highlighting 语法高亮<br>zsh-autosuggestions 历史记录提示<br>svn<br>adb<br>yarn</p>
<h2 id="更好用的terminal"><a href="#更好用的terminal" class="headerlink" title="更好用的terminal"></a>更好用的terminal</h2><p>支持f12下拉上半屏/全屏显示<br>Guake Terminal</p>
<h2 id="图形化svn"><a href="#图形化svn" class="headerlink" title="图形化svn"></a>图形化svn</h2><p>rapidsvn</p>
<h1 id="shadowsocks相关"><a href="#shadowsocks相关" class="headerlink" title="shadowsocks相关"></a>shadowsocks相关</h1><p>作为开发者ss是必不可少的，特别是习惯了google的，完全无法忍受没有梯子的日子，ubuntu下配置shadowsocks稍微有些麻烦。<br>首先我们要下载shadowsocks的无图形界面版本，我用过图形界面版qt5，太不稳定了。<br>sudo apt update<br>sudo apt install python-gevent python-pip<br>pip install shadowsocks<br>编辑配置文件<br>vim /etc/ss.json<br>server 服务器地址<br>server_port 端口<br>local_port 本地端口<br>password 密码<br>method 加密方式 跟服务器保持一致<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">&quot;server&quot;:&quot;server_ip&quot;,</div><div class="line">&quot;server_port&quot;:30696,</div><div class="line">&quot;local_port&quot;:1080,</div><div class="line">&quot;password&quot;:&quot;password&quot;,</div><div class="line">&quot;timeout&quot;:600,</div><div class="line">&quot;method&quot;:&quot;rc4-md5&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ubuntu自带开机启动项设置工具 startupapplications点击add添加<br>name和comment随意填写，command填写为sudo sslocal -c /etc/ss.json -d start<br>配置好了以后，我们需要修改本机代理，windows、mac都是不需要的</p>
<h2 id="全部请求用代理"><a href="#全部请求用代理" class="headerlink" title="全部请求用代理"></a>全部请求用代理</h2><p>SystemSetting-&gt;Network-&gt;-&gt;NetworkProxy<br>Method设置为Ｍanual<br>sockshost 127.0.0.1 1080，然后Apply System Wide</p>
<h2 id="添加规则，部分代理"><a href="#添加规则，部分代理" class="headerlink" title="添加规则，部分代理"></a>添加规则，部分代理</h2><p>安装genpac<br>sudo apt-get install python-pip<br>sudo pip install genpac<br>使用genpac生成autoproxy.pac规则文件<br>genpac -p “SOCKS5 127.0.0.1:1080” –output=”autoproxy.pac”<br>让系统应用规则<br>SystemSetting-&gt;Network-&gt;NetworkProxy<br>Method设置为Automatic<br>Configuration Url填”file:///home/xxx/autoproxy.pac”，然后Apply System Wide<br>chrome和firefox都要安装Proxy SwitchyOmega插件<br>方便我们设置自动切换规则</p>
<h2 id="http代理"><a href="#http代理" class="headerlink" title="http代理"></a>http代理</h2><p>如果是命令行，很多只支持http协议的软件或者工具，我们再配置一次http代理</p>
<h3 id="安装privoxy"><a href="#安装privoxy" class="headerlink" title="安装privoxy"></a>安装privoxy</h3><p>sudo apt-get install privoxy</p>
<h3 id="配置privoxy"><a href="#配置privoxy" class="headerlink" title="配置privoxy"></a>配置privoxy</h3><p>打开/etc/privoxy/config<br>取消listen-address localhost:8118的代码注释<br>找到5.2节<br>加入一句<br>forward-socks5 / 127.0.0.1:1080 .<br>重启privoxy服务<br>sudo /etc/init.d/privoxy restart<br>开机自启privoxy服务<br>sudo /etc/init.d/privoxy start加入到/etc/rc.local文件中的exit 0这句之前<br>在profile中写入http代理<br>export http_proxy=”127.0.0.1:8118”<br>export https_proxy=”127.0.0.1:8118”</p>
<h1 id="Ubuntu软件集合"><a href="#Ubuntu软件集合" class="headerlink" title="Ubuntu软件集合"></a>Ubuntu软件集合</h1><p>chrome 开发者必备浏览器，自带有firefox<br>Typora markdown编辑器<br>Shutter 截图<br>electronic wechat 微信<br>快速启动ULauncher<br>Redshift 自动调节屏幕色温<br>Android studio android开发者都懂<br>Webstorm 前端开发利器<br>vscode 微软出的开发神器，轻量级<br>mpv 播放器<br>angrySearch文件搜索<br>ubuntu-tweak 集清理，主题管理，字体管理，热区自定义于一体的软件，可替代ubuntu-tweak-tool，这个软件会默认安装系统自带的浏览器<br>(2018-5-31 新版的ubuntu18移除了unity桌面,这个没啥用了,可换成gnome-tweak-tool)</p>
<h2 id="ubuntu18-gnome主题定制"><a href="#ubuntu18-gnome主题定制" class="headerlink" title="ubuntu18 gnome主题定制"></a>ubuntu18 gnome主题定制</h2><p><a href="https://www.gnome-look.org/" target="_blank" rel="external">定制资源下载</a><br>光标: 下载解压后放到/usr/share/icons/目录<br>GTK主题: 下载解压后放到/usr/share/themes/目录<br>图标: 下载解压放到/usr/share/icons/目录<br>shell主题: 下载解压放到/usr/share/themes/目录 (需要安装gnome shell extension)<br>(使用gnome tweak tool-&gt;apperance前面按钮安装zip,会放到~/.local/share/themes下)<br>重启gnome tweak tool,才可在gnome tweak tool中找到</p>
<h1 id="wps-金山wps有linux版"><a href="#wps-金山wps有linux版" class="headerlink" title="wps 金山wps有linux版"></a>wps 金山wps有linux版</h1><p>安装后进入，报字体缺失<br>下载字体包<br>百度云<a href="http://pan.baidu.com/s/1nuS5U5b" target="_blank" rel="external">http://pan.baidu.com/s/1nuS5U5b</a> 密码：p4vz</p>
<ol>
<li>解压</li>
<li>把wps_symbol_fonts目录拷贝到 /usr/share/fonts/ 目录下</li>
<li><p>权限添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>cd /usr/share/fonts/</div><div class="line"><span class="meta">#</span>chmod 755 wps_symbol_fonts</div><div class="line"><span class="meta">#</span>cd /usr/share/fonts/wps_symbol_fonts</div><div class="line"><span class="meta">#</span>chmod 644 *</div></pre></td></tr></table></figure>
</li>
<li><p>生成缓存配置信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>cd /usr/share/fonts/wps_symbol_fonts</div><div class="line"><span class="meta">#</span>mkfontdir</div><div class="line"><span class="meta">#</span>mkfontscale</div><div class="line"><span class="meta">#</span>fc-cache</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="小程序开发工具"><a href="#小程序开发工具" class="headerlink" title="小程序开发工具"></a>小程序开发工具</h1><p>微信开发者工具(微信小程序)linux完美支持<br><a href="https://github.com/cytle/wechat_web_devtools" target="_blank" rel="external">https://github.com/cytle/wechat_web_devtools</a></p>
<h1 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h1><p>wireshark<br><a href="https://blog.csdn.net/xukai871105/article/details/31008635" target="_blank" rel="external">https://blog.csdn.net/xukai871105/article/details/31008635</a><br>charles也有linux版</p>
<h1 id="qq-解决方案"><a href="#qq-解决方案" class="headerlink" title="qq 解决方案"></a>qq 解决方案</h1><p>优麒麟qq，表情显示不出来且发送错误，版本很老</p>
<p>Wine-QQ-TIM，使用几天后出现电脑无故卡死，输入法切换不了，无法启动等问题</p>
<p>Wine真的不好用，还不如虚拟机</p>
<p>一番折腾后，还是卸载了qq，珍爱生命，远离qq</p>
<h1 id="virtualbox-amp-genymotion"><a href="#virtualbox-amp-genymotion" class="headerlink" title="virtualbox&amp;genymotion"></a>virtualbox&amp;genymotion</h1><p>虚拟机和Android模拟器<br>在virtualbox下安装win7，解决ubuntu下无法解决的问题<br>安装virtualbox时注意安装ubuntu最新版本，如果开了intel虚拟技术，还是卡开机界面，可能是当前显卡驱动问题，不要选择opensource版本的显卡驱动<br>genymotion尽量选择最新的版本，这里有个坑，如果卡死，内存分配尽量大一点</p>
<h1 id="拾色器"><a href="#拾色器" class="headerlink" title="拾色器"></a>拾色器</h1><p>前端开发，app开发必不可少的工具<br><a href="https://kryogenix.org/code/pick/" target="_blank" rel="external">https://kryogenix.org/code/pick/</a></p>
<h1 id="系统备份"><a href="#系统备份" class="headerlink" title="系统备份"></a>系统备份</h1><p>辛苦折腾的系统最好做个备份 ,remastersys这个系统备份工具是不错，但是备份文件大于4g就会备份失败，官方文档也说了这个问题是iso9660的限制，目前无解。<br>后来发现一个更好用的工具，Timeshift类似mac上的TimeMachine，按备份时间点创建快照，对快照可进行管理，有备份计划等功能，可以实现增强备份和完整备份。</p>
<p>目前就总结到这里，后面如果发现更好用的软件，插件，坑点会持续更新～</p>
<ul>
<li>2018.11.11爬坑<br>Android studio真机调试会报一个错，发现设备无法被识别<br><code>error insufficient permissions for device user in plugdev group are your udev rules wrong</code><br>解决方案：</li>
</ul>
<ol>
<li>lsusb命令查出所有通过usb连接pc的设备，找出那个正在调试的读不出型号的设备<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Bus 001 Device 004: ID 0424:2514 Standard Microsystems Corp. USB 2.0 Hub</div><div class="line">Bus 001 Device 003: ID 1bcf:2984 Sunplus Innovation Technology Inc.</div><div class="line">Bus 001 Device 006: ID 2717:9039</div><div class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</div><div class="line">Bus 003 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</div><div class="line">Bus 002 Device 002: ID 046d:c077 Logitech, Inc.</div></pre></td></tr></table></figure>
</li>
</ol>
<p>注意ID后XXXX:XXXX的参数，前一个是idVendor，后一个是idProduct</p>
<ol>
<li>创建adb_usb.ini文件，写入idVendor到~/.android/adb_usb.ini，内容格式为<code>0xidVendor</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo 0x2717&gt; ~/.android/adb_usb.ini</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这一步官网上没有提到，导致后面<code>android.rules</code>文件一直报<code>SUBSYSTEM==&quot;usb&quot;</code>有错</p>
<ul>
<li>以下步骤可以解决Android studio无法识别设备XXXX[null]的问题</li>
</ul>
<ol>
<li><p>添加Usb设备配置文件，创建文件并写入以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/udev/rules.d/70-android.rules</div><div class="line">SUBSYSTEM==&quot;usb&quot;, ATTRS&#123;idVendor&#125;==&quot;2717&quot;, ATTRS&#123;idProduct&#125;==&quot;9039&quot;,MODE=&quot;0666&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>给配置文件添加权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod a+rx /etc/udev/rules.d/70-android.rules</div></pre></td></tr></table></figure>
</li>
<li><p>重新加载usb配置规则文件，重启adb服务并查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo udevadm control --reload-rules &amp;&amp; sudo service udev restart &amp;&amp; sudo udevadm trigger</div><div class="line">adb kill-server &amp;&amp; adb start-server</div><div class="line">adb devices</div></pre></td></tr></table></figure>
</li>
</ol>
<p>此时设备已经可以识别了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Jessie Kate" />
            
              <p class="site-author-name" itemprop="name">Jessie Kate</p>
              <p class="site-description motion-element" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '6LCVjBbx0bpqxaQGmw1hdaTw-gzGzoHsz',
        appKey: 'h0CQIfed08e67roNpfhTzHOH',
        placeholder: '在这里写下你的评论吧～',
        avatar:'wavatar',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("6LCVjBbx0bpqxaQGmw1hdaTw-gzGzoHsz", "h0CQIfed08e67roNpfhTzHOH");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



  

  

  
  

  

  

  

</body>
</html>
