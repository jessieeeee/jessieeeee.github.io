<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>JessieK's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/29/BlockCanaryAndLeakCanary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/11/29/BlockCanaryAndLeakCanary/" class="post-title-link" itemprop="url">手写LeakCanary&&BlockCanary&&AnrWatchDog</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-11-29 23:56:22" itemprop="dateCreated datePublished" datetime="2020-11-29T23:56:22+08:00">2020-11-29</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-22 17:46:42" itemprop="dateModified" datetime="2020-11-22T17:46:42+08:00">2020-11-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近在做性能优化的东西，研究了一下相关的内存监测，卡顿监测，以及ANR监测开源框架，对里面的核心原理做了总结，并手写一份简易版以便加深印象，为后续搭建线上日志监控做铺垫，在此做一个记录，线上监控框架可根据业务在此基础上做扩展。收集必要的日志信息，排查问题及时修复BUG，提升性能和稳定性，也是每个Android工程师必不可少的技能。</p>
<hr>
<h2 id="BlockCanary"><a href="#BlockCanary" class="headerlink" title="BlockCanary"></a>BlockCanary</h2><ol>
<li>通过采样工具类，在子线程中获取主线程的堆栈信息并保存到Map，暴露一个接口返回采样结果</li>
<li>通过日志监控类，实现Printer接口，判断是否卡顿（采样开始到采样结束的时间间隔是否超过阈值），如果卡顿调用接口获取返回的采样结果在子线程中日志打印</li>
<li>App出现卡顿，会阻塞主线程的dispatchMessage，主线程Looper的loop方法中有一个Printer在每个Message处理前后被调用，所以设置主线程的MessageLogging为自定义的Printer<h3 id="采样工具类"><a href="#采样工具类" class="headerlink" title="采样工具类"></a>采样工具类</h3>开启一个采样子线程，设置原子变量记录本次是否采样保证多线程同步，避免重复开始和结束，开始采样post一个采样任务到子线程，存入当前时间戳和对应的主线程堆栈信息到Map中，如果本次仍然需采样继续延迟间隔时间执行采样任务，暴露一个获取主线程堆栈信息的接口方法，返回当前堆栈信息列表<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StackSampler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"\r\n"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat TIME_FORMATTER =</span><br><span class="line">            <span class="keyword">new</span> SimpleDateFormat(<span class="string">"MM-dd HH:mm:ss.SSS"</span>);</span><br><span class="line">    <span class="keyword">private</span> Handler mHandler;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Long, String&gt; mStackMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(); <span class="comment">//保存的主线程堆栈信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mMaxCount = <span class="number">100</span>; <span class="comment">// 最多保存100条</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mSampleInterval; <span class="comment">// 采样时间间隔</span></span><br><span class="line">    <span class="comment">// 本次是否采样</span></span><br><span class="line">    <span class="keyword">protected</span> AtomicBoolean mShouldSample = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StackSampler</span><span class="params">(<span class="keyword">long</span> sampleInterval)</span> </span>&#123;</span><br><span class="line">        mSampleInterval = sampleInterval;</span><br><span class="line">        <span class="comment">// 开启采样子线程</span></span><br><span class="line">        HandlerThread handlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">"block-canary-sampler"</span>);</span><br><span class="line">        handlerThread.start();</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(handlerThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始采样 执行堆栈</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDump</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 避免重复开始</span></span><br><span class="line">        <span class="keyword">if</span> (mShouldSample.get()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置采样标记</span></span><br><span class="line">        mShouldSample.set(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 移除上一个采样任务，在采样间隔时间后执行采样</span></span><br><span class="line">        mHandler.removeCallbacks(mRunnable);</span><br><span class="line">        mHandler.postDelayed(mRunnable, mSampleInterval);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopDump</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 避免重复结束</span></span><br><span class="line">        <span class="keyword">if</span> (!mShouldSample.get()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置采样标记</span></span><br><span class="line">        mShouldSample.set(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        mHandler.removeCallbacks(mRunnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getStacks</span><span class="params">(<span class="keyword">long</span> startTime, <span class="keyword">long</span> endTime)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">synchronized</span> (mStackMap) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long entryTime : mStackMap.keySet()) &#123;</span><br><span class="line">                <span class="comment">// 记录时间大于开始时间小于结束时间就放入返回列表中</span></span><br><span class="line">                <span class="keyword">if</span> (startTime &lt; entryTime &amp;&amp; entryTime &lt; endTime) &#123;</span><br><span class="line">                    result.add(TIME_FORMATTER.format(entryTime)</span><br><span class="line">                            + SEPARATOR</span><br><span class="line">                            + SEPARATOR</span><br><span class="line">                            + mStackMap.get(entryTime));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Runnable mRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="comment">// 获得主线程堆栈信息并拼接到字符串</span></span><br><span class="line">            StackTraceElement[] stackTrace = Looper.getMainLooper().getThread().getStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement s : stackTrace) &#123;</span><br><span class="line">                sb.append(s.toString()).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (mStackMap) &#123;</span><br><span class="line">                <span class="comment">//最多保存100条堆栈信息，到了数量上限移除</span></span><br><span class="line">                <span class="keyword">if</span> (mStackMap.size() == mMaxCount) &#123;</span><br><span class="line">                    mStackMap.remove(mStackMap.keySet().iterator().next());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 存入当前时间戳和对应的堆栈信息</span></span><br><span class="line">                mStackMap.put(System.currentTimeMillis(), sb.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果本次要采样，设置延迟继续执行此任务</span></span><br><span class="line">            <span class="keyword">if</span> (mShouldSample.get()) &#123;</span><br><span class="line">                mHandler.postDelayed(mRunnable, mSampleInterval);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="卡顿监控工具类"><a href="#卡顿监控工具类" class="headerlink" title="卡顿监控工具类"></a>卡顿监控工具类</h3>初始化采样工具类，开启打印日志子线程，记录采样的开始时间和结束时间，如果时间大于设定的卡顿阈值则判定为卡顿状态，调用采样工具类获取主线程堆栈信息<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 卡顿监控工具类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogMonitor</span> <span class="keyword">implements</span> <span class="title">Printer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StackSampler mStackSampler; <span class="comment">// 采样工具类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mPrintingStarted = <span class="keyword">false</span>; <span class="comment">// 开始打印标记</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mStartTimestamp; <span class="comment">// 开始时间戳</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mBlockThresholdMillis = <span class="number">3000</span>; <span class="comment">// 卡顿阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mSampleInterval = <span class="number">1000</span>; <span class="comment">// 采样频率</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler mLogHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogMonitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化采样工具类</span></span><br><span class="line">        mStackSampler = <span class="keyword">new</span> StackSampler(mSampleInterval);</span><br><span class="line">        <span class="comment">// 开启打印子线程</span></span><br><span class="line">        HandlerThread handlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">"block-canary-io"</span>);</span><br><span class="line">        handlerThread.start();</span><br><span class="line">        mLogHandler = <span class="keyword">new</span> Handler(handlerThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">println</span><span class="params">(String x)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从if到else会执行消息分发，如果执行耗时超过阈值，输出卡顿信息</span></span><br><span class="line">        <span class="keyword">if</span> (!mPrintingStarted) &#123;</span><br><span class="line">            <span class="comment">//记录开始时间</span></span><br><span class="line">            mStartTimestamp = System.currentTimeMillis();</span><br><span class="line">            mPrintingStarted = <span class="keyword">true</span>;</span><br><span class="line">            mStackSampler.startDump();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">            mPrintingStarted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//出现卡顿，通知卡顿事件</span></span><br><span class="line">            <span class="keyword">if</span> (isBlock(endTime)) &#123;</span><br><span class="line">                notifyBlockEvent(endTime);</span><br><span class="line">            &#125;</span><br><span class="line">            mStackSampler.stopDump();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyBlockEvent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> endTime)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获得卡顿时主线程堆栈信息在子线程打印</span></span><br><span class="line">        mLogHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                List&lt;String&gt; stacks = mStackSampler.getStacks(mStartTimestamp, endTime);</span><br><span class="line">                <span class="keyword">for</span> (String stack : stacks) &#123;</span><br><span class="line">                    Log.e(<span class="string">"block-canary"</span>, stack);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBlock</span><span class="params">(<span class="keyword">long</span> endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> endTime - mStartTimestamp &gt; mBlockThresholdMillis;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="卡顿监控入口"><a href="#卡顿监控入口" class="headerlink" title="卡顿监控入口"></a>卡顿监控入口</h3>设置主线程的MessageLogging为自定义的Printer<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockCanary</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LogMonitor logMonitor = <span class="keyword">new</span> LogMonitor();</span><br><span class="line">        Looper.getMainLooper().setMessageLogging(logMonitor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="LeakCanary"><a href="#LeakCanary" class="headerlink" title="LeakCanary"></a>LeakCanary</h2><p>Java中WeakReference和ReferenceQueue联合使用是监控某个对象是否被gc回收的手段，LeakCanary正是利用这个原理实现的。</p>
<h3 id="WeakReference和ReferenceQueue联合使用"><a href="#WeakReference和ReferenceQueue联合使用" class="headerlink" title="WeakReference和ReferenceQueue联合使用"></a>WeakReference和ReferenceQueue联合使用</h3><p>创建一个对象，包装到弱引用对象中并关联引用队列，把对象置空，强制GC，取出引用队列的弱引用对象是否与关联时的弱引用对象相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 创建一个引用队列</span></span><br><span class="line">      ReferenceQueue referenceQueue = <span class="keyword">new</span> ReferenceQueue();</span><br><span class="line">      <span class="comment">// 创建一个对象</span></span><br><span class="line">      Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//把obj放入弱引用对象，并和一个引用队列关联</span></span><br><span class="line">      <span class="comment">//当obj被gc回收后，weakReference会被添加到与之关联的referenceQueue</span></span><br><span class="line">      WeakReference weakReference = <span class="keyword">new</span> WeakReference(obj,referenceQueue);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//把obj置空，让它没有强引用</span></span><br><span class="line">      obj = <span class="keyword">null</span>;</span><br><span class="line">      Runtime.getRuntime().gc(); <span class="comment">//强制gc</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line">          Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">      &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">      Reference findRef = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">do</span>&#123;</span><br><span class="line">          findRef = referenceQueue.poll();</span><br><span class="line">          <span class="comment">//如果能找到上面的weakReference对象，说明obj被gc回收了</span></span><br><span class="line">          System.out.println(<span class="string">"findRef = "</span> +findRef + <span class="string">"是否等于上面的weakReference = "</span> + (findRef == weakReference));</span><br><span class="line">      &#125;<span class="keyword">while</span>(findRef !=<span class="keyword">null</span>);<span class="comment">// 把所有referenceQueue的weakReference对象找出来</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="封装包含key和name的弱引用类"><a href="#封装包含key和name的弱引用类" class="headerlink" title="封装包含key和name的弱引用类"></a>封装包含key和name的弱引用类</h3><p>继承WeakReference弱引用类，方便根据key删除对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyWeakReference</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KeyWeakReference</span><span class="params">(T referent, String key, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(referent);</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KeyWeakReference</span><span class="params">(T referent, ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; q, String key, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(referent, q);</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"KeyWeakReference&#123;"</span>);</span><br><span class="line">        sb.append(<span class="string">"key='"</span>).append(key).append(<span class="string">'\''</span>);</span><br><span class="line">        sb.append(<span class="string">", name='"</span>).append(name).append(<span class="string">'\''</span>);</span><br><span class="line">        sb.append(<span class="string">'&#125;'</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监控工具类"><a href="#监控工具类" class="headerlink" title="监控工具类"></a>监控工具类</h3><p>创建一个观察对象Map，怀疑对象Map和引用队列，先清理一遍被GC的对象，遍历引用队列的所有弱引用对象，清理观察对象Map和怀疑对象Map中对应的对象，被监控的对象生成UUID作为key，把对象放入弱引用并与引用队列关联，放入到观察对象Map中，5秒后判断该对象是否还存在观察对象Map中，还存在则说明没有被GC，将该对象移动到怀疑对象Map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 观察对象Map</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, KeyWeakReference&gt; watchedReferences = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 怀疑对象Map</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, KeyWeakReference&gt; retainedReferences = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当被监视的对象被gc回收后，对象的弱引用就会被加入到引用队列</span></span><br><span class="line">    <span class="keyword">private</span> ReferenceQueue queue = <span class="keyword">new</span> ReferenceQueue();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Watcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取出引用队列的所有弱引用对象，清理观察对象Map和怀疑对象Map中对应的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeWeaklyReachableReferences</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KeyWeakReference findRef = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 取出引用队列的弱引用对象</span></span><br><span class="line">            findRef = (KeyWeakReference) queue.poll();</span><br><span class="line">            <span class="comment">// 不为空说明对象被gc回收了，把对应的弱引用对象从观察对象Map，怀疑对象Map移除</span></span><br><span class="line">            <span class="keyword">if</span> (findRef != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 根据key把它从观察对象Map移除</span></span><br><span class="line">                Reference removedRef = watchedReferences.remove(findRef.getKey());</span><br><span class="line">                <span class="comment">// 如果removedRef为空，有可能被放入到怀疑对象Map了</span></span><br><span class="line">                <span class="comment">// 尝试从怀疑对象Map中移除</span></span><br><span class="line">                <span class="keyword">if</span> (removedRef == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    retainedReferences.remove(findRef.getKey());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (findRef != <span class="keyword">null</span>);<span class="comment">// 把referenceQueue的所有弱引用取出来</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key把对应的弱引用对象从观察对象Map移动到怀疑对象Map</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">moveToRetained</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"加入到怀疑列表..."</span>);</span><br><span class="line">        <span class="comment">// 加入怀疑对象Map前，做一次清理</span></span><br><span class="line">        removeWeaklyReachableReferences();</span><br><span class="line">        <span class="comment">// 根据key从观察对象Map中去找弱引用对象</span></span><br><span class="line">        KeyWeakReference retainedRef = watchedReferences.remove(key);</span><br><span class="line">        <span class="comment">// 发现还没有被删除，说明没有被回收</span></span><br><span class="line">        <span class="keyword">if</span> (retainedRef != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//从观察对象Map中移除,加入到怀疑对象Map</span></span><br><span class="line">            retainedReferences.put(key, retainedRef);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watch</span><span class="params">(Object watchedReference, String referenceName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 先清理下观察对象Map和怀疑对象Map</span></span><br><span class="line">        removeWeaklyReachableReferences();</span><br><span class="line">        <span class="comment">//2. 被监视的对象生成唯一的uuid作为key</span></span><br><span class="line">        <span class="keyword">final</span> String key = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3. 被监视的对象放入weakReference，并和一个引用队列关联</span></span><br><span class="line">        KeyWeakReference reference = <span class="keyword">new</span> KeyWeakReference(watchedReference, queue, key, <span class="string">""</span>);</span><br><span class="line">        <span class="comment">//4. 加入到观察对象Map</span></span><br><span class="line">        watchedReferences.put(key, reference);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 延迟5秒后检查是否还在观察对象Map，如果还在，则加入到怀疑对象Map</span></span><br><span class="line">        Executor executor = Executors.newSingleThreadExecutor();</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            Utils.sleep(<span class="number">5000</span>);</span><br><span class="line">            moveToRetained(key);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取泄漏对象Map</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap&lt;String, KeyWeakReference&gt; <span class="title">getRetainedReferences</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        retainedReferences.forEach((key, keyWeakReference) -&gt; &#123;</span><br><span class="line">                    System.out.println(<span class="string">"key: "</span> + key + <span class="string">" , obj: "</span> + keyWeakReference.get() + <span class="string">" , keyWeakReference: "</span> + keyWeakReference);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> retainedReferences;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="监控泄漏对象"><a href="#监控泄漏对象" class="headerlink" title="监控泄漏对象"></a>监控泄漏对象</h2><p>创建对象，调用监控工具类的监控方法，查看怀疑对象Map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化监控工具类</span></span><br><span class="line">        Watcher watcher = <span class="keyword">new</span> Watcher();</span><br><span class="line">        <span class="comment">// 创建对象并开始对象监控</span></span><br><span class="line">        Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">        watcher.watch(obj,<span class="string">""</span>);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 释放对象</span></span><br><span class="line">        obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 强制GC</span></span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">        System.runFinalization();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"查看是否在怀疑对象Map："</span> + watcher.getRetainedReferences().size());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ANRWatchDog"><a href="#ANRWatchDog" class="headerlink" title="ANRWatchDog"></a>ANRWatchDog</h2><h3 id="FileObserver"><a href="#FileObserver" class="headerlink" title="FileObserver"></a>FileObserver</h3><p>监控Android系统的anr日志目录/data/anr/，利用FileObserver监控目录下的文件操作，间接监控ANR问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ANRFileObserver</span> <span class="keyword">extends</span> <span class="title">FileObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ANRFileObserver</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ANRFileObserver</span><span class="params">(String path, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(path, mask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">int</span> event, @Nullable String path)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (event)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.ACCESS:<span class="comment">//文件被访问</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"ACCESS: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.ATTRIB:<span class="comment">//文件属性被修改，如 chmod、chown、touch 等</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"ATTRIB: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.CLOSE_NOWRITE:<span class="comment">//不可写文件被 close</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"CLOSE_NOWRITE: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.CLOSE_WRITE:<span class="comment">//可写文件被 close</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"CLOSE_WRITE: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.CREATE:<span class="comment">//创建新文件</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"CREATE: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.DELETE:<span class="comment">// 文件被删除，如 rm</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"DELETE: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.DELETE_SELF:<span class="comment">// 自删除，即一个可执行文件在执行时删除自己</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"DELETE_SELF: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.MODIFY:<span class="comment">//文件被修改</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"MODIFY: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.MOVE_SELF:<span class="comment">//自移动，即一个可执行文件在执行时移动自己</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"MOVE_SELF: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.MOVED_FROM:<span class="comment">//文件被移走，如 mv</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"MOVED_FROM: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.MOVED_TO:<span class="comment">//文件被移来，如 mv、cp</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"MOVED_TO: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FileObserver.OPEN:<span class="comment">//文件被 open</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"OPEN: "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">//CLOSE ： 文件被关闭，等同于(IN_CLOSE_WRITE | IN_CLOSE_NOWRITE)</span></span><br><span class="line">                <span class="comment">//ALL_EVENTS ： 包括上面的所有事件</span></span><br><span class="line">                Log.i(<span class="string">"Zero"</span>, <span class="string">"DEFAULT("</span> + event + <span class="string">"): "</span> + path);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>开启ANR监控后台线程，检查是否ANR，通过检查标志位和时间差判断规定时间内是否执行完成，如果没执行完成则可能发生ANR卡住了，那么打印主线程堆栈信息并调用回调接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ANRWatchDog</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ANR"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> timeout = <span class="number">5000</span>; <span class="comment">// 超时阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreDebugger = <span class="keyword">true</span>; <span class="comment">// 开启开关</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ANRWatchDog sWatchdog;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler mainHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ANRChecker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mCompleted; <span class="comment">// 是否完成</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> mStartTime; <span class="comment">// 开始时间</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> executeTime = SystemClock.uptimeMillis(); <span class="comment">// 执行时间</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ANRWatchDog.<span class="keyword">this</span>) &#123;</span><br><span class="line">                mCompleted = <span class="keyword">true</span>;</span><br><span class="line">                executeTime = SystemClock.uptimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 设置是否完成标记</span></span><br><span class="line">            mCompleted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// 记录开始时间</span></span><br><span class="line">            mStartTime = SystemClock.uptimeMillis();</span><br><span class="line">            <span class="comment">// 结束任务，在主线程中重置完成标记，记录结束时间</span></span><br><span class="line">            mainHandler.postAtFrontOfQueue(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isBlocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !mCompleted || executeTime - mStartTime &gt;= timeout;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// anr监听接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ANRListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onAnrHappened</span><span class="params">(String stackTraceInfo)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ANRChecker anrChecker = <span class="keyword">new</span> ANRChecker();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ANRListener anrListener;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addANRListener</span><span class="params">(ANRListener listener)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.anrListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ANRWatchDog <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(sWatchdog == <span class="keyword">null</span>)&#123;</span><br><span class="line">            sWatchdog = <span class="keyword">new</span> ANRWatchDog();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sWatchdog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ANRWatchDog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"ANR-WatchDog-Thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置为后台线程</span></span><br><span class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); </span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 没有被打断停止 </span></span><br><span class="line">            <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="comment">// 检查是否anr</span></span><br><span class="line">                    anrChecker.schedule();</span><br><span class="line">                    <span class="keyword">long</span> waitTime = timeout;</span><br><span class="line">                    <span class="keyword">long</span> start = SystemClock.uptimeMillis();</span><br><span class="line">                    <span class="comment">// 防止假唤醒</span></span><br><span class="line">                    <span class="keyword">while</span> (waitTime &gt; <span class="number">0</span>) &#123; </span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 等待超时时长后检查标志位</span></span><br><span class="line">                            wait(waitTime);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            Log.w(TAG, e.toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 发现没有到阈值继续休眠</span></span><br><span class="line">                        waitTime = timeout - (SystemClock.uptimeMillis() - start);</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">// 如果没有阻塞跳过此次循环</span></span><br><span class="line">                    <span class="keyword">if</span> (!anrChecker.isBlocked()) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果开关关闭并且在调试跳过此次循环</span></span><br><span class="line">                <span class="keyword">if</span> (!ignoreDebugger &amp;&amp; Debug.isDebuggerConnected()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 打印堆栈信息并回调</span></span><br><span class="line">                String stackTraceInfo = getStackTraceInfo();</span><br><span class="line">                <span class="keyword">if</span> (anrListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    anrListener.onAnrHappened(stackTraceInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            anrListener = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取主线程堆栈信息返回字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getStackTraceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement stackTraceElement : Looper.getMainLooper().getThread().getStackTrace()) &#123;</span><br><span class="line">            stringBuilder</span><br><span class="line">                    .append(stackTraceElement.toString())</span><br><span class="line">                    .append(<span class="string">"\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/30/LazyLoad/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/10/30/LazyLoad/" class="post-title-link" itemprop="url">LazyLoad</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-10-30 23:45:01" itemprop="dateCreated datePublished" datetime="2020-10-30T23:45:01+08:00">2020-10-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-01 23:57:33" itemprop="dateModified" datetime="2020-11-01T23:57:33+08:00">2020-11-01</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近公司的项目做性能优化，正在折腾Fragment懒加载的东西，由于项目迁移到了AndroidX，懒加载方案和以前有所不同，不过总体来说代码量少了很多，正好可以对新老版本的懒加载方案做一个对比，下面是关于AndroidX前和AndroidX后的fragment懒加载方案总结</p>
<hr>
<h2 id="AndroidX之前采用旧懒加载方案"><a href="#AndroidX之前采用旧懒加载方案" class="headerlink" title="AndroidX之前采用旧懒加载方案"></a>AndroidX之前采用旧懒加载方案</h2><p>4步优化</p>
<ol>
<li>View已加载且fragment可见时懒加载</li>
</ol>
<ul>
<li>当onViewCreated()方法执行时，表明View已经加载完毕，isViewCreated标记为true,并调lazyLoad()方法</li>
<li>当setUserVisibleHint(boolean isVisibleToUser)执行时，isVisibleToUser为true并调lazyLoad()方法</li>
<li>在lazyLoad()方法双重标记判断，再进行停止一切/加载数据事件分发</li>
<li>定义抽象方法loadData()，子类重写进行加载数据<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isViewCreated = <span class="keyword">false</span>;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        isViewCreated  = <span class="keyword">true</span>; <span class="comment">// View已加载</span></span><br><span class="line">        <span class="comment">// 此时正好可见</span></span><br><span class="line">        <span class="keyword">if</span> (getUserVisibleHint()) &#123;</span><br><span class="line">            setUserVisibleHint(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rootView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUserVisibleHint(isVisibleToUser);</span><br><span class="line">        <span class="comment">// View已加载</span></span><br><span class="line">        <span class="keyword">if</span> (isViewCreated) &#123;</span><br><span class="line">            <span class="comment">// 根据当前可见状态分发事件</span></span><br><span class="line">            <span class="keyword">if</span> (isVisibleToUser) &#123;</span><br><span class="line">                dispatchUserVisibleHint(<span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatchUserVisibleHint(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> visibleState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (visibleState) &#123;</span><br><span class="line">            <span class="comment">// 加载网络数据请求</span></span><br><span class="line">            onFragmentLoad();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 停止网络数据请求</span></span><br><span class="line">            onFragmentLoadStop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentLoadStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        E(<span class="string">"onFragmentLoadStop"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFragmentLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        E(<span class="string">"onFragmentLoad"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li>记录上一次状态与当前状态比较，保证变化过程，状态未改变不需要分发事件</li>
</ol>
<ul>
<li>从可见到不可见，停止一切操作</li>
<li>从不可见到可见，加载数据操作<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isVisibleStateUP = <span class="keyword">false</span>; <span class="comment">// 记录上一次可见的状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUserVisibleHint(isVisibleToUser);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isViewCreated) &#123;</span><br><span class="line">            <span class="comment">// 当前可见且上一次不可见</span></span><br><span class="line">            <span class="keyword">if</span> (isVisibleToUser &amp;&amp; !isVisibleStateUP) &#123;</span><br><span class="line">                dispatchUserVisibleHint(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当前不可见且上一次可见</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!isVisibleToUser &amp;&amp; isVisibleStateUP)&#123;</span><br><span class="line">                dispatchUserVisibleHint(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> visibleState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isVisibleStateUP = visibleState;</span><br><span class="line">        <span class="keyword">if</span> (visibleState) &#123;</span><br><span class="line">            <span class="comment">// 加载网络数据请求</span></span><br><span class="line">            onFragmentLoad();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 停止网络数据请求</span></span><br><span class="line">            onFragmentLoadStop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>启动新的Activity没有分发事件</li>
</ol>
<ul>
<li>除了onCreate和setUserVisibleHint在onResume/onPause中也要分发事件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onResume();</span><br><span class="line">      <span class="comment">// 当前可见且上一次不可见</span></span><br><span class="line">      <span class="keyword">if</span> (getUserVisibleHint() &amp;&amp; !isVisibleStateUP) &#123;</span><br><span class="line">          dispatchUserVisibleHint(<span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onPause();</span><br><span class="line">      <span class="comment">// 当前不可见且上一次可见</span></span><br><span class="line">      <span class="keyword">if</span> (getUserVisibleHint() &amp;&amp; isVisibleStateUP) &#123;</span><br><span class="line">          dispatchUserVisibleHint(<span class="keyword">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>双重嵌套下子Fragment无法接收到事件<br>需判断父fragment是否可见，当前fragment可见，父fragment上一次不可见时手动遍历分发每个fragment停止一切操作/加载数据事件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断父fragment是否可见 </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isParentInvisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 获取父fragment</span></span><br><span class="line">     Fragment parentFragment = getParentFragment();</span><br><span class="line">     <span class="comment">// 父fragment是懒加载fragment的实例</span></span><br><span class="line">     <span class="keyword">if</span> (parentFragment <span class="keyword">instanceof</span> LazyFragment) &#123;</span><br><span class="line">         LazyFragment fragment = (LazyFragment) parentFragment;</span><br><span class="line">         <span class="comment">// 父fragment不可见</span></span><br><span class="line">         <span class="keyword">return</span> !fragment.isVisibleStateUP;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> visibleState)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.isVisibleStateUP = visibleState;</span><br><span class="line">     <span class="comment">// 当前fragment可见且父fragment不可见，不分发事件</span></span><br><span class="line">     <span class="keyword">if</span> (visibleState &amp;&amp; isParentInvisible()) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (visibleState) &#123;</span><br><span class="line">         onFragmentLoad();</span><br><span class="line">         <span class="comment">// 分发子fragment可见事件</span></span><br><span class="line">         dispatchChildVisibleState(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         onFragmentLoadStop();</span><br><span class="line">         <span class="comment">// 分发子fragment不可见事件</span></span><br><span class="line">         dispatchChildVisibleState(<span class="keyword">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchChildVisibleState</span><span class="params">(<span class="keyword">boolean</span> state)</span> </span>&#123;</span><br><span class="line">     FragmentManager fragmentManager = getChildFragmentManager();</span><br><span class="line">     List&lt;Fragment&gt; fragments = fragmentManager.getFragments();</span><br><span class="line">     <span class="keyword">if</span> (fragments != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">// 遍历子Fragment分发事件</span></span><br><span class="line">         <span class="keyword">for</span> (Fragment fragment: fragments) &#123;</span><br><span class="line">             <span class="comment">// fragment是懒加载实例未被隐藏且可见</span></span><br><span class="line">             <span class="keyword">if</span> (fragment <span class="keyword">instanceof</span> LazyFragment &amp;&amp;</span><br><span class="line">                     !fragment.isHidden() &amp;&amp;</span><br><span class="line">                     fragment.getUserVisibleHint()) &#123;</span><br><span class="line">                 ((LazyFragment5)fragment).dispatchUserVisibleHint(state);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="AndroidX之后采用新懒加载方案"><a href="#AndroidX之后采用新懒加载方案" class="headerlink" title="AndroidX之后采用新懒加载方案"></a>AndroidX之后采用新懒加载方案</h2>Google在Androidx在FragmentTransaction中增加了setMaxLifecycle方法控制Fragment 调用的最大的生命周期函数。该方法可以设置活跃状态下Fragment最大状态，如果该Fragment 超过了设置的最大状态，会强制将Fragment降级到正确的状态<h3 id="viewPager下设置adapter的behavior"><a href="#viewPager下设置adapter的behavior" class="headerlink" title="viewPager下设置adapter的behavior"></a>viewPager下设置adapter的behavior</h3>BEHAVIOR_SET_USER_VISIBLE_HINT:Fragment对用户可见状态发生改变时，setUserVisibleHint方法会被调用。<br>BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT:当前选中的Fragment在Lifecycle.State#RESUMED状态，其他不可见的 Fragment限制在Lifecycle.State#STARTED状态<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">open class <span class="title">FragmentLazyPagerAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fragmentManager: FragmentManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">private</span> val fragments: MutableList&lt;Fragment&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">private</span> val titles: MutableList&lt;String&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> : <span class="title">FragmentPagerAdapter</span><span class="params">(fragmentManager, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">getItem</span><span class="params">(position: Int)</span> </span>= fragments[position]</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">getCount</span><span class="params">()</span> </span>= fragments.size</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">getPageTitle</span><span class="params">(position: Int)</span> </span>= titles[position]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装懒加载fragment"><a href="#封装懒加载fragment" class="headerlink" title="封装懒加载fragment"></a>封装懒加载fragment</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">abstract class LazyFragment : Fragment() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否加载过标记</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isLoaded = <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume()</span><br><span class="line">        <span class="keyword">if</span> (!isLoaded) &#123;</span><br><span class="line">            lazyInit()</span><br><span class="line">            Log.d(TAG, <span class="string">"lazyInit:!!!!!!!"</span>)</span><br><span class="line">            isLoaded = <span class="keyword">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">        isLoaded = <span class="keyword">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> fun <span class="title">lazyInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="add-show-hide时设置最大生命周期-未使用viewPager"><a href="#add-show-hide时设置最大生命周期-未使用viewPager" class="headerlink" title="add/show/hide时设置最大生命周期(未使用viewPager)"></a>add/show/hide时设置最大生命周期(未使用viewPager)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化fragment</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> fun <span class="title">loadFragmentsTransaction</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    @IdRes containerViewId: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">    showPosition: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">    fragmentManager: FragmentManager,</span></span></span><br><span class="line"><span class="function"><span class="params">    vararg fragments: Fragment</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fragments.isNotEmpty()) &#123;</span><br><span class="line">        fragmentManager.beginTransaction().apply &#123;</span><br><span class="line">            <span class="keyword">for</span> (index in fragments.indices) &#123;</span><br><span class="line">                val fragment = fragments[index]</span><br><span class="line">                add(containerViewId, fragment, fragment.javaClass.name)</span><br><span class="line">                <span class="keyword">if</span> (showPosition == index) &#123;</span><br><span class="line">                    setMaxLifecycle(fragment, Lifecycle.State.RESUMED)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    hide(fragment)</span><br><span class="line">                    setMaxLifecycle(fragment, Lifecycle.State.STARTED)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;.commit()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">"fragments must not empty"</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示/隐藏fragment</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> fun <span class="title">showHideFragmentTransaction</span><span class="params">(fragmentManager: FragmentManager, showFragment: Fragment)</span> </span>&#123;</span><br><span class="line">    fragmentManager.beginTransaction().apply &#123;</span><br><span class="line">        show(showFragment)</span><br><span class="line">        setMaxLifecycle(showFragment, Lifecycle.State.RESUMED)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取其中所有的fragment,其他的fragment进行隐藏</span></span><br><span class="line">        val fragments = fragmentManager.fragments</span><br><span class="line">        <span class="keyword">for</span> (fragment in fragments) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fragment != showFragment) &#123;</span><br><span class="line">                hide(fragment)</span><br><span class="line">                setMaxLifecycle(fragment, Lifecycle.State.STARTED)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.commit()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fragment嵌套下的问题"><a href="#Fragment嵌套下的问题" class="headerlink" title="Fragment嵌套下的问题"></a>Fragment嵌套下的问题</h3>第一次初始化时，同级不可见的Fragment仍然要调生命周期方法，需增加Fragment是否可见的判断<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">abstract class LazyFragment : Fragment() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isLoaded = <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume()</span><br><span class="line">        <span class="comment">//增加Fragment是否可见的判断</span></span><br><span class="line">        <span class="keyword">if</span> (!isLoaded &amp;&amp; !isHidden) &#123;</span><br><span class="line">            lazyInit()</span><br><span class="line">            Log.d(TAG, <span class="string">"lazyInit:!!!!!!!"</span>)</span><br><span class="line">            isLoaded = <span class="keyword">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">        isLoaded = <span class="keyword">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> fun <span class="title">lazyInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="ViewPager2懒加载"><a href="#ViewPager2懒加载" class="headerlink" title="ViewPager2懒加载"></a>ViewPager2懒加载</h2>最新的ViewPager2默认就实现了懒加载，可以说不用任何处理</li>
</ol>
<p>但是ViewPager2中的RecyclerView可以缓存Fragment的数量是有限的，会造成Fragment的多次销毁和创建，也可通过setOffscreenPageLimit()方法设置预加载数量，再用AndroidX下的懒加载fragment方式去处理</p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/30/DexEncryption/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/09/30/DexEncryption/" class="post-title-link" itemprop="url">APK加固技术初探</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-09-30 21:44:18" itemprop="dateCreated datePublished" datetime="2020-09-30T21:44:18+08:00">2020-09-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-07 20:32:00" itemprop="dateModified" datetime="2020-10-07T20:32:00+08:00">2020-10-07</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>加密技术这块不仅涉及到很多JAVA基础，加密技术还涉及到很多Android底层知识，JAVA反射，JAVA IO，apk的启动流程，类的加载机制，dex文件的构造，APK打包的过程，而这些东西又正好是面试的常考点，是深入学习Android的必经之路，这次从原理入手，手写一个简单的加固框架，在这里做一个记录，如果有不对的地方欢迎指出和交流。</p>
<hr>
<p>加固的主要目的是为了防止反编译，代码遭到阅读和窃取甚至重新打包上架的事情发生，那反编译的过程是什么呢？</p>
<ol>
<li>zip解压apk</li>
<li>dex2jar把class.dex转成jar包</li>
<li>jd-gui看class文件源码</li>
</ol>
<h1 id="加固的原理"><a href="#加固的原理" class="headerlink" title="加固的原理"></a>加固的原理</h1><p>所以加固的关键是对dex文件用加密算法进行加密，防止可执行部分的源码被阅读，此时就需要一个壳程序负责解密原dex文件，然后再合并原dex和壳dex重新签名打包成新的apk，运行时壳程序解密，获得原dex重新手动类加载</p>
<h1 id="apk的打包流程"><a href="#apk的打包流程" class="headerlink" title="apk的打包流程"></a>apk的打包流程</h1><ol>
<li>APT工具处理资源文件（xml资源如布局、AndroidManifest），生成R.java</li>
<li>AIDL工具处理AIDL文件，生成相应的Java文件</li>
<li>Javac工具编译Java，生成Class文件</li>
<li>DX工具将Class文件转换成DEX文件</li>
<li>ApkBuilder工具将资源文件和DEX文件打包成APK</li>
<li>KeyStore签名APK</li>
<li>正式版APK用ZipAlign工具对齐</li>
</ol>
<h1 id="实现加固"><a href="#实现加固" class="headerlink" title="实现加固"></a>实现加固</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	</span><br><span class="line">    	<span class="keyword">byte</span>[] mainDexData; <span class="comment">// 存储源apk中的源dex文件 </span></span><br><span class="line">    	<span class="keyword">byte</span>[] aarData;     <span class="comment">// 存储壳中的壳dex文件</span></span><br><span class="line">    	<span class="keyword">byte</span>[] mergeDex;    <span class="comment">// 存储壳dex 和源dex 的合并的新dex文件</span></span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">// 删除source/apk/temp目录下所有文件</span></span><br><span class="line">    	File tempFileApk = <span class="keyword">new</span> File(<span class="string">"source/apk/temp"</span>);</span><br><span class="line">    	<span class="keyword">if</span> (tempFileApk.exists()) &#123;</span><br><span class="line">			File[]files = tempFileApk.listFiles();</span><br><span class="line">			<span class="keyword">for</span>(File file: files)&#123;</span><br><span class="line">				<span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">					file.delete();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="comment">// 删除source/aar/temp目录下所有文件</span></span><br><span class="line">    	File tempFileAar = <span class="keyword">new</span> File(<span class="string">"source/aar/temp"</span>);</span><br><span class="line">    	<span class="keyword">if</span> (tempFileAar.exists()) &#123;</span><br><span class="line">    		File[]files = tempFileAar.listFiles();</span><br><span class="line">			<span class="keyword">for</span>(File file: files)&#123;</span><br><span class="line">				<span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">					file.delete();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    	</span><br><span class="line">        <span class="comment">//第一步 处理原始apk 加密dex</span></span><br><span class="line">        AES.init(AES.DEFAULT_PWD);</span><br><span class="line">        <span class="comment">//待加固的apk</span></span><br><span class="line">        File apkFile = <span class="keyword">new</span> File(<span class="string">"source/apk/app-debug.apk"</span>);</span><br><span class="line">        <span class="comment">//创建临时文件夹</span></span><br><span class="line">        File newApkFile = <span class="keyword">new</span> File(apkFile.getParent() + File.separator + <span class="string">"temp"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!newApkFile.exists()) &#123;</span><br><span class="line">        	newApkFile.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//加密apk文件并写入到临时文件夹获取主dex</span></span><br><span class="line">        File mainDexFile = AES.encryptAPKFile(apkFile,newApkFile);</span><br><span class="line">        <span class="comment">//临时文件夹存在，重命名dex文件</span></span><br><span class="line">        <span class="keyword">if</span> (newApkFile.isDirectory()) &#123;</span><br><span class="line">			File[] listFiles = newApkFile.listFiles();</span><br><span class="line">			<span class="keyword">for</span> (File file : listFiles) &#123;</span><br><span class="line">				<span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (file.getName().endsWith(<span class="string">".dex"</span>)) &#123;</span><br><span class="line">						String name = file.getName();</span><br><span class="line">						System.out.println(<span class="string">"rename step1:"</span>+name);</span><br><span class="line">						<span class="keyword">int</span> cursor = name.indexOf(<span class="string">".dex"</span>);</span><br><span class="line">						String newName = file.getParent()+ File.separator + name.substring(<span class="number">0</span>, cursor) + <span class="string">"_"</span> + <span class="string">".dex"</span>;</span><br><span class="line">						System.out.println(<span class="string">"rename step2:"</span>+newName);</span><br><span class="line">						file.renameTo(<span class="keyword">new</span> File(newName));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第二步 处理aar 获得壳dex，其实这就是一个解密程序</span></span><br><span class="line">    	File aarFile = <span class="keyword">new</span> File(<span class="string">"source/aar/mylibrary-debug.aar"</span>);</span><br><span class="line">    	<span class="comment">// jar包转dex文件</span></span><br><span class="line">        File aarDex  = Dx.jar2Dex(aarFile);</span><br><span class="line">        <span class="comment">//读取dex文件为byte数组</span></span><br><span class="line">        aarData = Utils.getBytes(aarDex);   </span><br><span class="line">        <span class="comment">// 创建一个classes.dex文件</span></span><br><span class="line">        File tempMainDex = <span class="keyword">new</span> File(newApkFile.getPath() + File.separator + <span class="string">"classes.dex"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!tempMainDex.exists()) &#123;</span><br><span class="line">			tempMainDex.createNewFile();</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 写入byte数组到classes.dex文件</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(tempMainDex);</span><br><span class="line">        <span class="keyword">byte</span>[] fbytes = Utils.getBytes(aarDex);</span><br><span class="line">        fos.write(fbytes);</span><br><span class="line">        fos.flush();</span><br><span class="line">        fos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 第三步 打包签名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 创建未签名apk的文件夹</span></span><br><span class="line">        File unsignedApk = <span class="keyword">new</span> File(<span class="string">"result/apk-unsigned.apk"</span>);</span><br><span class="line">        unsignedApk.getParentFile().mkdirs();</span><br><span class="line">        <span class="comment">// 合并壳dex和加密dex，压缩newApkFile中的文件为unsignedApk</span></span><br><span class="line">        Zip.zip(newApkFile, unsignedApk);</span><br><span class="line">        <span class="comment">// 对unsignedApk文件签名输出签名后的文件apk-signed.apk</span></span><br><span class="line">        File signedApk = <span class="keyword">new</span> File(<span class="string">"result/apk-signed.apk"</span>);</span><br><span class="line">        Signature.signature(unsignedApk, signedApk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Zip压缩工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Zip</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解压文件到目标文件夹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unZip</span><span class="params">(File zip, File dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 删除已存在的目标文件夹</span></span><br><span class="line">            dir.delete();</span><br><span class="line">            <span class="comment">// 包装成压缩文件对象</span></span><br><span class="line">            ZipFile zipFile = <span class="keyword">new</span> ZipFile(zip);</span><br><span class="line">            <span class="comment">// 获取被压缩的所有文件</span></span><br><span class="line">            Enumeration&lt;? extends ZipEntry&gt; entries = zipFile.entries();</span><br><span class="line">            <span class="comment">// 遍历被压缩的文件</span></span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                ZipEntry zipEntry = entries.nextElement();</span><br><span class="line">                String name = zipEntry.getName();</span><br><span class="line">                <span class="comment">// 如果是META-INF/CERT.RSA，META-INF/CERT.SF，META-INF/MANIFEST.MF文件就跳过</span></span><br><span class="line">                <span class="keyword">if</span> (name.equals(<span class="string">"META-INF/CERT.RSA"</span>) || name.equals(<span class="string">"META-INF/CERT.SF"</span>) || name</span><br><span class="line">                        .equals(<span class="string">"META-INF/MANIFEST.MF"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果当前压缩文件不是一个文件夹，就输出到目标文件夹</span></span><br><span class="line">                <span class="keyword">if</span> (!zipEntry.isDirectory()) &#123;</span><br><span class="line">                    File file = <span class="keyword">new</span> File(dir, name);</span><br><span class="line">                    <span class="keyword">if</span> (!file.getParentFile().exists()) file.getParentFile().mkdirs();</span><br><span class="line">                    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                    InputStream is = zipFile.getInputStream(zipEntry);</span><br><span class="line">                    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="keyword">int</span> len;</span><br><span class="line">                    <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                    &#125;</span><br><span class="line">                    is.close();</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            zipFile.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zip</span><span class="params">(File dir, File zip)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 删除已存在的压缩文件</span></span><br><span class="line">        zip.delete();</span><br><span class="line">        <span class="comment">// 压缩文件并对输出文件做CRC32校验</span></span><br><span class="line">        CheckedOutputStream cos = <span class="keyword">new</span> CheckedOutputStream(<span class="keyword">new</span> FileOutputStream(</span><br><span class="line">                zip), <span class="keyword">new</span> CRC32());</span><br><span class="line">        ZipOutputStream zos = <span class="keyword">new</span> ZipOutputStream(cos);</span><br><span class="line">        compress(dir, zos, <span class="string">""</span>);</span><br><span class="line">        zos.flush();</span><br><span class="line">        zos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compress</span><span class="params">(File srcFile, ZipOutputStream zos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 String basePath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (srcFile.isDirectory()) &#123;</span><br><span class="line">            compressDir(srcFile, zos, basePath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            compressFile(srcFile, zos, basePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compressDir</span><span class="params">(File dir, ZipOutputStream zos,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    String basePath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File[] files = dir.listFiles();</span><br><span class="line">        <span class="comment">// 文件夹为空，构建空目录</span></span><br><span class="line">        <span class="keyword">if</span> (files.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            ZipEntry entry = <span class="keyword">new</span> ZipEntry(basePath + dir.getName() + <span class="string">"/"</span>);</span><br><span class="line">            zos.putNextEntry(entry);</span><br><span class="line">            zos.closeEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 递归压缩</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            compress(file, zos, basePath + dir.getName() + <span class="string">"/"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compressFile</span><span class="params">(File file, ZipOutputStream zos, String dir)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 当前文件路径</span></span><br><span class="line">        String dirName = dir + file.getName();</span><br><span class="line">        <span class="comment">// 文件新名称拼接</span></span><br><span class="line">        String[] dirNameNew = dirName.split(<span class="string">"/"</span>);</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dirNameNew.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; dirNameNew.length; i++) &#123;</span><br><span class="line">                buffer.append(<span class="string">"/"</span>);</span><br><span class="line">                buffer.append(dirNameNew[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            buffer.append(<span class="string">"/"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建压缩文件并写入数据</span></span><br><span class="line">        ZipEntry entry = <span class="keyword">new</span> ZipEntry(buffer.toString().substring(<span class="number">1</span>));</span><br><span class="line">        zos.putNextEntry(entry);</span><br><span class="line">        BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">                file));</span><br><span class="line">        <span class="keyword">int</span> count;</span><br><span class="line">        <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((count = bis.read(data, <span class="number">0</span>, <span class="number">1024</span>)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            zos.write(data, <span class="number">0</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">        bis.close();</span><br><span class="line">        zos.closeEntry();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AES对称加密工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AES</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 默认密码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PWD = <span class="string">"abcdefghijklmnop"</span>;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String algorithmStr = <span class="string">"AES/ECB/PKCS5Padding"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cipher encryptCipher;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cipher decryptCipher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">// 创建加密对象,ECB模式,PKCS5Padding填充方式</span></span><br><span class="line">            encryptCipher = Cipher.getInstance(algorithmStr);</span><br><span class="line">            <span class="comment">// 创建解密对象</span></span><br><span class="line">            decryptCipher = Cipher.getInstance(algorithmStr);</span><br><span class="line">            <span class="comment">// 获取密码字节数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] keyStr = password.getBytes();</span><br><span class="line">            <span class="comment">// 生成加密密钥</span></span><br><span class="line">            SecretKeySpec key = <span class="keyword">new</span> SecretKeySpec(keyStr, <span class="string">"AES"</span>);</span><br><span class="line">            <span class="comment">// 初始化加密对象</span></span><br><span class="line">            encryptCipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">            <span class="comment">// 初始化解密对象</span></span><br><span class="line">            decryptCipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeyException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> srcAPKfile  源文件所在位置</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dstApkFile  目标文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span>             加密后的新dex 文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">encryptAPKFile</span><span class="params">(File srcAPKfile, File dstApkFile)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (srcAPKfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">        	System.out.println(<span class="string">"encryptAPKFile :srcAPKfile null"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解压源文件到目标文件夹</span></span><br><span class="line">        Zip.unZip(srcAPKfile, dstApkFile);</span><br><span class="line">        <span class="comment">// 获得目标文件夹所有的dex</span></span><br><span class="line">        File[] dexFiles = dstApkFile.listFiles(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> s.endsWith(<span class="string">".dex"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        File mainDexFile = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] mainDexData = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 遍历所有的dex文件，找到并记录主dex文件并获得加密后的字节数组</span></span><br><span class="line">        <span class="keyword">for</span> (File dexFile: dexFiles) &#123;</span><br><span class="line">        	<span class="comment">// 获取dex的字节数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] buffer = Utils.getBytes(dexFile);</span><br><span class="line">            <span class="comment">// 加密后的字节数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] encryptBytes = AES.encrypt(buffer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dexFile.getName().endsWith(<span class="string">"classes.dex"</span>)) &#123;</span><br><span class="line">                mainDexData = encryptBytes;</span><br><span class="line">                mainDexFile = dexFile;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">//用加密后的字节数组替换原来的数据</span></span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(dexFile);</span><br><span class="line">            fos.write(encryptBytes);</span><br><span class="line">            fos.flush();</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回主dex文件</span></span><br><span class="line">        <span class="keyword">return</span> mainDexFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对字节数组加密返回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] content) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] result = encryptCipher.doFinal(content);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalBlockSizeException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字节数组解密返回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] content) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] result = decryptCipher.doFinal(content);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalBlockSizeException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dx转换工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dx</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">jar2Dex</span><span class="params">(File aarFile)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建临时文件夹</span></span><br><span class="line">        File fakeDex = <span class="keyword">new</span> File(aarFile.getParent() + File.separator + <span class="string">"temp"</span>);</span><br><span class="line">        <span class="comment">// 解压aar到临时文件夹下</span></span><br><span class="line">        Zip.unZip(aarFile, fakeDex);</span><br><span class="line">        <span class="comment">// 过滤找到classes.jar</span></span><br><span class="line">        File[] files = fakeDex.listFiles(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file, String s)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> s.equals(<span class="string">"classes.jar"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// aar文件不存在抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (files == <span class="keyword">null</span> || files.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the aar is invalidate"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将classes.jar转classes.dex</span></span><br><span class="line">        File classes_jar = files[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// 创建classes.dex文件</span></span><br><span class="line">        File aarDex = <span class="keyword">new</span> File(classes_jar.getParentFile(), <span class="string">"classes.dex"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用android tools里面的dx.bat，调windows下的命令</span></span><br><span class="line">        Dx.dxCommand(aarDex, classes_jar);</span><br><span class="line">        <span class="keyword">return</span> aarDex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dxCommand</span><span class="params">(File aarDex, File classes_jar)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        Process process = runtime.exec(<span class="string">"cmd.exe /C dx --dex --output="</span> + aarDex.getAbsolutePath() + <span class="string">" "</span> +</span><br><span class="line">                classes_jar.getAbsolutePath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            process.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 转换失败，输出错误到文件并抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (process.exitValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        	InputStream inputStream = process.getErrorStream();</span><br><span class="line">        	<span class="keyword">int</span> len;</span><br><span class="line">        	<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        	ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        	<span class="keyword">while</span>((len=inputStream.read(buffer)) != -<span class="number">1</span>)&#123;</span><br><span class="line">        		bos.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">        	&#125;</span><br><span class="line">        	System.out.println(<span class="keyword">new</span> String(bos.toByteArray(),<span class="string">"GBK"</span>));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"dx run failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        process.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>签名工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Signature</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">signature</span><span class="params">(File unsignedApk, File signedApk)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 执行windows下的签名命令</span></span><br><span class="line">        String cmd[] = &#123;<span class="string">"cmd.exe"</span>, <span class="string">"/C "</span>,<span class="string">"jarsigner"</span>,  <span class="string">"-sigalg"</span>, <span class="string">"MD5withRSA"</span>,</span><br><span class="line">                <span class="string">"-digestalg"</span>, <span class="string">"SHA1"</span>,</span><br><span class="line">                <span class="string">"-keystore"</span>, <span class="string">"C:/Users/allen/.android/debug.keystore"</span>,</span><br><span class="line">                <span class="string">"-storepass"</span>, <span class="string">"android"</span>,</span><br><span class="line">                <span class="string">"-keypass"</span>, <span class="string">"android"</span>,</span><br><span class="line">                <span class="string">"-signedjar"</span>, signedApk.getAbsolutePath(),</span><br><span class="line">                unsignedApk.getAbsolutePath(),</span><br><span class="line">                <span class="string">"androiddebugkey"</span>&#125;;</span><br><span class="line">        Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        System.out.println(<span class="string">"start sign"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> waitResult = process.waitFor();</span><br><span class="line">            System.out.println(<span class="string">"waitResult: "</span> + waitResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"process.exitValue() "</span> + process.exitValue() );</span><br><span class="line">        <span class="comment">// 执行失败，输出错误到文件并抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (process.exitValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        	InputStream inputStream = process.getErrorStream();</span><br><span class="line">        	<span class="keyword">int</span> len;</span><br><span class="line">        	<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        	ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        	<span class="keyword">while</span>((len=inputStream.read(buffer)) != -<span class="number">1</span>)&#123;</span><br><span class="line">        		bos.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">        	&#125;</span><br><span class="line">        	System.out.println(<span class="keyword">new</span> String(bos.toByteArray(),<span class="string">"GBK"</span>));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"sign run failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"finish signed"</span>);</span><br><span class="line">        process.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="实现壳程序"><a href="#实现壳程序" class="headerlink" title="实现壳程序"></a>实现壳程序</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ShellApplication"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getPassword</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"abcdefghijklmnop"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        <span class="comment">// 初始化AES加密</span></span><br><span class="line">        AES.init(getPassword());</span><br><span class="line">        <span class="comment">// 待解密文件路径data/data/包名/files/fake_apk/</span></span><br><span class="line">        File apkFile = <span class="keyword">new</span> File(getApplicationInfo().sourceDir);</span><br><span class="line">        File unZipFile = getDir(<span class="string">"fake_apk"</span>, MODE_PRIVATE);</span><br><span class="line">        <span class="comment">// 待解密的文件目录data/data/包名/files/fake_apk/app</span></span><br><span class="line">        File app = <span class="keyword">new</span> File(unZipFile, <span class="string">"app"</span>);</span><br><span class="line">        <span class="comment">// 如果不存在待解密文件目录，解压apk</span></span><br><span class="line">        <span class="keyword">if</span> (!app.exists()) &#123;</span><br><span class="line">            Zip.unZip(apkFile, app);</span><br><span class="line">            <span class="comment">// 过滤不为classes.dex的.dex文件，对读取的字节数组解密写出到文件</span></span><br><span class="line">            File[] files = app.listFiles();</span><br><span class="line">            <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                String name = file.getName();</span><br><span class="line">                <span class="keyword">if</span> (name.equals(<span class="string">"classes.dex"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.endsWith(<span class="string">".dex"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">byte</span>[] bytes = getBytes(file);</span><br><span class="line">                            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                            <span class="keyword">byte</span>[] decrypt = AES.decrypt(bytes);</span><br><span class="line">                            fos.write(decrypt);</span><br><span class="line">                            fos.flush();</span><br><span class="line">                            fos.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取待解密的文件目录.dex文件列表</span></span><br><span class="line">        List list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Log.d(<span class="string">"FAKE"</span>, Arrays.toString(app.listFiles()));</span><br><span class="line">        <span class="keyword">for</span> (File file : app.listFiles()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.getName().endsWith(<span class="string">".dex"</span>)) &#123;</span><br><span class="line">                list.add(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">"FAKE"</span>, list.toString());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            V19.install(getClassLoader(), list, unZipFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射获取对象某个变量的值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Field <span class="title">findField</span><span class="params">(Object instance, String name)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">        Class clazz = instance.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Field e = clazz.getDeclaredField(name);</span><br><span class="line">                <span class="keyword">if</span> (!e.isAccessible()) &#123;</span><br><span class="line">                    e.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var4) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchFieldException(<span class="string">"Field "</span> + name + <span class="string">" not found in "</span> + instance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射获取对象的某个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Method <span class="title">findMethod</span><span class="params">(Object instance, String name, Class... parameterTypes)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">        Class clazz = instance.getClass();</span><br><span class="line">        <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Method e = clazz.getDeclaredMethod(name, parameterTypes);</span><br><span class="line">                <span class="keyword">if</span> (!e.isAccessible()) &#123;</span><br><span class="line">                    e.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">"Method "</span> + name + <span class="string">" with parameters "</span> + Arrays.asList</span><br><span class="line">                (parameterTypes) + <span class="string">" not found in "</span> + instance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展某个对象的某个变量数组</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expandFieldArray</span><span class="params">(Object instance, String fieldName, Object[]</span></span></span><br><span class="line"><span class="function"><span class="params">            extraElements)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException,</span></span><br><span class="line"><span class="function">            IllegalAccessException </span>&#123;</span><br><span class="line">        Field jlrField = findField(instance, fieldName);</span><br><span class="line">        Object[] original = (Object[]) ((Object[]) jlrField.get(instance));</span><br><span class="line">        Object[] combined = (Object[]) ((Object[]) Array.newInstance(original.getClass()</span><br><span class="line">                .getComponentType(), original.length + extraElements.length));</span><br><span class="line">        System.arraycopy(original, <span class="number">0</span>, combined, <span class="number">0</span>, original.length);</span><br><span class="line">        System.arraycopy(extraElements, <span class="number">0</span>, combined, original.length, extraElements.length);</span><br><span class="line">        jlrField.set(instance, combined);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态加载类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">V19</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">V19</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    File optimizedDirectory)</span> <span class="keyword">throws</span> IllegalArgumentException,</span></span><br><span class="line"><span class="function">                IllegalAccessException, NoSuchFieldException, InvocationTargetException,</span></span><br><span class="line"><span class="function">                NoSuchMethodException </span>&#123;</span><br><span class="line">            <span class="comment">// 获取ClassLoader对象的pathList变量的值</span></span><br><span class="line">            Field pathListField = findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">            Object dexPathList = pathListField.get(loader);</span><br><span class="line">            ArrayList suppressedExceptions = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            Log.d(TAG, <span class="string">"Build.VERSION.SDK_INT "</span> + Build.VERSION.SDK_INT);</span><br><span class="line">            <span class="comment">// 根据当前SDK版本动态批量加载类</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">                expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makePathElements(dexPathList, <span class="keyword">new</span></span><br><span class="line">                                ArrayList(additionalClassPathEntries), optimizedDirectory,</span><br><span class="line">                        suppressedExceptions));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makeDexElements(dexPathList, <span class="keyword">new</span></span><br><span class="line">                                ArrayList(additionalClassPathEntries), optimizedDirectory,</span><br><span class="line">                        suppressedExceptions));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果有异常，遍历打印</span></span><br><span class="line">            <span class="keyword">if</span> (suppressedExceptions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Iterator suppressedExceptionsField = suppressedExceptions.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (suppressedExceptionsField.hasNext()) &#123;</span><br><span class="line">                    IOException dexElementsSuppressedExceptions = (IOException)</span><br><span class="line">                            suppressedExceptionsField.next();</span><br><span class="line">                    Log.w(<span class="string">"MultiDex"</span>, <span class="string">"Exception in makeDexElement"</span>,</span><br><span class="line">                            dexElementsSuppressedExceptions);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取dexElementsSuppressedExceptions变量的值</span></span><br><span class="line">                Field suppressedExceptionsField1 = findField(loader,</span><br><span class="line">                        <span class="string">"dexElementsSuppressedExceptions"</span>);</span><br><span class="line">                IOException[] dexElementsSuppressedExceptions1 = (IOException[]) ((IOException[])</span><br><span class="line">                        suppressedExceptionsField1.get(loader));</span><br><span class="line">                <span class="comment">// 如果值为空，赋值为异常数组</span></span><br><span class="line">                <span class="keyword">if</span> (dexElementsSuppressedExceptions1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    dexElementsSuppressedExceptions1 = (IOException[]) suppressedExceptions</span><br><span class="line">                            .toArray(<span class="keyword">new</span> IOException[suppressedExceptions.size()]);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则扩展异常数组，合并dexElementsSuppressedExceptions并重新赋值</span></span><br><span class="line">                    IOException[] combined = <span class="keyword">new</span> IOException[suppressedExceptions.size() +</span><br><span class="line">                            dexElementsSuppressedExceptions1.length];</span><br><span class="line">                    suppressedExceptions.toArray(combined);</span><br><span class="line">                    System.arraycopy(dexElementsSuppressedExceptions1, <span class="number">0</span>, combined,</span><br><span class="line">                            suppressedExceptions.size(), dexElementsSuppressedExceptions1.length);</span><br><span class="line">                    dexElementsSuppressedExceptions1 = combined;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                suppressedExceptionsField1.set(loader, dexElementsSuppressedExceptions1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用dexPathList对象的makeDexElements方法</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Object[] makeDexElements(Object dexPathList,</span><br><span class="line">                                                ArrayList&lt;File&gt; files, File</span><br><span class="line">                                                        optimizedDirectory,</span><br><span class="line">                                                ArrayList&lt;IOException&gt; suppressedExceptions) <span class="keyword">throws</span></span><br><span class="line">                IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">                Method makeDexElements = findMethod(dexPathList, <span class="string">"makeDexElements"</span>, <span class="keyword">new</span></span><br><span class="line">                        Class[]&#123;ArrayList.class, File.class, ArrayList.class&#125;);</span><br><span class="line">                <span class="keyword">return</span> ((Object[]) makeDexElements.invoke(dexPathList, <span class="keyword">new</span> Object[]&#123;files,</span><br><span class="line">                        optimizedDirectory, suppressedExceptions&#125;));</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 调用dexPathList对象的makePathElements方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object[] makePathElements(</span><br><span class="line">            Object dexPathList, ArrayList&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            ArrayList&lt;IOException&gt; suppressedExceptions)</span><br><span class="line">            <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="comment">// 查找返回类型为List的makePathElements方法</span></span><br><span class="line">        Method makePathElements;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            makePathElements = findMethod(dexPathList, <span class="string">"makePathElements"</span>, List.class, File.class,</span><br><span class="line">                    List.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"NoSuchMethodException: makePathElements(List,File,List) failure"</span>);</span><br><span class="line">            <span class="comment">// 查找返回类型为ArrayList的makePathElements方法</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                makePathElements = findMethod(dexPathList, <span class="string">"makePathElements"</span>, ArrayList.class, File.class, ArrayList.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e1) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"NoSuchMethodException: makeDexElements(ArrayList,File,ArrayList) failure"</span>);</span><br><span class="line">                <span class="comment">// 调用dexPathList对象的makeDexElements方法</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"NoSuchMethodException: try use v19 instead"</span>);</span><br><span class="line">                    <span class="keyword">return</span> V19.makeDexElements(dexPathList, files, optimizedDirectory, suppressedExceptions);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e2) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"NoSuchMethodException: makeDexElements(List,File,List) failure"</span>);</span><br><span class="line">                    <span class="keyword">throw</span> e2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (Object[]) makePathElements.invoke(dexPathList, files, optimizedDirectory, suppressedExceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getBytes(File file) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        RandomAccessFile r = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"r"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) r.length()];</span><br><span class="line">        r.readFully(buffer);</span><br><span class="line">        r.close();</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/22/GradlePlugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/22/GradlePlugin/" class="post-title-link" itemprop="url">Gradle插件自定义</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-08-22 15:08:59" itemprop="dateCreated datePublished" datetime="2020-08-22T15:08:59+08:00">2020-08-22</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-07 20:41:49" itemprop="dateModified" datetime="2020-10-07T20:41:49+08:00">2020-10-07</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>国外的疫情越来越严重，不排除有卷土重来的可能，今年突如其来的疫情影响着每一个人，就业形势也不容乐观，不管是企业还是个人都要共同面对这次生存考验，今年的毕业生也是非常的不容易，不管外界如何变化，持续强化自己的专业技能永远是立身之本，提升自己的核心竞争力永远是生存之道。最近学了一些自定义gradle插件相关的知识，开发了自动上传fir并发送钉钉消息的gradle插件，提升了个人和团队的工作效率，在此记录并分享。</p>
<hr>
<p>由于公司当前的开发流程尚未用到Jenkins这类在线的自动化构建平台，开发流程仍然是开发者本地打包再上传fir托管平台并发送上传完成的消息到钉钉群里，再@相关的测试人员提醒可进行测试，这一系列流程化的操作显得过于繁琐。作为Android开发掌握groovy这门语言也是有必要的，毕竟这是Android studio的构建脚本语言且语法与java相似，完全可以利用构建脚本实现打包后自动上传到fir托管平台，再利用自定义钉钉机器人的官方api发送钉钉消息给相关的测试人员，解放双手，自动化这一系列的流程操作来提升工作效率，减少加班的可能，打包/上传/发消息这段时间喝杯咖啡放松一下不是更好吗？我决定把这个插件打包上传到JitPack分享给团队和网络上的其他人，因为帮更多的人提升工作效率确实是一件很cool的事情</p>
<h1 id="实现自定义Gradle插件的三种方式"><a href="#实现自定义Gradle插件的三种方式" class="headerlink" title="实现自定义Gradle插件的三种方式"></a>实现自定义Gradle插件的三种方式</h1><h2 id="app的gradle文件中定义"><a href="#app的gradle文件中定义" class="headerlink" title="app的gradle文件中定义"></a>app的gradle文件中定义</h2><ol>
<li>直接修改app的gradle文件，继承gradle的Plugin类，定义一个自定义插件的实现类，重写apply方法完成插件逻辑<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> PluginImpl</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginImpl</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt;&#123;</span></span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project)&#123;</span><br><span class="line">        println(<span class="string">"hello Plugin"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
优点：方便调试<br>缺点：跟app工程代码混在一起，无法给其它项目使用<h2 id="buildSrc目录定义"><a href="#buildSrc目录定义" class="headerlink" title="buildSrc目录定义"></a>buildSrc目录定义</h2>在工程目录下，新建buildSrc目录，在该目录下开发<br>新建文件夹src/main/groovy/xxx/xxx/xxx，其中xxx/xxx/xxx是包名，在这个目录下自定义gradle插件类PluginImpl<br>新建文件夹resource/META-INF/gradle-plugins，在这个目录下新建文件xxx.xxx.xxx.properties，声明插件实现类<code>implementation-class=xxx.xxx.xxx.PluginImpl</code><br><img src="/images/GradlePlugin1.png" alt="效果图"><br>优点：方便调试，与app工程分离<br>缺点：无法给其它项目使用</li>
</ol>
<h2 id="新增插件lib定义"><a href="#新增插件lib定义" class="headerlink" title="新增插件lib定义"></a>新增插件lib定义</h2><p>新建一个gradle插件的lib库，删除其它的所有文件，保持项目结构与buildSrc目录一样，在这个lib库下开发<br>优点：与app工程分离，可打包上传maven，在其它项目中引用并分享给其他人<br>缺点：调试稍微麻烦，需发布到本地仓库<br>以上三种方式最好的是第三种，与app工程分离，可发布到本地maven仓库下调试，也可以打包插件上传到私有的maven仓库或者公有maven仓库如JitPack分享给其他人</p>
<h1 id="定义插件参数"><a href="#定义插件参数" class="headerlink" title="定义插件参数"></a>定义插件参数</h1><h2 id="定义fir配置参数"><a href="#定义fir配置参数" class="headerlink" title="定义fir配置参数"></a>定义fir配置参数</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.inject.Inject</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirExtension</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> String appName <span class="comment">//app名称</span></span><br><span class="line">    <span class="keyword">private</span> String iconPath <span class="comment">//图标路径</span></span><br><span class="line">    <span class="keyword">private</span> String token <span class="comment">//fir设置中的上传token</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">public</span> FirExtension() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getAppName() &#123;</span><br><span class="line">        <span class="keyword">return</span> appName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setAppName(String appName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.appName = appName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getIconPath() &#123;</span><br><span class="line">        <span class="keyword">return</span> iconPath</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setIconPath(String iconPath) &#123;</span><br><span class="line">        <span class="keyword">this</span>.iconPath = iconPath</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getToken() &#123;</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setToken(String token) &#123;</span><br><span class="line">        <span class="keyword">this</span>.token = token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"FirExtension&#123;"</span> +</span><br><span class="line">                <span class="string">"appName='"</span> + appName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", iconPath='"</span> + iconPath + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", token='"</span> + token + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定义钉钉配置参数"><a href="#定义钉钉配置参数" class="headerlink" title="定义钉钉配置参数"></a>定义钉钉配置参数</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.inject.Inject</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DingTalkExtension</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> String webHook <span class="comment">// 钉钉自定义机器人的webhook</span></span><br><span class="line">    <span class="keyword">private</span> String title <span class="comment">// 消息标题</span></span><br><span class="line">    <span class="keyword">private</span> String content <span class="comment">// 内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isAtAll <span class="comment">// 是否@所有人</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; atMobiles <span class="comment">// 手机号列表，单独@某些人</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">public</span> DingTalkExtension() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getWebHook() &#123;</span><br><span class="line">        <span class="keyword">return</span> webHook</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setWebHook(String webHook) &#123;</span><br><span class="line">        <span class="keyword">this</span>.webHook = webHook</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getTitle() &#123;</span><br><span class="line">        <span class="keyword">return</span> title</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setTitle(String title) &#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String getContent() &#123;</span><br><span class="line">        <span class="keyword">return</span> content</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setContent(String content) &#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> getIsAtAll() &#123;</span><br><span class="line">        <span class="keyword">return</span> isAtAll</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setIsAtAll(<span class="keyword">boolean</span> isAtAll) &#123;</span><br><span class="line">        <span class="keyword">this</span>.isAtAll = isAtAll</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; getAtMobiles() &#123;</span><br><span class="line">        <span class="keyword">return</span> atMobiles</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setAtMobiles(List&lt;String&gt; atMobiles) &#123;</span><br><span class="line">        <span class="keyword">this</span>.atMobiles = atMobiles</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DingTalkExtension&#123;"</span> +</span><br><span class="line">                <span class="string">"webHook='"</span> + webHook + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", title='"</span> + title + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", content='"</span> + content + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", isAtAll="</span> + isAtAll +</span><br><span class="line">                <span class="string">", atMobiles="</span> + atMobiles +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义插件参数-1"><a href="#定义插件参数-1" class="headerlink" title="定义插件参数"></a>定义插件参数</h2><ul>
<li>结合上面两类参数配置<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Action</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.model.ObjectFactory</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadApkPluginExtension</span> &#123;</span></span><br><span class="line">    FirExtension firExtension</span><br><span class="line">    DingTalkExtension dingTalkExtension</span><br><span class="line">    <span class="keyword">public</span> UploadApkPluginExtension(ObjectFactory objectFactory) &#123;</span><br><span class="line">        firExtension = objectFactory.newInstance(FirExtension.<span class="keyword">class</span>)</span><br><span class="line">        dingTalkExtension = objectFactory.newInstance(DingTalkExtension.<span class="keyword">class</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> fir(Action&lt;FirExtension&gt; action) &#123;</span><br><span class="line">        action.execute(firExtension)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> dingTalk(Action&lt;DingTalkExtension&gt; action)&#123;</span><br><span class="line">        action.execute(dingTalkExtension)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="插件逻辑"><a href="#插件逻辑" class="headerlink" title="插件逻辑"></a>插件逻辑</h1>groovy中我们仍然可以使用okhttp，Gson这类Android中常用的开源框架来实现网络请求，Json序列化/反序列化相关的逻辑，封装网络请求工具类，最后在自定义Plugin中调用这个工具类完成自动化<h2 id="引入开源库"><a href="#引入开源库" class="headerlink" title="引入开源库"></a>引入开源库</h2>修改插件lib中的gradle文件<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'java-library'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'groovy'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'maven'</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">    implementation gradleApi()<span class="comment">//gradle sdk</span></span><br><span class="line">    implementation localGroovy()<span class="comment">//groovy sdk</span></span><br><span class="line">    implementation <span class="string">'com.squareup.okhttp3:okhttp:4.7.2'</span></span><br><span class="line">    implementation <span class="string">'com.google.code.gson:gson:2.8.6'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="网络请求工具类"><a href="#网络请求工具类" class="headerlink" title="网络请求工具类"></a>网络请求工具类</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson</span><br><span class="line"><span class="keyword">import</span> okhttp3.*</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpUtil</span>&#123;</span></span><br><span class="line">    OkHttpClient okHttpClient</span><br><span class="line">    Gson gson</span><br><span class="line">    DingTalk dingTalk <span class="comment">// 序列化钉钉消息工具类</span></span><br><span class="line">    <span class="keyword">public</span> OkHttpUtil()&#123;</span><br><span class="line">        okHttpClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">                .connectTimeout(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">60</span>, TimeUnit.SECONDS).build()</span><br><span class="line">        gson = <span class="keyword">new</span> Gson()</span><br><span class="line">        dingTalk = <span class="keyword">new</span> DingTalk()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取fir上传证书</span></span><br><span class="line">    BundleApp getCert(String appPackage, String apiTokenFir)&#123;</span><br><span class="line"></span><br><span class="line">        FormBody.Builder build = <span class="keyword">new</span> FormBody.Builder()</span><br><span class="line">        build.add(<span class="string">"bundle_id"</span>, appPackage)</span><br><span class="line">        build.add(<span class="string">"api_token"</span>, apiTokenFir)</span><br><span class="line">        build.add(<span class="string">"type"</span>, <span class="string">"android"</span>)</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder().url(<span class="string">"http://api.bq04.com/apps"</span>).post(build.build()).build()</span><br><span class="line">        Response response = okHttpClient.newCall(request).execute()</span><br><span class="line">        String result = response.body.string()</span><br><span class="line">        <span class="keyword">return</span> gson.fromJson(result, BundleApp.<span class="keyword">class</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传apk到fir</span></span><br><span class="line">    String uploadApk(String apkPath,String key,String token,String appName,String appVersion,String appBuild,String fileName,String upload_url) &#123;</span><br><span class="line">        RequestBody fileBody = RequestBody.create(MediaType.parse(<span class="string">"application/octet-stream"</span>), <span class="keyword">new</span> File(apkPath))</span><br><span class="line">        MultipartBody body = <span class="keyword">new</span> MultipartBody.Builder()</span><br><span class="line">                .setType(MediaType.parse(<span class="string">"multipart/form-data"</span>))</span><br><span class="line">                .addFormDataPart(<span class="string">"key"</span>, key)</span><br><span class="line">                .addFormDataPart(<span class="string">"token"</span>, token)</span><br><span class="line">                .addFormDataPart(<span class="string">"x:name"</span>, appName)</span><br><span class="line">                .addFormDataPart(<span class="string">"x:version"</span>, appVersion)</span><br><span class="line">                .addFormDataPart(<span class="string">"x:build"</span>, appBuild)</span><br><span class="line">                .addFormDataPart(<span class="string">"file"</span>, fileName, fileBody)</span><br><span class="line">                .build()</span><br><span class="line">        Request requestApk = <span class="keyword">new</span> Request.Builder().url(upload_url).post(body).build()</span><br><span class="line"></span><br><span class="line">        Response responseApk = okHttpClient.newCall(requestApk).execute()</span><br><span class="line">        <span class="keyword">return</span> responseApk.body.string()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传icon到fir</span></span><br><span class="line">    String uploadIcon(String apkIconPath,String keyIcon,String tokenIcon,String upload_urlIcon)&#123;</span><br><span class="line">        RequestBody fileBodyIcon = RequestBody.create(MediaType.parse(<span class="string">"application/octet-stream"</span>),<span class="keyword">new</span> File(apkIconPath))</span><br><span class="line">        MultipartBody bodyIcon = <span class="keyword">new</span> MultipartBody.Builder()</span><br><span class="line">                .setType(MediaType.parse(<span class="string">"multipart/form-data"</span>))</span><br><span class="line">                .addFormDataPart(<span class="string">"key"</span>, keyIcon)</span><br><span class="line">                .addFormDataPart(<span class="string">"token"</span>, tokenIcon)</span><br><span class="line">                .addFormDataPart(<span class="string">"file"</span>, <span class="string">"icon.png"</span>, fileBodyIcon)</span><br><span class="line">                .build()</span><br><span class="line">        Request requestIcon = <span class="keyword">new</span> Request.Builder().url(upload_urlIcon).post(bodyIcon).build()</span><br><span class="line">        Response responseIcon = okHttpClient.newCall(requestIcon).execute()</span><br><span class="line">        <span class="keyword">return</span> responseIcon.body.string()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ApkInfo getApkUrl(String appPackage, String apiTokenFir) &#123;</span><br><span class="line">        <span class="comment">// 获取成功连接</span></span><br><span class="line">        String queryurl =</span><br><span class="line">                <span class="string">"http://api.bq04.com/apps/latest/$appPackage?api_token=$apiTokenFir&amp;type=android"</span></span><br><span class="line">        Request requestUrl = <span class="keyword">new</span> Request.Builder().url(queryurl).get().build()</span><br><span class="line">        Response responseUrl = okHttpClient.newCall(requestUrl).execute()</span><br><span class="line">        String result = responseUrl.body.string()</span><br><span class="line">        <span class="keyword">return</span> gson.fromJson(result,ApkInfo.<span class="keyword">class</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送钉钉链接消息</span></span><br><span class="line">    <span class="keyword">void</span> sendDingTalkLink(String text,String title,String url,String webHook)&#123;</span><br><span class="line">        RequestBody linkBody = FormBody.create(MediaType.parse(<span class="string">"application/json; charset=utf-8"</span>)</span><br><span class="line">                , dingTalk.createLinkMsg(text,title,url))</span><br><span class="line">        Request linkDingTalk = <span class="keyword">new</span> Request.Builder().url(webHook)</span><br><span class="line">                .post(linkBody).build()</span><br><span class="line">        Response responseLink = okHttpClient.newCall(linkDingTalk).execute()</span><br><span class="line">        String result = responseLink.body.string()</span><br><span class="line">        println(<span class="string">"已发送钉钉链接:$result"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送钉钉文本消息</span></span><br><span class="line">    <span class="keyword">void</span> sendDingTalkMsg(String text,String webHook,<span class="keyword">boolean</span> isAtAll,List&lt;String&gt; atMobiles)&#123;</span><br><span class="line">        RequestBody textBody = FormBody.create(MediaType.parse(<span class="string">"application/json; charset=utf-8"</span>)</span><br><span class="line">                , dingTalk.createTextMsg(text,atMobiles,isAtAll))</span><br><span class="line">        Request textDingTalk = <span class="keyword">new</span> Request.Builder().url(webHook)</span><br><span class="line">                .post(textBody).build()</span><br><span class="line">        Response responseText = okHttpClient.newCall(textDingTalk).execute()</span><br><span class="line">        String result = responseText.body.string()</span><br><span class="line">        println(<span class="string">"已发送钉钉消息:$result"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="序列化工具类"><a href="#序列化工具类" class="headerlink" title="序列化工具类"></a>序列化工具类</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DingTalk</span> &#123;</span></span><br><span class="line">    Gson gson</span><br><span class="line">    <span class="keyword">public</span> DingTalk()&#123;</span><br><span class="line">        gson = <span class="keyword">new</span> Gson()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 定义钉钉链接消息的bean类</span></span><br><span class="line">    <span class="keyword">def</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkMsg</span>&#123;</span></span><br><span class="line">        String msgtype</span><br><span class="line">        Link link</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> LinkMsg(String msgtype,Link link)&#123;</span><br><span class="line">            <span class="keyword">this</span>.msgtype = msgtype</span><br><span class="line">            <span class="keyword">this</span>.link = link</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="class"><span class="keyword">class</span> <span class="title">Link</span>&#123;</span></span><br><span class="line">        String title</span><br><span class="line">        String text</span><br><span class="line">        String messageUrl</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Link(String title,String text,String messageUrl)&#123;</span><br><span class="line">            <span class="keyword">this</span>.title = title</span><br><span class="line">            <span class="keyword">this</span>.text = text</span><br><span class="line">            <span class="keyword">this</span>.messageUrl = messageUrl</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义钉钉文本消息的bean类</span></span><br><span class="line">    <span class="keyword">def</span> <span class="class"><span class="keyword">class</span> <span class="title">TextMsg</span>&#123;</span></span><br><span class="line">        String msgtype</span><br><span class="line">        Text text</span><br><span class="line">        At at</span><br><span class="line">        <span class="keyword">public</span> TextMsg(String msgtype,Text text,At at)&#123;</span><br><span class="line">            <span class="keyword">this</span>.msgtype = msgtype</span><br><span class="line">            <span class="keyword">this</span>.text = text</span><br><span class="line">            <span class="keyword">this</span>.at = at</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="class"><span class="keyword">class</span> <span class="title">At</span>&#123;</span></span><br><span class="line">        List&lt;String&gt; atMobiles = <span class="keyword">new</span> ArrayList&lt;&gt;()</span><br><span class="line">        <span class="keyword">boolean</span> isAtAll = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">public</span> At(List&lt;String&gt; atMobiles,<span class="keyword">boolean</span> isAtAll)&#123;</span><br><span class="line">            <span class="keyword">this</span>.atMobiles = atMobiles</span><br><span class="line">            <span class="keyword">if</span> (!atMobiles.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">this</span>.isAtAll = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.isAtAll = isAtAll</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="class"><span class="keyword">class</span> <span class="title">Text</span>&#123;</span></span><br><span class="line">        String content</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Text(String content)&#123;</span><br><span class="line">            <span class="keyword">this</span>.content = content</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建一个钉钉链接消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String createLinkMsg(String text ,String title,String url) &#123;</span><br><span class="line">        Link link = <span class="keyword">new</span> Link(title,text,url)</span><br><span class="line">        LinkMsg linkMsg = <span class="keyword">new</span> LinkMsg(<span class="string">"link"</span>,link)</span><br><span class="line">        <span class="keyword">return</span> gson.toJson(linkMsg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建一个钉钉文本消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgtype String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String createTextMsg(String content,List&lt;String&gt; atMobiles,<span class="keyword">boolean</span> isAtAll)&#123;</span><br><span class="line">        Text text = <span class="keyword">new</span> Text(content)</span><br><span class="line">        At at = <span class="keyword">new</span> At(atMobiles,isAtAll)</span><br><span class="line">        TextMsg textMsg = <span class="keyword">new</span> TextMsg(<span class="string">"text"</span>, text, at )</span><br><span class="line">        <span class="keyword">return</span> gson.toJson(textMsg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="反序列化bean类定义"><a href="#反序列化bean类定义" class="headerlink" title="反序列化bean类定义"></a>反序列化bean类定义</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApkInfo</span> &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * name : fir.im</span></span><br><span class="line"><span class="comment">     * version : 1.0</span></span><br><span class="line"><span class="comment">     * changelog : 更新日志</span></span><br><span class="line"><span class="comment">     * versionShort : 1.0.5</span></span><br><span class="line"><span class="comment">     * build : 6</span></span><br><span class="line"><span class="comment">     * installUrl : http://download.bq04.com/v2/app/install/xxxxxxxxxxxxxxxxxxxx?download_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="comment">     * install_url : http://download.bq04.com/v2/app/install/xxxxxxxxxxxxxxxx?download_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="comment">     * update_url : http://fir.im/fir</span></span><br><span class="line"><span class="comment">     * binary : &#123;"fsize":6446245&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="keyword">private</span> String changelog;</span><br><span class="line">    <span class="keyword">private</span> String versionShort;</span><br><span class="line">    <span class="keyword">private</span> String build;</span><br><span class="line">    <span class="keyword">private</span> String installUrl;</span><br><span class="line">    <span class="keyword">private</span> String install_url;</span><br><span class="line">    <span class="keyword">private</span> String update_url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getName() &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setName(String name) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getVersion() &#123;</span><br><span class="line">        <span class="keyword">return</span> version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setVersion(String version) &#123;</span><br><span class="line">        <span class="keyword">this</span>.version = version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getChangelog() &#123;</span><br><span class="line">        <span class="keyword">return</span> changelog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setChangelog(String changelog) &#123;</span><br><span class="line">        <span class="keyword">this</span>.changelog = changelog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getVersionShort() &#123;</span><br><span class="line">        <span class="keyword">return</span> versionShort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setVersionShort(String versionShort) &#123;</span><br><span class="line">        <span class="keyword">this</span>.versionShort = versionShort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getBuild() &#123;</span><br><span class="line">        <span class="keyword">return</span> build;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setBuild(String build) &#123;</span><br><span class="line">        <span class="keyword">this</span>.build = build;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getInstallUrl() &#123;</span><br><span class="line">        <span class="keyword">return</span> installUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setInstallUrl(String installUrl) &#123;</span><br><span class="line">        <span class="keyword">this</span>.installUrl = installUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getInstall_url() &#123;</span><br><span class="line">        <span class="keyword">return</span> install_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setInstall_url(String install_url) &#123;</span><br><span class="line">        <span class="keyword">this</span>.install_url = install_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getUpdate_url() &#123;</span><br><span class="line">        <span class="keyword">return</span> update_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setUpdate_url(String update_url) &#123;</span><br><span class="line">        <span class="keyword">this</span>.update_url = update_url;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BundleApp</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id : 5592ceb6537069f2a8000000</span></span><br><span class="line"><span class="comment">     * type : ios</span></span><br><span class="line"><span class="comment">     * short : yk37</span></span><br><span class="line"><span class="comment">     * cert : &#123;"icon":&#123;"key":"xxxxx","token":"xxxxxx","upload_url":"http://upload.qiniu.com"&#125;,"binary":&#123;"key":"xxxxx","token":"xxxxxx","upload_url":"http://upload.qiniu.com"&#125;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CertBean cert;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CertBean getCert() &#123;</span><br><span class="line">        <span class="keyword">return</span> cert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setCert(CertBean cert) &#123;</span><br><span class="line">        <span class="keyword">this</span>.cert = cert;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CertBean</span> &#123;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * icon : &#123;"key":"xxxxx","token":"xxxxxx","upload_url":"http://upload.qiniu.com"&#125;</span></span><br><span class="line"><span class="comment">         * binary : &#123;"key":"xxxxx","token":"xxxxxx","upload_url":"http://upload.qiniu.com"&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> IconBean icon;</span><br><span class="line">        <span class="keyword">private</span> BinaryBean binary;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> IconBean getIcon() &#123;</span><br><span class="line">            <span class="keyword">return</span> icon;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> setIcon(IconBean icon) &#123;</span><br><span class="line">            <span class="keyword">this</span>.icon = icon;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> BinaryBean getBinary() &#123;</span><br><span class="line">            <span class="keyword">return</span> binary;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> setBinary(BinaryBean binary) &#123;</span><br><span class="line">            <span class="keyword">this</span>.binary = binary;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IconBean</span> &#123;</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * key : xxxxx</span></span><br><span class="line"><span class="comment">             * token : xxxxxx</span></span><br><span class="line"><span class="comment">             * upload_url : http://upload.qiniu.com</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> String key;</span><br><span class="line">            <span class="keyword">private</span> String token;</span><br><span class="line">            <span class="keyword">private</span> String upload_url;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getKey() &#123;</span><br><span class="line">                <span class="keyword">return</span> key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setKey(String key) &#123;</span><br><span class="line">                <span class="keyword">this</span>.key = key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getToken() &#123;</span><br><span class="line">                <span class="keyword">return</span> token;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setToken(String token) &#123;</span><br><span class="line">                <span class="keyword">this</span>.token = token;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getUpload_url() &#123;</span><br><span class="line">                <span class="keyword">return</span> upload_url;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setUpload_url(String upload_url) &#123;</span><br><span class="line">                <span class="keyword">this</span>.upload_url = upload_url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryBean</span> &#123;</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * key : xxxxx</span></span><br><span class="line"><span class="comment">             * token : xxxxxx</span></span><br><span class="line"><span class="comment">             * upload_url : http://upload.qiniu.com</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> String key;</span><br><span class="line">            <span class="keyword">private</span> String token;</span><br><span class="line">            <span class="keyword">private</span> String upload_url;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getKey() &#123;</span><br><span class="line">                <span class="keyword">return</span> key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setKey(String key) &#123;</span><br><span class="line">                <span class="keyword">this</span>.key = key;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getToken() &#123;</span><br><span class="line">                <span class="keyword">return</span> token;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setToken(String token) &#123;</span><br><span class="line">                <span class="keyword">this</span>.token = token;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> String getUpload_url() &#123;</span><br><span class="line">                <span class="keyword">return</span> upload_url;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> setUpload_url(String upload_url) &#123;</span><br><span class="line">                <span class="keyword">this</span>.upload_url = upload_url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义Plugin"><a href="#自定义Plugin" class="headerlink" title="自定义Plugin"></a>自定义Plugin</h2><ol>
<li>继承gradle的Plugin类，重写apply方法中实现插件逻辑</li>
<li>在assemble任务后执行插件相关的逻辑</li>
</ol>
<ul>
<li>兼容Debug/Release两种打包方式和各个flavor下的打包任务，在这些任务打包完成后执行插件逻辑，采用”assemble” + variant.name.capitalize() +”Fir”的打包命令灵活配置</li>
<li>如渠道名为googlePlay下打debug/release包则打包任务名为assembleGooglePlayDebug/assembleGooglePlayRelease<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Task</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginImpl</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line">    UploadApkPluginExtension extension</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">        extension = project.extensions.create(<span class="string">'uploadApk'</span>, UploadApkPluginExtension.<span class="keyword">class</span>, project.getObjects())</span><br><span class="line">        <span class="keyword">if</span> (project.android.hasProperty(<span class="string">"applicationVariants"</span>)) &#123;</span><br><span class="line">            project.android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">                <span class="comment">// 定义gradle任务名称</span></span><br><span class="line">                Task uploadFir = project.task(<span class="string">"assemble$&#123;variant.name.capitalize()&#125;Fir"</span>).doLast &#123;</span><br><span class="line">                    println(<span class="string">"开始上传Fir"</span>)</span><br><span class="line">                    <span class="keyword">def</span> (String appPackage, String apiTokenFir, String apkPath, String fileName, String appName, String appVersion, String appBuild, String apkIconPath) = getParams(project, variant)</span><br><span class="line">                    OkHttpUtil okHttpUtil = <span class="keyword">new</span> OkHttpUtil()</span><br><span class="line">                    BundleApp bundleApp = okHttpUtil.getCert(appPackage,apiTokenFir)</span><br><span class="line">                    println(<span class="string">"获取凭证信息成功"</span>)</span><br><span class="line">                    BundleApp.CertBean certBean = bundleApp.getCert()</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 上传apk</span></span><br><span class="line">                    println(<span class="string">"上传apk中..."</span>)</span><br><span class="line">                    String key = certBean.getBinary().getKey()</span><br><span class="line">                    String token = certBean.getBinary().getToken()</span><br><span class="line">                    String upload_url = certBean.getBinary().getUpload_url()</span><br><span class="line"></span><br><span class="line">                    String jsonApk = okHttpUtil.uploadApk(apkPath,key,token,appName,appVersion,appBuild,fileName,upload_url)</span><br><span class="line">                    println(<span class="string">"上传apk文件返回结果:$jsonApk"</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 上传icon</span></span><br><span class="line">                    println(<span class="string">"上传Icon中..."</span>)</span><br><span class="line">                    String keyIcon = certBean.getIcon().getKey()</span><br><span class="line">                    String tokenIcon = certBean.getIcon().getToken()</span><br><span class="line">                    String upload_urlIcon = certBean.getIcon().getUpload_url()</span><br><span class="line"></span><br><span class="line">                    String jsonIcon = okHttpUtil.uploadIcon(apkIconPath,keyIcon,tokenIcon,upload_urlIcon)</span><br><span class="line">                    println(<span class="string">"上传Icon返回结果:$jsonIcon"</span>)</span><br><span class="line"></span><br><span class="line">                    ApkInfo apkInfo = okHttpUtil.getApkUrl(appPackage,apiTokenFir)</span><br><span class="line">                    println(<span class="string">"下载链接:$&#123;apkInfo.installUrl&#125;"</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">def</span> (String content, String title, String webHook, <span class="keyword">boolean</span> isAtAll,List&lt;String&gt; atMobiles) = getDingTalkParams()</span><br><span class="line">                    String dingTalkMsg = <span class="string">"点击跳转gilos下载链接(版本号:$appBuild    版本名称:$appVersion)"</span></span><br><span class="line">                    <span class="keyword">if</span> (content.length() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        dingTalkMsg = <span class="string">"$&#123;dingTalkMsg&#125;，此次更新:$content"</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 发送钉钉消息</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    okHttpUtil.sendDingTalkLink(dingTalkMsg,title,apkInfo.installUrl,webHook)</span><br><span class="line">                    okHttpUtil.sendDingTalkMsg(content,webHook,isAtAll,atMobiles)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 在assembleDebug执行后执行</span></span><br><span class="line">                uploadFir.dependsOn project.tasks[<span class="string">"assemble$&#123;variant.name.capitalize()&#125;"</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取钉钉消息配置相关的参数并返回</span></span><br><span class="line">    <span class="keyword">private</span> List getDingTalkParams() &#123;</span><br><span class="line">        String webHook = extension.getDingTalkExtension().getWebHook()</span><br><span class="line">        String title = extension.getDingTalkExtension().getTitle()</span><br><span class="line">        String content = extension.getDingTalkExtension().getContent()</span><br><span class="line">        String isAtAll = extension.getDingTalkExtension().getIsAtAll()</span><br><span class="line">        List&lt;String&gt; atMobiles = extension.getDingTalkExtension().getAtMobiles()</span><br><span class="line">        [content, title, webHook, isAtAll, atMobiles]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取相关gradle配置文件和fir配置相关的参数并返回</span></span><br><span class="line">    <span class="keyword">private</span> List getParams(Project project, variant) &#123;</span><br><span class="line">        String appName = extension.getFirExtension().getAppName()</span><br><span class="line">        String appPackage = project.android.defaultConfig.applicationId</span><br><span class="line">        String appVersion = project.android.defaultConfig.versionName</span><br><span class="line">        String appBuild = project.android.defaultConfig.versionCode</span><br><span class="line">        String apkPath = variant.outputs.first().outputFile</span><br><span class="line">        String fileName = apkPath.substring(apkPath.lastIndexOf(<span class="string">"\\"</span>) + <span class="number">1</span>, apkPath.length())</span><br><span class="line">        String apkIconPath = project.android.applicationVariants.first().outputs.first().outputFile.parent.split(<span class="string">"build"</span>)[<span class="number">0</span>] + extension.getFirExtension().getIconPath()</span><br><span class="line">        String apiTokenFir = extension.getFirExtension().getToken()</span><br><span class="line">        <span class="comment">// 获取上传凭证</span></span><br><span class="line"><span class="comment">//                        println("appName:$appName")</span></span><br><span class="line"><span class="comment">//                        println("appPackage:$appPackage")</span></span><br><span class="line"><span class="comment">//                        println("appVersion:$&#123;appVersion&#125;")</span></span><br><span class="line"><span class="comment">//                        println("appBuild:$&#123;appBuild&#125;")</span></span><br><span class="line"><span class="comment">//                        println("apiTokenFir:$&#123;apiTokenFir&#125;")</span></span><br><span class="line"><span class="comment">//                        println("apkIconPath:$&#123;apkIconPath&#125;")</span></span><br><span class="line">        println(<span class="string">"文件路径:$apkPath"</span>)</span><br><span class="line">        println(<span class="string">"文件名称:$fileName"</span>)</span><br><span class="line">        [appPackage, apiTokenFir, apkPath, fileName, appName, appVersion, appBuild, apkIconPath]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="声明插件"><a href="#声明插件" class="headerlink" title="声明插件"></a>声明插件</h2>在lib的配置文件xxx.xxx.xxx.properties（xxx.xxx.xxx是插件定义类所在的包名）中声明插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.demo.plugin.PluginImpl</span><br></pre></td></tr></table></figure>
<h3 id="获取所有打包任务下的插件执行命令"><a href="#获取所有打包任务下的插件执行命令" class="headerlink" title="获取所有打包任务下的插件执行命令"></a>获取所有打包任务下的插件执行命令</h3>variant.name.capitalize()这个参数是打包任务名称首字母大写，如不确定当前的打包任务名称，可以增加app的gradle代码，打印所有的打包任务名称来获取插件的执行命令，同步一下即可输出<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">project.android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">   println(<span class="string">"assemble$&#123;variant.name.capitalize()&#125;Fir"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="插件上传"><a href="#插件上传" class="headerlink" title="插件上传"></a>插件上传</h1><h2 id="上传到maven仓库"><a href="#上传到maven仓库" class="headerlink" title="上传到maven仓库"></a>上传到maven仓库</h2>上传本地仓库实际上就是生成maven工程的本地文件夹再引用，方便调试<br>增加插件lib的gradle文件代码<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            repository(<span class="string">url:</span> uri(<span class="string">'../repo'</span>)) <span class="comment">// 上传到本地仓库调试</span></span><br><span class="line">            <span class="comment">// 上传到远程仓库</span></span><br><span class="line">            <span class="comment">//  repository(url: "xxx.xxx.xxx:xxxx/repo私有仓库maven地址") &#123;</span></span><br><span class="line">            <span class="comment">//    authentication(userName: "用户名", password: "密码")</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            pom.groupId = <span class="string">'com.demo.plugin'</span><span class="comment">//插件lib包名</span></span><br><span class="line">            pom.artifactId = <span class="string">'firPlugin'</span></span><br><span class="line">            pom.version = <span class="string">'0.4'</span> <span class="comment">//插件版本号</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
执行gradle uploadArchives命令上传<h2 id="上传到远程仓库（私有maven-公有maven）"><a href="#上传到远程仓库（私有maven-公有maven）" class="headerlink" title="上传到远程仓库（私有maven/公有maven）"></a>上传到远程仓库（私有maven/公有maven）</h2></li>
</ul>
<h1 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h1><ul>
<li>修改根目录的gradle文件<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">"1.3.72"</span></span><br><span class="line">    repositories &#123;</span><br><span class="line"><span class="comment">//      maven &#123; url './repo' &#125; //本地Maven仓库地址</span></span><br><span class="line"><span class="comment">//      maven &#123; url 'xxx.xxx.xxx:xxxx/repository/release'&#125; // 私有仓库引用</span></span><br><span class="line">        maven &#123; url <span class="string">'https://jitpack.io'</span> &#125; <span class="comment">//Jitpack仓库引用</span></span><br><span class="line">       </span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">"com.android.tools.build:gradle:4.0.0"</span></span><br><span class="line">        classpath <span class="string">"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"</span></span><br><span class="line">        classpath <span class="string">'com.github.jessieeeee:upload-apk-fir-plugin:0.7'</span> <span class="comment">//Jitpack插件引用</span></span><br><span class="line"><span class="comment">//        classpath 'com.demo.plugin:firPlugin:0.4' // 本地/私有仓库插件引用</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="string">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改app的gradle文件，引入插件并进行相关配置<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.demo.plugin'</span></span><br><span class="line">uploadApk &#123;</span><br><span class="line">    fir &#123;</span><br><span class="line">        appName = <span class="string">"你的app名称"</span></span><br><span class="line">        iconPath = <span class="string">"src/main/res/mipmap-xxxhdpi/ic_launcher.png"</span></span><br><span class="line">        token = <span class="string">"fir平台的token"</span></span><br><span class="line">    &#125;</span><br><span class="line">    dingTalk&#123;</span><br><span class="line">        webHook = <span class="string">"钉钉机器人的webhook"</span></span><br><span class="line">        title = <span class="string">"Android：xxx打包完成"</span></span><br><span class="line">        content = <span class="string">"带关键字的消息内容"</span> <span class="comment">//这个关键字跟自定义钉钉机器人的安全设置有关</span></span><br><span class="line">        isAtAll = <span class="literal">false</span>  <span class="comment">// 是否at所有人</span></span><br><span class="line">        atMobiles = [<span class="string">"手机号1"</span>,<span class="string">"手机号2"</span>]   <span class="comment">//at某些人</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
github完整项目<a href="https://github.com/jessieeeee/upload-apk-fir-plugin" target="_blank" rel="noopener">传送门</a>，欢迎star,issue~</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/24/LiveDataBus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/07/24/LiveDataBus/" class="post-title-link" itemprop="url">LiveDataBus的封装</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-07-24 20:16:11" itemprop="dateCreated datePublished" datetime="2020-07-24T20:16:11+08:00">2020-07-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-08 23:31:33" itemprop="dateModified" datetime="2020-07-08T23:31:33+08:00">2020-07-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>随着JetPack的火热，google首推的Kotlin+LiveData+ViewModel+DataBinding的MVVM框架也越来越流行，在MVP的基础上，解决了P层带来的接口地狱和内存泄漏的问题，通信框架也从传统的handler，broadcast，interface到EventBus再到rxBus，最后到LiveDataBus，目前为止LiveDataBus确实是众多通信方案中最优的，在LiveData的加持下，拥有体积小，易封装，易维护且可感知生命周期防止内存泄漏的特点，接下来记录一下LiveDataBus的封装过程</p>
<hr>
<h1 id="通信框架对比"><a href="#通信框架对比" class="headerlink" title="通信框架对比"></a>通信框架对比</h1><p>Handler 高耦合，不利于维护，内存泄漏</p>
<p>BroadCast 性能差，传输数据有限，打乱代码的执行逻辑</p>
<p>Interface 实现复杂，不利于维护</p>
<p>RxBus 基于RxJava，学习成本高且依赖大</p>
<p>EventBus 需解决混淆问题，无法感知生命周期，实现复杂</p>
<h1 id="发布订阅模式和观察者模式区别"><a href="#发布订阅模式和观察者模式区别" class="headerlink" title="发布订阅模式和观察者模式区别"></a>发布订阅模式和观察者模式区别</h1><ul>
<li><p>观察者模式：观察者和被观察者相互知道对方的存在</p>
</li>
<li><p>发布订阅模式：发布者和订阅者互相不知道对方的存在</p>
</li>
</ul>
<h1 id="什么是LiveData"><a href="#什么是LiveData" class="headerlink" title="什么是LiveData"></a>什么是LiveData</h1><p>数据持有类，持有数据并且这个数据可以被观察者监听，它是和LifeCycle绑定的，在生命周期内使用有效，减少内存泄漏和引用问题</p>
<h1 id="LiveData的特点"><a href="#LiveData的特点" class="headerlink" title="LiveData的特点"></a>LiveData的特点</h1><ol>
<li>UI和数据保持一致：LiveData采用观察者模式，在数据变化时得到通知更新UI</li>
<li>避免内存泄漏：观察者被绑定到组件的生命周期上，组件销毁时，观察者会立刻清理数据</li>
<li>不会在Activity的stop状态下崩溃：当Activity处于后台，不会收到LiveData的延迟消息</li>
<li>解决屏幕旋转重启问题：能收到最新的数</li>
</ol>
<h1 id="LiveDataBus的封装"><a href="#LiveDataBus的封装" class="headerlink" title="LiveDataBus的封装"></a>LiveDataBus的封装</h1><ol>
<li>通过map维护一个消息事件和MutableLiveData的映射关系，MutableLiveData的类型默认为Object，接收任意类型，实现总线通信</li>
<li>将LiveDataBus封装为一个单例类</li>
<li>消息注册时，如果当前map中不存在，则先将消息和对应的MutableLiveData对象放入维护的map中，添加映射关系，返回当前map中缓存的MutableLiveData对象</li>
</ol>
<h2 id="粘性消息问题解决"><a href="#粘性消息问题解决" class="headerlink" title="粘性消息问题解决"></a>粘性消息问题解决</h2><p>具体现象：当前Activity给未启动的Activity发送一个消息，Activity在启动时能收到之前发送的消息</p>
<h3 id="LiveData源码"><a href="#LiveData源码" class="headerlink" title="LiveData源码"></a>LiveData源码</h3><p>LifecycleBoundObserver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(@NonNull LifecycleOwner source,</span></span></span><br><span class="line"><span class="function"><span class="params">              @NonNull Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">              removeObserver(mObserver);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          activeStateChanged(shouldBeActive());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>LiveData的version初始化是-1，每次LiveData设置值都会version加1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mVersion = START_VERSION;</span><br><span class="line"> <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        assertMainThread(<span class="string">"setValue"</span>);</span><br><span class="line">        mVersion++;</span><br><span class="line">        mData = value;</span><br><span class="line">        dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>LifeCircleOwner的状态变化时，会调LiveData.ObserverWrapper的activeStateChanged方法，如果这个时候ObserverWrapper的状态是active，就会调用LiveData的dispatchingValue，继续跟踪considerNotify，如果ObserverWrapper的mLastVersion小于LiveData的mVersion，会调mObserver的onChanged方法。所以LiveDataBus注册一个新的订阅者就会收到消息，即使消息发生在订阅之前。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// immediately set active state, so we'd never dispatch anything to inactive</span></span><br><span class="line">            <span class="comment">// owner</span></span><br><span class="line">            mActive = newActive;</span><br><span class="line">            <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">            LiveData.<span class="keyword">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class="line">                onActive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123;</span><br><span class="line">                onInactive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">                dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(@Nullable ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                considerNotify(initiator);</span><br><span class="line">                initiator = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="keyword">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                        mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                    considerNotify(iterator.next().getValue());</span><br><span class="line">                    <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">        mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// we still first check observer.active to keep it as the entrance for events. So even if</span></span><br><span class="line">        <span class="comment">// the observer moved to an active state, if we've not received that event, we better not</span></span><br><span class="line">        <span class="comment">// notify for a more predictable notification order.</span></span><br><span class="line">        <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">            observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        observer.mLastVersion = mVersion;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        observer.mObserver.onChanged((T) mData);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h3><p>在事件传递过程中拦截并监控事件的传输，修改事件传递流程<br>只要调用setValue版本号mVersion就会加1，此时版本号已经不一致导致onChange的调用，触发粘性事件，如果将mObservers.observer.mLastVersion修改为mVersion当前版本，就会在mObservers.observer.onChange调用前，也就是数据变化通知前return结束，这样就不调onChange方法<br>mObservers是Map对象，Map的item是键值对，observer是键值对的value，反射Map获取到Entry并获取到value也就是observer<br>继承MutableLiveData，重写observe方法，在注册监听时进行hook逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveDataBus</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BusMutableLiveData&lt;Object&gt;&gt; bus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LiveDataBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bus = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LiveDataBus DEFAULT_BUS = <span class="keyword">new</span> LiveDataBus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LiveDataBus <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.DEFAULT_BUS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">MutableLiveData&lt;T&gt; <span class="title">with</span><span class="params">(String key, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!bus.containsKey(key)) &#123;</span><br><span class="line">            bus.put(key, <span class="keyword">new</span> BusMutableLiveData&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MutableLiveData&lt;T&gt;) bus.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MutableLiveData&lt;Object&gt; <span class="title">with</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> with(key, Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BusMutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.observe(owner, observer);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 去除粘性事件</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//get wrapper's version</span></span><br><span class="line">            Class&lt;LiveData&gt; classLiveData = LiveData.class;</span><br><span class="line">            Field fieldObservers = classLiveData.getDeclaredField(<span class="string">"mObservers"</span>);</span><br><span class="line">            fieldObservers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectObservers = fieldObservers.get(<span class="keyword">this</span>);</span><br><span class="line">            Class&lt;?&gt; classObservers = objectObservers.getClass();</span><br><span class="line">            Method methodGet = classObservers.getDeclaredMethod(<span class="string">"get"</span>, Object.class);</span><br><span class="line">            methodGet.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</span><br><span class="line">            Object objectWrapper = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Wrapper can not be bull!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt; classObserverWrapper = objectWrapper.getClass().getSuperclass();</span><br><span class="line">            Field fieldLastVersion = classObserverWrapper.getDeclaredField(<span class="string">"mLastVersion"</span>);</span><br><span class="line">            fieldLastVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//get livedata's version</span></span><br><span class="line">            Field fieldVersion = classLiveData.getDeclaredField(<span class="string">"mVersion"</span>);</span><br><span class="line">            fieldVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectVersion = fieldVersion.get(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//set wrapper's version</span></span><br><span class="line">            fieldLastVersion.set(objectWrapper, objectVersion);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对非生命周期感知的observeForever方法，生成的wrapper不是LifecycleBoundObserver而是AlwaysActiveObserver，没有办法在observeForever调用完后再改AlwaysActiveObserver的version，因为注册监听时直接调了wrapper.activeStateChanged(true)而不是在LifeCircleOwner的状态变化时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@MainThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">      assertMainThread(<span class="string">"observeForever"</span>);</span><br><span class="line">      AlwaysActiveObserver wrapper = <span class="keyword">new</span> AlwaysActiveObserver(observer);</span><br><span class="line">      ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">      <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; existing <span class="keyword">instanceof</span> LiveData.LifecycleBoundObserver) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></span><br><span class="line">                  + <span class="string">" with different lifecycles"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      wrapper.activeStateChanged(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AlwaysActiveObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      AlwaysActiveObserver(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">          <span class="keyword">super</span>(observer);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以用ObserverWrapper，包装真正的回调传给observeForever，回调时检查调用栈，如果回调是observeForever方法，那么就不调真正的回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包装类包裹真正的Observer，处理非生命周期感知的注册监听</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Observer&lt;T&gt; observer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverWrapper</span><span class="params">(Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.observer = observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 目标方法不调onChanged</span></span><br><span class="line">            <span class="keyword">if</span> (isCallOnObserve()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            observer.onChanged(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCallOnObserve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (stackTrace != <span class="keyword">null</span> &amp;&amp; stackTrace.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement element : stackTrace) &#123;</span><br><span class="line">            <span class="comment">// 如果当前是LiveData对象且为observeForever方法</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"android.arch.lifecycle.LiveData"</span>.equals(element.getClassName()) &amp;&amp;</span><br><span class="line">                        <span class="string">"observeForever"</span>.equals(element.getMethodName())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改BusMutableLiveData增加对非生命周期感知的注册监听处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BusMutableLiveData</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MutableLiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Map&lt;Observer, Observer&gt; observerMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.observe(owner, observer);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非生命周期感知的注册监听处理，去除粘性事件</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!observerMap.containsKey(observer)) &#123;</span><br><span class="line">                observerMap.put(observer, <span class="keyword">new</span> ObserverWrapper(observer));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.observeForever(observerMap.get(observer));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非生命周期感知取消注册监听</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">            Observer realObserver = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observerMap.containsKey(observer)) &#123;</span><br><span class="line">                realObserver = observerMap.remove(observer);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realObserver = observer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.removeObserver(realObserver);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 去除粘性事件</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//get wrapper's version</span></span><br><span class="line">            Class&lt;LiveData&gt; classLiveData = LiveData.class;</span><br><span class="line">            Field fieldObservers = classLiveData.getDeclaredField(<span class="string">"mObservers"</span>);</span><br><span class="line">            fieldObservers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectObservers = fieldObservers.get(<span class="keyword">this</span>);</span><br><span class="line">            Class&lt;?&gt; classObservers = objectObservers.getClass();</span><br><span class="line">            Method methodGet = classObservers.getDeclaredMethod(<span class="string">"get"</span>, Object.class);</span><br><span class="line">            methodGet.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectWrapperEntry = methodGet.invoke(objectObservers, observer);</span><br><span class="line">            Object objectWrapper = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">                objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (objectWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Wrapper can not be bull!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt; classObserverWrapper = objectWrapper.getClass().getSuperclass();</span><br><span class="line">            Field fieldLastVersion = classObserverWrapper.getDeclaredField(<span class="string">"mLastVersion"</span>);</span><br><span class="line">            fieldLastVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//get livedata's version</span></span><br><span class="line">            Field fieldVersion = classLiveData.getDeclaredField(<span class="string">"mVersion"</span>);</span><br><span class="line">            fieldVersion.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object objectVersion = fieldVersion.get(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//set wrapper's version</span></span><br><span class="line">            fieldLastVersion.set(objectWrapper, objectVersion);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/29/ReflectStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/06/29/ReflectStudy/" class="post-title-link" itemprop="url">注解反射-学习笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-06-29 17:34:43" itemprop="dateCreated datePublished" datetime="2020-06-29T17:34:43+08:00">2020-06-29</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-09 00:38:40" itemprop="dateModified" datetime="2020-07-09T00:38:40+08:00">2020-07-09</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>注解和反射是Android开发的基础，也是项目框架搭建中用到的必不可少的技术，减少重复代码编写，提高开发效率，并且广泛用于知名的开源框架中，有利于我们阅读源码，同时提升自己的架构能力和封装基础库的能力。下面对注解和反射的学习做一个记录。</p>
<hr>
<h1 id="原注解"><a href="#原注解" class="headerlink" title="原注解"></a>原注解</h1><p>元注解是定义注解的注解</p>
<p>@Retention：该注解保留阶段，保留的时长， 源码（RetentionPolicy.SOURCE） &lt; 字节码（RetentionPolicy.CLASS） &lt; 运行时（RetentionPolicy.RUNTIME）</p>
<ul>
<li>源码级别的注解：应用于APT编译期处理注解生成JAVA代码，生成额外的辅助类，如Dagger2, ButterKnife, EventBus3</li>
<li>字节码级别的注解：应用于字节码插桩，可用于埋点，如ASM，AspectJ</li>
<li>运行时级别的注解：反射获取被注解标记的变量/方法/类的信息</li>
</ul>
<p>@Target：该注解被使用的位置，字段枚举常量级（ElementType.FIELD），局部变量级（ElementType.LOCAL_VARIABLE），方法级（ElementType.METHOD），方法级（ElementType.PARAMETER），类级接口级（ElementType.TYPE），包级（ElementType.PACKAGE），构造方法（ElementType.CONSTRUCTOR），注解级（ElementType.ANNOTATION_TYPE）</p>
<h1 id="注解-反射实现Intent参数传递"><a href="#注解-反射实现Intent参数传递" class="headerlink" title="注解+反射实现Intent参数传递"></a>注解+反射实现Intent参数传递</h1><h2 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h2><p>用反射获取该变量的信息需保留到运行时阶段且注解应用于类的字段变量之上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoInject &#123;</span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注入逻辑"><a href="#注入逻辑" class="headerlink" title="注入逻辑"></a>注入逻辑</h2><ol>
<li>获取到该Activity的class对象，获取到该Activity的Intent数据</li>
<li>没有任何传值时直接返回</li>
<li>如果有参数传递，获取到该Activity的所有字段变量</li>
<li>确定每个字段变量的传值key，遍历所有的字段变量，判断该字段变量是否被注解，如果被注解则获取到注解对象，判断注解上的参数传值是否为空，如果为空直接使用被注解的变量名称为key，不为空则使用注解上的参数传值为key</li>
<li>判断传递的参数中是否有该key的值，如果有获取传入的值，如果字段变量不为数组，这里传入的值为最终结果</li>
<li>获取被注解的变量类型，如果该变量是数组并且是序列化的类，强转对象数组，并复制一份新的对象数组为最终结果，修改Activity中该变量的访问权限，将结果赋值给该变量<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectBundle</span><span class="params">(Activity activity)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 获取class对象</span></span><br><span class="line">    Class&lt;? extends Activity&gt; cls = activity.getClass();</span><br><span class="line">    Intent intent = activity.getIntent();</span><br><span class="line">    Bundle bundle = intent.getExtras();</span><br><span class="line">    <span class="comment">// 如果没有传值返回</span></span><br><span class="line">    <span class="keyword">if</span> (bundle == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取所有的变量</span></span><br><span class="line">    Field[] fields = cls.getDeclaredFields();</span><br><span class="line">    <span class="comment">// 遍历activity的变量</span></span><br><span class="line">    <span class="keyword">for</span>(Field field: fields)&#123;</span><br><span class="line">        <span class="comment">// 判断是否被注解</span></span><br><span class="line">        <span class="keyword">if</span> (field.isAnnotationPresent(AutoInject.class))&#123;</span><br><span class="line">            <span class="comment">// 获取到注解对象</span></span><br><span class="line">            AutoInject autoInject = field.getAnnotation(AutoInject.class);</span><br><span class="line">            <span class="comment">// 判断注解传值是否为空，如果为空使用当前被注解的变量名称</span></span><br><span class="line">            String key = TextUtils.isEmpty(autoInject.key()) ? field.getName() : autoInject.key();</span><br><span class="line">            <span class="comment">// 如果有该key的传值</span></span><br><span class="line">            <span class="keyword">if</span> (bundle.containsKey(key))&#123;</span><br><span class="line">                <span class="comment">// 获取传入的值</span></span><br><span class="line">                Object object = bundle.get(key);</span><br><span class="line">                <span class="comment">// 获取被注解的变量类型</span></span><br><span class="line">                Class&lt;?&gt; componentType = field.getType().getComponentType();</span><br><span class="line">                <span class="comment">// 如果当前变量是数组并且是序列化的class</span></span><br><span class="line">                <span class="keyword">if</span> (field.getType().isArray() &amp;&amp; Parcelable.class.isAssignableFrom(componentType))&#123;</span><br><span class="line">                    <span class="comment">// 强转对象数组</span></span><br><span class="line">                    Object[] objs = (Object[])object;</span><br><span class="line">                    <span class="comment">// 复制到新的对象数组</span></span><br><span class="line">                    Object[] objects = Arrays.copyOf(objs, objs.length, (Class&lt;?  extends Object[]&gt;) field.getType());</span><br><span class="line">                    object = objects;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 修改该变量的访问权限</span></span><br><span class="line">                field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 设置当前activity该变量的值为传值对象</span></span><br><span class="line">                    field.set(activity,object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2></li>
</ol>
<ul>
<li>第一个Activity传递参数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//User是序列化对象</span></span><br><span class="line">User user1 = <span class="keyword">new</span> User(<span class="string">"小明"</span>,<span class="number">12</span>); </span><br><span class="line">User user2 = <span class="keyword">new</span> User(<span class="string">"小王"</span>,<span class="number">13</span>);</span><br><span class="line">User[] users = <span class="keyword">new</span> User[<span class="number">2</span>];</span><br><span class="line">users[<span class="number">0</span>] = user1;</span><br><span class="line">users[<span class="number">1</span>] = user2;</span><br><span class="line">ArrayList&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">userList.add(user1);</span><br><span class="line">userList.add(user2);</span><br><span class="line"><span class="comment">// 传对象</span></span><br><span class="line">intent.putExtra(<span class="string">"test1"</span>,user1);</span><br><span class="line"><span class="comment">// 传对象数组</span></span><br><span class="line">intent.putExtra(<span class="string">"test2"</span>,users);</span><br><span class="line"><span class="comment">// 传对象列表</span></span><br><span class="line">intent.putParcelableArrayListExtra(<span class="string">"test3"</span>,userList);</span><br></pre></td></tr></table></figure></li>
<li>第二个Activity声明接收变量添加注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收对象</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test1"</span>)</span><br><span class="line"><span class="keyword">private</span> User value1;</span><br><span class="line"><span class="comment">// 接收对象数组</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test2"</span>)</span><br><span class="line"><span class="keyword">private</span> User[] value4;</span><br><span class="line"><span class="comment">// 接收对象列表</span></span><br><span class="line"><span class="meta">@AutoInject</span>(key = <span class="string">"test3"</span>)</span><br><span class="line"><span class="keyword">private</span> ArrayList&lt;User&gt; value5;</span><br><span class="line"><span class="comment">// Activity创建时调注入逻辑</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    InjectUtils.injectBundle(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="注解-反射实现View-OnClick注入逻辑"><a href="#注解-反射实现View-OnClick注入逻辑" class="headerlink" title="注解+反射实现View.OnClick注入逻辑"></a>注解+反射实现View.OnClick注入逻辑</h1><h2 id="定义注解-1"><a href="#定义注解-1" class="headerlink" title="定义注解"></a>定义注解</h2><h3 id="定义注解的注解"><a href="#定义注解的注解" class="headerlink" title="定义注解的注解"></a>定义注解的注解</h3><p>声明监听器类型，注入的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.ANNOTATION_TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EventType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Class <span class="title">listenerType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">listenerSetter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义方法注解"><a href="#定义方法注解" class="headerlink" title="定义方法注解"></a>定义方法注解</h3><p>用反射获取该变量的信息需保留到运行时阶段且注解应用于方法之上</p>
<p>普通点击监听的类型为View.OnClickListener.class，作用的方法为setOnClickListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@EventType</span>(listenerType = View.OnClickListener.class, listenerSetter = <span class="string">"setOnClickListener"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnClick &#123;</span><br><span class="line">    <span class="keyword">int</span>[] value();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>长按监听的类型为View.OnLongClickListener.class，作用的方法为setOnLongClickListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@EventType</span>(listenerType = View.OnLongClickListener.class, listenerSetter = <span class="string">"setOnLongClickListener"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OnLongClick &#123;</span><br><span class="line">    <span class="keyword">int</span>[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注入逻辑-1"><a href="#注入逻辑-1" class="headerlink" title="注入逻辑"></a>注入逻辑</h2><ol>
<li>获取到该Activity的class对象，获取到当前Activity的所有方法</li>
<li>遍历所有方法，获取到方法的所有注解</li>
<li>遍历所有注解，获取到当前注解类型</li>
<li>如果是EventType目标注解，获取到注解对象，获取到注解上定义的传值，监听的Class类型，注解作用的方法</li>
<li>获取到方法上注解传入的id</li>
<li>修改方法的访问权限</li>
<li>利用Java的代理器生成代理对象，动态代理OnClickListener/OnLongClickListener接口</li>
<li>自定义InvocationHandler添加在对应的点击事件上注入的逻辑</li>
<li>获取到View对象，在对应的点击方法上注入代理对象<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InjectClick</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectEvent</span><span class="params">(Activity activity)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 获取到当前的activity的class对象</span></span><br><span class="line">        Class&lt;? extends Activity&gt; activityClass = activity.getClass();</span><br><span class="line">        <span class="comment">// 获取到当前activity的所有方法</span></span><br><span class="line">        Method[] methods = activityClass.getDeclaredMethods();</span><br><span class="line">        <span class="comment">// 遍历所有方法</span></span><br><span class="line">        <span class="keyword">for</span> (Method method: methods)&#123;</span><br><span class="line">            <span class="comment">// 获取到方法的所有注解</span></span><br><span class="line">            Annotation[] annotations = method.getAnnotations();</span><br><span class="line">            <span class="comment">// 遍历所有注解</span></span><br><span class="line">            <span class="keyword">for</span> (Annotation annotation: annotations)&#123;</span><br><span class="line">                <span class="comment">// 获取到注解的类型</span></span><br><span class="line">                Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</span><br><span class="line">                <span class="comment">// 如果是EventType的注解</span></span><br><span class="line">                <span class="keyword">if</span> (annotationType.isAnnotationPresent(EventType.class))&#123;</span><br><span class="line">                    <span class="comment">// 获取到注解对象</span></span><br><span class="line">                    EventType eventType = annotationType.getAnnotation(EventType.class);</span><br><span class="line">                    <span class="comment">// 获取到注解上定义的传值</span></span><br><span class="line">                    Class listenerType = eventType.listenerType();</span><br><span class="line">                    String listenerSetter = eventType.listenerSetter();</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        <span class="comment">// 获取到注解传入的id值</span></span><br><span class="line">                        Method valueMethod = annotationType.getDeclaredMethod(<span class="string">"value"</span>);</span><br><span class="line">                        <span class="keyword">int</span>[] viewIds = (<span class="keyword">int</span>[]) valueMethod.invoke(annotation);</span><br><span class="line">                        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        ListenerInvocationHandler&lt;Activity&gt; handler = <span class="keyword">new</span> ListenerInvocationHandler(activity, method);</span><br><span class="line">                        <span class="comment">// OnClickListener/OnLongClickListener的代理对象</span></span><br><span class="line">                        Object listenerProxy = Proxy.newProxyInstance(listenerType.getClassLoader(),</span><br><span class="line">                                <span class="keyword">new</span> Class[]&#123;listenerType&#125;, handler);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 遍历传入的id</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> viewId : viewIds) &#123;</span><br><span class="line">                            <span class="comment">// 获得view</span></span><br><span class="line">                            View view = activity.findViewById(viewId);</span><br><span class="line">                            <span class="comment">// 获得OnClickListener/OnLongClickListener的setOnClickLisnter/setOnLongClickLisnter方法</span></span><br><span class="line">                            Method setter = view.getClass().getMethod(listenerSetter, listenerType);</span><br><span class="line">                            <span class="comment">// 在View的点击方法上注入代理对象</span></span><br><span class="line">                            setter.invoke(view, listenerProxy);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 兼容自定义view注入，所以是泛型： T = Activity/View</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerInvocationHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Method method;</span><br><span class="line">        <span class="keyword">private</span> T target;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListenerInvocationHandler</span><span class="params">(T target, Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.target = target;</span><br><span class="line">            <span class="keyword">this</span>.method = method;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            Log.v(<span class="string">"injectClick"</span>,<span class="string">"注入点击事件逻辑"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.method.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h1><p>声明对应的点击回调，并添加注解，传入被注入点击事件View的Id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClick</span>(&#123;R.id.text, R.id.button&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">click</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.text:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"click: 按钮1"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"click: 按钮2"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnLongClick</span>(&#123;R.id.text, R.id.button&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">longClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.text:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"longClick: 按钮1"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.button:</span><br><span class="line">            Log.i(<span class="string">"click"</span>, <span class="string">"longClick: 按钮2"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    InjectClick.injectEvent(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/24/ProxyStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/05/24/ProxyStudy/" class="post-title-link" itemprop="url">代理模式-学习笔记</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-05-24 17:34:31" itemprop="dateCreated datePublished" datetime="2020-05-24T17:34:31+08:00">2020-05-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-08 23:32:59" itemprop="dateModified" datetime="2020-07-08T23:32:59+08:00">2020-07-08</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很久没有写博客了，疫情结束后经济萧条，很多年轻人受疫情的影响而被迫离职至今未找到工作。今年受疫情影响，招聘需求明显萎缩，离职人员近几个月大幅增加，这应该是最难找工作的一年，相信不管是在职或离职的小伙伴应该都不太轻松。有工作经验的人尚且如此，今年毕业的应届生求职可能会更加艰难。生活不易，但是我们仍要以积极的心态去应对，相信终有一天这一切都会过去，生活又美好如初。受疫情影响今年我也经历了找工作这段痛苦的日子，受老天眷顾找到了一份新的工作，但仍然感觉自己的技术实力还需提高，作为程序员扎实的基础是核心竞争力中不可缺少的一部分，在扎实的基础下进一步扩展深度，学习更多的计算机底层原理，同时扩展广度，学习当下的新技术，只有保证自己的核心竞争力，才能在任何时候面对危机和考验从容应对。代理模式是设计模式中的常考点且很多开源框架都用到了这个模式，有必要学习并加深理解，在此做一个学习记录。</p>
<hr>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><p>外地拼搏的年轻人总是要面对租房的问题，这里以租房为例，理解静态代理模式。首先我们需要一个租赁接口，这个接口中只有一个方法就是租房</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rent</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个年轻人叫小明，在外地拼搏的他需要租房，需要继承租赁这个接口并实现租房的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XiaoMing</span> <span class="keyword">implements</span> <span class="title">Rent</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"小明需要租房"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个中介机构链家可以帮你租房，你将租房需求告诉他们，当你满意成功租房后需要支付给他们中介费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LianJia</span> <span class="keyword">implements</span> <span class="title">Rent</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Rent rent;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LianJia</span><span class="params">(Rent rent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rent = rent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentHouse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"链家获取你的租房需求"</span>);</span><br><span class="line">        rent.rentHouse();</span><br><span class="line">        Log.v(<span class="string">"proxy"</span>,<span class="string">"链家帮你租房"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来让链家帮小明租房</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明一个有租房需求的人小明</span></span><br><span class="line">Rent xiaoMing = <span class="keyword">new</span> XiaoMing();</span><br><span class="line"><span class="comment">// 声明中介机构链家，接受小明的租房需求</span></span><br><span class="line">LianJia lianJia = <span class="keyword">new</span> LianJia(xiaoMing);</span><br><span class="line"><span class="comment">// 链家帮小明租房</span></span><br><span class="line">lianJia.rentHouse();</span><br></pre></td></tr></table></figure>

<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>Java中有个代理器可以实现接口对象的代理并生成对应的代理对象，我们利用Proxy.newProxyInstance生成实现了Rent接口的小明并生成代理对象，invoke方法中第一个参数是代理对象，第二个参数是被代理的方法，第三个参数是当前方法传入的参数值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object o = Proxy.newProxyInstance(SplashActivity.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Rent.class&#125;, <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(xiaoMing,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将代理对象转化为Rent接口的实例并调用租房的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代理生成器的代理对象</span></span><br><span class="line">Rent xiaoMingProxy = (Rent) o;</span><br><span class="line">xiaoMingProxy.rentHouse();</span><br></pre></td></tr></table></figure>

<h1 id="手写Retrofit框架"><a href="#手写Retrofit框架" class="headerlink" title="手写Retrofit框架"></a>手写Retrofit框架</h1><p>Retrofit的核心就是通过动态代理，将注解参数拼接成一个完整的http请求再给网络请求框架去处理</p>
<h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.PARAMETER) <span class="comment">// 表单提交，作用在POST请求的参数上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Field &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD) <span class="comment">// 声明GET请求，作用在方法上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GET &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD) <span class="comment">// 声明POST请求，作用在方法上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> POST &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.PARAMETER) <span class="comment">// url上拼接，作用在请求的参数上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// 运行期保留</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Query &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现Retrofit"><a href="#实现Retrofit" class="headerlink" title="实现Retrofit"></a>实现Retrofit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRetrofit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Map&lt;Method, ServiceMethod&gt; serviceMethodMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); <span class="comment">// 缓存调用方法到方法参数解析服务的映射</span></span><br><span class="line">    <span class="keyword">final</span> Call.Factory callFactory;<span class="comment">// 网络请求框架</span></span><br><span class="line">    <span class="keyword">final</span> HttpUrl baseUrl;<span class="comment">// 请求服务器url地址</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRetrofit</span><span class="params">(Call.Factory callFactory, HttpUrl baseUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.callFactory = callFactory;</span><br><span class="line">        <span class="keyword">this</span>.baseUrl = baseUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回请求接口的代理对象</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class[]&#123;service&#125;,</span><br><span class="line">                <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        <span class="comment">//解析方法所有注解信息</span></span><br><span class="line">                        ServiceMethod serviceMethod = loadServiceMethod(method);</span><br><span class="line">                        <span class="comment">//传入参数的值并返回拼接好的请求</span></span><br><span class="line">                        <span class="keyword">return</span> serviceMethod.invoke(args);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双琐式创建实例</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span></span>&#123;</span><br><span class="line">        ServiceMethod serviceMethod = serviceMethodMap.get(method);</span><br><span class="line">        <span class="keyword">if</span> (serviceMethod == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (serviceMethodMap)&#123;</span><br><span class="line">                <span class="comment">// 直接取出对应的方法参数解析服务</span></span><br><span class="line">                serviceMethod = serviceMethodMap.get(method);</span><br><span class="line">                <span class="comment">// 如果没有缓存就初始化调用，再放入缓存</span></span><br><span class="line">                <span class="keyword">if</span> (serviceMethod == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    serviceMethod = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>,method).build();</span><br><span class="line">                    serviceMethodMap.put(method,serviceMethod);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> serviceMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收外部传入的参数并构建实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> HttpUrl baseUrl;</span><br><span class="line">        <span class="keyword">private</span> Call.Factory callFactory;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">callFactory</span><span class="params">(Call.Factory callFactory)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.callFactory = callFactory;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">baseUrl</span><span class="params">(String url)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.baseUrl = HttpUrl.parse(url);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MyRetrofit <span class="title">build</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"base url required"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</span><br><span class="line">            <span class="keyword">if</span>(callFactory == <span class="keyword">null</span>)&#123;</span><br><span class="line">                callFactory = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyRetrofit(callFactory, baseUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现方法参数解析服务"><a href="#实现方法参数解析服务" class="headerlink" title="实现方法参数解析服务"></a>实现方法参数解析服务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMethod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Call.Factory callFactory;<span class="comment">// 网络请求框架</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url; <span class="comment">// 当前的请求路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> hasBody; <span class="comment">// 是否有请求体</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ParameterHandler[] parameterHandlers;</span><br><span class="line">    <span class="keyword">private</span> FormBody.Builder formBuild; <span class="comment">// 请求体表单</span></span><br><span class="line">    HttpUrl baseUrl;<span class="comment">// 请求服务器url</span></span><br><span class="line">    String httpMethod; <span class="comment">// 请求方式post/get</span></span><br><span class="line">    HttpUrl.Builder urlBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceMethod</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        baseUrl = builder.retrofit.baseUrl;</span><br><span class="line">        callFactory = builder.retrofit.callFactory;</span><br><span class="line"></span><br><span class="line">        httpMethod = builder.httpMethod;</span><br><span class="line">        url = builder.url;</span><br><span class="line">        hasBody = builder.hasBody;</span><br><span class="line">        parameterHandlers = builder.parameterHandlers;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果有请求体,创建okhttp请求体对象</span></span><br><span class="line">        <span class="keyword">if</span> (hasBody) &#123;</span><br><span class="line">            formBuild = <span class="keyword">new</span> FormBody.Builder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理传参</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理请求的地址与参数</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterHandlers.length; i++) &#123;</span><br><span class="line">            ParameterHandler handlers = parameterHandlers[i];</span><br><span class="line">            <span class="comment">//handler内本来就记录了key,现在给到对应的value</span></span><br><span class="line">            handlers.apply(<span class="keyword">this</span>, args[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取最终请求地址</span></span><br><span class="line">        HttpUrl httpUrl;</span><br><span class="line">        <span class="keyword">if</span> (urlBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            urlBuilder = baseUrl.newBuilder(url);</span><br><span class="line">        &#125;</span><br><span class="line">        httpUrl = urlBuilder.build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        FormBody formBody = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (formBuild != <span class="keyword">null</span>) &#123;</span><br><span class="line">            formBody = formBuild.build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后拼接成功的请求</span></span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder().url(httpUrl).method(httpMethod, formBody).build();</span><br><span class="line">        <span class="keyword">return</span> callFactory.newCall(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get请求, 按http的方式处理参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addQueryParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (urlBuilder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            urlBuilder = baseUrl.newBuilder(url);</span><br><span class="line">        &#125;</span><br><span class="line">        urlBuilder.addQueryParameter(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Post请求, 按http的方式处理参数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFiledParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        formBuild.add(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> MyRetrofit retrofit;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Annotation[] methodAnnotations;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Annotation[][] parameterAnnotations;</span><br><span class="line">        ParameterHandler[] parameterHandlers;</span><br><span class="line">        <span class="keyword">private</span> String httpMethod;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> hasBody;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(MyRetrofit retrofit, Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.retrofit = retrofit;</span><br><span class="line">            <span class="comment">//获取方法的所有注解</span></span><br><span class="line">            methodAnnotations = method.getAnnotations();</span><br><span class="line">            <span class="comment">//获取方法参数的所有注解</span></span><br><span class="line">            parameterAnnotations = method.getParameterAnnotations();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//处理POST与GET</span></span><br><span class="line">            <span class="keyword">for</span> (Annotation methodAnnotation : methodAnnotations) &#123;</span><br><span class="line">                <span class="keyword">if</span> (methodAnnotation <span class="keyword">instanceof</span> POST) &#123;</span><br><span class="line">                    <span class="comment">//记录请求方式</span></span><br><span class="line">                    <span class="keyword">this</span>.httpMethod = <span class="string">"POST"</span>;</span><br><span class="line">                    <span class="comment">//记录请求url的path</span></span><br><span class="line">                    <span class="keyword">this</span>.url = ((POST) methodAnnotation).value();</span><br><span class="line">                    <span class="comment">// 是否有请求体</span></span><br><span class="line">                    <span class="keyword">this</span>.hasBody = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodAnnotation <span class="keyword">instanceof</span> GET) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.httpMethod = <span class="string">"GET"</span>;</span><br><span class="line">                    <span class="keyword">this</span>.url = ((GET) methodAnnotation).value();</span><br><span class="line">                    <span class="keyword">this</span>.hasBody = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理方法参数的注解</span></span><br><span class="line">            <span class="keyword">int</span> length = parameterAnnotations.length;</span><br><span class="line">            <span class="comment">// 创建请求参数映射数组</span></span><br><span class="line">            parameterHandlers = <span class="keyword">new</span> ParameterHandler[length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">                <span class="comment">// 一个参数的所有注解</span></span><br><span class="line">                Annotation[] annotations = parameterAnnotations[i];</span><br><span class="line">                <span class="comment">// 处理每一个注解</span></span><br><span class="line">                <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</span><br><span class="line">                    <span class="comment">// 如果是Field注解</span></span><br><span class="line">                    <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Field) &#123;</span><br><span class="line">                        <span class="comment">//得到注解上的value也就是请求参数的key</span></span><br><span class="line">                        String value = ((Field) annotation).value();</span><br><span class="line">                        <span class="comment">// 传入参数的key</span></span><br><span class="line">                        parameterHandlers[i] = <span class="keyword">new</span> ParameterHandler.FieldParameterHandler(value);</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="comment">// 如果是Query注解</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">                        String value = ((Query) annotation).value();</span><br><span class="line">                        parameterHandlers[i] = <span class="keyword">new</span> ParameterHandler.QueryParameterHandler(value);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryParameterHandler</span> <span class="keyword">extends</span> <span class="title">ParameterHandler</span></span>&#123;</span><br><span class="line">        String key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">QueryParameterHandler</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span> </span>&#123;</span><br><span class="line">            serviceMethod.addQueryParameter(key,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldParameterHandler</span> <span class="keyword">extends</span> <span class="title">ParameterHandler</span></span>&#123;</span><br><span class="line">        String key;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FieldParameterHandler</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(ServiceMethod serviceMethod, String value)</span> </span>&#123;</span><br><span class="line">            serviceMethod.addFiledParameter(key,value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义网络请求Api"><a href="#定义网络请求Api" class="headerlink" title="定义网络请求Api"></a>定义网络请求Api</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WeatherApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@POST</span>(<span class="string">"/v3/weather/weatherInfo"</span>)</span><br><span class="line">    <span class="function">Call <span class="title">postWeather</span><span class="params">(@Field(<span class="string">"city"</span>)</span> String city, @<span class="title">Field</span><span class="params">(<span class="string">"key"</span>)</span> String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/v3/weather/weatherInfo"</span>)</span><br><span class="line">    <span class="function">Call <span class="title">getWeather</span><span class="params">(@Query(<span class="string">"city"</span>)</span> String city, @<span class="title">Query</span><span class="params">(<span class="string">"key"</span>)</span> String key)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义Retrofit发起请求"><a href="#自定义Retrofit发起请求" class="headerlink" title="自定义Retrofit发起请求"></a>自定义Retrofit发起请求</h2><h3 id="初始化Retrofit"><a href="#初始化Retrofit" class="headerlink" title="初始化Retrofit"></a>初始化Retrofit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyRetrofit myRetrofit = <span class="keyword">new</span> MyRetrofit.Builder().baseUrl(<span class="string">"https://restapi.amap.com"</span>).build();</span><br><span class="line">weatherApi = myRetrofit.create(WeatherApi.class);</span><br></pre></td></tr></table></figure>

<h3 id="发起post请求"><a href="#发起post请求" class="headerlink" title="发起post请求"></a>发起post请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Call getCall = weatherApi.getWeather(<span class="string">"110101"</span>, <span class="string">"ae6c53e2186f33bbf240a12d80672d1b"</span>);</span><br><span class="line">        getCall.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                Log.i(<span class="string">"onResponse"</span>, <span class="string">"onResponse enjoy get: "</span> + response.body().string());</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="发起get请求"><a href="#发起get请求" class="headerlink" title="发起get请求"></a>发起get请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Call postCall = weatherApi.postWeather(<span class="string">"110101"</span>, <span class="string">"ae6c53e2186f33bbf240a12d80672d1b"</span>);</span><br><span class="line"> postCall.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">         Log.i(<span class="string">"onResponse"</span>, <span class="string">"onResponse enjoy post: "</span> + response.body().string());</span><br><span class="line">         response.close();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/05/PuppeteerInterception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/02/05/PuppeteerInterception/" class="post-title-link" itemprop="url">nodejs爬虫-puppeteer网络拦截器</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2020-02-05 14:36:13 / Modified: 17:53:38" itemprop="dateCreated datePublished" datetime="2020-02-05T14:36:13+08:00">2020-02-05</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很久没有写博客了，最近由于武汉疫情，这个春节从初一起就全程宅家，春节假期一延再延，本该上班的我们依然没有正常返工，街上仍然是没有几个人，快递延迟，很多人仍然是宅在家里远程上班。停工不停学，之前的漫画项目主要使用了网易漫画和腾讯漫画爬取的数据，而网易漫画在不久前被bilibili收购了，现在正式改为bilibili漫画，所以之前的爬虫逻辑和接口失效了，正好趁着这个时间把之前的服务端数据爬取接口改一下，这里做一个简单的记录。</p>
<hr>
<p>爬取漫画列表和漫画详情都没什么问题，跟之前的思路一样，改一下对应的标签重新绑定目标数据，但是在爬去漫画内容的时候，发现漫画图片的链接已经不在html的标签中了，而是直接获取到服务端返回的图片地址后用canvas绘制出来的。如下图所示：<br><img src="/images/PuppeteerInterception1.png" alt="截图"></p>
<p>所以只要我们能获取到该页面的网络请求结果，我们就能过滤出图片地址，也就不用去标签中获取目标数据了，接下来我发现在chrome浏览器中元素审查界面的网络拦截器中可以找到漫画内容的图片链接，如下图所示：<br><img src="/images/PuppeteerInterception2.png" alt="截图"></p>
<p>所以只要我们目前使用的爬虫框架puppeteer能够拦截到网络请求的结果就可以解决标签中无法爬取到图片地址的问题了。我查了一下puppeteer的官方文档，发现了这些api</p>
<p>开启拦截</p>
<p><code>page.setRequestInterception(true)</code></p>
<p>监听服务端返回<br><code>page.on(&#39;response&#39;)</code></p>
<p>另外还可以监听当前页面的请求</p>
<p><code>page.on(&#39;request&#39;)</code></p>
<p>返回一个自定义的响应</p>
<p><code>req.respond()</code></p>
<p>根据当前的场景，我们需要获取服务器返回的数据，并过滤其中的漫画图片地址</p>
<p><code>https://manga.hdslb.com/bfs/manga/a39f3fd06e540fe14b7e591ced413f372bd9f85f.jpg@660w.jpg?token=3a96fd02961137c00a76145fb381d544&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/4cd38fde6581e146c249373c9ed120b75047004a.jpg@660w.jpg?token=2e740fd7ccfefec3f1f5d0d27e925e33&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/18a6e2e4739e7e3eb9888e7220b398fb2d0def9d.jpg@660w.jpg?token=0e8b573c3c40fa3c5554d2df6ec8b2cb&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/e6cbe3162d3c4b6e1175557a90d4a0e54562032f.jpg@660w.jpg?token=0d1a55fe1d27d3527a9340034cd5a35f&amp;ts=5e3a7d62</code></p>
<p><code>https://manga.hdslb.com/bfs/manga/0c649ad9107997801dd4e45179323381b16dc50a.jpg@660w.jpg?token=fbdf6eb7df231dbe345f4411a32d56c6&amp;ts=5e3a7d62</code></p>
<p>以上的链接地址特征</p>
<ol>
<li>以<code>https://manga.hdslb.com/bfs/manga/</code>开头</li>
<li>尾部都跟有token和ts的参数，<code>?token=</code>和<code>&amp;ts=</code></li>
<li><code>@660w.jpg</code>看起来是传入了请求图片的宽度和图片格式</li>
<li>抛开<code>@</code>后面的尾部参数，请求的图片格式和<code>@</code>后面的尾部参数传入的格式一致</li>
</ol>
<p>根据特征，抓取漫画图片代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>)</span><br><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">            headless: <span class="literal">false</span>,</span><br><span class="line">            executablePath: <span class="string">'/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'</span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.setRequestInterception(<span class="literal">true</span>);</span><br><span class="line">page.on(<span class="string">'response'</span>,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">response</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> url = response.url().toString()</span><br><span class="line">                <span class="keyword">let</span> tokenStart = url.indexOf(<span class="string">'?token='</span>)</span><br><span class="line">                <span class="keyword">let</span> tsStart = url.indexOf(<span class="string">'&amp;ts='</span>)</span><br><span class="line">                <span class="comment">// 捕获目标url</span></span><br><span class="line">                <span class="keyword">if</span> (url.indexOf(<span class="string">'manga.hdslb.com/bfs/manga/'</span>) !== <span class="number">-1</span></span><br><span class="line">                    &amp;&amp; tokenStart !== <span class="number">-1</span></span><br><span class="line">                    &amp;&amp; tsStart !== <span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="comment">// 尾部参数请求的格式</span></span><br><span class="line">                    <span class="keyword">let</span> imgParamStart = url.indexOf(<span class="string">'@'</span>)</span><br><span class="line">                    <span class="keyword">if</span> (imgParamStart !== <span class="number">-1</span>)&#123;</span><br><span class="line">                        <span class="comment">// 图片本身的格式</span></span><br><span class="line">                        <span class="keyword">let</span> suffix = url.substring(imgParamStart - <span class="number">3</span>, imgParamStart)</span><br><span class="line">                        <span class="comment">// 请求图片的参数</span></span><br><span class="line">                        <span class="keyword">let</span> imgParam = url.substring(imgParamStart, tokenStart)</span><br><span class="line">                        <span class="keyword">let</span> imgWidthEnd = imgParam.indexOf(<span class="string">'w'</span>)</span><br><span class="line">                        <span class="comment">// 请求图片的宽度</span></span><br><span class="line">                        <span class="keyword">let</span> imgWidth = imgParam.substring(<span class="number">1</span>, imgWidthEnd)</span><br><span class="line">                        <span class="keyword">let</span> imgFormatStart = imgParam.indexOf(<span class="string">'.'</span>)</span><br><span class="line">                        <span class="comment">// 请求图片的格式</span></span><br><span class="line">                        <span class="keyword">let</span> imgFormat = imgParam.substring(imgFormatStart + <span class="number">1</span>,tokenStart)</span><br><span class="line">                        <span class="comment">// 过滤图片信息</span></span><br><span class="line">                        <span class="keyword">if</span> (suffix === imgFormat)&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(response.url())</span><br><span class="line">                            <span class="keyword">let</span> data = response.url().toString();</span><br><span class="line">                            <span class="keyword">let</span> imgHeight = <span class="number">1320</span></span><br><span class="line">                            resolve(&#123;data, imgWidth, imgHeight&#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"><span class="comment">// 跳转到目标网站</span></span><br><span class="line"><span class="keyword">await</span> page.goto(url)</span><br></pre></td></tr></table></figure>




        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/24/DingDingRobot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/11/24/DingDingRobot/" class="post-title-link" itemprop="url">钉钉机器人实现自定义闹钟提醒</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-11-24 20:57:51" itemprop="dateCreated datePublished" datetime="2019-11-24T20:57:51+08:00">2019-11-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-07 23:59:00" itemprop="dateModified" datetime="2020-03-07T23:59:00+08:00">2020-03-07</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很长一段时间没写博客了，最近工作繁忙，加班多，也是无奈啊～但是好习惯还是应该坚持下去的，平时工作钉钉作为主要的沟通工具，发现它除了是个聊天软件以外，还有一个好玩的东西-钉钉机器人，做些自动化推送提醒还是不错的，之前在telegram看到过类似的东西，它有一套专属api，可发送一些自定义的消息，实现一些自动化功能，目前推送提醒的解决方案一般是app推送，短信，企业微信，邮件，为了推送提醒单独开发一个app成本太高，短信现在几乎都是收费的，企业微信注册麻烦，而邮件一般都不会及时去看的。钉钉机器人创建成本低，又是主力聊天工具之一，对于个人或群组推送还是很实用的，随便拉两个人创建一个群就可以添加机器人了，如果只是做个人提醒的话，创建好后可以把这两个人T掉。唯一的限制是1秒最多发送20条～由于个人用iphone手机，本土化做得不好，节假日后补班那几天经常因为忘记定闹钟而睡过头，又不想下载第三方app，准备用家里有个树莓派做个人小型服务器，每天晚上定时跑一个python脚本，提醒我明天是否上班，如果上班提醒我设好闹钟，并请求天气预报，如果明天上班且下雨，提醒我闹钟提前半个小时，下雨早点出门不堵啊。</p>
<hr>
<h1 id="创建钉钉机器人"><a href="#创建钉钉机器人" class="headerlink" title="创建钉钉机器人"></a>创建钉钉机器人</h1><p>只要是个群组即可创建钉钉机器人，先拉两个人组成群组，在群组菜单中选择群组助手，添加机器人选择自定义机器人，创建的时候填写机器人名字，这里需要复制webhook的url链接，安全设置中可勾选自定义关键字，签名，ip地址，这里为了简单选择自定义关键字，设置为“提醒”，只要发送内容中带了关键字“提醒”即可。如果选择签名的话需要参考官方的签名算法，签名需添加到webhook的url上，如果选择ip地址的话，只有该ip地址的服务器才可以调用api发送消息。</p>
<h2 id="钉钉机器人发送消息"><a href="#钉钉机器人发送消息" class="headerlink" title="钉钉机器人发送消息"></a>钉钉机器人发送消息</h2><p>发起post请求，参数为json格式，就是机器人发送的内容，请求的地址就是创建机器人的webhook，如果安全设置选择了签名的话要带上签名参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">  url = <span class="string">'你的webhook'</span></span><br><span class="line">  headers = &#123;</span><br><span class="line">      <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">  &#125;</span><br><span class="line">  requests.post(url, data=json.dumps(msg), headers=headers)</span><br></pre></td></tr></table></figure>
<h1 id="获取日期信息"><a href="#获取日期信息" class="headerlink" title="获取日期信息"></a>获取日期信息</h1><p>找了一个免费api，<code>http://timor.tech/api/holiday/info/{yyyy-MM-dd}</code>，{yyyy-MM-dd}为要查询的日期，请求结果如下：<br>如果该接口请求失败，code = 1，也需要给自己发送接口请求失败的消息，及时处理<br>type = 0, 明天是正常的工作日<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-11</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"周五"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">5</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 1, 明天是正常的双休日<br>request url: <code>http://timor.tech/api/holiday/info/2019-10-13</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"周日"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">7</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 2, 明天是法定节假日<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-1</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: &#123;</span><br><span class="line">    <span class="attr">"holiday"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"wage"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2019-10-01"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type = 3, 明天是补班的特殊日子<br>request url:<code>http://timor.tech/api/holiday/info/2019-10-12</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"type"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节后调休"</span>,</span><br><span class="line">    <span class="attr">"week"</span>: <span class="number">6</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"holiday"</span>: &#123;</span><br><span class="line">    <span class="attr">"holiday"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"国庆节后调休"</span>,</span><br><span class="line">    <span class="attr">"after"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"wage"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"国庆节"</span>,</span><br><span class="line">    <span class="attr">"date"</span>: <span class="string">"2019-10-12"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="获取天气预报"><a href="#获取天气预报" class="headerlink" title="获取天气预报"></a>获取天气预报</h1><p>也是找了一个免费Api，<code>http://t.weather.sojson.com/api/weather/city/{citycode}</code>，参数是城市编码，以成都为例，请求结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"success感谢又拍云(upyun.com)提供CDN赞助"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">"date"</span>: <span class="string">"20200307"</span>,</span><br><span class="line">  <span class="attr">"time"</span>: <span class="string">"2020-03-07 22:52:50"</span>,</span><br><span class="line">  <span class="attr">"cityInfo"</span>: &#123;</span><br><span class="line">    <span class="attr">"city"</span>: <span class="string">"成都市"</span>,</span><br><span class="line">    <span class="attr">"citykey"</span>: <span class="string">"101270101"</span>,</span><br><span class="line">    <span class="attr">"parent"</span>: <span class="string">"四川"</span>,</span><br><span class="line">    <span class="attr">"updateTime"</span>: <span class="string">"22:30"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"shidu"</span>: <span class="string">"63%"</span>,</span><br><span class="line">    <span class="attr">"pm25"</span>: <span class="number">52.0</span>,</span><br><span class="line">    <span class="attr">"pm10"</span>: <span class="number">79.0</span>,</span><br><span class="line">    <span class="attr">"quality"</span>: <span class="string">"良"</span>,</span><br><span class="line">    <span class="attr">"wendu"</span>: <span class="string">"14"</span>,</span><br><span class="line">    <span class="attr">"ganmao"</span>: <span class="string">"极少数敏感人群应减少户外活动"</span>,</span><br><span class="line">    <span class="attr">"forecast"</span>: Array[<span class="number">15</span>][</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"07"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 19℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-07"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:25"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:06"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">94</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"08"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 18℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-08"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期日"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:24"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:07"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">57</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"09"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 17℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 8℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-09"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期一"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:22"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:08"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">52</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"10"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 18℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 8℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-10"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期二"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:21"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:08"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">59</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"11"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-11"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期三"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:20"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:09"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">55</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"12"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 17℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-12"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期四"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:19"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:10"</span>,</span><br><span class="line">        <span class="attr">"aqi"</span>: <span class="number">62</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"13"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-13"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:18"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:10"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"14"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 20℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-14"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:16"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:11"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"15"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 15℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-15"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期日"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:15"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:12"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"16"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 14℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-16"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期一"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:14"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:12"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"17"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 16℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 10℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-17"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期二"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:13"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:13"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"小雨"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"雨虽小，注意保暖别感冒"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"18"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 20℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 9℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-18"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期三"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:12"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:14"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"19"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 22℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 11℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-19"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期四"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:10"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:14"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东南风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"阴"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"不要被阴云遮挡住好心情"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"20"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 23℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 12℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-20"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:09"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:15"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"东北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"21"</span>,</span><br><span class="line">        <span class="attr">"high"</span>: <span class="string">"高温 22℃"</span>,</span><br><span class="line">        <span class="attr">"low"</span>: <span class="string">"低温 13℃"</span>,</span><br><span class="line">        <span class="attr">"ymd"</span>: <span class="string">"2020-03-21"</span>,</span><br><span class="line">        <span class="attr">"week"</span>: <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="attr">"sunrise"</span>: <span class="string">"07:08"</span>,</span><br><span class="line">        <span class="attr">"sunset"</span>: <span class="string">"19:16"</span>,</span><br><span class="line">        <span class="attr">"fx"</span>: <span class="string">"西北风"</span>,</span><br><span class="line">        <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">        <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"yesterday"</span>: &#123;</span><br><span class="line">      <span class="attr">"date"</span>: <span class="string">"06"</span>,</span><br><span class="line">      <span class="attr">"high"</span>: <span class="string">"高温 16℃"</span>,</span><br><span class="line">      <span class="attr">"low"</span>: <span class="string">"低温 10℃"</span>,</span><br><span class="line">      <span class="attr">"ymd"</span>: <span class="string">"2020-03-06"</span>,</span><br><span class="line">      <span class="attr">"week"</span>: <span class="string">"星期五"</span>,</span><br><span class="line">      <span class="attr">"sunrise"</span>: <span class="string">"07:26"</span>,</span><br><span class="line">      <span class="attr">"sunset"</span>: <span class="string">"19:06"</span>,</span><br><span class="line">      <span class="attr">"aqi"</span>: <span class="number">79</span>,</span><br><span class="line">      <span class="attr">"fx"</span>: <span class="string">"无持续风向"</span>,</span><br><span class="line">      <span class="attr">"fl"</span>: <span class="string">"&lt;3级"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"多云"</span>,</span><br><span class="line">      <span class="attr">"notice"</span>: <span class="string">"阴晴之间，谨防紫外线侵扰"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求成功status=200，data的forecast字段是包括今天以及未来14天的天气情况，所以这个字段下的第二个元素就是明天的天气预报，判断该元素下的type字段是否包含“雨”，并返回调用结果，如果接口请求失败也给自己发送一条消息，及时处理</p>
<h2 id="python3实现"><a href="#python3实现" class="headerlink" title="python3实现"></a>python3实现</h2><p>每天定时跑脚本，给自己发钉钉消息，并结合明天的天气预报，如果要下雨给自己发送要早起的提示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWeather</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">"http://t.weather.sojson.com/api/weather/city/&#123;citycode&#125;"</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime(<span class="string">"getWeather ---&gt; "</span> + response.text)</span><br><span class="line">    json_data = json.loads(response.text)</span><br><span class="line">    status = json_data.get(<span class="string">'status'</span>)</span><br><span class="line">    <span class="keyword">if</span>  status == <span class="number">200</span>:</span><br><span class="line">        <span class="comment"># 明天的天气信息</span></span><br><span class="line">        tomorrow = json_data.get(<span class="string">'data'</span>).get(<span class="string">'forecast'</span>)[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 明天的天气</span></span><br><span class="line">        tomorrow_weather = str(tomorrow.get(<span class="string">"type"</span>))</span><br><span class="line">        <span class="keyword">if</span>  <span class="string">"雨"</span> <span class="keyword">in</span> tomorrow_weather:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">getDateInfo</span><span class="params">()</span>:</span></span><br><span class="line">     <span class="comment">#获得今天的日期</span></span><br><span class="line">    today = datetime.date.today() </span><br><span class="line">    <span class="comment">#获得明天的日期</span></span><br><span class="line">    tomorrow = today + datetime.timedelta(days=<span class="number">1</span>)</span><br><span class="line">    url = <span class="string">"http://timor.tech/api/holiday/info/"</span> + str(tomorrow)</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime(<span class="string">"getDateInfo ---&gt; "</span> + response.text)</span><br><span class="line">    json_data = json.loads(response.text)</span><br><span class="line">    dayType = json_data.get(<span class="string">'type'</span>).get(<span class="string">'type'</span>)</span><br><span class="line">    code = json_data.get(<span class="string">'code'</span>)</span><br><span class="line">    holiday = json_data.get(<span class="string">'holiday'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> code == <span class="number">1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getDateInfoError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span>(dayType == <span class="number">0</span>): <span class="comment">#正常上班</span></span><br><span class="line">            messageWorkNormal(getWeather())</span><br><span class="line">        <span class="keyword">elif</span>(dayType == <span class="number">1</span> <span class="keyword">or</span> dayType == <span class="number">2</span>): <span class="comment">#普通周末和节假日</span></span><br><span class="line">            messageHoliday()</span><br><span class="line">        <span class="keyword">elif</span>(dayType == <span class="number">3</span>): <span class="comment"># 补假日</span></span><br><span class="line">            messageWorkAbnormal(today, str(holiday.get(<span class="string">'name'</span>)),getWeather())</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 休息日</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageHoliday</span><span class="params">()</span>:</span></span><br><span class="line">    logWithTime(<span class="string">"messageHoliday ---&gt; "</span>)</span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天休息日，不上班哦~"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常上班</span></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">messageWorkNormal</span><span class="params">(rain)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>  rain == <span class="number">-1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getWeatherError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> rain == <span class="number">1</span>:</span><br><span class="line">            logWithTime(<span class="string">"messageWorkNormal rain ---&gt; "</span>)</span><br><span class="line">            str = <span class="string">"可能下雨，需提前出门，"</span></span><br><span class="line">        logWithTime(<span class="string">"messageWorkNormal ---&gt; "</span>)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天要上班，"</span>+ str +<span class="string">"注意添加闹钟!!!"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口请求出错处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestError</span><span class="params">(date)</span>:</span></span><br><span class="line">    str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span>  date:</span><br><span class="line">        str = <span class="string">"日期信息"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">"天气信息"</span></span><br><span class="line">    </span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【闹钟提醒】"</span>+str+<span class="string">"接口请求失败，注意添加闹钟!!!"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补假要上班</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageWorkAbnormal</span><span class="params">(date, reason, rain)</span>:</span> </span><br><span class="line">    <span class="keyword">if</span>  rain == <span class="number">-1</span>:</span><br><span class="line">        logWithTime(<span class="string">"getWeatherError ---&gt; "</span>)</span><br><span class="line">        requestError(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span>  rain == <span class="number">1</span>:</span><br><span class="line">            logWithTime(<span class="string">"messageWorkAbnormal rain ---&gt; "</span>)</span><br><span class="line">            str = <span class="string">"可能下雨，需提前出门，"</span></span><br><span class="line">        logWithTime(<span class="string">"messageWorkAbnormal ---&gt; "</span>)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【闹钟提醒】明天是：&#123;&#125;，&#123;&#125; 要上班，"</span>.format(date,reason)+ str + <span class="string">"注意添加闹钟!!!"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉机器人发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">    url = <span class="string">'your webhook'</span></span><br><span class="line">    </span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">    requests.post(url, data=json.dumps(msg), headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志带时间利于排查</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logWithTime</span><span class="params">(msg)</span>:</span></span><br><span class="line">      localtime = time.asctime( time.localtime(time.time()) )</span><br><span class="line">      <span class="keyword">print</span> (localtime + <span class="string">"    "</span> + msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    getDateInfo()</span><br></pre></td></tr></table></figure>
<p>每日晚上11点23在服务端运行这个脚本，请求钉钉机器人接口，给自己发送一个钉钉推送提醒，要定好闹钟</p>
<h1 id="树莓派设置定时任务"><a href="#树莓派设置定时任务" class="headerlink" title="树莓派设置定时任务"></a>树莓派设置定时任务</h1><p>将python脚本上传到树莓派，用ftp，ssh，samba都可以，这里就不详细说明了，设置定时任务前需要注意的是校准树莓派的时间，树莓派默认采用欧洲时区，如果树莓派的时间校准过，可略过此步骤。</p>
<h2 id="校准树莓派时间"><a href="#校准树莓派时间" class="headerlink" title="校准树莓派时间"></a>校准树莓派时间</h2><p>查看当前树莓派时间<code>date</code><br>设置树莓派时区<br><code>sudo dpkg-reconfigure tzdata</code><br>选择亚洲时区Asia，选择上海时间Shanghai</p>
<h2 id="contab设置定时任务"><a href="#contab设置定时任务" class="headerlink" title="contab设置定时任务"></a>contab设置定时任务</h2><p>linux定时任务可利用contab设置，<code>crontab -e</code>，进入文件编辑，选择编辑工具，nano或vim<br>格式为：Minute Hour Day Month Dayofweek   command<br>Minute            每个小时的第几分钟执行该任务<br>Hour               每天的第几个小时执行该任务<br>Day                 每月的第几天执行该任务<br>Month             每年的第几个月执行该任务<br>DayOfWeek    每周的第几天执行该任务<br>Command       要执行的命令<br>设置23点22分执行python3的脚本，并输出日志，利于维护和问题排查<br><code>22 23 * * * python3 /home/pi/upload/test123.py &gt;&gt;/home/pi/mylog.log</code><br>保存文件，并重启contab服务<br><code>sudo service cron restart</code></p>
<h1 id="ip变化提醒（2020-03-07更新）"><a href="#ip变化提醒（2020-03-07更新）" class="headerlink" title="ip变化提醒（2020/03/07更新）"></a>ip变化提醒（2020/03/07更新）</h1><p>家里申请了电信的公网ip，之前买了域名，一直在用端口转发+动态域名服务访问家里的树莓派，最近域名过期了，不打算续了，但希望仍然能在外网访问到家里的树莓派，电信的公网ip一直都是变动的，让电信固定ip需要繁杂的手续且需要企业申请，所以是不可能的了。最后想了一个可行的方法，如果能利用钉钉机器人在ip变化时给自己发送一条消息，告知最新的ip，那么仍然可以访问到家里的树莓派，这个问题就解决了。那如何知道ip变化了呢？还是利用linux的定时任务，每个小时跑一次python脚本，获取当前的外网ip，并将第一次的结果写入本地文件记录下来，每次运行脚本将当前外网ip与上一次记录的外网ip对比，如果不一致则ip变化，给自己发送钉钉消息告知最新的ip并再次写入文件刷新本地记录，如果ip一致则不用发送。</p>
<h2 id="获取本机外网ip"><a href="#获取本机外网ip" class="headerlink" title="获取本机外网ip"></a>获取本机外网ip</h2><p>找了一个免费的接口，<code>http://members.3322.org/dyndns/getip</code>，直接返回本机外网ip，如果为空就请求失败了，也给自己发送钉钉消息，及时处理，python实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># 获取当前ip</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getip</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">"http://members.3322.org/dyndns/getip"</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    logWithTime (<span class="string">"getip ---&gt;"</span> + response.text)</span><br><span class="line">    myip = response.text.strip()</span><br><span class="line">    <span class="keyword">return</span> myip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口请求出错处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestError</span><span class="params">()</span>:</span>    </span><br><span class="line">    messageRobot(&#123;</span><br><span class="line">        <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"text"</span>: &#123;</span><br><span class="line">            <span class="string">"content"</span>: <span class="string">"【ip变更提醒】获取ip接口请求失败!!!"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeFile</span><span class="params">(ip)</span>:</span></span><br><span class="line">    fo = open(<span class="string">"ip.txt"</span>, <span class="string">"w"</span>)</span><br><span class="line">    fo.write( ip)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readFile</span><span class="params">()</span>:</span></span><br><span class="line">    fo = open(<span class="string">"ip.txt"</span>, <span class="string">"r+"</span>)</span><br><span class="line">    <span class="keyword">return</span> fo.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉机器人发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">messageRobot</span><span class="params">(msg)</span>:</span></span><br><span class="line">    url = <span class="string">'your webhook'</span></span><br><span class="line">    </span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">    requests.post(url, data=json.dumps(msg), headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启ip变更通知任务</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notifyIpTask</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"ip.txt"</span>):</span><br><span class="line">        lastIp = readFile()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lastIp = <span class="string">""</span></span><br><span class="line">    logWithTime(<span class="string">"notifyIpTask ---&gt; notify ip server start"</span>)</span><br><span class="line">    myIp = getip()</span><br><span class="line">    <span class="keyword">if</span>  myIp == <span class="string">""</span>:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; get ip error"</span>)</span><br><span class="line">        requestError()</span><br><span class="line">    <span class="keyword">elif</span> myIp == lastIp:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; same ip"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logWithTime(<span class="string">"notifyIpTask ---&gt; send ip"</span>)</span><br><span class="line">        writeFile(myIp)</span><br><span class="line">        messageRobot(&#123;</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: &#123;</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"【ip变更提醒】当前ip为&#123;&#125;"</span>.format(myIp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志带时间利于排查</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logWithTime</span><span class="params">(msg)</span>:</span></span><br><span class="line">      localtime = time.asctime( time.localtime(time.time()) )</span><br><span class="line">      <span class="keyword">print</span> (localtime + <span class="string">"    "</span> + msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    notifyIpTask()</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/20/NtpSync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2019/07/20/NtpSync/" class="post-title-link" itemprop="url">Android上利用Ntp实现不同设备间的同步</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-07-20 20:31:21" itemprop="dateCreated datePublished" datetime="2019-07-20T20:31:21+08:00">2019-07-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-21 18:32:51" itemprop="dateModified" datetime="2019-07-21T18:32:51+08:00">2019-07-21</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近公司有个需求，希望在不同的Android设备上实现视频的播放同步，误差尽可能的小，后期继续优化实现逐帧同步效果，以便后期进行矩阵拼接屏的研发，前期处于试探性阶段，在App上实现，目前误差在10-20ms内，属于肉眼完全看不出的误差效果范围，只有利用手机的慢动作摄影才能看出一点过渡误差，并且视频播放出的声音听起来也完全同步。对于请求主机时间消息的传递误差，主要利用了ntp时间同步技术来解决，对于视频的加载耗时通过两个播放器实例交替加载，达到预先加载的效果来解决，加载视频耗时造成的误差基本可以忽略不计。只要获取到了当前的主机时间，那么就能推算出主机的播放时间，这个时间可以看作是所有设备同步播放的时间，也能算出当前设备时间到这个同步播放时间的偏移量，达到准时播放同一个视频的效果。由于设备不一定一直联网，排除设备的时钟时间错误造成的干扰，这里统一采用rtc时间（硬件时钟）。这里主要记录一下在Android平台上ntp协议的应用。</p>
<hr>
<h1 id="NTP协议简介"><a href="#NTP协议简介" class="headerlink" title="NTP协议简介"></a>NTP协议简介</h1><p>网络时间协议NTP(Network Time Protocol)用于将计算机客户或服务器的时间与另一服务器同步，使用层次式时间分布模型。在配置时，NTP可以利用冗余服务器和多条网络路径来获得时间的高准确性和高可靠性。即使客户机在长时间无法与某一时间服务器相联系的情况下,仍可提供高准确度时间。</p>
<p>联网计算机同步时钟最简便的方法是网络授时。网络授时分为广域网授时和局域网授时。广域网授时精度通常能达50ms级，但有时超过500ms，这是因为每次经过的路由器路径可能不相同。现在还没有更好的办法将这种不同路径延迟的时间误差完全消除。局域网授时不存在路由器路径延迟问题，因而授时精度理论上可以提到亚毫秒级。Windows内置NTP服务，在局域网内其最高授时精度也只能达10ms级。</p>
<h2 id="进一步提高NTP授时精度的方法"><a href="#进一步提高NTP授时精度的方法" class="headerlink" title="进一步提高NTP授时精度的方法"></a>进一步提高NTP授时精度的方法</h2><p>局域网络延相对较大的原因在于时间戳的发送请求和接收一般都是在应用层。减少操作系统内核处理延时可以提高NTP授时精度，使发/收NTP包时间戳应尽量接近主机真实发/收包时刻。在不改变硬件的条件下，修改网卡驱动程序，将记录NTP包发/收时间戳从应用程序移至网卡驱动程序处，可消除操作系统内核处理延时不确定而造成的误差。这种方法在局域网中可大幅提高NTP授时精度至μs级。</p>
<h1 id="NTP的算法推导"><a href="#NTP的算法推导" class="headerlink" title="NTP的算法推导"></a>NTP的算法推导</h1><p>NTP最典型的授时方式是Client/Server方式。如下图所示，客户机首先向服务器发送一个NTP包，其中包含了该包离开客户机的时间戳T1，当服务器接收到该包时，依次填入包到达的时间戳T2、包离开的时间戳T3，然后立即把包返回给客户机。客户机在接收到响应包时，记录包返回的时间戳T4。客户机用上述4个时间参数就能够计算出2个关键参数：NTP包的往返延迟d和客户机与服务器之间的时钟偏差t。客户机使用时钟偏差来调整本地时钟，以使其时间与服务器时间一致。</p>
<p>T1为客户发送NTP请求时间戳(以客户时间为参照)；T2为服务器收到NTP请求时间戳(以服务器时间为参照)；T3为服务器回复NTP请求时间戳(以服务器时间为参照)；T4为客户收到NTP回复包时间戳(以客户时间为参照)；d1为NTP请求包传送延时，d2为NTP回复包传送延时；t为服务器和客户端之间的时间偏差，d为NTP包的往返时间<br>那么服务器的处理时间为T3 - T2，服务器从发送请求到接收应答总时间为T4 - T1<br>例如T1客户发送NTP请求时间为10:00:00am，T2服务器收到NTP请求时间为11:00:01am，T3服务器回复NTP请求时间为11:00:02am，T4客户端收到NTP回复包10:00:03am，那么<br>d = (T4 - T1) - (T3 - T2) = 2秒<br>客户端设备相对服务端设备的时间差为<br>t = (T2 - T1) + (T3 - T4) / 2 约等于 1 小时</p>
<h1 id="Android代码实现"><a href="#Android代码实现" class="headerlink" title="Android代码实现"></a>Android代码实现</h1><h2 id="客户端请求ntp时间"><a href="#客户端请求ntp时间" class="headerlink" title="客户端请求ntp时间"></a>客户端请求ntp时间</h2><p>已知客户端T1，T4时间，实现从服务器返回的报文中获取T2，T3时间参数并计算服务器ntp时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_PACKET_SIZE = <span class="number">48</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_MODE_CLIENT = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_VERSION = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RECEIVE_TIME_OFFSET = <span class="number">32</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSMIT_TIME_OFFSET = <span class="number">40</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> OFFSET_1900_TO_1970 = ((<span class="number">365L</span> * <span class="number">70L</span>) + <span class="number">17L</span>) * <span class="number">24L</span> * <span class="number">60L</span> * <span class="number">60L</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 请求ntp服务器设备的时间，设置服务器IP地址，端口号，以及超时时间</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ipAddress ip地址</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> port      端口号</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timeout   超时时间单位毫秒</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 如果请求成功返回true</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">requestTime</span><span class="params">(String ipAddress, <span class="keyword">int</span> port, <span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           InetAddress address = InetAddress.getByName(ipAddress);</span><br><span class="line">           DatagramSocket mSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">           mSocket.setSoTimeout(timeout);</span><br><span class="line">           <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[NTP_PACKET_SIZE];</span><br><span class="line">           DatagramPacket request = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length, address, port);</span><br><span class="line">           buffer[<span class="number">0</span>] = NTP_MODE_CLIENT | (NTP_VERSION &lt;&lt; <span class="number">3</span>);</span><br><span class="line">           <span class="comment">// 请求发送时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> requestTicks = SystemClock.elapsedRealtime();</span><br><span class="line">           mSocket.send(request);</span><br><span class="line">           <span class="comment">// 读取服务器响应数据包</span></span><br><span class="line">           DatagramPacket response = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length);</span><br><span class="line">           mSocket.receive(response);</span><br><span class="line">           <span class="comment">// 收到服务器响应时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> responseTicks = SystemClock.elapsedRealtime();</span><br><span class="line">           <span class="comment">// 服务器的接收时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> receiveTime = readTimeStamp(buffer, RECEIVE_TIME_OFFSET);</span><br><span class="line">           <span class="comment">// 服务器的发送时间</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> transmitTime = readTimeStamp(buffer, TRANSMIT_TIME_OFFSET);</span><br><span class="line">           <span class="comment">// 计算时间客户端和服务器的时间差（服务器收到请求时间 - 客户端请求时间） + （服务器回复请求时间 - 客户端收到回复时间） / 2</span></span><br><span class="line">           <span class="keyword">long</span> clockOffset = ((receiveTime - requestTicks) + (transmitTime - responseTicks)) / <span class="number">2</span>;</span><br><span class="line">           <span class="comment">// 当前ntp服务器的时间</span></span><br><span class="line">           <span class="keyword">long</span> mNtpTime = SystemClock.elapsedRealtime() + clockOffset;</span><br><span class="line">           <span class="comment">// 添加到平均值计算集合中，求平均值使得计算误差更小</span></span><br><span class="line">           addDeviation(clockOffset);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!mSocket.isClosed()) &#123;</span><br><span class="line">                       mSocket.close();</span><br><span class="line">                   &#125;</span><br><span class="line">                   mSocket.disconnect();</span><br><span class="line">                   mSocket = <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从buffer中读取32位的大端数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">read32</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">byte</span> b0 = buffer[offset];</span><br><span class="line">       <span class="keyword">byte</span> b1 = buffer[offset + <span class="number">1</span>];</span><br><span class="line">       <span class="keyword">byte</span> b2 = buffer[offset + <span class="number">2</span>];</span><br><span class="line">       <span class="keyword">byte</span> b3 = buffer[offset + <span class="number">3</span>];</span><br><span class="line">       <span class="comment">// convert signed bytes to unsigned values</span></span><br><span class="line">       <span class="keyword">int</span> i0 = ((b0 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b0 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b0);</span><br><span class="line">       <span class="keyword">int</span> i1 = ((b1 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b1 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b1);</span><br><span class="line">       <span class="keyword">int</span> i2 = ((b2 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b2 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b2);</span><br><span class="line">       <span class="keyword">int</span> i3 = ((b3 &amp; <span class="number">0x80</span>) == <span class="number">0x80</span> ? (b3 &amp; <span class="number">0x7F</span>) + <span class="number">0x80</span> : b3);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> ((<span class="keyword">long</span>) i0 &lt;&lt; <span class="number">24</span>) + ((<span class="keyword">long</span>) i1 &lt;&lt; <span class="number">16</span>) + ((<span class="keyword">long</span>) i2 &lt;&lt; <span class="number">8</span>)</span><br><span class="line">               + (<span class="keyword">long</span>) i3;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从buffer中读取时间戳</span></span><br><span class="line"><span class="comment">    * 返回毫秒数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">readTimeStamp</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 读取秒数</span></span><br><span class="line">       <span class="keyword">long</span> seconds = read32(buffer, offset);</span><br><span class="line">       <span class="comment">// 读取小数</span></span><br><span class="line">       <span class="keyword">long</span> fraction = read32(buffer, offset + <span class="number">4</span>);</span><br><span class="line">       <span class="keyword">return</span> ((seconds - OFFSET_1900_TO_1970) * <span class="number">1000</span>)</span><br><span class="line">               + ((fraction * <span class="number">1000L</span>) / <span class="number">0x100000000L</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里的SystemClock.elapsedRealtime()是获取设备启动后到现在的时间（硬件时间），System.currentTimeMillis()获取的是系统时间（软件时间），是距离1970年1月1日开始计算的一个值，这里为了减少误差，避免因为外界修改软件时间而导致时间不准的情况而使用硬件时间。</p>
<h1 id="服务器返回ntp时间"><a href="#服务器返回ntp时间" class="headerlink" title="服务器返回ntp时间"></a>服务器返回ntp时间</h1><p>从客户端发的报文中获取响应地址和端口号，把收到请求的时间写入报文并保存到链表，从链表中取出刚才放入的报文，写入发送响应的时间发给客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> OFFSET_1900_TO_1970 = ((<span class="number">365L</span> * <span class="number">70L</span>) + <span class="number">17L</span>) * <span class="number">24L</span> * <span class="number">60L</span> * <span class="number">60L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RECEIVE_TIME_OFFSET = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSMIT_TIME_OFFSET = <span class="number">40</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_PACKET_SIZE = <span class="number">48</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_MODE_SERVIER = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NTP_VERSION = <span class="number">3</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    mCompositeDisposable.add(Observable.just(<span class="number">1</span>).subscribeOn(Schedulers.io())</span><br><span class="line">            .subscribe(integer -&gt; &#123;</span><br><span class="line">                start = <span class="keyword">true</span>;</span><br><span class="line">                Logger.t(TAG).d(<span class="string">"服务端开启 port="</span> + port);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mSocket = <span class="keyword">new</span> DatagramSocket(<span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// 设置端口重用</span></span><br><span class="line">                    mSocket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 绑定端口号</span></span><br><span class="line">                    mSocket.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">                    <span class="keyword">while</span> (start) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[NTP_PACKET_SIZE];</span><br><span class="line">                            DatagramPacket response = <span class="keyword">new</span> DatagramPacket(buffer,</span><br><span class="line">                                    buffer.length);</span><br><span class="line">                            buffer[<span class="number">0</span>] = NTP_MODE_SERVIER | (NTP_VERSION &lt;&lt; <span class="number">3</span>);</span><br><span class="line">                            Logger.t(TAG).d(<span class="string">"等待接收客户端消息"</span>);</span><br><span class="line">                            mSocket.receive(response);</span><br><span class="line">                            DatagramPacket echo = <span class="keyword">new</span> DatagramPacket(buffer, buffer.length, response.getAddress(), response.getPort());</span><br><span class="line">                            Logger.t(TAG).d(<span class="string">"收到客户端请求="</span> + response.getAddress());</span><br><span class="line">                            <span class="comment">// 把收到的时间写入buffer</span></span><br><span class="line">                            writeTimeStamp(buffer, RECEIVE_TIME_OFFSET, SystemClock.elapsedRealtime());</span><br><span class="line">                            <span class="comment">// 添加到链表</span></span><br><span class="line">                            mLinkedList.add(echo);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            Logger.t(TAG).e(<span class="string">"while receive failed:"</span> + e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Logger.t(TAG).e(<span class="string">"response failed:"</span> + e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Logger.t(TAG).e(<span class="string">"关闭socket"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mSocket.isClosed()) &#123;</span><br><span class="line">                            mSocket.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                        mSocket.disconnect();</span><br><span class="line">                        mSocket = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">    mCompositeDisposable.add(Observable.just(<span class="number">1</span>).subscribeOn(Schedulers.io())</span><br><span class="line">            .subscribe(integer -&gt; &#123;</span><br><span class="line">                mSendSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">                mSendSocket.setSoTimeout(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">while</span> (start) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mLinkedList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 取出刚才放入链表的数据包</span></span><br><span class="line">                            DatagramPacket first = mLinkedList.removeFirst();</span><br><span class="line">                            <span class="keyword">if</span> (first != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// 写入发送响应包的时间</span></span><br><span class="line">                                writeTimeStamp(first.getData(), TRANSMIT_TIME_OFFSET, SystemClock.elapsedRealtime());</span><br><span class="line">                                Logger.t(TAG).d(<span class="string">"向客户端发送消息="</span> + first.getAddress());</span><br><span class="line">                                mSendSocket.send(first);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        Logger.t(TAG).e(<span class="string">"while send failed:"</span> + e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Logger.t(TAG).d(<span class="string">"发送消息端关闭"</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入硬件时间到buffer中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeTimeStamp</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> seconds = time / <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">long</span> milliseconds = time - seconds * <span class="number">1000L</span>;</span><br><span class="line">    seconds += OFFSET_1900_TO_1970;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按大端模式写入秒数</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (seconds &gt;&gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> fraction = milliseconds * <span class="number">0x100000000L</span> / <span class="number">1000L</span>;</span><br><span class="line">    <span class="comment">// 按大端模式写入小数</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (fraction &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// 低位字节随机</span></span><br><span class="line">    buffer[offset++] = (<span class="keyword">byte</span>) (Math.random() * <span class="number">255.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jessie Kate</p>
  <div class="site-description" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  





















  

  

  


</body>
</html>
