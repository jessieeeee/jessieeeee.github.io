<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&amp;apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>JessieK's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/07/MVI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/11/07/MVI/" class="post-title-link" itemprop="url">Android UI架构MVI</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-11-07 19:58:44" itemprop="dateCreated datePublished" datetime="2022-11-07T19:58:44+08:00">2022-11-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-18 17:46:14" itemprop="dateModified" datetime="2022-10-18T17:46:14+08:00">2022-10-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>关于优化UI层的代码设计，从MVC，MVP，MVVM再到MVI，这四个模式围绕如何管理UI问题采用的都是“关注点分离”，实现细节稍有不同，但最终目的仍是解耦，提高维护性和可读性，从架构层面明确职责划分，约束开发者写出漂亮的代码，这里先回顾一下Android UI架构的演进过程与自己的一些思考并详细记录MVI的具体实现以及解决的相关痛点问题，欢迎一起学习讨论～</p>
<h1 id="UI架构演进"><a href="#UI架构演进" class="headerlink" title="UI架构演进"></a>UI架构演进</h1><h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p>Android的默认设计，最原始的UI架构，拆分为View，Model，Controller<br>View：布局xml文件<br>Model：管理业务数据逻辑，网络请求，数据库处理<br>Controller： 在Activity处理表现层逻辑</p>
<p><img src="/images/mvc.png" alt="效果图"></p>
<ul>
<li>存在问题<br>Activity臃肿，本身不可避免的要处理UI和用户交互，又要处理表现层逻辑，职责划分不清晰，分离程度不够</li>
</ul>
<h2 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h2><p>为了减轻Activity的负担，进化到了MVP架构，拆分为View，Model，Presenter<br>View：Activity和布局xml文件<br>Model：管理业务数据逻辑，网络请求，数据库处理，职责不变<br>Presenter：分担Activity一部分工作，处理表现层逻辑，其中View和Presenter会定义协议接口Contract，约定View调Presenter发送指令的接口方法和Presenter调callback返回结果给View的接口方法</p>
<p><img src="/images/mvp.png" alt="效果图"></p>
<ul>
<li>存在问题</li>
<li>协议接口Contract膨胀<br>当交互负责时会定义很多的发送指令和callback回调接口方法，不好维护</li>
<li>内存泄漏<br>生命周期无法绑定，Presenter持有View层的引用，当View层被关闭销毁时Model层有耗时操作存在内存泄漏的风险，当然可以在onDestory的生命周期中释放Presenter并采用弱引用的方式，但处理起来比较繁琐</li>
<li>双向依赖<br>View层有变动时Presenter也需要做出相应的调整，在实际开发中View层是容易变动的，一定程度上影响开发效率</li>
</ul>
<h2 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h2><p>为了解决以上的三个问题，进化到MVVM的架构，把Presenter改为ViewModel<br>View：Activity和布局xml文件<br>Model：管理业务数据逻辑，网络请求，数据库处理，职责不变<br>ViewModel：存储UI状态，处理表现层逻辑，将数据返回给观察者更新UI，这里View和Presenter的双向依赖变为View向ViewModel发指令，但ViewModel不直接回调返回结果而是通过观察者模式利用LiveData监听数据变化，返回给相应的观察者更新UI，解决了生命周期感知问题，同时也解决了手机旋转等配置变更数据丢失问题</p>
<p><img src="/images/mvvm.png" alt="效果图"></p>
<ul>
<li>存在问题</li>
<li>多数据流<br>View与ViewModel的交互分散，不易于追踪</li>
<li>LiveData膨胀<br>复杂页面交互需要定义多个LiveData，模糊了状态和事件的界限，粘性机制可能会导致一些问题，用在UI状态时如横竖屏切换时会重新执行一次observe会再次收到一个事件，对于UI来说只需关心最终状态，多次postValue可能会丢失数据也可能导致一些问题，用在事件发送时可能只执行第二个事件，对于事件来说希望每条事件都能被执行</li>
</ul>
<h1 id="MVI"><a href="#MVI" class="headerlink" title="MVI"></a>MVI</h1><h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>把View和ViewModel之间的多数据流改为基于ViewState和Intent的单数据流替换LiveData<br>View：Activity和布局xml文件<br>Model：管理业务数据逻辑，网络请求，数据库处理，职责不变<br>Intent：操作事件，将UI层的操作事件和携带的数据传到Model<br>ViewState：数据类，包含页面状态和对应的数据<br>ViewModel：存储UI状态，处理表现层逻辑，通过ViewState设置给UI</p>
<p><img src="/images/mvi.png" alt="效果图"></p>
<h2 id="解决痛点"><a href="#解决痛点" class="headerlink" title="解决痛点"></a>解决痛点</h2><ul>
<li>单一数据流便于追踪问题</li>
<li>清晰的划分状态和事件的界限，避免LiveData滥用导致的问题<h2 id="MVI封装流程"><a href="#MVI封装流程" class="headerlink" title="MVI封装流程"></a>MVI封装流程</h2></li>
</ul>
<h3 id="声明State和Intent接口"><a href="#声明State和Intent接口" class="headerlink" title="声明State和Intent接口"></a>声明State和Intent接口</h3><p>所有的业务层UiState都需要实现IState接口，UiIntent都需要实现IIntent接口</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IState</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IIntent</span></span></span><br></pre></td></tr></table></figure>
<h3 id="声明业务层ViewModel基类接口"><a href="#声明业务层ViewModel基类接口" class="headerlink" title="声明业务层ViewModel基类接口"></a>声明业务层ViewModel基类接口</h3><p>业务层ViewModel基类需要初始化stateFlow和intentFlow</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IStateViewModel</span>&lt;<span class="type">I: IIntent, S: IState</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> stateFlow: Flow&lt;S&gt;</span><br><span class="line">    <span class="keyword">val</span> intentFlow: Flow&lt;I&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装View层生命周期事件"><a href="#封装View层生命周期事件" class="headerlink" title="封装View层生命周期事件"></a>封装View层生命周期事件</h3><p>初始化默认为IDLE空闲状态</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">WidgetLifeEvent</span> </span>&#123;</span><br><span class="line">    IDLE, <span class="comment">// 空闲</span></span><br><span class="line">    ON_SHOW, <span class="comment">// 显示</span></span><br><span class="line">    ON_HIDE, <span class="comment">// 隐藏</span></span><br><span class="line">    ON_DESTROY <span class="comment">// 销毁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装观察者接口"><a href="#封装观察者接口" class="headerlink" title="封装观察者接口"></a>封装观察者接口</h3><p>观察者可通过回调监测到生命周期变化</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WidgetLifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onShow</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onHide</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生命周期观察者管理类"><a href="#生命周期观察者管理类" class="headerlink" title="生命周期观察者管理类"></a>生命周期观察者管理类</h3><ul>
<li>生命周期观察者被存储到一个列表中，当前的生命周期默认为IDLE</li>
<li>onShow/onHide/onDestroy事件会更新当前的生命周期状态，遍历所有的观察者调对应的接口方法</li>
<li>onDestroy时会清空列表所有的观察者<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetLifecycle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentWidgetLifeEvent: WidgetLifeEvent = WidgetLifeEvent.IDLE <span class="comment">// 当前的生命周期</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> widgetLifeList = mutableListOf&lt;WidgetLifecycleObserver&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加生命周期观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">addWidgetLife</span><span class="params">(widgetLifecycleObserver: <span class="type">WidgetLifecycleObserver</span>)</span></span>&#123;</span><br><span class="line">        synchronized(widgetLifeList)&#123;</span><br><span class="line">            <span class="keyword">if</span> (widgetLifecycleObserver !<span class="keyword">in</span> widgetLifeList)&#123;</span><br><span class="line">                widgetLifeList.add(widgetLifecycleObserver)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除生命周期观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">removeWidgetLife</span><span class="params">(widgetLifecycleObserver: <span class="type">WidgetLifecycleObserver</span>)</span></span>&#123;</span><br><span class="line">        synchronized(widgetLifeList)&#123;</span><br><span class="line">            widgetLifeList.remove(widgetLifecycleObserver)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调所有观察者的onShow</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        synchronized(widgetLifeList)&#123;</span><br><span class="line">            currentWidgetLifeEvent = WidgetLifeEvent.ON_SHOW</span><br><span class="line">            widgetLifeList.onEach &#123;</span><br><span class="line">                kotlin.runCatching &#123;</span><br><span class="line">                    it.onShow()</span><br><span class="line">                &#125;.onFailure &#123;</span><br><span class="line">                    <span class="string">"WidgetLifecycleObserver onShow异常"</span>.logD()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调所有观察者的onHide</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onHide</span><span class="params">()</span></span>&#123;</span><br><span class="line">        synchronized(widgetLifeList)&#123;</span><br><span class="line">            currentWidgetLifeEvent = WidgetLifeEvent.ON_HIDE</span><br><span class="line">            widgetLifeList.onEach &#123;</span><br><span class="line">                kotlin.runCatching &#123;</span><br><span class="line">                    it.onHide()</span><br><span class="line">                &#125;.onFailure &#123;</span><br><span class="line">                    <span class="string">"WidgetLifecycleObserver onHide异常"</span>.logD()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调所有观察者的onDestory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        synchronized(widgetLifeList)&#123;</span><br><span class="line">            currentWidgetLifeEvent = WidgetLifeEvent.ON_DESTROY</span><br><span class="line">            widgetLifeList.forEach &#123;</span><br><span class="line">                kotlin.runCatching &#123;</span><br><span class="line">                    it.onDestroy()</span><br><span class="line">                &#125;.onFailure &#123;</span><br><span class="line">                    <span class="string">"WidgetLifecycleObserver onDestroy异常"</span>.logD()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            widgetLifeList.clear()</span><br><span class="line">            <span class="string">"widgetLifeList clear"</span>.logD()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="暴露生命周期观察者管理对象"><a href="#暴露生命周期观察者管理对象" class="headerlink" title="暴露生命周期观察者管理对象"></a>暴露生命周期观察者管理对象</h3>实现了WidgetLifecycleOwner接口的类会提供命周期观察者管理对象<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WidgetLifecycleOwner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getWidgetLifecycle</span><span class="params">()</span></span>: WidgetLifecycle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装BaseViewModel"><a href="#封装BaseViewModel" class="headerlink" title="封装BaseViewModel"></a>封装BaseViewModel</h3>继承ViewModel的同时实现了WidgetLifecycleOwner接口，提供生命周期观察者管理对象，BaseStateFragment通过channel分发生命周期变化事件给BaseViewModel，BaseViewModel再把对应的事件分发给所有的观察者<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseViewModel</span> : <span class="type">ViewModel</span></span>(), WidgetLifecycleOwner&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> widgetLifecycle = WidgetLifecycle() <span class="comment">// 生命周期观察者管理对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> lifeEventChannel: Channel&lt;WidgetLifeEvent&gt; = Channel()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> lifecycleFlow: Flow&lt;WidgetLifeEvent&gt; = lifeEventChannel.consumeAsFlow()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getWidgetLifecycle</span><span class="params">()</span></span>: WidgetLifecycle &#123;</span><br><span class="line">        <span class="keyword">return</span> widgetLifecycle</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launch</span><span class="params">(callback: <span class="type">suspend</span> () -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">        viewModelScope.launch &#123;</span><br><span class="line">            callback.invoke()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        viewModelScope.launch &#123;</span><br><span class="line">            lifecycleFlow.collect&#123;</span><br><span class="line">                <span class="keyword">if</span> (it == WidgetLifeEvent.ON_SHOW)&#123;</span><br><span class="line">                    onShow()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (it == WidgetLifeEvent.ON_HIDE)&#123;</span><br><span class="line">                    onHide()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送生命周期事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendLifeEvent</span><span class="params">(widgetLifeEvent: <span class="type">WidgetLifeEvent</span>)</span></span>&#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            lifeEventChannel.send(widgetLifeEvent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onShow</span><span class="params">()</span></span>&#123;</span><br><span class="line">        widgetLifecycle.onShow()</span><br><span class="line">        <span class="string">"onShow"</span>.logD()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onHide</span><span class="params">()</span></span>&#123;</span><br><span class="line">        widgetLifecycle.onHide()</span><br><span class="line">        <span class="string">"onHide"</span>.logD()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCleared</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCleared()</span><br><span class="line">        widgetLifecycle.onDestroy()</span><br><span class="line">        <span class="string">"onCleared"</span>.logD()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装加载视图和toast事件"><a href="#封装加载视图和toast事件" class="headerlink" title="封装加载视图和toast事件"></a>封装加载视图和toast事件</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sealed</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> LOADING_TYPE_DIALOG = <span class="number">1</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> LOADING_TYPE_VIEW = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">object</span> HideLoadingDialog: SingleEvent()</span><br><span class="line">    <span class="keyword">object</span> ShowLoadingDialog: SingleEvent()</span><br><span class="line">    <span class="keyword">object</span> ShowLoadingView: SingleEvent()</span><br><span class="line">    <span class="keyword">object</span> ShowContentView: SingleEvent()</span><br><span class="line">    <span class="keyword">object</span> HideSwipeLayout: SingleEvent()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowToast</span></span>(<span class="keyword">val</span> msg: String): SingleEvent()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装BaseStateViewModel"><a href="#封装BaseStateViewModel" class="headerlink" title="封装BaseStateViewModel"></a>封装BaseStateViewModel</h3></li>
<li>继承BaseViewModel，实现IStateViewModel接口</li>
<li>需要传入意图和视图状态的具体类型</li>
<li>初始化intentFlow和stateFlow，intentFlow通过channel转换实现，stateFlow需要子类返回具体状态类，初始化状态对象再初始化StateFlow实现</li>
<li>加载视图和toast事件通过singleEventChannel发送，在BaseStateFragment中绑定事件并处理视图展示逻辑</li>
<li>更新State时刷新stateFlow的value，比较当前stateFlow的value是否和需要更新的State一致，如果一致则不会发送事件，因为StateFlow具有数据防抖功能</li>
<li>根据ViewModel的scope封装子线程切换和flow的子线程切换方法</li>
<li>声明dispatchIntentOnIO抽象方法，在子线程中分发意图事件并处理，不阻塞主线程，避免UI卡顿</li>
<li>封装加载状态展示和自动隐藏的方法，通过singleEventChannel发送相应的加载视图事件</li>
<li>封装checkIntent优化switch判断类型逻辑便于链式回调</li>
<li>初始化代码块中绑定intentFlow切换到子线程分发事件</li>
<li>dispatchIntentOnIO中的异常在needCatchException为true且release包下会被catch住<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseStateViewModel</span>&lt;<span class="type">I: IIntent, S: IState</span>&gt;: <span class="type">BaseViewModel</span></span>(), IStateViewModel&lt;I,S&gt; &#123;</span><br><span class="line">    <span class="comment">// Channel发送Intent</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> intentChannel = Channel&lt;I&gt; (Channel.UNLIMITED)</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">override</span> <span class="keyword">val</span> intentFlow: Flow&lt;I&gt;</span><br><span class="line">        <span class="keyword">get</span>() = intentChannel.consumeAsFlow()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">val</span> stateClass: KClass&lt;S&gt; <span class="comment">// 状态类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">val</span> needCatchException = <span class="literal">false</span> <span class="comment">// 是否需要try/catch</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// stateflow发送state</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> initState = createInitState() <span class="comment">// 状态对象初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mutableStatedFlow = MutableStateFlow(initState) <span class="comment">// stateFlow初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可变stateflow转成只读流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> stateFlow: Flow&lt;S&gt;</span><br><span class="line">        <span class="keyword">get</span>() = mutableStatedFlow.asStateFlow()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> singleEventChannel = Channel&lt;SingleEvent&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> tag: String <span class="keyword">get</span>() = javaClass.name</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SingleEvent flow</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> singleEvent <span class="keyword">get</span>() = singleEventChannel.consumeAsFlow()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送intent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendIntent</span><span class="params">(intent: <span class="type">I</span>)</span></span>&#123;</span><br><span class="line">        viewModelScope.launch &#123;</span><br><span class="line">            intentChannel.send(intent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前state对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> state: S <span class="keyword">get</span>() = mutableStatedFlow.value</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">emitState</span><span class="params">(state: <span class="type">S</span>)</span></span>&#123;</span><br><span class="line">        (<span class="keyword">if</span> (state == <span class="keyword">this</span>.state) <span class="string">"界面不会刷新"</span> <span class="keyword">else</span> <span class="string">"界面【会刷新】"</span>).apply &#123;</span><br><span class="line">            <span class="string">"<span class="variable">$tag</span> -&gt; 发送状态 -&gt; <span class="subst">$&#123;state.javaClass.name&#125;</span> <span class="variable">$this</span>"</span>.logD()</span><br><span class="line">            <span class="keyword">if</span> (isDebug())&#123;</span><br><span class="line">                <span class="string">"<span class="variable">$tag</span>-&gt;发送状态数据-&gt;<span class="variable">$this</span>  旧数据:<span class="subst">$&#123;this@BaseStateViewModel.state&#125;</span> 新数据:<span class="subst">$&#123;state&#125;</span>"</span>.logD()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutableStatedFlow.value = state</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateState</span><span class="params">(reducer: <span class="type">S</span>.() -&gt; <span class="type">S</span>)</span></span>&#123;</span><br><span class="line">        emitState(state.reducer())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启子线程执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchOnIO</span><span class="params">(callback: <span class="type">suspend</span> () -&gt; <span class="type">Unit</span>)</span></span>: Job&#123;</span><br><span class="line">        <span class="keyword">return</span> viewModelScope.launch(Dispatchers.IO) &#123; callback.invoke() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * flow切换子线程执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">collectOnIO</span><span class="params">(block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.(<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">        viewModelScope.launch(Dispatchers.IO)&#123;</span><br><span class="line">            <span class="keyword">this</span><span class="symbol">@collectOnIO</span>.onEach &#123;</span><br><span class="line">                block.invoke(<span class="keyword">this</span>, it)</span><br><span class="line">            &#125;.launchIn(<span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在IO协程分发Intent，这个方法只会在IO协程里面执行</span></span><br><span class="line"><span class="comment">     * 非阻塞的，不影响其他intent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchIntentOnIO</span><span class="params">(intent: <span class="type">I</span>)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化默认状态，子类可以实现自己的默认状态，比如读取缓存之类的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">createInitState</span><span class="params">()</span></span>: S&#123;</span><br><span class="line">        <span class="keyword">return</span> stateClass.createInstance()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送一个单一事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendSingleEvent</span><span class="params">(singleEvent: <span class="type">SingleEvent</span>)</span></span>&#123;</span><br><span class="line">        launch &#123;</span><br><span class="line">            singleEventChannel.send(singleEvent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">showLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sendSingleEvent(SingleEvent.ShowLoadingDialog)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">hideLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sendSingleEvent(SingleEvent.HideLoadingDialog)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">showLoadingView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sendSingleEvent(SingleEvent.ShowLoadingView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">showContentView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sendSingleEvent(SingleEvent.ShowContentView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">showToast</span><span class="params">(msg: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">        sendSingleEvent(SingleEvent.ShowToast(msg))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 显示加载状态</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@param</span> type 加载状态类型 对话框 加载View</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@param</span> needAutoHide 是否需要自动触发隐藏</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">startLoading</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        type: <span class="type">Int</span> = SingleEvent.LOADING_TYPE_DIALOG,</span></span></span><br><span class="line"><span class="function"><span class="params">        needAutoHide: <span class="type">Boolean</span> = <span class="literal">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Flow&lt;T&gt;&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.onStart &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == SingleEvent.LOADING_TYPE_DIALOG)&#123;</span><br><span class="line">                singleEventChannel.send(SingleEvent.ShowLoadingDialog)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                singleEventChannel.send(SingleEvent.ShowLoadingView)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.onCompletion &#123;</span><br><span class="line">            <span class="keyword">if</span> (needAutoHide)&#123;</span><br><span class="line">                <span class="keyword">if</span> (type == SingleEvent.LOADING_TYPE_DIALOG)&#123;</span><br><span class="line">                    singleEventChannel.send(SingleEvent.HideLoadingDialog)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    singleEventChannel.send(SingleEvent.ShowContentView)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载对话框</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">startLoadingDialog</span><span class="params">()</span></span>: Flow&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> startLoading(SingleEvent.LOADING_TYPE_DIALOG)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">startLoadingView</span><span class="params">()</span></span>: Flow&lt;T&gt;&#123;</span><br><span class="line">        <span class="keyword">return</span> startLoading(SingleEvent.LOADING_TYPE_VIEW)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">startLoadingViewWithCondition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        needShowLoadingView: <span class="type">Boolean</span> = <span class="literal">true</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Flow&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (needShowLoadingView) startLoading(SingleEvent.LOADING_TYPE_VIEW) <span class="keyword">else</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">startLoadingByCondition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        needShowLoading: <span class="type">Boolean</span> = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        type: <span class="type">Int</span> = SingleEvent.LOADING_TYPE_VIEW</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Flow&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (needShowLoading) startLoading(type) <span class="keyword">else</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断Intent类型，如果是该类型就回调</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> T</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@receiver</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T: IIntent&gt;</span> IIntent.<span class="title">checkIntent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: IIntent&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> T)&#123;</span><br><span class="line">            block.invoke(<span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        collectIntent()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步订阅Intent，所有的intent的执行都是在IO协程里面执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">collectIntent</span><span class="params">()</span></span> &#123;</span><br><span class="line">        intentFlow.collectOnIO &#123;</span><br><span class="line">            <span class="keyword">val</span> intent = it</span><br><span class="line">            <span class="keyword">val</span> intentName = intent.javaClass.name</span><br><span class="line">            <span class="string">"<span class="variable">$tag</span>-&gt;分发Intent-&gt;<span class="variable">$intentName</span>"</span>.logD()</span><br><span class="line">            <span class="string">"<span class="variable">$tag</span>-&gt;分发Intent详细数据-&gt;<span class="variable">$it</span>"</span>.logD()</span><br><span class="line"></span><br><span class="line">             callbackByCondition &#123;</span><br><span class="line">                 launch &#123;</span><br><span class="line">                     dispatchIntentOnIO(it)</span><br><span class="line">                     <span class="string">"异步分发Intent完成-&gt;<span class="variable">$intentName</span>"</span>.logD()</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">isRelease</span><span class="params">()</span></span>: <span class="built_in">Boolean</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !BuildConfig.DEBUG</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">isDebug</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BuildConfig.DEBUG</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * release环境下，needCatchException=true会捕获所有intent异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@receiver</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">callbackByCondition</span><span class="params">(block: <span class="type">suspend</span> () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (needCatchException &amp;&amp; isRelease()) &#123;</span><br><span class="line">            kotlin.runCatching &#123;</span><br><span class="line">                block.invoke()</span><br><span class="line">            &#125;.onFailure &#123;</span><br><span class="line">                <span class="string">"callbackByCondition异常"</span>.logD()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            block.invoke()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装BaseFragment"><a href="#封装BaseFragment" class="headerlink" title="封装BaseFragment"></a>封装BaseFragment</h3></li>
<li>对加载视图进行封装，把包含layout的content视图包裹在加载视图中</li>
<li>提供显示空视图，错误视图，内容视图，弹出toast，展示加载弹窗和隐藏加载弹窗的方法<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> loadingView: WrapperLoadingView? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> loadingDialogFragment: LoadingDialogFragment? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> needLoadingView = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取layout资源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@LayoutRes</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLayout</span><span class="params">()</span></span>: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化加载弹窗和加载视图</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        inflater: <span class="type">LayoutInflater</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        container: <span class="type">ViewGroup</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">        savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: View? &#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingDialogFragment == <span class="literal">null</span>) &#123;</span><br><span class="line">            loadingDialogFragment = LoadingDialogFragment()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (needLoadingView) &#123;</span><br><span class="line">            <span class="keyword">if</span> (loadingView == <span class="literal">null</span>) &#123;</span><br><span class="line">                loadingView = WrapperLoadingView(</span><br><span class="line">                    inflater.context,</span><br><span class="line">                    inflater.inflate(getLayout(), container, <span class="literal">false</span>)</span><br><span class="line">                )</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                (loadingView?.parent <span class="keyword">as</span>? ViewGroup)?.removeView(loadingView)</span><br><span class="line">            &#125;</span><br><span class="line">            loadingView</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inflater.inflate(getLayout(), container, <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showContentView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        loadingView?.showContent()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showLoadingView</span><span class="params">(<span class="meta">@ColorInt</span> color: <span class="type">Int</span> = Color.TRANSPARENT)</span></span>&#123;</span><br><span class="line">        loadingView?.showLoading(Gravity.CENTER, color)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        loadingDialogFragment?.show(childFragmentManager,<span class="string">"loading_dialog"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">hideLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        loadingDialogFragment?.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showEmptyView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        tips: <span class="type">Int</span> = R.string.no_more_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        icon: <span class="type">Int</span> = R.mipmap.icon_empty_default,</span></span></span><br><span class="line"><span class="function"><span class="params">        click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        loadingView?.showEmpty(tips, icon, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showEmptyView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        tips: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        icon: <span class="type">Int</span> = R.mipmap.icon_empty_default,</span></span></span><br><span class="line"><span class="function"><span class="params">        click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        loadingView?.showEmpty(tips, icon, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showFailView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        tips: <span class="type">Int</span> = R.string.load_failed_click_retry,</span></span></span><br><span class="line"><span class="function"><span class="params">        icon: <span class="type">Int</span> = R.mipmap.icon_error_retry,</span></span></span><br><span class="line"><span class="function"><span class="params">        click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        loadingView?.showEmpty(tips, icon, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showFailView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        tips: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        icon: <span class="type">Int</span> = R.mipmap.icon_empty_default,</span></span></span><br><span class="line"><span class="function"><span class="params">        click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        loadingView?.showEmpty(tips, icon, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showErrorView</span><span class="params">(tips: <span class="type">String</span>, click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span>)</span></span> &#123;</span><br><span class="line">        loadingView?.showError(tips, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showErrorView</span><span class="params">(tips: <span class="type">String</span>, color: <span class="type">Int</span>, click: <span class="type">View</span>.<span class="type">OnClickListener</span>? = <span class="literal">null</span>)</span></span> &#123;</span><br><span class="line">        loadingView?.showError(tips, color, click)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showToast</span><span class="params">(errorMsg: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        ToastUtils.showShort(errorMsg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getViewProvider</span><span class="params">()</span></span>: View &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">if</span> (needLoadingView)&#123;</span><br><span class="line">           (view <span class="keyword">as</span> WrapperLoadingView).contentView</span><br><span class="line">       &#125; <span class="keyword">else</span> requireView()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装BaseStateFragment"><a href="#封装BaseStateFragment" class="headerlink" title="封装BaseStateFragment"></a>封装BaseStateFragment</h3></li>
<li>继承BaseFragment，子类需要传入具体的意图类型，视图状态类型，绑定的ViewModel的类型</li>
<li>懒初始化ViewModelProvider的Factory，暴露出方法给子类重写默认返回空，暴露出方法给子类返回具体的ViewModel的Class对象</li>
<li>暴露绑定state和初始化View的方法，在onViewCreated中调用</li>
<li>绑定singleEventChannel并处理对应的UI事件</li>
<li>在onResume和onPause中发送对应的生命周期事件给生命周期观察者</li>
<li>stateFlow绑定具体的state属性，在生命周期started后回调变更后的state，distinctUntilChanged避免多次不必要的刷新<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseStateFragment</span>&lt;<span class="type">I : IIntent, S : IState, VM : BaseStateViewModel&lt;I, S</span>&gt;&gt; :<span class="type"></span></span></span><br><span class="line">    BaseFragment() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> vmFactory: ViewModelProvider.Factory? <span class="keyword">by</span> lazy &#123; getViewModelFactory() &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">val</span> viewModelClass: KClass&lt;VM&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果ViewModelProvider.Factory不为空则用它初始化否则直接初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel: VM <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        vmFactory?.run &#123;</span><br><span class="line">            ViewModelProvider(<span class="keyword">this</span><span class="symbol">@BaseStateFragment</span>, <span class="keyword">this</span>)[viewModelClass.java]</span><br><span class="line">        &#125; ?: ViewModelProvider(<span class="keyword">this</span><span class="symbol">@BaseStateFragment</span>)[viewModelClass.java]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ViewModelProvider.Factory，如果需要可以自行实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">getViewModelFactory</span><span class="params">()</span></span>: ViewModelProvider.Factory? &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fragment布局创建完成</span></span><br><span class="line"><span class="comment">     * 绑定state</span></span><br><span class="line"><span class="comment">     * 绑定SingleEvent并处理</span></span><br><span class="line"><span class="comment">     * 初始化View</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        bindState()</span><br><span class="line">        handleSingleEvent(<span class="keyword">this</span>)</span><br><span class="line">        initView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindState</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume()</span><br><span class="line">        viewModel.sendLifeEvent(WidgetLifeEvent.ON_SHOW)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause()</span><br><span class="line">        viewModel.sendLifeEvent(WidgetLifeEvent.ON_HIDE)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分发singleEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchSingleEvent</span><span class="params">(singleEvent: <span class="type">SingleEvent</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定singleEvent并处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleSingleEvent</span><span class="params">(lifecycleOwner: <span class="type">LifecycleOwner</span>)</span></span>&#123;</span><br><span class="line">        viewModel.singleEvent.collectWhenStart(lifecycleOwner)&#123;</span><br><span class="line">            <span class="string">"handleSingleEvent-&gt;<span class="variable">$it</span>"</span>.logD()</span><br><span class="line">            <span class="keyword">when</span>(it) &#123;</span><br><span class="line">                <span class="keyword">is</span> SingleEvent.HideLoadingDialog -&gt; &#123;</span><br><span class="line">                    hideMviLoadingDialog()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">is</span> SingleEvent.ShowLoadingDialog -&gt; &#123;</span><br><span class="line">                    showMviLoadingDialog()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">is</span> SingleEvent.ShowContentView -&gt; &#123;</span><br><span class="line">                    showMviContentView()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">is</span> SingleEvent.ShowLoadingView -&gt; &#123;</span><br><span class="line">                    showMviLoadingView()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">is</span> SingleEvent.ShowToast -&gt; &#123;</span><br><span class="line">                    showMviToast(it.msg)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                    dispatchSingleEvent(it)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showMviContentView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="string">"showMviContentView"</span>.logD()</span><br><span class="line">        showContentView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showMviLoadingView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="string">"showMviLoadingView"</span>.logD()</span><br><span class="line">        showLoadingView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showMviLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="string">"showMviLoadingDialog"</span>.logD()</span><br><span class="line">        showLoadingDialog()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hideMviLoadingDialog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="string">"hideMviLoadingDialog"</span>.logD()</span><br><span class="line">        hideLoadingDialog()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showMviToast</span><span class="params">(toast: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">        <span class="string">"showMviToast:<span class="variable">$toast</span>"</span>.logD()</span><br><span class="line">        showToast(toast)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * state刷新绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;A&gt;</span> <span class="title">bindPropertyState</span><span class="params">(kp: <span class="type">KProperty1</span>&lt;<span class="type">S</span>, A&gt;, action: <span class="type">suspend</span> (<span class="type">A</span>) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">        viewModel.stateFlow.map &#123;</span><br><span class="line">                <span class="keyword">data</span> -&gt; kp.<span class="keyword">get</span>(<span class="keyword">data</span>)</span><br><span class="line">        &#125;.distinctUntilChanged()</span><br><span class="line">            .collectWhenStart(<span class="keyword">this</span>) &#123; a -&gt;</span><br><span class="line">                <span class="string">"<span class="subst">$&#123;this@BaseStateFragment&#125;</span> -&gt; UI收到局部状态 -&gt; <span class="subst">$&#123;kp.getter.property&#125;</span>"</span>.logD()</span><br><span class="line">                action.invoke(a)</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * state绑定扩展</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;A&gt;</span> KProperty1<span class="type">&lt;S, A&gt;</span>.<span class="title">bindState</span><span class="params">(action: <span class="type">suspend</span> (<span class="type">A</span>) -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">        bindPropertyState(<span class="keyword">this</span>, action)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回viewModel的state对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="title">getState</span><span class="params">()</span></span>: S&#123;</span><br><span class="line">        <span class="keyword">return</span> viewModel.state</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * intent发送扩展</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: I&gt;</span> T.<span class="title">sendToIntent</span><span class="params">()</span></span> &#123;</span><br><span class="line">        viewModel.sendIntent(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="在业务场景中的使用"><a href="#在业务场景中的使用" class="headerlink" title="在业务场景中的使用"></a>在业务场景中的使用</h3><h4 id="定义登录接口"><a href="#定义登录接口" class="headerlink" title="定义登录接口"></a>定义登录接口</h4><ul>
<li>这里是Flow + retrofit的风格<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LoginApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@POST(<span class="meta-string">"/user/login"</span>)</span></span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">realLogin</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Field(<span class="meta-string">"username"</span>)</span> code: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Field(<span class="meta-string">"password"</span>)</span> token: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Flow&lt;LoginEntity?&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="登录Contract"><a href="#登录Contract" class="headerlink" title="登录Contract"></a>登录Contract</h4></li>
<li>这里定义UiIntent和UIState</li>
<li>UiIntent是一个密封类，每一个Intent都是内部的一个类，内部所有的类均继承UiIntent</li>
<li>UiIntent是一个数据类，实现IState接口，每一个State都是内部的一个属性<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LoginContract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">sealed</span> <span class="class"><span class="keyword">class</span> <span class="title">UiIntent</span>: <span class="type">IIntent &#123;</span></span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">DealLogin</span></span>(<span class="keyword">val</span> username: String, <span class="keyword">val</span> password: String): UiIntent()</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">CheckEnable</span></span>(<span class="keyword">val</span> username: String, <span class="keyword">val</span> password: String): UiIntent()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">UIState</span></span>(<span class="keyword">val</span> loginEntity: LoginEntity? = <span class="literal">null</span>,</span><br><span class="line">                       <span class="keyword">val</span> enable: <span class="built_in">Boolean</span>? = <span class="literal">null</span>): IState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="登录接口数据Bean类"><a href="#登录接口数据Bean类" class="headerlink" title="登录接口数据Bean类"></a>登录接口数据Bean类</h4></li>
<li>根据后端返回的数据结构封装Bean<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginEntity</span></span>(</span><br><span class="line">    <span class="keyword">val</span> admin: <span class="built_in">Boolean</span>? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> chapterTops: List&lt;Any&gt;? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> coinCount: <span class="built_in">Int</span>? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> collectIds: List&lt;<span class="built_in">Int</span>&gt;? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> email: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> icon: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> id: <span class="built_in">Int</span>? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> nickname: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> password: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> publicName: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> token: String? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> type: <span class="built_in">Int</span>? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">val</span> username: String? = <span class="literal">null</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="登录ViewModel"><a href="#登录ViewModel" class="headerlink" title="登录ViewModel"></a>登录ViewModel</h4></li>
<li>扩展ViewModel可接收初始化参数，传入SavedStateHandle</li>
<li>重写stateClass返回LoginContract的UIState的class对象</li>
<li>懒加载初始化FlowApi，关于FlowApi的封装在后面的文章中会详细讨论</li>
<li>dispatchIntentOnIO中根据当前的Intent类型去执行对应的表现层逻辑，这里值得注意的是由于是子线程执行，需要在设计时考虑线程安全的问题</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginViewModel</span></span>(savedStateHandle: SavedStateHandle): BaseStateViewModel&lt;LoginContract.UiIntent, LoginContract.UIState&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> stateClass: KClass&lt;LoginContract.UIState&gt;</span><br><span class="line">        <span class="keyword">get</span>() = LoginContract.UIState::<span class="class"><span class="keyword">class</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> loginApi <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        LoginApi::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">createFlowApi</span></span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchIntentOnIO</span><span class="params">(intent: <span class="type">LoginContract</span>.<span class="type">UiIntent</span>)</span></span> &#123;</span><br><span class="line">        intent.checkIntent&lt;LoginContract.UiIntent.CheckEnable&gt; &#123;</span><br><span class="line">            handleCheckEnable(it.username, it.password)</span><br><span class="line">        &#125;.checkIntent&lt;LoginContract.UiIntent.DealLogin&gt; &#123;</span><br><span class="line">            handleDealLogin(it.username, it.password)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleCheckEnable</span><span class="params">(username: <span class="type">String</span>, password: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">         updateState &#123;</span><br><span class="line">             copy(enable = username.isNotEmpty() &amp;&amp; password.isNotEmpty())</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理登录请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleDealLogin</span><span class="params">(username: <span class="type">String</span>, password: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        loginApi.realLogin(username, password).startLoading()</span><br><span class="line">            .onSuccess &#123;</span><br><span class="line">                updateState &#123; copy(loginEntity = it,) &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .onFail &#123;</span><br><span class="line">                Log.d(<span class="string">"loginApi"</span>, it.message.toString())</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a>登录界面</h4><ul>
<li>这里就不放xml文件了，主要是展示Fragment和ViewModel之间的交互过程，ViewBinding的封装涉及到了属性代理，在后面的文章中会详细讨论</li>
<li>重写getViewModelFactory方法，返回SavedStateViewModelFactory，可传递参数到ViewModel初始化</li>
<li>initView中CheckEnable的逻辑和登录逻辑在ViewModel中实现，通过发送Intent事件到ViewModel走交互逻辑</li>
<li>bindState中监听视图状态数据enable获取CheckEnable的结果刷新UI，监听loginEntity获取登录逻辑的数据结果反馈到UI<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginFragment</span> :<span class="type"></span></span></span><br><span class="line">    BaseStateFragment&lt;LoginContract.UiIntent, LoginContract.UIState, LoginViewModel&gt;() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> viewModelClass: KClass&lt;LoginViewModel&gt;</span><br><span class="line">        <span class="keyword">get</span>() = LoginViewModel::<span class="class"><span class="keyword">class</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewBinding <span class="keyword">by</span> viewBinding1(</span><br><span class="line">        FragmentLoginBinding::bind,</span><br><span class="line">        viewProvider =  &#123;</span><br><span class="line">            getViewProvider()</span><br><span class="line">        &#125;,</span><br><span class="line">        onViewDestroyed = &#123; _: FragmentLoginBinding -&gt;</span><br><span class="line">            <span class="comment">// reset view</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLayout</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.fragment_login</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getViewModelFactory</span><span class="params">()</span></span>: ViewModelProvider.Factory &#123;</span><br><span class="line">        <span class="keyword">return</span> SavedStateViewModelFactory(</span><br><span class="line">            BaseApplication.<span class="keyword">get</span>(), <span class="keyword">this</span>,</span><br><span class="line">            arguments)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.initView()</span><br><span class="line">        viewBinding.apply &#123;</span><br><span class="line">            etAccount.doAfterTextChanged &#123;</span><br><span class="line">                LoginContract.UiIntent.CheckEnable(it.toString(),</span><br><span class="line">                    viewBinding.passwordToggleView.editText.text.toString()).sendToIntent()</span><br><span class="line">            &#125;</span><br><span class="line">            passwordToggleView.editText.doAfterTextChanged &#123;</span><br><span class="line">                LoginContract.UiIntent.CheckEnable(viewBinding.etAccount.text.toString(),</span><br><span class="line">                    it.toString())</span><br><span class="line">                    .sendToIntent()</span><br><span class="line">            &#125;</span><br><span class="line">            tvLogin.clickWithTrigger &#123;</span><br><span class="line">               <span class="keyword">val</span> username = viewBinding.etAccount.text.toString()</span><br><span class="line">               <span class="keyword">val</span> password = viewBinding.passwordToggleView.editText.text.toString()</span><br><span class="line"></span><br><span class="line">               LoginContract.UiIntent.DealLogin(username, password).sendToIntent()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindState</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.bindState()</span><br><span class="line">        LoginContract.UIState::loginEntity.bindState &#123;</span><br><span class="line">            it?.let &#123;</span><br><span class="line">                Log.d(TAG, GsonUtils.toJson(it))</span><br><span class="line">                ToastUtils.showShort(<span class="string">"登录成功"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LoginContract.UIState::enable.bindState &#123;</span><br><span class="line">            it?.let &#123;</span><br><span class="line">                viewBinding.tvLogin.isEnabled = it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/15/FlowEventBus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/10/15/FlowEventBus/" class="post-title-link" itemprop="url">封装FlowEventBus事件总线</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-10-15 19:51:24" itemprop="dateCreated datePublished" datetime="2022-10-15T19:51:24+08:00">2022-10-15</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-05 23:50:03" itemprop="dateModified" datetime="2022-10-05T23:50:03+08:00">2022-10-05</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<ul>
<li>Kotlin是Android开发的趋势，协程是Kotlin必不可少的一部分，而Flow是协程的一部分，是类似RxJava的基于流的一种链式调用的异步响应式编程框架，可以说用kotlin开发Android是绕不开对Flow的学习和使用，关于组件间的通信，事件总线的实现方案有很多，如handler有内存泄漏问题，高耦合且不好维护，本地Broadcast和EventBus无法感知生命周期需要注册和反注册，EventBus还要配置混淆，直接使用interface又不好维护，RxBus学习成本高还依赖RxJava，自从google推出LiveData后封装了LiveDataBus但是要解决粘性事件问题和onCreate/onStop/onDestroy收不到数据问题以及postValue丢值问题，而这些问题在Flow上是不用考虑的</li>
<li>根据大部分业务需要，采用SharedFlow去封装EventBus是目前比较完美的事件总线解决方案，这里记录一下本次封装的详细过程，同时这次封装还解决了大部分事件总线的痛点，临时事件滥用维护难度大，事件名易重复，发送接收数据类型不一致导致数据转换错误，欢迎交流和讨论～</li>
</ul>
<hr>
<h1 id="为什么采用SharedFlow"><a href="#为什么采用SharedFlow" class="headerlink" title="为什么采用SharedFlow"></a>为什么采用SharedFlow</h1><h2 id="官方推荐用Flow去替代Livedata"><a href="#官方推荐用Flow去替代Livedata" class="headerlink" title="官方推荐用Flow去替代Livedata"></a>官方推荐用Flow去替代Livedata</h2><p>从设计上我们可以看出SharedFlow是高配版的LiveData，理论上LiveData能做的它也可以</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">MutableSharedFlow</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    replay: <span class="type">Int</span> = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    extraBufferCapacity: <span class="type">Int</span> = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    onBufferOverflow: <span class="type">BufferOverflow</span> = BufferOverflow.SUSPEND</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>: MutableSharedFlow&lt;T&gt; &#123;</span><br><span class="line">    require(replay &gt;= <span class="number">0</span>) &#123; <span class="string">"replay cannot be negative, but was <span class="variable">$replay</span>"</span> &#125;</span><br><span class="line">    require(extraBufferCapacity &gt;= <span class="number">0</span>) &#123; <span class="string">"extraBufferCapacity cannot be negative, but was <span class="variable">$extraBufferCapacity</span>"</span> &#125;</span><br><span class="line">    require(replay &gt; <span class="number">0</span> || extraBufferCapacity &gt; <span class="number">0</span> || onBufferOverflow == BufferOverflow.SUSPEND) &#123;</span><br><span class="line">        <span class="string">"replay or extraBufferCapacity must be positive with non-default onBufferOverflow strategy <span class="variable">$onBufferOverflow</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> bufferCapacity0 = replay + extraBufferCapacity</span><br><span class="line">    <span class="keyword">val</span> bufferCapacity = <span class="keyword">if</span> (bufferCapacity0 &lt; <span class="number">0</span>) <span class="built_in">Int</span>.MAX_VALUE <span class="keyword">else</span> bufferCapacity0 <span class="comment">// coerce to MAX_VALUE on overflow</span></span><br><span class="line">    <span class="keyword">return</span> SharedFlowImpl(replay, bufferCapacity, onBufferOverflow)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>LiveData容量是1，SharedFlow容量支持0到多个</li>
<li>LiveData无法应对背压问题，SharedFlow有缓存空间能应对背压问题</li>
<li>LiveData固定重播1个数据，SharedFlow支持重播0个到多个数据</li>
<li>LiveData只能在主线程订阅，SharedFlow支持在任意线程订阅<h2 id="适合大多数业务场景"><a href="#适合大多数业务场景" class="headerlink" title="适合大多数业务场景"></a>适合大多数业务场景</h2></li>
<li>支持一对多，即一条消息支持多个订阅者</li>
<li>具有时效性，过期的消息没有意义且不应该被延迟发送<br>对照SharedFlow本身是热流，支持多个订阅者，默认重播为0，容量为0，不会出现粘性事件，没有订阅直接丢弃</li>
</ul>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><h2 id="定义FlowDataEvent"><a href="#定义FlowDataEvent" class="headerlink" title="定义FlowDataEvent"></a>定义FlowDataEvent</h2><ul>
<li>定义EventBus发送的数据类FlowDataEvent，keyEvent为事件名称，data为发送的任意数据类型</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlowDataEvent</span></span>(<span class="keyword">val</span> keyEvent: String, <span class="keyword">val</span> <span class="keyword">data</span>: Any): FlowEvent</span><br></pre></td></tr></table></figure>

<h2 id="封装FlowEventBus"><a href="#封装FlowEventBus" class="headerlink" title="封装FlowEventBus"></a>封装FlowEventBus</h2><ul>
<li>定义EventBus的CoroutineScope</li>
<li>定义全局的SharedFlow</li>
<li>SharedFlow转冷流与订阅者绑定，LifecycleOwner的扩展用于Fragment中订阅数据，生命周期与Fragment绑定，CoroutineScope的扩展用于ViewModel中订阅数据，生命周期与ViewModel绑定</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> FlowEventBus &#123;</span><br><span class="line">    <span class="comment">// flowEventBus对应的scope</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> flowEventBusScope = CoroutineScope(CoroutineName(<span class="string">"FlowEventBus"</span>))</span><br><span class="line">    <span class="comment">// flowEventBus使用全局SharedFlow</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mutableSharedFlow = MutableSharedFlow&lt;FlowDataEvent&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> flowEventBus: Flow&lt;FlowDataEvent&gt; <span class="keyword">get</span>() = mutableSharedFlow.asSharedFlow()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SharedFlow绑定scope</span></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        mutableSharedFlow.launchIn(flowEventBusScope)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送一个事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendEvent</span><span class="params">(event: <span class="type">FlowDataEvent</span>)</span></span> &#123;</span><br><span class="line">        flowEventBusScope.launch &#123;</span><br><span class="line">            mutableSharedFlow.emit(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定LifecycleOwner返回FlowDataEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> LifecycleOwner.<span class="title">collectDataEvent</span><span class="params">(action: <span class="type">suspend</span> (<span class="type">e</span>: <span class="type">FlowDataEvent</span>) -&gt; <span class="type">Unit</span>)</span></span>: Job &#123;</span><br><span class="line">        <span class="keyword">return</span> flowEventBus.collectWhenCreated(<span class="keyword">this</span>)&#123;</span><br><span class="line">            action.invoke(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定Scope返回FlowDataEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">collectDataEvent</span><span class="params">(action: <span class="type">suspend</span> (<span class="type">e</span>: <span class="type">FlowDataEvent</span>) -&gt; <span class="type">Unit</span>)</span></span>: Job &#123;</span><br><span class="line">        <span class="keyword">return</span> launch &#123;</span><br><span class="line">            flowEventBus.collect&#123;</span><br><span class="line">                action.invoke(it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Flow<span class="type">&lt;T&gt;</span>.<span class="title">collectWhenCreated</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, action: <span class="type">suspend</span> (<span class="type">value</span>: <span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>: Job = owner.lifecycleScope.launch &#123;</span><br><span class="line">    owner.lifecycle.repeatOnLifecycle(Lifecycle.State.CREATED) &#123;</span><br><span class="line">        collect&#123;action.invoke(it)&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="对外调用扩展"><a href="#对外调用扩展" class="headerlink" title="对外调用扩展"></a>对外调用扩展</h2><ul>
<li>根据事件名做一个String类型的扩展，LifecycleOwner和CoroutineScope适配Fragment/Activity和ViewModel场景的绑定订阅者，监听事件获取发送的数据</li>
<li>根据需要发送的任意对象，传入事件名称构建一个FlowDataEvent对象并调用FlowEventBus发送<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绑定事件，生命周期为LifecycleOwner</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> String.<span class="title">bindFlowEvent</span><span class="params">(lifecycleOwner: <span class="type">LifecycleOwner</span>,  block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">    lifecycleOwner.collectDataEvent &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.keyEvent == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> result = it.<span class="keyword">data</span> <span class="keyword">as</span>? T</span><br><span class="line">            result?.apply &#123;</span><br><span class="line">                block.invoke(<span class="keyword">this</span>)</span><br><span class="line">            &#125; ?: <span class="string">"lifecycleOwner bindFlowEvent convert T error"</span>.logD()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绑定事件，生命周期为CoroutineScope</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> String.<span class="title">bindFlowEvent</span><span class="params">(coroutineScope: <span class="type">CoroutineScope</span>, block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    coroutineScope.collectDataEvent &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.keyEvent == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> result = it.<span class="keyword">data</span> <span class="keyword">as</span>? T</span><br><span class="line">            result?.apply &#123;</span><br><span class="line">                block.invoke(<span class="keyword">this</span>)</span><br><span class="line">            &#125; ?: <span class="string">"coroutineScope bindFlowEvent convert T error"</span>.logD()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个当前对象为data的并发送</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Any.<span class="title">sendFlowEvent</span><span class="params">(key: <span class="type">String</span>)</span></span>&#123;</span><br><span class="line">    FlowEventBus.sendEvent(FlowDataEvent(key, <span class="keyword">this</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="解决痛点"><a href="#解决痛点" class="headerlink" title="解决痛点"></a>解决痛点</h1></li>
<li>临时事件滥用<br>收敛到一个文件，只能根据预先定义好的事件发送和接收</li>
<li>事件名易重复<br>采用object事件类的类名作为事件名保证唯一性</li>
<li>发送接收数据类型不一致<br>抽象出一个泛型抽象类，传入泛型的具体类型为发送和接收的统一类型，保证发送接收数据类型一致</li>
</ul>
<h2 id="泛型抽象类"><a href="#泛型抽象类" class="headerlink" title="泛型抽象类"></a>泛型抽象类</h2><p>所有FlowEventBus需要发送的事件类都要继承这个抽象类，保证发送和接收数据类型一致</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IEvent</span>&lt;<span class="type">T</span>&gt;  </span>&#123;</span><br><span class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendEvent</span><span class="params">(t: <span class="type">T</span>)</span></span>&#123;</span><br><span class="line">        t?.sendFlowEvent(<span class="keyword">this</span>.javaClass.name)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bindEvent</span><span class="params">(lifecycleOwner: <span class="type">LifecycleOwner</span>, block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.javaClass.name.bindFlowEvent(lifecycleOwner, block)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bindEvent</span><span class="params">(coroutineScope: <span class="type">CoroutineScope</span>, block: (<span class="type">T</span>) -&gt; <span class="type">Unit</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.javaClass.name.bindFlowEvent(coroutineScope, block)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义FlowEventBus的事件类"><a href="#定义FlowEventBus的事件类" class="headerlink" title="定义FlowEventBus的事件类"></a>定义FlowEventBus的事件类</h2><p>所有的事件定义在一个文件中方便维护，避免临时事件，事件名重复问题</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ClickItemEvent: IEvent&lt;BottomSheetDialogHelper.SelectEntity&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> TestEvent: IEvent&lt;String&gt;()</span><br></pre></td></tr></table></figure>

<h2 id="业务场景中使用"><a href="#业务场景中使用" class="headerlink" title="业务场景中使用"></a>业务场景中使用</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送 </span></span><br><span class="line">ClickItemEvent.sendEvent(selectEntity)</span><br><span class="line">TestEvent.sendEvent(<span class="string">"Test"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收</span></span><br><span class="line">ClickItemEvent.bindEvent(<span class="keyword">this</span>) &#123;</span><br><span class="line">  <span class="string">"<span class="subst">$&#123;it.toJson()&#125;</span>"</span>.logD()</span><br><span class="line">&#125;</span><br><span class="line">TestEvent.bindEvent(<span class="keyword">this</span>) &#123;</span><br><span class="line">  showToast(<span class="string">"<span class="variable">$it</span>"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/03/Dio-IOWebSocketChannel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/10/03/Dio-IOWebSocketChannel/" class="post-title-link" itemprop="url">flutter封装网络层（http和WebSocket请求）</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-10-03 20:46:59" itemprop="dateCreated datePublished" datetime="2022-10-03T20:46:59+08:00">2022-10-03</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-05 14:16:57" itemprop="dateModified" datetime="2022-10-05T14:16:57+08:00">2022-10-05</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flutter/" itemprop="url" rel="index">
                    <span itemprop="name">Flutter</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>一转眼来到国庆假期，核酸未停疫情还在，假期是个好好充电的日子，休息之余总结之前的工作度过一个充实的假期，但愿疫情快点过去，大家能回归到正常生活吧<br>上一篇写到了flutter的开发框架封装，其中用到了DioManager这个类，这个类主要是利用flutter框架提供的dio对网络层http请求做一个封装，另外由于业务需要，也封装了WebSocket请求，这里整理了一下具体的封装流程，欢迎一起交流讨论～</p>
<hr>
<h1 id="http请求封装"><a href="#http请求封装" class="headerlink" title="http请求封装"></a>http请求封装</h1><h2 id="封装数据传输Bean基础类"><a href="#封装数据传输Bean基础类" class="headerlink" title="封装数据传输Bean基础类"></a>封装数据传输Bean基础类</h2><p>这里以WanAndroid的Api为例</p>
<ul>
<li>data是泛型T，返回的数据内容</li>
<li>errorCode是后端返回的int类型的业务状态码</li>
<li>errorMsg是错误信息<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  BaseResult(&#123;</span><br><span class="line">    <span class="keyword">this</span>.data,</span><br><span class="line">    <span class="keyword">this</span>.errorCode,</span><br><span class="line">    <span class="keyword">this</span>.errorMsg,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> BaseResult.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> BaseResult(</span><br><span class="line">        data: json[<span class="string">'data'</span>],</span><br><span class="line">        errorCode: json[<span class="string">'errorCode'</span>],</span><br><span class="line">        errorMsg: json[<span class="string">'errorMsg'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">   * </span>不显示错误toast</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   */</span></span></span><br><span class="line">  <span class="built_in">bool</span> isSuccess() &#123;</span><br><span class="line">    <span class="keyword">return</span> errorCode == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  T? data;</span><br><span class="line">  <span class="built_in">int</span>? errorCode;</span><br><span class="line">  <span class="built_in">String</span>? errorMsg;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() &#123;</span><br><span class="line">    <span class="keyword">final</span> map = &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">      map[<span class="string">'data'</span>] = data;</span><br><span class="line">    &#125;</span><br><span class="line">    map[<span class="string">'errorCode'</span>] = errorCode;</span><br><span class="line">    map[<span class="string">'errorMsg'</span>] = errorMsg;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2>构造函数私有化，懒汉式构造单例<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> DioManager? instance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> DioManager? getInstance() &#123;</span><br><span class="line">  instance ??= DioManager._internal();</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DioManager._internal();</span><br></pre></td></tr></table></figure>
<h2 id="声明baseUrl和全局Header"><a href="#声明baseUrl和全局Header" class="headerlink" title="声明baseUrl和全局Header"></a>声明baseUrl和全局Header</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">String</span> getAppUrl() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"https://www.wanandroid.com"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; baseHeaders = &#123;</span><br><span class="line">    <span class="string">"X-SYSTEM"</span>: <span class="string">"Android"</span>,</span><br><span class="line">    <span class="string">"LANG"</span>: <span class="string">"zh_CN"</span>,</span><br><span class="line">    <span class="string">"x-app-token"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"X-VERSION"</span>: <span class="string">""</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="初始化DioManager"><a href="#初始化DioManager" class="headerlink" title="初始化DioManager"></a>初始化DioManager</h2>dio对象全局唯一，DioManager的构造函数中需要对options进行相关配置，全局header和baseUrl以及连接超时，接收超时，发送超时，添加日志拦截器，设置数据的返回格式为Json<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Dio dio = Dio();</span><br><span class="line"></span><br><span class="line">DioManager() &#123;</span><br><span class="line">  dio.options.headers = baseHeaders;</span><br><span class="line">  dio.options.baseUrl = getAppUrl();</span><br><span class="line">  dio.options.connectTimeout = <span class="number">15000</span>;</span><br><span class="line">  dio.options.receiveTimeout = <span class="number">15000</span>;</span><br><span class="line">  dio.options.sendTimeout = <span class="number">30000</span>;</span><br><span class="line">  <span class="comment">// 是否开启请求日志</span></span><br><span class="line">  <span class="keyword">if</span> (Global.isDebug) &#123;</span><br><span class="line">    dio.interceptors.addAll([LogInterceptor()]);</span><br><span class="line">  &#125;</span><br><span class="line">  dio.options.responseType = ResponseType.json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="封装get和post请求"><a href="#封装get和post请求" class="headerlink" title="封装get和post请求"></a>封装get和post请求</h2></li>
<li>post请求有表单和body两种方式，isForm为true时为表单请求默认为false</li>
<li>_request方法中统一处理，调用dio的request方法传path，data，queryParameters和options发起请求，根据post和get请求配置options的method，根据post表单和body两种请求方式配置contentType，如果是get请求携带的参数传queryParameters，post请求携带的参数传data</li>
<li>dio的request需要try-catch捕获异常，如果捕获到异常且needToast为true时通过toast展示异常code</li>
<li>获取到data数据后，如果是string则直接反序列化，否则调用Bean基础类BaseResult的fromJson反序列化，反序列化操作需要try-catch捕获异常，如果成功直接返回结果，否则返回序列化失败，如果当前是错误状态码且needToast为true时通过toast展示toast<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;BaseResult&gt; getRequest(<span class="built_in">String</span> url, &#123;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;? params&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _request(</span><br><span class="line">    url,</span><br><span class="line">    queryParameters: params,</span><br><span class="line">    options: Options(method: <span class="string">"GET"</span>),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;BaseResult&gt; postRequest(<span class="built_in">String</span> url,</span><br><span class="line">    &#123;<span class="keyword">dynamic</span> params, <span class="built_in">bool</span> isForm = <span class="keyword">false</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> contentType =</span><br><span class="line">        isForm ? Headers.formUrlEncodedContentType : Headers.jsonContentType;</span><br><span class="line">    <span class="keyword">final</span> options = Options(</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        extra: &#123;<span class="string">"dio_content_type"</span>: contentType&#125;,</span><br><span class="line">        contentType: contentType);</span><br><span class="line">    <span class="keyword">return</span> _request(url, data: params, options: options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;BaseResult&gt; _request(<span class="built_in">String</span> path,</span><br><span class="line">    &#123;data,</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;? queryParameters,</span><br><span class="line">    Options? options,</span><br><span class="line">    <span class="built_in">bool</span> needToast = <span class="keyword">true</span>&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Response response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    response = <span class="keyword">await</span> dio.request(path,</span><br><span class="line">        data: data, queryParameters: queryParameters, options: options);</span><br><span class="line">    &#125; on DioError <span class="keyword">catch</span> (error, stackTrace) &#123;</span><br><span class="line">    <span class="keyword">var</span> checkedError = _checkError(error);</span><br><span class="line">    <span class="keyword">final</span> statusCode =</span><br><span class="line">        checkedError.response?.statusCode ?? ResultCode.NO_NETWORK;</span><br><span class="line">    <span class="keyword">if</span> (needToast) &#123;</span><br><span class="line">        showToast(<span class="string">"network_error(<span class="subst">$&#123;statusCode.toString()&#125;</span>)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Global.isDebug) Future.error(checkedError, stackTrace);</span><br><span class="line">    <span class="keyword">return</span> BaseResult(errorCode: statusCode, errorMsg: error.message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//防止解析失败</span></span><br><span class="line">    <span class="keyword">var</span> data = response.data;</span><br><span class="line">    <span class="keyword">if</span> (data <span class="keyword">is</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">        data = json.decode(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> baseResult = BaseResult.fromJson(data);</span><br><span class="line">    <span class="keyword">if</span> (!baseResult.isSuccess() &amp;&amp; needToast) &#123;</span><br><span class="line">        showToast(baseResult.errorMsg ?? <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> baseResult;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex, stackTrace) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Global.isDebug) Future.error(ex, stackTrace);</span><br><span class="line">    <span class="keyword">return</span> BaseResult(</span><br><span class="line">        errorCode: ResultCode.JSON_ERROR, errorMsg: ex.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="错误码统一处理"><a href="#错误码统一处理" class="headerlink" title="错误码统一处理"></a>错误码统一处理</h2>如果返回的DioError的response为空或statusCode为空统一处理为没有网络，其余的错误类型转换为自定义的错误码便于混合开发时统计<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DioError _checkError(DioError error) &#123;</span><br><span class="line">    <span class="comment">// 如果response为空构造没有网络的response</span></span><br><span class="line">    <span class="comment">// 如果statusCode为空直接赋值为没有网络</span></span><br><span class="line">    <span class="comment"><span class="markdown">/// 统一认为是没有网络</span></span></span><br><span class="line">    Response errorResponse = error.response ??</span><br><span class="line">        Response(</span><br><span class="line">            statusCode: ResultCode.NO_NETWORK,</span><br><span class="line">            requestOptions: error.requestOptions);</span><br><span class="line"></span><br><span class="line">    errorResponse.statusCode ??= ResultCode.NO_NETWORK;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// 自定义请求超时错误码</span></span></span><br><span class="line">    <span class="keyword">if</span> (error.type == DioErrorType.connectTimeout) &#123;</span><br><span class="line">    errorResponse.statusCode = ResultCode.CONNECT_TIMEOUT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.type == DioErrorType.receiveTimeout) &#123;</span><br><span class="line">    errorResponse.statusCode = ResultCode.RECEIVE_TIMEOUT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.type == DioErrorType.sendTimeout) &#123;</span><br><span class="line">    errorResponse.statusCode = ResultCode.SEND_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    error.response = errorResponse;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultCode</span> </span>&#123;</span><br><span class="line">    <span class="comment"><span class="markdown">/// 业务错误</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> BIZ_ERROR = <span class="number">-111</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// json解析异常</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> JSON_ERROR = <span class="number">-100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// 没有网络</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> NO_NETWORK = <span class="number">-101</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">///连接超时</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> CONNECT_TIMEOUT = <span class="number">-102</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// 接收超时</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> RECEIVE_TIMEOUT = <span class="number">-103</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">///写数据超时</span></span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> SEND_TIMEOUT = <span class="number">-104</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
最后附上DioManager完整的源码：<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DioManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> DioManager? instance;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> DioManager() &#123;</span><br><span class="line">    instance ??= DioManager();</span><br><span class="line">    <span class="keyword">return</span> instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">String</span> getAppUrl() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"https://www.wanandroid.com"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; baseHeaders = &#123;</span><br><span class="line">    <span class="string">"X-SYSTEM"</span>: <span class="string">"Android"</span>,</span><br><span class="line">    <span class="string">"LANG"</span>: <span class="string">"zh_CN"</span>,</span><br><span class="line">    <span class="string">"x-app-token"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"X-VERSION"</span>: <span class="string">""</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Dio dio = Dio();</span><br><span class="line"></span><br><span class="line">  DioManager._internal() &#123;</span><br><span class="line">    dio.options.headers = baseHeaders;</span><br><span class="line">    dio.options.baseUrl = getAppUrl();</span><br><span class="line">    dio.options.connectTimeout = <span class="number">15000</span>;</span><br><span class="line">    dio.options.receiveTimeout = <span class="number">15000</span>;</span><br><span class="line">    dio.options.sendTimeout = <span class="number">30000</span>;</span><br><span class="line">    <span class="comment">// 是否开启请求日志</span></span><br><span class="line">    <span class="keyword">if</span> (Global.isDebug) &#123;</span><br><span class="line">      dio.interceptors.addAll([LogInterceptor()]);</span><br><span class="line">    &#125;</span><br><span class="line">    dio.options.responseType = ResponseType.json;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;BaseResult&gt; getRequest(<span class="built_in">String</span> url, &#123;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;? params&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _request(</span><br><span class="line">      url,</span><br><span class="line">      queryParameters: params,</span><br><span class="line">      options: Options(method: <span class="string">"GET"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;BaseResult&gt; postRequest(<span class="built_in">String</span> url,</span><br><span class="line">      &#123;<span class="keyword">dynamic</span> params, <span class="built_in">bool</span> isForm = <span class="keyword">false</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> contentType =</span><br><span class="line">        isForm ? Headers.formUrlEncodedContentType : Headers.jsonContentType;</span><br><span class="line">    <span class="keyword">final</span> options = Options(</span><br><span class="line">        method: <span class="string">"POST"</span>,</span><br><span class="line">        extra: &#123;<span class="string">"dio_content_type"</span>: contentType&#125;,</span><br><span class="line">        contentType: contentType);</span><br><span class="line">    <span class="keyword">return</span> _request(url, data: params, options: options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;BaseResult&gt; _request(<span class="built_in">String</span> path,</span><br><span class="line">      &#123;data,</span><br><span class="line">      <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;? queryParameters,</span><br><span class="line">      Options? options,</span><br><span class="line">      <span class="built_in">bool</span> needToast = <span class="keyword">true</span>&#125;) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Response response;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = <span class="keyword">await</span> dio.request(path,</span><br><span class="line">          data: data, queryParameters: queryParameters, options: options);</span><br><span class="line">    &#125; on DioError <span class="keyword">catch</span> (error, stackTrace) &#123;</span><br><span class="line">      <span class="keyword">var</span> checkedError = _checkError(error);</span><br><span class="line">      <span class="keyword">final</span> statusCode =</span><br><span class="line">          checkedError.response?.statusCode ?? ResultCode.NO_NETWORK;</span><br><span class="line">      <span class="keyword">if</span> (needToast) &#123;</span><br><span class="line">        showToast(<span class="string">"network_error(<span class="subst">$&#123;statusCode.toString()&#125;</span>)"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (Global.isDebug) Future.error(checkedError, stackTrace);</span><br><span class="line">      <span class="keyword">return</span> BaseResult(errorCode: statusCode, errorMsg: error.message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//防止解析失败</span></span><br><span class="line">      <span class="keyword">var</span> data = response.data;</span><br><span class="line">      <span class="keyword">if</span> (data <span class="keyword">is</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">        data = json.decode(data);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> baseResult = BaseResult.fromJson(data);</span><br><span class="line">      <span class="keyword">if</span> (!baseResult.isNotShowNetErrorToast() &amp;&amp; needToast) &#123;</span><br><span class="line">        showToast(baseResult.errorMsg ?? <span class="string">""</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> baseResult;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ex, stackTrace) &#123;</span><br><span class="line">      <span class="keyword">if</span> (Global.isDebug) Future.error(ex, stackTrace);</span><br><span class="line">      <span class="keyword">return</span> BaseResult(</span><br><span class="line">          errorCode: ResultCode.JSON_ERROR, errorMsg: ex.toString());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DioError _checkError(DioError error) &#123;</span><br><span class="line">    <span class="comment"><span class="markdown">/// 统一认为是没有网络</span></span></span><br><span class="line">    <span class="comment">// 如果response为空构造没有网络的response</span></span><br><span class="line">    <span class="comment">// 如果statusCode为空直接赋值为没有网络</span></span><br><span class="line">    Response errorResponse = error.response ??</span><br><span class="line">        Response(</span><br><span class="line">            statusCode: ResultCode.NO_NETWORK,</span><br><span class="line">            requestOptions: error.requestOptions);</span><br><span class="line"></span><br><span class="line">    errorResponse.statusCode ??= ResultCode.NO_NETWORK;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// 自定义请求超时错误码</span></span></span><br><span class="line">    <span class="keyword">if</span> (error.type == DioErrorType.connectTimeout) &#123;</span><br><span class="line">      errorResponse.statusCode = ResultCode.CONNECT_TIMEOUT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.type == DioErrorType.receiveTimeout) &#123;</span><br><span class="line">      errorResponse.statusCode = ResultCode.RECEIVE_TIMEOUT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error.type == DioErrorType.sendTimeout) &#123;</span><br><span class="line">      errorResponse.statusCode = ResultCode.SEND_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    error.response = errorResponse;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// 跟宿主定义的http网络错误码保持一致</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultCode</span> </span>&#123;</span><br><span class="line">  <span class="comment"><span class="markdown">/// 业务错误</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> BIZ_ERROR = <span class="number">-111</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// json解析异常</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> JSON_ERROR = <span class="number">-100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 没有网络</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> NO_NETWORK = <span class="number">-101</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">///连接超时</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> CONNECT_TIMEOUT = <span class="number">-102</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">///It occurs when receiving timeout.</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> RECEIVE_TIMEOUT = <span class="number">-103</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">///写数据超时</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> SEND_TIMEOUT = <span class="number">-104</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="WebSocket请求封装"><a href="#WebSocket请求封装" class="headerlink" title="WebSocket请求封装"></a>WebSocket请求封装</h1><h2 id="封装数据传输Bean基础类-1"><a href="#封装数据传输Bean基础类-1" class="headerlink" title="封装数据传输Bean基础类"></a>封装数据传输Bean基础类</h2>根据服务端返回的内容封装一个bean类<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsBaseBean</span> </span>&#123;</span><br><span class="line">  Decimal? changeRate;</span><br><span class="line">  Decimal? lastTradedPrice;</span><br><span class="line">  <span class="built_in">String</span>? symbolCode;</span><br><span class="line">  Decimal? volValue;</span><br><span class="line"></span><br><span class="line">  WsBaseBean(</span><br><span class="line">      &#123;<span class="keyword">this</span>.changeRate, <span class="keyword">this</span>.lastTradedPrice, <span class="keyword">this</span>.symbolCode, <span class="keyword">this</span>.volValue&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> WsBaseBean.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> WsBaseBean(</span><br><span class="line">        changeRate: Decimal.tryParse(<span class="string">"<span class="subst">$&#123;json[<span class="string">"changeRate"</span>] ?? <span class="number">0.0</span>&#125;</span>"</span>),</span><br><span class="line">        lastTradedPrice: Decimal.tryParse(<span class="string">"<span class="subst">$&#123;json[<span class="string">"lastTradedPrice"</span>] ?? <span class="number">0.0</span>&#125;</span>"</span>),</span><br><span class="line">        symbolCode: json[<span class="string">"symbolCode"</span>],</span><br><span class="line">        volValue: Decimal.tryParse(<span class="string">"<span class="subst">$&#123;json[<span class="string">"volValue"</span>] ?? <span class="number">0.0</span>&#125;</span>"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="单例模式-1"><a href="#单例模式-1" class="headerlink" title="单例模式"></a>单例模式</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/// 单例对象</span></span></span><br><span class="line"><span class="keyword">static</span> WebSocketUtility? _socket;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// 内部构造方法，可避免外部暴露构造函数，进行实例化</span></span></span><br><span class="line">WebSocketUtility._internal();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// 获取单例内部方法</span></span></span><br><span class="line"><span class="keyword">factory</span> WebSocketUtility() &#123;</span><br><span class="line">  <span class="comment">// 只能有一个实例</span></span><br><span class="line">  _socket ??= WebSocketUtility._internal();</span><br><span class="line">  <span class="keyword">return</span> _socket!;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="声明Websocket地址和连接状态"><a href="#声明Websocket地址和连接状态" class="headerlink" title="声明Websocket地址和连接状态"></a>声明Websocket地址和连接状态</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">String</span> _SOCKET_URL = <span class="string">'ws://192.168.3.123:8181/test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> SocketStatus &#123;</span><br><span class="line">  socketStatusConnected, <span class="comment">// 已连接</span></span><br><span class="line">  socketStatusFailed, <span class="comment">// 失败</span></span><br><span class="line">  socketStatusClosed, <span class="comment">// 连接关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="声明变量"><a href="#声明变量" class="headerlink" title="声明变量"></a>声明变量</h2></li>
<li>定义回调，接连错误，接收消息，开始连接</li>
<li>定义IOWebSocketChannel实现WebSocket通信</li>
<li>定义心跳定时器和心跳间隔，每隔固定时长发送心跳</li>
<li>定义重连定时器和当前重连次数和最大重连次数，未达到最大重连次数时每隔固定时长重新连接</li>
<li>定义当前socket的连接状态<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IOWebSocketChannel? _webSocket; <span class="comment">// WebSocket</span></span><br><span class="line">SocketStatus? _socketStatus; <span class="comment">// socket状态</span></span><br><span class="line">Timer? _heartBeat; <span class="comment">// 心跳定时器</span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">int</span> _heartTimes = <span class="number">3000</span>; <span class="comment">// 心跳间隔(毫秒)</span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">int</span> _reconnectMaxCount = <span class="number">60</span>; <span class="comment">// 重连次数，默认60次</span></span><br><span class="line"><span class="built_in">int</span> _reconnectTimes = <span class="number">0</span>; <span class="comment">// 重连计数器</span></span><br><span class="line">Timer? _reconnectTimer; <span class="comment">// 重连定时器</span></span><br><span class="line">late <span class="built_in">Function</span> onError; <span class="comment">// 连接错误回调</span></span><br><span class="line">late <span class="built_in">Function</span> onOpen; <span class="comment">// 开始连接回调</span></span><br><span class="line">late <span class="built_in">Function</span> onMessage; <span class="comment">// 接收消息回调</span></span><br></pre></td></tr></table></figure>
<h2 id="开始连接"><a href="#开始连接" class="headerlink" title="开始连接"></a>开始连接</h2></li>
<li>初始化IOWebSocketChannel开始连接</li>
<li>设置_socketStatus连接状态</li>
<li>重置重连计数和定时器</li>
<li>调用onOpen回调</li>
<li>接收消息回调处理，收到消息调onMessage回调，连接错误调onError回调，连接推出时尝试重连<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/// 开启WebSocket连接</span></span></span><br><span class="line"><span class="keyword">void</span> openSocket() &#123;</span><br><span class="line">  closeSocket();</span><br><span class="line">  _webSocket = IOWebSocketChannel.connect(_SOCKET_URL);</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">'WebSocket连接成功: <span class="subst">$_SOCKET_URL</span>'</span>);</span><br><span class="line">  <span class="comment">// 连接成功，返回WebSocket实例</span></span><br><span class="line">  _socketStatus = SocketStatus.socketStatusConnected;</span><br><span class="line">  <span class="comment">// 连接成功，重置重连计数器</span></span><br><span class="line">  _reconnectTimes = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (_reconnectTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    _reconnectTimer?.cancel();</span><br><span class="line">    _reconnectTimer = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  onOpen();</span><br><span class="line">  <span class="comment">// 接收消息</span></span><br><span class="line">  _webSocket?.stream.listen((data) =&gt; onMessage(data), onError: (e) &#123;</span><br><span class="line">    WebSocketChannelException ex = e;</span><br><span class="line">    _socketStatus = SocketStatus.socketStatusFailed;</span><br><span class="line">    onError(ex.message);</span><br><span class="line">    closeSocket();</span><br><span class="line">  &#125;, onDone: () &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'closed'</span>);</span><br><span class="line">    reconnect();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="销毁心跳"><a href="#销毁心跳" class="headerlink" title="销毁心跳"></a>销毁心跳</h2>取消心跳定时器<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> destroyHeartBeat() &#123;</span><br><span class="line">  <span class="keyword">if</span> (_heartBeat != <span class="keyword">null</span>) &#123;</span><br><span class="line">    _heartBeat?.cancel();</span><br><span class="line">    _heartBeat = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化并开启心跳"><a href="#初始化并开启心跳" class="headerlink" title="初始化并开启心跳"></a>初始化并开启心跳</h2>如果心跳定时器已经初始化则销毁，重新初始化并开启心跳发送任务<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> initHeartBeat() &#123;</span><br><span class="line">  destroyHeartBeat();</span><br><span class="line">  _heartBeat = Timer.periodic(<span class="built_in">Duration</span>(milliseconds: _heartTimes), (timer) &#123;</span><br><span class="line">    sendMessage(<span class="string">'&#123;"module": "HEART_CHECK", "message": "请求心跳"&#125;'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="发送WebSocket消息"><a href="#发送WebSocket消息" class="headerlink" title="发送WebSocket消息"></a>发送WebSocket消息</h2>如果当前的连接状态是已连接则发送消息，否则打印当前状态<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/// 发送WebSocket消息</span></span></span><br><span class="line"> <span class="keyword">void</span> sendMessage(message) &#123;</span><br><span class="line">   <span class="keyword">if</span> (_webSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">switch</span> (_socketStatus) &#123;</span><br><span class="line">       <span class="keyword">case</span> SocketStatus.socketStatusConnected:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">'发送中：'</span> + message);</span><br><span class="line">         _webSocket?.sink.add(message);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SocketStatus.socketStatusClosed:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">'连接已关闭'</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> SocketStatus.socketStatusFailed:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">'发送失败'</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="重连机制"><a href="#重连机制" class="headerlink" title="重连机制"></a>重连机制</h2>如果当前未达到最大连接次数则重连次数+1，开启重连定时器，执行WebSocket连接，否则如果重连定时器不为空则销毁<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/// 重连机制</span></span></span><br><span class="line">  <span class="keyword">void</span> reconnect() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_reconnectTimes &lt; _reconnectMaxCount) &#123;</span><br><span class="line">      _reconnectTimes++;</span><br><span class="line">      _reconnectTimer =</span><br><span class="line">          Timer.periodic(<span class="built_in">Duration</span>(milliseconds: _heartTimes), (timer) &#123;</span><br><span class="line">        openSocket();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (_reconnectTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'重连次数超过最大次数'</span>);</span><br><span class="line">        _reconnectTimer?.cancel();</span><br><span class="line">        _reconnectTimer = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
最后附上WebSocketUtility完整的源码:<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/// WebSocket地址</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">String</span> _SOCKET_URL = <span class="string">'ws://192.168.3.123:8181/test'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// WebSocket状态</span></span></span><br><span class="line"><span class="keyword">enum</span> SocketStatus &#123;</span><br><span class="line">  socketStatusConnected, <span class="comment">// 已连接</span></span><br><span class="line">  socketStatusFailed, <span class="comment">// 失败</span></span><br><span class="line">  socketStatusClosed, <span class="comment">// 连接关闭</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebSocketUtility</span> </span>&#123;</span><br><span class="line">  <span class="comment"><span class="markdown">/// 单例对象</span></span></span><br><span class="line">  <span class="keyword">static</span> WebSocketUtility? _socket;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 内部构造方法，可避免外部暴露构造函数，进行实例化</span></span></span><br><span class="line">  WebSocketUtility._internal();</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 获取单例内部方法</span></span></span><br><span class="line">  <span class="keyword">factory</span> WebSocketUtility() &#123;</span><br><span class="line">    <span class="comment">// 只能有一个实例</span></span><br><span class="line">    _socket ??= WebSocketUtility._internal();</span><br><span class="line">    <span class="keyword">return</span> _socket!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  IOWebSocketChannel? _webSocket; <span class="comment">// WebSocket</span></span><br><span class="line">  SocketStatus? _socketStatus; <span class="comment">// socket状态</span></span><br><span class="line">  Timer? _heartBeat; <span class="comment">// 心跳定时器</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> _heartTimes = <span class="number">3000</span>; <span class="comment">// 心跳间隔(毫秒)</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> _reconnectMaxCount = <span class="number">60</span>; <span class="comment">// 重连次数，默认60次</span></span><br><span class="line">  <span class="built_in">int</span> _reconnectTimes = <span class="number">0</span>; <span class="comment">// 重连计数器</span></span><br><span class="line">  Timer? _reconnectTimer; <span class="comment">// 重连定时器</span></span><br><span class="line">  late <span class="built_in">Function</span> onError; <span class="comment">// 连接错误回调</span></span><br><span class="line">  late <span class="built_in">Function</span> onOpen; <span class="comment">// 连接开启回调</span></span><br><span class="line">  late <span class="built_in">Function</span> onMessage; <span class="comment">// 接收消息回调</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 初始化WebSocket</span></span></span><br><span class="line">  <span class="keyword">void</span> initWebSocket(</span><br><span class="line">      &#123;required <span class="built_in">Function</span> onOpen,</span><br><span class="line">      required <span class="built_in">Function</span> onMessage,</span><br><span class="line">      required <span class="built_in">Function</span> onError&#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.onOpen = onOpen;</span><br><span class="line">    <span class="keyword">this</span>.onMessage = onMessage;</span><br><span class="line">    <span class="keyword">this</span>.onError = onError;</span><br><span class="line">    openSocket();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 开启WebSocket连接</span></span></span><br><span class="line">  <span class="keyword">void</span> openSocket() &#123;</span><br><span class="line">    closeSocket();</span><br><span class="line">    _webSocket = IOWebSocketChannel.connect(_SOCKET_URL);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'WebSocket连接成功: <span class="subst">$_SOCKET_URL</span>'</span>);</span><br><span class="line">    <span class="comment">// 连接成功，返回WebSocket实例</span></span><br><span class="line">    _socketStatus = SocketStatus.socketStatusConnected;</span><br><span class="line">    <span class="comment">// 连接成功，重置重连计数器</span></span><br><span class="line">    _reconnectTimes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (_reconnectTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">      _reconnectTimer?.cancel();</span><br><span class="line">      _reconnectTimer = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onOpen();</span><br><span class="line">    <span class="comment">// 接收消息</span></span><br><span class="line">    _webSocket?.stream.listen((data) =&gt; onMessage(data), onError: (e) &#123;</span><br><span class="line">      WebSocketChannelException ex = e;</span><br><span class="line">      _socketStatus = SocketStatus.socketStatusFailed;</span><br><span class="line">      onError(ex.message);</span><br><span class="line">      closeSocket();</span><br><span class="line">    &#125;, onDone: () &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">'closed'</span>);</span><br><span class="line">      reconnect();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 初始化心跳</span></span></span><br><span class="line">  <span class="keyword">void</span> initHeartBeat() &#123;</span><br><span class="line">    destroyHeartBeat();</span><br><span class="line">    _heartBeat = Timer.periodic(<span class="built_in">Duration</span>(milliseconds: _heartTimes), (timer) &#123;</span><br><span class="line">      sendMessage(<span class="string">'&#123;"module": "HEART_CHECK", "message": "请求心跳"&#125;'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 销毁心跳</span></span></span><br><span class="line">  <span class="keyword">void</span> destroyHeartBeat() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_heartBeat != <span class="keyword">null</span>) &#123;</span><br><span class="line">      _heartBeat?.cancel();</span><br><span class="line">      _heartBeat = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 关闭WebSocket</span></span></span><br><span class="line">  <span class="keyword">void</span> closeSocket() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_webSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">'WebSocket连接关闭'</span>);</span><br><span class="line">      _webSocket?.sink.close();</span><br><span class="line">      destroyHeartBeat();</span><br><span class="line">      _socketStatus = SocketStatus.socketStatusClosed;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 发送WebSocket消息</span></span></span><br><span class="line">  <span class="keyword">void</span> sendMessage(message) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_webSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (_socketStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> SocketStatus.socketStatusConnected:</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'发送中：'</span> + message);</span><br><span class="line">          _webSocket?.sink.add(message);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SocketStatus.socketStatusClosed:</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'连接已关闭'</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SocketStatus.socketStatusFailed:</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'发送失败'</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 重连机制</span></span></span><br><span class="line">  <span class="keyword">void</span> reconnect() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_reconnectTimes &lt; _reconnectMaxCount) &#123;</span><br><span class="line">      _reconnectTimes++;</span><br><span class="line">      _reconnectTimer =</span><br><span class="line">          Timer.periodic(<span class="built_in">Duration</span>(milliseconds: _heartTimes), (timer) &#123;</span><br><span class="line">        openSocket();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (_reconnectTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'重连次数超过最大次数'</span>);</span><br><span class="line">        _reconnectTimer?.cancel();</span><br><span class="line">        _reconnectTimer = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在Widget中使用"><a href="#在Widget中使用" class="headerlink" title="在Widget中使用"></a>在Widget中使用</h2>在initState中初始化WebSocket并在连接后开启心跳发送任务与服务端保持通信连接，在消息接收中反序列化实时刷新页面数据<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketTestWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> SocketTestWidget(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;SocketTestWidget&gt; createState() =&gt; _SocketTestWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_SocketTestWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">SocketTestWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">dynamic</span> data;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    WebSocketUtility().initWebSocket(onOpen: () &#123;</span><br><span class="line">      WebSocketUtility().initHeartBeat();</span><br><span class="line">    &#125;, onMessage: (data) &#123;</span><br><span class="line">      WsBaseBean wsBaseBean = WsBaseBean.fromJson(jsonDecode(data));</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        <span class="keyword">this</span>.data = wsBaseBean.changeRate;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, onError: (e) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"WebSocketUtility"</span> + e);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: <span class="keyword">const</span> Text(<span class="string">"SocketTest"</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: ListView(</span><br><span class="line">          children: [Text(<span class="string">'收到数据: <span class="subst">$&#123;data&#125;</span>'</span>)],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
看下flutter客户端的控制台输出效果<br><img src="/images/websocket_client.png" alt="效果图"></li>
</ul>
<p>最后我们可以用python写个简单的服务端脚本测试一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">websocket_users = set()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收客户端消息并处理</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">recv_user_msg</span><span class="params">(websocket)</span>:</span></span><br><span class="line"> <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  recv_text = <span class="keyword">await</span> websocket.recv()</span><br><span class="line">  print(<span class="string">"recv_text:"</span>, recv_text)</span><br><span class="line">  changeRate = random.randint(<span class="number">2000</span>, <span class="number">3000</span>) + random.random()</span><br><span class="line">  lastTradedPrice = random.randint(<span class="number">1000</span>, <span class="number">2000</span>) + random.random()</span><br><span class="line">  volValue = random.randint(<span class="number">4000</span>, <span class="number">5000</span>) + random.random()</span><br><span class="line">  recv_text = &#123;<span class="string">'changeRate'</span> : changeRate, <span class="string">'lastTradedPrice'</span> : lastTradedPrice, <span class="string">'symbolCode'</span> : <span class="string">"BTC-USDT"</span>, <span class="string">'volValue'</span> : volValue&#125;</span><br><span class="line">  data = json.dumps(recv_text)</span><br><span class="line">  print(data)</span><br><span class="line">  response_text = data</span><br><span class="line">  print(<span class="string">"response_text:"</span>, <span class="string">f"Server return: <span class="subst">&#123;data&#125;</span>"</span>)</span><br><span class="line">  <span class="keyword">await</span> websocket.send(response_text)</span><br><span class="line">  time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器端主逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(websocket, path)</span>:</span></span><br><span class="line"> <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">   <span class="keyword">await</span> recv_user_msg(websocket)</span><br><span class="line">  <span class="keyword">except</span> websockets.ConnectionClosed:</span><br><span class="line">   print(<span class="string">"ConnectionClosed..."</span>, path) <span class="comment"># 链接断开</span></span><br><span class="line">   print(<span class="string">"websocket_users old:"</span>, websocket_users)</span><br><span class="line">   websocket_users.remove(websocket)</span><br><span class="line">   print(<span class="string">"websocket_users new:"</span>, websocket_users)</span><br><span class="line">   <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">except</span> websockets.InvalidState:</span><br><span class="line">   print(<span class="string">"InvalidState..."</span>) <span class="comment"># 无效状态</span></span><br><span class="line">   <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">   print(<span class="string">"Exception:"</span>, e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> print(<span class="string">"192.168.3.123:8181 websocket..."</span>)</span><br><span class="line"> asyncio.get_event_loop().run_until_complete(websockets.serve(run, <span class="string">"192.168.3.123"</span>, <span class="number">8181</span>))</span><br><span class="line"> asyncio.get_event_loop().run_forever()</span><br></pre></td></tr></table></figure>
<p>看下服务端的控制台输出效果<br><img src="/images/websocket_server.png" alt="效果图"></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/09/17/FlutterMviGetX/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/09/17/FlutterMviGetX/" class="post-title-link" itemprop="url">MVI+GetX打造Flutter开发架构</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-09-17 19:58:08" itemprop="dateCreated datePublished" datetime="2022-09-17T19:58:08+08:00">2022-09-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-03 22:12:27" itemprop="dateModified" datetime="2022-10-03T22:12:27+08:00">2022-10-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flutter/" itemprop="url" rel="index">
                    <span itemprop="name">Flutter</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<ul>
<li>今年的互联网寒冬真是冰冷刺骨，高温+限电+地震+疫情让所有人都感觉到2022年活下来就好，既然疫情下的经济衰退无法避免，那就只能多准备点保暖的装备过冬了，作为菜鸟的我焦虑是无法避免的而学习可以平复心中的不安，大环境无法改变只能抓紧时间充电了，期待破局的那一天。</li>
<li>移动端开发趋近于饱和已经很久了，传统的开发方式需要ios和Android的两端的人力，为了达到双端一致的效果少不了沟通和UI交互校对的成本，如果项目以UI交互为主利用跨平台开发是有优势的，一套代码打造各端UI一致的体验，性能接近原生，提升人效受各大企业青睐，可能这是客户端最终的归宿吧，前有facebook的React后有google的flutter，连compose都有跨平台发展的迹象，随着flutter3.0的发布已经稳定支持所有终端，作为Android开发者面对这种强大的开发框架必须要赶紧学习起来，保持新技术的学习热情，顺应互联网时代的快速发展。</li>
<li>公司的项目中已经用上了flutter，对于二级页面采用混合式的开发方式，集成flutter到原生的项目当中，目前性能和稳定性表现都是非常不错的，由于hot reload开发效率也提升了不少，开发了一段时间后，我利用Android开发中的MVI架构思想和GetX状态管理封装了flutter的开发架构，目前集成到项目中在线上稳定运行，欢迎交流和讨论～</li>
</ul>
<hr>
<h1 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h1><p><img src="/images/flutter_arch.jpg" alt="效果图"></p>
<ul>
<li>先放上一张整体的架构图～</li>
<li>借鉴Android的MVI架构思想，整理一下大概思路：</li>
</ul>
<ol>
<li>ViewModel 会存储并公开界面要使用的状态。界面状态是经过 ViewModel 转换的应用数据</li>
<li>界面会向 ViewModel 发送用户事件通知</li>
<li>ViewModel 会处理用户操作并更新状态</li>
<li>更新后的状态将反馈给界面呈现</li>
<li>ViewModel的数据源是两种，本地数据源和服务端数据源，本地数据源来自于文件和数据库，服务端数据源是web服务端接口提供的数据</li>
</ol>
<h1 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h1><h2 id="LocalDataSource本地存储"><a href="#LocalDataSource本地存储" class="headerlink" title="LocalDataSource本地存储"></a>LocalDataSource本地存储</h2><p>引入shared_preferences到pubspec.yaml</p>
<h3 id="工具类封装"><a href="#工具类封装" class="headerlink" title="工具类封装"></a>工具类封装</h3><p>对shared_preferences进行封装，调用shared_preferences</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">bool</span>&gt; saveString2Sp(<span class="built_in">String</span> key, <span class="built_in">String</span> value) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  <span class="keyword">return</span> prefs.setString(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">String</span>?&gt; getStringFromSp(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  <span class="keyword">return</span> prefs.getString(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">bool</span>&gt; saveBool2Sp(<span class="built_in">String</span> key, <span class="built_in">bool</span> value) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  <span class="keyword">return</span> prefs.setBool(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">bool</span>?&gt; getBoolFromSp(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  <span class="keyword">return</span> prefs.getBool(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">bool</span>&gt; removeSp(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  <span class="keyword">return</span> prefs.remove(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="本地存储基类"><a href="#本地存储基类" class="headerlink" title="本地存储基类"></a>本地存储基类</h3><p>调用封装的工具类实现本地数据的操作</p>
<ul>
<li>本地数据缓存</li>
<li>本地数据获取</li>
<li>删除本地数据<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLocalDataSource</span> </span>&#123;</span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; saveCache(<span class="built_in">String</span> cacheData, <span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> saveString2Sp(key, cacheData);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">String</span>?&gt; readCache(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getStringFromSp(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>?&gt; deleteCache(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> removeSp(key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="网络请求基类"><a href="#网络请求基类" class="headerlink" title="网络请求基类"></a>网络请求基类</h3>引入dio到pubspec.yaml，初始化网络请求DioManager对象供实现类使用，封装了网络请求的Dio API<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRemoteDataSource</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> DioManager dioManager = DioManager.getInstance()!;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Repository基类"><a href="#Repository基类" class="headerlink" title="Repository基类"></a>Repository基类</h3>暴露本地数据操作接口</li>
<li>本地数据缓存</li>
<li>本地数据获取</li>
<li>删除本地数据<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRepository</span> </span>&#123;</span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; saveCache(<span class="built_in">String</span> cacheData, <span class="built_in">String</span> key);</span><br><span class="line">  Future&lt;<span class="built_in">String</span>?&gt; readCache(<span class="built_in">String</span> key);</span><br><span class="line">  Future&lt;<span class="built_in">bool</span>?&gt; deleteCache(<span class="built_in">String</span> key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Repository基础实现类"><a href="#Repository基础实现类" class="headerlink" title="Repository基础实现类"></a>Repository基础实现类</h3></li>
<li>需外部传入本地数据，网络请求操作对象</li>
<li>方便外部自定义BaseLocalDataSource，替换shared_preferences，实现本地数据操作方法</li>
<li>方便外部自定义BaseRemoteDataSource， 定义网络请求的相关接口</li>
<li>网络请求的相关接口在外部Repository实现类中实现<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseRepositoryImp</span>&lt;<span class="title">Local</span> <span class="keyword">extends</span> <span class="title">BaseLocalDataSource</span>,</span></span><br><span class="line"><span class="class">    <span class="title">Remote</span> <span class="keyword">extends</span> <span class="title">BaseRemoteDataSource</span>&gt; <span class="keyword">implements</span> <span class="title">BaseRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Local? localDataSource;</span><br><span class="line">  <span class="keyword">final</span> Remote remoteDataSource;</span><br><span class="line"></span><br><span class="line">  BaseRepositoryImp(&#123;<span class="keyword">this</span>.localDataSource, required <span class="keyword">this</span>.remoteDataSource&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; saveCache(<span class="built_in">String</span> cacheData, <span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> isSuccess = <span class="keyword">await</span> localDataSource?.saveCache(cacheData, key);</span><br><span class="line">    <span class="keyword">return</span> isSuccess ?? <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="built_in">String</span>?&gt; readCache(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> localDataSource?.readCache(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>?&gt; deleteCache(<span class="built_in">String</span> key) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> isSuccess = <span class="keyword">await</span> localDataSource?.deleteCache(key);</span><br><span class="line">    <span class="keyword">return</span> isSuccess ?? <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Binding基类"><a href="#Binding基类" class="headerlink" title="Binding基类"></a>Binding基类</h1>注入repository实现类<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面binding封装，注入repository</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseBinding</span>&lt;<span class="title">R</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>&gt; <span class="keyword">extends</span> <span class="title">Bindings</span> </span>&#123;</span><br><span class="line">  R provideRepository();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="封装页面基类"><a href="#封装页面基类" class="headerlink" title="封装页面基类"></a>封装页面基类</h1>继承StatelessWidget，暴露viewModel的get接口，重写build方法<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseView</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseViewModel</span>&gt; <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> BaseView(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  T <span class="keyword">get</span> viewModel =&gt; GetInstance().find&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="封装页面基类ViewModel"><a href="#封装页面基类ViewModel" class="headerlink" title="封装页面基类ViewModel"></a>封装页面基类ViewModel</h1></li>
</ul>
<ol>
<li>引入GetX到pubspec.yaml</li>
<li>FullLifeCycleController的生命周期</li>
</ol>
<ul>
<li>onInit Controller初始化</li>
<li>onReady 处理异步事件，网络请求</li>
<li>onResumed 应用可见且页面回到前台</li>
<li>onInactive 应用在前台但页面不可见</li>
<li>onPaused 应用不可见且页面到后台</li>
<li>onDetach 页面视图销毁</li>
<li>onClose 关闭流对象，动画，释放内存，数据持久化</li>
</ul>
<ol start="3">
<li>继承FullLifeCycleController混入FullLifeCycleMixin重写生命周期方法，传入Repository的实现类定义Repository对象的具体类型，初始化数据埋点收集对象TrackPageViewHelper，通过桥调用native SDK中的API实现的，传入Repository对象，在生命周期做数据埋点，onInit和onResumed调用数据埋点的onPageShow，onInactive和onClose调用数据埋点的onPageHide<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseViewModel</span>&lt;<span class="title">Repository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>?&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">FullLifeCycleController</span> <span class="title">with</span> <span class="title">FullLifeCycleMixin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Repository? repository;</span><br><span class="line"></span><br><span class="line">  BaseViewModel(&#123;<span class="keyword">this</span>.repository&#125;);</span><br><span class="line"></span><br><span class="line">  TrackPageViewHelper? trackPageViewHelper;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> pageId() =&gt; <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> onInit() &#123;</span><br><span class="line">    <span class="keyword">if</span> (pageId().isNotEmpty) &#123;</span><br><span class="line">      trackPageViewHelper = TrackPageViewHelper(pageId());</span><br><span class="line">      trackPageViewHelper?.onPageShow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/// viewModel的初始化工作，例如一些成员属性的初始化</span></span></span><br><span class="line">    <span class="keyword">super</span>.onInit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onReady() &#123;</span><br><span class="line">    <span class="comment"><span class="markdown">/// 处理异步事件，比如网络请求</span></span></span><br><span class="line">    <span class="keyword">super</span>.onReady();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> onClose() &#123;</span><br><span class="line">    <span class="keyword">if</span> (pageId().isNotEmpty) &#123;</span><br><span class="line">      trackPageViewHelper?.onPageHide();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onClose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> onResumed() &#123;</span><br><span class="line">    <span class="keyword">if</span> (pageId().isNotEmpty) &#123;</span><br><span class="line">      trackPageViewHelper?.onPageShow();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> onInactive() &#123;</span><br><span class="line">    <span class="keyword">if</span> (pageId().isNotEmpty) &#123;</span><br><span class="line">      trackPageViewHelper?.onPageHide();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onPaused() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onDetached() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="通用页面基类"><a href="#通用页面基类" class="headerlink" title="通用页面基类"></a>通用页面基类</h1>根据当前封装的页面基类和ViewModel基类封装普通/列表/下拉刷新列表页，分别封装它们对应的UIState/Page/ViewModel<h2 id="普通页基类"><a href="#普通页基类" class="headerlink" title="普通页基类"></a>普通页基类</h2><h3 id="封装UIState"><a href="#封装UIState" class="headerlink" title="封装UIState"></a>封装UIState</h3>UIState只定义与UI刷新相关的变量，结合GetX的Obx机制刷新使用obs变量，普通页的UIState封装内容View的显示状态，根据当前的几个状态加载中/空页面/错误页来展示页面当前View<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只定义UI显示所需要的state，其他和界面显示无关的state，请放在ViewModel</span></span><br><span class="line"><span class="comment">// 普通页面UIState</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePageUIState</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> isLoading = <span class="keyword">true</span>;</span><br><span class="line">  <span class="built_in">bool</span> isEmpty = <span class="keyword">false</span>;</span><br><span class="line">  <span class="built_in">bool</span> isError = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装ViewModel"><a href="#封装ViewModel" class="headerlink" title="封装ViewModel"></a>封装ViewModel</h3>传入UIState的实例化对象和Repository的实例化对象，继承自前面封装的基类ViewModel，暴露状态传入的接口并利用GetX的GetBuilder刷新状态视图<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePageViewModel</span>&lt;<span class="title">UIState</span> <span class="keyword">extends</span> <span class="title">BasePageUIState</span>,</span></span><br><span class="line"><span class="class">    <span class="title">Repository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>?&gt; <span class="keyword">extends</span> <span class="title">BaseViewModel</span>&lt;<span class="title">Repository</span>?&gt; </span>&#123;</span><br><span class="line">  BasePageViewModel(&#123;Repository? repository, required <span class="keyword">this</span>.uiState&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(repository: repository);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> UIState uiState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> activeStatus(</span><br><span class="line">      &#123;<span class="built_in">bool</span> isLoading = <span class="keyword">false</span>, <span class="built_in">bool</span> isEmpty = <span class="keyword">false</span>, <span class="built_in">bool</span> isError = <span class="keyword">false</span>&#125;) &#123;</span><br><span class="line">    uiState.isLoading = isLoading;</span><br><span class="line">    uiState.isEmpty = isEmpty;</span><br><span class="line">    uiState.isError = isError;</span><br><span class="line">    update([<span class="string">'status'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装普通页面"><a href="#封装普通页面" class="headerlink" title="封装普通页面"></a>封装普通页面</h3></li>
</ol>
<ul>
<li>定义页面背景色，appBar背景色</li>
<li>重写build方法，设置页面背景色和appBar背景色</li>
<li>标题居中，设置左侧返回按钮，右侧操作按钮</li>
<li>暴露标题设置，左侧/右侧按钮设置，空界面，网络错误界面，重试，点击返回，内容界面绘制接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePage</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BasePageViewModel</span>&gt; <span class="keyword">extends</span> <span class="title">BaseView</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> BasePage(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  Color <span class="keyword">get</span> backgroundColor =&gt; ColorConfig.background;</span><br><span class="line"></span><br><span class="line">  Color <span class="keyword">get</span> appBarBackgroundColor =&gt; ColorConfig.background;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      backgroundColor: backgroundColor,</span><br><span class="line">      resizeToAvoidBottomInset: <span class="keyword">false</span>,</span><br><span class="line">      appBar: appbar(context),</span><br><span class="line">      body: body(context),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  PreferredSizeWidget? appbar(BuildContext buildContext) &#123;</span><br><span class="line">    <span class="keyword">return</span> AppBar(</span><br><span class="line">      brightness: Global.isDark! ? Brightness.dark : Brightness.light,</span><br><span class="line">      backgroundColor: appBarBackgroundColor,</span><br><span class="line">      elevation: <span class="number">0</span>,</span><br><span class="line">      centerTitle: <span class="keyword">true</span>,</span><br><span class="line">      leading: leading(buildContext),</span><br><span class="line">      title: title(),</span><br><span class="line">      actions: actions(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 返回按钮</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget? leading(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> IconButton(</span><br><span class="line">      splashColor: Colors.transparent,</span><br><span class="line">      highlightColor: Colors.transparent,</span><br><span class="line">      icon: Image.asset(</span><br><span class="line">        <span class="string">'resource/images/icon_back.png'</span>,</span><br><span class="line">        width: <span class="number">24</span>,</span><br><span class="line">        height: <span class="number">24</span>,</span><br><span class="line">        color: ColorConfig.emphasis,</span><br><span class="line">      ),</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        onBackClick(context);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 标题字符串</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">String</span> titleString() =&gt; <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 标题</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget? title() &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      padding: EdgeInsetsDirectional.only(bottom: <span class="number">5</span>),</span><br><span class="line">      child: Text(</span><br><span class="line">        titleString(),</span><br><span class="line">        overflow: TextOverflow.ellipsis,</span><br><span class="line">        style: TextStyle(</span><br><span class="line">          color: ColorConfig.emphasis,</span><br><span class="line">          fontSize: <span class="number">18</span>,</span><br><span class="line">        ),</span><br><span class="line">        textAlign: TextAlign.center,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt;? actions() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget body(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GetBuilder&lt;T&gt;(</span><br><span class="line">        id: <span class="string">'status'</span>,</span><br><span class="line">        builder: (viewModel) &#123;</span><br><span class="line">          <span class="keyword">if</span> (viewModel.uiState.isLoading) &#123;</span><br><span class="line">            <span class="keyword">return</span> loading();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewModel.uiState.isEmpty) &#123;</span><br><span class="line">            <span class="keyword">return</span> empty();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (viewModel.uiState.isError) &#123;</span><br><span class="line">            <span class="keyword">return</span> networkError();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> content(context);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 子类实现该方法，创建自己的UI</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget content(BuildContext context);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget loading() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> PageLoading();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget empty() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> Padding(</span><br><span class="line">      padding: EdgeInsetsDirectional.only(</span><br><span class="line">        top: <span class="number">152</span>,</span><br><span class="line">      ),</span><br><span class="line">      child: PageEmpty(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget networkError() &#123;</span><br><span class="line">    <span class="keyword">return</span> PageNetworkError(</span><br><span class="line">      onRetry: onRetry,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 点击重试时回调</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="keyword">void</span> onRetry() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="keyword">void</span> onBackClick(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Navigator.canPop(context)) &#123;</span><br><span class="line">      Navigator.pop(context);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Global.bridge.pop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="列表页基类"><a href="#列表页基类" class="headerlink" title="列表页基类"></a>列表页基类</h2><h3 id="封装列表UIState"><a href="#封装列表UIState" class="headerlink" title="封装列表UIState"></a>封装列表UIState</h3>继承普通页的UIState增加dataList变量<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>普通列表UIState</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> */</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseListPageUIState</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BasePageUIState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;T&gt; dataList = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装列表ViewModel"><a href="#封装列表ViewModel" class="headerlink" title="封装列表ViewModel"></a>封装列表ViewModel</h3>传入列表UIState实现类，列表Repository实现类，重写onReady方法调数据刷新接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseListPageViewModel</span>&lt;<span class="title">UIState</span> <span class="keyword">extends</span> <span class="title">BaseListPageUIState</span>,</span></span><br><span class="line"><span class="class">        <span class="title">Repository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BasePageViewModel</span>&lt;<span class="title">UIState</span>, <span class="title">Repository</span>&gt; </span>&#123;</span><br><span class="line">  BaseListPageViewModel(</span><br><span class="line">      &#123;required Repository repository, required UIState uiState&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(repository: repository, uiState: uiState);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onReady() &#123;</span><br><span class="line">    refreshData(isFirstLoading: <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">super</span>.onReady();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; refreshData(&#123;<span class="built_in">bool</span> isFirstLoading = <span class="keyword">false</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装列表页"><a href="#封装列表页" class="headerlink" title="封装列表页"></a>封装列表页</h3>继承普通页面基类，传入列表ViewModel，重写content方法返回带下拉刷新的listview，暴露itemExtent接口设置固定的高度重写可提升性能，设置itemCount为viewModel内置UIState中的dataList的数据长度，暴露listview的item接口给外部定义视图<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseListPage</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseListPageViewModel</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BasePage</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> BaseListPage(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget content(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GetBuilder&lt;T&gt;(</span><br><span class="line">        id: <span class="string">'listview'</span>,</span><br><span class="line">        builder: (viewModel) &#123;</span><br><span class="line">          <span class="keyword">return</span> EasyRefresh(</span><br><span class="line">            onRefresh: () <span class="keyword">async</span> &#123;</span><br><span class="line">              <span class="keyword">await</span> viewModel.refreshData();</span><br><span class="line">            &#125;,</span><br><span class="line">            child: ListView.builder(</span><br><span class="line">              scrollDirection: Axis.vertical,</span><br><span class="line">              itemExtent: itemExtent(),</span><br><span class="line">              itemCount: itemCount(),</span><br><span class="line">              shrinkWrap: <span class="keyword">true</span>,</span><br><span class="line">              itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">                <span class="keyword">return</span> item(context, index);</span><br><span class="line">              &#125;,</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/// 已知item固定高度时设置itemExtent值，提升列表滚动性能</span></span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">double</span>? itemExtent() =&gt; <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">int</span>? itemCount() =&gt; viewModel.uiState.dataList.length;</span><br><span class="line"></span><br><span class="line">  Widget item(BuildContext context, <span class="built_in">int</span> index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="下拉刷新列表页基类"><a href="#下拉刷新列表页基类" class="headerlink" title="下拉刷新列表页基类"></a>下拉刷新列表页基类</h2><h3 id="封装UIState-1"><a href="#封装UIState-1" class="headerlink" title="封装UIState"></a>封装UIState</h3>继承列表UIState增加isEmptyList变量用于控制是否展示空列表视图<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseLoadMoreListPageUIState</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseListPageUIState</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> isEmptyList = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装ViewModel-1"><a href="#封装ViewModel-1" class="headerlink" title="封装ViewModel"></a>封装ViewModel</h3>继承列表ViewModel传入列表UIState实现类，列表Repository实现类，定义EasyRefreshController对象并在onInit中初始化，定义当前页数和是否有下一页变量支持分页加载，暴露加载下一页数据和刷新列表的接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLoadMoreListViewModel</span>&lt;</span></span><br><span class="line"><span class="class">        <span class="title">UIState</span> <span class="keyword">extends</span> <span class="title">BaseLoadMoreListPageUIState</span>,</span></span><br><span class="line"><span class="class">        <span class="title">Repository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BaseListPageViewModel</span>&lt;<span class="title">UIState</span>, <span class="title">Repository</span>&gt; </span>&#123;</span><br><span class="line">  late <span class="keyword">final</span> EasyRefreshController controller;</span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">int</span> currentPage = <span class="number">1</span>;</span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">bool</span> hasNext = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  BaseLoadMoreListViewModel(</span><br><span class="line">      &#123;required Repository repository, required UIState uiState&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(repository: repository, uiState: uiState);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onInit() &#123;</span><br><span class="line">    controller = EasyRefreshController();</span><br><span class="line">    <span class="keyword">super</span>.onInit();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载下一页数据时，后端某些分页api采用偏移量计算下一页数据；某些是currentPage自增；</span></span><br><span class="line">  Future&lt;<span class="keyword">void</span>&gt; loadNextPageData();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onClose() &#123;</span><br><span class="line">    controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.onClose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> updatePageList() &#123;</span><br><span class="line">    update([<span class="string">'listView'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装加载更多列表页"><a href="#封装加载更多列表页" class="headerlink" title="封装加载更多列表页"></a>封装加载更多列表页</h3>继承列表页基类，传入加载更多列表的ViewModel，重写content方法，利用GetX的GetBuilder设置列表的id，设置列表的下拉刷新和加载更多回调，根据UIState的isEmptyList设置通用空白页面的显示，设置列表的通用底部视图，如果列表不为空加载下一页否则不加载数据<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLoadMoreListPage</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseLoadMoreListViewModel</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BaseListPage</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> BaseLoadMoreListPage(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget content(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GetBuilder&lt;T&gt;(</span><br><span class="line">      id: <span class="string">'listView'</span>,</span><br><span class="line">      builder: (viewModel) &#123;</span><br><span class="line">        <span class="keyword">return</span> createContentWidget(viewModel);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  Widget createContentWidget(viewModel) &#123;</span><br><span class="line">    <span class="keyword">return</span> EasyRefresh(</span><br><span class="line">      enableControlFinishLoad: <span class="keyword">false</span>,</span><br><span class="line">      enableControlFinishRefresh: <span class="keyword">false</span>,</span><br><span class="line">      taskIndependence: <span class="keyword">true</span>,</span><br><span class="line">      topBouncing: <span class="keyword">false</span>,</span><br><span class="line">      behavior: <span class="keyword">null</span>,</span><br><span class="line">      bottomBouncing: <span class="keyword">false</span>,</span><br><span class="line">      footer: PageFooter(),</span><br><span class="line">      controller: viewModel.controller,</span><br><span class="line">      emptyWidget: viewModel.uiState.isEmptyList ? empty() : <span class="keyword">null</span>,</span><br><span class="line">      onRefresh: () <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> viewModel.refreshData();</span><br><span class="line">      &#125;,</span><br><span class="line">      onLoad:</span><br><span class="line">          viewModel.uiState.isEmptyList || viewModel.uiState.dataList.isEmpty</span><br><span class="line">              ? <span class="keyword">null</span></span><br><span class="line">              : () <span class="keyword">async</span> &#123;</span><br><span class="line">                  <span class="keyword">await</span> viewModel.loadNextPageData();</span><br><span class="line">                &#125;,</span><br><span class="line">      child: ListView.builder(</span><br><span class="line">        scrollDirection: Axis.vertical,</span><br><span class="line">        itemExtent: itemExtent(),</span><br><span class="line">        itemCount: itemCount(),</span><br><span class="line">        shrinkWrap: <span class="keyword">true</span>,</span><br><span class="line">        itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">          <span class="keyword">return</span> item(context, index);</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget empty() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> Padding(</span><br><span class="line">      padding: EdgeInsetsDirectional.only(</span><br><span class="line">        top: <span class="number">40</span>,</span><br><span class="line">      ),</span><br><span class="line">      child: PageEmpty(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="封装通用视图"><a href="#封装通用视图" class="headerlink" title="封装通用视图"></a>封装通用视图</h1><h2 id="空界面"><a href="#空界面" class="headerlink" title="空界面"></a>空界面</h2>通用的空界面视图，中间展示图标和文本，适配黑白模式<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageEmpty</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PageEmpty(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      alignment: Alignment.topCenter,</span><br><span class="line">      child: Column(</span><br><span class="line">        mainAxisSize: MainAxisSize.min,</span><br><span class="line">        crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          Image.asset(</span><br><span class="line">            _provideImagePath(),</span><br><span class="line">            width: <span class="number">180</span>,</span><br><span class="line">            height: <span class="number">180</span>,</span><br><span class="line">          ),</span><br><span class="line">          <span class="keyword">const</span> Padding(</span><br><span class="line">            padding: EdgeInsetsDirectional.only(top: <span class="number">12</span>),</span><br><span class="line">          ),</span><br><span class="line">          Text(</span><br><span class="line">            <span class="string">'empty'</span>,</span><br><span class="line">            style: TextStyle(</span><br><span class="line">              fontSize: <span class="number">14</span>,</span><br><span class="line">              color: ColorConfig.emphasis60,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> _provideImagePath() &#123;</span><br><span class="line">    <span class="built_in">bool</span> isDark = Global.isDark ?? <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isDark) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"resource/images/ic_no_record_dark.png"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"resource/images/ic_no_record.png"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="列表底部视图"><a href="#列表底部视图" class="headerlink" title="列表底部视图"></a>列表底部视图</h2>通用的列表底部视图，居中展示文本<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageFooter</span> <span class="keyword">extends</span> <span class="title">Footer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> LinkFooterNotifier linkNotifier = LinkFooterNotifier();</span><br><span class="line">  PageFooter(&#123;<span class="built_in">bool</span> safeArea = <span class="keyword">true</span>&#125;) : <span class="keyword">super</span>(safeArea: safeArea);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget contentBuilder(</span><br><span class="line">      BuildContext context,</span><br><span class="line">      LoadMode loadState,</span><br><span class="line">      <span class="built_in">double</span> pulledExtent,</span><br><span class="line">      <span class="built_in">double</span> loadTriggerPullDistance,</span><br><span class="line">      <span class="built_in">double</span> loadIndicatorExtent,</span><br><span class="line">      AxisDirection axisDirection,</span><br><span class="line">      <span class="built_in">bool</span> float,</span><br><span class="line">      <span class="built_in">Duration</span>? completeDuration,</span><br><span class="line">      <span class="built_in">bool</span> enableInfiniteLoad,</span><br><span class="line">      <span class="built_in">bool</span> success,</span><br><span class="line">      <span class="built_in">bool</span> noMore) &#123;</span><br><span class="line">    linkNotifier.contentBuilder(</span><br><span class="line">        context,</span><br><span class="line">        loadState,</span><br><span class="line">        pulledExtent,</span><br><span class="line">        loadTriggerPullDistance,</span><br><span class="line">        loadIndicatorExtent,</span><br><span class="line">        axisDirection,</span><br><span class="line">        float,</span><br><span class="line">        completeDuration,</span><br><span class="line">        enableInfiniteLoad,</span><br><span class="line">        success,</span><br><span class="line">        noMore);</span><br><span class="line">    <span class="keyword">return</span> SafeArea(</span><br><span class="line">      child: Container(</span><br><span class="line">        height: <span class="number">32</span>,</span><br><span class="line">        child: Center(</span><br><span class="line">          child: Text(</span><br><span class="line">            noMore ? <span class="string">'no_more_data'</span> : <span class="string">'loading'</span>,</span><br><span class="line">            textAlign: TextAlign.center,</span><br><span class="line">            style: TextStyle(fontSize: <span class="number">12</span>, color: ColorConfig.emphasis40),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加载视图"><a href="#加载视图" class="headerlink" title="加载视图"></a>加载视图</h2><h3 id="封装LoadingView"><a href="#封装LoadingView" class="headerlink" title="封装LoadingView"></a>封装LoadingView</h3>引入Lottie到pubspec.yaml，传入文本并展示加载图标<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadingView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> tips;</span><br><span class="line">  <span class="keyword">final</span> Size size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> LoadingView(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">this</span>.tips = <span class="string">''</span>,</span><br><span class="line">    <span class="keyword">this</span>.size = <span class="keyword">const</span> Size.square(<span class="number">32</span>),</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;LoadingView&gt; createState() =&gt; _LoadingViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LoadingViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">LoadingView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> UnconstrainedBox(</span><br><span class="line">      child: Column(</span><br><span class="line">        children: [</span><br><span class="line">          Container(</span><br><span class="line">            alignment: Alignment.center,</span><br><span class="line">            width: widget.size.width,</span><br><span class="line">            height: widget.size.height,</span><br><span class="line">            child: Lottie.asset(</span><br><span class="line">              <span class="string">'resource/lottie/loading.json'</span>,</span><br><span class="line">              animate: <span class="keyword">true</span>,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          widget.tips.isEmpty</span><br><span class="line">              ? SizedBox()</span><br><span class="line">              : Text(</span><br><span class="line">                  widget.tips,</span><br><span class="line">                  textAlign: TextAlign.center,</span><br><span class="line">                  style: TextStyle(</span><br><span class="line">                    fontSize: <span class="number">12</span>,</span><br><span class="line">                    fontFamily: <span class="string">'URWDIN'</span>,</span><br><span class="line">                    fontWeight: FontWeight.w400,</span><br><span class="line">                    color: ColorConfig.emphasis,</span><br><span class="line">                  ),</span><br><span class="line">                ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
通用的加载视图，中间展示LoadingView<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageLoading</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> PageLoading(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">const</span> Center(child: LoadingView(size: Size.square(<span class="number">50</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="网络错误视图"><a href="#网络错误视图" class="headerlink" title="网络错误视图"></a>网络错误视图</h2>通用的网络错误，中间展示图标和文字暴露重试接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageNetworkError</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> OnRetry? onRetry;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> PageNetworkError(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">this</span>.onRetry,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GestureDetector(</span><br><span class="line">      child: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        margin: EdgeInsetsDirectional.only(top: <span class="number">50</span>),</span><br><span class="line">        child: Column(</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Image.asset(</span><br><span class="line">              <span class="string">'resource/images/candy_net_error.png'</span>,</span><br><span class="line">              width: <span class="number">250</span>,</span><br><span class="line">              height: <span class="number">100</span>,</span><br><span class="line">            ),</span><br><span class="line">            Text(</span><br><span class="line">              <span class="string">'network_error'</span>,</span><br><span class="line">              style: TextStyle(fontSize: <span class="number">14</span>, color: ColorConfig.emphasis60),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      onTap: () =&gt; onRetry,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> OnRetry = <span class="keyword">void</span> <span class="built_in">Function</span>();</span><br></pre></td></tr></table></figure>
<h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><h2 id="普通页面-登录页面"><a href="#普通页面-登录页面" class="headerlink" title="普通页面-登录页面"></a>普通页面-登录页面</h2>这里用wanandroid的api来举例<h3 id="登录页面LoginApi"><a href="#登录页面LoginApi" class="headerlink" title="登录页面LoginApi"></a>登录页面LoginApi</h3>返回登录和注册的url<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginApi</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> LoginApi? _instance;</span><br><span class="line"></span><br><span class="line">  LoginApi._internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> LoginApi.getInstance() &#123;</span><br><span class="line">    _instance ??= LoginApi._internal();</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getLoginUrl() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"/user/login"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getRegisterUrl() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"/user/register"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口返回的bean类"><a href="#接口返回的bean类" class="headerlink" title="接口返回的bean类"></a>接口返回的bean类</h3>所有字段均可空，实现fromJson方法接收map实例返回实例和toJson方法返回序列化后的map对象，可以用插件JsonToDart也可以用在线转换[0][传送门]再拷贝过来<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginBean</span> </span>&#123;</span><br><span class="line">  LoginBean(&#123;</span><br><span class="line">    <span class="keyword">this</span>.admin,</span><br><span class="line">    <span class="keyword">this</span>.chapterTops,</span><br><span class="line">    <span class="keyword">this</span>.coinCount,</span><br><span class="line">    <span class="keyword">this</span>.collectIds,</span><br><span class="line">    <span class="keyword">this</span>.email,</span><br><span class="line">    <span class="keyword">this</span>.icon,</span><br><span class="line">    <span class="keyword">this</span>.id,</span><br><span class="line">    <span class="keyword">this</span>.nickname,</span><br><span class="line">    <span class="keyword">this</span>.password,</span><br><span class="line">    <span class="keyword">this</span>.publicName,</span><br><span class="line">    <span class="keyword">this</span>.token,</span><br><span class="line">    <span class="keyword">this</span>.type,</span><br><span class="line">    <span class="keyword">this</span>.username,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> LoginBean.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> LoginBean(</span><br><span class="line">        admin: json[<span class="string">'admin'</span>],</span><br><span class="line">        chapterTops:</span><br><span class="line">            (json[<span class="string">'chapterTops'</span>] <span class="keyword">as</span> <span class="built_in">List</span>?)?.map((e) =&gt; e <span class="keyword">as</span> <span class="built_in">String</span>).toList(),</span><br><span class="line">        coinCount: json[<span class="string">'coinCount'</span>],</span><br><span class="line">        collectIds: (json[<span class="string">'collectIds'</span>] <span class="keyword">as</span> <span class="built_in">List</span>?)?.map((e) =&gt; e <span class="keyword">as</span> <span class="built_in">int</span>).toList(),</span><br><span class="line">        email: json[<span class="string">'email'</span>],</span><br><span class="line">        icon: json[<span class="string">'icon'</span>],</span><br><span class="line">        id: json[<span class="string">'id'</span>],</span><br><span class="line">        nickname: json[<span class="string">'nickname'</span>],</span><br><span class="line">        password: json[<span class="string">'password'</span>],</span><br><span class="line">        publicName: json[<span class="string">'publicName'</span>],</span><br><span class="line">        token: json[<span class="string">'token'</span>],</span><br><span class="line">        type: json[<span class="string">'type'</span>],</span><br><span class="line">        username: json[<span class="string">'username'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span>? admin;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="keyword">dynamic</span>&gt;? chapterTops;</span><br><span class="line">  <span class="built_in">int</span>? coinCount;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="keyword">dynamic</span>&gt;? collectIds;</span><br><span class="line">  <span class="built_in">String</span>? email;</span><br><span class="line">  <span class="built_in">String</span>? icon;</span><br><span class="line">  <span class="built_in">int</span>? id;</span><br><span class="line">  <span class="built_in">String</span>? nickname;</span><br><span class="line">  <span class="built_in">String</span>? password;</span><br><span class="line">  <span class="built_in">String</span>? publicName;</span><br><span class="line">  <span class="built_in">String</span>? token;</span><br><span class="line">  <span class="built_in">int</span>? type;</span><br><span class="line">  <span class="built_in">String</span>? username;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() &#123;</span><br><span class="line">    <span class="keyword">final</span> map = &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;&#125;;</span><br><span class="line">    map[<span class="string">'admin'</span>] = admin;</span><br><span class="line">    <span class="keyword">if</span> (chapterTops != <span class="keyword">null</span>) &#123;</span><br><span class="line">      map[<span class="string">'chapterTops'</span>] = chapterTops?.map((v) =&gt; v.toJson()).toList();</span><br><span class="line">    &#125;</span><br><span class="line">    map[<span class="string">'coinCount'</span>] = coinCount;</span><br><span class="line">    map[<span class="string">'collectIds'</span>] = collectIds?.map((v) =&gt; v.toJson()).toList();</span><br><span class="line">    map[<span class="string">'email'</span>] = email;</span><br><span class="line">    map[<span class="string">'icon'</span>] = icon;</span><br><span class="line">    map[<span class="string">'id'</span>] = id;</span><br><span class="line">    map[<span class="string">'nickname'</span>] = nickname;</span><br><span class="line">    map[<span class="string">'password'</span>] = password;</span><br><span class="line">    map[<span class="string">'publicName'</span>] = publicName;</span><br><span class="line">    map[<span class="string">'token'</span>] = token;</span><br><span class="line">    map[<span class="string">'type'</span>] = type;</span><br><span class="line">    map[<span class="string">'username'</span>] = username;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义BasePageViewModel实现类LoginLogic"><a href="#定义BasePageViewModel实现类LoginLogic" class="headerlink" title="定义BasePageViewModel实现类LoginLogic"></a>定义BasePageViewModel实现类LoginLogic</h3>调用LoginRepository的login方法发起登录请求，onReady方法中可执行loadData执行请求任务列表<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginLogic</span> <span class="keyword">extends</span> <span class="title">BasePageViewModel</span>&lt;<span class="title">LoginUIState</span>, <span class="title">LoginRepository</span>&gt; </span>&#123;</span><br><span class="line">  LoginLogic(&#123;required <span class="keyword">super</span>.uiState, required <span class="keyword">super</span>.repository&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> pageId() =&gt; LoginTrack.pageIdLogin;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onReady() &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement onReady</span></span><br><span class="line">    <span class="keyword">super</span>.onReady();</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> loadData() <span class="keyword">async</span> &#123;</span><br><span class="line">    activeStatus(isLoading: <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">await</span> Future.wait&lt;<span class="keyword">dynamic</span>&gt;([]);</span><br><span class="line">    activeStatus(isLoading: <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> login(<span class="built_in">String</span> username, <span class="built_in">String</span> password) <span class="keyword">async</span> &#123;</span><br><span class="line">    LoginBean? loginBean = <span class="keyword">await</span> repository?.login(username, password);</span><br><span class="line">    showToast(loginBean != <span class="keyword">null</span> ? <span class="string">'登录成功'</span> : <span class="string">'登录失败'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义BaseBinding实现类LoginBinding"><a href="#定义BaseBinding实现类LoginBinding" class="headerlink" title="定义BaseBinding实现类LoginBinding"></a>定义BaseBinding实现类LoginBinding</h3>初始化LoginRemoteDataSource实例，重写provideRepository方法注入LoginRepositoryImpl的实例和LoginUIState的实例<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginLogicBinding</span> <span class="keyword">extends</span> <span class="title">BaseBinding</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dependencies() &#123;</span><br><span class="line">    Get.lazyPut&lt;LoginLogic&gt;(() =&gt;</span><br><span class="line">        LoginLogic(repository: provideRepository(), uiState: LoginUIState()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  LoginRepository provideRepository() =&gt; LoginRepositoryImpl.getInstance(LoginRemoteDataSource.getInstance());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义UIState实现类LoginUIState"><a href="#定义UIState实现类LoginUIState" class="headerlink" title="定义UIState实现类LoginUIState"></a>定义UIState实现类LoginUIState</h3>定义UI相关的变量，是否展示输入密码交互，当前是否可以登录<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginUIState</span> <span class="keyword">extends</span> <span class="title">BasePageUIState</span> </span>&#123;</span><br><span class="line">  RxBool protect = <span class="keyword">false</span>.obs;</span><br><span class="line">  RxBool loginEnable = <span class="keyword">false</span>.obs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义RemoteDataSource实现类LoginRemoteDataSource"><a href="#定义RemoteDataSource实现类LoginRemoteDataSource" class="headerlink" title="定义RemoteDataSource实现类LoginRemoteDataSource"></a>定义RemoteDataSource实现类LoginRemoteDataSource</h3>继承BaseRemoteDataSource，实现调用服务端login接口的方法并实现单例，利用封装的DioManager发起post请求<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginRemoteDataSource</span> <span class="keyword">extends</span> <span class="title">BaseRemoteDataSource</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> LoginRemoteDataSource? _instance;</span><br><span class="line"></span><br><span class="line">  LoginRemoteDataSource._internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> LoginRemoteDataSource.getInstance() &#123;</span><br><span class="line">    _instance ??= LoginRemoteDataSource._internal();</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;LoginBean?&gt; login(<span class="built_in">String</span> username, <span class="built_in">String</span> password) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> requestParams = &#123;</span><br><span class="line">      <span class="string">'username'</span>: username,</span><br><span class="line">      <span class="string">'password'</span>: password</span><br><span class="line">    &#125;;</span><br><span class="line">    BaseResult result = <span class="keyword">await</span> dioManager.postRequest(</span><br><span class="line">        LoginApi.getInstance().getLoginUrl(),</span><br><span class="line">        params: requestParams,</span><br><span class="line">        isForm: <span class="keyword">true</span>);</span><br><span class="line">    logPrint(LoginApi.getInstance().getLoginUrl(), result);</span><br><span class="line">    <span class="keyword">return</span> result.data == <span class="keyword">null</span> ? <span class="keyword">null</span> : LoginBean.fromJson(result.data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义BaseRepository子类LoginRepository"><a href="#定义BaseRepository子类LoginRepository" class="headerlink" title="定义BaseRepository子类LoginRepository"></a>定义BaseRepository子类LoginRepository</h3>定义登录接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginRepository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span> </span>&#123;</span><br><span class="line">  Future&lt;LoginBean?&gt; login(<span class="built_in">String</span> username, <span class="built_in">String</span> password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义RepositoryImpl子类LoginRepositoryImpl"><a href="#定义RepositoryImpl子类LoginRepositoryImpl" class="headerlink" title="定义RepositoryImpl子类LoginRepositoryImpl"></a>定义RepositoryImpl子类LoginRepositoryImpl</h3>实现LoginRepository接口的登录方法调用服务端数据处理对象请求接口，传入LoginRemoteDataSource服务端数据处理对象类型<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginRepositoryImpl</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BaseRepositoryImp</span>&lt;<span class="title">BaseLocalDataSource</span>, <span class="title">LoginRemoteDataSource</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">LoginRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> LoginRepositoryImpl? _instance;</span><br><span class="line"></span><br><span class="line">  LoginRepositoryImpl._internal(&#123;required <span class="keyword">super</span>.remoteDataSource&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> LoginRepositoryImpl.getInstance(</span><br><span class="line">      LoginRemoteDataSource loginRemoteDataSource) &#123;</span><br><span class="line">    _instance ??=</span><br><span class="line">        LoginRepositoryImpl._internal(remoteDataSource: loginRemoteDataSource);</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;LoginBean?&gt; login(<span class="built_in">String</span> username, <span class="built_in">String</span> password) =&gt; remoteDataSource.login(username, password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="定义BasePage的子类LoginPage"><a href="#定义BasePage的子类LoginPage" class="headerlink" title="定义BasePage的子类LoginPage"></a>定义BasePage的子类LoginPage</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPage</span> <span class="keyword">extends</span> <span class="title">BasePage</span>&lt;<span class="title">LoginLogic</span>&gt; </span>&#123;</span><br><span class="line">  LoginLogic? loginLogic;</span><br><span class="line">  <span class="built_in">String</span>? username;</span><br><span class="line">  <span class="built_in">String</span>? password;</span><br><span class="line"></span><br><span class="line">  LoginPage(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key) &#123;</span><br><span class="line">    loginLogic = GetInstance().find&lt;LoginLogic&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> titleString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"登录"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  PreferredSizeWidget? appbar(BuildContext buildContext) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement appbar</span></span><br><span class="line">    <span class="keyword">return</span> AppBar(</span><br><span class="line">      brightness: Global.isDark! ? Brightness.dark : Brightness.light,</span><br><span class="line">      backgroundColor: appBarBackgroundColor,</span><br><span class="line">      elevation: <span class="number">0</span>,</span><br><span class="line">      centerTitle: <span class="keyword">true</span>,</span><br><span class="line">      titleSpacing: <span class="number">0</span>,</span><br><span class="line">      leading: leading(buildContext),</span><br><span class="line">      title: title(),</span><br><span class="line">      actions: actions(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt;? actions() &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      GestureDetector(</span><br><span class="line">        child: Container(</span><br><span class="line">          height: <span class="number">44</span>,</span><br><span class="line">          margin: EdgeInsetsDirectional.only(start: <span class="number">12</span>, end: <span class="number">12</span>),</span><br><span class="line">          padding: EdgeInsetsDirectional.only(bottom: <span class="number">5</span>),</span><br><span class="line">          alignment: AlignmentDirectional.center,</span><br><span class="line">          child: Image.asset(<span class="string">'resource/images/newcomer_home_rule.png'</span>,</span><br><span class="line">              width: <span class="number">24</span>, height: <span class="number">24</span>, color: ColorConfig.emphasis),</span><br><span class="line">        ),</span><br><span class="line">        onTap: () &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'explainIcon'</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget content(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      child: ListView(</span><br><span class="line">        children: [</span><br><span class="line">          Obx(() =&gt; LoginEffect(protect: viewModel.uiState.protect.value)),</span><br><span class="line">          LoginInput(<span class="string">'用户名'</span>, <span class="string">'请输入用户名'</span>, onChanged: (text) &#123;</span><br><span class="line">            username = text;</span><br><span class="line">            checkInput();</span><br><span class="line">          &#125;),</span><br><span class="line">          LoginInput(</span><br><span class="line">            <span class="string">'密码'</span>,</span><br><span class="line">            <span class="string">'请输入密码'</span>,</span><br><span class="line">            obscureText: <span class="keyword">true</span>,</span><br><span class="line">            onChanged: (text) &#123;</span><br><span class="line">              password = text;</span><br><span class="line">              checkInput();</span><br><span class="line">            &#125;,</span><br><span class="line">            focusChanged: (focus) &#123;</span><br><span class="line">              viewModel.uiState.protect.value = focus;</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">          Obx(() =&gt; Padding(</span><br><span class="line">                padding: EdgeInsets.only(left: <span class="number">20</span>, right: <span class="number">20</span>, top: <span class="number">10</span>),</span><br><span class="line">                child: LoginButton(</span><br><span class="line">                  <span class="string">'登录'</span>,</span><br><span class="line">                  enable: viewModel.uiState.loginEnable.value,</span><br><span class="line">                  onPressed: send,</span><br><span class="line">                ),</span><br><span class="line">              ))</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> checkInput() &#123;</span><br><span class="line">    <span class="built_in">bool</span> enable;</span><br><span class="line">    <span class="keyword">if</span> (username?.isNotEmpty == <span class="keyword">true</span> &amp;&amp; password?.isNotEmpty == <span class="keyword">true</span>) &#123;</span><br><span class="line">      enable = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      enable = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    viewModel.uiState.loginEnable.value = enable;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> send() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (username != <span class="keyword">null</span> &amp;&amp; password != <span class="keyword">null</span>) &#123;</span><br><span class="line">      loginLogic?.login(username!, password!);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装登录按钮"><a href="#封装登录按钮" class="headerlink" title="封装登录按钮"></a>封装登录按钮</h3>封装编辑框下面的圆角登录按钮<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginButton</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> enable;</span><br><span class="line">  <span class="keyword">final</span> VoidCallback? onPressed;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> LoginButton(<span class="keyword">this</span>.title, &#123;Key? key, <span class="keyword">this</span>.enable = <span class="keyword">true</span>, <span class="keyword">this</span>.onPressed&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> FractionallySizedBox(</span><br><span class="line">      widthFactor: <span class="number">1</span>,</span><br><span class="line">      child: MaterialButton(</span><br><span class="line">        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(<span class="number">6</span>)),</span><br><span class="line">        height: <span class="number">45</span>,</span><br><span class="line">        onPressed: enable ? onPressed : <span class="keyword">null</span>,</span><br><span class="line">        disabledColor: ColorConfig.primary60,</span><br><span class="line">        color: ColorConfig.primary,</span><br><span class="line">        child: Text(title, style: TextStyle(color: Colors.white, fontSize: <span class="number">16</span>)),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装登录页面顶部交互头"><a href="#封装登录页面顶部交互头" class="headerlink" title="封装登录页面顶部交互头"></a>封装登录页面顶部交互头</h3>传入密码输入时是否展示遮挡交互的标记<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginEffect</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> protect;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> LoginEffect(&#123;Key? key, required <span class="keyword">this</span>.protect&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;LoginEffect&gt; createState() =&gt; _LoginEffectState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LoginEffectState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">LoginEffect</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      padding: EdgeInsets.only(top: <span class="number">10</span>),</span><br><span class="line">      decoration: BoxDecoration(</span><br><span class="line">        color: Colors.grey[<span class="number">100</span>],</span><br><span class="line">        border: Border(bottom: BorderSide(color: Colors.grey[<span class="number">300</span>]!)),</span><br><span class="line">      ),</span><br><span class="line">      child: Row(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">        children: [</span><br><span class="line">          image(<span class="keyword">true</span>),</span><br><span class="line">          Image(</span><br><span class="line">            height: <span class="number">90</span>,</span><br><span class="line">            width: <span class="number">90</span>,</span><br><span class="line">            image: AssetImage(<span class="string">'resource/images/logo.png'</span>),</span><br><span class="line">          ),</span><br><span class="line">          image(<span class="keyword">false</span>)</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">   * </span>密码保护的交互图片</span></span></span><br><span class="line"><span class="comment"><span class="markdown">   */</span></span></span><br><span class="line">  image(<span class="built_in">bool</span> left) &#123;</span><br><span class="line">    <span class="keyword">var</span> leftImg = widget.protect</span><br><span class="line">        ? <span class="string">'resource/images/head_left_protect.png'</span></span><br><span class="line">        : <span class="string">'resource/images/head_left.png'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> rightImg = widget.protect</span><br><span class="line">        ? <span class="string">'resource/images/head_right_protect.png'</span></span><br><span class="line">        : <span class="string">'resource/images/head_right.png'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Image(height: <span class="number">90</span>, image: AssetImage(left ? leftImg : rightImg));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装登录用户名密码编辑框"><a href="#封装登录用户名密码编辑框" class="headerlink" title="封装登录用户名密码编辑框"></a>封装登录用户名密码编辑框</h3>传入标题和提示文本，暴露文字/焦点改变的回调，是否有左边距，传入密码是否模糊<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginInput</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> hint;</span><br><span class="line">  <span class="keyword">final</span> ValueChanged&lt;<span class="built_in">String</span>&gt;? onChanged;</span><br><span class="line">  <span class="keyword">final</span> ValueChanged&lt;<span class="built_in">bool</span>&gt;? focusChanged;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> lineStretch;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> obscureText;</span><br><span class="line">  <span class="keyword">final</span> TextInputType? keyboardType;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> LoginInput(<span class="keyword">this</span>.title, <span class="keyword">this</span>.hint,</span><br><span class="line">      &#123;Key? key,</span><br><span class="line">      <span class="keyword">this</span>.onChanged,</span><br><span class="line">      <span class="keyword">this</span>.focusChanged,</span><br><span class="line">      <span class="keyword">this</span>.lineStretch = <span class="keyword">false</span>,</span><br><span class="line">      <span class="keyword">this</span>.obscureText = <span class="keyword">false</span>,</span><br><span class="line">      <span class="keyword">this</span>.keyboardType&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;LoginInput&gt; createState() =&gt; _LoginInputState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LoginInputState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">LoginInput</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> focusNode = FocusNode();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    focusNode.addListener(() &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">'Has focus: <span class="subst">$&#123;focusNode.hasFocus&#125;</span>'</span>);</span><br><span class="line">      <span class="keyword">if</span> (widget.focusChanged != <span class="keyword">null</span>) &#123;</span><br><span class="line">        widget.focusChanged!(focusNode.hasFocus);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    focusNode.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Column(</span><br><span class="line">      children: [</span><br><span class="line">        Row(</span><br><span class="line">          children: [</span><br><span class="line">            Container(</span><br><span class="line">              padding: EdgeInsets.only(left: <span class="number">15</span>),</span><br><span class="line">              width: <span class="number">100</span>,</span><br><span class="line">              child: Text(</span><br><span class="line">                widget.title,</span><br><span class="line">                style: TextStyle(fontSize: <span class="number">16</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            input()</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        Padding(</span><br><span class="line">            padding: EdgeInsets.only(left: !widget.lineStretch ? <span class="number">15</span> : <span class="number">0</span>),</span><br><span class="line">            child: Divider(</span><br><span class="line">              height: <span class="number">1</span>,</span><br><span class="line">              thickness: <span class="number">0.5</span>,</span><br><span class="line">            )),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  input() &#123;</span><br><span class="line">    <span class="keyword">return</span> Expanded(</span><br><span class="line">        child: TextField(</span><br><span class="line">      focusNode: focusNode,</span><br><span class="line">      onChanged: widget.onChanged,</span><br><span class="line">      obscureText: widget.obscureText,</span><br><span class="line">      keyboardType: widget.keyboardType,</span><br><span class="line">      autofocus: !widget.obscureText,</span><br><span class="line">      cursorColor: ColorConfig.primary,</span><br><span class="line">      style: TextStyle(fontSize: <span class="number">16</span>, fontWeight: FontWeight.w300),</span><br><span class="line">      decoration: InputDecoration(</span><br><span class="line">          contentPadding: EdgeInsets.only(left: <span class="number">20</span>, right: <span class="number">20</span>),</span><br><span class="line">          border: InputBorder.none,</span><br><span class="line">          hintText: widget.hint,</span><br><span class="line">          hintStyle: TextStyle(fontSize: <span class="number">15</span>, color: Colors.grey)),</span><br><span class="line">    ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加载更多列表页面-WanAndroid"><a href="#加载更多列表页面-WanAndroid" class="headerlink" title="加载更多列表页面-WanAndroid"></a>加载更多列表页面-WanAndroid</h2><h3 id="首页HomeApi"><a href="#首页HomeApi" class="headerlink" title="首页HomeApi"></a>首页HomeApi</h3>返回获取文章列表的url<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeApi</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> HomeApi? _instance;</span><br><span class="line">  HomeApi._internal();</span><br><span class="line">  <span class="keyword">factory</span> HomeApi.getInstance() &#123;</span><br><span class="line">    _instance ??= HomeApi._internal();</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getArticleList(<span class="built_in">int</span> currentPage) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'/article/list/<span class="subst">$currentPage</span>/json'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseLoadMoreListPageUIState的子类HomeUIState"><a href="#BaseLoadMoreListPageUIState的子类HomeUIState" class="headerlink" title="BaseLoadMoreListPageUIState的子类HomeUIState"></a>BaseLoadMoreListPageUIState的子类HomeUIState</h3>暂时没用到与UI显示有关的变量<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeUIState</span> <span class="keyword">extends</span> <span class="title">BaseLoadMoreListPageUIState</span>&lt;<span class="title">ArticleBean</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseBinding的实现类首页Binding"><a href="#BaseBinding的实现类首页Binding" class="headerlink" title="BaseBinding的实现类首页Binding"></a>BaseBinding的实现类首页Binding</h3>初始化HomeRemoteDataSource的实例，重写provideRepository方法，注入HomeRepositoryImpl的实例和HomeUIState的实例<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeBinding</span> <span class="keyword">extends</span> <span class="title">BaseBinding</span></span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dependencies() &#123;</span><br><span class="line">    Get.lazyPut&lt;HomeLogic&gt;(() =&gt;</span><br><span class="line">        HomeLogic(repository: provideRepository(), uiState: HomeUIState()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  HomeRepository provideRepository() =&gt; HomeRepositoryImpl.getInstance(HomeRemoteDataSource.getInstance());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseLoadMoreListViewModel的实现类HomeLogic"><a href="#BaseLoadMoreListViewModel的实现类HomeLogic" class="headerlink" title="BaseLoadMoreListViewModel的实现类HomeLogic"></a>BaseLoadMoreListViewModel的实现类HomeLogic</h3>重写loadData方法调用repository的获取文章列表接口添加到BaseListPageUIState的dataList中，刷新是否有下一页标记，刷新下一次请求的页数<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeLogic</span> <span class="keyword">extends</span> <span class="title">BaseLoadMoreListViewModel</span>&lt;<span class="title">HomeUIState</span>, <span class="title">HomeRepository</span>&gt; </span>&#123;</span><br><span class="line">  HomeLogic(&#123;required <span class="keyword">super</span>.repository, required <span class="keyword">super</span>.uiState&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; loadData(<span class="built_in">bool</span> isRefresh) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> repository?.getArticleList(currentPage);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isRefresh) &#123;</span><br><span class="line">      uiState.dataList.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    currentPage = result.curPage ?? <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (result.articles != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> list = result.articles?.map((e) =&gt; e <span class="keyword">as</span> ArticleBean).toList();</span><br><span class="line">      uiState.dataList.addAll(list ?? []);</span><br><span class="line">    &#125;</span><br><span class="line">    hasNext = result.curPage != result.pageCount;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseRemoteDataSource的实现类HomeRemoteDataSource"><a href="#BaseRemoteDataSource的实现类HomeRemoteDataSource" class="headerlink" title="BaseRemoteDataSource的实现类HomeRemoteDataSource"></a>BaseRemoteDataSource的实现类HomeRemoteDataSource</h3>调用dioManager对象发起get请求获取文章列表<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeRemoteDataSource</span> <span class="keyword">extends</span> <span class="title">BaseRemoteDataSource</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> HomeRemoteDataSource? _instance;</span><br><span class="line">  HomeRemoteDataSource._internal();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> HomeRemoteDataSource.getInstance()&#123;</span><br><span class="line">    _instance ??= HomeRemoteDataSource._internal();</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;ArticleList?&gt; getArticleList(<span class="built_in">int</span> currentPage) <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="built_in">String</span> requestUrl = HomeApi.getInstance().getArticleList(currentPage);</span><br><span class="line">    BaseResult result = <span class="keyword">await</span> dioManager.getRequest(requestUrl);</span><br><span class="line">    logPrint(requestUrl, result);</span><br><span class="line">    <span class="keyword">return</span> result.data == <span class="keyword">null</span> ? <span class="keyword">null</span> : ArticleList.fromJson(result.data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logPrint(<span class="built_in">String</span> api, BaseResult result)&#123;</span><br><span class="line">    <span class="keyword">if</span> (Global.isDebug) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Login &gt;&gt; <span class="subst">$api</span> \n <span class="subst">$&#123;jsonEncode(result)&#125;</span>"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseRepository的子类HomeRepository"><a href="#BaseRepository的子类HomeRepository" class="headerlink" title="BaseRepository的子类HomeRepository"></a>BaseRepository的子类HomeRepository</h3>定义获取文章列表接口<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeRepository</span> <span class="keyword">extends</span> <span class="title">BaseRepository</span></span>&#123;</span><br><span class="line">   Future&lt;ArticleList?&gt; getArticleList(<span class="built_in">int</span> currentPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseRepositoryImp的子类HomeRepositoryImpl实现HomeRepository接口"><a href="#BaseRepositoryImp的子类HomeRepositoryImpl实现HomeRepository接口" class="headerlink" title="BaseRepositoryImp的子类HomeRepositoryImpl实现HomeRepository接口"></a>BaseRepositoryImp的子类HomeRepositoryImpl实现HomeRepository接口</h3>重写getArticleList方法调用服务端数据处理对象请求文章列表接口，传入HomeRemoteDataSource服务端数据处理对象类型<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeRepositoryImpl</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">BaseRepositoryImp</span>&lt;<span class="title">BaseLocalDataSource</span>, <span class="title">HomeRemoteDataSource</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">HomeRepository</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> HomeRepositoryImpl? _instance;</span><br><span class="line"></span><br><span class="line">  HomeRepositoryImpl._internal(&#123;required <span class="keyword">super</span>.remoteDataSource&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> HomeRepositoryImpl.getInstance(</span><br><span class="line">      HomeRemoteDataSource homeRemoteDataSource) &#123;</span><br><span class="line">    _instance ??=</span><br><span class="line">        HomeRepositoryImpl._internal(remoteDataSource: homeRemoteDataSource);</span><br><span class="line">    <span class="keyword">return</span> _instance!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;ArticleList?&gt; getArticleList(<span class="built_in">int</span> currentPage) =&gt;</span><br><span class="line">      remoteDataSource.getArticleList(currentPage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装文章列表的Bean对象"><a href="#封装文章列表的Bean对象" class="headerlink" title="封装文章列表的Bean对象"></a>封装文章列表的Bean对象</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleList</span> </span>&#123;</span><br><span class="line">  ArticleList(&#123;</span><br><span class="line">    <span class="keyword">this</span>.curPage,</span><br><span class="line">    <span class="keyword">this</span>.articles,</span><br><span class="line">    <span class="keyword">this</span>.offset,</span><br><span class="line">    <span class="keyword">this</span>.over,</span><br><span class="line">    <span class="keyword">this</span>.pageCount,</span><br><span class="line">    <span class="keyword">this</span>.size,</span><br><span class="line">    <span class="keyword">this</span>.total,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> ArticleList.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> ArticleList(</span><br><span class="line">        curPage: json[<span class="string">'curPage'</span>],</span><br><span class="line">        articles: (json[<span class="string">'datas'</span>] <span class="keyword">as</span> <span class="built_in">List</span>?)?</span><br><span class="line">            .map((e) =&gt; ArticleBean.fromJson(e))</span><br><span class="line">            .toList(),</span><br><span class="line">        offset: json[<span class="string">'offset'</span>],</span><br><span class="line">        over: json[<span class="string">'over'</span>],</span><br><span class="line">        pageCount: json[<span class="string">'pageCount'</span>],</span><br><span class="line">        size: json[<span class="string">'size'</span>],</span><br><span class="line">        total: json[<span class="string">'total'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span>? curPage;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="keyword">dynamic</span>&gt;? articles;</span><br><span class="line">  <span class="built_in">int</span>? offset;</span><br><span class="line">  <span class="built_in">bool</span>? over;</span><br><span class="line">  <span class="built_in">int</span>? pageCount;</span><br><span class="line">  <span class="built_in">int</span>? size;</span><br><span class="line">  <span class="built_in">int</span>? total;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() &#123;</span><br><span class="line">    <span class="keyword">final</span> map = &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;&#125;;</span><br><span class="line">    map[<span class="string">'curPage'</span>] = curPage;</span><br><span class="line">    <span class="keyword">if</span> (articles != <span class="keyword">null</span>) &#123;</span><br><span class="line">      map[<span class="string">'datas'</span>] = articles?.map((v) =&gt; v.toJson()).toList();</span><br><span class="line">    &#125;</span><br><span class="line">    map[<span class="string">'offset'</span>] = offset;</span><br><span class="line">    map[<span class="string">'over'</span>] = over;</span><br><span class="line">    map[<span class="string">'pageCount'</span>] = pageCount;</span><br><span class="line">    map[<span class="string">'size'</span>] = size;</span><br><span class="line">    map[<span class="string">'total'</span>] = total;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleBean</span> </span>&#123;</span><br><span class="line">  ArticleBean(&#123;</span><br><span class="line">    <span class="keyword">this</span>.adminAdd,</span><br><span class="line">    <span class="keyword">this</span>.apkLink,</span><br><span class="line">    <span class="keyword">this</span>.audit,</span><br><span class="line">    <span class="keyword">this</span>.author,</span><br><span class="line">    <span class="keyword">this</span>.canEdit,</span><br><span class="line">    <span class="keyword">this</span>.chapterId,</span><br><span class="line">    <span class="keyword">this</span>.chapterName,</span><br><span class="line">    <span class="keyword">this</span>.collect,</span><br><span class="line">    <span class="keyword">this</span>.courseId,</span><br><span class="line">    <span class="keyword">this</span>.desc,</span><br><span class="line">    <span class="keyword">this</span>.descMd,</span><br><span class="line">    <span class="keyword">this</span>.envelopePic,</span><br><span class="line">    <span class="keyword">this</span>.fresh,</span><br><span class="line">    <span class="keyword">this</span>.host,</span><br><span class="line">    <span class="keyword">this</span>.id,</span><br><span class="line">    <span class="keyword">this</span>.isAdminAdd,</span><br><span class="line">    <span class="keyword">this</span>.link,</span><br><span class="line">    <span class="keyword">this</span>.niceDate,</span><br><span class="line">    <span class="keyword">this</span>.niceShareDate,</span><br><span class="line">    <span class="keyword">this</span>.origin,</span><br><span class="line">    <span class="keyword">this</span>.prefix,</span><br><span class="line">    <span class="keyword">this</span>.projectLink,</span><br><span class="line">    <span class="keyword">this</span>.publishTime,</span><br><span class="line">    <span class="keyword">this</span>.realSuperChapterId,</span><br><span class="line">    <span class="keyword">this</span>.selfVisible,</span><br><span class="line">    <span class="keyword">this</span>.shareDate,</span><br><span class="line">    <span class="keyword">this</span>.shareUser,</span><br><span class="line">    <span class="keyword">this</span>.superChapterId,</span><br><span class="line">    <span class="keyword">this</span>.superChapterName,</span><br><span class="line">    <span class="keyword">this</span>.tags,</span><br><span class="line">    <span class="keyword">this</span>.title,</span><br><span class="line">    <span class="keyword">this</span>.type,</span><br><span class="line">    <span class="keyword">this</span>.userId,</span><br><span class="line">    <span class="keyword">this</span>.visible,</span><br><span class="line">    <span class="keyword">this</span>.zan,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> ArticleBean.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> ArticleBean(</span><br><span class="line">        adminAdd: json[<span class="string">'adminAdd'</span>],</span><br><span class="line">        apkLink: json[<span class="string">'apkLink'</span>],</span><br><span class="line">        audit: json[<span class="string">'audit'</span>],</span><br><span class="line">        author: json[<span class="string">'author'</span>],</span><br><span class="line">        canEdit: json[<span class="string">'canEdit'</span>],</span><br><span class="line">        chapterId: json[<span class="string">'chapterId'</span>],</span><br><span class="line">        chapterName: json[<span class="string">'chapterName'</span>],</span><br><span class="line">        collect: json[<span class="string">'collect'</span>],</span><br><span class="line">        courseId: json[<span class="string">'courseId'</span>],</span><br><span class="line">        desc: json[<span class="string">'desc'</span>],</span><br><span class="line">        descMd: json[<span class="string">'descMd'</span>],</span><br><span class="line">        envelopePic: json[<span class="string">'envelopePic'</span>],</span><br><span class="line">        fresh: json[<span class="string">'fresh'</span>],</span><br><span class="line">        host: json[<span class="string">'host'</span>],</span><br><span class="line">        id: json[<span class="string">'id'</span>],</span><br><span class="line">        isAdminAdd: json[<span class="string">'isAdminAdd'</span>],</span><br><span class="line">        link: json[<span class="string">'link'</span>],</span><br><span class="line">        niceDate: json[<span class="string">'niceDate'</span>],</span><br><span class="line">        niceShareDate: json[<span class="string">'niceShareDate'</span>],</span><br><span class="line">        origin: json[<span class="string">'origin'</span>],</span><br><span class="line">        prefix: json[<span class="string">'prefix'</span>],</span><br><span class="line">        projectLink: json[<span class="string">'projectLink'</span>],</span><br><span class="line">        publishTime: json[<span class="string">'publishTime'</span>],</span><br><span class="line">        realSuperChapterId: json[<span class="string">'realSuperChapterId'</span>],</span><br><span class="line">        selfVisible: json[<span class="string">'selfVisible'</span>],</span><br><span class="line">        shareDate: json[<span class="string">'shareDate'</span>],</span><br><span class="line">        shareUser: json[<span class="string">'shareUser'</span>],</span><br><span class="line">        superChapterId: json[<span class="string">'superChapterId'</span>],</span><br><span class="line">        superChapterName: json[<span class="string">'superChapterName'</span>],</span><br><span class="line">        tags: (json[<span class="string">'tags'</span>] <span class="keyword">as</span> <span class="built_in">List</span>?)?.map((e) =&gt; Tag.fromJson(e)).toList(),</span><br><span class="line">        title: json[<span class="string">'title'</span>],</span><br><span class="line">        type: json[<span class="string">'type'</span>],</span><br><span class="line">        userId: json[<span class="string">'userId'</span>],</span><br><span class="line">        visible: json[<span class="string">'visible'</span>],</span><br><span class="line">        zan: json[<span class="string">'zan'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span>? adminAdd;</span><br><span class="line">  <span class="built_in">String</span>? apkLink;</span><br><span class="line">  <span class="built_in">int</span>? audit;</span><br><span class="line">  <span class="built_in">String</span>? author;</span><br><span class="line">  <span class="built_in">bool</span>? canEdit;</span><br><span class="line">  <span class="built_in">int</span>? chapterId;</span><br><span class="line">  <span class="built_in">String</span>? chapterName;</span><br><span class="line">  <span class="built_in">bool</span>? collect;</span><br><span class="line">  <span class="built_in">int</span>? courseId;</span><br><span class="line">  <span class="built_in">String</span>? desc;</span><br><span class="line">  <span class="built_in">String</span>? descMd;</span><br><span class="line">  <span class="built_in">String</span>? envelopePic;</span><br><span class="line">  <span class="built_in">bool</span>? fresh;</span><br><span class="line">  <span class="built_in">String</span>? host;</span><br><span class="line">  <span class="built_in">int</span>? id;</span><br><span class="line">  <span class="built_in">bool</span>? isAdminAdd;</span><br><span class="line">  <span class="built_in">String</span>? link;</span><br><span class="line">  <span class="built_in">String</span>? niceDate;</span><br><span class="line">  <span class="built_in">String</span>? niceShareDate;</span><br><span class="line">  <span class="built_in">String</span>? origin;</span><br><span class="line">  <span class="built_in">String</span>? prefix;</span><br><span class="line">  <span class="built_in">String</span>? projectLink;</span><br><span class="line">  <span class="built_in">int</span>? publishTime;</span><br><span class="line">  <span class="built_in">int</span>? realSuperChapterId;</span><br><span class="line">  <span class="built_in">int</span>? selfVisible;</span><br><span class="line">  <span class="keyword">dynamic</span> shareDate;</span><br><span class="line">  <span class="built_in">String</span>? shareUser;</span><br><span class="line">  <span class="built_in">int</span>? superChapterId;</span><br><span class="line">  <span class="built_in">String</span>? superChapterName;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="keyword">dynamic</span>&gt;? tags;</span><br><span class="line">  <span class="built_in">String</span>? title;</span><br><span class="line">  <span class="built_in">int</span>? type;</span><br><span class="line">  <span class="built_in">int</span>? userId;</span><br><span class="line">  <span class="built_in">int</span>? visible;</span><br><span class="line">  <span class="built_in">int</span>? zan;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() &#123;</span><br><span class="line">    <span class="keyword">final</span> map = &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;&#125;;</span><br><span class="line">    map[<span class="string">'adminAdd'</span>] = adminAdd;</span><br><span class="line">    map[<span class="string">'apkLink'</span>] = apkLink;</span><br><span class="line">    map[<span class="string">'audit'</span>] = audit;</span><br><span class="line">    map[<span class="string">'author'</span>] = author;</span><br><span class="line">    map[<span class="string">'canEdit'</span>] = canEdit;</span><br><span class="line">    map[<span class="string">'chapterId'</span>] = chapterId;</span><br><span class="line">    map[<span class="string">'chapterName'</span>] = chapterName;</span><br><span class="line">    map[<span class="string">'collect'</span>] = collect;</span><br><span class="line">    map[<span class="string">'courseId'</span>] = courseId;</span><br><span class="line">    map[<span class="string">'desc'</span>] = desc;</span><br><span class="line">    map[<span class="string">'descMd'</span>] = descMd;</span><br><span class="line">    map[<span class="string">'envelopePic'</span>] = envelopePic;</span><br><span class="line">    map[<span class="string">'fresh'</span>] = fresh;</span><br><span class="line">    map[<span class="string">'host'</span>] = host;</span><br><span class="line">    map[<span class="string">'id'</span>] = id;</span><br><span class="line">    map[<span class="string">'isAdminAdd'</span>] = isAdminAdd;</span><br><span class="line">    map[<span class="string">'link'</span>] = link;</span><br><span class="line">    map[<span class="string">'niceDate'</span>] = niceDate;</span><br><span class="line">    map[<span class="string">'niceShareDate'</span>] = niceShareDate;</span><br><span class="line">    map[<span class="string">'origin'</span>] = origin;</span><br><span class="line">    map[<span class="string">'prefix'</span>] = prefix;</span><br><span class="line">    map[<span class="string">'projectLink'</span>] = projectLink;</span><br><span class="line">    map[<span class="string">'publishTime'</span>] = publishTime;</span><br><span class="line">    map[<span class="string">'realSuperChapterId'</span>] = realSuperChapterId;</span><br><span class="line">    map[<span class="string">'selfVisible'</span>] = selfVisible;</span><br><span class="line">    map[<span class="string">'shareDate'</span>] = shareDate;</span><br><span class="line">    map[<span class="string">'shareUser'</span>] = shareUser;</span><br><span class="line">    map[<span class="string">'superChapterId'</span>] = superChapterId;</span><br><span class="line">    map[<span class="string">'superChapterName'</span>] = superChapterName;</span><br><span class="line">    <span class="keyword">if</span> (tags != <span class="keyword">null</span>) &#123;</span><br><span class="line">      map[<span class="string">'tags'</span>] = tags?.map((v) =&gt; v.toJson()).toList();</span><br><span class="line">    &#125;</span><br><span class="line">    map[<span class="string">'title'</span>] = title;</span><br><span class="line">    map[<span class="string">'type'</span>] = type;</span><br><span class="line">    map[<span class="string">'userId'</span>] = userId;</span><br><span class="line">    map[<span class="string">'visible'</span>] = visible;</span><br><span class="line">    map[<span class="string">'zan'</span>] = zan;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span> </span>&#123;</span><br><span class="line">  Tag(&#123;</span><br><span class="line">    <span class="keyword">this</span>.name,</span><br><span class="line">    <span class="keyword">this</span>.url,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> Tag.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">    <span class="keyword">return</span> Tag(name: json[<span class="string">'name'</span>], url: json[<span class="string">'url'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span>? name;</span><br><span class="line">  <span class="built_in">String</span>? url;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() &#123;</span><br><span class="line">    <span class="keyword">final</span> map = &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;&#125;;</span><br><span class="line">    map[<span class="string">'name'</span>] = name;</span><br><span class="line">    map[<span class="string">'url'</span>] = url;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BasePage的实现类HomePage"><a href="#BasePage的实现类HomePage" class="headerlink" title="BasePage的实现类HomePage"></a>BasePage的实现类HomePage</h3>重写首页展示标题，重写item方法返回列表项视图<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">BaseLoadMoreListPage</span>&lt;<span class="title">HomeLogic</span>&gt; </span>&#123;</span><br><span class="line">  HomeLogic? homeLogic;</span><br><span class="line"></span><br><span class="line">  HomePage(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key) &#123;</span><br><span class="line">    homeLogic = GetInstance().find&lt;HomeLogic&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> titleString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'首页'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget item(BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> ArticleItemView(</span><br><span class="line">        articleBean: viewModel.uiState.dataList[index],</span><br><span class="line">        onClickCollect: (collect) &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'click collect'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="封装文章列表项"><a href="#封装文章列表项" class="headerlink" title="封装文章列表项"></a>封装文章列表项</h3>外部Widget传入ViewModel中的UIState中的dataList中的某条ArticleBean数据项，传入回调方法onClickCollect，定义collect通过GetX的Obx机制结合obs变量刷新局部视图<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleItemView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ArticleBean articleBean;</span><br><span class="line">  <span class="keyword">final</span> OnClickCollect onClickCollect;</span><br><span class="line">  RxBool collect = <span class="keyword">false</span>.obs;</span><br><span class="line"></span><br><span class="line">  ArticleItemView(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    required <span class="keyword">this</span>.articleBean,</span><br><span class="line">    required <span class="keyword">this</span>.onClickCollect,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;ArticleItemView&gt; createState() =&gt; _ArticleItemViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ArticleItemViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ArticleItemView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> itemClick(ArticleBean articleBean) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> itemCollect(ArticleBean articleBean) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">String</span> authorTitle;</span><br><span class="line">    <span class="built_in">String</span> author;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (widget.articleBean.author == <span class="keyword">null</span> ||</span><br><span class="line">        widget.articleBean.author!.isEmpty) &#123;</span><br><span class="line">      authorTitle = <span class="string">"分享人:"</span>;</span><br><span class="line">      author = widget.articleBean.shareUser ?? <span class="string">""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      authorTitle = <span class="string">"作者:"</span>;</span><br><span class="line">      author = widget.articleBean.author ?? <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Row row = Row(</span><br><span class="line">      mainAxisAlignment: MainAxisAlignment.start,</span><br><span class="line">      children: &lt;Widget&gt;[</span><br><span class="line">        Expanded(</span><br><span class="line">            child: Text(</span><br><span class="line">          <span class="string">"<span class="subst">$authorTitle</span><span class="subst">$author</span>"</span>,</span><br><span class="line">          style: TextStyle(color: ColorConfig.emphasis, fontSize: <span class="number">13</span>),</span><br><span class="line">        )),</span><br><span class="line">        Text(</span><br><span class="line">          widget.articleBean.niceDate ?? <span class="string">""</span>,</span><br><span class="line">          style: TextStyle(color: ColorConfig.emphasis, fontSize: <span class="number">13</span>),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">    Row title = Row(</span><br><span class="line">      children: &lt;Widget&gt;[</span><br><span class="line">        Expanded(</span><br><span class="line">            child: Text.rich(</span><br><span class="line">          TextSpan(text: widget.articleBean.title ?? <span class="string">""</span>),</span><br><span class="line">          softWrap: <span class="keyword">true</span>,</span><br><span class="line">          style: TextStyle(fontSize: <span class="number">16.0</span>, color: ColorConfig.emphasis),</span><br><span class="line">          textAlign: TextAlign.left,</span><br><span class="line">        )),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">    Row chapterName = Row(</span><br><span class="line">      mainAxisAlignment: MainAxisAlignment.spaceBetween,</span><br><span class="line">      children: [</span><br><span class="line">        Container(</span><br><span class="line">          padding: EdgeInsets.only(left: <span class="number">4</span>, right: <span class="number">4</span>, top: <span class="number">1</span>, bottom: <span class="number">2</span>),</span><br><span class="line">          decoration: BoxDecoration(</span><br><span class="line">              color: ColorConfig.darkOverLay,</span><br><span class="line">              borderRadius: BorderRadius.circular(<span class="number">2</span>)),</span><br><span class="line">          child: Text(</span><br><span class="line">            widget.articleBean.chapterName ?? <span class="string">""</span>,</span><br><span class="line">            softWrap: <span class="keyword">true</span>,</span><br><span class="line">            style: TextStyle(color: ColorConfig.emphasis60, fontSize: <span class="number">12</span>),</span><br><span class="line">            textAlign: TextAlign.left,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        Obx(() =&gt; GestureDetector(</span><br><span class="line">              child: Icon(</span><br><span class="line">                widget.collect.value ? Icons.favorite : Icons.favorite_border,</span><br><span class="line">                color: widget.collect.value ? Colors.red : <span class="keyword">null</span>,</span><br><span class="line">              ),</span><br><span class="line">              onTap: () &#123;</span><br><span class="line">                widget.articleBean.collect =</span><br><span class="line">                    !widget.articleBean.collect.notNull();</span><br><span class="line">                widget.collect.value = widget.articleBean.collect.notNull();</span><br><span class="line">                widget.onClickCollect</span><br><span class="line">                    .call(widget.articleBean.collect.notNull());</span><br><span class="line">              &#125;,</span><br><span class="line">            ))</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Column column = Column(</span><br><span class="line">      children: [</span><br><span class="line">        title,</span><br><span class="line">        SizedBox(</span><br><span class="line">          height: <span class="number">5</span>,</span><br><span class="line">        ),</span><br><span class="line">        row,</span><br><span class="line">        SizedBox(</span><br><span class="line">          height: <span class="number">5</span>,</span><br><span class="line">        ),</span><br><span class="line">        chapterName</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> InkWell(</span><br><span class="line">        onTap: () &#123;</span><br><span class="line">          itemClick(widget.articleBean);</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Container(</span><br><span class="line">          padding: EdgeInsets.symmetric(vertical: <span class="number">8</span>, horizontal: <span class="number">12</span>),</span><br><span class="line">          decoration: BoxDecoration(</span><br><span class="line">            color: Colors.white,</span><br><span class="line">            borderRadius: BorderRadius.circular(<span class="number">4</span>),</span><br><span class="line">          ),</span><br><span class="line">          margin: EdgeInsets.all(<span class="number">4</span>),</span><br><span class="line">          child: column,</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> OnClickCollect = <span class="keyword">void</span> <span class="built_in">Function</span>(<span class="built_in">bool</span> collect);</span><br></pre></td></tr></table></figure>

</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/07/24/PasswordView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/07/24/PasswordView/" class="post-title-link" itemprop="url">六位密码输入框</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-07-24 17:51:46 / Modified: 23:17:31" itemprop="dateCreated datePublished" datetime="2022-07-24T17:51:46+08:00">2022-07-24</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是很长一段时间没有更新blog，最近疫情又严重了，公司开启了WFH模式，闲暇之余有更多的时间来做技术总结和沉淀，最近在项目中遇到一个需求，绘制一个六位的密码输入框，需要用到自定义View的相关知识，中间还出了一点小插曲，在某些机型引发了一个bug在此做一个记录，欢迎交流和讨论～</p>
<hr>
<p>最终效果图：<br><img src="/images/TradingPassword.jpg" alt="效果图"></p>
<h1 id="自定义LinearLayout"><a href="#自定义LinearLayout" class="headerlink" title="自定义LinearLayout"></a>自定义LinearLayout</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PassWordView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="添加EditText和TextView"><a href="#添加EditText和TextView" class="headerlink" title="添加EditText和TextView"></a>添加EditText和TextView</h1><ul>
<li>在LinearLayout中添加1个EditText在底部，EditText的输入格式只能是数字或密码且输入长度为6，当前LinearLayout点击后触发EditText获取焦点并弹出软键盘</li>
<li>监听输入过程把输入的文本替换为”●”<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> defaultSize = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">private</span> EditText editText;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空当前输入的密码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearPassWord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    editText.setText(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    editText = <span class="keyword">new</span> EditText(getContext());</span><br><span class="line">    editText.setTextSize(<span class="number">12f</span>);</span><br><span class="line">    editText.setLayoutParams(<span class="keyword">new</span> FrameLayout.LayoutParams(<span class="number">1</span>, ViewGroup.LayoutParams.WRAP_CONTENT));</span><br><span class="line">    editText.setCursorVisible(<span class="keyword">false</span>);</span><br><span class="line">    editText.setBackgroundDrawable(<span class="keyword">null</span>);</span><br><span class="line">    editText.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_VARIATION_PASSWORD);</span><br><span class="line">    addView(editText);</span><br><span class="line">    editText.setFilters(<span class="keyword">new</span> InputFilter[]&#123;<span class="keyword">new</span> InputFilter.LengthFilter(defaultSize)&#125;);</span><br><span class="line">    setOnClickListener(v -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (editText.requestFocus()) &#123;</span><br><span class="line">            InputMethodManager imm = (InputMethodManager) getContext().getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">            <span class="keyword">if</span> (imm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                imm.showSoftInput(editText, InputMethodManager.SHOW_IMPLICIT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    editText.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">            TextView childAt = (TextView) getChildAt(start + <span class="number">1</span>); <span class="comment">// 获取当前聚焦的TextView</span></span><br><span class="line">            <span class="keyword">if</span> (before == <span class="number">0</span>) &#123;</span><br><span class="line">                childAt.setText(<span class="string">"●"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                childAt.setText(<span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前密码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPwd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> editText.getText().toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFocusShape</span><span class="params">(<span class="keyword">boolean</span> showFocusShape)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.showFocusShape = showFocusShape;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="添加TextView"><a href="#添加TextView" class="headerlink" title="添加TextView"></a>添加TextView</h1></li>
<li>添加6个正方形的TextView在顶部，来实现我们的六位密码框输入布局，自定义TextView在onMeasure中设置宽等于高</li>
<li>定义单个密码框之间间隔为6，第一个密码框marginStart为0，marginEnd为5/6 * space，第二个密码框marginStart为1/6 * space，marginEnd为4/6 * space，第三个密码框marginStart为2/6 * space，marginEnd为3/6 * space，前一个密码框的marginEnd + marginStart = space，所以marginStart = space * i / defaultSize，marginEnd = space * (defaultSize - 1 - i) / defaultSize</li>
<li>设置当前输入的密码框聚焦背景<h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2>这里最开始的实现思路有问题，把TextView的weight设置为并动态添加，对当前LinearLayout的onMeasure方法做了处理，获取每个TextView的宽度再设置其高度导致应用到底部弹窗布局时，小米机型上由于TextView的高度做了调整比调整前的高度更高，使得软件盘顶上去的高度不够，下面的文本被遮挡。但是在华为等机型上又表现正常，可能跟Rom的处理有关（这些机型上又自动刷新了一次）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> showFocusShape = <span class="keyword">true</span>; <span class="comment">// 是否设置聚焦背景</span></span><br><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">double</span> space = SizeUtils.dp2px(<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; defaultSize; i++) &#123;</span><br><span class="line">        TextView textView = (TextView) LayoutInflater.from(getContext()).inflate(R.layout.single_pwd_editext, <span class="keyword">null</span>);</span><br><span class="line">        LinearLayout.LayoutParams layoutParams = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT, <span class="number">1</span>);</span><br><span class="line">        layoutParams.setMarginStart((<span class="keyword">int</span>) (space * i / defaultSize));</span><br><span class="line">        layoutParams.setMarginEnd((<span class="keyword">int</span>) (space * (defaultSize - i - <span class="number">1</span>) / defaultSize));</span><br><span class="line">        addView(textView, layoutParams);</span><br><span class="line">    &#125;</span><br><span class="line">    editText.setOnFocusChangeListener((v, hasFocus) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!showFocusShape) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; getChildCount(); i++) &#123;</span><br><span class="line">            getChildAt(i).setBackgroundResource(hasFocus ? R.drawable.shape_editext_border_green_2r : R.drawable.shape_edittext_border_background_with_error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SquareTextView</span> <span class="keyword">extends</span> <span class="title">AppCompatTextView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SquareTextView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SquareTextView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (widthMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"mode is UNSPECIFIED"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setMeasuredDimension(widthSize, widthSize);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>shape_editext_border_green_2r.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/emphasis4"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">stroke</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:width</span>=<span class="string">"@dimen/line_width"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">"@color/primary"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"2dp"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>shape_edittext_border_background_with_error.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_activated</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/emphasis4"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">stroke</span> <span class="attr">android:width</span>=<span class="string">"@dimen/line_width"</span> <span class="attr">android:color</span>=<span class="string">"@color/secondary"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"6dp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_activated</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shape</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"@color/emphasis4"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"6dp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>single_pwd_editext中引用自定义TextView<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">"com.resources.widget.PassWordView$SquareTextView"</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/shape_edittext_border_background_with_error"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:textColor</span>=<span class="string">"@color/c_text60"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="定义回调返回密码输入完成的数据"><a href="#定义回调返回密码输入完成的数据" class="headerlink" title="定义回调返回密码输入完成的数据"></a>定义回调返回密码输入完成的数据</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PasswordCallback passwordCallback;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PassWordCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(String password)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswordCallback</span><span class="params">(PasswordCallback passwordCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.passwordCallback = passwordCallback;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    editText.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">            TextView childAt = (TextView) getChildAt(start + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (before == <span class="number">0</span>) &#123; <span class="comment">// 新增情况下</span></span><br><span class="line">                childAt.setText(<span class="string">"●"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                childAt.setText(<span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(s) &amp;&amp; s.length() == defaultSize) &#123;</span><br><span class="line">                <span class="keyword">if</span> (passwordCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        passwordCallback.complete(s.toString());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="最后附上完整代码"><a href="#最后附上完整代码" class="headerlink" title="最后附上完整代码"></a>最后附上完整代码</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PassWordView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> defaultSize = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> PasswordCallback passwordCallback;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">PassWordCallback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">complete</span><span class="params">(String password)</span></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPasswordCallback</span><span class="params">(PasswordCallback passwordCallback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passwordCallback = passwordCallback;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> showFocusShape = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> EditText editText;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PassWordView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearPassWord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        editText.setText(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        editText = <span class="keyword">new</span> EditText(getContext());</span><br><span class="line">        editText.setTextSize(<span class="number">12f</span>);</span><br><span class="line">        editText.setLayoutParams(<span class="keyword">new</span> FrameLayout.LayoutParams(<span class="number">1</span>, ViewGroup.LayoutParams.WRAP_CONTENT));</span><br><span class="line">        editText.setCursorVisible(<span class="keyword">false</span>);</span><br><span class="line">        editText.setBackgroundDrawable(<span class="keyword">null</span>);</span><br><span class="line">        editText.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_VARIATION_PASSWORD);</span><br><span class="line">        addView(editText);</span><br><span class="line">        editText.setFilters(<span class="keyword">new</span> InputFilter[]&#123;<span class="keyword">new</span> InputFilter.LengthFilter(defaultSize)&#125;);</span><br><span class="line">        setOnClickListener(v -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (editText.requestFocus()) &#123;</span><br><span class="line">                InputMethodManager imm = (InputMethodManager) getContext().getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">                <span class="keyword">if</span> (imm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    imm.showSoftInput(editText, InputMethodManager.SHOW_IMPLICIT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> space = SizeUtils.dp2px(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; defaultSize; i++) &#123;</span><br><span class="line">            TextView textView = (TextView) LayoutInflater.from(getContext()).inflate(R.layout.single_pwd_editext, <span class="keyword">null</span>);</span><br><span class="line">             LinearLayout.LayoutParams layoutParams = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT, <span class="number">1</span>);</span><br><span class="line">            layoutParams.setMarginStart((<span class="keyword">int</span>) (space * i / defaultSize));</span><br><span class="line">            layoutParams.setMarginEnd((<span class="keyword">int</span>) (space * (defaultSize - i - <span class="number">1</span>) / defaultSize));</span><br><span class="line">            addView(textView, layoutParams);</span><br><span class="line">        &#125;</span><br><span class="line">        editText.setOnFocusChangeListener((v, hasFocus) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!showFocusShape) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; getChildCount(); i++) &#123;</span><br><span class="line">                getChildAt(i).setBackgroundResource(hasFocus ? R.drawable.shape_editext_border_green_2r : R.drawable.shape_edittext_border_background_with_error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        editText.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">                TextView childAt = (TextView) getChildAt(start + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (before == <span class="number">0</span>) &#123;</span><br><span class="line">                    childAt.setText(<span class="string">"●"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    childAt.setText(<span class="string">""</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!TextUtils.isEmpty(s) &amp;&amp; s.length() == defaultSize) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (passwordCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            passwordCallback.complete(s.toString());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPwd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> editText.getText().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFocusShape</span><span class="params">(<span class="keyword">boolean</span> showFocusShape)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.showFocusShape = showFocusShape;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SquareTextView</span> <span class="keyword">extends</span> <span class="title">AppCompatTextView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SquareTextView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SquareTextView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">            <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">            <span class="keyword">if</span> (widthMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"mode is UNSPECIFIED"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setMeasuredDimension(widthSize, widthSize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="在xml中使用"><a href="#在xml中使用" class="headerlink" title="在xml中使用"></a>在xml中使用</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/root"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@color/c_large"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingStart</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingEnd</span>=<span class="string">"16dp"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/tv1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/input_pwd"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"@color/c_text"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"20sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/iv_close"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingStart</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">"@mipmap/icon_close"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:tint</span>=<span class="string">"@color/emphasis60"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.resources.widget.PassWordView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/password_view"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/tv1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@+id/tv1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_goneMarginTop</span>=<span class="string">"20dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/password_view"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/tips_input"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"@color/secondary"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"14sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@+id/password_view"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/tv_forget_pwd"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@+id/password_view"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/forget_pwd"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"@color/c_text60"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"14sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@+id/password_view"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/13/DashBoard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/05/13/DashBoard/" class="post-title-link" itemprop="url">Android自定义仪表盘</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-05-13 20:32:49" itemprop="dateCreated datePublished" datetime="2022-05-13T20:32:49+08:00">2022-05-13</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-03 14:03:32" itemprop="dateModified" datetime="2022-05-03T14:03:32+08:00">2022-05-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>又是更新blog的一天，最近项目中遇到一个需求，绘制一个渐变色的仪表盘去展示某个行情当前的热度，为用户提供当前市场热度更直观的一个大概参考，需要用到自定义View的相关知识，在这里做一个总结，欢迎一起学习和讨论～</p>
<hr>
<p>最终效果图：<br><img src="/images/dashboard.png" alt="效果图"></p>
<h1 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h1><ul>
<li>声明画笔，颜色，刻度数，属性动画，进度条宽度，表盘矩形区域，文本大小，必要的偏移量，表盘的开始和过渡角度<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> progressColor = intArrayOf() <span class="comment">// 渐变色开始颜色</span></span><br><span class="line"><span class="keyword">var</span> progressBackgroundColor = R.color.emphasis16 <span class="comment">// 进度条背景颜色</span></span><br><span class="line"><span class="keyword">var</span> textColor = R.color.primary <span class="comment">// 文字颜色</span></span><br><span class="line"><span class="keyword">var</span> tickScaleColor = R.color.emphasis8 <span class="comment">// 普通刻度线颜色</span></span><br><span class="line"><span class="keyword">var</span> groupScaleColor = R.color.emphasis38 <span class="comment">// 分组刻度线颜色</span></span><br><span class="line"><span class="keyword">var</span> progressStrokeWidth = <span class="number">24f</span> <span class="comment">// 进度条宽度</span></span><br><span class="line"><span class="keyword">var</span> paintProgressBackground = Paint() <span class="comment">// 进度条背景画笔</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> paintProgress = Paint() <span class="comment">// 进度条画笔</span></span><br><span class="line"><span class="keyword">var</span> paintText = Paint() <span class="comment">// 文字画笔</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> paintNum = Paint() <span class="comment">// 刻度画笔</span></span><br><span class="line"><span class="keyword">var</span> rect = RectF() <span class="comment">// 表盘矩形区域</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> viewWidth = <span class="number">0</span> <span class="comment">// 宽度</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> viewHeight = <span class="number">0</span> <span class="comment">// 高度</span></span><br><span class="line"><span class="keyword">var</span> percent = <span class="number">0f</span> <span class="comment">// 百分比</span></span><br><span class="line"><span class="keyword">var</span> oldPercent = <span class="number">0f</span> <span class="comment">// 过去的百分比</span></span><br><span class="line"><span class="keyword">var</span> textSize = <span class="number">100f</span> <span class="comment">// 文本大小</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> valueAnimator: ValueAnimator? = <span class="literal">null</span> <span class="comment">// 属性动画</span></span><br><span class="line"><span class="keyword">var</span> animatorDuration = <span class="number">0L</span> <span class="comment">// 动画时长</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> groupNum = <span class="number">5</span> <span class="comment">// 分组数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> ticksNum = <span class="number">6</span> <span class="comment">// 每组刻度数</span></span><br><span class="line"><span class="keyword">var</span> pointerWidth = <span class="number">15f</span> <span class="comment">// 指针的宽度</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> ticksCount = groupNum * ticksNum + <span class="number">1</span><span class="comment">// 总刻度数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> OFFSET = <span class="number">30f</span> <span class="comment">// 偏移量</span></span><br><span class="line">    <span class="keyword">var</span> START_ARC = <span class="number">150f</span> <span class="comment">// 开始角度</span></span><br><span class="line">    <span class="keyword">var</span> DURING_ARC = <span class="number">240f</span> <span class="comment">// 过渡调度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="初始化逻辑"><a href="#初始化逻辑" class="headerlink" title="初始化逻辑"></a>初始化逻辑</h1><ul>
<li>获取xml的配置进行变量初始化<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    setLayerType(LAYER_TYPE_SOFTWARE, <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">val</span> typedArray = context.obtainStyledAttributes(attrs, R.styleable.dashboard)</span><br><span class="line">    progressBackgroundColor = typedArray.getColor(</span><br><span class="line">        R.styleable.dashboard_progressBackgroundColor,</span><br><span class="line">        ContextCompat.getColor(context, progressBackgroundColor)</span><br><span class="line">    )</span><br><span class="line">    progressStrokeWidth = typedArray.getDimension(</span><br><span class="line">        R.styleable.dashboard_progressStrokeWidth,</span><br><span class="line">        progressStrokeWidth</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    textSize = typedArray.getDimension(</span><br><span class="line">        R.styleable.dashboard_textSize,</span><br><span class="line">        textSize</span><br><span class="line">    )</span><br><span class="line">    textColor = typedArray.getColor(R.styleable.dashboard_textColor, textColor)</span><br><span class="line">    tickScaleColor =</span><br><span class="line">        typedArray.getColor(R.styleable.dashboard_tickScaleColor, tickScaleColor)</span><br><span class="line">    groupScaleColor =</span><br><span class="line">        typedArray.getColor(R.styleable.dashboard_groupScaleColor, groupScaleColor)</span><br><span class="line">    groupNum = typedArray.getInt(R.styleable.dashboard_groupNum, groupNum)</span><br><span class="line">    ticksNum = typedArray.getInt(R.styleable.dashboard_ticksNum, ticksNum)</span><br><span class="line">    pointerWidth =</span><br><span class="line">        typedArray.getDimension(R.styleable.dashboard_pointerWidth, pointerWidth)</span><br><span class="line">    <span class="keyword">val</span> colorsId = typedArray.getResourceId(R.styleable.dashboard_progressColors, <span class="number">0</span>)</span><br><span class="line">    progressColor =typedArray.resources.getIntArray(colorsId)</span><br><span class="line">        ticksCount = groupNum * ticksNum + <span class="number">1</span></span><br><span class="line">    typedArray.recycle()</span><br><span class="line">    OFFSET = progressStrokeWidth + <span class="number">10f</span></span><br><span class="line">    initPaint()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化画笔</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initPaint</span><span class="params">()</span></span> &#123;</span><br><span class="line">    paintProgressBackground.isAntiAlias = <span class="literal">true</span></span><br><span class="line">    paintProgressBackground.strokeWidth = progressStrokeWidth</span><br><span class="line">    paintProgressBackground.style = Paint.Style.STROKE</span><br><span class="line">    paintProgressBackground.color = progressBackgroundColor</span><br><span class="line">    paintProgressBackground.isDither = <span class="literal">true</span></span><br><span class="line">    paintProgress.isAntiAlias = <span class="literal">true</span></span><br><span class="line">    paintProgress.strokeWidth = progressStrokeWidth</span><br><span class="line">    paintProgress.style = Paint.Style.STROKE</span><br><span class="line">    paintProgress.isDither = <span class="literal">true</span></span><br><span class="line">    paintText.isAntiAlias = <span class="literal">true</span></span><br><span class="line">    paintText.color = textColor</span><br><span class="line">    paintText.strokeWidth = <span class="number">1F</span></span><br><span class="line">    paintText.style = Paint.Style.FILL</span><br><span class="line">    paintText.isDither = <span class="literal">true</span></span><br><span class="line">    paintNum.isAntiAlias = <span class="literal">true</span></span><br><span class="line">    paintNum.strokeWidth = <span class="number">3f</span></span><br><span class="line">    paintNum.style = Paint.Style.FILL</span><br><span class="line">    paintNum.isDither = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="声明xml配置属性"><a href="#声明xml配置属性" class="headerlink" title="声明xml配置属性"></a>声明xml配置属性</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"dashboard"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"progressStrokeWidth"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"progressBackgroundColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"tickScaleColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"groupScaleColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"groupNum"</span> <span class="attr">format</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"ticksNum"</span> <span class="attr">format</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"pointerWidth"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"progressColors"</span> <span class="attr">format</span>=<span class="string">"reference"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="获取自定义View宽高，初始化渐变进度条"><a href="#获取自定义View宽高，初始化渐变进度条" class="headerlink" title="获取自定义View宽高，初始化渐变进度条"></a>获取自定义View宽高，初始化渐变进度条</h1><h2 id="回顾一下View的生命周期"><a href="#回顾一下View的生命周期" class="headerlink" title="回顾一下View的生命周期"></a>回顾一下View的生命周期</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activity.onCreate -&gt; onFinishInflate -&gt; activity.onStart -&gt; activity.onResume -&gt; onAttachedToWindow -&gt; onWindowVisibilityChanged -&gt; onVisibilityChanged -&gt; onMeasure -&gt; onSizeChanged -&gt; onLayout -&gt; onDraw -&gt; onWindowFocusChanged -&gt; activity.onPause -&gt; onWindowFocusChanged -&gt; onWindowVisibilityChanged -&gt; activity.onStop -&gt; onVisibilityChanged -&gt; activity.onDestroy -&gt; onDetachedFromWindow</span><br></pre></td></tr></table></figure></li>
<li>重写onSizeChanged，此时自定义View已经完成测量可以拿到当前自定义View的宽高</li>
<li>初始化指针宽度，当前变盘的矩形区域，以0，0点为原点，左边上角的坐标，x为-（View宽度 / 2）+ 偏移量 + paddingLeft，y为- (view高度 / 2) + 偏移量 + paddingTop，右下角的坐标，x为（View宽度 / 2）- 偏移量 - paddingRight，y为（view高度 / 2) - 偏移量 - paddingBottom，渐变色采用以原点为中心的90度渐变，初始化Shader的子类SweepGradient并设置一个以原点为中心的90度旋转操作后的矩阵，再设置这个Shader为画笔的Shader<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSizeChanged</span><span class="params">(w: <span class="type">Int</span>, h: <span class="type">Int</span>, oldw: <span class="type">Int</span>, oldh: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh)</span><br><span class="line">    viewWidth = width</span><br><span class="line">    viewHeight = height</span><br><span class="line">    pointerWidth = (viewWidth / <span class="number">40</span>).toFloat()</span><br><span class="line">    initShader()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化渐变颜色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initShader</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rect.<span class="keyword">set</span>(</span><br><span class="line">        (-viewWidth / <span class="number">2</span>) + OFFSET + paddingLeft, paddingTop - (viewHeight / <span class="number">2</span>) + OFFSET,</span><br><span class="line">        (viewWidth / <span class="number">2</span>) - paddingRight - OFFSET,</span><br><span class="line">        (viewWidth / <span class="number">2</span>) - paddingBottom - OFFSET</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> shader = SweepGradient(</span><br><span class="line">        <span class="number">0f</span>,</span><br><span class="line">        <span class="number">0f</span>,</span><br><span class="line">        progressColor,</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> rotate = <span class="number">90f</span></span><br><span class="line">    <span class="keyword">val</span> gradientMatrix = Matrix()</span><br><span class="line">    gradientMatrix.preRotate(rotate, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">    shader.setLocalMatrix(gradientMatrix)</span><br><span class="line">    paintProgress.shader = shader</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="测量View的宽高"><a href="#测量View的宽高" class="headerlink" title="测量View的宽高"></a>测量View的宽高</h1></li>
<li>根据当前的模式和大小决定View大小，如果是明确指明宽高的大小就用当前声明的值，否则就设置一个固定值使得宽高一致防止自定义View形变<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">    <span class="keyword">val</span> realWidth = startMeasure(widthMeasureSpec)</span><br><span class="line">    <span class="keyword">val</span> realHeight = startMeasure(heightMeasureSpec)</span><br><span class="line">    setMeasuredDimension(realWidth, realHeight)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">startMeasure</span><span class="params">(msSpec: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> mode = MeasureSpec.getMode(msSpec)</span><br><span class="line">    <span class="keyword">val</span> size = MeasureSpec.getSize(msSpec)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (mode == MeasureSpec.EXACTLY) &#123;</span><br><span class="line">        size</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Util.dp2px(<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="重写绘制方法"><a href="#重写绘制方法" class="headerlink" title="重写绘制方法"></a>重写绘制方法</h1></li>
<li>当前的仪表盘的绘制逻辑分为绘制表盘刻度，绘制进度条，绘制文本，绘制指针，canvas的原点为左上角，为了方便计算在绘制前需要把原点移动到canvas的中心，所以x方向平移（View宽度 / 2），y方向平移（View高度 / 2）<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    canvas?.translate((viewWidth / <span class="number">2</span>).toFloat(), (viewHeight / <span class="number">2</span>).toFloat())</span><br><span class="line">    drawPanel(canvas)</span><br><span class="line">    drawProgress(canvas, percent)</span><br><span class="line">    drawText(canvas, percent)</span><br><span class="line">    drawPointer(canvas, percent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="绘制表盘刻度"><a href="#绘制表盘刻度" class="headerlink" title="绘制表盘刻度"></a>绘制表盘刻度</h2></li>
<li>以0，0点为圆心，绘制起始点逆时针旋转-120度，计算刻度的y坐标为 -(View高度 / 2) + 偏移量 + 进度条宽度，计算每个刻度的旋转角度为过渡角度 / （总刻度数 - 1），再以总刻度数进行循环绘制刻度线条，判断当前下标是否为新一组开始刻度的位置，区分普通刻度和分割刻度并设置不同的颜色<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绘制刻度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">drawPanel</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    canvas?.save()</span><br><span class="line">    canvas?.rotate(-(<span class="number">180</span> - START_ARC + <span class="number">90</span>), <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">    <span class="keyword">val</span> numY = -viewHeight / <span class="number">2</span> + OFFSET + progressStrokeWidth</span><br><span class="line">    <span class="keyword">val</span> angle = DURING_ARC / ((ticksCount - <span class="number">1</span>) * <span class="number">1.0f</span>)</span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until ticksCount) &#123;</span><br><span class="line">        canvas?.save()</span><br><span class="line">        canvas?.rotate(angle * i, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span> || i % groupNum == <span class="number">0</span>) &#123;</span><br><span class="line">            paintNum.color = groupScaleColor</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            paintNum.color = tickScaleColor</span><br><span class="line">        &#125;</span><br><span class="line">        canvas?.drawLine(<span class="number">0f</span>, numY + <span class="number">2</span>, <span class="number">0f</span>, numY + (pointerWidth * <span class="number">2</span>) + <span class="number">5</span>, paintNum)</span><br><span class="line">        canvas?.restore()</span><br><span class="line">    &#125;</span><br><span class="line">    canvas?.restore()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="绘制进度条"><a href="#绘制进度条" class="headerlink" title="绘制进度条"></a>绘制进度条</h2></li>
<li>先绘制背景进度条，绘制一个圆弧，绘制区域为表盘矩形区域，设置开始角度和过渡角度</li>
<li>绘制进度条，判断当前的进度百分比如果大于1则为1，过滤掉其他异常情况，如果百分比大于0绘制一个渐变色圆弧，根据当前百分比和过渡角度计算当前需要绘制的渐变色过渡角度<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绘制进度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawProgress</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">    canvas?.drawArc(rect, START_ARC, DURING_ARC, <span class="literal">false</span>, paintProgressBackground)</span><br><span class="line">    <span class="keyword">var</span> curPercent = percent</span><br><span class="line">    <span class="keyword">if</span> (curPercent &gt; <span class="number">1.0f</span>) &#123;</span><br><span class="line">        curPercent = <span class="number">1.0f</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (curPercent &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">        canvas?.drawArc(rect, START_ARC, percent * DURING_ARC, <span class="literal">false</span>, paintProgress)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="绘制文本"><a href="#绘制文本" class="headerlink" title="绘制文本"></a>绘制文本</h2></li>
<li>根据当前的进度百分比设置文本的内容和颜色，根据当前的View宽度计算一个Y方向的偏移量，如果百分比小于0.2展示“Very Cold”文本，渐变色数组中取第一个颜色，绘制文本的x坐标为文本宽度/2，第一个词y坐标为1.4倍偏移量，第二个词为2.4倍偏移量，如果百分比大于等于0.2并且小于0.4展示“Cold”文本，y坐标为2.2倍偏移量，如果百分比大于等于0.4并且小于0.6展示“Normal”文本，y坐标为2.2倍偏移量，如果百分比大于等于0.6并且小于0.8展示“Hot”文本，y坐标为2.2倍偏移量，如果是剩下的情况展示“Very Hot”文本，第一个词y坐标为1.4倍偏移量，第二个词为2.4倍偏移量<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 绘制文本</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@SuppressLint(<span class="meta-string">"RestrictedApi"</span>)</span></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">drawText</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">       <span class="keyword">val</span> offsetY = viewWidth / <span class="number">8</span></span><br><span class="line">       paintText.textSize = textSize</span><br><span class="line">       <span class="keyword">if</span> (percent &lt; <span class="number">0.2f</span>) &#123;</span><br><span class="line">           <span class="keyword">val</span> subTitle1 = <span class="string">"Very"</span></span><br><span class="line">           paintText.color = progressColor[<span class="number">0</span>]</span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle1,</span><br><span class="line">               -paintText.measureText(subTitle1) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">1.4f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line"></span><br><span class="line">           <span class="keyword">val</span> subTitle2 = <span class="string">"Cold"</span></span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle2,</span><br><span class="line">               -paintText.measureText(subTitle2) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">2.4f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.2f</span> &amp;&amp; percent &lt; <span class="number">0.4f</span>) &#123;</span><br><span class="line">           <span class="keyword">val</span> subTitle = <span class="string">"Cold"</span></span><br><span class="line">           paintText.color = progressColor[<span class="number">0</span>]</span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle,</span><br><span class="line">               -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">2.2f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.4f</span> &amp;&amp; percent &lt; <span class="number">0.6f</span>) &#123;</span><br><span class="line">           <span class="keyword">val</span> subTitle = <span class="string">"Normal"</span></span><br><span class="line">           paintText.color = progressColor[<span class="number">2</span>]</span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle,</span><br><span class="line">               -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">2.2f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.6f</span> &amp;&amp; percent &lt; <span class="number">0.8f</span>) &#123;</span><br><span class="line">           <span class="keyword">val</span> subTitle = <span class="string">"Hot"</span></span><br><span class="line">           paintText.color = progressColor[<span class="number">4</span>]</span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle,</span><br><span class="line">               -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">2.2f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">val</span> subTitle1 = <span class="string">"Very"</span></span><br><span class="line">           paintText.color = progressColor[<span class="number">4</span>]</span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle1,</span><br><span class="line">               -paintText.measureText(subTitle1) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">1.4f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line"></span><br><span class="line">           <span class="keyword">val</span> subTitle2 = <span class="string">"Hot"</span></span><br><span class="line">           canvas?.drawText(</span><br><span class="line">               subTitle2,</span><br><span class="line">               -paintText.measureText(subTitle2) / <span class="number">2</span>,</span><br><span class="line">               offsetY * <span class="number">2.4f</span>,</span><br><span class="line">               paintText</span><br><span class="line">           )</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       paintText.textSize = (textSize * <span class="number">1.3</span>).toFloat()</span><br><span class="line">       <span class="keyword">val</span> text = (percent * <span class="number">100</span>).toInt().toString()</span><br><span class="line">       canvas?.drawText(</span><br><span class="line">           text,</span><br><span class="line">           -paintText.measureText(text) / <span class="number">2</span>,</span><br><span class="line">           - textSize / <span class="number">5f</span>,</span><br><span class="line">           paintText</span><br><span class="line">       )</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="绘制指针"><a href="#绘制指针" class="headerlink" title="绘制指针"></a>绘制指针</h2></li>
<li>绘制一个三角形的指针，根据当前的百分比计算指针所在位置的旋转角度，再计算指针所在位置需要绘制三角形的路径，从(0, view的高度/2 - 偏移量 - 进度条宽度)为起点，绘制一个倒三角形，绘制右边的线段和左边的线段再绘制顶部的线段，以垂直向下为0度，旋转范围是-300到-60并设置填充模式绘制这条路径<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 绘制指针</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawPointer</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">      canvas?.save()</span><br><span class="line">      <span class="keyword">val</span> angle = DURING_ARC * (percent - <span class="number">0.5f</span>) - <span class="number">180</span></span><br><span class="line">      canvas?.rotate(angle, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">      <span class="keyword">val</span> pointer = Path()</span><br><span class="line">      pointer.moveTo(<span class="number">0f</span>, viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth)</span><br><span class="line">      pointer.lineTo(</span><br><span class="line">          pointerWidth,</span><br><span class="line">          viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth - (pointerWidth * <span class="number">2</span>)</span><br><span class="line">      )</span><br><span class="line">      pointer.lineTo(</span><br><span class="line">          -pointerWidth,</span><br><span class="line">          viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth - (pointerWidth * <span class="number">2</span>)</span><br><span class="line">      )</span><br><span class="line">      pointer.lineTo(<span class="number">0f</span>, viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth)</span><br><span class="line">      pointer.close()</span><br><span class="line">      pointer.fillType = Path.FillType.EVEN_ODD</span><br><span class="line">      canvas?.drawPath(pointer, paintText)</span><br><span class="line">      canvas?.restore()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="设置百分比和动画"><a href="#设置百分比和动画" class="headerlink" title="设置百分比和动画"></a>设置百分比和动画</h1><ul>
<li>传入当前的百分比范围0~1，初始化属性动画设置属性值变化监听刷新当前百分比，根据上一次的百分比和当前百分比计算动画时间，设置动画开始结束的百分比数值，设置动画结束监听刷新上一次百分比数值并做边界判断。<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置当前百分比</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curPercent Float 范围0~1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setProgress</span><span class="params">(curPercent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valueAnimator?.isRunning == <span class="literal">true</span>) &#123;</span><br><span class="line">            valueAnimator?.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">        animatorDuration = (abs(curPercent - oldPercent) * <span class="number">20</span>).toLong()</span><br><span class="line">        valueAnimator = ValueAnimator.ofFloat(oldPercent, curPercent).setDuration(animatorDuration)</span><br><span class="line">        valueAnimator?.addUpdateListener &#123;</span><br><span class="line">            percent = it.animatedValue <span class="keyword">as</span> <span class="built_in">Float</span></span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">        valueAnimator?.interpolator = LinearInterpolator()</span><br><span class="line">        valueAnimator?.addListener(onEnd = &#123;</span><br><span class="line">            oldPercent = curPercent</span><br><span class="line">            <span class="keyword">if</span> (percent &lt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                percent = <span class="number">0.0f</span></span><br><span class="line">                invalidate()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (percent &gt; <span class="number">1f</span>) &#123;</span><br><span class="line">                percent = <span class="number">1f</span></span><br><span class="line">                invalidate()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        valueAnimator?.start()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1></li>
<li>xml声明<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.example.testapp.DashboardView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/view_dashboard"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_marginStart</span>=<span class="string">"6dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_marginTop</span>=<span class="string">"8dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:groupNum</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:groupScaleColor</span>=<span class="string">"@color/emphasis38"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:pointerWidth</span>=<span class="string">"2dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:progressBackgroundColor</span>=<span class="string">"@color/emphasis8"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:progressStrokeWidth</span>=<span class="string">"6dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:progressColors</span>=<span class="string">"@array/dashboardColors"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:textSize</span>=<span class="string">"24sp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tickScaleColor</span>=<span class="string">"@color/emphasis8"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:ticksNum</span>=<span class="string">"6"</span> /&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>设置当前百分比<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboardView.setProgress((float) i / <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
最后附上完整代码：<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.testapp</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.animation.ValueAnimator</span><br><span class="line"><span class="keyword">import</span> android.<span class="keyword">annotation</span>.SuppressLint</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.*</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.animation.LinearInterpolator</span><br><span class="line"><span class="keyword">import</span> androidx.core.animation.addListener</span><br><span class="line"><span class="keyword">import</span> androidx.core.content.ContextCompat</span><br><span class="line"><span class="keyword">import</span> kotlin.math.abs</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(<span class="meta-string">"CustomViewStyleable"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DashboardView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">    context: Context,</span><br><span class="line">    attrs: AttributeSet? = <span class="literal">null</span>,</span><br><span class="line">    defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) :</span><br><span class="line">    View(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    <span class="keyword">var</span> progressColor = intArrayOf() <span class="comment">// 渐变色开始颜色</span></span><br><span class="line">    <span class="keyword">var</span> progressBackgroundColor = R.color.emphasis16 <span class="comment">// 进度条背景颜色</span></span><br><span class="line">    <span class="keyword">var</span> textColor = R.color.primary <span class="comment">// 文字颜色</span></span><br><span class="line">    <span class="keyword">var</span> tickScaleColor = R.color.emphasis8 <span class="comment">// 普通刻度线颜色</span></span><br><span class="line">    <span class="keyword">var</span> groupScaleColor = R.color.emphasis38 <span class="comment">// 分组刻度线颜色</span></span><br><span class="line">    <span class="keyword">var</span> progressStrokeWidth = <span class="number">24f</span> <span class="comment">// 进度条宽度</span></span><br><span class="line">    <span class="keyword">var</span> paintProgressBackground = Paint() <span class="comment">// 进度条背景画笔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> paintProgress = Paint() <span class="comment">// 进度条画笔</span></span><br><span class="line">    <span class="keyword">var</span> paintText = Paint() <span class="comment">// 文字画笔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> paintNum = Paint() <span class="comment">// 刻度画笔</span></span><br><span class="line">    <span class="keyword">var</span> rect = RectF() <span class="comment">// 表盘矩形区域</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> viewWidth = <span class="number">0</span> <span class="comment">// 宽度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> viewHeight = <span class="number">0</span> <span class="comment">// 高度</span></span><br><span class="line">    <span class="keyword">var</span> percent = <span class="number">0f</span> <span class="comment">// 百分比</span></span><br><span class="line">    <span class="keyword">var</span> oldPercent = <span class="number">0f</span> <span class="comment">// 过去的百分比</span></span><br><span class="line">    <span class="keyword">var</span> textSize = <span class="number">100f</span> <span class="comment">// 文本大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> valueAnimator: ValueAnimator? = <span class="literal">null</span> <span class="comment">// 属性动画</span></span><br><span class="line">    <span class="keyword">var</span> animatorDuration = <span class="number">0L</span> <span class="comment">// 动画时长</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> groupNum = <span class="number">5</span> <span class="comment">// 分组数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> ticksNum = <span class="number">6</span> <span class="comment">// 每组刻度数</span></span><br><span class="line">    <span class="keyword">var</span> pointerWidth = <span class="number">15f</span> <span class="comment">// 指针的宽度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> ticksCount = groupNum * ticksNum + <span class="number">1</span><span class="comment">// 总刻度数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> OFFSET = <span class="number">30f</span> <span class="comment">// 偏移量</span></span><br><span class="line">        <span class="keyword">var</span> START_ARC = <span class="number">150f</span> <span class="comment">// 开始角度</span></span><br><span class="line">        <span class="keyword">var</span> DURING_ARC = <span class="number">240f</span> <span class="comment">// 过渡调度</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        setLayerType(LAYER_TYPE_SOFTWARE, <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">val</span> typedArray = context.obtainStyledAttributes(attrs, R.styleable.dashboard)</span><br><span class="line">        progressBackgroundColor = typedArray.getColor(</span><br><span class="line">            R.styleable.dashboard_progressBackgroundColor,</span><br><span class="line">            ContextCompat.getColor(context, progressBackgroundColor)</span><br><span class="line">        )</span><br><span class="line">        progressStrokeWidth = typedArray.getDimension(</span><br><span class="line">            R.styleable.dashboard_progressStrokeWidth,</span><br><span class="line">            progressStrokeWidth</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        textSize = typedArray.getDimension(</span><br><span class="line">            R.styleable.dashboard_textSize,</span><br><span class="line">            textSize</span><br><span class="line">        )</span><br><span class="line">        textColor = typedArray.getColor(R.styleable.dashboard_textColor, textColor)</span><br><span class="line">        tickScaleColor =</span><br><span class="line">            typedArray.getColor(R.styleable.dashboard_tickScaleColor, tickScaleColor)</span><br><span class="line">        groupScaleColor =</span><br><span class="line">            typedArray.getColor(R.styleable.dashboard_groupScaleColor, groupScaleColor)</span><br><span class="line">        groupNum = typedArray.getInt(R.styleable.dashboard_groupNum, groupNum)</span><br><span class="line">        ticksNum = typedArray.getInt(R.styleable.dashboard_ticksNum, ticksNum)</span><br><span class="line">        pointerWidth =</span><br><span class="line">            typedArray.getDimension(R.styleable.dashboard_pointerWidth, pointerWidth)</span><br><span class="line">        <span class="keyword">val</span> colorsId = typedArray.getResourceId(R.styleable.dashboard_progressColors, <span class="number">0</span>)</span><br><span class="line">        progressColor =typedArray.resources.getIntArray(colorsId)</span><br><span class="line">            ticksCount = groupNum * ticksNum + <span class="number">1</span></span><br><span class="line">        typedArray.recycle()</span><br><span class="line">        OFFSET = progressStrokeWidth + <span class="number">10f</span></span><br><span class="line">        initPaint()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> realWidth = startMeasure(widthMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> realHeight = startMeasure(heightMeasureSpec)</span><br><span class="line">        setMeasuredDimension(realWidth, realHeight)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">startMeasure</span><span class="params">(msSpec: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> mode = MeasureSpec.getMode(msSpec)</span><br><span class="line">        <span class="keyword">val</span> size = MeasureSpec.getSize(msSpec)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (mode == MeasureSpec.EXACTLY) &#123;</span><br><span class="line">            size</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Util.dp2px(<span class="number">200</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSizeChanged</span><span class="params">(w: <span class="type">Int</span>, h: <span class="type">Int</span>, oldw: <span class="type">Int</span>, oldh: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh)</span><br><span class="line">        viewWidth = width</span><br><span class="line">        viewHeight = height</span><br><span class="line">        pointerWidth = (viewWidth / <span class="number">40</span>).toFloat()</span><br><span class="line">        initShader()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        canvas?.translate((viewWidth / <span class="number">2</span>).toFloat(), (viewHeight / <span class="number">2</span>).toFloat())</span><br><span class="line">        drawPanel(canvas)</span><br><span class="line">        drawProgress(canvas, percent)</span><br><span class="line">        drawText(canvas, percent)</span><br><span class="line">        drawPointer(canvas, percent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制刻度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">drawPanel</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        canvas?.save()</span><br><span class="line">        canvas?.rotate(-(<span class="number">180</span> - START_ARC + <span class="number">90</span>), <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">        <span class="keyword">val</span> numY = -viewHeight / <span class="number">2</span> + OFFSET + progressStrokeWidth</span><br><span class="line">        <span class="keyword">val</span> angle = DURING_ARC / ((ticksCount - <span class="number">1</span>) * <span class="number">1.0f</span>)</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until ticksCount) &#123;</span><br><span class="line">            canvas?.save()</span><br><span class="line">            canvas?.rotate(angle * i, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span> || i % groupNum == <span class="number">0</span>) &#123;</span><br><span class="line">                paintNum.color = groupScaleColor</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                paintNum.color = tickScaleColor</span><br><span class="line">            &#125;</span><br><span class="line">            canvas?.drawLine(<span class="number">0f</span>, numY + <span class="number">2</span>, <span class="number">0f</span>, numY + (pointerWidth * <span class="number">2</span>) + <span class="number">5</span>, paintNum)</span><br><span class="line">            canvas?.restore()</span><br><span class="line">        &#125;</span><br><span class="line">        canvas?.restore()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制进度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawProgress</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        canvas?.drawArc(rect, START_ARC, DURING_ARC, <span class="literal">false</span>, paintProgressBackground)</span><br><span class="line">        <span class="keyword">var</span> curPercent = percent</span><br><span class="line">        <span class="keyword">if</span> (curPercent &gt; <span class="number">1.0f</span>) &#123;</span><br><span class="line">            curPercent = <span class="number">1.0f</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (curPercent &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">            canvas?.drawArc(rect, START_ARC, percent * DURING_ARC, <span class="literal">false</span>, paintProgress)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制指针</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawPointer</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        canvas?.save()</span><br><span class="line">        <span class="keyword">val</span> angle = DURING_ARC * (percent - <span class="number">0.5f</span>) - <span class="number">180</span></span><br><span class="line">        canvas?.rotate(angle, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">        <span class="keyword">val</span> pointer = Path()</span><br><span class="line">        pointer.moveTo(<span class="number">0f</span>, viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth)</span><br><span class="line">        pointer.lineTo(</span><br><span class="line">            pointerWidth,</span><br><span class="line">            viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth - (pointerWidth * <span class="number">2</span>)</span><br><span class="line">        )</span><br><span class="line">        pointer.lineTo(</span><br><span class="line">            -pointerWidth,</span><br><span class="line">            viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth - (pointerWidth * <span class="number">2</span>)</span><br><span class="line">        )</span><br><span class="line">        pointer.lineTo(<span class="number">0f</span>, viewHeight / <span class="number">2</span> - OFFSET - progressStrokeWidth)</span><br><span class="line">        pointer.close()</span><br><span class="line">        pointer.fillType = Path.FillType.EVEN_ODD</span><br><span class="line">        canvas?.drawPath(pointer, paintText)</span><br><span class="line">        canvas?.restore()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> canvas Canvas?</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> percent Float</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressLint(<span class="meta-string">"RestrictedApi"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">drawText</span><span class="params">(canvas: <span class="type">Canvas</span>?, percent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> offsetY = viewWidth / <span class="number">8</span></span><br><span class="line">        paintText.textSize = textSize</span><br><span class="line">        <span class="keyword">if</span> (percent &lt; <span class="number">0.2f</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> subTitle1 = <span class="string">"Very"</span></span><br><span class="line">            paintText.color = progressColor[<span class="number">0</span>]</span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle1,</span><br><span class="line">                -paintText.measureText(subTitle1) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">1.4f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> subTitle2 = <span class="string">"Cold"</span></span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle2,</span><br><span class="line">                -paintText.measureText(subTitle2) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">2.4f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.2f</span> &amp;&amp; percent &lt; <span class="number">0.4f</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> subTitle = <span class="string">"Cold"</span></span><br><span class="line">            paintText.color = progressColor[<span class="number">0</span>]</span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle,</span><br><span class="line">                -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">2.2f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.4f</span> &amp;&amp; percent &lt; <span class="number">0.6f</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> subTitle = <span class="string">"Normal"</span></span><br><span class="line">            paintText.color = progressColor[<span class="number">2</span>]</span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle,</span><br><span class="line">                -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">2.2f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (percent &gt;= <span class="number">0.6f</span> &amp;&amp; percent &lt; <span class="number">0.8f</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> subTitle = <span class="string">"Hot"</span></span><br><span class="line">            paintText.color = progressColor[<span class="number">4</span>]</span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle,</span><br><span class="line">                -paintText.measureText(subTitle) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">2.2f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> subTitle1 = <span class="string">"Very"</span></span><br><span class="line">            paintText.color = progressColor[<span class="number">4</span>]</span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle1,</span><br><span class="line">                -paintText.measureText(subTitle1) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">1.4f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> subTitle2 = <span class="string">"Hot"</span></span><br><span class="line">            canvas?.drawText(</span><br><span class="line">                subTitle2,</span><br><span class="line">                -paintText.measureText(subTitle2) / <span class="number">2</span>,</span><br><span class="line">                offsetY * <span class="number">2.4f</span>,</span><br><span class="line">                paintText</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        paintText.textSize = (textSize * <span class="number">1.3</span>).toFloat()</span><br><span class="line">        <span class="keyword">val</span> text = (percent * <span class="number">100</span>).toInt().toString()</span><br><span class="line">        canvas?.drawText(</span><br><span class="line">            text,</span><br><span class="line">            -paintText.measureText(text) / <span class="number">2</span>,</span><br><span class="line">            - textSize / <span class="number">5f</span>,</span><br><span class="line">            paintText</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置当前百分比</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curPercent Float 范围0~1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setProgress</span><span class="params">(curPercent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valueAnimator?.isRunning == <span class="literal">true</span>) &#123;</span><br><span class="line">            valueAnimator?.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">        animatorDuration = (abs(curPercent - oldPercent) * <span class="number">20</span>).toLong()</span><br><span class="line">        valueAnimator = ValueAnimator.ofFloat(oldPercent, curPercent).setDuration(animatorDuration)</span><br><span class="line">        valueAnimator?.addUpdateListener &#123;</span><br><span class="line">            percent = it.animatedValue <span class="keyword">as</span> <span class="built_in">Float</span></span><br><span class="line">            invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">        valueAnimator?.interpolator = LinearInterpolator()</span><br><span class="line">        valueAnimator?.addListener(onEnd = &#123;</span><br><span class="line">            oldPercent = curPercent</span><br><span class="line">            <span class="keyword">if</span> (percent &lt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                percent = <span class="number">0.0f</span></span><br><span class="line">                invalidate()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (percent &gt; <span class="number">1f</span>) &#123;</span><br><span class="line">                percent = <span class="number">1f</span></span><br><span class="line">                invalidate()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        valueAnimator?.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置进度条宽度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dp Int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setProgressStroke</span><span class="params">(dp: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        progressStrokeWidth = Util.dp2px(dp).toFloat()</span><br><span class="line">        paintProgress.strokeWidth = progressStrokeWidth</span><br><span class="line">        paintProgressBackground.strokeWidth = progressStrokeWidth</span><br><span class="line">        invalidate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化画笔</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initPaint</span><span class="params">()</span></span> &#123;</span><br><span class="line">        paintProgressBackground.isAntiAlias = <span class="literal">true</span></span><br><span class="line">        paintProgressBackground.strokeWidth = progressStrokeWidth</span><br><span class="line">        paintProgressBackground.style = Paint.Style.STROKE</span><br><span class="line">        paintProgressBackground.color = progressBackgroundColor</span><br><span class="line">        paintProgressBackground.isDither = <span class="literal">true</span></span><br><span class="line">        paintProgress.isAntiAlias = <span class="literal">true</span></span><br><span class="line">        paintProgress.strokeWidth = progressStrokeWidth</span><br><span class="line">        paintProgress.style = Paint.Style.STROKE</span><br><span class="line">        paintProgress.isDither = <span class="literal">true</span></span><br><span class="line">        paintText.isAntiAlias = <span class="literal">true</span></span><br><span class="line">        paintText.color = textColor</span><br><span class="line">        paintText.strokeWidth = <span class="number">1F</span></span><br><span class="line">        paintText.style = Paint.Style.FILL</span><br><span class="line">        paintText.isDither = <span class="literal">true</span></span><br><span class="line">        paintNum.isAntiAlias = <span class="literal">true</span></span><br><span class="line">        paintNum.strokeWidth = <span class="number">3f</span></span><br><span class="line">        paintNum.style = Paint.Style.FILL</span><br><span class="line">        paintNum.isDither = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化渐变颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initShader</span><span class="params">()</span></span> &#123;</span><br><span class="line">        rect.<span class="keyword">set</span>(</span><br><span class="line">            (-viewWidth / <span class="number">2</span>) + OFFSET + paddingLeft, paddingTop - (viewHeight / <span class="number">2</span>) + OFFSET,</span><br><span class="line">            (viewWidth / <span class="number">2</span>) - paddingRight - OFFSET,</span><br><span class="line">            (viewWidth / <span class="number">2</span>) - paddingBottom - OFFSET</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">val</span> shader = SweepGradient(</span><br><span class="line">            <span class="number">0f</span>,</span><br><span class="line">            <span class="number">0f</span>,</span><br><span class="line">            progressColor,</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">val</span> rotate = <span class="number">90f</span></span><br><span class="line">        <span class="keyword">val</span> gradientMatrix = Matrix()</span><br><span class="line">        gradientMatrix.preRotate(rotate, <span class="number">0f</span>, <span class="number">0f</span>)</span><br><span class="line">        shader.setLocalMatrix(gradientMatrix)</span><br><span class="line">        paintProgress.shader = shader</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/04/30/CompareIndicator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/04/30/CompareIndicator/" class="post-title-link" itemprop="url">Android自定义对比指示条</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-04-30 20:32:49" itemprop="dateCreated datePublished" datetime="2022-04-30T20:32:49+08:00">2022-04-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-03 14:30:11" itemprop="dateModified" datetime="2022-05-03T14:30:11+08:00">2022-05-03</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近工作比较忙，项目压力大，又是很长一段时间没有更新blog了。今天虽然是放五一长假，但是由于疫情仍然没有结束，所以没有出游的计划，正好可以写点东西总结一下最近项目中遇到的自定义View相关的内容，实现一个总量一定，支持和反对人数对比的指示条来反映某个问题下大多数人的看法，欢迎交流和讨论～</p>
<hr>
<p>最终效果图：<br><img src="/images/compare_indicator.png" alt="效果图"></p>
<h1 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h1><ul>
<li>声明支持和反对的绘制画笔，数量以及颜色，定义指示条的宽度，中间间隔的宽度，以及三角分割的宽度，圆角大小，指示条坐标对象<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> downPaint = Paint()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> upPaint = Paint()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> upCount = <span class="number">80</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> downCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> downColor = ContextCompat.getColor(context, R.color.secondary)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> upColor = ContextCompat.getColor(context, R.color.primary)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> lineWidth = Util.dp2px(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> attachWidth = Util.dp2px(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> spanWidth = Util.dp2px(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> roundSize = lineWidth - Util.dp2px(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> indicator <span class="keyword">by</span> lazy &#123; Indicator() &#125;</span><br></pre></td></tr></table></figure>
<h2 id="指示条坐标对象"><a href="#指示条坐标对象" class="headerlink" title="指示条坐标对象"></a>指示条坐标对象</h2></li>
<li>整个指示条包含8个坐标，支持段和反对段各4个坐标，所以封装为一个Indicator对象，把支持和反对的绘制路径封装成两个IndicatorPath对象，每个IndicatorPath包含4个坐标，每个坐标包含x，y的数值<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Indicator</span></span>(</span><br><span class="line">    <span class="keyword">var</span> upPath: IndicatorPath = IndicatorPath(),</span><br><span class="line">    <span class="keyword">var</span> downPath: IndicatorPath = IndicatorPath()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">IndicatorPath</span></span>(</span><br><span class="line">    <span class="keyword">var</span> startTop: Pos = Pos(),</span><br><span class="line">    <span class="keyword">var</span> startBottom: Pos = Pos(),</span><br><span class="line">    <span class="keyword">var</span> endTop: Pos = Pos(),</span><br><span class="line">    <span class="keyword">var</span> endBottom: Pos = Pos()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Pos</span></span>(<span class="keyword">var</span> x: <span class="built_in">Float</span> = <span class="number">0f</span>, <span class="keyword">var</span> y: <span class="built_in">Float</span> = <span class="number">0f</span>)</span><br></pre></td></tr></table></figure>
<h1 id="初始化逻辑"><a href="#初始化逻辑" class="headerlink" title="初始化逻辑"></a>初始化逻辑</h1></li>
<li>获取xml的配置进行变量初始化<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    setLayerType(View.LAYER_TYPE_SOFTWARE, <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">val</span> typedArray = context.obtainStyledAttributes(attrs, R.styleable.compareindicator)</span><br><span class="line">    downColor = typedArray.getColor(R.styleable.compareindicator_down_color, downColor)</span><br><span class="line">    upColor = typedArray.getColor(R.styleable.compareindicator_up_color, upColor)</span><br><span class="line">    lineWidth = typedArray.getDimension(</span><br><span class="line">        R.styleable.compareindicator_lineWidth,</span><br><span class="line">        lineWidth.toFloat()</span><br><span class="line">    ).toInt()</span><br><span class="line">    attachWidth = typedArray.getDimension(</span><br><span class="line">        R.styleable.compareindicator_attachWidth,</span><br><span class="line">        lineWidth.toFloat()</span><br><span class="line">    ).toInt()</span><br><span class="line">    spanWidth = typedArray.getDimension(</span><br><span class="line">        R.styleable.compareindicator_spanWidth,</span><br><span class="line">        lineWidth.toFloat()</span><br><span class="line">    ).toInt()</span><br><span class="line">    textSize = typedArray.getDimension(</span><br><span class="line">        R.styleable.dashboard_textSize,</span><br><span class="line">        textSize</span><br><span class="line">    )</span><br><span class="line">    typedArray.recycle()</span><br><span class="line">    upPaint = Paint()</span><br><span class="line">    upPaint.color = upColor</span><br><span class="line">    downPaint = Paint()</span><br><span class="line">    downPaint.color = downColor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="重写onDraw自定义绘制逻辑"><a href="#重写onDraw自定义绘制逻辑" class="headerlink" title="重写onDraw自定义绘制逻辑"></a>重写onDraw自定义绘制逻辑</h1></li>
<li>当支持和反对数量均不为0时，根据当前View宽度和支持数量百分比计算支持指示条的长度，根据当前View宽度和反对数量百分比计算反对指示条的长度，再计算支持和反对指示条的绘制路径。如果支持数不为0反对数为0则只绘制支持指示条，设置支持绘制画笔的圆角，直接绘制一根长度为View宽度的支持指示条，如果支持数为0反对数不为0则只绘制反对指示条，设置反对绘制画笔的圆角，直接绘制一根长度为View宽度的反对指示条。如果支持和反对数都为0，则支持和反对指示条长度各占View宽度的一半进行绘制<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">    <span class="keyword">val</span> upWidth: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">val</span> downWidth: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">if</span> (upCount != <span class="number">0</span> &amp;&amp; downCount != <span class="number">0</span>) &#123;</span><br><span class="line">        upWidth = width / (downCount + upCount) * upCount</span><br><span class="line">        downWidth = width / (downCount + upCount) * downCount</span><br><span class="line">        getPath(downWidth)</span><br><span class="line">        drawIndicator(canvas)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (upCount != <span class="number">0</span> &amp;&amp; downCount == <span class="number">0</span>) &#123;</span><br><span class="line">        upWidth = width</span><br><span class="line">        upPaint.strokeWidth = lineWidth.toFloat()</span><br><span class="line">        upPaint.strokeCap = Paint.Cap.ROUND</span><br><span class="line">        canvas?.drawLine(</span><br><span class="line">            (paddingStart + roundSize).toFloat(),</span><br><span class="line">            (paddingTop + roundSize).toFloat(),</span><br><span class="line">            (upWidth - paddingEnd - roundSize).toFloat(),</span><br><span class="line">            (paddingTop + roundSize).toFloat(),</span><br><span class="line">            upPaint</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (upCount == <span class="number">0</span> &amp;&amp; downCount != <span class="number">0</span>) &#123;</span><br><span class="line">        downWidth = width</span><br><span class="line">        downPaint.strokeWidth = lineWidth.toFloat()</span><br><span class="line">        downPaint.strokeCap = Paint.Cap.ROUND</span><br><span class="line">        canvas?.drawLine(</span><br><span class="line">            (paddingStart + roundSize).toFloat(),</span><br><span class="line">            (paddingTop + roundSize).toFloat(),</span><br><span class="line">            (downWidth - paddingEnd - roundSize).toFloat(),</span><br><span class="line">            (paddingTop + roundSize).toFloat(),</span><br><span class="line">            downPaint</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        upWidth = width / <span class="number">2</span></span><br><span class="line">        downWidth = width / <span class="number">2</span></span><br><span class="line">        getPath(downWidth)</span><br><span class="line">        drawIndicator(canvas)</span><br><span class="line">    &#125;</span><br><span class="line">    drawText(canvas)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="计算绘制路径"><a href="#计算绘制路径" class="headerlink" title="计算绘制路径"></a>计算绘制路径</h1></li>
<li>分别计算支持指示条和反对指示条的绘制路径，各自计算开始和结束的上下坐标，这里考虑到圆角，所以左边的反对指示条x开始坐标为View的paddingStart+圆角的大小，x结束坐标为View的paddingStart+圆角的大小+反对指示条的长度+三角形分割的宽度-间隔的宽度，y开始坐标为View的paddingTop，y结束坐标为View的paddingTop+指示条的宽度。右边的支持指示条x开始坐标为反对指示条的x坐标+间隔宽度，结束坐标为View的宽度-View的paddingEnd-圆角大小，y开始坐标为paddingTop，结束坐标为paddingTop+指示条的宽度<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPath</span><span class="params">(downWidth: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> paddingSpanStart = paddingStart + roundSize</span><br><span class="line">    <span class="comment">// 反对指示条</span></span><br><span class="line">    indicator.downPath.startTop.x = paddingSpanStart.toFloat()</span><br><span class="line">    indicator.downPath.startTop.y = paddingTop.toFloat()</span><br><span class="line">    indicator.downPath.startBottom.x = paddingSpanStart.toFloat()</span><br><span class="line">    indicator.downPath.startBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">    indicator.downPath.endTop.x =</span><br><span class="line">        (paddingSpanStart + downWidth + attachWidth - spanWidth).toFloat()</span><br><span class="line">    indicator.downPath.endTop.y = paddingTop.toFloat()</span><br><span class="line">    indicator.downPath.endBottom.x = (paddingSpanStart + downWidth - spanWidth).toFloat()</span><br><span class="line">    indicator.downPath.endBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">    <span class="keyword">val</span> paddingSpanEnd = paddingEnd + roundSize</span><br><span class="line">    <span class="comment">// 支持指示条</span></span><br><span class="line">    indicator.upPath.startTop.x = indicator.downPath.endTop.x + spanWidth</span><br><span class="line">    indicator.upPath.startTop.y = paddingTop.toFloat()</span><br><span class="line">    indicator.upPath.startBottom.x = indicator.downPath.endBottom.x + spanWidth</span><br><span class="line">    indicator.upPath.startBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">    indicator.upPath.endTop.x = (width - paddingSpanEnd).toFloat()</span><br><span class="line">    indicator.upPath.endTop.y = paddingTop.toFloat()</span><br><span class="line">    indicator.upPath.endBottom.x = (width - paddingSpanEnd).toFloat()</span><br><span class="line">    indicator.upPath.endBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="绘制指示条逻辑"><a href="#绘制指示条逻辑" class="headerlink" title="绘制指示条逻辑"></a>绘制指示条逻辑</h1></li>
<li>设置支持和反对的绘制画笔为填充模式，绘制反对指示条的路径，从开始的上坐标到结束的上坐标，从结束的下坐标到开始的下坐标都是绘制直线，开始的下坐标到开始的上坐标是绘制圆滑的曲线即贝塞尔曲线，控制点为x的位置是开始的下坐标x-圆角大小，y是开始的下坐标y-指示线的宽度/2，结束点为开始的上坐标。同理，绘制支持指示条的路径，从结束的上坐标到开始的上坐标，从开始的下坐标到结束的下坐标都是绘制直线，结束的下坐标到结束的上坐标同样是绘制贝塞尔曲线，控制点为x的位置是结束的下坐标x-圆角大小，y是结束的下坐标y-指示线的宽度/2，结束点为结束的上坐标。<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawIndicator</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    downPaint.strokeWidth = <span class="number">1F</span></span><br><span class="line">    upPaint.strokeWidth = <span class="number">1F</span></span><br><span class="line">    downPaint.strokeCap = Paint.Cap.BUTT</span><br><span class="line">    upPaint.strokeCap = Paint.Cap.BUTT</span><br><span class="line">    drawLine(canvas, indicator.downPath, downPaint, <span class="literal">true</span>)</span><br><span class="line">    drawLine(canvas, indicator.upPath, upPaint, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawLine</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    canvas: <span class="type">Canvas</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">    indicatorPath: <span class="type">IndicatorPath</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    paint: <span class="type">Paint</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    down: <span class="type">Boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> path = Path()</span><br><span class="line">    <span class="keyword">if</span> (down) &#123;</span><br><span class="line">        path.moveTo(indicatorPath.startTop.x, indicatorPath.startTop.y)</span><br><span class="line">        path.lineTo(indicatorPath.endTop.x, indicatorPath.endTop.y)</span><br><span class="line">        path.lineTo(indicatorPath.endBottom.x, indicatorPath.endBottom.y)</span><br><span class="line">        path.lineTo(indicatorPath.startBottom.x, indicatorPath.startBottom.y)</span><br><span class="line">        path.quadTo(</span><br><span class="line">            indicatorPath.startBottom.x - roundSize,</span><br><span class="line">            indicatorPath.startBottom.y - (lineWidth / <span class="number">2</span>),</span><br><span class="line">            indicatorPath.startTop.x,</span><br><span class="line">            indicatorPath.startTop.y</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path.moveTo(indicatorPath.endTop.x, indicatorPath.endTop.y)</span><br><span class="line">        path.lineTo(indicatorPath.startTop.x, indicatorPath.startTop.y)</span><br><span class="line">        path.lineTo(indicatorPath.startBottom.x, indicatorPath.startBottom.y)</span><br><span class="line">        path.lineTo(indicatorPath.endBottom.x, indicatorPath.endBottom.y)</span><br><span class="line">        path.quadTo(</span><br><span class="line">            indicatorPath.endBottom.x + roundSize,</span><br><span class="line">            indicatorPath.endBottom.y - (lineWidth / <span class="number">2</span>),</span><br><span class="line">            indicatorPath.endTop.x,</span><br><span class="line">            indicatorPath.endTop.y</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    path.close()</span><br><span class="line">    paint.strokeWidth = <span class="number">1f</span></span><br><span class="line">    paint.style = Paint.Style.FILL</span><br><span class="line">    path.fillType = Path.FillType.WINDING</span><br><span class="line">    canvas?.drawPath(path, paint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="绘制文本逻辑"><a href="#绘制文本逻辑" class="headerlink" title="绘制文本逻辑"></a>绘制文本逻辑</h1></li>
<li>左边是反对指示条在开始位置绘制Down的数量文本，x的坐标为反对指示条的开始x坐标，y坐标为反对指示条的开始下坐标y+间隔宽度+文字大小，右边是支持指示条在结束位置绘制Up的数量文本，x的坐标为支持指示条的结束下坐标的x-文本宽度，y坐标为支持指示条的结束下坐标y+间隔宽度+文字大小<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawText</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span>&#123;</span><br><span class="line">    <span class="keyword">val</span> downText = <span class="string">"Down: <span class="variable">$downCount</span>"</span></span><br><span class="line">    downPaint.textSize = textSize</span><br><span class="line">    canvas?.drawText(downText, indicator.downPath.startBottom.x, indicator.downPath.startBottom.y + spanWidth + textSize, downPaint)</span><br><span class="line">    <span class="keyword">val</span> upText = <span class="string">"Up: <span class="variable">$upCount</span>"</span></span><br><span class="line">    upPaint.textSize = textSize</span><br><span class="line">    canvas?.drawText(upText, indicator.upPath.endBottom.x - upPaint.measureText(upText), indicator.upPath.endBottom.y + spanWidth + textSize, upPaint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="设置支持和反对数量"><a href="#设置支持和反对数量" class="headerlink" title="设置支持和反对数量"></a>设置支持和反对数量</h1></li>
<li>根据设置的支持反对数量刷新视图<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">updateView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    up: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    down: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    downColor: <span class="type">Int</span> = ContextCompat.getColor(context, R.color.secondary)</span></span>,</span><br><span class="line">    upColor: <span class="built_in">Int</span> = ContextCompat.getColor(context, R.color.primary)</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">this</span>.upCount = up</span><br><span class="line">    <span class="keyword">this</span>.downCount = down</span><br><span class="line">    <span class="keyword">this</span>.downColor = downColor</span><br><span class="line">    downPaint.color = downColor</span><br><span class="line">    <span class="keyword">this</span>.upColor = upColor</span><br><span class="line">    upPaint.color = upColor</span><br><span class="line">    postInvalidate()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1></li>
<li>xml中声明<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.example.testapp.CompareIndicator</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/indicator_compare"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginStart</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"200dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginEnd</span>=<span class="string">"12dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:lineWidth</span>=<span class="string">"6dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:textSize</span>=<span class="string">"12sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>设置支持反对数量<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compareIndicator.updateView(<span class="number">80</span>,<span class="number">20</span>, ContextCompat.getColor(<span class="keyword">this</span>, R.color.secondary), ContextCompat.getColor(<span class="keyword">this</span>, R.color.primary))</span><br></pre></td></tr></table></figure>
最后附上完整代码：<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.testapp</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint</span><br><span class="line"><span class="keyword">import</span> android.graphics.Path</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> androidx.core.content.ContextCompat</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CompareIndicator</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">    context: Context,</span><br><span class="line">    attrs: AttributeSet? = <span class="literal">null</span>,</span><br><span class="line">    defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : View(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> downPaint = Paint()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> upPaint = Paint()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> upCount = <span class="number">80</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> downCount = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> downColor = ContextCompat.getColor(context, R.color.secondary)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> upColor = ContextCompat.getColor(context, R.color.primary)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> lineWidth = Util.dp2px(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> attachWidth = Util.dp2px(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> spanWidth = Util.dp2px(<span class="number">9</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> labelSize = <span class="number">40f</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> roundSize = lineWidth - Util.dp2px(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> indicator <span class="keyword">by</span> lazy &#123; Indicator() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        setLayerType(View.LAYER_TYPE_SOFTWARE, <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">val</span> typedArray = context.obtainStyledAttributes(attrs, R.styleable.compareindicator)</span><br><span class="line">        downColor = typedArray.getColor(R.styleable.compareindicator_down_color, downColor)</span><br><span class="line">        upColor = typedArray.getColor(R.styleable.compareindicator_up_color, upColor)</span><br><span class="line">        lineWidth = typedArray.getDimension(</span><br><span class="line">            R.styleable.compareindicator_lineWidth,</span><br><span class="line">            lineWidth.toFloat()</span><br><span class="line">        ).toInt()</span><br><span class="line">        attachWidth = typedArray.getDimension(</span><br><span class="line">            R.styleable.compareindicator_attachWidth,</span><br><span class="line">            lineWidth.toFloat()</span><br><span class="line">        ).toInt()</span><br><span class="line">        spanWidth = typedArray.getDimension(</span><br><span class="line">            R.styleable.compareindicator_spanWidth,</span><br><span class="line">            lineWidth.toFloat()</span><br><span class="line">        ).toInt()</span><br><span class="line">        labelSize = typedArray.getDimension(</span><br><span class="line">            R.styleable.dashboard_textSize,</span><br><span class="line">            labelSize</span><br><span class="line">        )</span><br><span class="line">        typedArray.recycle()</span><br><span class="line">        upPaint = Paint()</span><br><span class="line">        upPaint.color = upColor</span><br><span class="line">        downPaint = Paint()</span><br><span class="line">        downPaint.color = downColor</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        up: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        down: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        downColor: <span class="type">Int</span> = ContextCompat.getColor(context, R.color.secondary)</span></span>,</span><br><span class="line">        upColor: <span class="built_in">Int</span> = ContextCompat.getColor(context, R.color.primary)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">this</span>.upCount = up</span><br><span class="line">        <span class="keyword">this</span>.downCount = down</span><br><span class="line">        <span class="keyword">this</span>.downColor = downColor</span><br><span class="line">        downPaint.color = downColor</span><br><span class="line">        <span class="keyword">this</span>.upColor = upColor</span><br><span class="line">        upPaint.color = upColor</span><br><span class="line">        postInvalidate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        <span class="keyword">val</span> upWidth: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> downWidth: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">if</span> (upCount != <span class="number">0</span> &amp;&amp; downCount != <span class="number">0</span>) &#123;</span><br><span class="line">            upWidth = width / (downCount + upCount) * upCount</span><br><span class="line">            downWidth = width / (downCount + upCount) * downCount</span><br><span class="line">            getPath(downWidth)</span><br><span class="line">            drawIndicator(canvas)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (upCount != <span class="number">0</span> &amp;&amp; downCount == <span class="number">0</span>) &#123;</span><br><span class="line">            upWidth = width</span><br><span class="line">            upPaint.strokeWidth = lineWidth.toFloat()</span><br><span class="line">            upPaint.strokeCap = Paint.Cap.ROUND</span><br><span class="line">            canvas?.drawLine(</span><br><span class="line">                (paddingStart + roundSize).toFloat(),</span><br><span class="line">                (paddingTop + roundSize).toFloat(),</span><br><span class="line">                (upWidth - paddingEnd - roundSize).toFloat(),</span><br><span class="line">                (paddingTop + roundSize).toFloat(),</span><br><span class="line">                upPaint</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (upCount == <span class="number">0</span> &amp;&amp; downCount != <span class="number">0</span>) &#123;</span><br><span class="line">            downWidth = width</span><br><span class="line">            downPaint.strokeWidth = lineWidth.toFloat()</span><br><span class="line">            downPaint.strokeCap = Paint.Cap.ROUND</span><br><span class="line">            canvas?.drawLine(</span><br><span class="line">                (paddingStart + roundSize).toFloat(),</span><br><span class="line">                (paddingTop + roundSize).toFloat(),</span><br><span class="line">                (downWidth - paddingEnd - roundSize).toFloat(),</span><br><span class="line">                (paddingTop + roundSize).toFloat(),</span><br><span class="line">                downPaint</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            upWidth = width / <span class="number">2</span></span><br><span class="line">            downWidth = width / <span class="number">2</span></span><br><span class="line">            getPath(downWidth)</span><br><span class="line">            drawIndicator(canvas)</span><br><span class="line">        &#125;</span><br><span class="line">        drawText(canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawText</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span>&#123;</span><br><span class="line">        <span class="keyword">val</span> downText = <span class="string">"Down: <span class="variable">$downCount</span>"</span></span><br><span class="line">        downPaint.textSize = labelSize</span><br><span class="line">        canvas?.drawText(downText, indicator.downPath.startBottom.x, indicator.downPath.startBottom.y + spanWidth + labelSize, downPaint)</span><br><span class="line">        <span class="keyword">val</span> upText = <span class="string">"Up: <span class="variable">$upCount</span>"</span></span><br><span class="line">        upPaint.textSize = labelSize</span><br><span class="line">        canvas?.drawText(upText, indicator.upPath.endBottom.x - upPaint.measureText(upText), indicator.upPath.endBottom.y + spanWidth + labelSize, upPaint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawIndicator</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        downPaint.strokeWidth = <span class="number">1F</span></span><br><span class="line">        upPaint.strokeWidth = <span class="number">1F</span></span><br><span class="line">        downPaint.strokeCap = Paint.Cap.BUTT</span><br><span class="line">        upPaint.strokeCap = Paint.Cap.BUTT</span><br><span class="line">        drawLine(canvas, indicator.downPath, downPaint, <span class="literal">true</span>)</span><br><span class="line">        drawLine(canvas, indicator.upPath, upPaint, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawLine</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        canvas: <span class="type">Canvas</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">        indicatorPath: <span class="type">IndicatorPath</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        paint: <span class="type">Paint</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        down: <span class="type">Boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> path = Path()</span><br><span class="line">        <span class="keyword">if</span> (down) &#123;</span><br><span class="line">            path.moveTo(indicatorPath.startTop.x, indicatorPath.startTop.y)</span><br><span class="line">            path.lineTo(indicatorPath.endTop.x, indicatorPath.endTop.y)</span><br><span class="line">            path.lineTo(indicatorPath.endBottom.x, indicatorPath.endBottom.y)</span><br><span class="line">            path.lineTo(indicatorPath.startBottom.x, indicatorPath.startBottom.y)</span><br><span class="line">            path.quadTo(</span><br><span class="line">                indicatorPath.startBottom.x - roundSize,</span><br><span class="line">                indicatorPath.startBottom.y - (lineWidth / <span class="number">2</span>),</span><br><span class="line">                indicatorPath.startTop.x,</span><br><span class="line">                indicatorPath.startTop.y</span><br><span class="line">            )</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            path.moveTo(indicatorPath.endTop.x, indicatorPath.endTop.y)</span><br><span class="line">            path.lineTo(indicatorPath.startTop.x, indicatorPath.startTop.y)</span><br><span class="line">            path.lineTo(indicatorPath.startBottom.x, indicatorPath.startBottom.y)</span><br><span class="line">            path.lineTo(indicatorPath.endBottom.x, indicatorPath.endBottom.y)</span><br><span class="line">            path.quadTo(</span><br><span class="line">                indicatorPath.endBottom.x + roundSize,</span><br><span class="line">                indicatorPath.endBottom.y - (lineWidth / <span class="number">2</span>),</span><br><span class="line">                indicatorPath.endTop.x,</span><br><span class="line">                indicatorPath.endTop.y</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        path.close()</span><br><span class="line">        paint.strokeWidth = <span class="number">1f</span></span><br><span class="line">        paint.style = Paint.Style.FILL</span><br><span class="line">        path.fillType = Path.FillType.WINDING</span><br><span class="line">        canvas?.drawPath(path, paint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPath</span><span class="params">(downWidth: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> paddingSpanStart = paddingStart + roundSize</span><br><span class="line">        <span class="comment">// 支持指示条</span></span><br><span class="line">        indicator.downPath.startTop.x = paddingSpanStart.toFloat()</span><br><span class="line">        indicator.downPath.startTop.y = paddingTop.toFloat()</span><br><span class="line">        indicator.downPath.startBottom.x = paddingSpanStart.toFloat()</span><br><span class="line">        indicator.downPath.startBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">        indicator.downPath.endTop.x =</span><br><span class="line">            (paddingSpanStart + downWidth + attachWidth - spanWidth).toFloat()</span><br><span class="line">        indicator.downPath.endTop.y = paddingTop.toFloat()</span><br><span class="line">        indicator.downPath.endBottom.x = (paddingSpanStart + downWidth - spanWidth).toFloat()</span><br><span class="line">        indicator.downPath.endBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">        <span class="keyword">val</span> paddingSpanEnd = paddingEnd + roundSize</span><br><span class="line">        <span class="comment">// 反对指示条</span></span><br><span class="line">        indicator.upPath.startTop.x = indicator.downPath.endTop.x + spanWidth</span><br><span class="line">        indicator.upPath.startTop.y = paddingTop.toFloat()</span><br><span class="line">        indicator.upPath.startBottom.x = indicator.downPath.endBottom.x + spanWidth</span><br><span class="line">        indicator.upPath.startBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">        indicator.upPath.endTop.x = (width - paddingSpanEnd).toFloat()</span><br><span class="line">        indicator.upPath.endTop.y = paddingTop.toFloat()</span><br><span class="line">        indicator.upPath.endBottom.x = (width - paddingSpanEnd).toFloat()</span><br><span class="line">        indicator.upPath.endBottom.y = (paddingTop + lineWidth).toFloat()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Indicator</span></span>(</span><br><span class="line">        <span class="keyword">var</span> upPath: IndicatorPath = IndicatorPath(),</span><br><span class="line">        <span class="keyword">var</span> downPath: IndicatorPath = IndicatorPath()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">IndicatorPath</span></span>(</span><br><span class="line">        <span class="keyword">var</span> startTop: Pos = Pos(),</span><br><span class="line">        <span class="keyword">var</span> startBottom: Pos = Pos(),</span><br><span class="line">        <span class="keyword">var</span> endTop: Pos = Pos(),</span><br><span class="line">        <span class="keyword">var</span> endBottom: Pos = Pos()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Pos</span></span>(<span class="keyword">var</span> x: <span class="built_in">Float</span> = <span class="number">0f</span>, <span class="keyword">var</span> y: <span class="built_in">Float</span> = <span class="number">0f</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/01/12/CropTransformation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2022/01/12/CropTransformation/" class="post-title-link" itemprop="url">Glide自定义CropTransformation</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2022-01-12 21:06:24" itemprop="dateCreated datePublished" datetime="2022-01-12T21:06:24+08:00">2022-01-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-13 00:03:18" itemprop="dateModified" datetime="2022-01-13T00:03:18+08:00">2022-01-13</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>裁剪是Android开发中一个常见的需求，虽然Android的ImageView的scaleType属性提供了多种图片的展示方式，其中包括一些裁剪方式，以及Glide自带的Transformation也提供了常见的圆角，圆形，居中裁剪，但有的时候仍然不能满足我们的需求，比如说为了版本迭代老版本apk能兼容新版本的图片资源，UI迭代的情况下产品会提出裁剪图片保留图片底部区域的规则，这时候ImageView和Glide自带的裁剪就不能满足需求了，需要我们自定义Transformation实现新的裁剪规则</p>
<hr>
<h1 id="裁剪类型"><a href="#裁剪类型" class="headerlink" title="裁剪类型"></a>裁剪类型</h1><p>定义枚举：顶部裁剪，居中裁剪，底部裁剪</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">CropType</span> </span>&#123;</span><br><span class="line">     TOP, CENTER, BOTTOM</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实线BitmapTransformation接口"><a href="#实线BitmapTransformation接口" class="headerlink" title="实线BitmapTransformation接口"></a>实线BitmapTransformation接口</h1><p>默认居中裁剪，支持传入自定义的裁剪像素宽高，重写必要的方法，updateDiskCacheKey，transform，equals，hashCode</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> TAG: String = CropTransformation::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">name</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CropTransformation</span></span>(<span class="keyword">var</span> width: <span class="built_in">Int</span> = <span class="number">0</span>, <span class="keyword">var</span> height: <span class="built_in">Int</span> = <span class="number">0</span>, <span class="keyword">var</span> cropType: CropType = CropType.CENTER) : BitmapTransformation() &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDiskCacheKey</span><span class="params">(messageDigest: <span class="type">MessageDigest</span>)</span></span> &#123;</span><br><span class="line">        messageDigest.update(TAG.toByteArray(CHARSET))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">transform</span><span class="params">(pool: <span class="type">BitmapPool</span>, toTransform: <span class="type">Bitmap</span>, outWidth: <span class="type">Int</span>, outHeight: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> other <span class="keyword">is</span> CropTransformation &amp;&amp; other.width == width &amp;&amp; other.height == height &amp;&amp; other.cropType == cropType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hashCode</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TAG.hashCode()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现核心方法transform"><a href="#实现核心方法transform" class="headerlink" title="实现核心方法transform"></a>实现核心方法transform</h1><ul>
<li><p>transform的入参为，图片复用线程池pool，下载后要处理的图片toTransform，目标View的宽高</p>
</li>
<li><p>当宽或高为0时默认使用图片的宽或高</p>
</li>
<li><p>图片格式默认采用要处理图片的格式，否则使用ARGB_8888</p>
</li>
<li><p>从当前图片缓存池中取得一张复用的图片进行处理，打开alpha通道</p>
</li>
<li><p>计算裁剪的宽和图片的宽之比，以及高之比，取大的那个</p>
</li>
<li><p>计算缩放后的宽和高</p>
</li>
<li><p>计算绘制的开始位置，x和y坐标，x坐标为（当前裁剪的宽度 - 缩放后的宽度）/ 2，从水平居中区域开始绘制，y坐标根据当前的裁剪类型而定，TOP从0开始，CENTER为（当前裁剪的高度 - 缩放后的高度）/ 2，从垂直居中区域开始，BOTTOM直接裁剪底部区域，结束位置的x坐标为开始位置的x坐标 + 缩放后的宽度，y坐标为开始位置的y坐标 + 缩放后的高度，最后计算出绘制的矩形区域，设置从当前图片缓存池中取得的图片密度为要处理的图片toTransform的密度，利用复用的图片创建canvas，drawBitmap把要处理的图片toTransform绘制到canvas的目标矩形区域</p>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">transform</span><span class="params">(pool: <span class="type">BitmapPool</span>, toTransform: <span class="type">Bitmap</span>, outWidth: <span class="type">Int</span>, outHeight: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        width = <span class="keyword">if</span> (width == <span class="number">0</span>) toTransform.width <span class="keyword">else</span> width</span><br><span class="line">        height = <span class="keyword">if</span> (height == <span class="number">0</span>) toTransform.height <span class="keyword">else</span> height</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> config = <span class="keyword">if</span> (toTransform.config != <span class="literal">null</span>) toTransform.config <span class="keyword">else</span> Bitmap.Config.ARGB_8888</span><br><span class="line">        <span class="keyword">val</span> bitmap = pool[width, height, config]</span><br><span class="line"></span><br><span class="line">        bitmap.setHasAlpha(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> scaleX = width.toFloat() / toTransform.width</span><br><span class="line">        <span class="keyword">val</span> scaleY = height.toFloat() / toTransform.height</span><br><span class="line">        <span class="keyword">val</span> scale = max(scaleX, scaleY)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> scaledWidth = scale * toTransform.width</span><br><span class="line">        <span class="keyword">val</span> scaledHeight = scale * toTransform.height</span><br><span class="line">        <span class="keyword">val</span> left = (width - scaledWidth) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> top: <span class="built_in">Float</span> = getTop(scaledHeight)</span><br><span class="line">        <span class="keyword">val</span> targetRect = RectF(left, top, left + scaledWidth, top + scaledHeight)</span><br><span class="line"></span><br><span class="line">        bitmap.density = toTransform.density</span><br><span class="line">        <span class="keyword">val</span> canvas = Canvas(bitmap)</span><br><span class="line">        canvas.drawBitmap(toTransform, <span class="literal">null</span>, targetRect, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmap</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTop</span><span class="params">(scaledHeight: <span class="type">Float</span>)</span></span>: <span class="built_in">Float</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">when</span> (cropType) &#123;</span><br><span class="line">    CropType.TOP -&gt; <span class="number">0f</span></span><br><span class="line">    CropType.CENTER -&gt; (height - scaledHeight) / <span class="number">2</span></span><br><span class="line">    CropType.BOTTOM -&gt; height - scaledHeight</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kubi.kucoin.utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas</span><br><span class="line"><span class="keyword">import</span> android.graphics.RectF</span><br><span class="line"><span class="keyword">import</span> com.bumptech.glide.load.engine.bitmap_recycle.BitmapPool</span><br><span class="line"><span class="keyword">import</span> com.bumptech.glide.load.resource.bitmap.BitmapTransformation</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest</span><br><span class="line"><span class="keyword">import</span> kotlin.math.max</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 图片裁剪</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Jessie.Li</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span>: jessie.li<span class="doctag">@corp</span>.kucoin.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-01-05 17:47</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> TAG: String = CropTransformation::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">name</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CropTransformation</span></span>(<span class="keyword">var</span> width: <span class="built_in">Int</span> = <span class="number">0</span>, <span class="keyword">var</span> height: <span class="built_in">Int</span> = <span class="number">0</span>, <span class="keyword">var</span> cropType: CropType = CropType.CENTER) : BitmapTransformation() &#123;</span><br><span class="line">    <span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">CropType</span> </span>&#123;</span><br><span class="line">        TOP, CENTER, BOTTOM</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDiskCacheKey</span><span class="params">(messageDigest: <span class="type">MessageDigest</span>)</span></span> &#123;</span><br><span class="line">        messageDigest.update(TAG.toByteArray(CHARSET))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">transform</span><span class="params">(pool: <span class="type">BitmapPool</span>, toTransform: <span class="type">Bitmap</span>, outWidth: <span class="type">Int</span>, outHeight: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        width = <span class="keyword">if</span> (width == <span class="number">0</span>) toTransform.width <span class="keyword">else</span> width</span><br><span class="line">        height = <span class="keyword">if</span> (height == <span class="number">0</span>) toTransform.height <span class="keyword">else</span> height</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> config = <span class="keyword">if</span> (toTransform.config != <span class="literal">null</span>) toTransform.config <span class="keyword">else</span> Bitmap.Config.ARGB_8888</span><br><span class="line">        <span class="keyword">val</span> bitmap = pool[width, height, config]</span><br><span class="line"></span><br><span class="line">        bitmap.setHasAlpha(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> scaleX = width.toFloat() / toTransform.width</span><br><span class="line">        <span class="keyword">val</span> scaleY = height.toFloat() / toTransform.height</span><br><span class="line">        <span class="keyword">val</span> scale = max(scaleX, scaleY)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> scaledWidth = scale * toTransform.width</span><br><span class="line">        <span class="keyword">val</span> scaledHeight = scale * toTransform.height</span><br><span class="line">        <span class="keyword">val</span> left = (width - scaledWidth) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> top: <span class="built_in">Float</span> = getTop(scaledHeight)</span><br><span class="line">        <span class="keyword">val</span> targetRect = RectF(left, top, left + scaledWidth, top + scaledHeight)</span><br><span class="line"></span><br><span class="line">        bitmap.density = toTransform.density</span><br><span class="line">        <span class="keyword">val</span> canvas = Canvas(bitmap)</span><br><span class="line">        canvas.drawBitmap(toTransform, <span class="literal">null</span>, targetRect, <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmap</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTop</span><span class="params">(scaledHeight: <span class="type">Float</span>)</span></span>: <span class="built_in">Float</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> (cropType) &#123;</span><br><span class="line">            CropType.TOP -&gt; <span class="number">0f</span></span><br><span class="line">            CropType.CENTER -&gt; (height - scaledHeight) / <span class="number">2</span></span><br><span class="line">            CropType.BOTTOM -&gt; height - scaledHeight</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> other <span class="keyword">is</span> CropTransformation &amp;&amp; other.width == width &amp;&amp; other.height == height &amp;&amp; other.cropType == cropType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hashCode</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> TAG.hashCode()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/27/RingPullAnimation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2021/10/27/RingPullAnimation/" class="post-title-link" itemprop="url">拉环下拉弹动动画效果</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2021-10-27 21:47:50" itemprop="dateCreated datePublished" datetime="2021-10-27T21:47:50+08:00">2021-10-27</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-11-14 18:32:28" itemprop="dateModified" datetime="2021-11-14T18:32:28+08:00">2021-11-14</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>最近工作忙项目比较急，很少有时间更新blog了，不过好习惯还是应该保持，时间挤挤还是有的。项目中遇到一个需求，实现一个拉环动画，有一根拉伸可以往下拉动并在放手的时候回弹然后上下抖动，就跟我们生活中拖拽一根带了拉环的橡皮筋效果是一样的。最终我是用属性动画去实现这个需求，感觉不算复杂效果也还行，在此记录实现过程，欢迎相互交流～</p>
<hr>
<p>最终效果图gif:<br><img src="/images/RingPullAnimation.gif" alt="image"></p>
<h1 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h1><h2 id="实现AnimatorUpdateListener和Animator-AnimatorListener接口"><a href="#实现AnimatorUpdateListener和Animator-AnimatorListener接口" class="headerlink" title="实现AnimatorUpdateListener和Animator.AnimatorListener接口"></a>实现AnimatorUpdateListener和Animator.AnimatorListener接口</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RingView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">    context: Context, attrs: AttributeSet? = <span class="literal">null</span>, defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : View(context, attrs, defStyleAttr), AnimatorUpdateListener, Animator.AnimatorListener&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationUpdate</span><span class="params">(animation: <span class="type">ValueAnimator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationRepeat</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationCancel</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationStart</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationEnd</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>初始化paint，animator，设置1秒后开始动画</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">  paint.color = resources.getColor(R.color.colorPrimary)</span><br><span class="line">  paint.isAntiAlias = <span class="literal">true</span></span><br><span class="line">  postDelayed(&#123; startAnimation() &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initAnimator</span><span class="params">(start: <span class="type">Int</span>, end: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">      animator = ValueAnimator.ofInt(start, end)</span><br><span class="line">      animator?.duration = <span class="number">1000</span></span><br><span class="line">      animator?.interpolator = accelerateInterpolator</span><br><span class="line">      animator?.addUpdateListener(<span class="keyword">this</span>)</span><br><span class="line">      animator?.addListener(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">startAnimation</span><span class="params">()</span></span> &#123;</span><br><span class="line">      initAnimator(startY, endY)</span><br><span class="line">      isDown = <span class="literal">true</span></span><br><span class="line">      animator?.start()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="绘制"><a href="#绘制" class="headerlink" title="绘制"></a>绘制</h2><h3 id="绘制拉环"><a href="#绘制拉环" class="headerlink" title="绘制拉环"></a>绘制拉环</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> bgRing = BitmapFactory.decodeResource(resources, R.mipmap.bg_ring)</span><br><span class="line"><span class="comment">// 拉环绘制尺寸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> targetWidth = (bgRing.width * <span class="number">1.4</span>).toInt()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> targetHeight = (bgRing.height * <span class="number">1.4</span>).toInt()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> radius = targetWidth / <span class="number">2</span></span><br><span class="line"> <span class="comment">// 拉环坐标</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> xPos = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> yPos = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> srcRingRect = Rect(<span class="number">0</span>, <span class="number">0</span>, bgRing.width, bgRing.height)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> dstRingRect = Rect()</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawRing</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    dstRingRect.left = xPos</span><br><span class="line">    dstRingRect.top = yPos</span><br><span class="line">    dstRingRect.right = xPos + targetWidth</span><br><span class="line">    dstRingRect.bottom = yPos + targetHeight</span><br><span class="line">    canvas.drawBitmap(bgRing, srcRingRect, dstRingRect, paint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="绘制弹力绳"><a href="#绘制弹力绳" class="headerlink" title="绘制弹力绳"></a>绘制弹力绳</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> strokeWidth = <span class="number">6f</span>  <span class="comment">// 绳子粗细</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> ratio = <span class="number">0f</span> <span class="comment">// 弹性变化比例</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawLine</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">       paint.strokeWidth = strokeWidth - <span class="number">3</span> * ratio</span><br><span class="line">       canvas.drawLine((xPos + radius).toFloat(), <span class="number">0f</span>, (xPos + radius).toFloat(), (yPos + <span class="number">2</span>).toFloat(), paint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重写onDraw"><a href="#重写onDraw" class="headerlink" title="重写onDraw"></a>重写onDraw</h3><p>初始化上下轻微抖动的范围和最大拖拽长度</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上下轻微抖动的范围</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> startY = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> endY = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> maxDragY = <span class="number">0</span> <span class="comment">// 最大拖拽长度</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">       <span class="keyword">if</span> (animator == <span class="literal">null</span>) &#123;</span><br><span class="line">           startY = canvas.height / <span class="number">2</span> - radius / <span class="number">2</span></span><br><span class="line">           endY = canvas.height / <span class="number">2</span></span><br><span class="line">           yPos = startY</span><br><span class="line">           maxDragY = endY + endY / <span class="number">2</span></span><br><span class="line">           xPos = canvas.width / <span class="number">2</span> - radius</span><br><span class="line">       &#125;</span><br><span class="line">       drawLine(canvas)</span><br><span class="line">       drawRing(canvas)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="下拉后自动回弹"><a href="#下拉后自动回弹" class="headerlink" title="下拉后自动回弹"></a>下拉后自动回弹</h2><p>利用加速插值器和减速插值器实现惯性向下运动，减速向上回弹，监听动画结束事件，更新运动方向标志位，下落时设置为加速插值器，回弹时设置为减速插值器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private var isDown = true</span><br><span class="line">private var stopAnimate = false // 是否停止动画</span><br><span class="line">private val accelerateInterpolator = AccelerateInterpolator()</span><br><span class="line">private val decelerateInterpolator = DecelerateInterpolator()</span><br><span class="line">override fun onAnimationEnd(animation: Animator) &#123;</span><br><span class="line">     if (!stopAnimate) &#123;</span><br><span class="line">         val vAnimation = animation as ValueAnimator</span><br><span class="line">         isDown = !isDown</span><br><span class="line">         if (isDown) &#123;</span><br><span class="line">             vAnimation.setIntValues(startY, endY)</span><br><span class="line">             vAnimation.interpolator = accelerateInterpolator</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             vAnimation.setIntValues(endY, startY)</span><br><span class="line">             vAnimation.interpolator = decelerateInterpolator</span><br><span class="line">         &#125;</span><br><span class="line">         vAnimation.start()</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="拖拽逻辑"><a href="#拖拽逻辑" class="headerlink" title="拖拽逻辑"></a>拖拽逻辑</h2><p>重写onTouchEvent，监听ACTION_DOWN/ACTION_UP/ACTION_MOVE事件<br>手指落下时：判断当前触摸位置坐标是否在拉环矩形区域内，如果是则记录开始拖拽位置的Y坐标，停止当前动画，记录上一次手指移动的Y坐标<br>手指移动时：记录手指当前Y坐标，如果是拖拽状态且拖拽距离大于10，计算当前拖拽的插值，如果插值大于0则为向下拖拽，继续判断当前Y坐标是否小于最大拖拽Y坐标位置，如果是计算拉环当前运动的目标位置，计算当前拖拽位置到最大拖拽位置的百分比，修正拉环的Y坐标，实现拖拽时移动缓慢的阻尼效果，达到最大拖拽位置时百分比为1，更新拖拽状态为false，刷新视图，更新最后一次拖拽的Y坐标<br>手指抬起时：更新拖拽状态为false，更新最后一次拖拽的Y坐标为0，触发回弹动画，设置为减速插值器，刷新动画标志位，向下标志位为false</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (event.action) &#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                isDrag = dstRingRect.plus(padding).contains(event.x.toInt(), event.y.toInt())</span><br><span class="line">                <span class="keyword">if</span> (isDrag) &#123;</span><br><span class="line">                    lastDragY = event.y</span><br><span class="line">                    <span class="keyword">if</span> (animator != <span class="literal">null</span> &amp;&amp; animator!!.isRunning) &#123;</span><br><span class="line">                        stopAnimate = <span class="literal">true</span></span><br><span class="line">                        animator?.cancel()</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastMoveY = (yPos + radius).toFloat()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                <span class="comment">// 弹回去</span></span><br><span class="line">                back()</span><br><span class="line">                lastMoveY = <span class="number">0f</span></span><br><span class="line">                isDrag = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                curDragY = event.y</span><br><span class="line">                <span class="keyword">if</span> (isDrag &amp;&amp; curDragY - lastDragY &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">val</span> diffY = curDragY - lastMoveY</span><br><span class="line">                    Log.i(TAG, <span class="string">"diffY: <span class="variable">$diffY</span>"</span> )</span><br><span class="line">                    <span class="keyword">if</span> (diffY &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span> (curDragY &lt; maxDragY)&#123;</span><br><span class="line">                            <span class="keyword">val</span> targetY =  curDragY.toInt()</span><br><span class="line">                            Log.i(TAG, <span class="string">"maxLength: <span class="subst">$&#123;maxDragY - lastDragY&#125;</span>"</span> )</span><br><span class="line">                            ratio = (targetY - lastDragY) / (maxDragY - lastDragY)</span><br><span class="line">                            yPos = (yPos + diffY * (<span class="number">1</span> - ratio)).toInt()</span><br><span class="line">                            Log.i(TAG, <span class="string">"add: <span class="subst">$&#123;diffY * (<span class="number">1</span> - ratio)&#125;</span>, diffY:<span class="subst">$&#123;diffY&#125;</span>  ratio:<span class="subst">$&#123;(<span class="number">1</span> - ratio)&#125;</span>"</span> )</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ratio = <span class="number">1f</span></span><br><span class="line">                            isDrag = <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        invalidate()</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastMoveY = curDragY</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">back</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animator != <span class="literal">null</span> &amp;&amp; !animator!!.isRunning) &#123;</span><br><span class="line">            animator?.setIntValues(yPos, startY)</span><br><span class="line">            animator?.interpolator = decelerateInterpolator</span><br><span class="line">            stopAnimate = <span class="literal">false</span></span><br><span class="line">            animator?.start()</span><br><span class="line">            isDown = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RingView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">    context: Context, attrs: AttributeSet? = <span class="literal">null</span>, defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : View(context, attrs, defStyleAttr), AnimatorUpdateListener, Animator.AnimatorListener &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bgRing = BitmapFactory.decodeResource(resources, R.mipmap.bg_ring)</span><br><span class="line">    <span class="comment">// 拉环绘制尺寸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> targetWidth = (bgRing.width * <span class="number">1.4</span>).toInt()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> targetHeight = (bgRing.height * <span class="number">1.4</span>).toInt()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> radius = targetWidth / <span class="number">2</span></span><br><span class="line">    <span class="comment">// 拉环坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> xPos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> yPos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> strokeWidth = <span class="number">6f</span>  <span class="comment">// 绳子粗细</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> animator: ValueAnimator? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isDown = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上下轻微抖动的范围</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> startY = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> endY = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> maxDragY = <span class="number">0</span><span class="comment">// 最大拖拽长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> accelerateInterpolator = AccelerateInterpolator()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> decelerateInterpolator = DecelerateInterpolator()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> srcRingRect = Rect(<span class="number">0</span>, <span class="number">0</span>, bgRing.width, bgRing.height)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dstRingRect = Rect()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isDrag = <span class="literal">false</span><span class="comment">// 是否拖拽</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> curDragY = <span class="number">0f</span> <span class="comment">// 当前拖拽Y坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> lastDragY = <span class="number">0f</span> <span class="comment">// 开始拖拽Y坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> stopAnimate = <span class="literal">false</span> <span class="comment">// 是否停止动画</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> lastMoveY = <span class="number">0f</span> <span class="comment">// 上一次手指移动Y坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> ratio = <span class="number">0f</span> <span class="comment">// 弹性变化比例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> padding = <span class="number">20</span> <span class="comment">// 触摸范围增量</span></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        paint.color = resources.getColor(R.color.colorPrimary)</span><br><span class="line">        paint.isAntiAlias = <span class="literal">true</span></span><br><span class="line">        postDelayed(&#123; startAnimation() &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        <span class="keyword">if</span> (animator == <span class="literal">null</span>) &#123;</span><br><span class="line">            startY = canvas.height / <span class="number">2</span> - radius / <span class="number">2</span></span><br><span class="line">            endY = canvas.height / <span class="number">2</span></span><br><span class="line">            yPos = startY</span><br><span class="line">            maxDragY = endY + endY / <span class="number">2</span></span><br><span class="line">            xPos = canvas.width / <span class="number">2</span> - radius</span><br><span class="line">        &#125;</span><br><span class="line">        drawLine(canvas)</span><br><span class="line">        drawRing(canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawRing</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        dstRingRect.left = xPos</span><br><span class="line">        dstRingRect.top = yPos</span><br><span class="line">        dstRingRect.right = xPos + targetWidth</span><br><span class="line">        dstRingRect.bottom = yPos + targetHeight</span><br><span class="line">        canvas.drawBitmap(bgRing, srcRingRect, dstRingRect, paint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationUpdate</span><span class="params">(animation: <span class="type">ValueAnimator</span>)</span></span> &#123;</span><br><span class="line">        yPos = animation.animatedValue <span class="keyword">as</span> <span class="built_in">Int</span></span><br><span class="line">        ratio = (yPos - startY).toFloat() / (maxDragY - startY)</span><br><span class="line">        invalidate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawLine</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        paint.strokeWidth = strokeWidth - <span class="number">3</span> * ratio</span><br><span class="line">        canvas.drawLine((xPos + radius).toFloat(), <span class="number">0f</span>, (xPos + radius).toFloat(), (yPos + <span class="number">2</span>).toFloat(), paint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initAnimator</span><span class="params">(start: <span class="type">Int</span>, end: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        animator = ValueAnimator.ofInt(start, end)</span><br><span class="line">        animator?.duration = <span class="number">1000</span></span><br><span class="line">        animator?.interpolator = accelerateInterpolator</span><br><span class="line">        animator?.addUpdateListener(<span class="keyword">this</span>)</span><br><span class="line">        animator?.addListener(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">startAnimation</span><span class="params">()</span></span> &#123;</span><br><span class="line">        initAnimator(startY, endY)</span><br><span class="line">        isDown = <span class="literal">true</span></span><br><span class="line">        animator?.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationRepeat</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationStart</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationEnd</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!stopAnimate) &#123;</span><br><span class="line">            <span class="keyword">val</span> vAnimation = animation <span class="keyword">as</span> ValueAnimator</span><br><span class="line">            isDown = !isDown</span><br><span class="line">            <span class="keyword">if</span> (isDown) &#123;</span><br><span class="line">                vAnimation.setIntValues(startY, endY)</span><br><span class="line">                vAnimation.interpolator = accelerateInterpolator</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                vAnimation.setIntValues(endY, startY)</span><br><span class="line">                vAnimation.interpolator = decelerateInterpolator</span><br><span class="line">            &#125;</span><br><span class="line">            vAnimation.start()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAnimationCancel</span><span class="params">(animation: <span class="type">Animator</span>)</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (event.action) &#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                isDrag = dstRingRect.plus(padding).contains(event.x.toInt(), event.y.toInt())</span><br><span class="line">                <span class="keyword">if</span> (isDrag) &#123;</span><br><span class="line">                    lastDragY = event.y</span><br><span class="line">                    <span class="keyword">if</span> (animator != <span class="literal">null</span> &amp;&amp; animator!!.isRunning) &#123;</span><br><span class="line">                        stopAnimate = <span class="literal">true</span></span><br><span class="line">                        animator?.cancel()</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastMoveY = (yPos + radius).toFloat()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                <span class="comment">// 弹回去</span></span><br><span class="line">                back()</span><br><span class="line">                lastMoveY = <span class="number">0f</span></span><br><span class="line">                isDrag = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                curDragY = event.y</span><br><span class="line">                <span class="keyword">if</span> (isDrag &amp;&amp; curDragY - lastDragY &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">val</span> diffY = curDragY - lastMoveY</span><br><span class="line">                    Log.i(TAG, <span class="string">"diffY: <span class="variable">$diffY</span>"</span> )</span><br><span class="line">                    <span class="keyword">if</span> (diffY &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span> (curDragY &lt; maxDragY)&#123;</span><br><span class="line">                            <span class="keyword">val</span> targetY =  curDragY.toInt()</span><br><span class="line">                            Log.i(TAG, <span class="string">"maxLength: <span class="subst">$&#123;maxDragY - lastDragY&#125;</span>"</span> )</span><br><span class="line">                            ratio = (targetY - lastDragY) / (maxDragY - lastDragY)</span><br><span class="line">                            yPos = (yPos + diffY * (<span class="number">1</span> - ratio)).toInt()</span><br><span class="line">                            Log.i(TAG, <span class="string">"add: <span class="subst">$&#123;diffY * (<span class="number">1</span> - ratio)&#125;</span>, diffY:<span class="subst">$&#123;diffY&#125;</span>  ratio:<span class="subst">$&#123;(<span class="number">1</span> - ratio)&#125;</span>"</span> )</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ratio = <span class="number">1f</span></span><br><span class="line">                            isDrag = <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        invalidate()</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastMoveY = curDragY</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">back</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animator != <span class="literal">null</span> &amp;&amp; !animator!!.isRunning) &#123;</span><br><span class="line">            animator?.setIntValues(yPos, startY)</span><br><span class="line">            animator?.interpolator = decelerateInterpolator</span><br><span class="line">            stopAnimate = <span class="literal">false</span></span><br><span class="line">            animator?.start()</span><br><span class="line">            isDown = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="xml中引入"><a href="#xml中引入" class="headerlink" title="xml中引入"></a>xml中引入</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.example.testapp.RingView</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       /&gt;</span></span><br></pre></td></tr></table></figure>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/16/Raspberry-VPN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2021/08/16/Raspberry-VPN/" class="post-title-link" itemprop="url">树莓派+PPTP+chnroutes+dnsmasq分流+Clash局域网共享</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2021-08-16 00:10:07" itemprop="dateCreated datePublished" datetime="2021-08-16T00:10:07+08:00">2021-08-16</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-08-31 16:51:48" itemprop="dateModified" datetime="2021-08-31T16:51:48+08:00">2021-08-31</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>PPTP协议在没有配置智能分流的情况下，上网需要来回切换略显麻烦，有没有什么办法可以和ssr客户端和V2ray客户端那样实现分流呢？解决这个问题以后又会发现一个新的问题PPTP用的是google的dns，解析到的ip地址未必是适合的ip导致某些网站访问速度很慢，如果一个账号能让任意设备共享网络，省去折腾各个终端安装和配置那就太好了，最近利用家里的树莓派实现了这个需求，下面是我的折腾记录，有更好的方法欢迎留言交流～</p>
<hr>
<h1 id="安装PPTP的linux客户端"><a href="#安装PPTP的linux客户端" class="headerlink" title="安装PPTP的linux客户端"></a>安装PPTP的linux客户端</h1><ol>
<li><p>apt-get安装pptp-linux<br><code>sudo apt-get install pptp-linux</code></p>
</li>
<li><p>修改pptp-linux的配置文件 </p>
<p><code>sudo vi /etc/ppp/peers/pptpconf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pty &quot;你的服务端地址 --nolaunchpppd&quot;</span><br><span class="line">name 账号</span><br><span class="line">password 密码</span><br><span class="line">remotename PPTP</span><br><span class="line">require-mppe-128</span><br><span class="line">require-mschap-v2</span><br><span class="line">refuse-eap</span><br><span class="line">refuse-pap</span><br><span class="line">refuse-chap</span><br><span class="line">refuse-mschap</span><br><span class="line">noauth</span><br><span class="line">persist</span><br><span class="line">maxfail 0</span><br><span class="line">defaultroute</span><br><span class="line">replacedefaultroute</span><br><span class="line">usepeerdns</span><br></pre></td></tr></table></figure></li>
<li><p>启动/关闭PPTP<br><code>sudo pon pptpconf</code><br>开启后，如果连接正常，<code>ifconfig</code>可以看到PPTP的连接ppp0</p>
</li>
<li><p>设置开机启动服务 <code>sudo vi /lib/systemd/system/pptp.service</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=PPTP Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/usr/bin/pon pptpconf</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></li>
<li><p>刷新并启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable pptp</span><br><span class="line">sudo systemctl start pptp</span><br></pre></td></tr></table></figure>
<h1 id="chnroutes分流策略"><a href="#chnroutes分流策略" class="headerlink" title="chnroutes分流策略"></a>chnroutes分流策略</h1><p>根据请求ip分流，某些网站强制转发到ppp0使用PPTP访问，某些网站不使用，这里记录PPTP下的使用方法，其它协议的使用方法可以查看官网：<a href="https://github.com/fivesheep/chnroutes" target="_blank" rel="noopener">https://github.com/fivesheep/chnroutes</a></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/fivesheep/chnroutes.git</span><br><span class="line">cd chnroutes</span><br><span class="line">sudo python chnroutes.py -p linux; sudo chmod a+x ip-pre-up; sudo cp ip-pre-up /etc/ppp; sudo chmod a+x ip-down; sudo cp ip-down /etc/ppp/ip-down.d/</span><br></pre></td></tr></table></figure>
<h1 id="clash开启http-https-socks5代理"><a href="#clash开启http-https-socks5代理" class="headerlink" title="clash开启http/https/socks5代理"></a>clash开启http/https/socks5代理</h1><ol>
<li>安装clash</li>
</ol>
<ul>
<li><p>下载安装包</p>
<p><code>sudo wget https://github.com/Dreamacro/clash/releases/download/v1.6.5/clash-linux-armv7-v1.6.5.gz</code></p>
</li>
<li><p>解压 </p>
<p><code>sudo gunzip clash-linux-armv7-v1.6.5.gz</code></p>
</li>
<li><p>移动到系统目录</p>
<p> <code>sudo mv clash-linux-armv7-v1.6.5 /usr/local/bin/clash</code></p>
</li>
<li><p>设置可执行权限 </p>
<p><code>sudo chmod +x /usr/local/bin/clash</code></p>
</li>
</ul>
<ol start="2">
<li><p>设置配置文件<br> <code>sudo vi ~/.config/clash/config.yaml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># port of HTTP</span><br><span class="line">port: 7890</span><br><span class="line"></span><br><span class="line">## port of SOCKS5</span><br><span class="line">socks-port: 7891</span><br><span class="line"></span><br><span class="line"># `allow-lan` must be true in your config.yml</span><br><span class="line">allow-lan: true</span><br><span class="line"></span><br><span class="line"># set log level to stdout (default is info)</span><br><span class="line"># info / warning / error / debug / silent</span><br><span class="line">log-level: info</span><br><span class="line"></span><br><span class="line"># A RESTful API for clash</span><br><span class="line">#使用0.0.0.0可以使用局域网设备访问</span><br><span class="line">external-controller: 0.0.0.0:8080</span><br><span class="line"></span><br><span class="line">mode: Rule</span><br></pre></td></tr></table></figure>
<p><code>sudo clash</code>启动，这样我们就拥有http/https/socks5的代理服务器了，任意设备只要配置树莓派的ip地址和对应协议的端口号即可代理请求，如果有公网ip或内网穿透，有域名+ddns解析服务器那么在外网也可以代理</p>
</li>
<li><p>设置开机启动服务</p>
<p> <code>sudo vi /etc/systemd/system/clash.service</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Clash Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Restart=on-abort</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">ExecStart=/usr/local/bin/clash -d /home/pi/.config/clash</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></li>
<li><p>转发所有请求 <code>sudo vi /etc/sysctl.conf</code></p>
</li>
</ol>
<ul>
<li><p>ipv4的请求，修改</p>
<p> <code>net.ipv4.ip_forward=1</code></p>
</li>
<li><p>ipv6的请求，修改</p>
<p><code>net.ipv6.conf.all.forwarding = 1</code><br>刷新设置 </p>
<p><code>sudo sysctl -p</code><br>流量强制转发到ppp0<br> <code>sudo iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</code></p>
<h1 id="dnsmasq-dnsmasq-china-list-本地DNS分流策略"><a href="#dnsmasq-dnsmasq-china-list-本地DNS分流策略" class="headerlink" title="dnsmasq + dnsmasq-china-list 本地DNS分流策略"></a>dnsmasq + dnsmasq-china-list 本地DNS分流策略</h1></li>
</ul>
<ol>
<li><p>apt-get安装dnsmasq</p>
<p> <code>sudo apt install dnsmasq</code></p>
</li>
<li><p>设置配置文件</p>
<p> <code>sudo vi /etc/dnsmasq.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">no-resolv</span><br><span class="line">server=8.8.8.8</span><br><span class="line">server=8.8.4.4</span><br></pre></td></tr></table></figure></li>
<li><p>用dnsmasq-china-list设置白名单，用运营商dns去解析，其它用google的dns解析，否则解析到的ip并不是访问速度快的最适合的ip，导致网站和App的访问速度太慢了，所以太干净的dns解析也不好</p>
</li>
</ol>
<ul>
<li>运营商分配的DNS地址假设为223.5.5.5，切换到su用户，拉取不需要走PPTP的地址用运营商分配的DNS地址去解析<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf|sed &apos;s/114.114.114.114/223.5.5.5/g&apos; &gt;/etc/dnsmasq.d/accelerated-domains.china.223.5.5.5.conf</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li><p>重启dnsmasq</p>
<p><code>service dnsmasq restart</code></p>
</li>
<li><p>测试分流效果</p>
</li>
</ol>
<ul>
<li>未使用本地dns解析<br><code>dig google.com @223.5.5.5</code></li>
<li>使用本地dns解析<br><code>dig google.com @127.0.0.1</code></li>
</ul>
<ol start="6">
<li>添加自定义域名到白名单<br><code>echo &#39;server=/你需要的域名/223.5.5.5&#39; &gt;&gt;/etc/dnsmasq.d/accelerated-domains.china.223.5.5.5.conf</code><h1 id="DDNS动态域名解析"><a href="#DDNS动态域名解析" class="headerlink" title="DDNS动态域名解析"></a>DDNS动态域名解析</h1>如果家里是公网IP，可以使用DDNS给域名绑定动态ip，no-ip是ddns解析服务，免费赠送域名无需备案，速度还不错，每个月需要点一次邮件续期，官网的ip更新方式在树莓派下更新失败，折腾一段时间后，发现用ddclient可以正常更新，但是注意如果当前状态是pptp开启的情况下，获取到的外网ip可能不是运营商的公网ip，在配置了智能路由的情况下需使用无需PPTP访问的网站获取外网ip<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install ddclient</span><br></pre></td></tr></table></figure>
设置配置文件 <code>/etc/ddclient.conf</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protocol=noip</span><br><span class="line">use=web, web=获取外网ip的网站</span><br><span class="line">server=dynupdate.no-ip.com</span><br><span class="line">login=用户名（邮箱）</span><br><span class="line">password=&apos;密码&apos;</span><br><span class="line">你的域名</span><br></pre></td></tr></table></figure>
</li>
</ol>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jessie Kate</p>
  <div class="site-description" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.1
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  





















  

  

  


</body>
</html>
