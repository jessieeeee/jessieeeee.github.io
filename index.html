<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=PingFang SC:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta property="og:type" content="website">
<meta property="og:title" content="JessieK&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="JessieK&#39;s blog">
<meta property="og:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JessieK&#39;s blog">
<meta name="twitter:description" content="程序的世界，比你牛逼的人更比你努力。 hello，I&apos;m an Android developer～  My hobbies tag &amp;#58;  - Coding   - Sports    - Game">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> JessieK's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e889f842193ec7fdc8e475d42bc50dee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JessieK's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">My Technical sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/03/SimpleOne/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/03/SimpleOne/" itemprop="url">
                  SimpleOne
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-03T20:03:19+08:00">
                2018-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/03/SimpleOne/" class="leancloud_visitors" data-flag-title="SimpleOne">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>随着混合开发越来越火，逐渐成为行业发展趋势，ReactNative也一直保持着快速更新的节奏，”learn once,write anywhere”这个宣传语一直吸引着我，公司最近也不忙了，一直想入坑的我终于找到了一个合适的时间点，很长一段时间没有更新博客了，因为在学习ReactNative这个框架，由于喜欢one一个的ui界面，做了这个开源项目，这是一个高仿韩寒one一个的开源项目，在此声明，本项目完全以学习为目的，不侵犯one一个的利益，遵守开源协议，所有接口全部来源于one一个android版4.3.4抓包获得，项目中使用的素材也是解压apk文件获得，原版是使用android原生实现的，本项目用ReactNative框架实现，还使用了ReactNative的第三方库，sdk接入是调用了原生android sdk模块，此项目目前只对android进行了适配，ios目前尚未适配，项目结构并非标准的ReactNative项目结构，而是android原生项目结构引入ReactNative框架的混合开发结构。我学习ReactNative不久，以前是做android原生开发的，如果有写的不好的地方，或者是你有更好的实现方式，希望一起学习讨论。</p>
<hr>
<h1 id="api接口清单"><a href="#api接口清单" class="headerlink" title="api接口清单"></a>api接口清单</h1><p>这里对提取出的api接口做个记录，本人以学习为目的，希望读者也不要用于任何商业项目中，目前列出的接口是基于4.3.4的android版：</p>
<ol>
<li><p>one首页（第一页，date=0，更多页date=yyyy-MM-dd）</p>
<p><code>http://v3.wufazhuce.com:8000/api/channel/one/{date}/0</code></p>
</li>
<li><p>专题列表（第一页，last_id=0，更多页last_id=上次请求结束的id）</p>
<p><code>http://v3.wufazhuce.com:8000/api/banner/list/4?last_id={last_id}</code></p>
</li>
<li><p>横着的列表（所有人问所有人）</p>
<p><code>http://v3.wufazhuce.com:8000/api/banner/list/5</code></p>
</li>
<li><p>近期热门作者</p>
<p><code>http://v3.wufazhuce.com:8000/api/author/hot</code></p>
</li>
<li><p>one首页菜单跳转</p>
<ul>
<li><p>问答<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/question/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/question/htmlcontent/{content_id}</code></p>
</li>
<li><p>连载<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/serial/{content_id}/0</code><br><code>http://v3.wufazhuce.com:8000/api/serialcontent/htmlcontent/{content_id}</code></p>
</li>
<li><p>音乐<br><code>http://v3.wufazhuce.com:8000/api/music/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/music/{content_id}/0</code></p>
</li>
<li><p>电影<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/movie/{content_id}/0</code><br><code>http://v3.wufazhuce.com:8000/api/movie/htmlcontent/{content_id}</code></p>
</li>
<li><p>文章内容和作者<br><code>http://v3.wufazhuce.com:8000/api/essay/htmlcontent/{content_id}</code><br>文章评论<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/essay/{content_id}/0</code></p>
</li>
</ul>
</li>
<li><p>搜索模块分类跳转（category_id，0图文 3问答 1阅读 2连载 5影视 4音乐 8电台）</p>
<p><code>http://v3.wufazhuce.com:8000/api/all/list/{category_id}</code></p>
</li>
<li><p>one首页和专题列表的item点击阅读跳转详情和获取评论</p>
<ul>
<li><p>问答<br><code>http://v3.wufazhuce.com:8000/api/question/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/question/{content_id}</code></p>
</li>
<li><p>连载<br><code>http://v3.wufazhuce.com:8000/api/serialcontent/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/serial/{content_id}/0</code></p>
</li>
<li><p>音乐<br><code>http://v3.wufazhuce.com:8000/api/music/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/music/{content_id}/0</code></p>
</li>
<li><p>电影<br><code>http://v3.wufazhuce.com:8000/api/movie/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/movie/{content_id}/0</code></p>
</li>
<li><p>文章内容和作者<br><code>http://v3.wufazhuce.com:8000/api/essay/htmlcontent/{content_id}</code></p>
</li>
<li>文章评论<br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/essay/{content_id}/0</code></li>
<li><p>电台<br><code>http://v3.wufazhuce.com:8000/api/radio/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/radio/{content_id}/0</code></p>
</li>
<li><p>专题<br><code>http://v3.wufazhuce.com:8000/api/topic/htmlcontent/{content_id}</code><br><code>http://v3.wufazhuce.com:8000/api/comment/praiseandtime/topic/{content_id}/0</code></p>
</li>
</ul>
</li>
<li><p>作者页<br><code>http://v3.wufazhuce.com:8000/api/author/works?page_num={page_num}&amp;author_id={author_id}&amp;version=4.3.4</code></p>
</li>
</ol>
<p>#功能模块：</p>
<p>根据android 4.3.4整理：</p>
<p>一级界面：</p>
<p>欢迎界面，按星期几展示不同的欢迎界面</p>
<p>one分页，也是首页，展示今日列表（插图，one-story, 问答，文章，影视，音乐，电台），折叠菜单，可翻页查看以前的列表，每翻一页，查看前一天的内容，列表头部可以下拉刷新。</p>
<p>all分页，长列表展示，顶部banner，分类导航，专题列表（下拉到底部以后，可加载更多），列表头部可以下拉刷新。</p>
<p>me分页，个人资料页，未登录时，为登录界面入口和设置入口</p>
<p>二级界面：</p>
<p>设置界面</p>
<p>阅读界面</p>
<p>登录界面</p>
<p>分享界面</p>
<p>搜索界面</p>
<p>第三方平台分享，登录sdk对接</p>
<p>##当前未完成部分：</p>
<p>阅读界面js回调（包含音乐播放）夜间模式</p>
<p>设置模块缓存</p>
<p>阅读界面交互动画</p>
<p>one分页翻页标题动画</p>
<p>#目前用到的技术：</p>
<p>由于我最初学习的时候资料是用ES5进行编写的，这是我自学ReactNative后的第一个项目，所以本项目采用ES5的语法。</p>
<p>react-native对原生组件进行了封装。</p>
<ol>
<li>基本控件的使用 View，Text，Image，ScrollView，ListView，WebView，Clipboard，Platform，TouchableOpacity，ActivityIndicator，StatusBar，SliderBar。</li>
<li>动画的调用，Animated，Easing</li>
<li>计时器的使用，react-timer-mixin</li>
<li>react-native调用原生模块（原生toast，调android第三方分享sdk）</li>
<li>底部导航栏TabNavigator，页面导航Navigator</li>
<li>子组件的封装，调用以及回调</li>
<li>父组件和子组件之间的参数传递</li>
<li>页面导航跳转时的参数传递，以及回调</li>
<li>第三方react-native控件的引入( react-native-pull )，并进行部分修改</li>
<li>自定义折叠控件（one分页中的菜单）实现折叠动画</li>
<li>自定义banner控件，实现all分页中的广告栏展示</li>
<li>自定义加载更多控件，监听ScrollView的滑动，实现加载更多</li>
<li>自定义阅读界面loading时的帧动画展示。</li>
<li>半透明界面，悬浮窗实现，自定义单选对话框实现</li>
<li>相册，拍照实现</li>
<li>调用基于Android原生封装的ui控件</li>
<li>在Android原生项目的基础上引入react-native框架进行混合开发</li>
<li>音乐专辑封面旋转动画（解决动画循环播放中的暂停与播放事件），通过直接修改属性setNativeProps实现帧动画提高性能</li>
</ol>
<p>这个项目让初学者的我受益良多，现在的react-native第三方框架还不是很多，很多时候要自定义，而且在Android上的坑还是有很多，不过react-native的更新速度也是相当快的。后面有时间会陆续追加一些此项目中自定义部分的详细技术文章。<br>最近由于公司的项目需求，入坑了微信小程序，年前忙项目进度，估计短期内没有时间更新这个项目了，有时间会上传目前的动画效果图。</p>
<p>此项目的github地址<a href="https://github.com/jessieeeee/SimpleOne" target="_blank" rel="external">传送门</a>，欢迎一起交流和学习。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/01/RxJavaStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/01/RxJavaStudy/" itemprop="url">
                  RxJava学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-01T20:07:55+08:00">
                2017-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/12/01/RxJavaStudy/" class="leancloud_visitors" data-flag-title="RxJava学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>RxJava 的异步实现，是通过一种扩展的观察者模式来实现的。免除了业务逻辑代码的频繁回调，增加了逻辑代码的可读性。</p>
<h2 id="观察者模式："><a href="#观察者模式：" class="headerlink" title="观察者模式："></a>观察者模式：</h2><p>A 对象（观察者）对 B 对象（被观察者）的某种变化高度敏感，需要在 B 变化的一瞬间做出反应。<br>观察者不需要时刻盯着被观察者（例如 A 不需要每过 2ms 就检查一次 B 的状态），而是采用注册(Register)或者称为订阅(Subscribe)的方式，告诉被观察者：我需要你的某某状态，你要在它变化的时候通知我。 Android 开发中一个比较典型的例子是点击监听器 OnClickListener 。对设置 OnClickListener 来说， View 是被观察者， OnClickListener 是观察者，二者通过 setOnClickListener() 方法达成订阅关系。订阅之后用户点击按钮的瞬间，Android Framework 就会将点击事件发送给已经注册的 OnClickListener 。采取这样被动的观察方式，既省去了反复检索状态的资源消耗，也能够得到最高的反馈速度。</p>
<h2 id="RxJava-基本概念："><a href="#RxJava-基本概念：" class="headerlink" title="RxJava 基本概念："></a>RxJava 基本概念：</h2><p>Observable (可观察者，即被观察者)也称作上游<br>Observer (观察者)也称作下游<br>subscribe (订阅)、事件<br>Observable 和 Observer 通过 subscribe() 方法实现订阅关系，从而 Observable 可以在需要的时候发出事件来通知 Observer。</p>
<p>与传统观察者模式不同， RxJava 的事件回调方法除了普通事件 onNext() （相当于 onClick() / onEvent()）之外，还定义了两个特殊的事件：onCompleted() 和 onError()。</p>
<p>onCompleted(): 事件队列完结。RxJava 不仅把每个事件单独处理，还会把它们看做一个队列。RxJava 规定，当不会再有新的 onNext() 发出时，需要触发 onCompleted() 方法作为标志。<br>onError(): 事件队列异常。在事件处理过程中出异常时，onError() 会被触发，同时队列自动终止，不允许再有事件发出。<br>在一个正确运行的事件序列中, onCompleted() 和 onError() 有且只有一个，并且是事件序列中的最后一个。需要注意的是，onCompleted() 和 onError() 二者也是互斥的，即在队列中调用了其中一个，就不应该再调用另一个。</p>
<p>对于Android本身有一套现成的框架，复杂的逻辑操作在服务端较多，客户端出现的场景较少，长时间不怎么使用，很容易让人忘记那些理论知识，所以根据一些实战例子来进行学习效果更佳。</p>
<h2 id="map操作符"><a href="#map操作符" class="headerlink" title="map操作符"></a>map操作符</h2><p>常用于数据列表类型转换<br>上游读取数据源并发送到下游，Utils.getApiUserList()模拟从服务端获得的dto类型为ApiUser的数据列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observable&lt;List&lt;ApiUser&gt;&gt; getObservable() &#123;</div><div class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;ApiUser&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;ApiUser&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="comment">//上游未被切断</span></div><div class="line">            <span class="keyword">if</span> (!e.isDisposed()) &#123;</div><div class="line">                <span class="comment">//发送到下游,执行下游对应逻辑</span></div><div class="line">                e.onNext(Utils.getApiUserList());</div><div class="line">                <span class="comment">//上游发送完毕，执行下游对应逻辑</span></div><div class="line">                e.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ApiUser&gt; <span class="title">getApiUserList</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    List&lt;ApiUser&gt; apiUserList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    ApiUser apiUserOne = <span class="keyword">new</span> ApiUser();</div><div class="line">    apiUserOne.firstname = <span class="string">"Amit"</span>;</div><div class="line">    apiUserOne.lastname = <span class="string">"Shekhar"</span>;</div><div class="line">    apiUserList.add(apiUserOne);</div><div class="line"></div><div class="line">    ApiUser apiUserTwo = <span class="keyword">new</span> ApiUser();</div><div class="line">    apiUserTwo.firstname = <span class="string">"Manish"</span>;</div><div class="line">    apiUserTwo.lastname = <span class="string">"Kumar"</span>;</div><div class="line">    apiUserList.add(apiUserTwo);</div><div class="line"></div><div class="line">    ApiUser apiUserThree = <span class="keyword">new</span> ApiUser();</div><div class="line">    apiUserThree.firstname = <span class="string">"Sumit"</span>;</div><div class="line">    apiUserThree.lastname = <span class="string">"Kumar"</span>;</div><div class="line">    apiUserList.add(apiUserThree);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> apiUserList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>建立订阅关系，通过map操作符将ApiUser类型的dto转化成User类型的dto，再执行下游的处理逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">//上游处理逻辑</span></div><div class="line">    getObservable()</div><div class="line">            .map(<span class="keyword">new</span> Function&lt;List&lt;ApiUser&gt;, List&lt;User&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">apply</span><span class="params">(List&lt;ApiUser&gt; apiUsers)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="comment">//转化操作</span></div><div class="line">                    <span class="keyword">return</span> Utils.convertApiUserListToUserList(apiUsers);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            <span class="comment">// 在子线程中运行</span></div><div class="line">            .subscribeOn(Schedulers.io())</div><div class="line">            <span class="comment">// 切换到主线程</span></div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            <span class="comment">// 下游处理逻辑</span></div><div class="line">            .subscribe(getObserver());</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">convertApiUserListToUserList</span><span class="params">(List&lt;ApiUser&gt; apiUserList)</span> </span>&#123;</div><div class="line"></div><div class="line">    List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (ApiUser apiUser : apiUserList) &#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.firstname = apiUser.firstname;</div><div class="line">        user.lastname = apiUser.lastname;</div><div class="line">        userList.add(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> userList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下游获取到数据源，进行数据打印：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observer&lt;List&lt;User&gt;&gt; getObserver() &#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;List&lt;User&gt;&gt;() &#123;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; userList)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onNext"</span>);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               <span class="keyword">for</span> (User user : userList) &#123;</div><div class="line">                   textView.append(<span class="string">" firstname : "</span> + user.firstname);</div><div class="line">                   textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               &#125;</div><div class="line">               Log.d(TAG, <span class="string">" onNext : "</span> + userList.size());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onComplete"</span>);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="flatMap操作符"><a href="#flatMap操作符" class="headerlink" title="flatMap操作符"></a>flatMap操作符</h2><p>常用于遍历数据列表，按条件进行过滤<br>与它相同的是concatMap，但是flatMap可能会乱序，concatMap可保证下游的获取到的数据源与上游发送顺序一致<br>此处上游数据源与map操作符相同<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">getObservable()</div><div class="line">               .subscribeOn(Schedulers.io())</div><div class="line">               .observeOn(AndroidSchedulers.mainThread())</div><div class="line">               .flatMap(<span class="keyword">new</span> Function&lt;List&lt;ApiUser&gt;, ObservableSource&lt;ApiUser&gt;&gt;() &#123;</div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> ObservableSource&lt;ApiUser&gt; <span class="title">apply</span><span class="params">(List&lt;ApiUser&gt; apiUsers)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                       <span class="keyword">return</span> Observable.fromIterable(apiUsers);</div><div class="line">                   &#125;</div><div class="line">               &#125;)</div><div class="line">               .filter(<span class="keyword">new</span> Predicate&lt;ApiUser&gt;() &#123;</div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(ApiUser apiUser)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                       <span class="keyword">return</span> apiUser.lastname.substring(<span class="number">0</span>,<span class="number">1</span>).equals(<span class="string">"K"</span>);</div><div class="line">                   &#125;</div><div class="line">               &#125;)</div><div class="line">               .subscribe(getObserver());</div></pre></td></tr></table></figure></p>
<p>下游获取到数据源，进行数据打印：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observer&lt;ApiUser&gt; <span class="title">getObserver</span><span class="params">()</span></span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;ApiUser&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiUser apiUser)</span> </span>&#123;</div><div class="line">               Log.d(TAG, <span class="string">"user : "</span> + apiUser.toString());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="zip操作符"><a href="#zip操作符" class="headerlink" title="zip操作符"></a>zip操作符</h2><p>常用于对两个数据源列表进行处理，并返回一个结果数据列表<br>上游读取两个数据源并发送到下游：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observable&lt;List&lt;User&gt;&gt; getCricketFansObservable() &#123;</div><div class="line">      <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;User&gt;&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;User&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              <span class="comment">//上游未被切断</span></div><div class="line">              <span class="keyword">if</span> (!e.isDisposed()) &#123;</div><div class="line">                  <span class="comment">//发送到下游,执行下游对应逻辑</span></div><div class="line">                  e.onNext(Utils.getUserListWhoLovesCricket());</div><div class="line">                  <span class="comment">//上游发送完毕，执行下游对应逻辑</span></div><div class="line">                  e.onComplete();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Observable&lt;List&lt;User&gt;&gt; getFootballFansObservable() &#123;</div><div class="line">      <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;List&lt;User&gt;&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;List&lt;User&gt;&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              <span class="comment">//上游未被切断</span></div><div class="line">              <span class="keyword">if</span> (!e.isDisposed()) &#123;</div><div class="line">                  <span class="comment">//发送到下游,执行下游对应逻辑</span></div><div class="line">                  e.onNext(Utils.getUserListWhoLovesFootball());</div><div class="line">                  <span class="comment">//上游发送完毕，执行下游对应逻辑</span></div><div class="line">                  e.onComplete();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">//模拟数据源1</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">getUserListWhoLovesCricket</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">      List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">      User userOne = <span class="keyword">new</span> User();</div><div class="line">      userOne.id = <span class="number">1</span>;</div><div class="line">      userOne.firstname = <span class="string">"Amit"</span>;</div><div class="line">      userOne.lastname = <span class="string">"Shekhar"</span>;</div><div class="line">      userList.add(userOne);</div><div class="line"></div><div class="line">      User userTwo = <span class="keyword">new</span> User();</div><div class="line">      userTwo.id = <span class="number">2</span>;</div><div class="line">      userTwo.firstname = <span class="string">"Manish"</span>;</div><div class="line">      userTwo.lastname = <span class="string">"Kumar"</span>;</div><div class="line">      userList.add(userTwo);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> userList;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//模拟数据源2</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">getUserListWhoLovesFootball</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">      List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">      User userOne = <span class="keyword">new</span> User();</div><div class="line">      userOne.id = <span class="number">1</span>;</div><div class="line">      userOne.firstname = <span class="string">"Amit"</span>;</div><div class="line">      userOne.lastname = <span class="string">"Shekhar"</span>;</div><div class="line">      userList.add(userOne);</div><div class="line"></div><div class="line">      User userTwo = <span class="keyword">new</span> User();</div><div class="line">      userTwo.id = <span class="number">3</span>;</div><div class="line">      userTwo.firstname = <span class="string">"Sumit"</span>;</div><div class="line">      userTwo.lastname = <span class="string">"Kumar"</span>;</div><div class="line">      userList.add(userTwo);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> userList;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>建立订阅关系，通过zip操作符过滤两个数据源都有的数据，返回结果数据列表<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Observable.zip(getCricketFansObservable(), getFootballFansObservable(),</div><div class="line">                <span class="keyword">new</span> BiFunction&lt;List&lt;User&gt;, List&lt;User&gt;, List&lt;User&gt;&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">apply</span><span class="params">(List&lt;User&gt; cricketFans, List&lt;User&gt; footballFans)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                        <span class="comment">//过滤两个数据表都有的数据，返回结果数据列表</span></div><div class="line">                        <span class="keyword">return</span> Utils.filterUserWhoLovesBoth(cricketFans, footballFans);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                <span class="comment">// 在子线程中运行</span></div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                <span class="comment">// 切到主线程</span></div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                <span class="comment">// 下游逻辑处理</span></div><div class="line">                .subscribe(getObserver());</div><div class="line">                </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">filterUserWhoLovesBoth</span><span class="params">(List&lt;User&gt; cricketFans, List&lt;User&gt; footballFans)</span> </span>&#123;</div><div class="line">        List&lt;User&gt; userWhoLovesBoth = <span class="keyword">new</span> ArrayList&lt;User&gt;();</div><div class="line">        <span class="keyword">for</span> (User cricketFan : cricketFans) &#123;</div><div class="line">            <span class="keyword">for</span> (User footballFan : footballFans) &#123;</div><div class="line">                <span class="keyword">if</span> (cricketFan.id == footballFan.id) &#123;</div><div class="line">                    userWhoLovesBoth.add(cricketFan);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> userWhoLovesBoth;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>下游获取到数据源进行数据打印<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observer&lt;List&lt;User&gt;&gt; getObserver() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;List&lt;User&gt;&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;User&gt; userList)</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onNext"</span>);</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            <span class="keyword">for</span> (User user : userList) &#123;</div><div class="line">                textView.append(<span class="string">" firstname : "</span> + user.firstname);</div><div class="line">                textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            &#125;</div><div class="line">            Log.d(TAG, <span class="string">" onNext : "</span> + userList.size());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onComplete"</span>);</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Interval操作符"><a href="#Interval操作符" class="headerlink" title="Interval操作符"></a>Interval操作符</h2><p>常用于周期性的处理逻辑（每隔多少时间后执行）<br>上游11秒延迟后，每隔2秒，发送long型数据源到下游，从0开始逐渐递增<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observable&lt;? extends Long&gt; getObservable() &#123;</div><div class="line">       <span class="keyword">return</span> Observable.interval(<span class="number">11</span>, <span class="number">2</span>, TimeUnit.SECONDS);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>建立订阅关系，CompositeDisposable统一存放水管，也就是被观察者，为防止内存泄漏，在activity被destory时切断所有的水管<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CompositeDisposable disposables = <span class="keyword">new</span> CompositeDisposable();</div><div class="line"> disposables.add(getObservable()</div><div class="line">                <span class="comment">// 上游运行在子线程</span></div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                <span class="comment">// 切换到主线程</span></div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                <span class="comment">// 下游逻辑处理</span></div><div class="line">                .subscribeWith(getObserver()));</div><div class="line"> <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        disposables.clear();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>下游获取到数据源进行数据打印：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> DisposableObserver&lt;Long&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DisposableObserver&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long value)</span> </span>&#123;</div><div class="line">                textView.append(<span class="string">" onNext : value : "</span> + value);</div><div class="line">                textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">                Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">                textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">                textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">                Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                textView.append(<span class="string">" onComplete"</span>);</div><div class="line">                textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">                Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="Timer操作符"><a href="#Timer操作符" class="headerlink" title="Timer操作符"></a>Timer操作符</h2><p>常用于计时器的处理逻辑（多少时间后执行）<br>上游延迟2秒发送long型数据0到下游，只发送一次<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Observable&lt;? extends Long&gt; getObservable() &#123;</div><div class="line">    <span class="keyword">return</span> Observable.timer(<span class="number">2</span>, TimeUnit.SECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>建立订阅关系<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">getObservable()</div><div class="line">             <span class="comment">// 上游在子线程运行</span></div><div class="line">             .subscribeOn(Schedulers.io())</div><div class="line">             <span class="comment">// 切换到主线程</span></div><div class="line">             .observeOn(AndroidSchedulers.mainThread())</div><div class="line">             .subscribe(getObserver());</div></pre></td></tr></table></figure></p>
<p>下游进行打印输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observer&lt;Long&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;Long&gt;() &#123;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long value)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onNext : value : "</span> + value);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onComplete"</span>);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="Flowable背压式"><a href="#Flowable背压式" class="headerlink" title="Flowable背压式"></a>Flowable背压式</h2><p>Rxjava在处理异步操作时，会先将上游的数据放入一个缓存池中，这里称作水缸，一旦下游不能及时处理就会出现内存溢出的问题，抛出MissingBackpressureException<br>解决方式</p>
<ol>
<li>放慢上游的发送速度</li>
<li>减少发送的数据<br>Flowable在设计的时候采用了一种新的思路也就是响应式拉取的方式来更好的解决上下游流速不均衡的问题，<br>在同一线程中下游没有调用request, 上游就认为下游没有处理事件的能力，抛出MissingBackpressureException，当上下游工作在不同的线程中时,  只有当下游调用request时, 才从水缸里取出事件发给下游。 <h3 id="背压策略"><a href="#背压策略" class="headerlink" title="背压策略"></a>背压策略</h3><h4 id="BackpressureStrategy-ERROR："><a href="#BackpressureStrategy-ERROR：" class="headerlink" title="BackpressureStrategy.ERROR："></a>BackpressureStrategy.ERROR：</h4>默认策略，有一个大小为128的水缸<h4 id="BackpressureStrategy-BUFFER"><a href="#BackpressureStrategy-BUFFER" class="headerlink" title="BackpressureStrategy.BUFFER"></a>BackpressureStrategy.BUFFER</h4>增大水缸的容量，仍有内存溢出问题<h4 id="BackpressureStrategy-DROP"><a href="#BackpressureStrategy-DROP" class="headerlink" title="BackpressureStrategy.DROP"></a>BackpressureStrategy.DROP</h4>水缸存不下时，直接把存不下的事件丢弃<h4 id="BackpressureStrategy-LATEST"><a href="#BackpressureStrategy-LATEST" class="headerlink" title="BackpressureStrategy.LATEST"></a>BackpressureStrategy.LATEST</h4>水缸存不下时，只保留最新的事件<h2 id="reduce操作符"><a href="#reduce操作符" class="headerlink" title="reduce操作符"></a>reduce操作符</h2>遍历list，第一次将第一个元素和第二个元素作为入参，返回一个结果值，以后将上一次返回的结果和当前遍历的元素作为入参，返回一个结果值。<br>与它相同的是scan操作符，但是scan操作符会返回上一次的结果<br>上游创建数据源，发送到下游<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Integer&gt; <span class="title">getObservable</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>建立订阅关系，将上一次返回的结果和当前遍历的元素作为入参，最后返回一个累加值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">getObservable()</div><div class="line">                .reduce(<span class="keyword">new</span> BiFunction&lt;Integer, Integer, Integer&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">apply</span><span class="params">(Integer t1, Integer t2)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> t1 + t2;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">                .subscribe(getObserver());</div></pre></td></tr></table></figure></p>
<p>下游进行打印输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MaybeObserver&lt;Integer&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaybeObserver&lt;Integer&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Integer value)</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onSuccess : value : "</span> + value);</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            Log.d(TAG, <span class="string">" onSuccess : value : "</span> + value);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">            textView.append(<span class="string">" onComplete"</span>);</div><div class="line">            textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">            Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Filter操作符"><a href="#Filter操作符" class="headerlink" title="Filter操作符"></a>Filter操作符</h2><p>遍历list中的每个元素，按条件过滤<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</div><div class="line">               .filter(<span class="keyword">new</span> Predicate&lt;Integer&gt;() &#123;</div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                       <span class="keyword">return</span> integer % <span class="number">2</span> == <span class="number">0</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;)</div><div class="line">               .subscribe(getObserver());</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Observer&lt;Integer&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">               Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer value)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onNext : "</span>);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               textView.append(<span class="string">" value : "</span> + value);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onNext "</span>);</div><div class="line">               Log.d(TAG, <span class="string">" value : "</span> + value);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">               textView.append(<span class="string">" onComplete"</span>);</div><div class="line">               textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">               Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="Contact操作符"><a href="#Contact操作符" class="headerlink" title="Contact操作符"></a>Contact操作符</h2><p>将多个数据源结合成一个数据源并发送数据，并且严格按照先后顺序发射数据<br>与它相同的有merge，但是merge是无序的且是并发的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">String[] aStrings = &#123;<span class="string">"A1"</span>, <span class="string">"A2"</span>, <span class="string">"A3"</span>, <span class="string">"A4"</span>&#125;;</div><div class="line">String[] bStrings = &#123;<span class="string">"B1"</span>, <span class="string">"B2"</span>, <span class="string">"B3"</span>&#125;;</div><div class="line"></div><div class="line">Observable&lt;String&gt; aObservable = Observable.fromArray(aStrings);</div><div class="line">Observable&lt;String&gt; bObservable = Observable.fromArray(bStrings);</div><div class="line"></div><div class="line">Observable.concat(aObservable, bObservable)</div><div class="line">              .subscribe(getObserver());</div><div class="line">              </div><div class="line"><span class="function"><span class="keyword">private</span> Observer&lt;String&gt; <span class="title">getObserver</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">              Log.d(TAG, <span class="string">" onSubscribe : "</span> + d.isDisposed());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">              textView.append(<span class="string">" onNext : value : "</span> + value);</div><div class="line">              textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">              Log.d(TAG, <span class="string">" onNext : value : "</span> + value);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">              textView.append(<span class="string">" onError : "</span> + e.getMessage());</div><div class="line">              textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">              Log.d(TAG, <span class="string">" onError : "</span> + e.getMessage());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">              textView.append(<span class="string">" onComplete"</span>);</div><div class="line">              textView.append(AppConstant.LINE_SEPARATOR);</div><div class="line">              Log.d(TAG, <span class="string">" onComplete"</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h2 id="Rxbus的使用"><a href="#Rxbus的使用" class="headerlink" title="Rxbus的使用"></a>Rxbus的使用</h2><p>定义Rxbus<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> PublishSubject&lt;Object&gt; bus = PublishSubject.create();</div><div class="line"></div><div class="line">    <span class="comment">//发送event</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        bus.onNext(o);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取bus对象</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Observable&lt;Object&gt; <span class="title">toObservable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bus;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasObservers</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bus.hasObservers();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在Application中初始化Rxbus，做事件的统一管理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> RxBus bus;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        bus = <span class="keyword">new</span> RxBus();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> RxBus <span class="title">bus</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bus;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在activity中发送事件，CompositeDisposable统一存放水管，为避免内存泄漏，destory时切断水管<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">CompositeDisposable disposables = <span class="keyword">new</span> CompositeDisposable();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        disposables.clear();</div><div class="line">    &#125;</div><div class="line"> <span class="comment">//上游是MyApplication的bus，建立订阅关系，绑定下游事件接收回调处理</span></div><div class="line"> disposables.add(((MyApplication) getApplication())</div><div class="line">                .bus()</div><div class="line">                .toObservable()</div><div class="line">                .subscribeOn(Schedulers.io())</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribe(<span class="keyword">new</span> Consumer&lt;Object&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Events.TapEvent) &#123;</div><div class="line">                            textView.setText(<span class="string">"Tap Event Received"</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;));</div><div class="line">                </div><div class="line">    <span class="comment">//发送事件到MyApplication的bus</span></div><div class="line">    ((MyApplication) getApplication())</div><div class="line">                        .bus()</div><div class="line">                        .send(<span class="keyword">new</span> Events.TapEvent());</div></pre></td></tr></table></figure></p>
<h2 id="操作符组合使用"><a href="#操作符组合使用" class="headerlink" title="操作符组合使用"></a>操作符组合使用</h2><p>android搜索功能的实现<br>绑定searchview的监听<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxSearchObservable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Observable&lt;String&gt; <span class="title">fromView</span><span class="params">(SearchView searchView)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> PublishSubject&lt;String&gt; subject = PublishSubject.create();</div><div class="line"></div><div class="line">        searchView.setOnQueryTextListener(<span class="keyword">new</span> SearchView.OnQueryTextListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                subject.onComplete();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String text)</span> </span>&#123;</div><div class="line">                subject.onNext(text);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> subject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>建立订阅关系，上游输入文字监听，下游显示结果<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//上游绑定SearchView输入文字监听</span></div><div class="line">    RxSearchObservable.fromView(searchView)</div><div class="line">            <span class="comment">//每隔300毫秒执行</span></div><div class="line">            .debounce(<span class="number">300</span>, TimeUnit.MILLISECONDS)</div><div class="line">            <span class="comment">//过滤输入文字不为空</span></div><div class="line">            .filter(<span class="keyword">new</span> Predicate&lt;String&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String text)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (text.isEmpty()) &#123;</div><div class="line">                        textViewResult.setText(<span class="string">""</span>);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            <span class="comment">//与上次的数据对比有变化</span></div><div class="line">            .distinctUntilChanged()</div><div class="line">            <span class="comment">//只发射最近的一次observable</span></div><div class="line">            .switchMap(<span class="keyword">new</span> Function&lt;String, ObservableSource&lt;String&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> ObservableSource&lt;String&gt; <span class="title">apply</span><span class="params">(String query)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="comment">//从网络获取数据</span></div><div class="line">                    <span class="keyword">return</span> dataFromNetwork(query);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            <span class="comment">//在子线程中运行</span></div><div class="line">            .subscribeOn(Schedulers.io())</div><div class="line">            <span class="comment">//切到主线程</span></div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            <span class="comment">//下游显示结果</span></div><div class="line">            .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String result)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    textViewResult.setText(result);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            </div><div class="line"><span class="comment">//模拟网络请求</span></div><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;String&gt; <span class="title">dataFromNetwork</span><span class="params">(<span class="keyword">final</span> String query)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.just(<span class="keyword">true</span>)</div><div class="line">            .delay(<span class="number">2</span>, TimeUnit.SECONDS)</div><div class="line">            .map(<span class="keyword">new</span> Function&lt;Boolean, String&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(@NonNull Boolean value)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="keyword">return</span> query;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/12/java8-NewFeatures/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/12/java8-NewFeatures/" itemprop="url">
                  java8-NewFeatures
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-12T21:51:24+08:00">
                2017-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/11/12/java8-NewFeatures/" class="leancloud_visitors" data-flag-title="java8-NewFeatures">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>java9已经发布一段时间了，AndroidStudio才开始支持Java 8，Java 8是Java的一个重大版本，虽然这些新特性令Java开发人员十分期待，但同时也需要花不少精力去学习，对于android开发者而言了解Java8的新特性是必要的，虽然现在Google力推kotlin，但是Java仍然是排名第一的使用最广泛的语言，社区依旧很活跃，也是处于不断进步和发展中，而且在新特性中我们能看到一些kotlin的影子。</p>
<h1 id="lambda表达式的支持"><a href="#lambda表达式的支持" class="headerlink" title="lambda表达式的支持"></a>lambda表达式的支持</h1><p>格式为：(入参) -&gt; {函数体}</p>
<h2 id="基本形式："><a href="#基本形式：" class="headerlink" title="基本形式："></a>基本形式：</h2><p>入参和返回值的类型可被编译器推测，入参一个参数不需要括号，无参直接写为<code>（）</code>，函数体多行可加上括号<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; a + b;</div><div class="line">(a, b) -&gt; a - b;</div><div class="line">(<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; &#123; <span class="keyword">return</span> a * b; &#125;;</div></pre></td></tr></table></figure></p>
<h2 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h2><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p>以前的写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (String player : players) &#123;  </div><div class="line">     System.out.print(player + <span class="string">"; "</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>lambda写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">players.forEach((player) -&gt; System.out.print(player + <span class="string">"; "</span>));</div></pre></td></tr></table></figure></p>
<h3 id="ui回调"><a href="#ui回调" class="headerlink" title="ui回调"></a>ui回调</h3><p>以前的写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">check_all.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">               </div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure></p>
<p>lambda写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">check_all.setOnClickListener(v-&gt;&#123;&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h3><p>以前的写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"Hello world !"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;).start();</div></pre></td></tr></table></figure></p>
<p>lambda写法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"Hello world !"</span>)).start();</div></pre></td></tr></table></figure></p>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>以前的写法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Arrays.sort(players, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String s1, String s2)</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> (s1.length() - s2.length());  </div><div class="line">    &#125;  </div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>lambda写法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Arrays.sort(players, (String s1, String s2) -&gt; (s1.length() - s2.length()));</div></pre></td></tr></table></figure></p>
<h3 id="结合Stream"><a href="#结合Stream" class="headerlink" title="结合Stream"></a>结合Stream</h3><p>Stream是对集合的包装，通常和lambda一起使用。 使用lambdas可以支持许多操作,如 map, filter, limit, sorted, count, min, max, sum, collect 等等。<br>定义一个类，医生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Doctor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</div><div class="line">    <span class="keyword">private</span> String degree;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> salary;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Doctor</span><span class="params">(String name, <span class="keyword">int</span> age, String degree, <span class="keyword">int</span> salary)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.age = age;</div><div class="line">        <span class="keyword">this</span>.degree = degree;</div><div class="line">        <span class="keyword">this</span>.salary = salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.age = age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDegree</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> degree;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDegree</span><span class="params">(String degree)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.degree = degree;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSalary</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> salary;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSalary</span><span class="params">(<span class="keyword">int</span> salary)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.salary = salary;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先初始化医生列表，foreach循环输出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">List&lt;Doctor&gt; doctors =<span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"joe"</span>,<span class="number">20</span>,<span class="string">"bachelor"</span>,<span class="number">2000</span>));</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"jack"</span>,<span class="number">23</span>,<span class="string">"bachelor"</span>,<span class="number">2300</span>));</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"kris"</span>,<span class="number">27</span>,<span class="string">"Master"</span>,<span class="number">4200</span>));</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"bob"</span>,<span class="number">28</span>,<span class="string">"doctor"</span>,<span class="number">5000</span>));</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"tom"</span>,<span class="number">26</span>,<span class="string">"Master"</span>,<span class="number">4400</span>));</div><div class="line"> doctors.add(<span class="keyword">new</span> Doctor(<span class="string">"jay"</span>,<span class="number">29</span>,<span class="string">"doctor"</span>,<span class="number">5500</span>));</div><div class="line"></div><div class="line"> doctors.forEach(</div><div class="line">         (doctor)-&gt;&#123;</div><div class="line">             System.out.println(doctor.getName());</div><div class="line"></div><div class="line">         &#125;</div><div class="line">         );</div></pre></td></tr></table></figure></p>
<p>过滤器filter()，过滤出年龄大于25岁且学历为博士的医生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">doctors.stream().filter( doctor -&gt; doctor.getAge()&gt;<span class="number">25</span>)</div><div class="line">                .filter(doctor -&gt; <span class="string">"doctor"</span>.equals(doctor.getDegree()))</div><div class="line">                .forEach(doctor -&gt; System.out.println(doctor.getName()));</div></pre></td></tr></table></figure></p>
<p>limit方法，限制结果个数，年龄大于25的前三个医生<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">doctors.stream().filter( doctor -&gt; doctor.getAge()&gt;<span class="number">25</span>)</div><div class="line">              .limit(<span class="number">3</span>)</div><div class="line">              .forEach(doctor -&gt; System.out.println(doctor.getName()));</div></pre></td></tr></table></figure></p>
<p>sorted方法，按薪水由多到少排序<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">doctors.stream().sorted((d1,d2)-&gt;d2.getSalary()-d1.getSalary())</div><div class="line">        .forEach(</div><div class="line">                (doctor)-&gt;&#123;</div><div class="line">                    System.out.println(doctor.getName());</div><div class="line">                &#125;</div><div class="line">        );</div></pre></td></tr></table></figure></p>
<p>min和max方法，找出最低和最高的薪水<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Doctor doctor1=doctors.stream().min((d1,d2)-&gt;d1.getSalary()-d2.getSalary()).get();</div><div class="line">System.out.print(doctor1.getName());</div><div class="line"></div><div class="line">Doctor doctor2=doctors.stream().min((d1,d2)-&gt;d1.getSalary()-d2.getSalary()).get();</div><div class="line">System.out.print(doctor2.getName());</div></pre></td></tr></table></figure></p>
<p>结合 map 方法,使用 collect 方法来将我们的结果集放到一个字符串,一个 Set 中<br>将所有医生的名字拼接在一个string中，用逗号隔开<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String names=doctors.stream().map(Doctor::getName).collect(joining(<span class="string">","</span>));</div><div class="line">System.out.print(names);</div></pre></td></tr></table></figure></p>
<p>将所有医生的名字存放到一个set中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Set&lt;String&gt; doctorSet=doctors.stream().map(Doctor::getName).collect(Collectors.toSet());</div><div class="line">octorSet.forEach((name)-&gt;System.out.println(name));</div></pre></td></tr></table></figure></p>
<p>summaryStatistics方法获得stream中元素的汇总数据，求和，平均值，最大最小值，个数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">IntSummaryStatistics statistics=doctors.stream()</div><div class="line">                .mapToInt(doctor-&gt;doctor.getSalary())</div><div class="line">                .summaryStatistics();</div><div class="line">System.out.println(statistics.getSum());</div><div class="line">System.out.println(statistics.getAverage());</div><div class="line">System.out.println(statistics.getMax());</div><div class="line">System.out.println(statistics.getMin());</div><div class="line">System.out.println(statistics.getCount());</div></pre></td></tr></table></figure></p>
<h1 id="接口的默认方法和静态方法"><a href="#接口的默认方法和静态方法" class="headerlink" title="接口的默认方法和静态方法"></a>接口的默认方法和静态方法</h1><p>默认方法和抽象方法之间的区别在于抽象方法需要实现，而默认方法不需要。接口提供的默认方法可以被接口的实现类继承或者覆写。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">defaultMethod</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"this is default method"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> <span class="keyword">implements</span> <span class="title">MyInterface</span></span>&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在接口中可以定义静态方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">default</span> String <span class="title">defaultMethod</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"this is default method"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">static</span> String <span class="title">staticMethod</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"this is static method"</span>;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="方法的引用方式"><a href="#方法的引用方式" class="headerlink" title="方法的引用方式"></a>方法的引用方式</h1><p>初始化数组<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Function&lt;Integer, String[]&gt; fun = x -&gt; <span class="keyword">new</span> String[x];</div><div class="line">String[] strs = fun.apply(<span class="number">10</span>);</div><div class="line">System.out.println(strs.length);</div><div class="line">Function&lt;Integer,String[]&gt; fun1 = String[]::<span class="keyword">new</span>;</div><div class="line">strs = fun1.apply(<span class="number">20</span>);</div><div class="line">System.out.println(strs.length);</div></pre></td></tr></table></figure></p>
<p>构造方法的引用 Class::new只针对无参构造，若该类只有有参构造，需要添加一个无参构造方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Supplier&lt;Student&gt; supplier=Student::<span class="keyword">new</span>;</div><div class="line">Student student=supplier.get();</div><div class="line">student.setName(<span class="string">"小明"</span>);</div><div class="line">System.out.println(student.getName());</div></pre></td></tr></table></figure></p>
<p>有参构造调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Supplier&lt;Student&gt; supplier=()-&gt;<span class="keyword">new</span> Student(<span class="string">"小张"</span>,<span class="string">"man"</span>,<span class="number">12</span>);</div><div class="line">Student student=supplier.get();</div><div class="line">System.out.println(student.getName());</div></pre></td></tr></table></figure></p>
<p>静态方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Supplier&lt;String&gt; supplier=Student::saying;</div><div class="line">System.out.println(supplier.get());</div></pre></td></tr></table></figure></p>
<p>成员方法调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Supplier&lt;Student&gt; supplier=Student::<span class="keyword">new</span>;</div><div class="line">Student student=supplier.get();</div><div class="line">Consumer&lt;String&gt; consumer1=student::setName;</div><div class="line">consumer1.accept(<span class="string">"小明"</span>);</div><div class="line">Consumer&lt;Integer&gt; consumer2=student::setAge;</div><div class="line">consumer2.accept(<span class="number">18</span>);</div><div class="line">System.out.println(student.getName()+<span class="string">":"</span>+student.getAge());</div></pre></td></tr></table></figure></p>
<h1 id="注解的变化"><a href="#注解的变化" class="headerlink" title="注解的变化"></a>注解的变化</h1><h2 id="支持重复注解"><a href="#支持重复注解" class="headerlink" title="支持重复注解"></a>支持重复注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Filter</span>( <span class="string">"filter1"</span> )</div><div class="line"><span class="meta">@Filter</span>( <span class="string">"filter2"</span> )</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filterable</span> </span>&#123;        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Filterable.class.getAnnoation(Filters.class)</div></pre></td></tr></table></figure></p>
<p>控制台输出：<br>filter1<br>filter2</p>
<h2 id="注解使用范围扩大"><a href="#注解使用范围扩大" class="headerlink" title="注解使用范围扩大"></a>注解使用范围扩大</h2><p>java8可以使用在任何元素上：局部变量、方法、接口、类和泛型，甚至可以用在函数的异常定义上。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>( RetentionPolicy.RUNTIME )</div><div class="line"><span class="meta">@Target</span>( &#123; ElementType.TYPE_USE, ElementType.TYPE_PARAMETER &#125; )</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NonEmpty &#123;        </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span>&lt; @<span class="title">NonEmpty</span> <span class="title">T</span> &gt; <span class="keyword">extends</span> @<span class="title">NonEmpty</span> <span class="title">Object</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> <span class="keyword">throws</span> @NonEmpty Exception </span>&#123;            </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>( <span class="string">"unused"</span> )</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Holder&lt; String &gt; holder = <span class="keyword">new</span> <span class="meta">@NonEmpty</span> Holder&lt; String &gt;();        </div><div class="line">    <span class="meta">@NonEmpty</span> Collection&lt; <span class="meta">@NonEmpty</span> String &gt; strings = <span class="keyword">new</span> ArrayList&lt;&gt;();        </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h1 id="Map新增方法"><a href="#Map新增方法" class="headerlink" title="Map新增方法"></a>Map新增方法</h1><p>初始化一个map<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Map&lt;Integer, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">map.put(<span class="number">1</span>, <span class="string">"Tom"</span>);</div><div class="line">map.put(<span class="number">2</span>, <span class="string">"Bob"</span>);</div><div class="line">map.put(<span class="number">3</span>, <span class="string">"Jack"</span>);</div></pre></td></tr></table></figure></p>
<h2 id="forEach-遍历"><a href="#forEach-遍历" class="headerlink" title="forEach 遍历"></a>forEach 遍历</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">map.forEach((key,value)-&gt;System.out.println(key+<span class="string">":"</span>+value));</div></pre></td></tr></table></figure>
<h2 id="getOrDefault"><a href="#getOrDefault" class="headerlink" title="getOrDefault"></a>getOrDefault</h2><p>如果指定的key存在，则返回该key对应的value，如果不存在，则返回指定的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(map.getOrDefault(<span class="number">4</span>, <span class="string">"name"</span>));</div></pre></td></tr></table></figure></p>
<h2 id="replaceAll修改所有的value值"><a href="#replaceAll修改所有的value值" class="headerlink" title="replaceAll修改所有的value值"></a>replaceAll修改所有的value值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//所有value前面加上一个编号</span></div><div class="line">map.replaceAll((key,value)-&gt;<span class="string">"20000"</span>+key+value);</div><div class="line">map.forEach((key,value)-&gt;System.out.println(key+<span class="string">":"</span>+value));</div></pre></td></tr></table></figure>
<h2 id="putIfAbsent返回key对应的value，如果value为空则填入一个值"><a href="#putIfAbsent返回key对应的value，如果value为空则填入一个值" class="headerlink" title="putIfAbsent返回key对应的value，如果value为空则填入一个值"></a>putIfAbsent返回key对应的value，如果value为空则填入一个值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map.putIfAbsent(<span class="number">3</span>, <span class="string">"xiaoming"</span>);</div><div class="line">map.putIfAbsent(<span class="number">4</span>, <span class="string">"xiaoming"</span>);</div><div class="line"><span class="comment">//Jack</span></div><div class="line">System.out.println(map.get(<span class="number">3</span>));</div><div class="line"><span class="comment">//xiaoming</span></div><div class="line">System.out.println(map.get(<span class="number">4</span>));</div></pre></td></tr></table></figure>
<h2 id="remove指定元素删除"><a href="#remove指定元素删除" class="headerlink" title="remove指定元素删除"></a>remove指定元素删除</h2><p>如果key获取的value值与给的value值相等，则删除这个元素<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">map.remove(<span class="number">1</span>, <span class="string">"Bob"</span>);</div><div class="line"><span class="comment">// 未删除成功， 输出 Tom</span></div><div class="line">System.out.println(map.get(<span class="number">1</span>));</div><div class="line"></div><div class="line">map.remove(<span class="number">2</span>, <span class="string">"Bob"</span>);</div><div class="line"><span class="comment">// 删除成功，输出 null</span></div><div class="line">System.out.println(map.get(<span class="number">2</span>))</div></pre></td></tr></table></figure></p>
<h2 id="replace替换"><a href="#replace替换" class="headerlink" title="replace替换"></a>replace替换</h2><p>如果key获取的value值与给的value值相等，则把这个value替换成一个新的value<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map.replace(<span class="number">3</span>, <span class="string">"Tom"</span>, <span class="string">"Joe"</span>);</div><div class="line"><span class="comment">// 未替换成功，输出 Jack</span></div><div class="line">System.out.println(map.get(<span class="number">3</span>));</div><div class="line">map.replace(<span class="number">1</span>, <span class="string">"Tom"</span>, <span class="string">"Joe"</span>);</div><div class="line"><span class="comment">// 替换成功， 输出 Joe</span></div><div class="line">System.out.println(map.get(<span class="number">1</span>));</div></pre></td></tr></table></figure></p>
<p>如果map中存在key，则替换成value值，替换成功返回旧值，否则返回null<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//输出Tom</span></div><div class="line">System.out.println( map.replace(<span class="number">1</span>, <span class="string">"Joe"</span>));</div><div class="line"><span class="comment">//输出Joe</span></div><div class="line">System.out.println( map.get(<span class="number">1</span>));</div><div class="line"><span class="comment">//输出null</span></div><div class="line">System.out.println( map.replace(<span class="number">4</span>, <span class="string">"Joe"</span>));</div><div class="line"><span class="comment">//输出null</span></div><div class="line">System.out.println( map.get(<span class="number">4</span>));</div></pre></td></tr></table></figure></p>
<h2 id="computeIfAbsent"><a href="#computeIfAbsent" class="headerlink" title="computeIfAbsent"></a>computeIfAbsent</h2><p>如果指定的key不存在，则可通过key计算value为新的值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map.computeIfAbsent(<span class="number">1</span>,key-&gt;key+<span class="string">"newName"</span>);</div><div class="line"><span class="comment">//输出Tom</span></div><div class="line">System.out.println(map.get(<span class="number">1</span>));</div><div class="line">map.computeIfAbsent(<span class="number">4</span>,key-&gt;key+<span class="string">"newName"</span>);</div><div class="line"><span class="comment">//输出4newName</span></div><div class="line">System.out.println(map.get(<span class="number">4</span>));</div></pre></td></tr></table></figure></p>
<h2 id="computeIfPresent"><a href="#computeIfPresent" class="headerlink" title="computeIfPresent"></a>computeIfPresent</h2><p>如果指定的key存在，则根据key和value计算一个新的newValue, 如果这个newValue不为null，则设置key新的值为这个newValue, 如果newValue为null, 则删除该key的值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">map.computeIfPresent(<span class="number">1</span>, (key, value) -&gt; key + <span class="string">"新的值:"</span> + value);</div><div class="line"><span class="comment">// 输出1新的值:Tom</span></div><div class="line">System.out.println(map.get(<span class="number">1</span>));</div><div class="line"></div><div class="line">map.computeIfPresent(<span class="number">2</span>, (key, value) -&gt; <span class="keyword">null</span>);</div><div class="line"><span class="comment">// 输出 null</span></div><div class="line">System.out.println(map.get(<span class="number">2</span>));</div></pre></td></tr></table></figure></p>
<h2 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h2><p>如果指定的key不存在，则设置指定的value值，否则根据key和value计算一个新的newValue, 如果这个newValue不为null，则设置key新的值为这个newValue, 如果newValue为null, 则删除该key的值。<br>这个解释有点长，容易绕，实际上用if-else可以很简单的表达<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!key.exist())&#123;</div><div class="line">   map.computeIfAbsent(key,key-&gt;key+<span class="string">"newValue"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span>&#123;</div><div class="line">   map.computeIfPresent(key, (key, value) -&gt; key + <span class="string">"新的值:"</span> + value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以就是if key不存在，调computeIfAbsent，否则调computeIfPresent<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">map.compute(<span class="number">4</span>,(key,value)-&gt;key+<span class="string">":"</span>+value+<span class="string">"新的值"</span>);</div><div class="line"><span class="comment">//输出 4:null新的值</span></div><div class="line">System.out.println(map.get(<span class="number">4</span>));</div><div class="line">map.compute(<span class="number">1</span>,(key,value)-&gt;key+<span class="string">":"</span>+<span class="string">"新的值"</span>);</div><div class="line"><span class="comment">//输出 1:新的值</span></div><div class="line">System.out.println(map.get(<span class="number">1</span>));</div></pre></td></tr></table></figure></p>
<h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><p>如果指定的key不存在，直接设置指定值，如果存在根据旧的value，指定值计算出新的值newValue, 如果这个newValue不为空，设置key的新值newValue，如果newValue为null, 则删除该key。最后返回当前最新的值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">//输出 指定的名字</span></div><div class="line">System.out.println(map.merge(<span class="number">4</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;oldValue+<span class="string">","</span>+assignValue));</div><div class="line"><span class="comment">//输出 Tom,指定的名字</span></div><div class="line">System.out.println(map.merge(<span class="number">1</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;oldValue+<span class="string">","</span>+assignValue));</div><div class="line"><span class="comment">//输出 null</span></div><div class="line">System.out.println(map.merge(<span class="number">1</span>,<span class="string">"指定的名字"</span>,(oldValue,assignValue)-&gt;<span class="keyword">null</span>));</div></pre></td></tr></table></figure></p>
<h1 id="空指针判断类Optional"><a href="#空指针判断类Optional" class="headerlink" title="空指针判断类Optional"></a>空指针判断类Optional</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">String str1=<span class="keyword">null</span>;</div><div class="line">String str2=<span class="string">"abc"</span>;</div><div class="line"><span class="comment">//创建初始化Optional对象，可为空的</span></div><div class="line">Optional&lt;String&gt; optionalStr1=Optional.ofNullable(str1);</div><div class="line"><span class="comment">//创建初始化Optional对象，不可为空，会抛异常</span></div><div class="line">Optional&lt;String&gt; optionalStr2=Optional.of(str2);</div><div class="line">System.out.println(<span class="string">"第一个参数是否存在"</span>+optionalStr1.isPresent());</div><div class="line">System.out.println(<span class="string">"第二个参数是否存在"</span>+optionalStr2.isPresent());</div><div class="line"><span class="comment">//不存在时返回默认值，存在时返回该值</span></div><div class="line">String getStr1=optionalStr1.orElse(<span class="string">"这个值不存在的默认值"</span>);</div><div class="line"><span class="comment">//返回该值，该值必须存在</span></div><div class="line">String getStr2=optionalStr2.get();</div><div class="line">System.out.println(getStr1);</div><div class="line">System.out.println(getStr2);</div></pre></td></tr></table></figure>
<h1 id="日期和时间Joda-Time的支持"><a href="#日期和时间Joda-Time的支持" class="headerlink" title="日期和时间Joda-Time的支持"></a>日期和时间Joda-Time的支持</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取当前的日期时间</span></div><div class="line">LocalDateTime currentTime = LocalDateTime.now();</div><div class="line">System.out.println(<span class="string">"当前时间: "</span> + currentTime);</div><div class="line"><span class="comment">// 获取当前日期</span></div><div class="line">LocalDate currentDate = currentTime.toLocalDate();</div><div class="line">System.out.println(<span class="string">"当前日期: "</span> + currentDate);</div><div class="line">System.out.println(<span class="string">"年"</span>+currentDate.getYear()+<span class="string">"月"</span>+currentDate.getMonthOfYear()+<span class="string">"日"</span>+currentDate.getDayOfMonth());</div><div class="line"><span class="comment">// 修改当前时间的月份和年份</span></div><div class="line">currentDate.withYear(<span class="number">2013</span>).withMonthOfYear(<span class="number">3</span>);</div><div class="line">System.out.println(<span class="string">"修改后的日期: "</span> + currentDate);</div><div class="line"><span class="comment">// 日期格式化</span></div><div class="line">System.out.println(currentDate.toString(<span class="string">"yyyy-MM-dd"</span>));</div><div class="line"><span class="comment">// 修改时区</span></div><div class="line">DateTimeZone zoneEurope = DateTimeZone.forID(<span class="string">"Europe/London"</span>);</div><div class="line">DateTime dtLondon = <span class="keyword">new</span> DateTime().withZone(zoneEurope);</div><div class="line">System.out.println(<span class="string">"修改时区: "</span> + dtLondon);</div><div class="line">DateTimeZone currentZone = DateTimeZone.getDefault();</div><div class="line">DateTime dtCurrent = <span class="keyword">new</span> DateTime().withZone(currentZone);</div><div class="line">System.out.println(<span class="string">"当期时区: "</span> + dtCurrent);</div></pre></td></tr></table></figure>
<h1 id="base64支持"><a href="#base64支持" class="headerlink" title="base64支持"></a>base64支持</h1><p>基本编解码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 使用基本编码</span></div><div class="line">        String base64encodedString = Base64.getEncoder().encodeToString(<span class="string">"这是待编码的字符串"</span>.getBytes(<span class="string">"utf-8"</span>));</div><div class="line">        System.out.println(<span class="string">"Base64编码后"</span> + base64encodedString);</div><div class="line">        <span class="comment">// 解码</span></div><div class="line">        <span class="keyword">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(base64encodedString);</div><div class="line">        System.out.println(<span class="string">"原始字符串: "</span> + <span class="keyword">new</span> String(base64decodedBytes, <span class="string">"utf-8"</span>));</div><div class="line">        <span class="comment">//使用url编码</span></div><div class="line">        String base64encodedUrl = Base64.getUrlEncoder().encodeToString(<span class="string">"这是待编码的字符串"</span>.getBytes(<span class="string">"utf-8"</span>));</div><div class="line">        System.out.println(<span class="string">"Base64 URL编码:"</span> + base64encodedUrl);</div><div class="line">        <span class="comment">//生成随机uuid</span></div><div class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; ++i) &#123;</div><div class="line">            stringBuilder.append(UUID.randomUUID().toString());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//使用mime编码</span></div><div class="line">        <span class="keyword">byte</span>[] mimeBytes = stringBuilder.toString().getBytes(<span class="string">"utf-8"</span>);</div><div class="line">        String mimeEncodedString = Base64.getMimeEncoder().encodeToString(mimeBytes);</div><div class="line">        System.out.println(<span class="string">"Base64 MIME编码:"</span> + mimeEncodedString);</div><div class="line">    &#125;<span class="keyword">catch</span>(UnsupportedEncodingException e)&#123;</div><div class="line">        System.out.println(<span class="string">"Error :"</span> + e.getMessage());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/02/genymotion-issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/02/genymotion-issue/" itemprop="url">
                  genymotion-issue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-02T22:14:57+08:00">
                2017-11-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/util/" itemprop="url" rel="index">
                    <span itemprop="name">util</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/11/02/genymotion-issue/" class="leancloud_visitors" data-flag-title="genymotion-issue">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本人是比较喜欢用模拟器调试的，毕竟可以不用对真机进行频繁的插拔，避免USB接触不良的问题，提高开发效率，虽然模拟器测试时仍有很多限制，但是能用模拟器调试的时候还是会尽量选择模拟器。genymotion是一款优秀的android模拟器，依赖于virtual box，是android开发者的必备品。虽然android studio自带的模拟器已经比以前好多了，但是仍然不是很稳定，莫名重启的情况频频发生，所以genymotion依然是最好的选择。但是目前的genymotion版本都是基于x86架构的，你是否还在为它安装不上输入法和微信而烦恼？那是因为市面上的绝大多数手机都是基于arm架构的，大多数的so库也是仅支持ARM架构，要想让ARM架构的应用在genymotion上跑起来，需要刷ARM_Translation架构包来达到兼容的效果。</p>
<p>genymotion有一个坑就是不同版本的android系统需要刷对应版本的ARM_Translation架构包，否则即使提示刷入成功，仍然是没有效果，应用依旧安装失败。下面是我收集的各个版本的ARM_Translation架构包，亲测可用：</p>
<p><a href="https://pan.baidu.com/s/1eSyBfea" target="_blank" rel="external">https://pan.baidu.com/s/1eSyBfea</a></p>
<p>里面有3个文件：</p>
<p><code>Genymotion_ARM_Translation_Marshmallow.zip</code> 适配android6.0和7.0</p>
<p><code>Genymotion_ARM_Translation_5.1_Lollipop</code> 适配android5.1</p>
<p><code>Genymotion-ARM-Translation_v1.1.zip</code> 适配android5.0以下</p>
<p>安装方法很简单，直接把zip包拖到模拟器即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/10/react-native-issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/10/react-native-issue/" itemprop="url">
                  react-native issue
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T21:57:33+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/" itemprop="url" rel="index">
                    <span itemprop="name">framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/10/react-native-issue/" class="leancloud_visitors" data-flag-title="react-native issue">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>随着近几年web前端的火热，纯原生的开发需求逐渐减少，混合开发也变得越来越流行。连最近刷论坛也传着不会前端的android开发不是好的开发者这么一句话。上一个项目快要结束，最近也闲下来了，带着对前端的好奇和提升自身技术的想法，入了混合开发的坑。react-native是Facebook打造的一款开源的跨平台移动应用开发框架，作为最火的跨平台移动应用开发开发框架，官网上写着Learn once, write anywhere，吸引了大批开发者。它弥补了web app性能上的缺陷，调用原生组件，利用javascript开发，支持热更新，跨平台的特性也降低了开发成本。但是目前存在少量bug，我在入门学习的时候也遇到了不少坑，下面做简要记录。</p>
<hr>
<h1 id="xcode编译时报错"><a href="#xcode编译时报错" class="headerlink" title="xcode编译时报错"></a>xcode编译时报错</h1><p>1.’boost/xxx/xxx.hpp’ file not found</p>
<p>由于 /Users/Vanessa/.rncache 中 boost_1_63_0.tar.gz， double-conversion-1.1.5.tar.gz， folly-2016.09.26.00.tar.gz， glog-0.3.4.tar.gz 文件下载不完整</p>
<p>导致 node_modules/react-native/third-party 文件不完整</p>
<p>解决方案：</p>
<p>删除 .rncache 后手动下载一份，后放入 .rncache 中</p>
<p>把以上文件解压后放入 node_modules/react-native/third-party 下</p>
<p>Clean &amp; Build</p>
<p>2.”config.h” file not found<br> 解决方案：<br> 项目目录下执行npm install</p>
<p>之前在网上查到要在package.json中改react-native的版本号，我这边改了反倒报错</p>
<h1 id="android-studio报错"><a href="#android-studio报错" class="headerlink" title="android studio报错"></a>android studio报错</h1><h2 id="编译报错"><a href="#编译报错" class="headerlink" title="编译报错"></a>编译报错</h2><p>1.unable to load script form assets</p>
<p>解决方案：</p>
<p>在 android/app/src/main 目录下创建一个 assets空文件夹</p>
<p>在跟目录下执行</p>
<p><code>react-native bundle --platform android --dev false --entry-file index.android.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res/</code></p>
<h2 id="点击菜单刷新报错"><a href="#点击菜单刷新报错" class="headerlink" title="点击菜单刷新报错"></a>点击菜单刷新报错</h2><p>红屏显示Could not connect to development server</p>
<p>解决方案：</p>
<p>react-native start</p>
<p>在公司的windows上配置环境，android平台始终报这个错，各种方案都试过了</p>
<p>最后的解决方案是：</p>
<p>在android设备的菜单中选择最后一个选项，配置编译机器的ip地址和端口号8081。</p>
<p>注意：6.0以上的模拟器不要忘记连上wifi</p>
<p>###记2017.12.20爬坑 </p>
<p>当你的app有多张图片时，如果你发现在android机上某些图片显示不出，不管是嵌套在需要loadmore的listview,还是性能更高的升级版flatlist以及scrollview，这种类似图片长列表加载到固定页数，后面偶尔只能显示出一两张这种问题，是由于内存问题导致的，最简单的解决办法，分配更大的堆内存，在Android的AndroidManifest配置文件中开启largeHeap，在<code>application</code>标签下添加<code>android:largeHeap=&quot;true&quot;</code>即可，整个过程没有任何警告和错误，真的是太坑了。</p>
<h3 id="记2018-1-18爬坑"><a href="#记2018-1-18爬坑" class="headerlink" title="记2018.1.18爬坑"></a>记2018.1.18爬坑</h3><p>react-native Android真机调试技巧：</p>
<p>目前网上这块的资料比较少，基本都是如官网所说摇一摇或者是通过adb命令发送一个双击R的输入事件</p>
<p>然而这并不实用，真机调试的时候经常都是连着数据线，每次reload都要摇一摇触发难度系数比较高，输入adb命令显得过于麻烦。实际上我们使用reactnative绘制的activity都是继承了ReactActivity，查看一下源码，它重写了按键监听，我们可以看到这样的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> mDelegate.onKeyUp(keyCode, event) || <span class="keyword">super</span>.onKeyUp(keyCode, event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们点击进去<code>mDelegate.onKeyUp(keyCode, event)</code>继续跟踪，可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (getReactNativeHost().hasInstance() &amp;&amp; getReactNativeHost().getUseDeveloperSupport()) &#123;</div><div class="line">    <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_MENU) &#123;</div><div class="line">      getReactNativeHost().getReactInstanceManager().showDevOptionsDialog();</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">boolean</span> didDoubleTapR = Assertions.assertNotNull(mDoubleTapReloadRecognizer)</div><div class="line">      .didDoubleTapR(keyCode, getPlainActivity().getCurrentFocus());</div><div class="line">    <span class="keyword">if</span> (didDoubleTapR) &#123;</div><div class="line">      getReactNativeHost().getReactInstanceManager().getDevSupportManager().handleReloadJS();</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以我们点菜单键调用的是<code>getReactNativeHost().getReactInstanceManager().showDevOptionsDialog();</code>弹出调试菜单。</p>
<p>我们双击R键，调用的是<code>getReactNativeHost().getReactInstanceManager().getDevSupportManager().handleReloadJS();</code>进行reload刷新。</p>
<p>这两个方法在ReactActivity直接调用，纯react-native搭建的项目，我们可以在onCreate时调用方便调试。</p>
<p>如果是在混合开发的项目，onCreate方法中我们有自己的ReactInstanceManager，可以直接调用 <code>mReactInstanceManager.getDevSupportManager().handleReloadJS();</code>菜单弹出也一样。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/10/androidComponentStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/10/androidComponentStudy/" itemprop="url">
                  组件化技术学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T10:34:57+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/10/androidComponentStudy/" class="leancloud_visitors" data-flag-title="组件化技术学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>随着Android技术发展越来越成熟，随着热更新技术的火热，组件化和插件化的技术也得到了一定的关注。特别是对于比较大的项目，人员的增多，代码越来越臃肿，这时候就必须进行模块化的拆分。模块化在Android工程中目前有两种实现方式，一种是组件化，另一种是插件化，其实质都是降低耦合。作为Android开发者，有必要对这两种技术做一个了解，在项目需要重构时或在构建大项目初期时，选择合适的模块化方案，下面就对组件化技术学习做一个总结。目前比较流行的组件化方案是阿里的Atlas，得到app的AndroidComponent，插件化比较流行的方案是滴滴的virtual apk，360的replugin。</p>
<hr>
<p>得到团队的AndroidComponent的学习成本较低，对于初学者方便入手，以下记录该框架的学习情况：<br>每个组件都可以看成一个单独的整体，可以按需的和其他组件（包括主项目）整合在一起，从而完成的形成一个app，整体app缺少任何一个组件都是可以正常运行的，并且每个组件可以单独运行。<br>件化和插件化的最大区别（应该也是唯一区别）就是组件化在运行时不具备动态添加和修改组件的功能，但是插件化是可以的。</p>
<h1 id="依赖库与Component的区别"><a href="#依赖库与Component的区别" class="headerlink" title="依赖库与Component的区别"></a>依赖库与Component的区别</h1><h2 id="依赖库library"><a href="#依赖库library" class="headerlink" title="依赖库library"></a>依赖库library</h2><p>代码被其他组件直接引用。比如网络库module可以认为是一个library。</p>
<h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><p>这种module是一个完整的功能模块。比如分享module就是一个Component。<br>统一把library称之为依赖库，把Component称之为组件。组件化也主要是针对Component这种类型。主项目、主module或者Host负责拼装这些组件以形成一个完成app的module，统一称为主项目。</p>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><p>app是主项目，负责集成众多组件，控制组件的生命周期<br>xxxComponent 是我们拆分的两个组件，比如shareComponent<br>componentservice 定义了所有的组件提供的服务<br>basicres 定义了全局通用的theme和color等公共资源<br>basiclib 公共的基础库，统一在这里引入，比如一些第三方的库okhttp<br>componentlib 组件化的基础库 Router/UIRouter等都定义在这里<br>build-gradle 组件化编译的gradle插件</p>
<h1 id="单独调试和发布"><a href="#单独调试和发布" class="headerlink" title="单独调试和发布"></a>单独调试和发布</h1><ol>
<li>在组件工程下的gradle.properties文件中设置一个isRunAlone的变量来区分不同的场景，build.gradle需要引入一个插件，插件中会判断apply com.android.library还是com.android.application</li>
<li>在src/main/runalone下面定义单独调试所必须的AndroidManifest.xml、application、入口activity等类</li>
<li>组件开发并测试完成时，需要发布一个release版本的aar文件到中央仓库，只需要把isRunAlone修改为false，执行module:assembleRelease命令。只有发布组件时才需要修改isRunAlone=false，即使后面将组件集成到app中，也不需要修改isRunAlone的值。所以在Androidstudio中，是可以看到三个application工程的，随便点击一个都是可以独立运行的，并且可以根据配置引入其他需要依赖的组件，这些工作都由插件来完成。</li>
</ol>
<h1 id="组件交互"><a href="#组件交互" class="headerlink" title="组件交互"></a>组件交互</h1><p>组件间数据传输，通过接口+实现的方式，组件之间完全面向接口编程。<br>下面是share提供一个fragment给app使用的例子。<br>share组件在componentservice中定义自己的服务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShareService</span> </span>&#123;</div><div class="line">    <span class="function">Fragment <span class="title">getShareFragment</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在自己的组件工程中，提供对应的实现类ShareServiceImpl：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareServiceImpl</span> <span class="keyword">implements</span> <span class="title">ShareService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Fragment <span class="title">getShareFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShareFragment();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在ShareAppLike中在组件加载的时候把实现类注册到Router中，ShareAppLike相当于组件的application类需要实现IApplicationLike的接口，在IApplicationLike接口中定义onCreate和onStop两个生命周期方法，对应组件的加载和卸载。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareAppLike</span> <span class="keyword">implements</span> <span class="title">IApplicationLike</span> </span>&#123;</div><div class="line">    Router router = Router.getInstance();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.addService(ShareService.class.getSimpleName(), <span class="keyword">new</span> ShareServiceImpl());</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.removeService(ShareService.class.getSimpleName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在app中面向ShareService来编程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Router router = Router.getInstance();</div><div class="line"><span class="keyword">if</span> (router.getService(ShareService.class.getSimpleName()) != <span class="keyword">null</span>) &#123;</div><div class="line">    ShareService service = (ShareService) router.getService(ShareService.class.getSimpleName());</div><div class="line">    fragment = service.getShareFragment();</div><div class="line">    ft = getSupportFragmentManager().beginTransaction();</div><div class="line">    ft.add(R.id.tab_content, fragment).commitAllowingStateLoss();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于组件是动态加载和卸载的，在使用ShareService的需要进行判空处理。我们看到数据的传输是通过一个中央路由Router来实现的，这个Router就是一个HashMap</p>
<h1 id="UI跳转"><a href="#UI跳转" class="headerlink" title="UI跳转"></a>UI跳转</h1><p>页面（activity）的跳转也是通过一个中央路由UIRouter来实现，这里增加了一个优先级的概念。<br>页面的跳转通过短链的方式，跳转到share的activity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIRouter.getInstance().openUri(getActivity(), <span class="string">"componentdemo://share"</span>, <span class="keyword">null</span>);</div></pre></td></tr></table></figure></p>
<p>share组件在自己实现的ShareUIRouter中声明了自己处理这个短链(scheme和host)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCHEME = <span class="string">"componentdemo"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHAREHOST = <span class="string">"share"</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, Uri uri, Bundle bundle)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (uri == <span class="keyword">null</span> || context == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    String host = uri.getHost();</div><div class="line">    <span class="keyword">if</span> (SHAREHOST.equals(host)) &#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(context, ShareActivity.class);</div><div class="line">        intent.putExtras(bundle == <span class="keyword">null</span> ? <span class="keyword">new</span> Bundle() : bundle);</div><div class="line">        context.startActivity(intent);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果已经组件已经响应了这个短链，就返回true，这样更低优先级的组件就不会接收到这个短链。注解生成根据scheme和host跳转的逻辑，如ARouter的开源框架已实现。</p>
<h1 id="集成调试"><a href="#集成调试" class="headerlink" title="集成调试"></a>集成调试</h1><p>由app或者其他组件充当host的角色，引入其他相关的组件一起参与编译，从而测试整个交互流程。app和组件都可以充当host的角色。在这里我们以app为例。</p>
<ol>
<li>在根项目的gradle.properties中增加一个变量mainmodulename，其值就是工程中的主项目，这里是app。设置为mainmodulename的module，isRunAlone永远是true。</li>
<li>在app项目的gradle.properties文件中增加两个变量：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">debugComponent=com.mrzhang.share:sharecomponent</div><div class="line">compileComponent=sharecomponent</div></pre></td></tr></table></figure>
</li>
</ol>
<p>其中debugComponent是debug的时候引入的组件，compileComponent是release下引入的组件。<br>debugComponent引入的组件写法是不同的，组件引入支持两种语法，module直接引用module工程，modulePackage:module，使用componentrelease中已经发布的aar。<br>在集成调试中，要引入的share组件是不需要把自己的isRunAlone修改为false的。一个application工程是不能直接引用（compile）另一个application工程的，所以app和组件都是isRunAlone=true在正常情况下是编译不过的。<br>插件会自动识别当前要调试的具体是哪个组件，然后把其他组件修改为library工程，而且这个修改只在当次编译生效。</p>
<p>通过task来判断判断当前要运行的是app还是哪个组件，判断的规则如下：<br>assembleRelease → app<br>app:assembleRelease或者 :app:assembleRelease → app<br>sharecomponent:assembleRelease 或者:sharecomponent:assembleRelease→ sharecomponent<br>这样每个组件可以直接在Androidstudio中run，也可以使用命令进行打包，不需要修改任何配置，却可以自动引入依赖的组件，在开发中可以提高工作效率。</p>
<h1 id="代码边界"><a href="#代码边界" class="headerlink" title="代码边界"></a>代码边界</h1><p>依赖的组件集成到host中，本质还是使用compile project（…）或者compile modulePackage:module@aar。不直接在build.gradle中直接引入是为了组件之间的完全隔离，可以称之为代码边界。为了避免直接引入实现类来编程，绕过了面向接口编程的约束。<br>从task入手，只有在assemble任务的时候才进行compile引入。这样在代码的开发期间，组件是完全不可见的。具体的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 自动添加依赖，只在运行assemble任务的才会添加依赖，在开发期间组件之间是完全无感知，做到完全隔离的关键</div><div class="line"> * module直接引用module工程，modulePackage:module，使用componentrelease中已经发布的aar</div><div class="line"> * <span class="doctag">@param</span> assembleTask</div><div class="line"> * <span class="doctag">@param</span> project</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">compileComponents</span><span class="params">(AssembleTask assembleTask, Project project)</span> </span>&#123;</div><div class="line">    String components;</div><div class="line">    <span class="keyword">if</span> (assembleTask.isDebug) &#123;</div><div class="line">        components = (String) project.properties.get(<span class="string">"debugComponent"</span>)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        components = (String) project.properties.get(<span class="string">"compileComponent"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (components == <span class="keyword">null</span> || components.length() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    String[] compileComponents = components.split(<span class="string">","</span>)</div><div class="line">    <span class="keyword">if</span> (compileComponents == <span class="keyword">null</span> || compileComponents.length == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String str : compileComponents) &#123;</div><div class="line">        <span class="keyword">if</span> (str.contains(<span class="string">":"</span>)) &#123;</div><div class="line">            File file = project.file(<span class="string">"../componentrelease/"</span> + str.split(<span class="string">":"</span>)[<span class="number">1</span>] + <span class="string">"-release.aar"</span>)</div><div class="line">            <span class="keyword">if</span> (file.exists()) &#123;</div><div class="line">                project.dependencies.add(<span class="string">"compile"</span>, str + <span class="string">"-release@aar"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(str + <span class="string">" not found ! maybe you should generate a new one "</span>)</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            project.dependencies.add(<span class="string">"compile"</span>, project.project(<span class="string">':'</span> + str))</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><p>集成调试，可以在打包的时候把依赖的组件参与编译，此时反编译apk的代码会看到各个组件的代码和资源都已经包含在包里面。但是由于每个组件的唯一入口ApplicationLike还没有执行oncreate()方法，所以组件并没有把自己的服务注册到中央路由，因此组件实际上是不可达的。</p>
<p>加载组件目前插件提供了两种方式，字节码插入和反射调用。</p>
<h2 id="字节码插入模式"><a href="#字节码插入模式" class="headerlink" title="字节码插入模式"></a>字节码插入模式</h2><p>在dex生成之前，扫描所有的ApplicationLike类，它有一个共同的父类，然后通过javassist在主项目的Application.onCreate()中插入调用ApplicationLike.onCreate()的代码。这样就相当于每个组件在application启动的时候就加载起来了。</p>
<h2 id="反射调用的方式"><a href="#反射调用的方式" class="headerlink" title="反射调用的方式"></a>反射调用的方式</h2><p>手动在Application.onCreate()中或者在其他合适的时机手动通过反射的方式来调用ApplicationLike.onCreate()。比起字节码插入，这种方式有两个好处，一是字节码插入对代码进行扫描和插入会增加编译的时间，在debug的时候会影响效率，并且这种模式对Instant Run支持不好；二是可以更灵活的控制加载或者卸载时机。<br>这两种模式的配置是通过配置插件的Extension来实现的，下面是字节码插入的模式下的配置格式，添加applicatonName的目的是加快定位Application的速度。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">combuild &#123;</div><div class="line">    applicatonName = <span class="string">'com.mrzhang.component.application.AppApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="组件化集成步骤"><a href="#组件化集成步骤" class="headerlink" title="组件化集成步骤"></a>组件化集成步骤</h1><p>以官方的demo为例子：</p>
<ol>
<li><p>将项目中的所有第三方库引用添加到basiclib的build.gradle</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'com.squareup.okhttp3:okhttp:3.4.1'</span></div><div class="line">compile <span class="string">'com.squareup.picasso:picasso:2.5.2'</span></div></pre></td></tr></table></figure>
</li>
<li><p>将项目中的公共资源如颜色，字符串，风格 ，主要是values里面的东西迁移到basicres</p>
</li>
<li>导入gradle插件<br>ComExtension 是否自动注册管理<br>ComBuild gradle task 对组件进行打包<br>ComCodeTransform ConvertUtils 工具类</li>
<li>componentlib 组件化的基础库 Router/UIRouter的实现</li>
<li><p>componentservice 定义组件提供的服务接口声明，这里是阅读组件提供了一个fragment</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReadBookService</span> </span>&#123;</div><div class="line">    <span class="function">Fragment <span class="title">getReadBookFragment</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>readerComponent<br>ui路由的注册，实现IApplicationLike接口，此处使用的是默认的ui路由</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderAppLike</span> <span class="keyword">implements</span> <span class="title">IApplicationLike</span> </span>&#123;</div><div class="line"></div><div class="line">    Router router = Router.getInstance();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.addService(ReadBookService.class.getSimpleName(), <span class="keyword">new</span> ReadBookServiceImpl());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.removeService(ReadBookService.class.getSimpleName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>实现提供的ReadBookService接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadBookServiceImpl</span> <span class="keyword">implements</span> <span class="title">ReadBookService</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Fragment <span class="title">getReadBookFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReaderFragment();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要提供的fragment实现，点击后跳转到share的activity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View rootView;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreateView(inflater, container, savedInstanceState);</div><div class="line">        <span class="keyword">if</span> (rootView == <span class="keyword">null</span>) &#123;</div><div class="line">            rootView = inflater.inflate(R.layout.readerbook_fragment_reader, container,</div><div class="line">                    <span class="keyword">false</span>);</div><div class="line">            rootView.findViewById(R.id.tv_content).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                    UIRouter.getInstance().openUri(getActivity(), <span class="string">"componentdemo://share"</span>, <span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> rootView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>shareComponent<br>ui路由的注册，实现IApplicationLike接口，使用的是自定义的ui路由<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareApplike</span> <span class="keyword">implements</span> <span class="title">IApplicationLike</span> </span>&#123;</div><div class="line"></div><div class="line">    UIRouter uiRouter = UIRouter.getInstance();</div><div class="line">    ShareUIRouter shareUIRouter = ShareUIRouter.getInstance();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        uiRouter.registerUI(shareUIRouter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        uiRouter.unregisterUI(shareUIRouter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>自定义ui路由，实现IComponentRouter接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareUIRouter</span> <span class="keyword">implements</span> <span class="title">IComponentRouter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCHME = <span class="string">"componentdemo"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHAREHOST = <span class="string">"share"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] HOSTS = <span class="keyword">new</span> String[]&#123;SHAREHOST&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ShareUIRouter instance = <span class="keyword">new</span> ShareUIRouter();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ShareUIRouter</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ShareUIRouter <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, String url, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(url) || context == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> openUri(context, Uri.parse(url), bundle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, Uri uri, Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (uri == <span class="keyword">null</span> || context == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        String host = uri.getHost();</div><div class="line">        <span class="keyword">if</span> (SHAREHOST.equals(host)) &#123;</div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(context, ShareActivity.class);</div><div class="line">            intent.putExtras(bundle == <span class="keyword">null</span> ? <span class="keyword">new</span> Bundle() : bundle);</div><div class="line">            context.startActivity(intent);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyUri</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">        String scheme = uri.getScheme();</div><div class="line">        String host = uri.getHost();</div><div class="line">        <span class="keyword">if</span> (SCHME.equals(scheme)) &#123;</div><div class="line">            <span class="keyword">for</span> (String str : HOSTS) &#123;</div><div class="line">                <span class="keyword">if</span> (str.equals(host)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>activity的具体实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.share_activity_share);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后在主app中调用：<br>使用shareComponent提供的fragment<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Router router = Router.getInstance();</div><div class="line">       <span class="keyword">if</span> (router.getService(ReadBookService.class.getSimpleName()) != <span class="keyword">null</span>) &#123;</div><div class="line">           ReadBookService service = (ReadBookService) router.getService(ReadBookService.class.getSimpleName());</div><div class="line">           fragment = service.getReadBookFragment();</div><div class="line">           ft = getSupportFragmentManager().beginTransaction();</div><div class="line">           ft.add(R.id.tab_content, fragment).commitAllowingStateLoss();</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>注册activity<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Router.registerComponent(<span class="string">"com.mrzhang.share.applike.ShareApplike"</span>);</div></pre></td></tr></table></figure></p>
<h1 id="Router实现解析"><a href="#Router实现解析" class="headerlink" title="Router实现解析"></a>Router实现解析</h1><p>不管是哪个组件化方案，路由技术都是必不可少的，得到团队的这个方案路由未采用第三方，且实现了动态加载和卸载，确实不错。</p>
<ol>
<li><p>定义组件ui路由接口，组件自定义ui路由需实现这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IComponentRouter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 打开一个链接</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> url</div><div class="line">     *          目标url可以是http 或者 自定义scheme</div><div class="line">     * <span class="doctag">@param</span> bundle</div><div class="line">     *          打开目录activity时要传入的参数。建议只传基本类型参数。</div><div class="line">     * <span class="doctag">@return</span> 是否正常打开</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, String url, Bundle bundle)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context,Uri uri, Bundle bundle)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyUri</span><span class="params">(Uri uri)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>实现一个统一管理ui路由的接口，继承IComponentRouter<br>设置优先级和提供注册方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUIRouter</span> <span class="keyword">extends</span> <span class="title">IComponentRouter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> PRIORITY_NORMAL = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> PRIORITY_LOW = -<span class="number">1000</span>;</div><div class="line">    <span class="keyword">int</span> PRIORITY_HEIGHT = <span class="number">1000</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUI</span><span class="params">(IComponentRouter router, <span class="keyword">int</span> priority)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUI</span><span class="params">(IComponentRouter router)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterUI</span><span class="params">(IComponentRouter router)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>实现一个统一管理的ui路由<br>定义了一个路由列表和优先级map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;IComponentRouter&gt; uiRouters = <span class="keyword">new</span> ArrayList&lt;IComponentRouter&gt;();</div><div class="line">   HashMap&lt;IComponentRouter, Integer&gt; priorities = <span class="keyword">new</span> HashMap&lt;IComponentRouter, Integer&gt;();</div></pre></td></tr></table></figure>
</li>
</ol>
<p>提供单例对象的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">UIRouter</span><span class="params">()</span> </span>&#123;</div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UIRouter <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (UIRouter.class) &#123;</div><div class="line">               <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">                   instance = <span class="keyword">new</span> UIRouter();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> instance;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>注册一个ui路由并设置优先级,如果当前列表存在这个路由且优先级相同则返回，移除已存在的路由对象，遍历路由列表，当优先级小于当前路由时，退出遍历并插入列表，同时插入优先级到优先级map<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerUI</span><span class="params">(IComponentRouter router, <span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (priorities.containsKey(router) &amp;&amp; priority == priorities.get(router)) &#123;</div><div class="line">         <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">     removeOldUIRouter(router);</div><div class="line">     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">     <span class="keyword">for</span> (IComponentRouter temp : uiRouters) &#123;</div><div class="line">         Integer tp = priorities.get(temp);</div><div class="line">         <span class="keyword">if</span> (tp == <span class="keyword">null</span> || tp &lt;= priority) &#123;</div><div class="line">             <span class="keyword">break</span>;</div><div class="line">         &#125;</div><div class="line">         i++;</div><div class="line">     &#125;</div><div class="line">     uiRouters.add(i, router);</div><div class="line">     priorities.put(router, Integer.valueOf(priority));</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>反注册执行移除操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterUI</span><span class="params">(IComponentRouter router)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; uiRouters.size(); i++) &#123;</div><div class="line">         <span class="keyword">if</span> (router == uiRouters.get(i)) &#123;</div><div class="line">             uiRouters.remove(i);</div><div class="line">             priorities.remove(router);</div><div class="line">             <span class="keyword">break</span>;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>统一对ui理由的url进行处理，没有特殊前缀加上http头返回<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, String url, Bundle bundle)</span> </span>&#123;</div><div class="line">       url = url.trim();</div><div class="line">       <span class="keyword">if</span> (!TextUtils.isEmpty(url)) &#123;</div><div class="line">           <span class="keyword">if</span> (!url.contains(<span class="string">"://"</span>) &amp;&amp;</div><div class="line">                   (!url.startsWith(<span class="string">"tel:"</span>) ||</div><div class="line">                           !url.startsWith(<span class="string">"smsto:"</span>) ||</div><div class="line">                           !url.startsWith(<span class="string">"file:"</span>))) &#123;</div><div class="line">               url = <span class="string">"http://"</span> + url;</div><div class="line">           &#125;</div><div class="line">           Uri uri = Uri.parse(url);</div><div class="line">           <span class="keyword">return</span> openUri(context, uri, bundle);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>遍历路由列表，调用当前ui路由的检查方法和跳转方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">openUri</span><span class="params">(Context context, Uri uri, Bundle bundle)</span> </span>&#123;</div><div class="line">       <span class="keyword">for</span> (IComponentRouter temp : uiRouters) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">if</span> (temp.verifyUri(uri) &amp;&amp; temp.openUri(context, uri, bundle)) &#123;</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">               e.printStackTrace();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>路由实现类Router，负责组件的服务管理和组件注册，同时调用applicationLike的onCreate和onStop，相当于Application的初始化与销毁的生命周期<br>组件的服务map和注册组件map<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> HashMap&lt;String, Object&gt; services = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="comment">//注册组件的集合</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, IApplicationLike&gt; components = <span class="keyword">new</span> HashMap&lt;&gt;();</div></pre></td></tr></table></figure>
</li>
</ol>
<p>提供单例对象的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Router</span><span class="params">()</span> </span>&#123;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Router <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (Router.class) &#123;</div><div class="line">               <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">                   instance = <span class="keyword">new</span> Router();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> instance;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>组件服务的添加移除和获取<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String serviceName, Object serviceImpl)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (serviceName == <span class="keyword">null</span> || serviceImpl == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        services.put(serviceName, serviceImpl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object <span class="title">getService</span><span class="params">(String serviceName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (serviceName == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> services.get(serviceName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeService</span><span class="params">(String serviceName)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (serviceName == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        services.remove(serviceName);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>组件的注册与反注册，调用此处可实现动态的加载和卸载组件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * 注册组件</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> classname 组件名</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerComponent</span><span class="params">(@Nullable String classname)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (TextUtils.isEmpty(classname)) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (components.keySet().contains(classname)) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Class clazz = Class.forName(classname);</div><div class="line">          IApplicationLike applicationLike = (IApplicationLike) clazz.newInstance();</div><div class="line">          applicationLike.onCreate();</div><div class="line">          components.put(classname, applicationLike);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * 反注册组件</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> classname 组件名</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unregisterComponent</span><span class="params">(@Nullable String classname)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (TextUtils.isEmpty(classname)) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (components.keySet().contains(classname)) &#123;</div><div class="line">          components.get(classname).onStop();</div><div class="line">          components.remove(classname);</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Class clazz = Class.forName(classname);</div><div class="line">          IApplicationLike applicationLike = (IApplicationLike) clazz.newInstance();</div><div class="line">          applicationLike.onStop();</div><div class="line">          components.remove(classname);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/03/GoogleArchitectureStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/03/GoogleArchitectureStudy/" itemprop="url">
                  Android Architecture Components学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-03T13:58:58+08:00">
                2017-10-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/10/03/GoogleArchitectureStudy/" class="leancloud_visitors" data-flag-title="Android Architecture Components学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>Architecture Components 是在 2017 年 Google I/O 大会上，Google 官方推出的一个构建 Android 应用架构的库。它可以帮你避免在 Android 应用开发中常见的一些问题，比如：内存泄露，管理组件生命周期等等，帮助你去构建一个健壮，易测，可维护的应用。Now available in preview目前的版本还是一个预览版，但是我们依然可以去了解一下。</p>
<p>Google认为在 Android 中，应用间的这种跳跃切换行为很普遍，应用程序必须把这些问题都正确的处理好。移动设备的硬件资源是很有限的，在任何时候系统都可能杀掉一些应用去释放一些资源给新的应用。那么你的应用组件的创建和销毁是不完全可控的，它可能在任何时候由于用户或者系统的行为而触发。应用组件的生命周期也不是完全由你掌控的，所以不应该存储一些数据或者状态在应用组件中，应用组件之间也不应该彼此依赖。</p>
<hr>
<h1 id="架构原则"><a href="#架构原则" class="headerlink" title="架构原则"></a>架构原则</h1><ol>
<li>应用中的关注点分离。不应该在一个Activity或者Fragment中写所有的代码。任何与 UI 或者交互无关的代码都不应该存在这些类中。保证他们尽可能的职责单一化将会使我们避免很多生命周期相关的问题。因为Android系统可能会随时由于用户的行为或者系统状态（比如剩余内存过低）而销毁你的应用组件，减少组件之间的依赖可以提供一个稳定的用户体验。</li>
<li>应该采用Model驱动UI的方式，最好是一个可持久化的模型。满足以下两个条件：<ul>
<li>如果系统销毁我们的应用，用户不会为此而导致丢失数据。</li>
<li>在网络状况不好甚至断网的情况下，我们的应用仍然可以继续工作。</li>
</ul>
</li>
</ol>
<p>Model是专门负责为我们的应用处理和存储数据的。完全独立于View和其他应用中的组件，所以不存在生命周期相关的问题。保证UI部分的代码足够简单，没有业务逻辑，使Model管理数据的职责明确，这样更容易测试，而且稳定性更高。</p>
<h1 id="框架介绍"><a href="#框架介绍" class="headerlink" title="框架介绍"></a>框架介绍</h1><h2 id="生命周期的处理"><a href="#生命周期的处理" class="headerlink" title="生命周期的处理"></a>生命周期的处理</h2><p>在 android.arch.lifecycle包中提供了生命周期感知的组件的类和接口，这些组件可以根据 Activity/Fragment 的生命周期自动调整它的行为。</p>
<ul>
<li>LifecycleOwner：是一个具有单一方法的接口。如果一个类实现了此接口，则该类中需要持有一个Lifecycle对象，并通过 LifecycleOwner#getLifecycle()方法返回该对象。代码如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LifecycleRegistry mRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LifecycleRegistry <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRegistry;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果我们需要在Activity的生命周期的某些状态中对一些工具类做对应的处理，按以前的写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyListener</span><span class="params">(Callback callback)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enable</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLocation</span><span class="params">(<span class="keyword">long</span> longtitude ,<span class="keyword">long</span> latitude)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> MyListener myListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        myListener = <span class="keyword">new</span> MyListener(<span class="keyword">new</span> MyListener.Callback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLocation</span><span class="params">(<span class="keyword">long</span> longtitude, <span class="keyword">long</span> latitude)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onLocation: "</span> +longtitude+<span class="string">","</span>+latitude);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line">         myListener.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        myListener.stop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义一个位置监听类MyLocationListener，定义它在MyActivity生命周期的onStart和onStop中需要执行的方法，start()和stop()，接着在MyActivity的对应状态中调用。</p>
<p>如果我们让工具类实现LifecycleObserver接口，我们需要注入MyActivity的生命周期对象Lifecycle，那么我们只需要增加注解就可以实现在对应状态调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyListener</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG=<span class="string">"MyListener"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> Callback callback;</div><div class="line">    <span class="keyword">private</span> Lifecycle lifecycle;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyListener</span><span class="params">(Lifecycle lifecycle, Callback callback)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.lifecycle=lifecycle;</div><div class="line">       <span class="keyword">this</span>.callback =callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_START)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"start: "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnLifecycleEvent</span>(Lifecycle.Event.ON_STOP)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"stop: "</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">()</span> </span>&#123;</div><div class="line">        enabled = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span>(lifecycle.getCurrentState().isAtLeast(Lifecycle.State.INITIALIZED))&#123;</div><div class="line">            getLocation();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//模拟位置获取</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getLocation</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(<span class="number">1000</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> longtitude = (<span class="keyword">long</span>) (Math.random()*<span class="number">100</span>);</div><div class="line">        <span class="keyword">long</span> latitude = (<span class="keyword">long</span>) (Math.random()*<span class="number">100</span>);</div><div class="line">        callback.onLocation(longtitude,latitude);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onLocation</span><span class="params">(<span class="keyword">long</span> longtitude ,<span class="keyword">long</span> latitude)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">LifecycleActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> MyListener myListener;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MainActivity"</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        myListener = <span class="keyword">new</span> MyListener(<span class="keyword">this</span>, getLifecycle(), <span class="keyword">new</span> MyListener.Callback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLocation</span><span class="params">(<span class="keyword">long</span> longtitude, <span class="keyword">long</span> latitude)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onLocation: "</span> +longtitude+<span class="string">","</span>+latitude);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        getLifecycle().addObserver(myListener);</div><div class="line">        myListener.enable();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在onStart中调用就增加<code>@OnLifecycleEvent(Lifecycle.Event.ON_START)</code>的注解，不用在MyActivity中调用了。<br>MyActivity继承了LifecycleActivity，而LifecycleActivity已经实现了LifecycleOwner的接口，这里我们需要通过getLifecycle()传入MyActivity的生命周期对象Lifecycle到工具类中即可。<br>工具类获得Lifecycle对象后可对MyActivity的周期状态进行判断，<code>Lifecycle.State.INITIALIZED</code>这个代表生命周期所有者的初始化状态。<br>当然还有其他状态<code>CREATED</code> <code>DESTROYED</code>  <code>RESUMED</code> <code>STARTED</code></p>
<p>目前这个库只是一个beta版，提供的api一直都在变动，这里就通过一个入门的小例子来学习一下。</p>
<p>这个小例子是展示知乎的一个资讯列表。</p>
<p>目前有两个可用的免费api</p>
<p><code>https://news-at.zhihu.com/api/4/news/latest</code></p>
<p><code>https://news-at.zhihu.com/api/4/news/before/{date}</code></p>
<p>先创建一个知乎activity，这个相当于mvp架构的v层，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuActivity</span> <span class="keyword">extends</span> <span class="title">LifecycleActivity</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ZhihuActivity"</span>;</div><div class="line">    <span class="keyword">private</span> SwipeRefreshLayout refreshLayout = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> ZhihuListAdapter adapter = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> ProgressBar loadMorebar = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> View rootview = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ZhihuListViewModel zhihuListViewModel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_zhihu);</div><div class="line">        initView();</div><div class="line">        subscribeUI();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//初始化view</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</div><div class="line">        rootview=findViewById(R.id.rl_zhihu_root);</div><div class="line">        loadMorebar=findViewById(R.id.bar_load_more_zhihu);</div><div class="line">        refreshLayout=findViewById(R.id.refresh);</div><div class="line">        RecyclerView recyclerView = findViewById(R.id.rv_zhihu_list);</div><div class="line"></div><div class="line">        LinearLayoutManager layoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</div><div class="line">        adapter = <span class="keyword">new</span> ZhihuListAdapter(<span class="keyword">this</span>);</div><div class="line">        adapter.setClickListener(<span class="keyword">new</span> OnItemClickListener&lt;ZhihuStory&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(ZhihuStory zhihuStory)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        recyclerView.setAdapter(adapter);</div><div class="line">        recyclerView.setLayoutManager(layoutManager);</div><div class="line">        recyclerView.addOnScrollListener(<span class="keyword">new</span> ZhihuOnScrollListener());</div><div class="line"></div><div class="line">        refreshLayout.setOnRefreshListener(<span class="keyword">new</span> ZhihuSwipeListener());</div><div class="line">        refreshLayout.setColorSchemeResources(</div><div class="line">                android.R.color.holo_blue_bright,</div><div class="line">                android.R.color.holo_green_light,</div><div class="line">                android.R.color.holo_orange_light,</div><div class="line">                android.R.color.holo_red_light);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeUI</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 通过 ViewModelProviders 创建对应的 ZhihuListViewModel 对象</span></div><div class="line">        ZhihuListViewModel.Factory factory = <span class="keyword">new</span> ZhihuListViewModel</div><div class="line">                .Factory(getApplication()</div><div class="line">                , Injection.getDataRepository(getApplication()));</div><div class="line">        zhihuListViewModel = ViewModelProviders.of(<span class="keyword">this</span>, factory).get(ZhihuListViewModel.class);</div><div class="line">        <span class="comment">//注册知乎列表数据的监听，当有改变时刷新列表</span></div><div class="line">        zhihuListViewModel.getZhihuList().observe(<span class="keyword">this</span>, <span class="keyword">new</span> Observer&lt;List&lt;ZhihuStory&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable List&lt;ZhihuStory&gt; stories)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (stories == <span class="keyword">null</span> || stories.size() &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                Log.i(TAG,<span class="string">"size is "</span> + stories.size());</div><div class="line">                adapter.setStoryList(stories);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">//注册加载更多的监听</span></div><div class="line">        zhihuListViewModel.isLoadingZhihuList().observe(<span class="keyword">this</span>, <span class="keyword">new</span> Observer&lt;Boolean&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable Boolean aBoolean)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (aBoolean == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                Log.i(TAG,<span class="string">"state "</span> + aBoolean);</div><div class="line">                refreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">                loadMorebar.setVisibility(aBoolean ? View.VISIBLE : View.INVISIBLE);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        zhihuListViewModel.refreshZhihusData();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下拉刷新回调</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuSwipeListener</span> <span class="keyword">implements</span> <span class="title">SwipeRefreshLayout</span>.<span class="title">OnRefreshListener</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</div><div class="line">            adapter.clearStoryList();</div><div class="line">            zhihuListViewModel.refreshZhihusData();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 上拉加载更多回调</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ZhihuOnScrollListener</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">OnScrollListener</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onScrollStateChanged</span><span class="params">(RecyclerView recyclerView, <span class="keyword">int</span> newState)</span> </span>&#123;</div><div class="line">            LinearLayoutManager layoutManager = (LinearLayoutManager)</div><div class="line">                    recyclerView.getLayoutManager();</div><div class="line">            <span class="keyword">int</span> lastPosition = layoutManager</div><div class="line">                    .findLastCompletelyVisibleItemPosition();</div><div class="line">            <span class="keyword">if</span> (lastPosition == adapter.getItemCount() - <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">// 上拉加载更多数据</span></div><div class="line">                zhihuListViewModel.loadNextPageZhihu(lastPosition,getApplicationContext());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>recyclerView的adapter很简单，直接上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuListAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ZhihuListAdapter</span>.<span class="title">ZhihuViewHolder</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> OnItemClickListener&lt;ZhihuStory&gt; clickListener = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;ZhihuStory&gt; mStoryList = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZhihuListAdapter</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        mStoryList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        mContext = context;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClickListener</span><span class="params">(OnItemClickListener&lt;ZhihuStory&gt; listener)</span></span>&#123;</div><div class="line">        clickListener = listener;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ZhihuViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZhihuViewHolder(LayoutInflater.from(parent.getContext())</div><div class="line">                .inflate(R.layout.zhihu_list_item, parent, <span class="keyword">false</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ZhihuViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ZhihuStory zhihuStory = mStoryList.get(position);</div><div class="line">        holder.tv_zhihu_title.setText(zhihuStory.getTitle());</div><div class="line">        holder.tv_zhihu_time.setText(zhihuStory.getGa_prefix());</div><div class="line">        holder.ll_zhihu.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span>(clickListener != <span class="keyword">null</span>)&#123;</div><div class="line">                    clickListener.onClick(zhihuStory);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Glide.with(mContext)</div><div class="line">                .load(zhihuStory.getImages()[<span class="number">0</span>])</div><div class="line">                .centerCrop()</div><div class="line">                .into(holder.img_zhihu);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mStoryList.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//数据添加后刷新列表</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStoryList</span><span class="params">(List&lt;ZhihuStory&gt; storyList)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (storyList == <span class="keyword">null</span> || storyList.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mStoryList.addAll(storyList);</div><div class="line">        notifyDataSetChanged();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//清空当前数据</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearStoryList</span><span class="params">()</span> </span>&#123;</div><div class="line">        mStoryList.clear();</div><div class="line">        notifyDataSetChanged();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ZhihuViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> View ll_zhihu;</div><div class="line">        <span class="keyword">public</span> TextView tv_zhihu_title;</div><div class="line">        <span class="keyword">public</span> TextView tv_zhihu_time;</div><div class="line">        <span class="keyword">public</span> ImageView img_zhihu;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ZhihuViewHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            ll_zhihu = itemView.findViewById(R.id.ll_zhihu);</div><div class="line">            tv_zhihu_title = itemView.findViewById(R.id.tv_zhihu_title);</div><div class="line">            tv_zhihu_time = itemView.findViewById(R.id.tv_zhihu_time);</div><div class="line">            img_zhihu = itemView.findViewById(R.id.img_zhihu);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的item监听代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的布局文件代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/ll_zhihu"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"113dp"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/img_zhihu"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"112dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"112dp"</span></div><div class="line">        <span class="attr">android:layout_alignParentLeft</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentStart</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_alignParentTop</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_vertical"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@null"</span></div><div class="line">        <span class="attr">android:paddingBottom</span>=<span class="string">"16dp"</span></div><div class="line">        <span class="attr">android:paddingEnd</span>=<span class="string">"16dp"</span></div><div class="line">        <span class="attr">android:paddingRight</span>=<span class="string">"16dp"</span></div><div class="line">        <span class="attr">android:paddingTop</span>=<span class="string">"16dp"</span></div><div class="line">        <span class="attr">android:src</span>=<span class="string">"@mipmap/ic_launcher"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"112dp"</span></div><div class="line">        <span class="attr">android:layout_toEndOf</span>=<span class="string">"@+id/img_zhihu"</span></div><div class="line">        <span class="attr">android:layout_toRightOf</span>=<span class="string">"@+id/img_zhihu"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv_zhihu_title"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></div><div class="line">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">android:paddingLeft</span>=<span class="string">"16dp"</span></div><div class="line">            <span class="attr">android:paddingStart</span>=<span class="string">"16dp"</span></div><div class="line">            <span class="attr">android:paddingTop</span>=<span class="string">"24dp"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/tv_zhihu_time"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></div><div class="line">            <span class="attr">android:paddingLeft</span>=<span class="string">"16dp"</span></div><div class="line">            <span class="attr">android:paddingStart</span>=<span class="string">"16dp"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"1px"</span></div><div class="line">        <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"112dp"</span></div><div class="line">        <span class="attr">android:layout_marginStart</span>=<span class="string">"112dp"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@color/lightGrey"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这里创建了ZhihuListViewModel，相当于mvp架构的p层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuListViewModel</span> <span class="keyword">extends</span> <span class="title">AndroidViewModel</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 请求接口中查询的日期参数</span></div><div class="line">    <span class="keyword">private</span> MutableLiveData&lt;String&gt; requestPageDate = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">    <span class="comment">// 知乎列表的数据</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; mZhihuList;</div><div class="line">    <span class="comment">// 数据源对象</span></div><div class="line">    <span class="keyword">private</span> DataRepository dataRepository = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ZhihuListViewModel</span><span class="params">(Application application, <span class="keyword">final</span> DataRepository dataRepository)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(application);</div><div class="line">        <span class="keyword">this</span>.dataRepository = dataRepository;</div><div class="line">        <span class="comment">// 使用 Transformations.switchMap() 方法，当 View 改变 requestPageDate 参数的值时，则进行 zhihu 列表数据的请求</span></div><div class="line">        mZhihuList = Transformations.switchMap(requestPageDate, <span class="keyword">new</span> Function&lt;String, LiveData&lt;List&lt;ZhihuStory&gt;&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; apply(String input) &#123;</div><div class="line">                <span class="keyword">return</span> dataRepository.getZhihuList(input);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取 Zhihu 列表数据</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> Zhihu 列表数据</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getZhihuList() &#123;</div><div class="line">        <span class="keyword">return</span> mZhihuList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 数据请求状态由 DataRepository 控制，包括下拉刷新和上拉加载更多</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> 是否在进行数据请求</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> dataRepository.isLoadingZhihuList();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下拉刷新，获取最新的 Zhihu 列表数据</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshZhihusData</span><span class="params">()</span> </span>&#123;</div><div class="line">        requestPageDate.setValue(<span class="string">"today"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 上拉加载更多时，获取 Zhihu 历史列表数据</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> positon 表示列表滑动到最后一项</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadNextPageZhihu</span><span class="params">(<span class="keyword">int</span> positon, Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Util.isNetworkConnected(context)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        requestPageDate.setValue(String.valueOf(positon));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">extends</span> <span class="title">ViewModelProvider</span>.<span class="title">NewInstanceFactory</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@NonNull</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Application application;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DataRepository dataRepository;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Factory</span><span class="params">(@NonNull Application application, DataRepository dataRepository)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.application = application;</div><div class="line">            <span class="keyword">this</span>.dataRepository = dataRepository;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(Class&lt;T&gt; modelClass)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> ZhihuListViewModel(application, dataRepository);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化时，对requestPageDate做监听，当requestPageDate的值有变化时，调用getZhihuList刷新列表的数据。列表刷新时回调中会调用refreshZhihusData()，此时会改变requestPageDate的值，也就会调用getZhihuList。列表加载更多时回调中会调用loadNextPageZhihu(int positon, Context context) ，也会改变requestPageDate的值，同样会调用getZhihuList。</p>
<p>接下来是DataRepository，数据源管理类，对应mvp的m层。</p>
<p>通过一个类注入数据源对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Injection</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataRepository <span class="title">getDataRepository</span><span class="params">(Application application)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> DataRepository.getInstance(RemoteDataSource.getInstance(),</div><div class="line">                LocalDataSource.getInstance(application), application);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DataRepository单例类对网络数据源和本地数据源做统一管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataRepository</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource remoteDataSource;<span class="comment">//网络数据源</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource localDataSource;<span class="comment">//本地数据源</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DataRepository INSTANCE = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Application application = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DataRepository</span><span class="params">(@NonNull DataSource remoteDataSource,</span></span></div><div class="line">                           @NonNull DataSource localDataSource) &#123;</div><div class="line">        <span class="keyword">this</span>.remoteDataSource = remoteDataSource;</div><div class="line">        <span class="keyword">this</span>.localDataSource = localDataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> DataRepository <span class="title">getInstance</span><span class="params">(@NonNull DataSource remoteDataSource,</span></span></div><div class="line">                                      @NonNull DataSource localDataSource,</div><div class="line">                                      Application app) &#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (DataRepository.class) &#123;</div><div class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">                    INSTANCE = <span class="keyword">new</span> DataRepository(remoteDataSource, localDataSource);</div><div class="line">                    application = app;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取知乎列表的数据</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getZhihuList(<span class="meta">@NonNull</span> String date) &#123;</div><div class="line">        <span class="comment">//联网时使用网络数据源</span></div><div class="line">        <span class="keyword">if</span> (Util.isNetworkConnected(application.getApplicationContext())) &#123;</div><div class="line">            <span class="comment">//第一页获取最近的知乎资讯列表</span></div><div class="line">            <span class="keyword">if</span> (date.equals(<span class="string">"today"</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> remoteDataSource.getLastZhihuList();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//获取更多知乎资讯</span></div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> remoteDataSource.getMoreZhihuList();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//断网时使用本地数据源</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (date.equals(<span class="string">"today"</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> localDataSource.getLastZhihuList();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> localDataSource.getMoreZhihuList();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//加载状态</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//联网时返回网络数据源加载状态</span></div><div class="line">        <span class="keyword">if</span> (Util.isNetworkConnected(application.getApplicationContext())) &#123;</div><div class="line">            <span class="keyword">return</span> remoteDataSource.isLoadingZhihuList();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//断网时返回本地数据源加载状态</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> localDataSource.isLoadingZhihuList();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>判断网络状态工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Util</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isNetworkConnected</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">            ConnectivityManager mConnectivityManager = (ConnectivityManager) context</div><div class="line">                    .getSystemService(Context.CONNECTIVITY_SERVICE);</div><div class="line">            NetworkInfo mNetworkInfo = mConnectivityManager.getActiveNetworkInfo();</div><div class="line">            <span class="keyword">if</span> (mNetworkInfo != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> mNetworkInfo.isAvailable();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>网络数据源和本地数据源的统一接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSource</span> </span>&#123;</div><div class="line">    LiveData&lt;List&lt;ZhihuStory&gt;&gt; getLastZhihuList();<span class="comment">//加载最近的资讯列表</span></div><div class="line">    LiveData&lt;List&lt;ZhihuStory&gt;&gt; getMoreZhihuList();<span class="comment">//列表加载更多资讯</span></div><div class="line">    <span class="function">LiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span></span>;<span class="comment">//获取加载状态</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>网络数据源单例类对网络请求做统一管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteDataSource</span>  <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RemoteDataSource INSTANCE = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;Boolean&gt; isLoadingZhihulist; <span class="comment">//列表加载标记</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;List&lt;ZhihuStory&gt;&gt; zhihuList; <span class="comment">//列表数据</span></div><div class="line">    <span class="keyword">private</span> String requestDate;<span class="comment">//请求日期</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApiZhihu apiZhihu;<span class="comment">//请求api对象</span></div><div class="line"></div><div class="line">    &#123;</div><div class="line">        isLoadingZhihulist = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">        zhihuList = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RemoteDataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        apiZhihu = ApiManager.getInstance().getApiZhihu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteDataSource <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (RemoteDataSource.class) &#123;</div><div class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">                    INSTANCE = <span class="keyword">new</span> RemoteDataSource();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getLastZhihuList() &#123;</div><div class="line">        isLoadingZhihulist.setValue(<span class="keyword">true</span>);<span class="comment">//加载开始</span></div><div class="line">        apiZhihu.getLatestNews()</div><div class="line">                .enqueue(<span class="keyword">new</span> Callback&lt;ZhihuData&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;ZhihuData&gt; call, Response&lt;ZhihuData&gt; response)</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (response.isSuccessful()) &#123;</div><div class="line">                            zhihuList.setValue(response.body().getStories());</div><div class="line">                            refreshLocalZhihuList(response.body().getStories());</div><div class="line">                            requestDate = response.body().getDate();</div><div class="line">                        &#125;</div><div class="line">                        isLoadingZhihulist.setValue(<span class="keyword">false</span>);<span class="comment">//加载结束</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;ZhihuData&gt; call, Throwable t)</span> </span>&#123;</div><div class="line">                        isLoadingZhihulist.setValue(<span class="keyword">false</span>);<span class="comment">//加载结束</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">        <span class="keyword">return</span> zhihuList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getMoreZhihuList() &#123;</div><div class="line">        isLoadingZhihulist.setValue(<span class="keyword">true</span>);<span class="comment">//加载开始</span></div><div class="line">        apiZhihu.getTheDaily(requestDate)</div><div class="line">                .enqueue(<span class="keyword">new</span> Callback&lt;ZhihuData&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;ZhihuData&gt; call, Response&lt;ZhihuData&gt; response)</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (response.isSuccessful()) &#123;</div><div class="line">                            zhihuList.setValue(response.body().getStories());</div><div class="line">                            refreshLocalZhihuList(response.body().getStories());</div><div class="line">                            requestDate = response.body().getDate();</div><div class="line">                        &#125;</div><div class="line">                        isLoadingZhihulist.setValue(<span class="keyword">false</span>);<span class="comment">//加载结束</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;ZhihuData&gt; call, Throwable t)</span> </span>&#123;</div><div class="line">                        isLoadingZhihulist.setValue(<span class="keyword">false</span>);<span class="comment">//加载结束</span></div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">        <span class="keyword">return</span> zhihuList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//返回加载状态</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MutableLiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> isLoadingZhihulist;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//刷新本地数据</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshLocalZhihuList</span><span class="params">(List&lt;ZhihuStory&gt; zhihuStoryList)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (zhihuStoryList == <span class="keyword">null</span> || zhihuStoryList.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        AppDatabaseManager.getInstance().insertZhihuList(zhihuStoryList);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每次网络请求后，都需要刷新本地数据源的数据，ApiManager对api做统一管理，提供获取Retrofit网络请求对象的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiManager</span> </span>&#123;</div><div class="line">    <span class="comment">//全局url</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZHIHU_URL = <span class="string">"https://news-at.zhihu.com/"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApiManager INSTANCE;</div><div class="line">    <span class="comment">//Retrofit网络请求对象</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApiZhihu apiZhihu;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ApiManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApiManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (ApiManager.class) &#123;</div><div class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">                    INSTANCE = <span class="keyword">new</span> ApiManager();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取Retrofit对象，为空时初始化实例</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ApiZhihu <span class="title">getApiZhihu</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (apiZhihu == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (ApiManager.class) &#123;</div><div class="line">                <span class="keyword">if</span> (apiZhihu == <span class="keyword">null</span>) &#123;</div><div class="line">                    apiZhihu = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                            .baseUrl(ZHIHU_URL)</div><div class="line">                            .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                            .build()</div><div class="line">                            .create(ApiZhihu.class);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> apiZhihu;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义Retrofit网络请求接口，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApiZhihu</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"api/4/news/latest"</span>)</div><div class="line">    <span class="function">Call&lt;ZhihuData&gt; <span class="title">getLatestNews</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@GET</span>(<span class="string">"/api/4/news/before/&#123;date&#125;"</span>)</div><div class="line">    <span class="function">Call&lt;ZhihuData&gt; <span class="title">getTheDaily</span><span class="params">(@Path(<span class="string">"date"</span>)</span> String date)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>本地数据源单例类做统一管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LocalDataSource INSTANCE = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LocalDataSource</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        AppDatabaseManager.getInstance().createDB(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LocalDataSource <span class="title">getInstance</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (LocalDataSource.class) &#123;</div><div class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">                    INSTANCE = <span class="keyword">new</span> LocalDataSource(context);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getLastZhihuList() &#123;</div><div class="line">        <span class="keyword">return</span> AppDatabaseManager.getInstance().loadZhihuList();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; getMoreZhihuList() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> AppDatabaseManager.getInstance().isLoadingZhihuList();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AppDatabaseManager单例类是数据库的管理工具类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDatabaseManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_NAME = <span class="string">"google-architecture-study-db"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;Boolean&gt; mIsLoadingZhihuList;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MutableLiveData&lt;List&lt;ZhihuStory&gt;&gt; mZhihuList;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AppDatabaseManager INSTANCE = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> AppDatabase mDB = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">        mIsLoadingZhihuList = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">        mZhihuList = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AppDatabaseManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppDatabaseManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (AppDatabaseManager.class) &#123;</div><div class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</div><div class="line">                    INSTANCE = <span class="keyword">new</span> AppDatabaseManager();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//创建数据库</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createDB</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> AsyncTask&lt;Context, Void, Void&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Context... params)</span> </span>&#123;</div><div class="line">                Context context = params[<span class="number">0</span>].getApplicationContext();</div><div class="line">                mDB = Room.databaseBuilder(context,</div><div class="line">                        AppDatabase.class, DATABASE_NAME).build();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;.execute(context.getApplicationContext());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//刷新本地知乎列表数据</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertZhihuList</span><span class="params">(<span class="keyword">final</span> List&lt;ZhihuStory&gt; zhihuStoryList)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;()&#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... voids)</span> </span>&#123;</div><div class="line">                mDB.beginTransaction();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    mDB.zhihuDao().insertZhihuList(zhihuStoryList);</div><div class="line">                    mDB.setTransactionSuccessful();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    mDB.endTransaction();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//知乎列表数据查询</span></div><div class="line">    <span class="keyword">public</span> LiveData&lt;List&lt;ZhihuStory&gt;&gt; loadZhihuList() &#123;</div><div class="line">        mIsLoadingZhihuList.setValue(<span class="keyword">true</span>);</div><div class="line">        <span class="keyword">new</span> AsyncTask&lt;Void, Void, List&lt;ZhihuStory&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> List&lt;ZhihuStory&gt; <span class="title">doInBackground</span><span class="params">(Void... voids)</span> </span>&#123;</div><div class="line">                List&lt;ZhihuStory&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">                mDB.beginTransaction();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    results.addAll(mDB.zhihuDao().loadAllZhihus());</div><div class="line">                    mDB.setTransactionSuccessful();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    mDB.endTransaction();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> results;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(List&lt;ZhihuStory&gt; aVoid)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onPostExecute(aVoid);</div><div class="line">                mIsLoadingZhihuList.setValue(<span class="keyword">false</span>);</div><div class="line">                mZhihuList.setValue(aVoid);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">(List&lt;ZhihuStory&gt; aVoid)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onCancelled(aVoid);</div><div class="line">                mIsLoadingZhihuList.setValue(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;.execute();</div><div class="line">        <span class="keyword">return</span> mZhihuList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取加载状态</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MutableLiveData&lt;Boolean&gt; <span class="title">isLoadingZhihuList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mIsLoadingZhihuList;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化数据库room</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Database</span>(entities = &#123;ZhihuStory.class&#125;, version = <span class="number">1</span>, exportSchema = <span class="keyword">false</span>)</div><div class="line"><span class="meta">@TypeConverters</span>(&#123;Converters.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDatabase</span> <span class="keyword">extends</span> <span class="title">RoomDatabase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ZhihuDao <span class="title">zhihuDao</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>定义数据库room相关接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Dao</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ZhihuDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM zhihustorys"</span>)</div><div class="line">    <span class="function">List&lt;ZhihuStory&gt; <span class="title">loadAllZhihus</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Insert</span>(onConflict = OnConflictStrategy.REPLACE)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertZhihuList</span><span class="params">(List&lt;ZhihuStory&gt; zhihuStories)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>时间字符串拼接与切割转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Converters</span> </span>&#123;</div><div class="line">    <span class="meta">@TypeConverter</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">fromTimestamp</span><span class="params">(String[] arrays)</span> </span>&#123;</div><div class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">for</span> (String s : arrays) &#123;</div><div class="line">            stringBuilder.append(s).append(<span class="string">","</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> length = stringBuilder.toString().length();</div><div class="line">        <span class="keyword">if</span> (length &gt; <span class="number">0</span>) &#123;</div><div class="line">            stringBuilder = stringBuilder.deleteCharAt(length - <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> stringBuilder.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@TypeConverter</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] dateToTimestamp(String string) &#123;</div><div class="line">        <span class="keyword">return</span> string.split(<span class="string">","</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>涉及到的dto，知乎资讯内层dto，需要增加一些注解，这里对应数据库的<code>zhihustorys</code>的表，主键为id，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span>(tableName = <span class="string">"zhihustorys"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuStory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String ga_prefix;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String title;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String[] images;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZhihuStory</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZhihuStory</span><span class="params">(ZhihuStory zhihuStory)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = zhihuStory.getId();</div><div class="line">        <span class="keyword">this</span>.type = zhihuStory.getType();</div><div class="line">        <span class="keyword">this</span>.ga_prefix = zhihuStory.getGa_prefix();</div><div class="line">        <span class="keyword">this</span>.title = zhihuStory.getTitle();</div><div class="line">        <span class="keyword">this</span>.images = zhihuStory.getImages();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String[] getImages() &#123;</div><div class="line">        <span class="keyword">return</span> images;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImages</span><span class="params">(String[] images)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.images = images;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGa_prefix</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ga_prefix;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGa_prefix</span><span class="params">(String ga_prefix)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ga_prefix = ga_prefix;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> title;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.title = title;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>知乎资讯外层dto，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZhihuData</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String date;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;ZhihuStory&gt; stories;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;ZhihuStory&gt; top_stories;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> date;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.date = date;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ZhihuStory&gt; <span class="title">getStories</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stories;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStories</span><span class="params">(List&lt;ZhihuStory&gt; stories)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.stories = stories;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ZhihuStory&gt; <span class="title">getTop_stories</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> top_stories;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTop_stories</span><span class="params">(List&lt;ZhihuStory&gt; top_stories)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.top_stories = top_stories;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上是基于Architecture Components 架构的展示知乎资讯列表的所有代码。</p>
<p>总结：Architecture Components的架构总体上看起来还是很像MVP+Rxjava，M层对应DataRepository，V层对应activity，P层对应AndroidViewModel。AndroidViewModel中注册了请求参数改变的监听，在回调中发起数据请求，V层调用P层是通过AndroidViewModel的方法修改对应的请求参数。activity中注册了AndroidViewModel中的列表数据改变监听，在回调中刷新列表控件，P层得到结果刷新V层，也是通过改变AndroidViewModel中的列表数据来触发回调刷新。所以P层和V层都没有抽象出接口。M层通过统一的数据源管理类分别管理网络数据源和本地数据源。网络数据源通过Retrofit做网络请求，本地数据源主要通过数据库存储实现，定义了一个room数据库工具类做统一管理。个人觉得就目前的版本而言，如果原本就是MVP+Rxjava这种架构的完全可以不用重构了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/17/DataBindingStudy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/17/DataBindingStudy/" itemprop="url">
                  DataBinding 框架学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-17T00:29:51+08:00">
                2017-09-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/09/17/DataBindingStudy/" class="leancloud_visitors" data-flag-title="DataBinding 框架学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>Databinding 在2015年7月发布的Android Studio v1.3.0 版本上引入，在2016年4月Android Studio v2.0.0 上正式支持。目前为止，已经支持双向绑定。</p>
<p>在android中实现 MVVM 的架构模式，Data binding 是最具代表性的框架，Google推出这一框架的原因是通过数据绑定技术可以解决界面与业务分离问题，对应的在Android中你不必再写什么findViewById()、setText()，setVisibility()，setEnabled() 或 setOnClickListener() 等方法了，可简化代码。</p>
<p>由于以前缺少对架构的关注和重视，虽然这个框架很早出来，但是也没有进行系统性的学习，下面就对Data binding的使用做一个总结。</p>
<hr>
<h1 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h1><p>在app下的build.gradle文件中添加</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">26</span></div><div class="line">    buildToolsVersion <span class="string">"26.0.1"</span></div><div class="line">    defaultConfig &#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line">    dataBinding &#123;</div><div class="line">        enabled <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h1><h2 id="定义数据对象"><a href="#定义数据对象" class="headerlink" title="定义数据对象"></a>定义数据对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestNormalDto</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String test1;</div><div class="line">    <span class="keyword">private</span> String test2;</div><div class="line">    <span class="keyword">private</span> String test3;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestNormalDto</span><span class="params">(String test1, String test2, String test3)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test1 = test1;</div><div class="line">        <span class="keyword">this</span>.test2 = test2;</div><div class="line">        <span class="keyword">this</span>.test3 = test3;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> test1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest1</span><span class="params">(String test1)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test1 = test1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest2</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> test2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest2</span><span class="params">(String test2)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test2 = test2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest3</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> test3;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest3</span><span class="params">(String test3)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test3 = test3;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="布局文件"><a href="#布局文件" class="headerlink" title="布局文件"></a>布局文件</h2><p>在 DataBinding 中，xml 的布局文件就不再单纯的展示UI，还需要定义 UI用到的变量，将变量直接与UI捆绑，个人认为类似于web开发的响应式写法。所以，它的根节点不再是一个 ViewGroup，而是变成了·<code>layout</code>标签的节点，并且新增了一个节点<code>data</code>，布局文件如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">          <span class="comment">&lt;!--定义所需捆绑的变量，name变量名，type变量类型--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"testNormalDto"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.TestNormalDto"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView3"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;testNormalDto.test1&#125;"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView2"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;testNormalDto.test2&#125;"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;testNormalDto.test3&#125;"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>吐槽一下，android studio的XML支持并不是很好，输入变量很多时候没有智能提示。这里我们引用了testNormalDto这个数据集，并将这个数据集的属性与具体的ui控件做了捆绑，在定义变量的同时，框架会自动为我们生成testNormalDto这个数据集的set方法。当我们到Activity中刷新这个数据集时，对应捆绑的控件也会跟着刷新。具体的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ActivityMainBinding binding = DataBindingUtil.setContentView(</div><div class="line">              <span class="keyword">this</span>, R.layout.activity_main);</div><div class="line">TestNormalDto testNormalDto = <span class="keyword">new</span> TestNormalDto(<span class="string">"fei"</span>, <span class="string">"Liang"</span> ,<span class="string">"sss"</span>);</div><div class="line">binding.setTestNormalDto(testNormalDto);</div></pre></td></tr></table></figure></p>
<p>ActivityMainBinding是DataBinding这个框架自动生成的，初始化时绑定当前的ui布局。创建一个model对象，注入到ActivityMainBinding的对象中，即可完成数据刷新操作。刷新model对象的同时刷新ui。MVVM 的 <code>ViewModel</code> 需要把数据（Model）与 UI（View） 进行绑定，<code>data</code> 节点就是连接它们之间的一个桥梁。</p>
<h2 id="variable类型"><a href="#variable类型" class="headerlink" title="variable类型"></a>variable类型</h2><p>variable同样支持基本数据类型，比如String，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--定义所需捆绑的变量，name变量名，type变量类型--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">        	<span class="attr">name</span>=<span class="string">"myStr"</span></div><div class="line">        	<span class="attr">type</span>=<span class="string">"String"</span>/&gt;</div><div class="line">       </div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView4"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;myStr&#125;"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>框架也会自动为我们生成set方法，刷新数据集的同时刷新控件显示的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ActivityMainBinding binding = DataBindingUtil.setContentView(</div><div class="line">                <span class="keyword">this</span>, R.layout.activity_main);</div><div class="line">binding.setMyStr(<span class="string">"测试字符串变量"</span>);</div></pre></td></tr></table></figure>
<p>Integer, Float,Double也同样支持，不过这里不能直接显示在控件中，要转String再显示，DataBinding的数据绑定支持表达式，我们可以先定义一个工具类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyStringUtils</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convert</span><span class="params">(<span class="keyword">final</span> Double myDouble)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> myDouble+<span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convert</span><span class="params">(<span class="keyword">final</span> Integer myInteger)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> myInteger+<span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convert</span><span class="params">(<span class="keyword">final</span> Float myFloat)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> myFloat+<span class="string">""</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来是在XML中定义变量并绑定，同样，框架会自动为我们生成set方法，这里我们在绑定的时候调用这个工具类转String再显示到控件中，注意调用工具类需要先import工具类到xml中，我们需要在<code>&lt;data&gt;</code>标签中添加<code>&lt;import&gt;</code>标签。代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--定义所需捆绑的变量，name变量名，type变量类型--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.MyStringUtils"</span>/&gt;</span></div><div class="line">       </div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"myInt"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"Integer"</span>/&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"myDouble"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"Double"</span>/&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"myFloat"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"Float"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView5"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;MyStringUtils.convert(myInt)&#125;"</span>/&gt;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView6"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;MyStringUtils.convert(myDouble)&#125;"</span>/&gt;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView7"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;MyStringUtils.convert(myFloat)&#125;"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在Activity中刷新数据集，同时刷新控件显示数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ActivityMainBinding binding = DataBindingUtil.setContentView(</div><div class="line">                <span class="keyword">this</span>, R.layout.activity_main);  </div><div class="line">binding.setMyFloat(<span class="number">12.3f</span>);</div><div class="line">binding.setMyDouble(<span class="number">12.4</span>);</div><div class="line">binding.setMyInt(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<h2 id="自定义Binding的名称"><a href="#自定义Binding的名称" class="headerlink" title="自定义Binding的名称"></a>自定义Binding的名称</h2><p>除了使用自动生成的Binding名ActivityMainBinding以外，还可以在data标签中添加class属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">data</span> <span class="attr">class</span>=<span class="string">"CustomBinding"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><p>如果此时项目根目录下也存在一个TestNormalDto，这时存在两个TestNormalDto，XML中需要引入这两个dto做数据捆绑，这时<code>data</code> 节点了导入了两个同名的类：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.TestNormalDto"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.TestNormalDto"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"testNormalDto"</span> <span class="attr">type</span>=<span class="string">"TestNormalDto"</span> /&gt;</span></div></pre></td></tr></table></figure>
<p><code>import</code> 还有一个 <code>alias</code> 属性，可解决同名类问题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.TestNormalDto"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.TestNormalDto"</span> <span class="attr">alias</span>=<span class="string">"NormalDto"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"normalDto"</span> <span class="attr">type</span>=<span class="string">"NormalDto"</span> /&gt;</span></div></pre></td></tr></table></figure>
<h2 id="非空判断"><a href="#非空判断" class="headerlink" title="非空判断"></a>非空判断</h2><p>感觉类似java的三目运算符</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text="@&#123;user.displayName ?? user.lastName&#125;"</div></pre></td></tr></table></figure>
<p>这个等价于</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text="@&#123;user.displayName != null ? user.displayName : user.lastName&#125;"</div></pre></td></tr></table></figure>
<h2 id="设置属性"><a href="#设置属性" class="headerlink" title="设置属性"></a>设置属性</h2><p>如果TestNormalDto中添加一个属性isNormal，当该属性为true时，控件可见否则控件不可见，我们可以直接把 Java 中定义的属性值赋值给 xml 属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">   <span class="attr">android:text</span>=<span class="string">"@&#123;testNormalDto.test1&#125;"</span></div><div class="line">   <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">   <span class="attr">android:visibility</span>=<span class="string">"@&#123;testNormalDto.isNormal ? View.VISIBLE : View.GONE&#125;"</span>/&gt;</div></pre></td></tr></table></figure>
<h2 id="使用资源"><a href="#使用资源" class="headerlink" title="使用资源"></a>使用资源</h2><p>padding的大小通过屏幕尺寸自适应，大尺寸使用dimen资源中的largePadding，否则使用smallPadding。字符串引用也可使用占位符传参的形式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;<span class="name">data</span> &gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"large"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"boolean"</span> /&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"goodsName"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"String"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"price"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"double"</span> /&gt;</div><div class="line">  </div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line">   		<span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView8"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:padding</span>=<span class="string">"@&#123;large? (int)@dimen/largePadding : (int)@dimen/smallPadding&#125;"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;@string/nameFormat(goodsName,price)&#125;"</span></div><div class="line">             /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div><div class="line">  </div><div class="line"> <span class="comment">&lt;!--string.xml--&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"nameFormat"</span>&gt;</span>%1$s的价格是%2$.2f<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>同样在Activity中刷新数据集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ResourceBinding binding = DataBindingUtil.setContentView(</div><div class="line">               <span class="keyword">this</span>, R.layout.activity_main);</div><div class="line">binding.setGoodsName(<span class="string">"T-shirt"</span>);</div><div class="line">binding.setPrice(<span class="number">15</span>);</div></pre></td></tr></table></figure>
<h2 id="context引用"><a href="#context引用" class="headerlink" title="context引用"></a>context引用</h2><p>context是dataBinding通过variable标签默认帮我们定义好了,该context的值就是从当前布局文件中的根节点view的getContext()方法获取的.所以我们可以在布局中直接引用context</p>
<p>如果我们自己通过variable标签定义了一个name为context的变量，那么会覆盖掉系统提供的context。</p>
<h2 id="ViewStubs的使用"><a href="#ViewStubs的使用" class="headerlink" title="ViewStubs的使用"></a>ViewStubs的使用</h2><p>XML布局中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ViewStub</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/view_stub"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout</span>=<span class="string">"@layout/inflate_content"</span> /&gt;</div></pre></td></tr></table></figure>
<p>inflate_content.xml代码与activity的布局文件大致相似，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">data</span>  <span class="attr">class</span>=<span class="string">"ViewStubBinding"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"viewStubTag"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"String"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;viewStubTag&#125;"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在activity中inflate布局，并且增加inflate监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">binding.viewStub.setOnInflateListener(<span class="keyword">new</span> ViewStub.OnInflateListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInflate</span><span class="params">(ViewStub stub, View inflated)</span> </span>&#123;</div><div class="line">			   ViewStubBinding binding = DataBindingUtil.bind(inflated);</div><div class="line">                binding.setViewStubTag(<span class="string">"这是inflate的布局"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line"> inflateViewStub(binding);</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflateViewStub</span><span class="params">(ActivityMainBinding binding)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!binding.viewStub.isInflated()) &#123;</div><div class="line">            binding.viewStub.getViewStub().inflate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="include的使用"><a href="#include的使用" class="headerlink" title="include的使用"></a>include的使用</h2><p>XML布局中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--添加variable标签，定义变量--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">     <span class="attr">name</span>=<span class="string">"includeTag"</span></div><div class="line">     <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">include</span></span></div><div class="line">     <span class="attr">layout</span>=<span class="string">"@layout/include_content"</span></div><div class="line">     <span class="attr">bind:includeTag</span>=<span class="string">"@&#123;includeTag&#125;"</span> /&gt;</div></pre></td></tr></table></figure>
<p>include_content布局中接收由activity布局传过来的数据代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span> &gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"includeTag"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"String"</span> /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;includeTag&#125;"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在activity中加一句代码即可传入数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">binding.setIncludeTag(<span class="string">"这是include的内容"</span>);</div></pre></td></tr></table></figure>
<h2 id="BindingConversion与-BindingAdapter"><a href="#BindingConversion与-BindingAdapter" class="headerlink" title="@BindingConversion与@BindingAdapter"></a>@BindingConversion与@BindingAdapter</h2><p>XML布局中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--添加variable标签，定义变量--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">      <span class="attr">name</span>=<span class="string">"isNormal"</span></div><div class="line">      <span class="attr">type</span>=<span class="string">"boolean"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">      <span class="attr">name</span>=<span class="string">"height"</span></div><div class="line">      <span class="attr">type</span>=<span class="string">"float"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">      <span class="attr">name</span>=<span class="string">"time"</span></div><div class="line">      <span class="attr">type</span>=<span class="string">"java.util.Date"</span> /&gt;</div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"50dp"</span></div><div class="line">      <span class="attr">android:background</span>=<span class="string">"@&#123;isNormal ? @color/colorPrimary : @color/colorAccent&#125;"</span></div><div class="line">      <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">      <span class="attr">bind:custom</span>=<span class="string">"@&#123;height&#125;"</span> /&gt;</div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">      <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">      <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">      <span class="attr">android:text</span>=<span class="string">"@&#123;time&#125;"</span>/&gt;</div></pre></td></tr></table></figure>
<ul>
<li>@BindingAdapter标签的用法：</li>
</ul>
<p>在activity中添加绑定代码，bind:custom这个是我们自定义的属性，databinding会去查找自定义的setCustom的方法，需要添加注解@BindingAdapter，第一个参数必须是我们需要刷新的控件类型，第二个参数就是传入到我们自定义属性中的数据，这里我们传入的是float类型的高度值，我们可以根据这个高度值动态设置控件的高度。</p>
<ul>
<li>@BindingConversion标签的用法：</li>
</ul>
<p>在activity中添加绑定代码，android:text属性的目标类型是String，但是这里我们定义的是一个Date变量，传入后不能直接使用，所以我们需要在显示之前做一次转化，就像服务器给我们int型的数据，但是我们显示时，往往需要根据状态值显示string类型。添加注解@BindingConversion，传入我们定义的类型Date，转化为可显示的String类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindingConversion</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convertDate</span><span class="params">(Date date)</span> </span>&#123;</div><div class="line">    SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line">    <span class="keyword">if</span>(date!=<span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span> sdf.format(date);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@BindingAdapter</span>(<span class="string">"custom"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCustom</span><span class="params">(TextView textView, <span class="keyword">float</span> height)</span> </span>&#123;</div><div class="line">    ViewGroup.LayoutParams params = textView.getLayoutParams();</div><div class="line">    params.height = (<span class="keyword">int</span>) height;</div><div class="line">    textView.setLayoutParams(params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后在activity中刷新数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">binding.setIsNormal(<span class="keyword">false</span>);</div><div class="line">binding.setHeight(<span class="number">400</span>);</div><div class="line">binding.setTime(<span class="keyword">new</span> Date());</div></pre></td></tr></table></figure>
<h2 id="Recyclerview的动态绑定"><a href="#Recyclerview的动态绑定" class="headerlink" title="Recyclerview的动态绑定"></a>Recyclerview的动态绑定</h2><p>只需获得item布局对应的binding对象，然后刷新数据即可，感觉与ButterKnife的使用方法类似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">ListAdapter</span>.<span class="title">ListHolder</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BEANS_COUNT = <span class="number">10</span>;</div><div class="line">  </div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="keyword">private</span> List&lt;Bean&gt; beans;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ListAdapter</span><span class="params">()</span> </span>&#123;</div><div class="line">        beans = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; BEANS_COUNT; i ++) &#123;</div><div class="line">            Bean bean = <span class="keyword">new</span> Bean(<span class="string">"测试数据"</span>+i,i);</div><div class="line">            beans.add(bean);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> BeanItemBinding binding;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListHolder</span><span class="params">(View itemView)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(itemView);</div><div class="line">            binding = DataBindingUtil.bind(itemView);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(@NonNull Bean bean)</span> </span>&#123;</div><div class="line">            binding.setBean(bean);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ListHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup viewGroup, <span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        View itemView = LayoutInflater.from(viewGroup.getContext())</div><div class="line">                .inflate(R.layout.bean_item, viewGroup, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ListHolder(itemView);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ListHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        holder.bind(beans.get(position));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> beans.size();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Bean类的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> position;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bean</span><span class="params">(String name, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.position = position;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPosition</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> position;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPosition</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.position = position;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>item_bean.xml中定义bean对象，并将属性与控件捆绑的代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">class</span>=<span class="string">"BeanItemBinding"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.MyStringUtils"</span>&gt;</span><span class="tag">&lt;/<span class="name">import</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"bean"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.Bean"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;/<span class="name">variable</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textName"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"10dp"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;bean.name&#125;"</span>/&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/textPosition"</span></div><div class="line">            <span class="attr">android:layout_alignParentRight</span>=<span class="string">"true"</span></div><div class="line">            <span class="attr">android:layout_marginRight</span>=<span class="string">"10dp"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@&#123;MyStringUtils.convert(bean.position)&#125;"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>最后在activity中初始化recyclerview</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerviewActivity</span>  <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView recyclerView;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ListAdapter adapter;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_recyclerview);</div><div class="line">        recyclerView= (RecyclerView) <span class="keyword">this</span>.findViewById(R.id.recyclerview);</div><div class="line">        recyclerView.setLayoutManager(<span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>));</div><div class="line">        adapter=<span class="keyword">new</span> ListAdapter();</div><div class="line"></div><div class="line">        recyclerView.setAdapter(adapter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Observable-Binding配合实现双向绑定"><a href="#Observable-Binding配合实现双向绑定" class="headerlink" title="Observable Binding配合实现双向绑定"></a>Observable Binding配合实现双向绑定</h1><p>Observable Binding有三种实现方式：</p>
<ol>
<li>继承BaseObservable类</li>
<li>实现Observable接口</li>
<li>使用Observable封装的响应式对象</li>
</ol>
<p>Observable Binding具体表现主要是在数据源发生改变时，自动通知view刷新数据。</p>
<ul>
<li>BaseObservable是双向绑定的基础 </li>
<li>结合双向绑定表达式<code>@={}</code>，可以做到当view内容变化时，自动通知数据源更新。</li>
</ul>
<h2 id="继承BaseObservable类实现"><a href="#继承BaseObservable类实现" class="headerlink" title="继承BaseObservable类实现"></a>继承BaseObservable类实现</h2><p>我们需要在DTO类继承BaseObservable类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableBean</span> <span class="keyword">extends</span> <span class="title">BaseObservable</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> String test1;</div><div class="line"></div><div class="line">    <span class="meta">@Bindable</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> test1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest1</span><span class="params">(String test1)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test1 = test1;</div><div class="line">        notifyPropertyChanged(BR.test1);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与以往不同的是，需要用@Bindable注解get方法，在set方法最后一行添加notifyPropertyChanged方法，通知数据刷新。</p>
<p>在xml布局文件中对相应控件进行数据绑定，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span> &gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"observableBean"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.ObservableBean"</span>&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">variable</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/textObservable"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@&#123;observableBean.test1&#125;"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/editObservable"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@=&#123;observableBean.test1&#125;"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>注意，此时EditText的text赋值为<code>@={xxx}</code>就是在调用双向绑定，根据我们当前输入的字符串去刷新数据源，然后数据源再刷新对应的控件，我们可以在TextView中绑定相同的字段查看数据源中的字段是否同步更新。这里有个死循环的问题，需要对旧数据和新数据作比较，如果相同则是会引起死循环的重复刷新，是需要过滤掉的，不过EditText作为系统组件，databinding的框架中已经解决了。</p>
<p>在activity中刷新数据，跟以前没有区别，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">observableBean=<span class="keyword">new</span> ObservableBean();</div><div class="line">observableBean.setTest1(<span class="string">"测试数据1"</span>);</div><div class="line"></div><div class="line">ActivityObervableBinding binding = DataBindingUtil.setContentView(</div><div class="line">                <span class="keyword">this</span>, R.layout.activity_obervable);</div><div class="line">binding.setObservableBean(observableBean);</div><div class="line">EditText editObservable=findViewById(R.id.editObservable);</div><div class="line">editObservable.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"afterTextChanged: "</span>+observableBean.getTest1());</div><div class="line">   &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<p>我们也可以通过EditText的监听去打印数据源，效果图和截图如下：</p>
<p>EditText中输入的效果图：<br><img src="http://oqujmbgen.bkt.clouddn.com/databinding-Study.gif" alt="输入效果图"></p>
<p>log打印出的截图：<br><img src="http://oqujmbgen.bkt.clouddn.com/databinding-Study.png" alt="打印效果图"></p>
<p>这里可能会出现一个问题，我们的实体类已经继承了其他父类，不能再继承BaseObservable。第二种实现方式可以解决这个问题</p>
<h2 id="实现Observable接口"><a href="#实现Observable接口" class="headerlink" title="实现Observable接口"></a>实现Observable接口</h2><p>只有DTO类需要修改，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableImpBean</span> <span class="keyword">implements</span> <span class="title">Observable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> PropertyChangeRegistry registry =<span class="keyword">new</span> PropertyChangeRegistry();</div><div class="line">    <span class="keyword">private</span> String test1;</div><div class="line"></div><div class="line">    <span class="meta">@Bindable</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTest1</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> test1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTest1</span><span class="params">(String test1)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.test1 = test1;</div><div class="line">        registry.notifyChange(<span class="keyword">this</span>, BR.test1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOnPropertyChangedCallback</span><span class="params">(OnPropertyChangedCallback callback)</span> </span>&#123;</div><div class="line">        registry.add(callback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeOnPropertyChangedCallback</span><span class="params">(OnPropertyChangedCallback callback)</span> </span>&#123;</div><div class="line">        registry.remove(callback);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们需要先实例化PropertyChangeRegistry对象，实现Observable接口必须实现addOnPropertyChangedCallback方法和removeOnPropertyChangedCallback方法，我们用PropertyChangeRegistry对象分别调用对应的add方法和remove方法传入callback即可，同样需要用@Bindable注解get方法，在set方法最后一行添加PropertyChangeRegistry对象调用notifyChange方法，通知数据刷新。事实上，BaseObservable也是实现了Observable这个接口。</p>
<p>最后一种常见情况，我们的实体类的字段很多很多，要是每个get/set方法都对应加上@Bindable注解和notifyPropertyChanged()方法，显得很麻烦，那么第三个方式可以解决这个问题</p>
<h2 id="使用Observable封装的响应式对象"><a href="#使用Observable封装的响应式对象" class="headerlink" title="使用Observable封装的响应式对象"></a>使用Observable封装的响应式对象</h2><p>我们需要修改DTO类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableObject</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ObservableField&lt;String&gt; test1 = <span class="keyword">new</span> ObservableField&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里用到了DataBinding提供的响应式对象，看起来是不是精简许多了呢？</p>
<p>基本类型的数据结构提的包装类</p>
<ul>
<li>ObservableBoolean</li>
<li>ObservableByte</li>
<li>ObservableChar</li>
<li>ObservableDouble</li>
<li>ObservableFloat</li>
<li>ObservableInt</li>
<li>ObservableLong</li>
<li>ObservableShort</li>
</ul>
<p>针对集合提供的包装类</p>
<ul>
<li>ObservableArrayList</li>
<li>ObservableArrayMap</li>
</ul>
<p>针对实现了Parcelable接口的对象提供的包装类</p>
<ul>
<li>ObservableParcelable</li>
</ul>
<p>针对其他类型提供的包装类</p>
<ul>
<li>ObservableField。最典型的：ObservableField</li>
</ul>
<p>接下来是在xml中绑定对应的控件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--添加variable标签，定义变量--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">        <span class="attr">name</span>=<span class="string">"observableObject"</span></div><div class="line">        <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.dto.ObservableObject"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">variable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/textObservable2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@&#123;observableObject.test1.get()&#125;"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/editObservable2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@=&#123;observableObject.test1.get()&#125;"</span>/&gt;</div></pre></td></tr></table></figure></p>
<p>我们可以看到包装类的set，get方法略有不同。<br>在activity中刷新数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">observableObject=<span class="keyword">new</span> ObservableObject();</div><div class="line">observableObject.beanField.set(<span class="string">"测试响应式对象"</span>);</div><div class="line">binding.setObservableObject(observableObject);</div></pre></td></tr></table></figure></p>
<p>最后注意一点，并不是只靠BaseObservable加上双向绑定表达式@={}就可以实现双向绑定。实际上在使用双向绑定时，还得依靠各个注解的帮助，监听view内容的变化是BaseObservable做不到的，需要依赖指定的注解才能把view内容的变化通知出去，然后BaseObservable收到这些通知后触发 notifyPropertyChanged()，改变数据源以及界面。而这些对于android自带的组件DataBinding已经处理好了，所以对于自定义的控件需要自己通过这些注解实现双向绑定。</p>
<h1 id="MVPVM实战"><a href="#MVPVM实战" class="headerlink" title="MVPVM实战"></a>MVPVM实战</h1><p>自从google推出databinding后，View Interface的部分功能可以转移到ViewModel中去，进一步降低View层的臃肿。结合已经比较流行的MVP架构，衍生出一种新的架构，叫做MVPVM。MVPVM=Model+View+Presenter+ViewModel</p>
<p>除ViewModel层外，其余与MVP大致相同，各个分层的主要职责：</p>
<p>View层：实现View Interface，对外提供UI操作的方法，比如界面显示刷新，弹窗，消息提示。</p>
<p>ViewModel层：以databinding为基础，对外提供控制xml界面的方法。</p>
<p>Presenter层：实现Presenter Interface，调用model层处理业务逻辑并显示到View层上。</p>
<p>Model层：处理业务逻辑，如数据请求，缓存处理，数据库处理。</p>
<p>前一篇在介绍Dagger的时候写过登录功能，这里就登录功能以MVPVM的架构再写一个小例子。</p>
<p>dto为响应式对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseObservable</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> ObservableField&lt;String&gt; username=<span class="keyword">new</span> ObservableField&lt;&gt;();<span class="comment">//用户名</span></div><div class="line">    <span class="keyword">public</span> ObservableField&lt;String&gt; password=<span class="keyword">new</span> ObservableField&lt;&gt;();<span class="comment">//密码</span></div><div class="line">    <span class="keyword">public</span> ObservableInt usernamePass=<span class="keyword">new</span> ObservableInt();<span class="comment">//用户名校验状态</span></div><div class="line">    <span class="keyword">public</span> ObservableInt passwordPass=<span class="keyword">new</span> ObservableInt();<span class="comment">//密码校验状态</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>M层没有什么变化</p>
<p>M层接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoginModel</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(String username, String password)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkUserName</span><span class="params">(String username)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>M层实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginModel</span> <span class="keyword">implements</span> <span class="title">ILoginModel</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//    @Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginModel</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(String username,String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username)&amp;&amp;<span class="string">"123456"</span>.equals(password))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkUserName</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"123456"</span>.equals(password))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>P层需要传入V层接口，初始化响应式对象，并提供获取接口，响应式对象必须在V层绑定。    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ILoginModel iLoginModel;</div><div class="line">    <span class="keyword">private</span> ILoginView iLoginView;</div><div class="line">    <span class="keyword">private</span> User user;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(ILoginView iLoginView)</span></span>&#123;</div><div class="line">        iLoginModel = <span class="keyword">new</span> LoginModel();</div><div class="line">        <span class="comment">//初始化响应式对象</span></div><div class="line">        user=<span class="keyword">new</span> User();</div><div class="line">        <span class="keyword">this</span>.iLoginView=iLoginView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> user;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPassword</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//用户名输入框已输入</span></div><div class="line">        <span class="keyword">if</span>(!TextUtils.isEmpty(user.password.get()))&#123;</div><div class="line">            <span class="keyword">if</span> (iLoginModel.checkPassword(user.password.get())) &#123;</div><div class="line">                user.passwordPass.set(<span class="number">1</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                user.passwordPass.set(<span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            user.passwordPass.set(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkUserName</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//密码输入框已输入</span></div><div class="line">        <span class="keyword">if</span>(!TextUtils.isEmpty(user.username.get()))&#123;</div><div class="line">            <span class="keyword">if</span>(iLoginModel.checkUserName(user.username.get()))&#123;</div><div class="line">                user.usernamePass.set(<span class="number">1</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                user.usernamePass.set(<span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            user.usernamePass.set(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(iLoginModel.login(user.username.get(),user.password.get()))&#123;</div><div class="line">            iLoginView.onLoginResult(<span class="keyword">true</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            iLoginView.onLoginResult(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>V层接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoginView</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginResult</span><span class="params">(<span class="keyword">boolean</span> result)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>V层实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">ILoginView</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LoginActivity"</span>;</div><div class="line">    <span class="keyword">private</span> LoginPresenter loginPresenter;</div><div class="line">    EditText et_username,et_password;</div><div class="line">    TextInputLayout usernameInput;</div><div class="line">    TextInputLayout passwordInput;</div><div class="line">    User user;</div><div class="line">    ActivityLoginBinding activityLoginBinding;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        activityLoginBinding= DataBindingUtil.setContentView(<span class="keyword">this</span>,R.layout.activity_login);</div><div class="line"></div><div class="line">        loginPresenter=<span class="keyword">new</span> LoginPresenter(<span class="keyword">this</span>);</div><div class="line">        user=loginPresenter.getUser();</div><div class="line">        <span class="comment">//初始化binding</span></div><div class="line">        activityLoginBinding.setUser(user);</div><div class="line">        et_username= (EditText) findViewById(R.id.et_username);</div><div class="line">        et_password= (EditText) findViewById(R.id.et_password);</div><div class="line">        usernameInput = (TextInputLayout) findViewById(R.id.usernameInput);</div><div class="line">        passwordInput = (TextInputLayout) findViewById(R.id.passwordInput);</div><div class="line">        et_username.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</div><div class="line">                loginPresenter.checkUserName();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        et_password.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"afterTextChanged: "</span>+user.password.get());</div><div class="line">                loginPresenter.checkPassword();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//登录按钮点击回调</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        hideKeyboard();</div><div class="line">        loginPresenter.login();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideKeyboard</span><span class="params">()</span></span>&#123;</div><div class="line">        View view = getCurrentFocus();</div><div class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">            ((InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE)).</div><div class="line">                    hideSoftInputFromWindow(view.getWindowToken(), 							          InputMethodManager.HIDE_NOT_ALWAYS);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@BindingAdapter</span>(<span class="string">"onUsernameChange"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setOnUsernameChange</span><span class="params">(TextInputLayout usernameInput, <span class="keyword">int</span> result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result==<span class="number">0</span> || result==<span class="number">1</span>)&#123;</div><div class="line">            usernameInput.setErrorEnabled(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            usernameInput.setError(<span class="string">"用户名无效!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@BindingAdapter</span>(<span class="string">"onPasswordChange"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setOnPasswordChange</span><span class="params">(TextInputLayout passwordInput, <span class="keyword">int</span> result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result==<span class="number">0</span> || result==<span class="number">1</span>)&#123;</div><div class="line">            passwordInput.setErrorEnabled(<span class="keyword">false</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            passwordInput.setError(<span class="string">"密码无效!"</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginResult</span><span class="params">(<span class="keyword">boolean</span> result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result)&#123;</div><div class="line">            Toast.makeText(<span class="keyword">this</span>,<span class="string">"登录成功！"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            Toast.makeText(<span class="keyword">this</span>,<span class="string">"登录失败！"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此处EditText使用了databinding的双向绑定，在输入用户名和密码的同时，刷新数据源。P层调用M层校验用户名密码状态，并结果返回到P层。TextInputLayout使用了@BindingAdapter注解绑定自定义属性，setOnUsernameChange方法绑定onUsernameChange属性，传入目标view和自定义属性的值，根据用户名的校验状态，设置对应TextInputLayout的错误提示。同样，setOnPasswordChange方法绑定onPasswordChange属性，传入目标view和自定义属性的值，根据密码的校验状态，设置对应TextInputLayout的错误提示。所以V层接口只需要提供登录成功后的提示接口。</p>
<p>LoginActivity的XML布局代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:bind</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">variable</span></span></div><div class="line">            <span class="attr">name</span>=<span class="string">"user"</span></div><div class="line">            <span class="attr">type</span>=<span class="string">"com.jessie.databinding.study.mvpvm.dto.User"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;/<span class="name">variable</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line">        <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.design.widget.TextInputLayout</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/usernameInput"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"52dp"</span></div><div class="line">            <span class="attr">android:layout_marginEnd</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginRight</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginStart</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginTop</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">bind:onUsernameChange</span>=<span class="string">"@&#123;user.usernamePass&#125;"</span></div><div class="line">            <span class="attr">app:errorTextAppearance</span>=<span class="string">"@style/Theme.AppCompat"</span></div><div class="line">            <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@+id/passwordInput"</span></div><div class="line">            <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"1.0"</span></div><div class="line">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"1.0"</span></div><div class="line">            <span class="attr">tools:layout_constraintLeft_creator</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">tools:layout_constraintRight_creator</span>=<span class="string">"1"</span>&gt;</div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/et_username"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:hint</span>=<span class="string">"Username"</span></div><div class="line">                <span class="attr">android:text</span>=<span class="string">"@=&#123;user.username&#125;"</span></div><div class="line">                <span class="attr">android:inputType</span>=<span class="string">"textEmailAddress"</span></div><div class="line">                <span class="attr">tools:layout_editor_absoluteX</span>=<span class="string">"8dp"</span></div><div class="line">                <span class="attr">tools:layout_editor_absoluteY</span>=<span class="string">"28dp"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;/<span class="name">android.support.design.widget.TextInputLayout</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.design.widget.TextInputLayout</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/passwordInput"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_below</span>=<span class="string">"@id/usernameInput"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"257dp"</span></div><div class="line">            <span class="attr">android:layout_marginEnd</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginLeft</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginRight</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">android:layout_marginStart</span>=<span class="string">"8dp"</span></div><div class="line">            <span class="attr">bind:onPasswordChange</span>=<span class="string">"@&#123;user.passwordPass&#125;"</span></div><div class="line">            <span class="attr">app:errorTextAppearance</span>=<span class="string">"@style/Theme.AppCompat"</span></div><div class="line">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"0.0"</span></div><div class="line">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">tools:layout_constraintBottom_creator</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">tools:layout_constraintLeft_creator</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">tools:layout_constraintRight_creator</span>=<span class="string">"1"</span>&gt;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/et_password"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:hint</span>=<span class="string">"Password"</span></div><div class="line">                <span class="attr">android:text</span>=<span class="string">"@=&#123;user.password&#125;"</span></div><div class="line">                <span class="attr">android:inputType</span>=<span class="string">"textPassword"</span></div><div class="line">                <span class="attr">tools:layout_editor_absoluteY</span>=<span class="string">"74dp"</span> /&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">android.support.design.widget.TextInputLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_marginBottom</span>=<span class="string">"139dp"</span></div><div class="line">            <span class="attr">android:onClick</span>=<span class="string">"onLoginClick"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"登录"</span></div><div class="line">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></div><div class="line">            <span class="attr">tools:layout_constraintBottom_creator</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">tools:layout_constraintLeft_creator</span>=<span class="string">"1"</span></div><div class="line">            <span class="attr">tools:layout_constraintRight_creator</span>=<span class="string">"1"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.constraint.Guideline</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/guideline"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">            <span class="attr">app:layout_constraintGuide_begin</span>=<span class="string">"192dp"</span> /&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>databinding的总结：</p>
<p>优点：解决界面与业务分离问题，简化代码，可提高开发效率。</p>
<p>缺点：错误提示很难定位，XML中数据捆绑的代码编辑提示不够智能。</p>
<p>我已经把所有例子的完整代码打包上传，想查看demo源码的朋友，这里有<a href="https://github.com/jessieeeee/DataBindingStudy" target="_blank" rel="external">传送门</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/12/constraintLayout-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/12/constraintLayout-study/" itemprop="url">
                  constraintLayout 学习总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-12T22:20:48+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/09/12/constraintLayout-study/" class="leancloud_visitors" data-flag-title="constraintLayout 学习总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>ConstraintLayout是Android Studio 2.2中主要的新增功能之一，也是Google在去年的I/O大会上重点宣传的一个功能，升级Android Studio 2.3之后，IDE默认生成的Activity布局都是以ConstraintLayout做为根布局。</p>
<p>新技术毕竟有其优势，google大力宣传的ConstraintLayout有以下两大特性：</p>
<ol>
<li>可视化操作编写界面，提高开发效率</li>
<li>有效地解决布局嵌套过多的问题,是一个升级版的RelativeLayout，有效提升性能</li>
</ol>
<p>下面对其进行一个学习总结，毕竟这个布局是为了可视化而生，可视化操作的练习是必不可少的。由于constraintLayout的拖拽部分涉及到太多的动态效果图，就不详细描述了，已有很多文章写过这部分。其实constraintLayout的很多属性对于我们来说是新鲜的，是其它布局所没有的，所以这里主要总结一下constraintLayout的属性学习。</p>
<hr>
<h1 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h1><p>使用constraintLayout需要添加以下依赖<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">classpath <span class="string">'com.android.support.constraint:constraint-layout：XXX'</span></div></pre></td></tr></table></figure></p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>app:layout_constraintBottom_toBottomOf=”parent”<br>当前控件底部的布局约束是位于parent控件底部，parent是指包裹着它的ConstraintLayout，也可以设置指定某个控件的id。效果类似于RelativeLayout的layout_alignParentBottom=”true”<br>对比RelativeLayout，同类的属性还有以下这些<br>app:layout_constraintLeft_toLeftOf = layout_alignParentLeft=”true”<br>app:layout_constraintBottom_toBottomOf = layout_alignParentBottom=”true”<br>app:layout_constraintRight_toRightOf = layout_alignParentRight=”true”<br>app:layout_constraintTop_toTopOf = layout_alignParentTop=”true”<br>app:layout_constraintLeft_toRightOf = toRightOf<br>app:layout_constraintRight_toLeftOf = toLeftOf<br>app:layout_constraintTop_toBottomOf = toBottomOf<br>app:layout_constraintBottom_toTopOf = toTopOf<br>app:layout_constraintBaseline_toBaselineOf 此控件与指定控件水平对齐<br>点击该button按钮，下方会出现 x,ab两个图标，x表示去掉所有约束，ab表示切换显示横条还是四个点，点击ab，button中间会出现一根横条，然后把该控件和指定控件的横条相连就行了。</p>
<p>goneMargin属性<br>这些设置生效于当依赖的约束对象被设置visibility为gone时，支持的属性如下：<br>layout_goneMarginStart<br>layout_goneMarginEnd<br>layout_goneMarginLeft<br>layout_goneMarginTop<br>layout_goneMarginRight<br>layout_goneMarginBottom<br>比如A,B两个view,B在A的右边，这时候如果A消失了，但是你想让B在父布局的右边多少距离，就可以使用这个属性。</p>
<p>Bias属性<br>ConstraintLayout新增了如下两个属性用于控制控件在水平和垂直方向在屏幕上的偏移比例<br>当目标控件设置好水平方向约束<br>app:layout_constraintLeft_toLeftOf=”parent”、app:layout_constraintRight_toRightOf=”parent”<br>或者垂直方向约束时<br>app:layout_constraintTop_toTopOf=”parent”、app:layout_constraintBottom_toBottomOf=”parent”<br>layout_constraintHorizontal_bias和layout_constraintVertical_bias会随着控件的拖到一直发生相应的变化，如果你需要居中，那么直接将这两个属性的参数值设置为0.5即可。</p>
<h1 id="与其他Layout不同之处"><a href="#与其他Layout不同之处" class="headerlink" title="与其他Layout不同之处"></a>与其他Layout不同之处</h1><p>它的layout_width和layout_height不支持设置match_parent，其属性取值只有以下三种情况：<br>wrap_content；<br>指定具体dp值；<br>0dp<code>（match_constraint）</code>，代表填充约束之意。和match_parent不一样<br>要让一个控件的宽高按某个比例进行布局可以使用<code>layout_constraintDimentionRatio</code>属性设置宽高比例，前提是目标控件的<code>layout_width</code>和<code>layout_height</code>至少有一个设置为0dp，为0dp那个按宽高比适应<br><code>layout_constraintDimentionRatio</code>默认参数比例是指宽：高<br>使其高:宽写成<code>app:layout_constraintDimensionRatio=”H,2:1”</code>。</p>
<h1 id="链条（Chains）"><a href="#链条（Chains）" class="headerlink" title="链条（Chains）"></a>链条（Chains）</h1><h2 id="实现LinearLayout的水平布局"><a href="#实现LinearLayout的水平布局" class="headerlink" title="实现LinearLayout的水平布局"></a>实现LinearLayout的水平布局</h2><p><code>app:layout_constraintHorizontal_chainStyle</code><br>水平方向的<code>layout_constraintHorizontal_chainStyle</code><br>垂直方向的<code>layout_constraintVertical_chainStyle</code></p>
<p>两者均有spread,spread_inside,packed这三种取值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn1"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintHorizontal_chainStyle</span>=<span class="string">"spread"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn2"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn1"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn3"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn3"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn2"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>效果图如下<br><img src="http://oqujmbgen.bkt.clouddn.com/spread.png" alt="效果图"><br>当app:layout_constraintHorizontal_chainStyle = “spread_inside”<br>效果图如下<br><img src="http://oqujmbgen.bkt.clouddn.com/spread_inside.png" alt="效果图"></p>
<p>当app:layout_constraintHorizontal_chainStyle = “packed”<br>效果图如下<br><img src="http://oqujmbgen.bkt.clouddn.com/packed.png" alt="效果图"></p>
<h2 id="bias链条"><a href="#bias链条" class="headerlink" title="bias链条"></a>bias链条</h2><p>当app:layout_constraintHorizontal_chainStyle = “packed”的情况下，通过设置head头控件的bias属性，来设置链条的位置（更偏向左或更偏向右）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/btn1"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"0.3"</span> // 权重为靠左<span class="attr">0.3</span></div><div class="line">    <span class="attr">app:layout_constraintHorizontal_chainStyle</span>=<span class="string">"packed"</span> // 样式为<span class="attr">packed</span></div><div class="line">    <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">    <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn2"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/btn2"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn1"</span></div><div class="line">    <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn3"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/btn3"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">    <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn2"</span></div><div class="line">    <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>效果图如下<br><img src="http://oqujmbgen.bkt.clouddn.com/bias.png" alt="效果图"></p>
<h2 id="权重链"><a href="#权重链" class="headerlink" title="权重链"></a>权重链</h2><p>如果将控件的<code>layout_width</code>和<code>layout_height</code>设置成为0dp，还可以配合<code>layout_constraintHorizontal_weight</code>、<code>layout_constraintVertical_weight</code>两个属性实现和LinearLayout中设置<code>layout_weight</code>相同的效果</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn1"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"60dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn2"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintHorizontal_weight</span>=<span class="string">"1"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn1"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn3"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/btn3"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></div><div class="line">        <span class="attr">app:layout_constraintHorizontal_weight</span>=<span class="string">"1"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn2"</span></div><div class="line">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>当<code>layout_width</code>设置为60dp时，<code>app:layout_constraintHorizontal_weight=&quot;1&quot;</code>平分剩余的空间，效果图如下<br><img src="http://oqujmbgen.bkt.clouddn.com/weight.png" alt="效果图"></p>
<h1 id="GuildLine"><a href="#GuildLine" class="headerlink" title="GuildLine"></a>GuildLine</h1><p>这是一个辅助我们布局的View，并且默认设置了visibility为gone</p>
<p>Guideline也分为垂直和水平两种<br>设置在屏幕中所处的位置<br><code>layout_constraintGuide_begin</code> 引导线距离左边框的距离<br><code>layout_constraintGuide_end</code> 中引导线距离右边框的距离<br><code>layout_constraintGuide_percent</code> 在整个布局中引导线距离左边框的百分比<br>（<code>app:layout_constraintGuide_percent=”0.5”</code>表示距离左边框50%的位置）</p>
<p>到此约束布局的基本用法总结就结束了，接下来就需要更多的时间进行可视化操作练习~</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/Dagger-Start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jessie Kate">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JessieK's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/09/Dagger-Start/" itemprop="url">
                  Dagger 学习入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T15:01:37+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/09/09/Dagger-Start/" class="leancloud_visitors" data-flag-title="Dagger 学习入门">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>目前android最火的架构就是MVP+Dagger+Retrofit+Rxjava，技术迭代真的是很快啊，程序猿这个职业，需要我们抱着终身学习的热情在互联网急速发展的浪潮中追逐最新的技术，提高开发效率和我们的核心竞争力，好吧，一不小心又灌了一口鸡汤。</p>
<p>架构在大型项目中是很重要的，一个好的架构有着高度的可扩展性，可维护性，低耦合，高聚合，而Dagger正是为了解耦而生，主要是通过依赖注入去实现。依赖注入是一种设计模式，降低了依赖和被依赖对象之间的耦合，方便扩展和单元测试。是面向对象六大原则之一的依赖倒置原则（dependency inversion principle）比如当服务端接口未开发完时，我们可使用本地json注入做一个测试，与MVP结合可以实现更大程度的解耦，当面对需求更改时，进行更灵活的处理，避免项目的大规模修改，妈妈再也不用担心我又加班了～</p>
<p>所以，Dagger值得我们去跳坑，在此做一个学习记录</p>
<hr>
<h1 id="依赖注入的场景"><a href="#依赖注入的场景" class="headerlink" title="依赖注入的场景"></a>依赖注入的场景</h1><p>依赖注入，这个名词太抽象了，实际上我们平时开发是经常用到的，只不过你不知道这个就叫依赖注入而已，通过一个类的构造函数入参引入另一个类的对象，或者是通过set方法引入另一个类的对象，就是依赖注入。</p>
<p>比如这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//构造方法依赖注入</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    B b;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">A</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//set()方法依赖注入</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    B b;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好吧，这么一说神秘感就没有了，Dagger2不同的地方就是通过注解的方式依赖注入的。如果有一天，产品需要更改需求，A类依赖的不是B而是C，如果我们很多地方都引用到A，并且A都需要依赖于B，那么我们的代码就需要大面积更改了，而Dagger能够让我们避免这种问题的出现。</p>
<h1 id="Dagger常用注解"><a href="#Dagger常用注解" class="headerlink" title="Dagger常用注解"></a>Dagger常用注解</h1><p>@Inject 一般情况下是标注成员属性和构造函数，标注的成员属性不能是private，Dagger 2 中还可以标注方法，一般用于注解需要注入的对象。<br>@Module 用来标注 Module类，用来生成实例，像一个工厂，用于生成各种类的实例。<br>@Provides 只能标注方法，必须在 Module类 中，Module类对外提供实例方法的注解。<br>@Component 只能标注接口或抽象类，声明的注入接口的参数类型必须和目标类一致。Module类的构造函数入参与调用类Activity保持一致。Component一般是个接口，就是将Activity与Module类联系起来，通过它调用Module，传入当前Activity，获得Provides提供的实例，完成注入。<br>@Named:Dagger2是根据Provide方法返回类型查找对应的依赖的，如果需要注入相同类型的，但是内容不同，多态情况，这个时候就可以使用@Named进行区分。<br>@Singleton有时候，我们不需要多次创建Component，可以使用一个Component，即单例模式，这个时候就可以使用@Singleton来修饰它，这样就会以单利的模式在生成的 <code>Daggerxxxxx</code>中保存 。如果某个moudle也只需要使用同一个，那么也可以使用@Single来修饰provide的方法，同时也需要使用@Singleton注解使用该module的Component。</p>
<h1 id="Dagger注入过程"><a href="#Dagger注入过程" class="headerlink" title="Dagger注入过程"></a>Dagger注入过程</h1><p>当某个变量被@Inject注解时，会先判断注解成员属性的构造函数是否被注解，（Dagger2通过Inject标记可以在需要这个类实例的时候来找到这个构造函数并把相关实例new出来），在建立Component和工厂类的情况下，直接完成注入，如果没有被注解，会通过Component查找对应的Module里的Provides方法生成。</p>
<h1 id="Dagger的基本用法"><a href="#Dagger的基本用法" class="headerlink" title="Dagger的基本用法"></a>Dagger的基本用法</h1><p>以一个简陋的登录功能为例</p>
<p>首先我们定义一个接口ILoginModel</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoginModel</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(String username,String password)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkUserName</span><span class="params">(String username)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们实现这个接口，创建一个类LoginModel，这里只是模拟一下，随便写点逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginModel</span> <span class="keyword">implements</span> <span class="title">ILoginModel</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(String username,String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username)&amp;&amp;<span class="string">"123456"</span>.equals(password))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkUserName</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="string">"123456"</span>.equals(password))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着在主Activity中声明这个对象，随意调用里面的一个方法比如<code>checkUserName(String username)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"测试注入"</span>;</div><div class="line">    LoginModel loginModel;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        Log.d(TAG, <span class="string">"onCreate: "</span>+loginModel.checkUserName(<span class="string">"admin"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是不是在作死呢？loginModel明显会报空指针啊，没错，loginModel没初始化必然报空指针。这里我们使用Dagger依赖注入。</p>
<h2 id="Inject注解构造方法"><a href="#Inject注解构造方法" class="headerlink" title="@Inject注解构造方法"></a>@Inject注解构造方法</h2><ul>
<li><p>给LoginModel增加构造方法，并使用@Inject注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LoginModel</span><span class="params">()</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建一个LoginModel的实例工厂LoginModelFactory，专门负责生成LoginModel，记得用@Module注解，这里由于我们已经用@Inject注解了构造方法，所以LoginModel会直接被new出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginModelFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MainActivity mainActivity;</div><div class="line"></div><div class="line">  <span class="comment">//保持与需要被注入的变量所在的类名称一致</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LoginModelFactory</span><span class="params">(MainActivity mainActivity)</span></span>&#123;</div><div class="line">      <span class="keyword">this</span>.mainActivity=mainActivity;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建一个关联组建LoginModelComponent，关联LoginModelFactory和MainActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span> (modules = LoginModelFactory.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginModelComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity mainActivity)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在MainActivity中，将loginModel用@Inject注解，并增加一句代码实现注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">LoginModel loginModel;</div><div class="line"></div><div class="line"><span class="comment">//开始注入</span></div><div class="line">DaggerLoginModelComponent.create().inject(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>注：修改后的完整代码就不再贴了，完整代码已打包上传，文末有传送门。</p>
<p>至此，Dagger的基本使用结束，我们发现loginModel注入成功，<code>loginModel.checkUserName(&quot;admin&quot;)</code>成功调用，并没有抛异常。</p>
<p>下面介绍另一种实现方法。</p>
<h2 id="Provides注解实现"><a href="#Provides注解实现" class="headerlink" title="@Provides注解实现"></a>@Provides注解实现</h2><p>先取消LoginModel构造方法的注解。</p>
<p>前面说过@Provides必须在 Module 中，这里我们用@Module注解的类是LoginModelFactory，我们在LoginModelFactory中增加一个方法，生成LoginModel对象，注意用@Provides注解。</p>
<p>​<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Provides</span></div><div class="line"><span class="function">LoginModel <span class="title">provideLoginModel</span><span class="params">()</span></span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> LoginModel();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这时主Activity的那句注入代码<code>DaggerLoginModelComponent.create().inject(this);</code>报错了，因为这次我们采用的不是注解构造方法的实现方式，而是采用@Provides注解，所以修改如下</p>
<p>​<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DaggerLoginModelComponent.builder()</div><div class="line">               .loginModelFactory(<span class="keyword">new</span> LoginModelFactory(<span class="keyword">this</span>))</div><div class="line">               .build()</div><div class="line">               .inject(<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>这时我们发现loginModel依然注入成功，<code>loginModel.checkUserName(&quot;admin&quot;)</code>成功调用，也并没有抛异常。</p>
<p>接下来是比较常用的场景。</p>
<h1 id="与MVP架构结合"><a href="#与MVP架构结合" class="headerlink" title="与MVP架构结合"></a>与MVP架构结合</h1><p>按传统mvp的架构，我们现在有了M层的接口，M层的实现，还需要V层的接口和V层的实现，以及P层的实现，如果有必要还有P层的接口。</p>
<p>下面就直接贴传统mvp架构缺少的那部分代码</p>
<p>先删除主Activity中，引用到的LoginModel对象</p>
<p>删除或注释LoginModelComponent这个关联组建，否则会报错</p>
<p>V层接口ILoginView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoginView</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheckUserNameResult</span><span class="params">(<span class="keyword">boolean</span> result)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheckPasswordResult</span><span class="params">(<span class="keyword">boolean</span> result)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginResult</span><span class="params">(<span class="keyword">boolean</span> result)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>P层实现LoginPresenter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ILoginModel iLoginModel;</div><div class="line">    <span class="keyword">private</span> ILoginView iLoginView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(ILoginModel iLoginModel,ILoginView iLoginView)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.iLoginModel=iLoginModel;</div><div class="line">        <span class="keyword">this</span>.iLoginView=iLoginView;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPassword</span><span class="params">(String password)</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (iLoginModel.checkPassword(password)) &#123;</div><div class="line">            iLoginView.onCheckPasswordResult(<span class="keyword">true</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            iLoginView.onCheckPasswordResult(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkUserName</span><span class="params">(String username)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(iLoginModel.checkUserName(username))&#123;</div><div class="line">            iLoginView.onCheckUserNameResult(<span class="keyword">true</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            iLoginView.onCheckUserNameResult(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String username,String password)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(iLoginModel.login(username,password))&#123;</div><div class="line">           iLoginView.onLoginResult(<span class="keyword">true</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            iLoginView.onLoginResult(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主Activity修改，实现ILoginView的接口，声明待注入的LoginPresenter对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">ILoginView</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"测试Inject注释构造方法"</span>;</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    LoginPresenter loginPresenter;</div><div class="line"></div><div class="line">    TextInputLayout usernameInput;</div><div class="line">    TextInputLayout passwordInput;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        usernameInput = (TextInputLayout) findViewById(R.id.usernameInput);</div><div class="line">        passwordInput = (TextInputLayout) findViewById(R.id.passwordInput);</div><div class="line">        <span class="comment">//开始注入</span></div><div class="line">        DaggerLoginPresenterComponent.builder()</div><div class="line">                .loginPresenterFactory(<span class="keyword">new</span> LoginPresenterFactory(<span class="keyword">this</span>))</div><div class="line">                .build()</div><div class="line">                .inject(<span class="keyword">this</span>);</div><div class="line">        EditText editUsername= (EditText) findViewById(R.id.username);</div><div class="line">        EditText editPassword= (EditText) findViewById(R.id.password);</div><div class="line">        editUsername.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</div><div class="line">               onChangeUsername();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        editPassword.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence charSequence, <span class="keyword">int</span> i, <span class="keyword">int</span> i1, <span class="keyword">int</span> i2)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable editable)</span> </span>&#123;</div><div class="line">               onChangePassword();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//点击用户名输入回调</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChangeUsername</span><span class="params">()</span></span>&#123;</div><div class="line">        String username = usernameInput.getEditText().getText().toString().trim();</div><div class="line">        <span class="comment">//密码输入框已输入</span></div><div class="line">        <span class="keyword">if</span>(!TextUtils.isEmpty(username))&#123;</div><div class="line">          loginPresenter.checkUserName(username);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//点击密码输入回调</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChangePassword</span><span class="params">()</span></span>&#123;</div><div class="line">       String password = passwordInput.getEditText().getText().toString().trim();</div><div class="line">        <span class="comment">//用户名输入框已输入</span></div><div class="line">       <span class="keyword">if</span>(!TextUtils.isEmpty(password))&#123;</div><div class="line">           loginPresenter.checkPassword(password);</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//登录按钮点击回调</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        hideKeyboard();</div><div class="line">        String username = usernameInput.getEditText().getText().toString().trim();</div><div class="line">        String password = passwordInput.getEditText().getText().toString().trim();</div><div class="line"></div><div class="line">        loginPresenter.login(username,password);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideKeyboard</span><span class="params">()</span></span>&#123;</div><div class="line">        View view = getCurrentFocus();</div><div class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">            ((InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE)).</div><div class="line">                    hideSoftInputFromWindow(view.getWindowToken(), InputMethodManager.HIDE_NOT_ALWAYS);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheckUserNameResult</span><span class="params">(<span class="keyword">boolean</span> result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result)&#123;</div><div class="line">            usernameInput.setErrorEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            usernameInput.setError(<span class="string">"用户名无效!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheckPasswordResult</span><span class="params">(<span class="keyword">boolean</span> result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result)&#123;</div><div class="line">            passwordInput.setErrorEnabled(<span class="keyword">false</span>);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            passwordInput.setError(<span class="string">"密码无效!"</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginResult</span><span class="params">(<span class="keyword">boolean</span> result)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span>(result)&#123;</div><div class="line">           Toast.makeText(<span class="keyword">this</span>,<span class="string">"登录成功！"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">       &#125;<span class="keyword">else</span>&#123;</div><div class="line">           Toast.makeText(<span class="keyword">this</span>,<span class="string">"登录失败！"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>修改了注入代码，这里我们需要新建LoginPresenter的实例工厂LoginPresenterFactory，和LoginPresenterFactory与主Activity的关联组件LoginPresenterComponent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenterFactory</span> </span>&#123;</div><div class="line">    MainActivity mainActivity;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenterFactory</span><span class="params">(MainActivity mainActivity)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.mainActivity=mainActivity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="function">LoginPresenter <span class="title">provideLoginPresenter</span><span class="params">(LoginModel loginModel,MainActivity mainActivity)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoginPresenter(loginModel,mainActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="function">LoginModel <span class="title">provideLoginModel</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoginModel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="function">MainActivity <span class="title">proviceMainActivity</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> mainActivity;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span> (modules = LoginPresenterFactory.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginPresenterComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(MainActivity mainActivity)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到LoginPresenterFactory提供了3个实例方法，首先必须提供LoginPresenter的实例生成方法，其中LoginPresenter需要依赖MainActivity和LoginModel创建，所以我们可以增加两个实例的生成方法分别是provideLoginModel和proviceMainActivity，其中前者可以直接new出来，后者是通过注入方法从主Activity传进来。</p>
<p>到此mvp与Dagger结合的例子就完成了。</p>
<p>最后附上完整源码<a href="https://github.com/jessieeeee/DaggerDemo" target="_blank" rel="external">传送门</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Jessie Kate" />
          <p class="site-author-name" itemprop="name">Jessie Kate</p>
           
              <p class="site-description motion-element" itemprop="description">程序的世界，比你牛逼的人更比你努力。<br /> hello，I'm an Android developer～ <br /> My hobbies tag &#58; <br /> - Coding  <br /> - Sports   <br /> - Game</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jessie Kate</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/three/three.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("6LCVjBbx0bpqxaQGmw1hdaTw-gzGzoHsz", "h0CQIfed08e67roNpfhTzHOH");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>